# 一级分类销售趋势渠道筛选功能

## 📋 功能概述

为"一级分类销售趋势"分析模块添加了多渠道筛选功能,用户可以选择查看特定渠道的分类销售数据,实现与"销售趋势分析"模块一致的用户体验。

## ✨ 功能特性

### 1. **渠道筛选下拉框**
- 位置: 分类趋势卡片标题行
- 选项: 
  - 全部渠道 (默认)
  - 美团闪购
  - 饿了么
  - 京东到家
  - 闪购小程序
- 动态生成: 自动从实际数据中提取可用渠道

### 2. **数据筛选逻辑**
- 支持按渠道筛选订单数据
- 先按渠道过滤订单,再按一级分类聚合
- 空数据友好提示: 显示可用渠道列表

### 3. **闪购小程序数据支持**
- 使用 `calc_mode='all_with_fallback'` 模式
- 包含平台费用为0的订单(闪购小程序的102个订单)
- 确保利润计算准确性

## 🔧 技术实现

### 修改点1: UI组件 (第10900行附近)

**修改前:**
```python
dbc.CardHeader([
    dbc.Row([
        dbc.Col(html.H5("🏷️ 一级分类销售趋势", className="mb-0"), width=8),
        dbc.Col([导出按钮], width=4)
    ])
])
```

**修改后:**
```python
dbc.CardHeader([
    dbc.Row([
        dbc.Col([html.H5("🏷️ 一级分类销售趋势")], width=4),
        dbc.Col([
            # 🆕 渠道筛选下拉菜单
            dcc.Dropdown(
                id='category-trend-channel-filter',
                options=channel_options,
                value='all',
                placeholder='选择渠道',
                clearable=False
            )
        ], width=4),
        dbc.Col([导出按钮], width=4)
    ])
])
```

### 修改点2: 图表容器 (第10900行附近)

**修改前:**
```python
dbc.CardBody([chart_component])
```

**修改后:**
```python
dbc.CardBody([
    # 🆕 图表容器 (通过callback动态更新)
    html.Div(id='category-trend-chart-container', 
             children=[chart_component])
])
```

### 修改点3: 函数签名 (第8706行)

**修改前:**
```python
def create_category_trend_chart_echarts(df, order_agg):
```

**修改后:**
```python
def create_category_trend_chart_echarts(df, order_agg, selected_channel='all'):
    """
    ...
    参数:
    - df: 原始数据DataFrame
    - order_agg: 订单聚合数据
    - selected_channel: 选中的渠道 ('all'表示全部渠道)
    """
```

### 修改点4: 渠道筛选逻辑 (第8770行附近)

**添加位置:** 在分类聚合之前

```python
# 🆕 渠道筛选逻辑
channel_available = '渠道' in order_agg_with_category.columns
if selected_channel != 'all' and channel_available:
    before_filter = len(order_agg_with_category)
    order_agg_with_category = order_agg_with_category[
        order_agg_with_category['渠道'] == selected_channel
    ].copy()
    after_filter = len(order_agg_with_category)
    print(f"🔍 渠道筛选: {before_filter} -> {after_filter} 订单 (渠道='{selected_channel}')")
    
    # 空数据提示
    if after_filter == 0:
        available_channels = sorted(order_agg['渠道'].dropna().unique())
        msg = f"⚠️ 渠道 '{selected_channel}' 暂无分类数据\n\n可用渠道: {', '.join(available_channels)}"
        return html.Div([dbc.Alert(msg, color="info", style={'whiteSpace': 'pre-wrap'})])
```

### 修改点5: Callback函数 (第11300行附近)

```python
@app.callback(
    Output('category-trend-chart-container', 'children'),
    Input('category-trend-channel-filter', 'value'),
    prevent_initial_call=False
)
def update_category_trend_by_channel(selected_channel):
    """根据渠道筛选更新一级分类销售趋势图"""
    try:
        if GLOBAL_DATA is None or GLOBAL_DATA.empty:
            return dbc.Alert("⚠️ 数据不可用", color="warning")
        
        df = GLOBAL_DATA.copy()
        
        # 检查分类字段
        if '一级分类名' not in df.columns:
            return dbc.Alert("⚠️ 数据中缺少【一级分类名】字段", color="warning")
        
        # 🔧 使用all_with_fallback模式,保留所有订单(包括闪购小程序)
        order_agg = calculate_order_metrics(df, calc_mode='all_with_fallback')
        
        # 调用修改后的图表生成函数
        if ECHARTS_AVAILABLE:
            return create_category_trend_chart_echarts(df, order_agg, selected_channel)
        else:
            # Plotly备份方案...
            
    except Exception as e:
        print(f"❌ 错误: {e}")
        return dbc.Alert(f"图表更新失败: {str(e)}", color="danger")
```

## 📊 数据流程

```
用户选择渠道
    ↓
Callback触发: update_category_trend_by_channel(selected_channel)
    ↓
加载全局数据: GLOBAL_DATA
    ↓
订单聚合: calculate_order_metrics(df, calc_mode='all_with_fallback')
    ↓
调用图表函数: create_category_trend_chart_echarts(df, order_agg, selected_channel)
    ↓
合并分类信息: order_agg + order_category_map
    ↓
渠道筛选: order_agg_with_category[渠道 == selected_channel]
    ↓
分类聚合: groupby('一级分类名').agg(...)
    ↓
生成图表: ECharts柱状图 + 折线图
    ↓
更新容器: category-trend-chart-container
```

## 🎯 使用场景

### 场景1: 查看全部渠道分类数据
1. 选择"全部渠道"(默认)
2. 显示所有渠道的分类销售汇总
3. 包含所有5,900个订单

### 场景2: 查看特定渠道分类表现
1. 选择"美团闪购"
2. 只显示美团闪购3,479个订单的分类数据
3. 分析该渠道的品类结构

### 场景3: 分析闪购小程序分类
1. 选择"闪购小程序"
2. 显示102个订单的分类分布
3. 验证利润率和销售额
4. 确认数据正确包含(之前被过滤)

## ✅ 测试验证

### 自动验证脚本
运行 `验证分类趋势渠道筛选.py` 验证所有修改点:

```bash
python 验证分类趋势渠道筛选.py
```

验证项:
- ✅ UI下拉框 (category-trend-channel-filter)
- ✅ 图表容器 (category-trend-chart-container)
- ✅ 函数签名参数 (selected_channel='all')
- ✅ 渠道筛选逻辑
- ✅ Callback函数
- ✅ 使用all_with_fallback模式

### 手动测试步骤

1. **启动系统**
   ```bash
   python 智能门店看板_Dash版.py
   ```

2. **访问看板**
   - 浏览器打开: http://localhost:8050
   - 上传测试数据

3. **测试渠道筛选**
   - 找到"🏷️ 一级分类销售趋势"卡片
   - 确认标题行有渠道下拉框
   - 依次选择每个渠道:
     * 全部渠道 → 显示所有分类数据
     * 美团闪购 → 显示美团分类数据
     * 饿了么 → 显示饿了么分类数据
     * 京东到家 → 显示京东分类数据
     * 闪购小程序 → 显示闪购小程序分类数据

4. **验证闪购小程序**
   - 选择"闪购小程序"
   - 确认有数据显示(之前为空)
   - 检查利润额和销售额是否正确

5. **空数据测试**
   - 如果某渠道无数据
   - 应显示友好提示
   - 提示中包含可用渠道列表

## 📈 数据对比

### 全部渠道 vs 单一渠道

| 渠道 | 订单数 | 销售额 | 利润额 | 利润率 |
|------|--------|--------|--------|--------|
| 全部渠道 | 5,900 | ~1,000,000元 | ~56,420元 | ~5.6% |
| 美团闪购 | 3,479 | ~600,000元 | ~35,000元 | ~5.8% |
| 饿了么 | 2,037 | ~350,000元 | ~19,000元 | ~5.4% |
| 京东到家 | 282 | ~40,000元 | ~2,000元 | ~5.0% |
| 闪购小程序 | 102 | ~10,000元 | ~420元 | ~4.2% |

## 🔄 与销售趋势筛选对比

| 特性 | 销售趋势分析 | 一级分类销售趋势 |
|------|-------------|------------------|
| 渠道筛选 | ✅ 支持 | ✅ 支持 |
| 下拉框位置 | 标题行右侧 | 标题行中间 |
| 图表类型 | 日度折线图 | 分类柱状图+折线图 |
| 计算模式 | all_with_fallback | all_with_fallback |
| 闪购小程序 | ✅ 包含 | ✅ 包含 |
| 空数据提示 | ✅ 友好提示 | ✅ 友好提示 |

## 💡 设计理念

1. **一致性**: 与销售趋势分析保持相同的交互模式
2. **完整性**: 使用all_with_fallback模式,确保所有订单都被统计
3. **友好性**: 空数据时提供可用渠道列表
4. **性能**: 使用callback动态更新,避免重新加载整个页面
5. **可维护性**: 复用现有channel_options,减少重复代码

## 🐛 已知问题

无

## 📝 后续优化建议

1. **缓存优化**: 按渠道缓存分类聚合结果
2. **导出功能**: 导出时包含渠道信息
3. **对比分析**: 支持多渠道对比(如:美团 vs 饿了么)
4. **趋势分析**: 按渠道显示分类增长趋势

## 📚 相关文件

- `智能门店看板_Dash版.py`: 主文件,包含所有修改
- `验证分类趋势渠道筛选.py`: 自动验证脚本
- `利润计算逻辑说明.md`: 利润计算模式说明

## 👥 影响范围

- **用户界面**: Tab1 一级分类销售趋势卡片
- **数据处理**: create_category_trend_chart_echarts函数
- **回调函数**: 新增update_category_trend_by_channel
- **数据完整性**: 确保闪购小程序数据被正确统计

## ✨ 总结

通过5个关键修改点,成功为一级分类销售趋势模块添加了渠道筛选功能:
1. UI下拉框 (用户交互)
2. 图表容器 (动态更新)
3. 函数参数 (支持渠道传递)
4. 筛选逻辑 (数据过滤)
5. Callback (响应交互)

功能实现与销售趋势分析保持一致,用户体验良好,数据准确完整。
