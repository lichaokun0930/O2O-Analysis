# 企业级监控升级规划

## 已完成（高优先级）

### 1. 日志聚合服务 ✅

**文件**: `backend/app/services/logging_service.py`

**功能**:
- 结构化日志（JSON格式）
- 日志轮转（按天，保留30天）
- 请求追踪（trace_id）
- 慢请求告警（>500ms）
- API访问日志

**日志文件**:
```
logs/
├── app_2026-01-20.log       # 应用日志（JSON）
├── error_2026-01-20.log     # 错误日志
├── slow_requests_2026-01-20.log  # 慢请求日志
├── access_2026-01-20.log    # 访问日志
└── errors/                  # 错误详情
    └── errors_2026-01-20.jsonl
```

### 2. 健康监控服务 ✅

**文件**: `backend/app/services/health_service.py`

**功能**:
- 深度健康检查（数据库、Redis、DuckDB、系统资源）
- 性能指标收集（CPU、内存、QPS、错误率、延迟）
- 告警阈值检测
- 指标历史（最近1小时）

**告警阈值**:
| 指标 | 阈值 |
|------|------|
| CPU | 80% |
| 内存 | 85% |
| 磁盘 | 90% |
| API延迟 | 500ms |
| 数据库延迟 | 100ms |
| Redis延迟 | 50ms |
| 错误率 | 5% |

### 3. 错误追踪服务 ✅

**文件**: `backend/app/services/error_tracking_service.py`

**功能**:
- 异常自动捕获
- 错误聚合和去重（相同错误只记录一次，计数增加）
- 错误趋势分析
- 完整堆栈和上下文

### 4. 可观测性中间件 ✅

**文件**: `backend/app/middleware/observability.py`

**功能**:
- 自动生成 trace_id
- 请求日志记录
- 性能指标收集
- 错误自动捕获

### 5. 可观测性 API ✅

**路由**: `/api/v1/observability/*`

| 接口 | 说明 |
|------|------|
| GET /health/full | 完整健康检查 |
| GET /health/database | 数据库健康 |
| GET /health/redis | Redis健康 |
| GET /health/system | 系统资源 |
| GET /metrics | 性能指标 |
| GET /alerts | 当前告警 |
| GET /logs | 日志查询 |
| GET /logs/errors | 错误统计 |
| GET /logs/slow-requests | 慢请求列表 |
| GET /errors | 错误列表 |
| GET /errors/summary | 错误摘要 |
| GET /errors/top | 高频错误 |
| GET /errors/{id} | 错误详情 |
| GET /dashboard | 监控仪表板 |

---

## 后续升级（中优先级）

### 1. Prometheus + Grafana 监控

**用途**: 可视化监控仪表板

**实施步骤**:
1. 安装 Prometheus（指标收集）
2. 安装 Grafana（可视化）
3. 添加 `prometheus-fastapi-instrumentator` 依赖
4. 配置 Prometheus 抓取 `/metrics` 端点
5. 导入 Grafana 仪表板模板

**预估工作量**: 2-4小时

**依赖**:
```bash
pip install prometheus-fastapi-instrumentator
```

### 2. Sentry 错误追踪

**用途**: 专业错误追踪平台（可选云服务或自建）

**实施步骤**:
1. 注册 Sentry 账号（或自建 Sentry）
2. 安装 `sentry-sdk[fastapi]`
3. 配置 DSN
4. 前端也可接入

**预估工作量**: 1-2小时

**依赖**:
```bash
pip install sentry-sdk[fastapi]
```

**代码示例**:
```python
import sentry_sdk
sentry_sdk.init(
    dsn="https://xxx@sentry.io/xxx",
    traces_sample_rate=0.1,
)
```

### 3. ELK/Loki 日志聚合

**用途**: 集中日志查看和搜索

**方案选择**:
- **Loki + Grafana**（轻量，推荐）
- **ELK Stack**（功能强大，资源消耗大）

**实施步骤**:
1. 安装 Loki（日志存储）
2. 配置 Promtail（日志收集）
3. Grafana 添加 Loki 数据源
4. 创建日志查询面板

**预估工作量**: 4-8小时

---

## 后续升级（低优先级）

### 1. Kubernetes 容器编排

**适用场景**: 多实例部署、自动扩缩容

**当前状态**: 单机部署，16核CPU足够

**何时需要**:
- 需要高可用（多实例）
- 需要自动扩缩容
- 需要跨机器部署

### 2. 消息队列（Celery/RabbitMQ）

**适用场景**: 异步任务、任务队列

**当前状态**: APScheduler 定时任务足够

**何时需要**:
- 大量异步任务
- 任务需要重试机制
- 分布式任务调度

### 3. 负载均衡

**适用场景**: 多实例流量分发

**当前状态**: Nginx 单实例

**何时需要**:
- 单机性能不足
- 需要高可用

---

## 使用指南

### 查看监控仪表板

```bash
# 获取完整监控数据
curl http://localhost:8080/api/v1/observability/dashboard
```

### 查看健康状态

```bash
# 完整健康检查
curl http://localhost:8080/api/v1/observability/health/full
```

### 查看错误列表

```bash
# 最近错误
curl http://localhost:8080/api/v1/observability/errors

# 错误详情
curl http://localhost:8080/api/v1/observability/errors/{error_id}
```

### 查看慢请求

```bash
curl http://localhost:8080/api/v1/observability/logs/slow-requests
```

### 查看日志文件

```powershell
# 应用日志
Get-Content logs\app_2026-01-20.log -Tail 50

# 错误日志
Get-Content logs\error_2026-01-20.log -Tail 50

# 慢请求日志
Get-Content logs\slow_requests_2026-01-20.log -Tail 50
```

---

## 更新日期

- 2026-01-20: 完成高优先级监控功能
