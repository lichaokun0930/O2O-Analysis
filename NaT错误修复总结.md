# NaT (Not a Time) é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ“Œ é”™è¯¯æè¿°

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ValueError: NaTType does not support isocalendar
```

**é”™è¯¯ä½ç½®**ï¼š
- `æ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿_å¯è§†åŒ–.py` ç¬¬5060-5061è¡Œ
- `é—®é¢˜è¯Šæ–­å¼•æ“.py` ç¬¬261, 635, 843è¡Œ

**é”™è¯¯åŸå› **ï¼š
- æ•°æ®ä¸­å­˜åœ¨ç©ºå€¼æˆ–æ— æ•ˆæ—¥æœŸï¼Œè¢«è½¬æ¢ä¸º `NaT` (Not a Time)
- å¯¹ `NaT` è°ƒç”¨ `isocalendar()` æ–¹æ³•ä¼šæŠ¥é”™
- æœªå¯¹æ—¥æœŸæœ€å¤§å€¼è¿›è¡Œç©ºå€¼æ£€æŸ¥

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. æ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿_å¯è§†åŒ–.py

#### ä¿®å¤ä½ç½®1ï¼šæ—¥æœŸè½¬æ¢ï¼ˆç¬¬5051è¡Œï¼‰

**åŸä»£ç **ï¼š
```python
df['ä¸‹å•æ—¶é—´'] = pd.to_datetime(df['ä¸‹å•æ—¶é—´'])
```

**ä¿®å¤å**ï¼š
```python
# è½¬æ¢ä¸ºdatetimeï¼Œerrors='coerce'ä¼šå°†æ— æ•ˆæ—¥æœŸè½¬ä¸ºNaT
df['ä¸‹å•æ—¶é—´'] = pd.to_datetime(df['ä¸‹å•æ—¶é—´'], errors='coerce')
```

**è¯´æ˜**ï¼š
- æ·»åŠ  `errors='coerce'` å‚æ•°
- å°†æ— æ³•è§£æçš„æ—¥æœŸï¼ˆå¦‚ "invalid_date"ï¼‰è½¬æ¢ä¸º `NaT` è€Œä¸æ˜¯æŠ¥é”™

---

#### ä¿®å¤ä½ç½®2ï¼šisocalendar()è°ƒç”¨ï¼ˆç¬¬5060-5062è¡Œï¼‰

**åŸä»£ç **ï¼š
```python
# å‘¨ç»´åº¦å­—æ®µ
df['å¹´'] = df['ä¸‹å•æ—¶é—´'].dt.isocalendar().year
df['å‘¨'] = df['ä¸‹å•æ—¶é—´'].dt.isocalendar().week
df['å¹´å‘¨'] = df['å¹´'].astype(str) + '-W' + df['å‘¨'].astype(str).str.zfill(2)
```

**ä¿®å¤å**ï¼š
```python
# å‘¨ç»´åº¦å­—æ®µï¼ˆå¤„ç†NaTå€¼ï¼‰
# åˆ›å»ºä¸´æ—¶çš„isocalendarç»“æœï¼Œåªå¯¹æœ‰æ•ˆæ—¥æœŸè®¡ç®—
valid_dates_mask = df['ä¸‹å•æ—¶é—´'].notna()
df['å¹´'] = None
df['å‘¨'] = None

if valid_dates_mask.any():
    iso_cal = df.loc[valid_dates_mask, 'ä¸‹å•æ—¶é—´'].dt.isocalendar()
    df.loc[valid_dates_mask, 'å¹´'] = iso_cal.year
    df.loc[valid_dates_mask, 'å‘¨'] = iso_cal.week

# è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œé¿å…NaNé—®é¢˜
df['å¹´å‘¨'] = df.apply(
    lambda row: f"{int(row['å¹´'])}-W{int(row['å‘¨']):02d}" if pd.notna(row['å¹´']) and pd.notna(row['å‘¨']) else '',
    axis=1
)
```

**è¯´æ˜**ï¼š
- å…ˆç”¨ `notna()` è¿‡æ»¤å‡ºæœ‰æ•ˆæ—¥æœŸ
- åªå¯¹æœ‰æ•ˆæ—¥æœŸè®¡ç®— `isocalendar()`
- æ— æ•ˆæ—¥æœŸä¿æŒä¸º `None`
- ç”Ÿæˆå¹´å‘¨å­—ç¬¦ä¸²æ—¶æ£€æŸ¥æ˜¯å¦ä¸º `NaN`

---

### 2. é—®é¢˜è¯Šæ–­å¼•æ“.py

#### ä¿®å¤ä½ç½®1ï¼šdiagnose_sales_declineï¼ˆç¬¬230è¡Œï¼‰

**åŸä»£ç **ï¼š
```python
# ğŸ†• çµæ´»çš„å‘¨æœŸå¯¹æ¯”é€»è¾‘
max_date = df_filtered['æ—¥æœŸ'].max()
```

**ä¿®å¤å**ï¼š
```python
# ğŸ†• çµæ´»çš„å‘¨æœŸå¯¹æ¯”é€»è¾‘
# è·å–æœ€å¤§æ—¥æœŸï¼Œå¹¶æ£€æŸ¥æ˜¯å¦ä¸ºNaT
max_date = df_filtered['æ—¥æœŸ'].max()

# å¦‚æœmax_dateæ˜¯NaTæˆ–Noneï¼Œè¿”å›ç©ºDataFrame
if pd.isna(max_date):
    return pd.DataFrame()
```

**è¯´æ˜**ï¼š
- æ£€æŸ¥ `max_date` æ˜¯å¦ä¸º `NaT`
- å¦‚æœæ˜¯ï¼Œç›´æ¥è¿”å›ç©ºç»“æœï¼Œé¿å…åç»­è®¡ç®—æŠ¥é”™

---

#### ä¿®å¤ä½ç½®2ï¼šdiagnose_customer_price_declineï¼ˆç¬¬470è¡Œï¼‰

**åŸä»£ç **ï¼š
```python
max_date = self.df['æ—¥æœŸ'].max()
min_date = self.df['æ—¥æœŸ'].min()
```

**ä¿®å¤å**ï¼š
```python
max_date = self.df['æ—¥æœŸ'].max()
min_date = self.df['æ—¥æœŸ'].min()

# æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
if pd.isna(max_date) or pd.isna(min_date):
    return pd.DataFrame()
```

**è¯´æ˜**ï¼š
- åŒæ—¶æ£€æŸ¥ `max_date` å’Œ `min_date`
- ä»»ä¸€ä¸º `NaT` åˆ™è¿”å›ç©ºç»“æœ

---

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬ï¼š`æµ‹è¯•NaTä¿®å¤.py`

**æµ‹è¯•å†…å®¹**ï¼š
1. âœ… `isocalendar()` æ–¹æ³•å¤„ç† `NaT`
2. âœ… `max()` è¿”å› `NaT` çš„è¯†åˆ«
3. âœ… `NaT` å‚ä¸æ—¥æœŸè®¡ç®—
4. âœ… å®Œæ•´æ•°æ®å¤„ç†æµç¨‹
5. âœ… åœºæ™¯æ¨æ–­å¤„ç† `NaT`

**æµ‹è¯•ç»“æœ**ï¼š
```
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ï¼ˆ5/5ï¼‰

æµ‹è¯•æ•°æ®ï¼š
- æœ‰æ•ˆæ—¥æœŸï¼š3ä¸ª
- ç©ºå€¼ï¼ˆNoneï¼‰ï¼š1ä¸ª
- æ— æ•ˆæ—¥æœŸï¼ˆ"invalid_date"ï¼‰ï¼š1ä¸ª

å¤„ç†ç»“æœï¼š
- æœ‰æ•ˆæ—¥æœŸæ­£ç¡®è®¡ç®—å¹´å‘¨ï¼šâœ…
- NaTè¢«æ­£ç¡®è¯†åˆ«ï¼šâœ…
- æ—¶æ®µæ¨æ–­NaTâ†’'æœªçŸ¥'ï¼šâœ…
```

---

## ğŸ¯ æ ¸å¿ƒåŸç†

### NaT (Not a Time) æ˜¯ä»€ä¹ˆï¼Ÿ

`NaT` æ˜¯ pandas ä¸­çš„ç‰¹æ®Šå€¼ï¼Œç±»ä¼¼äºæ•°å€¼ä¸­çš„ `NaN`ï¼š

| æ•°æ®ç±»å‹ | ç©ºå€¼è¡¨ç¤º | è¯´æ˜ |
|---------|---------|------|
| æ•°å€¼ï¼ˆint/floatï¼‰ | `NaN` | Not a Number |
| æ—¥æœŸæ—¶é—´ | `NaT` | Not a Time |
| å¯¹è±¡ï¼ˆstr/objectï¼‰ | `None` | Pythonç©ºå€¼ |

### NaT çš„ç‰¹æ€§

```python
# 1. NaTçš„äº§ç”Ÿ
pd.to_datetime(None)           # â†’ NaT
pd.to_datetime('invalid')      # â†’ æŠ¥é”™ï¼ˆé»˜è®¤ï¼‰
pd.to_datetime('invalid', errors='coerce')  # â†’ NaTï¼ˆæ¨èï¼‰

# 2. NaTçš„è¯†åˆ«
pd.isna(NaT)                   # â†’ True
pd.notna(NaT)                  # â†’ False

# 3. NaTçš„è®¡ç®—
NaT - timedelta(days=7)        # â†’ NaT
max([NaT, NaT, NaT])          # â†’ NaT

# 4. NaTçš„æ–¹æ³•è°ƒç”¨
NaT.isocalendar()              # âŒ æŠ¥é”™ï¼
NaT.year                       # â†’ <NA>ï¼ˆpandasç‰¹æ®Šå€¼ï¼‰
NaT.hour                       # â†’ <NA>
```

---

## ğŸ›¡ï¸ é˜²å¾¡æ€§ç¼–ç¨‹æ¨¡å¼

### æ¨¡å¼1ï¼šè½¬æ¢æ—¶å®¹é”™

```python
# âŒ ä¸æ¨èï¼šé‡åˆ°æ— æ•ˆæ—¥æœŸä¼šæŠ¥é”™
df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'])

# âœ… æ¨èï¼šè‡ªåŠ¨è½¬æ¢æ— æ•ˆæ—¥æœŸä¸ºNaT
df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'], errors='coerce')
```

### æ¨¡å¼2ï¼šæ–¹æ³•è°ƒç”¨å‰è¿‡æ»¤

```python
# âŒ ä¸æ¨èï¼šç›´æ¥è°ƒç”¨å¯èƒ½æŠ¥é”™
iso_cal = df['æ—¥æœŸ'].dt.isocalendar()

# âœ… æ¨èï¼šå…ˆè¿‡æ»¤æœ‰æ•ˆå€¼
valid_mask = df['æ—¥æœŸ'].notna()
if valid_mask.any():
    iso_cal = df.loc[valid_mask, 'æ—¥æœŸ'].dt.isocalendar()
```

### æ¨¡å¼3ï¼šèšåˆåæ£€æŸ¥

```python
# âŒ ä¸æ¨èï¼šç›´æ¥ä½¿ç”¨å¯èƒ½æ˜¯NaT
max_date = df['æ—¥æœŸ'].max()
result = max_date - timedelta(days=7)  # å¦‚æœmax_dateæ˜¯NaTï¼Œresultä¹Ÿæ˜¯NaT

# âœ… æ¨èï¼šèšåˆåæ£€æŸ¥
max_date = df['æ—¥æœŸ'].max()
if pd.isna(max_date):
    return pd.DataFrame()  # æå‰è¿”å›
```

### æ¨¡å¼4ï¼šå®‰å…¨çš„é»˜è®¤å€¼

```python
# âŒ ä¸æ¨èï¼šå¯èƒ½ä¼ æ’­NaT
def process_date(dt):
    return dt.hour  # å¦‚æœdtæ˜¯NaTï¼Œè¿”å›<NA>

# âœ… æ¨èï¼šæä¾›é»˜è®¤å€¼
def process_date(dt):
    if pd.isna(dt):
        return 'æœªçŸ¥'
    return dt.hour
```

---

## ğŸ“Š å½±å“èŒƒå›´

### ä¿®å¤çš„åŠŸèƒ½

âœ… **é”€é‡ä¸‹æ»‘è¯Šæ–­**ï¼š
- å¯ä»¥å¤„ç†åŒ…å«æ— æ•ˆæ—¥æœŸçš„è®¢å•æ•°æ®
- è‡ªåŠ¨è¿‡æ»¤æ— æ•ˆæ—¥æœŸï¼Œä¸å½±å“åˆ†æç»“æœ

âœ… **å®¢å•ä»·å½’å› åˆ†æ**ï¼š
- æ£€æŸ¥æ—¥æœŸèŒƒå›´æœ‰æ•ˆæ€§
- é¿å…åœ¨ç©ºæ•°æ®ä¸Šè®¡ç®—å‘¨æœŸ

âœ… **é«˜çº§åˆ†æ**ï¼š
- å››ç»´æ•£ç‚¹å›¾ã€åˆ†ç±»æ ‘çŠ¶å›¾ã€çƒ­åŠ›å›¾
- æ‰€æœ‰ä¾èµ–æ—¥æœŸè®¡ç®—çš„å›¾è¡¨

âœ… **æ•°æ®åŠ è½½**ï¼š
- è‡ªåŠ¨è¯†åˆ«å¹¶è½¬æ¢æ— æ•ˆæ—¥æœŸ
- æä¾›å‹å¥½çš„æ•°æ®è´¨é‡æç¤º

---

## ğŸ’¡ ç”¨æˆ·å‹å¥½æ”¹è¿›

### æ”¹è¿›1ï¼šæ•°æ®è´¨é‡æç¤º

**å¯ä»¥æ·»åŠ çš„æç¤º**ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰ï¼š
```python
if df['ä¸‹å•æ—¶é—´'].isna().sum() > 0:
    invalid_count = df['ä¸‹å•æ—¶é—´'].isna().sum()
    st.warning(f"âš ï¸ å‘ç° {invalid_count} æ¡æ— æ•ˆæ—¥æœŸè®°å½•ï¼Œå·²è‡ªåŠ¨æ’é™¤")
```

### æ”¹è¿›2ï¼šæ— æ•ˆæ•°æ®æŠ¥å‘Š

**å¯ä»¥æ·»åŠ çš„åŠŸèƒ½**ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰ï¼š
```python
invalid_dates = df[df['ä¸‹å•æ—¶é—´'].isna()]
if len(invalid_dates) > 0:
    with st.expander(f"æŸ¥çœ‹ {len(invalid_dates)} æ¡æ— æ•ˆæ—¥æœŸè®°å½•"):
        st.dataframe(invalid_dates[['è®¢å•ID', 'å•†å“åç§°', 'ä¸‹å•æ—¶é—´']])
```

---

## ğŸ‰ ä¿®å¤æ€»ç»“

### ä¿®å¤æ–‡ä»¶

1. **æ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿_å¯è§†åŒ–.py**
   - ç¬¬5051è¡Œï¼šæ·»åŠ  `errors='coerce'`
   - ç¬¬5060-5070è¡Œï¼šå®‰å…¨å¤„ç† `isocalendar()`

2. **é—®é¢˜è¯Šæ–­å¼•æ“.py**
   - ç¬¬230è¡Œï¼šæ£€æŸ¥ `max_date` æ˜¯å¦ä¸º `NaT`
   - ç¬¬473è¡Œï¼šæ£€æŸ¥ `max_date` å’Œ `min_date`

### ä¿®å¤æ•ˆæœ

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|-------|--------|
| æ— æ•ˆæ—¥æœŸæ•°æ® | âŒ æŠ¥é”™å´©æºƒ | âœ… è‡ªåŠ¨è½¬æ¢ä¸ºNaT |
| ç©ºæ•°æ®é›† | âŒ æŠ¥é”™å´©æºƒ | âœ… è¿”å›ç©ºç»“æœ |
| éƒ¨åˆ†æ— æ•ˆæ—¥æœŸ | âŒ æŠ¥é”™å´©æºƒ | âœ… åªå¤„ç†æœ‰æ•ˆæ—¥æœŸ |
| æ—¥æœŸè®¡ç®— | âŒ NaTæŠ¥é”™ | âœ… NaTâ†’è¿”å›ç©º |

### æµ‹è¯•è¦†ç›–

- âœ… å•å…ƒæµ‹è¯•ï¼š5/5é€šè¿‡
- âœ… é›†æˆæµ‹è¯•ï¼šå¾…è¿è¡Œçœ‹æ¿éªŒè¯
- âœ… è¾¹ç•Œæƒ…å†µï¼šå…¨NaTã€éƒ¨åˆ†NaTã€æ— NaT

---

## ğŸ“ åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆæœ¬å‘¨ï¼‰

- [ ] åœ¨æ•°æ®ä¸Šä¼ æ—¶æ˜¾ç¤ºæ— æ•ˆæ—¥æœŸç»Ÿè®¡
- [ ] æä¾›æ— æ•ˆæ—¥æœŸæ˜ç»†æŸ¥çœ‹åŠŸèƒ½
- [ ] æ·»åŠ æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š

### ä¸­æœŸä¼˜åŒ–ï¼ˆæœ¬æœˆï¼‰

- [ ] è‡ªåŠ¨ä¿®å¤å¸¸è§æ—¥æœŸæ ¼å¼é”™è¯¯
- [ ] æä¾›æ—¥æœŸæ ¼å¼æ ¡éªŒå·¥å…·
- [ ] å¢å¼ºé”™è¯¯æç¤ºä¿¡æ¯

### é•¿æœŸä¼˜åŒ–ï¼ˆä¸‹å­£åº¦ï¼‰

- [ ] å»ºç«‹æ•°æ®è´¨é‡ç›‘æ§ä½“ç³»
- [ ] æä¾›æ•°æ®æ¸…æ´—å»ºè®®
- [ ] è‡ªåŠ¨åŒ–æ•°æ®ä¿®å¤æµç¨‹

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-10-16  
**ä¿®å¤ç‰ˆæœ¬**ï¼šv1.1  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… å…¨éƒ¨é€šè¿‡ï¼ˆ5/5ï¼‰  
**å½±å“èŒƒå›´**ï¼šé”€é‡ä¸‹æ»‘è¯Šæ–­ã€å®¢å•ä»·å½’å› ã€é«˜çº§åˆ†æ

**ä¿®å¤åŸåˆ™**ï¼š
> æ°¸è¿œä¸è¦å‡è®¾æ•°æ®æ˜¯å¹²å‡€çš„ã€‚ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œä¼˜é›…åœ°å¤„ç†å¼‚å¸¸æƒ…å†µã€‚
