# 下滑商品信息结构化改进说明

## 📋 改进概述

根据您的反馈:"**问题归因不要和商品融合在一起,商品列展示的就是商品名称,其它信息都有自己单独的列来展示**",我已经将下滑商品的信息拆分成独立的列。

---

## 🔄 改进前后对比

### 改进前（信息挤在一个单元格）
```
下滑TOP1商品 | 下滑TOP2商品 | 下滑TOP3商品 | ...
-------------|-------------|-------------|
【饮料】可口可乐(¥4.0 之前¥3.5) → 💰涨价导致销量降 | 【零食】薯片(¥0.0 之前¥5.2) → 🔴售罄 | ...
```

**问题**:
- ❌ 信息密集,难以阅读
- ❌ 无法按商品名称搜索
- ❌ 无法按价格排序
- ❌ 无法按原因筛选
- ❌ 字段过长,表格显示拥挤

### 改进后（信息分列展示）
```
TOP1-商品名称 | TOP1-分类 | TOP1-当前单价 | TOP1-之前单价 | TOP1-单价变化 | TOP1-销量变化 | TOP1-下滑原因 | ...
-------------|----------|--------------|--------------|--------------|--------------|--------------|
可口可乐      | 饮料     | ¥4.0         | ¥3.5         | ¥+0.5        | -20件        | 💰涨价导致销量降 | ...
```

**优势**:
- ✅ **商品名称独立** - 便于搜索和筛选
- ✅ **价格信息独立** - 便于排序和对比
- ✅ **变化量独立** - 变化趋势一目了然
- ✅ **下滑原因独立** - 便于分类统计
- ✅ **表格整洁** - 每列数据类型一致

---

## 📊 新的列结构

### 基础列（保持不变）
1. `对比周期` - 对比的时间范围
2. `之前客单价` - 对比期客单价
3. `当前客单价` - 当前期客单价
4. `客单价变化` - 客单价变化金额
5. `变化幅度%` - 客单价变化百分比
6. `商品角色分布` - 引流/利润/走量商品分布
7. `问题等级` - 🔴严重 / 🟠警告
8. `建议操作` - 运营建议

### TOP商品列（新结构,每个TOP商品7列）

#### TOP1商品:
1. `TOP1-商品名称` - 商品名称
2. `TOP1-分类` - 三级分类名
3. `TOP1-当前单价` - 当前周期单价
4. `TOP1-之前单价` - 对比周期单价
5. `TOP1-单价变化` - 单价变化(带正负号)
6. `TOP1-销量变化` - 销量变化(带单位"件")
7. `TOP1-下滑原因` - 下滑原因标签

#### TOP2-5商品: 
同样结构,列名改为`TOP2-`、`TOP3-`、`TOP4-`、`TOP5-`前缀

---

## 💡 数据格式说明

### 价格字段格式
- `¥12.5` - 标准价格格式
- 空值 - 如果商品已售罄,当前单价为空

### 单价变化格式
- `¥+0.5` - 涨价0.5元(绿色显示)
- `¥-3.0` - 降价3元(红色显示)
- 空值 - 价格无变化或无对比数据

### 销量变化格式
- `-20件` - 销量下降20件(红色显示)
- `+15件` - 销量上升15件(绿色显示)
- 空值 - 销量无变化或无对比数据

### 下滑原因标签
| 标签 | 含义 |
|-----|------|
| 🔴售罄 | 当前期销量=0,之前期销量>0 |
| 💰涨价导致销量降 | 单价上涨>5% & 销量下降 |
| 💸降价仍降量 | 单价下降>5% & 销量下降 |
| 📉销量大幅下滑 | 销量下降>30% |
| 📉销量小幅下滑 | 销量下降<30% |
| ✅正常 | 无明显问题 |

---

## 📈 使用示例

### 场景1: 查找所有涨价商品
筛选条件: `单价变化` > 0

### 场景2: 查找售罄商品
筛选条件: `下滑原因` = "🔴售罄"

### 场景3: 按销量下滑排序
排序字段: `销量变化` 升序

### 场景4: 统计各原因数量
分组统计: `下滑原因`

---

## 🔧 技术实现

### 数据结构变更
```python
# 改进前: 返回字符串列表
def _get_top_declining_products_with_reason(...) -> list:
    return [
        "【饮料】可口可乐(¥4.0 之前¥3.5) → 💰涨价导致销量降",
        "【零食】薯片(¥0.0 之前¥5.2) → 🔴售罄",
        ...
    ]

# 改进后: 返回结构化字典
def _get_top_declining_products_with_reason(...) -> dict:
    return {
        '商品名称': ['可口可乐', '薯片', ...],
        '分类': ['饮料', '零食', ...],
        '当前单价': [4.0, 0.0, ...],
        '之前单价': [3.5, 5.2, ...],
        '单价变化': [0.5, -5.2, ...],
        '销量变化': [-20, -50, ...],
        '下滑原因': ['💰涨价导致销量降', '🔴售罄', ...]
    }
```

### 列展开逻辑
```python
# 将字典数据展开成DataFrame列
results.append({
    '对比周期': period_label,
    ...
    # TOP1商品
    'TOP1-商品名称': top_products_dict['商品名称'][0],
    'TOP1-分类': top_products_dict['分类'][0],
    'TOP1-当前单价': top_products_dict['当前单价'][0],
    'TOP1-之前单价': top_products_dict['之前单价'][0],
    'TOP1-单价变化': top_products_dict['单价变化'][0],
    'TOP1-销量变化': top_products_dict['销量变化'][0],
    'TOP1-下滑原因': top_products_dict['下滑原因'][0],
    # TOP2-5同理
    ...
})
```

### 数值格式化
```python
# 格式化价格和变化量
for i in range(1, 6):
    # 当前单价: ¥12.5 或 空
    result[f'TOP{i}-当前单价'] = result[f'TOP{i}-当前单价'].apply(
        lambda x: f"¥{x:.1f}" if x > 0 else ''
    )
    
    # 单价变化: ¥+0.5 或 ¥-3.0 或 空
    result[f'TOP{i}-单价变化'] = result[f'TOP{i}-单价变化'].apply(
        lambda x: f"¥{x:+.1f}" if x != 0 else ''
    )
    
    # 销量变化: -20件 或 +15件 或 空
    result[f'TOP{i}-销量变化'] = result[f'TOP{i}-销量变化'].apply(
        lambda x: f"{x:+.0f}件" if x != 0 else ''
    )
```

---

## 🎯 查看新结构

### 访问看板
打开浏览器访问: **http://localhost:8502**

### 导航到客单价归因
1. 点击 **Tab4 - 问题诊断**
2. 选择 **客单价归因分析**
3. 选择 **按日分析** 或 **按周分析**
4. 查看结果表格

### 期望看到的列结构
```
对比周期 | 之前客单价 | 当前客单价 | 客单价变化 | 变化幅度% | 
TOP1-商品名称 | TOP1-分类 | TOP1-当前单价 | TOP1-之前单价 | TOP1-单价变化 | TOP1-销量变化 | TOP1-下滑原因 |
TOP2-商品名称 | TOP2-分类 | TOP2-当前单价 | TOP2-之前单价 | TOP2-单价变化 | TOP2-销量变化 | TOP2-下滑原因 |
...
商品角色分布 | 问题等级 | 建议操作
```

---

## 📝 更新记录

| 日期 | 版本 | 更新内容 |
|-----|------|---------|
| 2025-10-16 | v2.0 | **结构化改进** |
|  |  | - ✅ 将下滑商品信息拆分成独立的列 |
|  |  | - ✅ 商品名称、分类、价格、变化、原因各自独立 |
|  |  | - ✅ 支持按任意维度筛选和排序 |
|  |  | - ✅ 表格显示更清晰,便于分析 |
| 2025-10-16 | v1.0 | 初始版本 - 下滑原因分析功能 |

---

## ✅ 改进验证

### 测试清单
- [ ] 商品名称列独立显示,无其他信息
- [ ] 分类列独立显示
- [ ] 当前单价列独立显示,格式为`¥XX.X`
- [ ] 之前单价列独立显示,格式为`¥XX.X`
- [ ] 单价变化列独立显示,格式为`¥+X.X`或`¥-X.X`
- [ ] 销量变化列独立显示,格式为`+XX件`或`-XX件`
- [ ] 下滑原因列独立显示,仅显示原因标签
- [ ] 可按商品名称搜索
- [ ] 可按价格排序
- [ ] 可按原因筛选

---

**功能状态**: ✅ 已完成
**文件**: 问题诊断引擎.py
**方法**: `_get_top_declining_products_with_reason()` (返回dict)
**应用**: 客单价归因分析、销量下滑诊断
