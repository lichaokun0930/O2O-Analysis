# 智能调价计算器 V2.0 开发文档

## 📋 开发进度

| 阶段 | 任务 | 状态 |
|------|------|------|
| 1 | 创建独立数据处理函数 | ⬜ 待开始 |
| 2 | 实现商品角色识别逻辑 | ⬜ 待开始 |
| 3 | 重构UI布局 | ⬜ 待开始 |
| 4 | 重构主回调函数 | ⬜ 待开始 |
| 5 | 测试验证 | ⬜ 待开始 |

---

## 🎯 核心设计原则

1. **独立性**：不依赖诊断卡片的数据，从原始数据直接计算
2. **业务导向**：融入业务角色（引流款、走量款等）
3. **可操作性**：保留手动调整能力
4. **可解释性**：每个建议都有业务依据

---

## 📊 商品角色定义（10种）

### 角色判断优先级（从高到低）

```
1. 🚀 引流款 - 折扣率<30% 或 (营销占比>15% 且 利润率<5%)
2. 🏷️ 特价款 - 30%≤折扣率<50%
3. 🔴 亏损款 - 利润率<0
4. 📦 低频款 - 30天销量≤5
5. 🌟 明星款 - 高盈利(利润率>20%) + 高动销(销量排名前30%) + 低营销成本(营销占比<10%)
6. 💰 现金牛 - 高盈利 + 高动销 + 高营销成本
7. ⚡ 走量款 - 低盈利(利润率5-20%) + 高动销
8. 💎 潜力款 - 高盈利 + 低动销
9. 🐌 滞销款 - 低盈利 + 低动销(销量排名后30%)
10. ⚪ 正常款 - 其他
```

### 角色调价建议

| 角色 | 调价方向 | 调价建议 | 允许调价 |
|------|---------|---------|---------|
| 🚀 引流款 | -- | 引流商品，不建议调价 | ❌ 禁止 |
| 🏷️ 特价款 | -- | 促销商品，谨慎调价 | ⚠️ 警告 |
| 🔴 亏损款 | 📈 提价 | 必须提价止损 | ✅ 强制 |
| 📦 低频款 | -- | 销量过低，建议观察或下架 | ⚠️ 警告 |
| 🌟 明星款 | 📈 可提价 | 核心商品，可小幅提价测试 | ✅ 允许 |
| 💰 现金牛 | 📈 可提价 | 高利润商品，可试探提价 | ✅ 允许 |
| ⚡ 走量款 | 📈 建议提价 | 薄利多销，建议提价增利 | ✅ 推荐 |
| 💎 潜力款 | 📈 可提价 | 利润好但销量低，可提价 | ✅ 允许 |
| 🐌 滞销款 | 📉 建议降价 | 动销差，建议降价促销 | ✅ 推荐 |
| ⚪ 正常款 | 根据目标 | 根据目标利润率调整 | ✅ 允许 |

---

## 📐 核心计算公式

### 1. 基础指标

```python
# 折扣率 = 实收价格 / 商品原价
折扣率 = 实收价格 / 商品原价 if 商品原价 > 0 else 1

# 单品成本 = 商品采购成本 / 销量（原始数据中成本是总成本）
单品成本 = 商品采购成本 / 销量 if 销量 > 0 else 商品采购成本

# 利润率 = (实收价格 - 单品成本) / 实收价格 × 100%
利润率 = (实收价格 - 单品成本) / 实收价格 * 100 if 实收价格 > 0 else 0

# 营销占比 = 商品分摊营销成本 / 销售额 × 100%
营销占比 = 营销成本 / 销售额 * 100 if 销售额 > 0 else 0
```

### 2. 调价计算

```python
# 目标价格（基于目标利润率）
目标价格 = 单品成本 / (1 - 目标利润率/100)

# 保本价（最低价格）
保本价 = 单品成本

# 最高价（不超过原价）
最高价 = 商品原价

# 建议价格 = min(max(目标价格, 保本价), 最高价)
```

### 3. 弹性预估

```python
# 价格变化率
价格变化率 = (新价格 - 原价格) / 原价格

# 预估销量变化率 = 价格变化率 × 弹性系数
预估销量变化率 = 价格变化率 * 弹性系数  # 弹性系数为负数

# 预估新销量
预估新销量 = 原销量 * (1 + 预估销量变化率)

# 预估利润变化
原利润 = (原价格 - 成本) * 原销量
新利润 = (新价格 - 成本) * 预估新销量
利润变化率 = (新利润 - 原利润) / 原利润 * 100 if 原利润 != 0 else 0
```

---

## 🖥️ UI设计

### 筛选区域

```
商品筛选:
┌────────────┐ ┌────────────┐ ┌────────────┐
│🔴 亏损款    │ │⚡ 走量款    │ │🐌 滞销款    │
│ (必须提价) │ │ (建议提价) │ │ (建议降价) │
└────────────┘ └────────────┘ └────────────┘
┌────────────┐ ┌────────────┐ ┌────────────┐
│🌟 明星款    │ │💎 潜力款    │ │📦 全部商品  │
│ (可提价)   │ │ (可提价)   │ │            │
└────────────┘ └────────────┘ └────────────┘

渠道筛选: [全部渠道 ▼]

目标利润率: [ 5% ] [ 10% ] [ 15% ] [ 20% ]
                    ↑选中
```

### 表格列定义

| 列名 | 类型 | 可编辑 | 说明 |
|------|------|-------|------|
| 店内码 | 文本 | ❌ | 商品编码 |
| 商品名称 | 文本 | ❌ | 截取前20字符 |
| 商品角色 | 文本 | ❌ | 🔴亏损款 等 |
| ABC | 文本 | ❌ | A/B/C分类 |
| 折扣率 | 百分比 | ❌ | 实收/原价 |
| 原价 | 数值 | ❌ | 商品原价 |
| 售价 | 数值 | ❌ | 实收价格 |
| 成本 | 数值 | ❌ | 单品成本 |
| 利润率 | 百分比 | ❌ | 当前利润率 |
| 日均销量 | 数值 | ❌ | 30天销量/30 |
| 弹性系数 | 数值 | ❌ | 价格弹性 |
| 敏感度 | 文本 | ❌ | 🔴高敏/🟡中敏/🟢低敏 |
| 建议价 | 数值 | ❌ | 系统建议价格 |
| 调整价格 | 数值 | ✅ | 可手动修改 |
| 调价说明 | 文本 | ❌ | 调价原因 |
| 预估销量变化 | 百分比 | ❌ | 基于弹性预估 |
| 预估利润变化 | 百分比 | ❌ | 利润变化预估 |

### 批量操作区

```
批量调价: [+3%] [+5%] [+10%] [-5%] [-10%] [调至目标利润率]

提示信息区:
💡 引流款(🚀)和特价款(🏷️)不参与批量调价
⚠️ 高敏感商品(🔴)涨价需谨慎，可能导致销量大幅下降
```

---

## 🔧 代码结构

### 新增函数（在 callbacks.py 中）

```python
# 1. 商品角色识别
def identify_product_role(row: dict) -> tuple:
    """
    识别商品角色
    
    Args:
        row: 包含商品数据的字典
        
    Returns:
        (角色名称, 角色图标, 调价建议, 是否允许调价)
    """
    pass

# 2. 独立数据处理
def prepare_pricing_data_v2(df: pd.DataFrame, channel: str = None) -> pd.DataFrame:
    """
    准备调价计算器数据（独立计算，不依赖诊断模块）
    
    Args:
        df: 原始订单数据
        channel: 渠道筛选
        
    Returns:
        处理后的商品级DataFrame，包含所有调价所需字段
    """
    pass

# 3. 调价建议计算
def calculate_pricing_suggestion(
    current_price: float,
    cost: float,
    original_price: float,
    daily_sales: float,
    elasticity: float,
    target_margin: float,
    product_role: str
) -> dict:
    """
    计算调价建议
    
    Returns:
        {
            'suggested_price': 建议价格,
            'floor_price': 保本价,
            'ceiling_price': 最高价,
            'suggestion_text': 建议说明,
            'estimated_qty_change': 预估销量变化,
            'estimated_profit_change': 预估利润变化
        }
    """
    pass
```

### 修改函数

```python
# update_pricing_table - 完全重写
# update_pricing_effect_panel - 适配新数据结构
```

---

## 📝 实施步骤

### 第1步：创建独立数据处理函数
- [ ] `prepare_pricing_data_v2()` - 从原始数据计算商品级指标
- [ ] 计算：折扣率、利润率、营销占比、日均销量、ABC分类

### 第2步：实现商品角色识别
- [ ] `identify_product_role()` - 10种角色识别
- [ ] 按优先级判断，返回角色信息

### 第3步：重构UI布局
- [ ] 修改商品来源下拉框为角色筛选按钮
- [ ] 简化调价选项（移除调价方向/模式）
- [ ] 更新表格列定义

### 第4步：重构主回调函数
- [ ] `update_pricing_table()` - 使用新数据处理流程
- [ ] 集成商品角色识别
- [ ] 集成调价建议计算

### 第5步：测试验证
- [ ] 导入测试
- [ ] 功能测试
- [ ] 边界情况测试

---

## ⚠️ 注意事项

1. **成本计算**：原始数据中`商品采购成本`是总成本，需除以销量得到单品成本
2. **引流款判断**：优先级最高，一旦识别为引流款，不再判断其他角色
3. **弹性系数**：从`pricing_engine.get_product_elasticity()`获取
4. **保本底线**：任何调价不能低于成本
5. **原价上限**：提价不能超过商品原价

---

*文档创建时间：2025-12-04*
*最后更新：2025-12-04*
