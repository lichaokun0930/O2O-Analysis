import{r as f,j as e}from"./framework-DfnVWwpF.js";import{i as X}from"./charts-bindingecharts-DvSHEz9I.js";import{a as Y,o as Z}from"./index-CWtRVkAB.js";import{V as S}from"./vendor-DUbYPDw3.js";import"./utils-CB2_sajW.js";const B=({value:d,label:j,isDark:z})=>{if(d==null)return null;const v=d>0,p=d<0,b=v?"text-emerald-400":p?"text-rose-400":"text-slate-400",t=v?"bg-emerald-500/10":p?"bg-rose-500/10":"bg-slate-500/10",$=v?"â†‘":p?"â†“":"";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${t} ${b}`,children:[e.jsx("span",{className:"opacity-70",children:j}),e.jsxs("span",{children:[$,Math.abs(d).toFixed(1),"%"]})]})},oe=({storeName:d,channel:j,theme:z,selectedDate:v,selectedDateRange:p,onDistanceBandSelect:b})=>{const[t,$]=f.useState(null),[H,A]=f.useState(!0),[m,I]=f.useState(null),k=f.useRef(null),i=f.useRef(null),{dateRange:u}=Y(),a=z==="dark",g=a?"#64748b":"#94a3b8",W=a?"#fff":"#0f172a",w=a?"#94a3b8":"#64748b",O=a?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)",L=v||void 0;f.useEffect(()=>{if(!d){$(null),A(!1);return}(async()=>{A(!0);try{const o={store_name:d,channel:j};L?o.target_date=L:p?(o.start_date=p.start,o.end_date=p.end):u.type!=="all"&&u.start&&u.end&&(o.start_date=u.start,o.end_date=u.end),console.log("ğŸ“Š DistanceAnalysisChart è¯·æ±‚å‚æ•°:",o);const c=await Z.getDistanceAnalysis(o);c.success&&c.data&&(console.log("ğŸ“Š DistanceAnalysisChart è¿”å›æ•°æ®:",{date:c.data.date,total_orders:c.data.summary?.total_orders,bands:c.data.distance_bands?.map(C=>`${C.band_label}: ${C.order_count}`)}),$(c.data))}catch(o){console.error("è·å–åˆ†è·ç¦»è®¢å•è¯Šæ–­æ•°æ®å¤±è´¥:",o)}finally{A(!1)}})()},[d,j,L,p,u.type,u.start,u.end]),f.useEffect(()=>{if(!k.current||!t)return;i.current||(i.current=X(k.current,a?"dark":void 0));const{distance_bands:n,summary:o}=t,c=n.map(r=>r.band_label),C=n.map(r=>r.order_count),J=n.map(r=>r.profit),N=c.indexOf(o.optimal_distance),q=n.map((r,s)=>{const x=s===N;return s===m?new S(0,0,0,1,[{offset:0,color:"rgba(34, 211, 238, 1)"},{offset:1,color:"rgba(34, 211, 238, 0.5)"}]):x?new S(0,0,0,1,[{offset:0,color:"rgba(250, 204, 21, 0.9)"},{offset:1,color:"rgba(250, 204, 21, 0.3)"}]):new S(0,0,0,1,[{offset:0,color:a?"rgba(139, 92, 246, 0.8)":"rgba(139, 92, 246, 0.7)"},{offset:1,color:a?"rgba(139, 92, 246, 0.2)":"rgba(139, 92, 246, 0.1)"}])}),K=N>=0?{silent:!0,data:[[{xAxis:c[N],itemStyle:{color:a?"rgba(250, 204, 21, 0.08)":"rgba(250, 204, 21, 0.1)"}},{xAxis:c[N]}]]}:void 0,Q={backgroundColor:"transparent",grid:{top:35,right:45,bottom:25,left:40,containLabel:!0},tooltip:{trigger:"axis",backgroundColor:a?"rgba(15, 23, 42, 0.95)":"rgba(255, 255, 255, 0.95)",borderColor:a?"rgba(255, 255, 255, 0.1)":"rgba(0,0,0,0.1)",padding:16,textStyle:{fontFamily:"JetBrains Mono",color:a?"#fff":"#0f172a",fontSize:12},axisPointer:{type:"shadow"},formatter:r=>{const s=r[0]?.axisValue||"",x=c.indexOf(s),l=n[x];if(!l)return"";const U=s===o.optimal_distance;let _=`<div style="font-weight:600;margin-bottom:8px;font-size:13px">
            ${s}
            ${U?'<span style="color:#facc15;margin-left:6px">â˜… æœ€ä¼˜åŒºé—´</span>':""}
          </div>`;const y=l.order_count_change;let R="";if(y!=null){const E=y>0?"#22c55e":y<0?"#f43f5e":"#94a3b8",F=y>0?"â†‘":y<0?"â†“":"";R=`<span style="font-size:10px;color:${E};margin-left:8px">${F}${Math.abs(y).toFixed(1)}%</span>`}_+=`<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0">
            <span style="display:flex;align-items:center;gap:6px">
              <span style="width:8px;height:8px;border-radius:50%;background:#8b5cf6"></span>
              è®¢å•æ•°
            </span>
            <span style="font-weight:600;margin-left:20px">${l.order_count}${R}</span>
          </div>`;const T=l.profit>=0?"#22c55e":"#f43f5e",h=l.profit_change;let G="";if(h!=null){const E=h>0?"#22c55e":h<0?"#f43f5e":"#94a3b8",F=h>0?"â†‘":h<0?"â†“":"";G=`<span style="font-size:10px;color:${E};margin-left:8px">${F}${Math.abs(h).toFixed(1)}%</span>`}return _+=`<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0">
            <span style="display:flex;align-items:center;gap:6px">
              <span style="width:8px;height:8px;border-radius:50%;background:${T}"></span>
              åˆ©æ¶¦
            </span>
            <span style="font-weight:600;margin-left:20px;color:${T}">Â¥${l.profit.toFixed(2)}${G}</span>
          </div>`,_+=`<div style="border-top:1px solid ${a?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"};margin:8px 0"></div>`,_+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px">
            <div><span style="color:${a?"#94a3b8":"#64748b"}">é”€å”®é¢:</span> <span style="font-weight:600">Â¥${l.revenue.toFixed(0)}</span></div>
            <div><span style="color:${a?"#94a3b8":"#64748b"}">åˆ©æ¶¦ç‡:</span> <span style="font-weight:600;color:${l.profit_rate>=0?"#22c55e":"#f43f5e"}">${l.profit_rate.toFixed(1)}%</span></div>
            <div><span style="color:${a?"#94a3b8":"#64748b"}">é…é€æˆæœ¬:</span> <span style="font-weight:600">Â¥${l.delivery_cost.toFixed(0)}</span></div>
            <div><span style="color:${a?"#94a3b8":"#64748b"}">é…é€æˆæœ¬ç‡:</span> <span style="font-weight:600">${l.delivery_cost_rate.toFixed(1)}%</span></div>
            <div><span style="color:${a?"#94a3b8":"#64748b"}">å®¢å•ä»·:</span> <span style="font-weight:600">Â¥${l.avg_order_value.toFixed(0)}</span></div>
            <div><span style="color:${a?"#94a3b8":"#64748b"}">å•å‡é…é€è´¹:</span> <span style="font-weight:600">Â¥${(l.avg_delivery_fee||0).toFixed(1)}</span></div>
          </div>`,_}},legend:{data:["è®¢å•æ•°","åˆ©æ¶¦"],top:2,right:5,textStyle:{color:g,fontSize:10},itemWidth:10,itemHeight:10,itemGap:12},xAxis:{type:"category",data:c,axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:g,fontSize:10,interval:0,rotate:0}},yAxis:[{type:"value",name:"",position:"left",splitLine:{lineStyle:{color:O,type:"dashed"}},axisLabel:{color:g,fontSize:10},nameTextStyle:{color:g,fontSize:10}},{type:"value",name:"",position:"right",splitLine:{show:!1},axisLabel:{color:g,fontSize:10,formatter:r=>`Â¥${r}`},nameTextStyle:{color:g,fontSize:10}}],series:[{name:"è®¢å•æ•°",type:"bar",z:10,data:C.map((r,s)=>({value:r,itemStyle:{color:q[s],borderRadius:[3,3,0,0],shadowBlur:s===m?15:0,shadowColor:s===m?"rgba(34, 211, 238, 0.6)":"transparent"}})),barWidth:28,barMaxWidth:40,markArea:K,animationDuration:300,animationEasing:"cubicOut"},{name:"åˆ©æ¶¦",type:"line",yAxisIndex:1,data:J,smooth:.3,symbol:"circle",symbolSize:6,z:1,silent:!0,itemStyle:{color:"#22c55e"},lineStyle:{width:2.5,color:"#22c55e",shadowColor:"rgba(34, 197, 94, 0.3)",shadowBlur:8},areaStyle:{color:new S(0,0,0,1,[{offset:0,color:"rgba(34, 197, 94, 0.15)"},{offset:.5,color:"rgba(34, 197, 94, 0.03)"},{offset:1,color:"rgba(244, 63, 94, 0.08)"}]),opacity:.8},markLine:{silent:!0,symbol:"none",lineStyle:{color:a?"rgba(255,255,255,0.15)":"rgba(0,0,0,0.1)",type:"dashed",width:1},data:[{yAxis:0}],label:{show:!1}}}]};i.current.setOption(Q,!0),i.current.off("click"),i.current.on("click","series.bar",r=>{const s=r.dataIndex,x=n[s];x&&(console.log("ğŸ“Š æŸ±çŠ¶å›¾ç‚¹å‡»:",x.band_label,s),m===s?(I(null),b&&b(-1,"",0,0)):(I(s),b&&b(s,x.band_label,x.min_distance,x.max_distance)))});const D=()=>{i.current?.resize()};return window.addEventListener("resize",D),()=>{window.removeEventListener("resize",D)}},[t,a,g,O,m,b]),f.useEffect(()=>{i.current&&(i.current.dispose(),i.current=null)},[z]),f.useEffect(()=>()=>{i.current&&(i.current.dispose(),i.current=null)},[]);const P=t&&t.distance_bands&&t.distance_bands.some(n=>n.order_count>0),M=f.useMemo(()=>{if(t?.date){if(t.date.includes("~")){const n=t.date.split("~").map(o=>o.trim());return n.length===2&&n[0]&&n[1]?`${n[0].slice(5)} ~ ${n[1].slice(5)}`:t.date}return t.date.slice(5)}return null},[t?.date]),V=p!=null;return e.jsxs("div",{className:"glass-panel rounded-2xl p-4 h-full flex flex-col relative",children:[e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-violet-500/5 to-transparent pointer-events-none rounded-b-2xl"}),e.jsxs("div",{className:"mb-2 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-base font-bold flex items-center gap-2",style:{color:W},children:[e.jsx("span",{className:"w-1 h-4 bg-gradient-to-b from-violet-400 to-violet-600 rounded-full"}),M?`${M} åˆ†è·ç¦»è¯Šæ–­`:"åˆ†è·ç¦»è¯Šæ–­",(v||V)&&e.jsx("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-violet-500/20 text-violet-400 ml-1",children:"å·²è”åŠ¨"}),m!==null&&t?.distance_bands[m]&&e.jsxs("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400 ml-1",children:["å·²é€‰: ",t.distance_bands[m].band_label]})]}),t?.comparison&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{value:t.comparison.order_change,label:"è®¢å•",isDark:a}),e.jsx(B,{value:t.comparison.profit_change,label:"åˆ©æ¶¦",isDark:a})]})]}),e.jsxs("p",{className:"text-[10px] mt-0.5 font-mono uppercase tracking-wider opacity-70",style:{color:w},children:["DISTANCE-BASED ORDER DIAGNOSIS",t?.summary?.optimal_distance&&e.jsxs("span",{className:"ml-2 normal-case text-yellow-400",children:["(æœ€ä¼˜: ",t.summary.optimal_distance,")"]}),t?.comparison?.period&&e.jsxs("span",{className:"ml-2 normal-case text-slate-500",children:["(",t.comparison.period,")"]}),m!==null&&e.jsx("span",{className:"ml-2 normal-case text-cyan-400",children:"ç‚¹å‡»æŸ±å­å–æ¶ˆé€‰ä¸­"})]})]}),e.jsx("div",{className:"flex-1 w-full min-h-0",children:d?H?e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("div",{className:"animate-pulse text-sm",style:{color:w},children:"åŠ è½½ä¸­..."})}):P?e.jsx("div",{ref:k,className:"w-full h-full"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("div",{className:"text-sm",style:{color:w},children:"æš‚æ— æ•°æ®"})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm mb-2",style:{color:w},children:"è¯·å…ˆé€‰æ‹©é—¨åº—"}),e.jsx("div",{className:"text-xs opacity-60",style:{color:w},children:"é€‰æ‹©é—¨åº—åå°†æ˜¾ç¤ºè¯¥é—¨åº—çš„é…é€è·ç¦»åˆ†æ"})]})})})]})};export{oe as default};
