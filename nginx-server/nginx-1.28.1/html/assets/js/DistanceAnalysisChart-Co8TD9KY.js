import{r as f,j as e}from"./framework-DfnVWwpF.js";import{i as H}from"./charts-bindingecharts-DvSHEz9I.js";import{a as J,o as q}from"./index-BXnA4bXl.js";import{V as N}from"./vendor-DUbYPDw3.js";import"./utils-CB2_sajW.js";const O=({value:d,label:w,isDark:S})=>{if(d==null)return null;const y=d>0,p=d<0,b=y?"text-emerald-400":p?"text-rose-400":"text-slate-400",t=y?"bg-emerald-500/10":p?"bg-rose-500/10":"bg-slate-500/10",_=y?"â†‘":p?"â†“":"";return e.jsxs("span",{className:`inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium ${t} ${b}`,children:[e.jsx("span",{className:"opacity-70",children:w}),e.jsxs("span",{children:[_,Math.abs(d).toFixed(1),"%"]})]})},Z=({storeName:d,channel:w,theme:S,selectedDate:y,selectedDateRange:p,onDistanceBandSelect:b})=>{const[t,_]=f.useState(null),[D,C]=f.useState(!0),[m,A]=f.useState(null),z=f.useRef(null),l=f.useRef(null),{dateRange:u}=J(),s=S==="dark",g=s?"#64748b":"#94a3b8",M=s?"#fff":"#0f172a",h=s?"#94a3b8":"#64748b",L=s?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)",k=y||void 0;f.useEffect(()=>{if(!d){_(null),C(!1);return}(async()=>{C(!0);try{const r={store_name:d,channel:w};k?r.target_date=k:p?(r.start_date=p.start,r.end_date=p.end):u.type!=="all"&&u.start&&u.end&&(r.start_date=u.start,r.end_date=u.end),console.log("ğŸ“Š DistanceAnalysisChart è¯·æ±‚å‚æ•°:",r);const i=await q.getDistanceAnalysis(r);i.success&&i.data&&(console.log("ğŸ“Š DistanceAnalysisChart è¿”å›æ•°æ®:",{date:i.data.date,total_orders:i.data.summary?.total_orders,bands:i.data.distance_bands?.map(j=>`${j.band_label}: ${j.order_count}`)}),_(i.data))}catch(r){console.error("è·å–åˆ†è·ç¦»è®¢å•è¯Šæ–­æ•°æ®å¤±è´¥:",r)}finally{C(!1)}})()},[d,w,k,p,u.type,u.start,u.end]),f.useEffect(()=>{if(!z.current||!t)return;l.current||(l.current=H(z.current,s?"dark":void 0));const{distance_bands:n,summary:r}=t,i=n.map(o=>o.band_label),j=n.map(o=>o.order_count),G=n.map(o=>o.profit),$=i.indexOf(r.optimal_distance),B=n.map((o,a)=>{const x=a===$;return a===m?new N(0,0,0,1,[{offset:0,color:"rgba(34, 211, 238, 1)"},{offset:1,color:"rgba(34, 211, 238, 0.5)"}]):x?new N(0,0,0,1,[{offset:0,color:"rgba(250, 204, 21, 0.9)"},{offset:1,color:"rgba(250, 204, 21, 0.3)"}]):new N(0,0,0,1,[{offset:0,color:s?"rgba(139, 92, 246, 0.8)":"rgba(139, 92, 246, 0.7)"},{offset:1,color:s?"rgba(139, 92, 246, 0.2)":"rgba(139, 92, 246, 0.1)"}])}),W=$>=0?{silent:!0,data:[[{xAxis:i[$],itemStyle:{color:s?"rgba(250, 204, 21, 0.08)":"rgba(250, 204, 21, 0.1)"}},{xAxis:i[$]}]]}:void 0,P={backgroundColor:"transparent",grid:{top:35,right:45,bottom:25,left:40,containLabel:!0},tooltip:{trigger:"axis",backgroundColor:s?"rgba(15, 23, 42, 0.95)":"rgba(255, 255, 255, 0.95)",borderColor:s?"rgba(255, 255, 255, 0.1)":"rgba(0,0,0,0.1)",padding:16,textStyle:{fontFamily:"JetBrains Mono",color:s?"#fff":"#0f172a",fontSize:12},axisPointer:{type:"shadow"},formatter:o=>{const a=o[0]?.axisValue||"",x=i.indexOf(a),c=n[x];if(!c)return"";const V=a===r.optimal_distance;let v=`<div style="font-weight:600;margin-bottom:8px;font-size:13px">
            ${a}
            ${V?'<span style="color:#facc15;margin-left:6px">â˜… æœ€ä¼˜åŒºé—´</span>':""}
          </div>`;v+=`<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0">
            <span style="display:flex;align-items:center;gap:6px">
              <span style="width:8px;height:8px;border-radius:50%;background:#8b5cf6"></span>
              è®¢å•æ•°
            </span>
            <span style="font-weight:600;margin-left:20px">${c.order_count}</span>
          </div>`;const F=c.profit>=0?"#22c55e":"#f43f5e";return v+=`<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0">
            <span style="display:flex;align-items:center;gap:6px">
              <span style="width:8px;height:8px;border-radius:50%;background:${F}"></span>
              åˆ©æ¶¦
            </span>
            <span style="font-weight:600;margin-left:20px;color:${F}">Â¥${c.profit.toFixed(2)}</span>
          </div>`,v+=`<div style="border-top:1px solid ${s?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"};margin:8px 0"></div>`,v+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px">
            <div><span style="color:${s?"#94a3b8":"#64748b"}">é”€å”®é¢:</span> <span style="font-weight:600">Â¥${c.revenue.toFixed(0)}</span></div>
            <div><span style="color:${s?"#94a3b8":"#64748b"}">åˆ©æ¶¦ç‡:</span> <span style="font-weight:600;color:${c.profit_rate>=0?"#22c55e":"#f43f5e"}">${c.profit_rate.toFixed(1)}%</span></div>
            <div><span style="color:${s?"#94a3b8":"#64748b"}">é…é€æˆæœ¬:</span> <span style="font-weight:600">Â¥${c.delivery_cost.toFixed(0)}</span></div>
            <div><span style="color:${s?"#94a3b8":"#64748b"}">é…é€æˆæœ¬ç‡:</span> <span style="font-weight:600">${c.delivery_cost_rate.toFixed(1)}%</span></div>
            <div><span style="color:${s?"#94a3b8":"#64748b"}">å®¢å•ä»·:</span> <span style="font-weight:600">Â¥${c.avg_order_value.toFixed(0)}</span></div>
          </div>`,v}},legend:{data:["è®¢å•æ•°","åˆ©æ¶¦"],top:2,right:5,textStyle:{color:g,fontSize:10},itemWidth:10,itemHeight:10,itemGap:12},xAxis:{type:"category",data:i,axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:g,fontSize:10,interval:0,rotate:0}},yAxis:[{type:"value",name:"",position:"left",splitLine:{lineStyle:{color:L,type:"dashed"}},axisLabel:{color:g,fontSize:10},nameTextStyle:{color:g,fontSize:10}},{type:"value",name:"",position:"right",splitLine:{show:!1},axisLabel:{color:g,fontSize:10,formatter:o=>`Â¥${o}`},nameTextStyle:{color:g,fontSize:10}}],series:[{name:"è®¢å•æ•°",type:"bar",z:10,data:j.map((o,a)=>({value:o,itemStyle:{color:B[a],borderRadius:[3,3,0,0],shadowBlur:a===m?15:0,shadowColor:a===m?"rgba(34, 211, 238, 0.6)":"transparent"}})),barWidth:28,barMaxWidth:40,markArea:W,animationDuration:300,animationEasing:"cubicOut"},{name:"åˆ©æ¶¦",type:"line",yAxisIndex:1,data:G,smooth:.3,symbol:"circle",symbolSize:6,z:1,silent:!0,itemStyle:{color:"#22c55e"},lineStyle:{width:2.5,color:"#22c55e",shadowColor:"rgba(34, 197, 94, 0.3)",shadowBlur:8},areaStyle:{color:new N(0,0,0,1,[{offset:0,color:"rgba(34, 197, 94, 0.15)"},{offset:.5,color:"rgba(34, 197, 94, 0.03)"},{offset:1,color:"rgba(244, 63, 94, 0.08)"}]),opacity:.8},markLine:{silent:!0,symbol:"none",lineStyle:{color:s?"rgba(255,255,255,0.15)":"rgba(0,0,0,0.1)",type:"dashed",width:1},data:[{yAxis:0}],label:{show:!1}}}]};l.current.setOption(P,!0),l.current.off("click"),l.current.on("click","series.bar",o=>{const a=o.dataIndex,x=n[a];x&&(console.log("ğŸ“Š æŸ±çŠ¶å›¾ç‚¹å‡»:",x.band_label,a),m===a?(A(null),b&&b(-1,"",0,0)):(A(a),b&&b(a,x.band_label,x.min_distance,x.max_distance)))});const I=()=>{l.current?.resize()};return window.addEventListener("resize",I),()=>{window.removeEventListener("resize",I)}},[t,s,g,L,m,b]),f.useEffect(()=>{l.current&&(l.current.dispose(),l.current=null)},[S]),f.useEffect(()=>()=>{l.current&&(l.current.dispose(),l.current=null)},[]);const R=t&&t.distance_bands&&t.distance_bands.some(n=>n.order_count>0),E=f.useMemo(()=>{if(t?.date){if(t.date.includes("~")){const n=t.date.split("~").map(r=>r.trim());return n.length===2&&n[0]&&n[1]?`${n[0].slice(5)} ~ ${n[1].slice(5)}`:t.date}return t.date.slice(5)}return null},[t?.date]),T=p!=null;return e.jsxs("div",{className:"glass-panel rounded-2xl p-4 h-full flex flex-col relative",children:[e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-violet-500/5 to-transparent pointer-events-none rounded-b-2xl"}),e.jsxs("div",{className:"mb-2 relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-base font-bold flex items-center gap-2",style:{color:M},children:[e.jsx("span",{className:"w-1 h-4 bg-gradient-to-b from-violet-400 to-violet-600 rounded-full"}),E?`${E} åˆ†è·ç¦»è¯Šæ–­`:"åˆ†è·ç¦»è¯Šæ–­",(y||T)&&e.jsx("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-violet-500/20 text-violet-400 ml-1",children:"å·²è”åŠ¨"}),m!==null&&t?.distance_bands[m]&&e.jsxs("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400 ml-1",children:["å·²é€‰: ",t.distance_bands[m].band_label]})]}),t?.comparison&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{value:t.comparison.order_change,label:"è®¢å•",isDark:s}),e.jsx(O,{value:t.comparison.profit_change,label:"åˆ©æ¶¦",isDark:s})]})]}),e.jsxs("p",{className:"text-[10px] mt-0.5 font-mono uppercase tracking-wider opacity-70",style:{color:h},children:["DISTANCE-BASED ORDER DIAGNOSIS",t?.summary?.optimal_distance&&e.jsxs("span",{className:"ml-2 normal-case text-yellow-400",children:["(æœ€ä¼˜: ",t.summary.optimal_distance,")"]}),t?.comparison?.period&&e.jsxs("span",{className:"ml-2 normal-case text-slate-500",children:["(",t.comparison.period,")"]}),m!==null&&e.jsx("span",{className:"ml-2 normal-case text-cyan-400",children:"ç‚¹å‡»æŸ±å­å–æ¶ˆé€‰ä¸­"})]})]}),e.jsx("div",{className:"flex-1 w-full min-h-0",children:d?D?e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("div",{className:"animate-pulse text-sm",style:{color:h},children:"åŠ è½½ä¸­..."})}):R?e.jsx("div",{ref:z,className:"w-full h-full"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("div",{className:"text-sm",style:{color:h},children:"æš‚æ— æ•°æ®"})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm mb-2",style:{color:h},children:"è¯·å…ˆé€‰æ‹©é—¨åº—"}),e.jsx("div",{className:"text-xs opacity-60",style:{color:h},children:"é€‰æ‹©é—¨åº—åå°†æ˜¾ç¤ºè¯¥é—¨åº—çš„é…é€è·ç¦»åˆ†æ"})]})})})]})};export{Z as default};
