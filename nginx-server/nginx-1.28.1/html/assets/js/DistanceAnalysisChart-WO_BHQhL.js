import{r as d,j as e}from"./framework-DfnVWwpF.js";import{i as H}from"./charts-bindingecharts-DvSHEz9I.js";import{a as J,o as P}from"./index-CX6U_nV3.js";import{V as _}from"./vendor-DUbYPDw3.js";import"./utils-CB2_sajW.js";const Y=({storeName:h,channel:N,theme:z,selectedDate:C,selectedDateRange:x,onDistanceBandSelect:b})=>{const[a,A]=d.useState(null),[F,j]=d.useState(!0),[f,L]=d.useState(null),S=d.useRef(null),l=d.useRef(null),{dateRange:m}=J(),t=z==="dark",u=t?"#64748b":"#94a3b8",D=t?"#fff":"#0f172a",y=t?"#94a3b8":"#64748b",k=t?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)",$=C||void 0;d.useEffect(()=>{if(!h){A(null),j(!1);return}(async()=>{j(!0);try{const n={store_name:h,channel:N};$?n.target_date=$:x?(n.start_date=x.start,n.end_date=x.end):m.type!=="all"&&m.start&&m.end&&(n.start_date=m.start,n.end_date=m.end),console.log("ğŸ“Š DistanceAnalysisChart è¯·æ±‚å‚æ•°:",n);const i=await P.getDistanceAnalysis(n);i.success&&i.data&&(console.log("ğŸ“Š DistanceAnalysisChart è¿”å›æ•°æ®:",{date:i.data.date,total_orders:i.data.summary?.total_orders,bands:i.data.distance_bands?.map(v=>`${v.band_label}: ${v.order_count}`)}),A(i.data))}catch(n){console.error("è·å–åˆ†è·ç¦»è®¢å•è¯Šæ–­æ•°æ®å¤±è´¥:",n)}finally{j(!1)}})()},[h,N,$,x,m.type,m.start,m.end]),d.useEffect(()=>{if(!S.current||!a)return;l.current||(l.current=H(S.current,t?"dark":void 0));const{distance_bands:r,summary:n}=a,i=r.map(o=>o.band_label),v=r.map(o=>o.order_count),G=r.map(o=>o.profit),w=i.indexOf(n.optimal_distance),M=r.map((o,s)=>{const p=s===w;return s===f?new _(0,0,0,1,[{offset:0,color:"rgba(34, 211, 238, 1)"},{offset:1,color:"rgba(34, 211, 238, 0.5)"}]):p?new _(0,0,0,1,[{offset:0,color:"rgba(250, 204, 21, 0.9)"},{offset:1,color:"rgba(250, 204, 21, 0.3)"}]):new _(0,0,0,1,[{offset:0,color:t?"rgba(139, 92, 246, 0.8)":"rgba(139, 92, 246, 0.7)"},{offset:1,color:t?"rgba(139, 92, 246, 0.2)":"rgba(139, 92, 246, 0.1)"}])}),W=w>=0?{silent:!0,data:[[{xAxis:i[w],itemStyle:{color:t?"rgba(250, 204, 21, 0.08)":"rgba(250, 204, 21, 0.1)"}},{xAxis:i[w]}]]}:void 0,B={backgroundColor:"transparent",grid:{top:35,right:45,bottom:25,left:40,containLabel:!0},tooltip:{trigger:"axis",backgroundColor:t?"rgba(15, 23, 42, 0.95)":"rgba(255, 255, 255, 0.95)",borderColor:t?"rgba(255, 255, 255, 0.1)":"rgba(0,0,0,0.1)",padding:16,textStyle:{fontFamily:"JetBrains Mono",color:t?"#fff":"#0f172a",fontSize:12},axisPointer:{type:"shadow"},formatter:o=>{const s=o[0]?.axisValue||"",p=i.indexOf(s),c=r[p];if(!c)return"";const V=s===n.optimal_distance;let g=`<div style="font-weight:600;margin-bottom:8px;font-size:13px">
            ${s}
            ${V?'<span style="color:#facc15;margin-left:6px">â˜… æœ€ä¼˜åŒºé—´</span>':""}
          </div>`;g+=`<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0">
            <span style="display:flex;align-items:center;gap:6px">
              <span style="width:8px;height:8px;border-radius:50%;background:#8b5cf6"></span>
              è®¢å•æ•°
            </span>
            <span style="font-weight:600;margin-left:20px">${c.order_count}</span>
          </div>`;const O=c.profit>=0?"#22c55e":"#f43f5e";return g+=`<div style="display:flex;justify-content:space-between;align-items:center;margin:4px 0">
            <span style="display:flex;align-items:center;gap:6px">
              <span style="width:8px;height:8px;border-radius:50%;background:${O}"></span>
              åˆ©æ¶¦
            </span>
            <span style="font-weight:600;margin-left:20px;color:${O}">Â¥${c.profit.toFixed(2)}</span>
          </div>`,g+=`<div style="border-top:1px solid ${t?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"};margin:8px 0"></div>`,g+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px">
            <div><span style="color:${t?"#94a3b8":"#64748b"}">é”€å”®é¢:</span> <span style="font-weight:600">Â¥${c.revenue.toFixed(0)}</span></div>
            <div><span style="color:${t?"#94a3b8":"#64748b"}">åˆ©æ¶¦ç‡:</span> <span style="font-weight:600;color:${c.profit_rate>=0?"#22c55e":"#f43f5e"}">${c.profit_rate.toFixed(1)}%</span></div>
            <div><span style="color:${t?"#94a3b8":"#64748b"}">é…é€æˆæœ¬:</span> <span style="font-weight:600">Â¥${c.delivery_cost.toFixed(0)}</span></div>
            <div><span style="color:${t?"#94a3b8":"#64748b"}">é…é€æˆæœ¬ç‡:</span> <span style="font-weight:600">${c.delivery_cost_rate.toFixed(1)}%</span></div>
            <div><span style="color:${t?"#94a3b8":"#64748b"}">å®¢å•ä»·:</span> <span style="font-weight:600">Â¥${c.avg_order_value.toFixed(0)}</span></div>
          </div>`,g}},legend:{data:["è®¢å•æ•°","åˆ©æ¶¦"],top:2,right:5,textStyle:{color:u,fontSize:10},itemWidth:10,itemHeight:10,itemGap:12},xAxis:{type:"category",data:i,axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:u,fontSize:10,interval:0,rotate:0}},yAxis:[{type:"value",name:"",position:"left",splitLine:{lineStyle:{color:k,type:"dashed"}},axisLabel:{color:u,fontSize:10},nameTextStyle:{color:u,fontSize:10}},{type:"value",name:"",position:"right",splitLine:{show:!1},axisLabel:{color:u,fontSize:10,formatter:o=>`Â¥${o}`},nameTextStyle:{color:u,fontSize:10}}],series:[{name:"è®¢å•æ•°",type:"bar",z:10,data:v.map((o,s)=>({value:o,itemStyle:{color:M[s],borderRadius:[3,3,0,0],shadowBlur:s===f?15:0,shadowColor:s===f?"rgba(34, 211, 238, 0.6)":"transparent"}})),barWidth:28,barMaxWidth:40,markArea:W,animationDuration:300,animationEasing:"cubicOut"},{name:"åˆ©æ¶¦",type:"line",yAxisIndex:1,data:G,smooth:.3,symbol:"circle",symbolSize:6,z:1,silent:!0,itemStyle:{color:"#22c55e"},lineStyle:{width:2.5,color:"#22c55e",shadowColor:"rgba(34, 197, 94, 0.3)",shadowBlur:8},areaStyle:{color:new _(0,0,0,1,[{offset:0,color:"rgba(34, 197, 94, 0.15)"},{offset:.5,color:"rgba(34, 197, 94, 0.03)"},{offset:1,color:"rgba(244, 63, 94, 0.08)"}]),opacity:.8},markLine:{silent:!0,symbol:"none",lineStyle:{color:t?"rgba(255,255,255,0.15)":"rgba(0,0,0,0.1)",type:"dashed",width:1},data:[{yAxis:0}],label:{show:!1}}}]};l.current.setOption(B,!0),l.current.off("click"),l.current.on("click","series.bar",o=>{const s=o.dataIndex,p=r[s];p&&(console.log("ğŸ“Š æŸ±çŠ¶å›¾ç‚¹å‡»:",p.band_label,s),f===s?(L(null),b&&b(-1,"",0,0)):(L(s),b&&b(s,p.band_label,p.min_distance,p.max_distance)))});const I=()=>{l.current?.resize()};return window.addEventListener("resize",I),()=>{window.removeEventListener("resize",I)}},[a,t,u,k,f,b]),d.useEffect(()=>{l.current&&(l.current.dispose(),l.current=null)},[z]),d.useEffect(()=>()=>{l.current&&(l.current.dispose(),l.current=null)},[]);const R=a&&a.distance_bands&&a.distance_bands.some(r=>r.order_count>0),E=d.useMemo(()=>{if(a?.date){if(a.date.includes("~")){const r=a.date.split("~").map(n=>n.trim());return r.length===2&&r[0]&&r[1]?`${r[0].slice(5)} ~ ${r[1].slice(5)}`:a.date}return a.date.slice(5)}return null},[a?.date]),T=x!=null;return e.jsxs("div",{className:"glass-panel rounded-2xl p-4 h-full flex flex-col relative",children:[e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-violet-500/5 to-transparent pointer-events-none rounded-b-2xl"}),e.jsxs("div",{className:"mb-2 relative z-10",children:[e.jsxs("h3",{className:"text-base font-bold flex items-center gap-2",style:{color:D},children:[e.jsx("span",{className:"w-1 h-4 bg-gradient-to-b from-violet-400 to-violet-600 rounded-full"}),E?`${E} åˆ†è·ç¦»è¯Šæ–­`:"åˆ†è·ç¦»è¯Šæ–­",(C||T)&&e.jsx("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-violet-500/20 text-violet-400 ml-1",children:"å·²è”åŠ¨"}),f!==null&&a?.distance_bands[f]&&e.jsxs("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400 ml-1",children:["å·²é€‰: ",a.distance_bands[f].band_label]})]}),e.jsxs("p",{className:"text-[10px] mt-0.5 font-mono uppercase tracking-wider opacity-70",style:{color:y},children:["DISTANCE-BASED ORDER DIAGNOSIS",a?.summary?.optimal_distance&&e.jsxs("span",{className:"ml-2 normal-case text-yellow-400",children:["(æœ€ä¼˜: ",a.summary.optimal_distance,")"]}),f!==null&&e.jsx("span",{className:"ml-2 normal-case text-cyan-400",children:"ç‚¹å‡»æŸ±å­å–æ¶ˆé€‰ä¸­"})]})]}),e.jsx("div",{className:"flex-1 w-full min-h-0",children:h?F?e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("div",{className:"animate-pulse text-sm",style:{color:y},children:"åŠ è½½ä¸­..."})}):R?e.jsx("div",{ref:S,className:"w-full h-full"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("div",{className:"text-sm",style:{color:y},children:"æš‚æ— æ•°æ®"})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm mb-2",style:{color:y},children:"è¯·å…ˆé€‰æ‹©é—¨åº—"}),e.jsx("div",{className:"text-xs opacity-60",style:{color:y},children:"é€‰æ‹©é—¨åº—åå°†æ˜¾ç¤ºè¯¥é—¨åº—çš„é…é€è·ç¦»åˆ†æ"})]})})})]})};export{Y as default};
