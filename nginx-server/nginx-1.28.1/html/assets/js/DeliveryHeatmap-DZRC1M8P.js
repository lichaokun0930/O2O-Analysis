import{r as l,j as n}from"./framework-DfnVWwpF.js";import{g as W,i as I}from"./charts-bindingecharts-DvSHEz9I.js";import{a as J,o as q}from"./index-CX6U_nV3.js";import{cf as B}from"./vendor-DUbYPDw3.js";import"./utils-CB2_sajW.js";const X=({theme:E,selectedDistanceBand:u,storeName:H,selectedDate:v,selectedDateRange:x})=>{const c=E==="dark",p=c?"#94a3b8":"#64748b",A=c?"#fff":"#0f172a",N=c?"#94a3b8":"#64748b",d=c?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)",{selectedStore:P,dateRange:m}=J(),f=H||P,[z,k]=l.useState([]),[w,D]=l.useState(!1),[C,L]=l.useState(null),[i,M]=l.useState(null),y=l.useRef(null),g=l.useRef(null);l.useEffect(()=>{if(console.log("ğŸ“¡ DeliveryHeatmap - selectedStore:",f,"selectedDate:",v,"selectedDateRange:",x),!f){k([]),L(null);return}(async()=>{D(!0);try{const s={store_name:f};v?s.target_date=v:x?(s.start_date=x.start,s.end_date=x.end):m.type!=="all"&&m.start&&m.end&&(s.start_date=m.start,s.end_date=m.end),u&&(s.min_distance=u.minDistance,s.max_distance=u.maxDistance),console.log("ğŸ“¡ é…é€æº¢ä»·é›·è¾¾è¯·æ±‚å‚æ•°:",s);const r=await q.getDeliveryRadar(s);r.success&&(console.log("ğŸ“¡ é…é€æº¢ä»·é›·è¾¾æ•°æ®:",r.data?.length,"æ¡, æ—¥æœŸ:",r.date),k(r.data||[]),L(r.date||null))}catch(s){console.error("è·å–é…é€æº¢ä»·é›·è¾¾æ•°æ®å¤±è´¥:",s)}finally{D(!1)}})()},[f,v,x,m.type,m.start,m.end,u]);const{basePoints:o,channelStats:R}=l.useMemo(()=>{if(!z.length)return console.log("ğŸ“¡ DeliveryHeatmap basePoints - æ— æ•°æ®"),{basePoints:[],channelStats:[]};const s=z.filter(t=>typeof t.distance=="number"&&!isNaN(t.distance)&&typeof t.hour=="number"&&!isNaN(t.hour)&&typeof t.delivery_cost=="number"&&!isNaN(t.delivery_cost)&&typeof t.order_value=="number"&&!isNaN(t.order_value)&&typeof t.profit=="number"&&!isNaN(t.profit)).filter(t=>t.is_premium),r={};s.forEach(t=>{const a=t.channel||"å…¶ä»–";let h="å…¶ä»–";a.includes("ç¾å›¢")?h="ç¾å›¢":a.includes("é¥¿äº†ä¹ˆ")?h="é¥¿äº†ä¹ˆ":a.includes("æŠ–éŸ³")?h="æŠ–éŸ³":a.includes("äº¬ä¸œ")&&(h="äº¬ä¸œ"),r[h]=(r[h]||0)+1});const F={ç¾å›¢:"#FFB800",é¥¿äº†ä¹ˆ:"#0096FF",æŠ–éŸ³:"#1a1a1a",äº¬ä¸œ:"#E4393C",å…¶ä»–:"#8B5CF6"},_=Object.entries(r).map(([t,a])=>({name:t,count:a,color:F[t]||"#8B5CF6"})).sort((t,a)=>a.count-t.count);let S=s;i&&(S=s.filter(t=>{const a=t.channel||"å…¶ä»–";return i==="ç¾å›¢"?a.includes("ç¾å›¢"):i==="é¥¿äº†ä¹ˆ"?a.includes("é¥¿äº†ä¹ˆ"):i==="æŠ–éŸ³"?a.includes("æŠ–éŸ³"):i==="äº¬ä¸œ"?a.includes("äº¬ä¸œ"):i==="å…¶ä»–"?!a.includes("ç¾å›¢")&&!a.includes("é¥¿äº†ä¹ˆ")&&!a.includes("æŠ–éŸ³")&&!a.includes("äº¬ä¸œ"):!0}));const j=S.map(t=>({value:[t.distance,t.hour,t.delivery_cost,t.order_value,t.profit,t.channel||""],originalAngle:t.hour,isPremium:t.is_premium}));return console.log("ğŸ“¡ DeliveryHeatmap - æº¢ä»·è®¢å•:",s.length,"ç­›é€‰å:",j.length),{basePoints:j,channelStats:_}},[z,i]),b=l.useMemo(()=>{if(!o.length)return 8.5;const e=Math.max(...o.map(s=>s.value[0]));return Math.max(2,Math.ceil(e)+.5)},[o]),O={ç¾å›¢:"#FFB800",é¥¿äº†ä¹ˆ:"#0096FF",æŠ–éŸ³:"#000000",äº¬ä¸œ:"#E4393C",å…¶ä»–:"#8B5CF6"},T=e=>{if(!e)return"#f43f5e";for(const[s,r]of Object.entries(O))if(e.includes(s))return r;return"#f43f5e"},$=l.useMemo(()=>o.length?(console.log("ğŸ“¡ DeliveryHeatmap option - ç”Ÿæˆé…ç½®:",{pointsCount:o.length,maxDistance:b,firstPoint:o[0]?.value}),{polar:{radius:["5%","82%"],center:["50%","50%"]},angleAxis:{type:"value",min:0,max:24,interval:3,startAngle:90,clockwise:!0,axisLine:{lineStyle:{color:d}},axisLabel:{formatter:"{value}h",color:p,fontSize:10,fontFamily:"JetBrains Mono",fontWeight:"bold"},splitLine:{show:!0,lineStyle:{color:d,width:1}}},radiusAxis:{min:0,max:b,interval:b<=2?.5:b<=4?1:2,axisLine:{show:!1},axisLabel:{formatter:"{value}km",color:p,fontSize:9,verticalAlign:"bottom"},splitLine:{lineStyle:{color:d,type:"dashed"}}},tooltip:{backgroundColor:c?"rgba(2, 6, 23, 0.95)":"rgba(255, 255, 255, 0.95)",borderColor:c?"rgba(255, 255, 255, 0.2)":"rgba(0,0,0,0.1)",padding:12,textStyle:{fontFamily:"JetBrains Mono",color:c?"#fff":"#0f172a"},formatter:e=>{const s=e.data?.value;if(!s)return"";const[r,F,_,S,j,t]=s;return`
            <div style="font-weight:600;margin-bottom:6px;color:#f43f5e">âš ï¸ é…é€æº¢ä»·è®¢å•</div>
            <div>æ¸ é“: ${t||"æœªçŸ¥"}</div>
            <div>è·ç¦»: ${r.toFixed(1)}km</div>
            <div>æ—¶æ®µ: ${F}:00</div>
            <div>é…é€æˆæœ¬: <span style="color:#f43f5e;font-weight:bold">Â¥${_.toFixed(1)}</span></div>
            <div>å®¢å•ä»·: Â¥${S.toFixed(0)}</div>
            <div>åˆ©æ¶¦: <span style="color:${j>=0?"#22c55e":"#f43f5e"}">Â¥${j.toFixed(1)}</span></div>
            <div style="margin-top:4px;font-size:10px;color:#94a3b8">é…é€å‡€æˆæœ¬ > Â¥6</div>
          `}},series:[{name:"æº¢ä»·è®¢å•",type:"scatter",coordinateSystem:"polar",encode:{radius:0,angle:1},data:o.map(e=>{const s=e.value[5],r=T(s);return{value:e.value,itemStyle:{color:r,opacity:.85,shadowBlur:12,shadowColor:`${r}80`}}}),symbolSize:e=>Math.max(8,Math.min(e[2]*1.5,30)),itemStyle:{borderColor:c?"rgba(255,255,255,0.9)":"#fff",borderWidth:1.5},emphasis:{itemStyle:{opacity:1,shadowBlur:20,borderColor:"#fff",borderWidth:2},scale:1.3}}]}):(console.log("ğŸ“¡ DeliveryHeatmap option - æ— æ•°æ®ï¼Œè¿”å›ç©º series"),{series:[]}),[o,c,p,d,b]);return l.useEffect(()=>{if(!g.current||!f){console.log("ğŸ“¡ DeliveryHeatmap åˆå§‹åŒ– - è·³è¿‡: container=",!!g.current,"store=",f);return}let e=W(g.current);e||(e=I(g.current,c?"dark":void 0),console.log("ğŸ“¡ DeliveryHeatmap - åˆ›å»ºæ–°çš„ ECharts å®ä¾‹")),y.current=e;const s=()=>{e?.resize()};return window.addEventListener("resize",s),setTimeout(()=>{e?.resize()},50),()=>{window.removeEventListener("resize",s)}},[c,f]),l.useEffect(()=>{const e=y.current;if(!e){console.log("ğŸ“¡ DeliveryHeatmap æ›´æ–° - å®ä¾‹ä¸å­˜åœ¨");return}if(!o.length){console.log("ğŸ“¡ DeliveryHeatmap æ›´æ–° - æ— æ•°æ®ï¼Œæ¸…ç©º series"),e.setOption({polar:{radius:["12%","75%"],center:["50%","50%"]},angleAxis:{type:"value",min:0,max:24,interval:3,startAngle:90,clockwise:!0,axisLine:{lineStyle:{color:d}},axisLabel:{formatter:"{value}h",color:p,fontSize:10},splitLine:{show:!0,lineStyle:{color:d,width:1}}},radiusAxis:{min:0,max:8.5,interval:2,axisLine:{show:!1},axisLabel:{formatter:"{value}km",color:p,fontSize:9},splitLine:{lineStyle:{color:d,type:"dashed"}}},series:[]},{notMerge:!0});return}e.setOption($,{notMerge:!0}),console.log("ğŸ“¡ DeliveryHeatmap - setOption å®Œæˆ, æ•°æ®ç‚¹:",o.length),setTimeout(()=>{e?.resize()},100)},[$,o,p,d]),l.useEffect(()=>()=>{y.current&&(y.current.dispose(),y.current=null)},[]),n.jsxs("div",{className:"glass-panel rounded-2xl p-4 h-full flex flex-col relative overflow-hidden group",children:[n.jsxs("div",{className:"shrink-0 relative z-20 flex justify-between items-center mb-1",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx(B,{size:16,className:"text-cyan-400 animate-pulse"}),n.jsx("h3",{className:"text-base font-bold",style:{color:A},children:C?C.includes("~")?`${C.split("~").map(e=>e.trim().slice(5)).join(" ~ ")} é…é€æº¢ä»·é›·è¾¾`:`${C.slice(5)} é…é€æº¢ä»·é›·è¾¾`:"é…é€æº¢ä»·é›·è¾¾"}),u&&n.jsxs("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400",children:[u.minDistance,"-",u.maxDistance,"km"]}),(v||x)&&n.jsx("span",{className:"text-[10px] font-normal px-1.5 py-0.5 rounded-full bg-cyan-500/20 text-cyan-400 ml-1",children:"å·²è”åŠ¨"})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[R.slice(0,4).map(e=>n.jsxs("button",{onClick:()=>M(i===e.name?null:e.name),className:`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all cursor-pointer ${i===e.name?"bg-white/20 ring-1 ring-white/30":i?"opacity-40":"hover:bg-white/10"}`,children:[n.jsx("div",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),n.jsx("span",{className:"text-[10px]",style:{color:c?"#94a3b8":"#64748b"},children:e.name}),n.jsx("span",{className:"text-[10px] font-mono font-bold",style:{color:e.color},children:e.count})]},e.name)),i&&n.jsx("button",{onClick:()=>M(null),className:"text-[10px] text-cyan-400 hover:text-cyan-300 ml-1",children:"âœ•"})]})]}),n.jsx("div",{className:"flex-1 w-full relative z-10 flex items-center justify-center",children:f?n.jsxs(n.Fragment,{children:[n.jsx("div",{ref:g,className:"w-full h-full relative z-10",style:{visibility:w||!o.length?"hidden":"visible"}}),w&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-20",children:n.jsx("div",{className:"animate-pulse text-sm",style:{color:N},children:"åŠ è½½ä¸­..."})}),!w&&!o.length&&n.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-20",children:n.jsx("div",{className:"text-sm text-center",style:{color:N},children:i?`${i} æ¸ é“æ— æº¢ä»·è®¢å•`:u?`${u.minDistance}-${u.maxDistance}km èŒƒå›´å†…æ— æº¢ä»·è®¢å•`:"æš‚æ— æº¢ä»·è®¢å•æ•°æ®"})}),o.length>0&&!w&&n.jsxs("div",{className:"absolute flex items-center justify-center pointer-events-none z-20 aspect-square h-[85%]",children:[n.jsx("div",{className:"w-full h-full rounded-full animate-spin opacity-50",style:{animationDuration:"6s",animationTimingFunction:"linear",background:"conic-gradient(from 0deg, transparent 0deg, transparent 300deg, rgba(34, 211, 238, 0.3) 360deg)"}}),n.jsx("div",{className:"absolute w-1.5 h-1.5 bg-cyan-400 rounded-full shadow-[0_0_15px_#22d3ee] animate-ping"})]})]}):n.jsxs("div",{className:"text-center",children:[n.jsx("div",{className:"text-sm mb-2",style:{color:N},children:"è¯·å…ˆé€‰æ‹©é—¨åº—"}),n.jsx("div",{className:"text-xs opacity-60",style:{color:N},children:"é€‰æ‹©é—¨åº—åå°†æ˜¾ç¤ºé…é€æº¢ä»·åˆ†æ"})]})})]})};export{X as default};
