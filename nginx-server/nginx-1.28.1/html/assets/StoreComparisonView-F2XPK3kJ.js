import{ag as ae,j as e,au as ne,al as re,af as oe,T as le,J as ie,r as l,p as W,av as ce,f as A,i as U,b as de,c as xe,d as H,h as V,C as pe,g as me,D as fe,z as ge,k as ue,l as he,S as Y,G as X,X as be,aj as ye,Y as ve,W as je,ak as we}from"./react-vendor-BU-CX47b.js";import{a as G,b as ee,u as Ne,C as _e,S as K,o as ke}from"./index-DBeLt_Nr.js";const Q={getComparison:async a=>(await G.get("/stores/comparison",{params:a})).data,getWeekOverWeek:async(a,n,f,p)=>(await G.get("/stores/comparison/week-over-week",{params:{end_date:a,previous_start:n,previous_end:f,channel:p}})).data,getRanking:async a=>(await G.get("/stores/comparison/ranking",{params:a})).data,getAvailableChannels:async a=>(await G.get("/stores/comparison/available-channels",{params:a})).data},Se=({stores:a,theme:n="dark",loading:f=!1,sortBy:p,sortOrder:m,onSort:h})=>{ae.useEffect(()=>{a.length>0&&a[0].weekOverWeek&&console.log("ğŸ” [è¡¨æ ¼] ç¬¬ä¸€ä¸ªé—¨åº—çš„ç¯æ¯”æ•°æ®:",{store_name:a[0].store_name,weekOverWeek:a[0].weekOverWeek,keys:Object.keys(a[0].weekOverWeek||{})})},[a]);const j=s=>{p===s?h(s,m==="asc"?"desc":"asc"):h(s,"desc")},b=s=>p!==s?null:m==="asc"?e.jsx(ne,{size:14}):e.jsx(re,{size:14}),g=(s,i=!0)=>{if(s===void 0||s===0)return e.jsxs("span",{className:"text-slate-600 flex items-center gap-1 text-[10px]",children:[e.jsx(oe,{size:10})," -"]});const d=s>0,t=d?"text-emerald-400":"text-red-400",o=d?le:ie;return e.jsxs("span",{className:`${t} flex items-center gap-1 text-[10px] font-medium`,children:[e.jsx(o,{size:10}),d?"+":"",s.toFixed(1),i?"%":""]})};return f?e.jsx("div",{className:"glass-panel rounded-2xl p-6",children:e.jsx("div",{className:"text-slate-400 text-center",children:"åŠ è½½ä¸­..."})}):a.length===0?e.jsx("div",{className:"glass-panel rounded-2xl p-6",children:e.jsx("div",{className:"text-slate-400 text-center",children:"æš‚æ— æ•°æ®"})}):e.jsxs("div",{className:"glass-panel rounded-2xl p-6",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"é—¨åº—è¯¦ç»†æ•°æ®"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-white/10",children:[e.jsx("th",{className:"text-left py-3 px-4 text-slate-400 font-medium",children:"æ’å"}),e.jsx("th",{className:"text-left py-3 px-4 text-slate-400 font-medium",children:"é—¨åº—åç§°"}),e.jsx("th",{className:"text-right py-3 px-4 text-slate-400 font-medium cursor-pointer hover:text-white transition-colors",onClick:()=>j("order_count"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["è®¢å•é‡ ",b("order_count")]})}),e.jsx("th",{className:"text-right py-3 px-4 text-slate-400 font-medium cursor-pointer hover:text-white transition-colors",onClick:()=>j("revenue"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["é”€å”®é¢ ",b("revenue")]})}),e.jsx("th",{className:"text-right py-3 px-4 text-slate-400 font-medium cursor-pointer hover:text-white transition-colors",onClick:()=>j("profit"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["åˆ©æ¶¦ ",b("profit")]})}),e.jsx("th",{className:"text-right py-3 px-4 text-slate-400 font-medium cursor-pointer hover:text-white transition-colors",onClick:()=>j("profit_margin"),children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["åˆ©æ¶¦ç‡ ",b("profit_margin")]})}),e.jsx("th",{className:"text-right py-3 px-4 text-slate-400 font-medium",children:"å®¢å•ä»·"}),e.jsx("th",{className:"text-right py-3 px-4 text-slate-400 font-medium",children:"å•å‡é…é€è´¹"}),e.jsx("th",{className:"text-right py-3 px-4 text-slate-400 font-medium",children:"å•å‡è¥é”€è´¹"})]})}),e.jsx("tbody",{children:a.map((s,i)=>{var d,t,o,C,u,M,w;return e.jsxs("tr",{className:"border-b border-white/5 hover:bg-white/5 transition-colors",children:[e.jsx("td",{className:"py-3 px-4",children:e.jsx("div",{className:"flex items-center gap-2",children:i<3?e.jsx("span",{className:`
                        w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                        ${i===0?"bg-amber-500/20 text-amber-400":""}
                        ${i===1?"bg-slate-400/20 text-slate-300":""}
                        ${i===2?"bg-orange-600/20 text-orange-400":""}
                      `,children:i+1}):e.jsx("span",{className:"text-slate-500 text-xs w-6 text-center",children:i+1})})}),e.jsx("td",{className:"py-3 px-4 text-white font-medium",children:s.store_name}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsxs("div",{className:"flex flex-col items-end gap-0.5",children:[e.jsx("span",{className:"text-slate-300",children:s.order_count.toLocaleString()}),g((d=s.weekOverWeek)==null?void 0:d.order_count)]})}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsxs("div",{className:"flex flex-col items-end gap-0.5",children:[e.jsxs("span",{className:"text-slate-300",children:["Â¥",s.total_revenue.toLocaleString()]}),g((t=s.weekOverWeek)==null?void 0:t.revenue)]})}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsxs("div",{className:"flex flex-col items-end gap-0.5",children:[e.jsxs("span",{className:"text-slate-300",children:["Â¥",s.total_profit.toLocaleString()]}),g((o=s.weekOverWeek)==null?void 0:o.profit)]})}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsxs("div",{className:"flex flex-col items-end gap-0.5",children:[e.jsxs("span",{className:`
                      ${s.profit_margin>=30?"text-emerald-400":""}
                      ${s.profit_margin>=20&&s.profit_margin<30?"text-cyan-400":""}
                      ${s.profit_margin>=10&&s.profit_margin<20?"text-amber-400":""}
                      ${s.profit_margin<10?"text-red-400":""}
                    `,children:[s.profit_margin.toFixed(1),"%"]}),g((C=s.weekOverWeek)==null?void 0:C.profit_margin,!1)]})}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsxs("div",{className:"flex flex-col items-end gap-0.5",children:[e.jsxs("span",{className:"text-slate-300",children:["Â¥",s.aov.toFixed(1)]}),g((u=s.weekOverWeek)==null?void 0:u.aov)]})}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsxs("div",{className:"flex flex-col items-end gap-0.5",children:[e.jsxs("span",{className:"text-slate-300",children:["Â¥",s.avg_delivery_fee.toFixed(1)]}),g((M=s.weekOverWeek)==null?void 0:M.avg_delivery_fee)]})}),e.jsx("td",{className:"py-3 px-4 text-right",children:e.jsxs("div",{className:"flex flex-col items-end gap-0.5",children:[e.jsxs("span",{className:"text-slate-300",children:["Â¥",s.avg_marketing_cost.toFixed(1)]}),g((w=s.weekOverWeek)==null?void 0:w.avg_marketing_cost)]})})]},s.store_name)})})]})})]})},Ce=({stores:a,metric:n,theme:f="dark",loading:p=!1})=>{const m=l.useMemo(()=>{if(a.length===0)return{names:[],values:[],colors:[]};const s=a.slice(0,10),i=s.map(o=>o.store_name),d=s.map(o=>{switch(n){case"revenue":return o.total_revenue;case"profit":return o.total_profit;case"profit_margin":return o.profit_margin;case"order_count":return o.order_count;default:return o.total_revenue}}),t=s.map(o=>o.profit_margin>=30?"#10b981":o.profit_margin>=20?"#06b6d4":o.profit_margin>=10?"#f59e0b":"#ef4444");return{names:i,values:d,colors:t}},[a,n]),h={revenue:"é”€å”®é¢",profit:"åˆ©æ¶¦",profit_margin:"åˆ©æ¶¦ç‡",order_count:"è®¢å•é‡"},j={revenue:"å…ƒ",profit:"å…ƒ",profit_margin:"%",order_count:"å•"},b=l.useMemo(()=>({title:{text:`é—¨åº—${h[n]}æ’è¡Œæ¦œ Top 10`,left:"center",top:10,textStyle:{color:f==="dark"?"#fff":"#1e293b",fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},backgroundColor:"rgba(0, 0, 0, 0.8)",borderColor:"rgba(255, 255, 255, 0.2)",textStyle:{color:"#fff"},formatter:s=>{const i=s[0],d=a.find(t=>t.store_name===i.name);return d?`
          <div style="padding: 8px;">
            <div style="font-weight: bold; margin-bottom: 8px;">${d.store_name}</div>
            <div style="display: flex; justify-content: space-between; gap: 16px;">
              <span>é”€å”®é¢:</span>
              <span style="font-weight: bold;">Â¥${d.total_revenue.toLocaleString()}</span>
            </div>
            <div style="display: flex; justify-content: space-between; gap: 16px;">
              <span>åˆ©æ¶¦:</span>
              <span style="font-weight: bold;">Â¥${d.total_profit.toLocaleString()}</span>
            </div>
            <div style="display: flex; justify-content: space-between; gap: 16px;">
              <span>åˆ©æ¶¦ç‡:</span>
              <span style="font-weight: bold;">${d.profit_margin.toFixed(1)}%</span>
            </div>
            <div style="display: flex; justify-content: space-between; gap: 16px;">
              <span>è®¢å•é‡:</span>
              <span style="font-weight: bold;">${d.order_count.toLocaleString()}å•</span>
            </div>
          </div>
        `:""}},grid:{left:"3%",right:"4%",bottom:"3%",top:60,containLabel:!0},xAxis:{type:"category",data:m.names,axisLabel:{color:f==="dark"?"#94a3b8":"#64748b",rotate:45,fontSize:11},axisLine:{lineStyle:{color:f==="dark"?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"}}},yAxis:{type:"value",name:j[n],nameTextStyle:{color:f==="dark"?"#94a3b8":"#64748b"},axisLabel:{color:f==="dark"?"#94a3b8":"#64748b",formatter:s=>n==="profit_margin"?s.toFixed(0):s>=1e4?(s/1e4).toFixed(1)+"w":s.toLocaleString()},splitLine:{lineStyle:{color:f==="dark"?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)"}}},series:[{type:"bar",data:m.values.map((s,i)=>({value:s,itemStyle:{color:m.colors[i]}})),barWidth:"60%",label:{show:!0,position:"top",color:f==="dark"?"#fff":"#1e293b",fontSize:10,formatter:s=>{const i=s.value;return n==="profit_margin"?i.toFixed(1)+"%":i>=1e4?(i/1e4).toFixed(1)+"w":i.toLocaleString()}}}]}),[m,n,f,a,h,j]),g=ee(b,[m,n,f,p,a],f);return p?e.jsx("div",{className:"glass-panel rounded-2xl p-6 h-full flex items-center justify-center",children:e.jsx("div",{className:"text-slate-400 text-sm",children:"åŠ è½½ä¸­..."})}):a.length===0||m.names.length===0?e.jsx("div",{className:"glass-panel rounded-2xl p-6 h-full flex items-center justify-center",children:e.jsx("div",{className:"text-slate-400 text-sm",children:"æš‚æ— æ•°æ®"})}):e.jsx("div",{className:"glass-panel rounded-2xl p-6 h-full",children:e.jsx("div",{ref:g,className:"w-full h-full",style:{minHeight:"350px"}})})},Me=({stores:a,theme:n="dark",loading:f=!1})=>{var g,s;const p=l.useMemo(()=>{if(a.length===0)return[];const i=a.reduce((t,o)=>t+o.marketing_cost_rate,0)/a.length,d=a.reduce((t,o)=>t+o.profit_margin,0)/a.length;return a.map(t=>({name:t.store_name,value:[t.marketing_cost_rate,t.profit_margin,t.total_revenue],itemStyle:{color:t.profit_margin>=d&&t.marketing_cost_rate<=i?"#10b981":t.profit_margin>=d&&t.marketing_cost_rate>i?"#06b6d4":t.profit_margin<d&&t.marketing_cost_rate<=i?"#f59e0b":"#ef4444"},avgMarketingRate:i,avgProfitMargin:d}))},[a]),m=((g=p[0])==null?void 0:g.avgMarketingRate)||0,h=((s=p[0])==null?void 0:s.avgProfitMargin)||0,j=l.useMemo(()=>({title:{text:"é—¨åº—æ•ˆç‡åˆ†æï¼ˆè¥é”€æˆæœ¬ç‡ vs åˆ©æ¶¦ç‡ï¼‰",left:"center",top:10,textStyle:{color:n==="dark"?"#fff":"#1e293b",fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"item",backgroundColor:"rgba(0, 0, 0, 0.8)",borderColor:"rgba(255, 255, 255, 0.2)",textStyle:{color:"#fff"},formatter:i=>{const d=i.data,t=a.find(o=>o.store_name===d.name);return t?`
          <div style="padding: 8px;">
            <div style="font-weight: bold; margin-bottom: 8px;">${t.store_name}</div>
            <div style="display: flex; justify-content: space-between; gap: 16px;">
              <span>è¥é”€æˆæœ¬ç‡:</span>
              <span style="font-weight: bold;">${t.marketing_cost_rate.toFixed(1)}%</span>
            </div>
            <div style="display: flex; justify-content: space-between; gap: 16px;">
              <span>åˆ©æ¶¦ç‡:</span>
              <span style="font-weight: bold;">${t.profit_margin.toFixed(1)}%</span>
            </div>
            <div style="display: flex; justify-content: space-between; gap: 16px;">
              <span>é”€å”®é¢:</span>
              <span style="font-weight: bold;">Â¥${t.total_revenue.toLocaleString()}</span>
            </div>
          </div>
        `:""}},grid:{left:"3%",right:"7%",bottom:"3%",top:60,containLabel:!0},xAxis:{type:"value",name:"è¥é”€æˆæœ¬ç‡ (%)",nameLocation:"middle",nameGap:30,nameTextStyle:{color:n==="dark"?"#94a3b8":"#64748b",fontSize:12},axisLabel:{color:n==="dark"?"#94a3b8":"#64748b",formatter:"{value}%"},splitLine:{lineStyle:{color:n==="dark"?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)"}}},yAxis:{type:"value",name:"åˆ©æ¶¦ç‡ (%)",nameLocation:"middle",nameGap:40,nameTextStyle:{color:n==="dark"?"#94a3b8":"#64748b",fontSize:12},axisLabel:{color:n==="dark"?"#94a3b8":"#64748b",formatter:"{value}%"},splitLine:{lineStyle:{color:n==="dark"?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)"}}},series:[{type:"scatter",data:p,symbolSize:i=>{const d=Math.max(...a.map(C=>C.total_revenue)),t=10;return t+i[2]/d*(40-t)},label:{show:!0,position:"top",color:n==="dark"?"#fff":"#1e293b",fontSize:10,formatter:i=>i.data.name},emphasis:{focus:"self",label:{show:!0,fontSize:12,fontWeight:"bold"}}},{type:"line",markLine:{silent:!0,symbol:"none",lineStyle:{type:"dashed",color:"#6366f1",width:1},label:{show:!0,position:"end",formatter:"å¹³å‡è¥é”€æˆæœ¬ç‡",color:"#6366f1",fontSize:10},data:[{xAxis:m}]}},{type:"line",markLine:{silent:!0,symbol:"none",lineStyle:{type:"dashed",color:"#6366f1",width:1},label:{show:!0,position:"end",formatter:"å¹³å‡åˆ©æ¶¦ç‡",color:"#6366f1",fontSize:10},data:[{yAxis:h}]}}]}),[p,n,a,m,h]),b=ee(j,[p,n,f,a],n);return f?e.jsx("div",{className:"glass-panel rounded-2xl p-6 h-full flex items-center justify-center",children:e.jsx("div",{className:"text-slate-400 text-sm",children:"åŠ è½½ä¸­..."})}):a.length===0||p.length===0?e.jsx("div",{className:"glass-panel rounded-2xl p-6 h-full flex items-center justify-center",children:e.jsx("div",{className:"text-slate-400 text-sm",children:"æš‚æ— æ•°æ®"})}):e.jsxs("div",{className:"glass-panel rounded-2xl p-6 h-full flex flex-col",children:[e.jsx("div",{ref:b,className:"w-full flex-1",style:{minHeight:"300px"}}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 mt-4 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-emerald-500"}),e.jsx("span",{className:"text-slate-400",children:"ä¼˜è´¨é—¨åº—ï¼ˆé«˜åˆ©æ¶¦ä½è¥é”€ï¼‰"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-cyan-500"}),e.jsx("span",{className:"text-slate-400",children:"æ½œåŠ›é—¨åº—ï¼ˆé«˜åˆ©æ¶¦é«˜è¥é”€ï¼‰"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-amber-500"}),e.jsx("span",{className:"text-slate-400",children:"æ”¹è¿›é—¨åº—ï¼ˆä½åˆ©æ¶¦ä½è¥é”€ï¼‰"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full bg-red-500"}),e.jsx("span",{className:"text-slate-400",children:"äºæŸé—¨åº—ï¼ˆä½åˆ©æ¶¦é«˜è¥é”€ï¼‰"})]})]})]})},Z=[{days:1,label:"æ˜¨æ—¥"},{days:7,label:"è¿‘7å¤©"},{days:15,label:"è¿‘15å¤©"},{days:30,label:"è¿‘30å¤©"}],De=({currentStart:a,currentEnd:n,previousStart:f,previousEnd:p,minDate:m,maxDate:h,onApply:j,onReset:b})=>{var B,q;const[g,s]=l.useState(!1),[i,d]=l.useState(!1),[t,o]=l.useState(),C=l.useRef(null),u=l.useRef(null),M=l.useRef(null),w=l.useRef(null),P=m?W(m,"yyyy-MM-dd",new Date):void 0,O=h?W(h,"yyyy-MM-dd",new Date):void 0,R=a&&n?ce(W(n,"yyyy-MM-dd",new Date),W(a,"yyyy-MM-dd",new Date))+1:0,F=Z.find(x=>x.days===R),I=!F&&a&&n;l.useEffect(()=>{const x=k=>{const z=k.target;g&&C.current&&!C.current.contains(z)&&M.current&&!M.current.contains(z)&&s(!1),i&&u.current&&!u.current.contains(z)&&w.current&&!w.current.contains(z)&&d(!1)};return document.addEventListener("mousedown",x),()=>document.removeEventListener("mousedown",x)},[g,i]);const v=l.useCallback(x=>{if(!h)return;const k=W(h,"yyyy-MM-dd",new Date),z=new Date(k);z.setDate(z.getDate()-x+1),j(A(z,"yyyy-MM-dd"),A(k,"yyyy-MM-dd")),s(!1)},[h,j]),E=l.useCallback(x=>{o(x)},[]),T=l.useCallback(()=>{t!=null&&t.from&&(t!=null&&t.to)&&(j(A(t.from,"yyyy-MM-dd"),A(t.to,"yyyy-MM-dd")),d(!1))},[t,j]),J=l.useCallback(()=>{if(a&&n){const x=W(a,"yyyy-MM-dd",new Date),k=W(n,"yyyy-MM-dd",new Date);U(x)&&U(k)&&o({from:x,to:k})}else o(void 0);d(!0)},[a,n]),D=l.useCallback(x=>!!(P&&de(x,P)||O&&xe(x,O)),[P,O]),N=x=>{if(!x.current)return{top:0,left:0};const k=x.current.getBoundingClientRect();return{top:k.bottom+8,left:k.left}},L=()=>F?F.label:I?`${a} ~ ${n}`:"é€‰æ‹©æ—¥æœŸ";return e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(V,{size:18,className:"text-indigo-400"}),e.jsx("h3",{className:"text-sm font-semibold text-white",children:"å¯¹æ¯”å‘¨æœŸé€‰æ‹©"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsxs("button",{ref:C,onClick:()=>s(!g),className:"w-full flex items-center justify-between gap-2 px-3 py-2 bg-slate-900 hover:bg-slate-800 border border-slate-600 rounded-lg text-sm text-white transition-all",children:[e.jsx("span",{className:"truncate",children:L()}),e.jsx(pe,{size:14,className:`text-slate-400 transition-transform flex-shrink-0 ${g?"rotate-180":""}`})]}),g&&H.createPortal(e.jsx("div",{ref:M,style:N(C),className:"fixed w-40 bg-slate-900 border border-white/10 rounded-xl shadow-2xl z-[9999] overflow-hidden animate-fade-in-up",children:Z.map(({days:x,label:k})=>e.jsxs("button",{onClick:()=>v(x),className:`w-full flex items-center justify-between px-4 py-2.5 text-sm transition-colors ${R===x?"bg-emerald-500/20 text-emerald-300":"text-slate-300 hover:bg-white/5"}`,children:[e.jsx("span",{children:k}),R===x&&e.jsx(me,{size:14,className:"text-emerald-400"})]},x))}),document.body)]}),e.jsxs("button",{ref:u,onClick:J,className:`flex items-center gap-2 px-4 py-2 rounded-lg border transition-all ${I?"bg-indigo-500/20 border-indigo-500/50 text-indigo-300":"bg-slate-900 border-slate-600 text-slate-400 hover:bg-slate-800 hover:text-white hover:border-slate-500"}`,children:[e.jsx(V,{size:16,className:I?"text-indigo-400":"text-slate-400"}),e.jsx("span",{className:"text-sm",children:"è‡ªå®šä¹‰"})]})]}),e.jsxs("div",{className:"bg-slate-900/50 rounded p-3 text-xs space-y-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-slate-400",children:"æœ¬æœŸï¼š"}),e.jsxs("span",{className:"text-indigo-300 font-mono",children:[a," ~ ",n]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-slate-400",children:"ä¸ŠæœŸï¼š"}),e.jsxs("span",{className:"text-emerald-300 font-mono",children:[f," ~ ",p]})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx("button",{onClick:b,className:"flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded transition-colors",children:"é‡ç½®"})})]}),i&&H.createPortal(e.jsxs("div",{ref:w,style:{top:((B=u.current)==null?void 0:B.getBoundingClientRect().bottom)+8,left:Math.min(((q=u.current)==null?void 0:q.getBoundingClientRect().left)||0,window.innerWidth-620)},className:"fixed z-[9999] p-5 rounded-xl border shadow-2xl bg-slate-900 border-white/10",children:[m&&h&&e.jsx("div",{className:"mb-4 px-3 py-2 bg-indigo-500/10 border border-indigo-500/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-indigo-300",children:["ğŸ“… å¯é€‰æ•°æ®èŒƒå›´: ",m," ~ ",h]})}),e.jsx("style",{children:`
            .calendar-container .rdp-root {
              --rdp-accent-color: #6366f1;
              --rdp-accent-background-color: rgba(99, 102, 241, 0.2);
            }
            .calendar-container .rdp-months {
              display: flex;
              gap: 2rem;
            }
            .calendar-container .rdp-month_caption {
              display: flex;
              justify-content: center;
              align-items: center;
              height: 40px;
              font-weight: 600;
              font-size: 14px;
              color: #f1f5f9;
            }
            .calendar-container .rdp-nav {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              display: flex;
              justify-content: space-between;
              padding: 0 8px;
            }
            .calendar-container .rdp-button_previous,
            .calendar-container .rdp-button_next {
              width: 32px;
              height: 32px;
              border-radius: 8px;
              background: rgba(255, 255, 255, 0.05);
              color: #94a3b8;
              display: flex;
              align-items: center;
              justify-content: center;
              border: none;
              cursor: pointer;
              transition: all 0.15s;
            }
            .calendar-container .rdp-button_previous:hover,
            .calendar-container .rdp-button_next:hover {
              background: rgba(255, 255, 255, 0.1);
              color: #f1f5f9;
            }
            .calendar-container .rdp-weekday {
              color: #64748b;
              font-size: 12px;
              font-weight: 500;
              padding: 8px 0;
            }
            .calendar-container .rdp-day {
              width: 36px;
              height: 36px;
            }
            .calendar-container .rdp-day button {
              width: 36px;
              height: 36px;
              border-radius: 8px;
              color: #cbd5e1;
              font-weight: 400;
              font-size: 13px;
              transition: all 0.15s;
              border: none;
              background: transparent;
              cursor: pointer;
            }
            .calendar-container .rdp-day button:hover:not(:disabled) {
              background: rgba(255, 255, 255, 0.08);
              color: #f1f5f9;
            }
            .calendar-container .rdp-today button {
              color: #818cf8;
              box-shadow: inset 0 0 0 1px #6366f1;
            }
            .calendar-container .rdp-selected button,
            .calendar-container .rdp-range_start button,
            .calendar-container .rdp-range_end button {
              background: #6366f1 !important;
              color: white !important;
            }
            .calendar-container .rdp-range_middle button {
              background: rgba(99, 102, 241, 0.2) !important;
              color: #a5b4fc !important;
              border-radius: 0 !important;
            }
            .calendar-container .rdp-range_start button {
              border-radius: 8px 0 0 8px !important;
            }
            .calendar-container .rdp-range_end button {
              border-radius: 0 8px 8px 0 !important;
            }
            .calendar-container .rdp-disabled button {
              color: #334155 !important;
              opacity: 0.4;
              cursor: not-allowed !important;
            }
            .calendar-container .rdp-disabled button:hover {
              background: transparent !important;
            }
            .calendar-container .rdp-outside button {
              color: #475569;
              opacity: 0.5;
            }
          `}),e.jsx("div",{className:"calendar-container",children:e.jsx(fe,{mode:"range",numberOfMonths:2,selected:t,onSelect:E,locale:ge,disabled:D,defaultMonth:O?new Date(O.getFullYear(),O.getMonth()-1):new Date,startMonth:P,endMonth:O,showOutsideDays:!1,components:{Chevron:({orientation:x})=>x==="left"?e.jsx(ue,{size:18}):e.jsx(he,{size:18})}})}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-white/10 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-slate-400",children:t!=null&&t.from&&(t!=null&&t.to)?e.jsxs("span",{className:"text-emerald-400 font-medium",children:["å·²é€‰: ",A(t.from,"yyyy-MM-dd")," ~ ",A(t.to,"yyyy-MM-dd")]}):t!=null&&t.from?e.jsx("span",{className:"text-amber-400",children:"è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ"}):e.jsx("span",{children:"ç‚¹å‡»é€‰æ‹©å¼€å§‹æ—¥æœŸ"})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>d(!1),className:"px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors",children:"å–æ¶ˆ"}),e.jsx("button",{onClick:T,disabled:!(t!=null&&t.from)||!(t!=null&&t.to),className:"px-5 py-2 bg-indigo-500 text-white rounded-lg text-sm font-medium hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"ç¡®è®¤é€‰æ‹©"})]})]})]}),document.body)]})},Le=({theme:a="dark"})=>{const{storeDateRange:n,selectedStore:f}=Ne(),[p,m]=l.useState([]),[h,j]=l.useState([]),[b,g]=l.useState(!1),[s,i]=l.useState("revenue"),[d,t]=l.useState("desc"),[o,C]=l.useState(""),[u,M]=l.useState(""),[w,P]=l.useState("all"),[O,R]=l.useState([]),[F,I]=l.useState([]),[v,E]=l.useState(()=>{const r=sessionStorage.getItem("excludedStores");return r?JSON.parse(r):[]}),[T,J]=l.useState(!1);l.useEffect(()=>{if(n!=null&&n.max_date){const r=new Date(n.max_date),c=new Date(r);c.setDate(c.getDate()-6),M(r.toISOString().split("T")[0]),C(c.toISOString().split("T")[0])}},[n==null?void 0:n.max_date]),l.useEffect(()=>{p.length>0&&(async()=>{try{const c=await Q.getAvailableChannels({start_date:o,end_date:u});c.success&&c.data&&I(c.data)}catch(c){console.error("è·å–å¯ç”¨æ¸ é“åˆ—è¡¨å¤±è´¥:",c);try{const y=await ke.getChannels({});y.success&&y.data&&I(y.data)}catch(y){console.error("è·å–å…¨å±€æ¸ é“åˆ—è¡¨å¤±è´¥:",y)}}})()},[p,o,u]);const D=l.useMemo(()=>{if(!o||!u)return{start:"",end:""};const r=new Date(o),c=new Date(u),y=Math.ceil((c.getTime()-r.getTime())/(1e3*60*60*24))+1,S=new Date(r);S.setDate(S.getDate()-1);const _=new Date(S);return _.setDate(_.getDate()-y+1),{start:_.toISOString().split("T")[0],end:S.toISOString().split("T")[0]}},[o,u]);l.useEffect(()=>{sessionStorage.setItem("excludedStores",JSON.stringify(v))},[v]);const N=l.useMemo(()=>p.filter(r=>!v.includes(r.store_name)),[p,v]),L=l.useMemo(()=>{if(N.length===0)return{total_stores:0,total_orders:0,total_revenue:0,total_profit:0,avg_profit_margin:0};const r=N.reduce((_,$)=>_+$.order_count,0),c=N.reduce((_,$)=>_+$.total_revenue,0),y=N.reduce((_,$)=>_+$.total_profit,0),S=N.reduce((_,$)=>_+$.profit_margin,0)/N.length;return{total_stores:N.length,total_orders:r,total_revenue:c,total_profit:y,avg_profit_margin:S}},[N]),B=l.useCallback(async()=>{if(!o||!u)return;const r=`${o}-${u}-${s}-${d}-${w}`;if(sessionStorage.getItem("storeComparisonCacheKey")===r&&p.length>0){console.log("ğŸ“¦ [é—¨åº—å¯¹æ¯”] ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼Œè·³è¿‡è¯·æ±‚");return}g(!0);try{const y={sort_by:s,sort_order:d,start_date:o,end_date:u};console.log("ğŸ” [é—¨åº—å¯¹æ¯”] è¯·æ±‚å‚æ•°:",y),console.log("ğŸ“… [é—¨åº—å¯¹æ¯”] æœ¬æœŸ:",o,"~",u),console.log("ğŸ“… [é—¨åº—å¯¹æ¯”] ä¸ŠæœŸ:",D.start,"~",D.end),console.log("ğŸ¯ [é—¨åº—å¯¹æ¯”] æ¸ é“ç­›é€‰:",w==="all"?"å…¨éƒ¨æ¸ é“":w);const[S,_]=await Promise.all([Q.getComparison(y),Q.getWeekOverWeek(u,D.start,D.end,w==="all"?void 0:w)]);console.log("ğŸ“Š [é—¨åº—å¯¹æ¯”] APIå“åº”:",S),S.success&&S.data?(console.log("âœ… [é—¨åº—å¯¹æ¯”] é—¨åº—æ•°æ®:",S.data.stores.length,"ä¸ªé—¨åº—"),m(S.data.stores),sessionStorage.setItem("storeComparisonCacheKey",r)):(console.warn("âš ï¸ [é—¨åº—å¯¹æ¯”] æ•°æ®ä¸ºç©ºæˆ–è¯·æ±‚å¤±è´¥"),m([])),_.success&&_.data&&(console.log("âœ… [é—¨åº—å¯¹æ¯”] ç¯æ¯”æ•°æ®:",_.data.stores.length,"ä¸ªé—¨åº—"),j(_.data.stores))}catch(y){console.error("âŒ [é—¨åº—å¯¹æ¯”] è·å–æ•°æ®å¤±è´¥:",y),m([])}finally{g(!1)}},[o,u,D.start,D.end,s,d,w,p.length]);l.useEffect(()=>{B()},[B]);const q=l.useMemo(()=>N.map(r=>{var y;const c=h.find(S=>S.store_name===r.store_name);return c&&r.store_name===((y=N[0])==null?void 0:y.store_name)&&console.log("ğŸ” [ç¯æ¯”æ•°æ®] ç¬¬ä¸€ä¸ªé—¨åº—çš„ç¯æ¯”æ•°æ®:",{store_name:r.store_name,changes:c.changes,has_aov:"aov"in(c.changes||{}),has_avg_delivery_fee:"avg_delivery_fee"in(c.changes||{}),has_avg_marketing_cost:"avg_marketing_cost"in(c.changes||{})}),{...r,weekOverWeek:c==null?void 0:c.changes}}),[N,h]),x=l.useMemo(()=>p.map(r=>r.store_name).sort(),[p]),k=r=>{E(c=>c.includes(r)?c.filter(y=>y!==r):[...c,r])},z=()=>{v.length===0?E(x):E([])},te=(r,c)=>{C(r),M(c),sessionStorage.removeItem("storeComparisonCacheKey")},se=()=>{if(n!=null&&n.max_date){const r=new Date(n.max_date),c=new Date(r);c.setDate(c.getDate()-6),M(r.toISOString().split("T")[0]),C(c.toISOString().split("T")[0]),sessionStorage.removeItem("storeComparisonCacheKey")}};return e.jsxs("div",{className:"flex flex-col gap-6 w-full",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-white flex items-center gap-2",children:[e.jsx(Y,{size:24,className:"text-indigo-400"}),"å…¨é‡é—¨åº—å¯¹æ¯”åˆ†æ"]}),e.jsx("p",{className:"text-slate-400 text-sm mt-1",children:"å¯¹æ¯”æ‰€æœ‰é—¨åº—çš„å…³é”®æŒ‡æ ‡ï¼Œå‘ç°ä¼˜åŠ£åŠ¿é—¨åº—"})]}),f&&e.jsx("div",{className:"text-xs text-amber-400 bg-amber-500/10 px-3 py-2 rounded-lg border border-amber-500/20",children:"ğŸ’¡ å…¨é‡é—¨åº—å¯¹æ¯”æ˜¾ç¤ºæ‰€æœ‰é—¨åº—æ•°æ®ï¼Œä¸å—é¡¶éƒ¨é—¨åº—ç­›é€‰å½±å“"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsx(De,{currentStart:o,currentEnd:u,previousStart:D.start,previousEnd:D.end,minDate:(n==null?void 0:n.min_date)||void 0,maxDate:(n==null?void 0:n.max_date)||void 0,onApply:te,onReset:se}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(X,{size:18,className:"text-blue-400"}),e.jsx("h3",{className:"text-sm font-semibold text-white",children:"æ¸ é“ç­›é€‰"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_e,{selectedChannel:w,channelList:F,onSelect:P,isDark:a==="dark",accentColor:"cyan"}),e.jsx("span",{className:"text-xs text-slate-400 flex-1",children:w==="all"?`æ˜¾ç¤ºæ‰€æœ‰æ¸ é“ (${F.length}ä¸ª)`:`ä»…æ˜¾ç¤º${w}æ¸ é“`})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-2",children:"ğŸ’¡ åªæ˜¾ç¤ºå½“å‰æ—¥æœŸèŒƒå›´å†…æœ‰æ•°æ®çš„æ¸ é“"})]}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{size:18,className:"text-indigo-400"}),e.jsxs("h3",{className:"text-sm font-semibold text-white",children:["æ˜¾ç¤ºé—¨åº— (",N.length,"/",p.length,")"]})]}),e.jsx("button",{onClick:()=>J(!T),className:"text-xs text-indigo-400 hover:text-indigo-300",children:T?"æ”¶èµ·":"å±•å¼€"})]}),T&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("button",{onClick:z,className:"text-xs px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded transition-colors",children:v.length===0?"å…¨éƒ¨å‰”é™¤":"å…¨éƒ¨æ¢å¤"}),v.length>0&&e.jsxs("span",{className:"text-xs text-amber-400 flex items-center",children:["å·²å‰”é™¤ ",v.length," ä¸ªé—¨åº—"]})]}),e.jsx("div",{className:"max-h-40 overflow-y-auto space-y-1 bg-slate-900/50 rounded p-2",children:x.map(r=>e.jsxs("label",{className:"flex items-center gap-2 px-2 py-1 hover:bg-slate-800 rounded cursor-pointer text-sm",children:[e.jsx("input",{type:"checkbox",checked:!v.includes(r),onChange:()=>k(r),className:"w-4 h-4 text-indigo-600 bg-slate-700 border-slate-600 rounded focus:ring-indigo-500"}),e.jsx("span",{className:v.includes(r)?"text-slate-500 line-through":"text-white",children:r})]},r))})]}),!T&&v.length>0&&e.jsxs("div",{className:"flex flex-wrap gap-1",children:[v.slice(0,3).map(r=>e.jsxs("span",{className:"text-xs px-2 py-1 bg-slate-700 text-slate-300 rounded flex items-center gap-1",children:[r,e.jsx(be,{size:12,className:"cursor-pointer hover:text-white",onClick:()=>k(r)})]},r)),v.length>3&&e.jsxs("span",{className:"text-xs px-2 py-1 text-slate-400",children:["+",v.length-3," æ›´å¤š"]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx(K,{title:"æ˜¾ç¤ºé—¨åº—æ•°",value:L.total_stores.toString(),subtext:v.length>0?`å·²å‰”é™¤ ${v.length} ä¸ª`:"å…¨éƒ¨é—¨åº—",icon:e.jsx(Y,{size:18}),iconColor:"indigo",theme:a,loading:b,compact:!0}),e.jsx(K,{title:"æ€»è®¢å•é‡",value:L.total_orders.toLocaleString(),subtext:"è®¢å•",icon:e.jsx(ye,{size:18}),iconColor:"cyan",theme:a,loading:b,compact:!0}),e.jsx(K,{title:"æ€»é”€å”®é¢",value:`Â¥${L.total_revenue.toLocaleString()}`,subtext:"é”€å”®é¢",icon:e.jsx(ve,{size:18}),iconColor:"emerald",theme:a,loading:b,compact:!0}),e.jsx(K,{title:"æ€»åˆ©æ¶¦",value:`Â¥${L.total_profit.toLocaleString()}`,subtext:"åˆ©æ¶¦",icon:e.jsx(je,{size:18}),iconColor:"amber",theme:a,loading:b,compact:!0}),e.jsx(K,{title:"å¹³å‡åˆ©æ¶¦ç‡",value:`${L.avg_profit_margin.toFixed(1)}%`,subtext:"åˆ©æ¶¦ç‡",icon:e.jsx(we,{size:18}),iconColor:"violet",theme:a,loading:b,compact:!0})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"h-[450px]",children:e.jsx(Ce,{stores:N,metric:s,theme:a,loading:b})}),e.jsx("div",{className:"h-[450px]",children:e.jsx(Me,{stores:N,theme:a,loading:b})})]}),e.jsx("div",{children:e.jsx(Se,{stores:q,theme:a,loading:b,sortBy:s,sortOrder:d,onSort:(r,c)=>{i(r),t(c)}})})]})};export{Le as default};
