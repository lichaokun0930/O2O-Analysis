"""
Tab 5 - 500错误诊断指南
========================

## 当前状态

浏览器控制台显示:
```
:8050/_dash-update-component:1  Failed to load resource: the server responded with a status of 500 (INTERNAL SERVER ERROR)
```

✅ 已完成的修复:
1. 添加详细的异常处理和日志输出
2. 错误信息会同时显示在:
   - 服务器终端(完整堆栈)
   - 浏览器页面(可展开查看详情)

## 诊断步骤

### 步骤1: 查看服务器终端错误
在运行 `python "智能门店看板_Dash版.py"` 的PowerShell终端中,找到类似这样的输出:

```
================================================================================
❌ Tab 5子Tab渲染失败: KeyError: '时段'
================================================================================
Traceback (most recent call last):
  File "...", line XXX, in render_tab5_subtab_content
    ...
KeyError: '时段'
================================================================================
```

**请复制完整的错误堆栈信息!**

### 步骤2: 常见错误及解决方案

#### 错误A: KeyError: '时段' 或 '场景'
**原因**: 数据中缺少这些字段
**调试日志**:
```
🔍 Tab5 渲染: active_subtab=period-analysis, 数据行数=XXX
   时间特征提取后: 数据行数=XXX, 字段=[...]
```
查看"字段="部分是否包含'时段'和'场景'

**解决方法**:
1. 检查 add_scene_and_timeslot_fields 函数是否正常执行
2. 检查数据是否有'下单时间'字段(必需)

#### 错误B: AttributeError: 'NoneType' object has no attribute 'copy'
**原因**: GLOBAL_DATA 为 None,未上传数据
**解决方法**: 先在Tab 1上传数据

#### 错误C: NameError: name 'XXX' is not defined
**原因**: 函数未导入或变量未定义
**解决方法**: 检查导入语句

#### 错误D: ValueError: No objects to concatenate
**原因**: 数据分组后为空
**解决方法**: 检查数据是否有效,是否有订单记录

### 步骤3: 在页面上查看错误
现在修复后,错误会直接显示在Tab 5页面上:
1. 打开浏览器访问 http://localhost:8050
2. 进入 Tab 5 - 时段场景分析
3. 点击任意子Tab(如"订单时段分析")
4. 如果有错误,会显示红色警告框
5. 点击"📋 点击查看完整错误堆栈"展开详情

### 步骤4: 验证数据字段
运行以下脚本检查数据状态:
```python
# 检查全局数据
from 智能门店看板_Dash版 import GLOBAL_DATA
if GLOBAL_DATA is not None:
    print(f"数据行数: {len(GLOBAL_DATA)}")
    print(f"字段列表: {list(GLOBAL_DATA.columns)}")
    print(f"是否有'时段': {'时段' in GLOBAL_DATA.columns}")
    print(f"是否有'场景': {'场景' in GLOBAL_DATA.columns}")
    print(f"是否有'下单时间': {'下单时间' in GLOBAL_DATA.columns}")
else:
    print("GLOBAL_DATA 为 None,请先上传数据")
```

## 下一步行动

1. ✅ 重启看板:
   ```powershell
   python "智能门店看板_Dash版.py"
   ```

2. ✅ 观察启动日志:
   ```
   🔍 Tab5 渲染: active_subtab=...
   🕒 render_period_analysis 开始: df.shape=...
   ```

3. ✅ 在浏览器中访问 Tab 5

4. ✅ 复制以下信息给我:
   - 服务器终端的完整错误堆栈
   - 或页面上展开的错误详情截图

5. ✅ 如果看到字段相关错误,运行上面的验证脚本

## 预期结果

修复后,应该看到:
- ✅ 服务器日志显示成功渲染
- ✅ 页面正常显示指标卡片和图表
- ✅ 无500错误

如果仍有问题,**请提供完整的错误信息**,我会精准定位并修复!
