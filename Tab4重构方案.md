# Tab 4 问题诊断 - 全面重构方案

## 📋 重构目标

### 1. 统一计算口径
- **预计订单收入** = 商品实售价（与Tab 1/2保持一致）
- **实际利润** = 预计订单收入 - 商品采购成本 - 物流配送费 - 平台佣金
- **毛利率** = (商品实售价 - 商品采购成本) / 商品实售价 * 100%
- **所有数值保留1位小数**

### 2. UI风格统一
- 参数配置区域：统一使用dbc.Card包裹
- 统计卡片：4列布局，显示核心指标
- 图表展示：使用DashECharts替代DataTable
- 配色方案：与Tab 1/2保持一致

### 3. ECharts图表规范
- **柱状图**: 用于对比分析（下滑商品排行）
- **折线图**: 用于趋势分析（周期变化）
- **饼图**: 用于占比分析（角色分布）
- **散点图**: 用于关联分析（价格vs销量）

### 4. 交互优化
- 简化参数设置，提供智能默认值
- 一键诊断，自动生成报告
- 支持CSV导出和Excel综合报告

## 🏗️ 各子标签页重构计划

### Tab 4.1: 销量下滑诊断 ✅
**核心功能**: 识别销量大幅下滑的商品
**关键指标**:
- 下滑商品数量
- 总销量损失（件）
- 总收入损失（元）
- 总利润损失（元）

**可视化**:
1. TOP 20下滑商品柱状图（按下滑幅度排序）
2. 分时段下滑分布（柱状图）
3. 分场景下滑分布（柱状图）
4. 下滑幅度vs当前销量散点图

**参数**:
- 对比周期：按日/按周/按月
- 下滑阈值：-5% ~ -80%
- 场景筛选：多选
- 时段筛选：多选

### Tab 4.2: 客单价下滑归因 ✅
**核心功能**: 分析客单价下滑的原因，归因到具体商品
**关键指标**:
- 之前客单价
- 当前客单价
- 客单价变化
- 变化幅度%

**可视化**:
1. 客单价趋势折线图（最近N周）
2. TOP 5下滑商品贡献度（瀑布图）
3. TOP 5上涨商品贡献度（瀑布图）
4. 商品角色分布（饼图）

**参数**:
- 分析粒度：按日/按周
- 下滑阈值：-5% ~ -30%
- 当前周期：最近7天/14天/30天
- 对比周期：上周/上月/自定义

### Tab 4.3: 负毛利商品预警 🔄
**核心功能**: 识别负毛利商品，预警亏损风险
**关键指标**:
- 负毛利商品数
- 累计亏损额
- 平均毛利率
- 亏损订单数

**可视化**:
1. TOP 20负毛利商品柱状图
2. 毛利率分布直方图
3. 亏损金额vs订单数散点图
4. 分类亏损统计（树图）

**参数**:
- 最小订单数：筛选订单量达标的商品
- 时间范围：最近N天

### Tab 4.4: 高配送费诊断 🔄
**核心功能**: 识别配送费占比过高的订单
**关键指标**:
- 高配送费订单数
- 平均配送费占比
- 潜在优化空间
- 涉及地址数

**可视化**:
1. 配送费占比分布（直方图）
2. TOP 20高配送费地址（柱状图）
3. 配送距离vs配送费散点图
4. 地区分布地图（如有地理数据）

**参数**:
- 配送费阈值：10% ~ 50%
- 最小订单数：筛选高频地址

### Tab 4.5: 商品角色失衡诊断 🔄
**核心功能**: 检测流量品和利润品的配比是否合理
**关键指标**:
- 失衡场景数
- 流量品占比
- 利润品占比
- 总订单数

**可视化**:
1. 各场景角色配比堆叠柱状图
2. 流量品vs利润品占比散点图
3. 理想配比对比雷达图
4. 场景订单量分布（柱状图）

**参数**:
- 流量品上限：70%
- 利润品下限：15%
- 最小订单数：50单

### Tab 4.6: 异常波动预警 ⏸️
**核心功能**: 识别销量异常波动的商品（爆单或滞销）
**关键指标**:
- 异常商品数
- 爆单商品数
- 滞销商品数
- 平均波动幅度

**可视化**:
1. TOP 20异常波动商品（柱状图）
2. 周销量趋势对比（折线图）
3. 波动幅度分布（直方图）
4. 环比变化热力图

**参数**:
- 波动阈值：30% ~ 100%
- 最小基数：上周销量≥10

## 🎨 UI组件模板

### 统计卡片模板
```python
dbc.Row([
    dbc.Col([
        dbc.Card([
            dbc.CardBody([
                html.Div("📊", style={'fontSize': 50}),
                html.Div("数值", id='stat-xxx', className='stat-value'),
                html.Div("指标名称", className='stat-label')
            ], className='stat-card')
        ])
    ], md=3),
    # ... 重复4次
], className="mb-4")
```

### ECharts图表模板
```python
html.Div([
    html.H5("图表标题", className="mb-3"),
    DashECharts(
        id='chart-xxx',
        option={},  # ECharts配置
        style={'height': '400px', 'width': '100%'}
    ),
    dbc.Alert([
        html.I(className="bi bi-lightbulb me-2"),
        "图表说明和业务洞察"
    ], color="info", className="mt-2", style={'fontSize': '12px'})
])
```

## 📊 计算标准文档引用

详见：`数据结构统一标准.md`

核心原则：
1. 所有金额字段统一为"预计订单收入"（即商品实售价）
2. 利润计算：收入 - 成本 - 配送费 - 佣金
3. 毛利计算：(售价 - 成本) / 售价
4. 数值格式：保留1位小数，添加单位符号

## ⚠️ 注意事项

1. **向后兼容**: 保留原有callback ID，避免破坏现有功能
2. **性能优化**: 大数据量时使用分页和缓存
3. **错误处理**: 数据为空时显示友好提示
4. **用户体验**: 加载时显示Loading动画

## 🚀 实施步骤

1. ✅ 分析现有代码结构
2. 🔄 重构Tab 4.1（销量下滑）
3. ⏳ 重构Tab 4.2（客单价）
4. ⏳ 重构Tab 4.3（负毛利）
5. ⏳ 重构Tab 4.4（配送费）
6. ⏳ 重构Tab 4.5（角色失衡）
7. ⏸️ 重构Tab 4.6（异常波动）- 可选
8. ⏳ 测试和优化
9. ⏳ 更新文档

---

**文档版本**: v1.0  
**创建时间**: 2025-10-18  
**作者**: AI Assistant
