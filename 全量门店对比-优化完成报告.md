# 全量门店对比 TAB 优化完成报告

## 优化概览

基于五位专家（前端工程师、后端工程师、UI设计师、UX设计师、数据分析师）的评估，完成了以下全面优化：

---

## 一、后端优化 (store_comparison.py)

### 1. 计算逻辑修复 ✅
- **平均利润率**：从简单平均改为加权平均（总利润/总销售额）
- 新增 `weighted_profit_margin` 字段明确标识

### 2. SQL查询优化 ✅
- **渠道筛选**：从 N+1 查询优化为 SQL 层面直接筛选
- `get_all_stores_data()` 函数新增 `channel` 参数，在 SQL 层面过滤

### 3. 缓存优化 ✅
- **缓存key**：包含渠道参数，格式 `{start_date}:{end_date}:{channel}`
- 避免不同渠道筛选时缓存冲突

### 4. 新增功能 ✅
- **综合评分**：多维度加权评分（销售额30% + 利润30% + 利润率20% + 订单量20%）
- **异常检测**：自动识别4类异常
  - 利润率异常（低于平均值2个标准差）
  - 订单量异常（低于平均值2个标准差）
  - 营销成本率过高（>15%）
  - 配送成本率过高（>20%）
- **同比数据**：支持 `include_yoy=True` 参数获取去年同期数据
- **数据导出**：新增 `/comparison/export` 接口，支持 JSON/CSV 格式
- **门店列表**：新增 `/comparison/stores-by-channel` 接口，渠道筛选后更新门店列表

---

## 二、前端优化

### 1. 状态管理修复 ✅
- **缓存key依赖**：移除 `stores.length` 依赖，使用 `useRef` 防止重复请求
- **渠道加载时机**：日期变化时立即加载可用渠道列表

### 2. 加载状态反馈 ✅
- 添加全局加载提示（右上角动画）
- 图表和表格独立加载状态
- 渠道加载状态提示

### 3. 筛选器联动 ✅
- 渠道筛选后自动更新门店列表
- 清除不在新列表中的已剔除门店

### 4. 数据导出 ✅
- 支持 CSV 和 JSON 两种格式
- 导出按钮在标题栏右侧

### 5. 交互增强 ✅
- **散点图点击**：点击气泡显示门店详情
- **表格行点击**：点击行显示门店详情卡片
- **选中状态高亮**：散点图选中门店高亮显示

### 6. 空状态设计 ✅
- 图表空状态：图标 + 提示文字 + 建议操作
- 表格空状态：图标 + 提示
- 全局空状态：重置筛选条件按钮

### 7. 异常标识 ✅
- 表格左侧边框颜色标识风险等级
- 门店名称旁显示警告图标
- 详情卡片显示具体异常信息

### 8. 新增指标 ✅
- **综合评分列**：表格新增综合评分列
- **异常门店卡片**：汇总区新增异常门店数统计

---

## 三、类型定义更新 (types/index.ts)

```typescript
// 新增异常类型
interface StoreAnomaly {
  type: 'low_profit_margin' | 'low_order_count' | 'high_marketing_cost' | 'high_delivery_cost';
  message: string;
  severity: 'high' | 'medium' | 'low';
}

// StoreComparisonData 新增字段
composite_score: number;
anomalies?: StoreAnomaly[];

// StoreWeekOverWeekData 新增字段
yoy_changes?: { ... };  // 同比数据
```

---

## 四、API 更新 (storeComparison.ts)

新增接口：
- `exportData(params)` - 导出数据
- `getStoresByChannel(params)` - 获取渠道下的门店列表

更新接口：
- `getWeekOverWeek()` - 新增 `include_yoy` 参数

---

## 五、文件变更清单

| 文件 | 变更类型 |
|------|---------|
| `backend/app/api/v1/store_comparison.py` | 重构 |
| `frontend-react/src/views/StoreComparisonView.tsx` | 重写 |
| `frontend-react/src/components/StoreComparisonTable.tsx` | 重写 |
| `frontend-react/src/components/charts/StoreEfficiencyScatter.tsx` | 更新 |
| `frontend-react/src/components/charts/StoreRankingChart.tsx` | 更新 |
| `frontend-react/src/api/storeComparison.ts` | 更新 |
| `frontend-react/src/types/index.ts` | 更新 |

---

## 六、验证清单

- [x] 后端代码语法检查通过
- [x] 前端代码 TypeScript 检查通过
- [ ] 功能测试（需手动验证）
- [ ] 性能测试（需手动验证）

---

## 七、使用说明

### 数据导出
1. 点击右上角「导出CSV」或「导出JSON」按钮
2. 文件自动下载到本地

### 查看门店详情
1. 点击散点图中的气泡
2. 或点击表格中的任意行
3. 详情卡片显示在图表下方

### 异常门店识别
- 表格左侧红色边框 = 高风险
- 表格左侧橙色边框 = 中风险
- 门店名称旁的警告图标可悬停查看详情

### 同比数据（需后端支持）
- 调用 API 时传入 `include_yoy=true` 参数
- 前端暂未展示同比数据，可在表格中扩展

---

完成时间：2026-01-19
