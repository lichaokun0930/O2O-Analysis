# 销量下滑诊断 - 日维度功能说明

## 📋 功能概述

销量下滑商品诊断现在支持**三种时间维度**的对比分析：
- ✅ **按日对比**（新增）- 对比任意两天的销量
- ✅ **按周对比** - 对比不同周的销量
- ✅ **按月对比** - 对比不同月的销量

---

## 🎯 日维度功能特点

### 1. **精细化分析**
- 可以精确到**某一天**的销量对比
- 适合快速发现短期波动
- 适合节假日、促销活动等特殊日期的分析

### 2. **灵活的日期选择**
- 自动列出最近**30天**的可用日期
- 可以对比任意两天（例如：今天 vs 昨天、今天 vs 7天前）
- 每个日期显示格式：`X月X日 (XXXX年)`

### 3. **使用场景**
| 场景 | 对比设置 | 用途 |
|------|---------|------|
| 日常监控 | 今天 vs 昨天 | 发现突发性下滑 |
| 周环比 | 今天 vs 7天前 | 发现周同比变化 |
| 活动对比 | 活动日 vs 非活动日 | 评估活动效果 |
| 异常诊断 | 异常日 vs 正常日 | 定位问题原因 |

---

## 💻 使用方法

### 步骤1：启动看板
```powershell
streamlit run 智能门店经营看板_可视化.py
```

### 步骤2：进入诊断页面
1. 选择【问题诊断引擎】标签页
2. 选择【销量下滑】子标签

### 步骤3：配置分析参数

#### 基础配置
- **对比周期**：选择"按日对比" ⭐️ 新增选项
- **下滑阈值%**：设置下滑百分比（默认-20%）
- **场景筛选**：可选，筛选特定场景
- **时段筛选**：可选，筛选特定时段

#### 自定义周期对比
1. 展开"📅 自定义周期对比"区域
2. **当前周期**：选择要分析的日期（如：10月16日）
3. **对比周期**：选择要对比的日期（如：10月15日）
4. 勾选"启用自定义"

### 步骤4：开始诊断
点击"🔍 开始诊断"按钮

---

## 📊 结果解读

### 输出字段说明

| 字段名称 | 说明 | 示例 |
|---------|------|------|
| 商品名称 | 商品的完整名称 | 【活珠子】莘源浩隆 活珠子香辣味 50g/袋 |
| X月X日销量 | 当前日期的销量 | 21 |
| Y月Y日销量 | 对比日期的销量 | 12 |
| 销量变化 | 销量差值 | +9 或 -9 |
| 变化幅度% | 变化百分比 | +75.0% 或 -42.9% |
| 问题等级 | 严重程度 | 严重 / 警告 / 关注 |
| 建议操作 | 推荐的应对措施 | 补货 / 调价 / 下架等 |

### 问题等级分类

- **严重**：变化幅度 ≤ -50%（急需处理）
- **警告**：-50% < 变化幅度 ≤ -30%（需要关注）
- **关注**：-30% < 变化幅度 ≤ 阈值（持续观察）

---

## 🔍 应用案例

### 案例1：发现昨日突然下滑的商品
```
配置：
  对比周期：按日对比
  当前周期：10月16日
  对比周期：10月15日
  下滑阈值：-20%

结果示例：
  商品A：10月15日销量50，10月16日销量10，变化-80%，问题等级：严重
  → 建议：立即检查库存、价格、上架状态
```

### 案例2：对比7天前同期
```
配置：
  对比周期：按日对比
  当前周期：10月16日（周三）
  对比周期：10月9日（上周三）
  下滑阈值：-20%

结果示例：
  商品B：上周三销量30，本周三销量20，变化-33.3%，问题等级：警告
  → 建议：分析周环比下滑原因（价格/库存/竞品）
```

### 案例3：节假日vs工作日对比
```
配置：
  对比周期：按日对比
  当前周期：10月1日（国庆节）
  对比周期：9月25日（工作日）
  下滑阈值：-20%

用途：
  分析节假日和工作日的销量差异
  优化节假日商品策略
```

---

## ⚙️ 技术实现

### 修改文件清单

1. **智能门店经营看板_可视化.py**
   - 第7861-7866行：添加"按日对比"选项

2. **问题诊断引擎.py**
   - 第65-128行：`get_available_periods()` 支持日维度
   - 第212-224行：`diagnose_sales_decline()` 添加日维度计算逻辑

### 核心逻辑

```python
# 日维度计算
if time_period == 'day':
    period_days = 1
    current_start = max_date - timedelta(days=current_period_index)
    current_end = current_start
    compare_start = max_date - timedelta(days=compare_period_index)
    compare_end = compare_start
    
    current_label = f'{current_start.month}月{current_start.day}日'
    compare_label = f'{compare_start.month}月{compare_start.day}日'
```

---

## 📝 注意事项

### 1. 数据要求
- 必须包含`日期`字段
- 必须包含`商品名称`字段
- 日期数据类型需为 `datetime`

### 2. 使用建议
- **日维度**适合短期波动分析（1-30天）
- **周维度**适合中期趋势分析（1-12周）
- **月维度**适合长期趋势分析（1-12月）

### 3. 性能优化
- 日维度默认最多显示30天
- 周维度默认最多显示12周
- 月维度默认最多显示12个月

---

## 🎉 测试验证

运行测试脚本验证功能：
```powershell
python 测试日维度功能.py
```

预期输出：
- ✅ 成功生成30天的可用日期列表
- ✅ 成功对比昨天vs今天
- ✅ 成功对比10天前vs今天

---

## 📞 常见问题

**Q1: 为什么选择"按日对比"后，日期列表是空的？**
- A: 检查数据的日期范围，确保至少有2天的数据

**Q2: 日维度对比时，销量为什么都是0？**
- A: 可能是选择的日期没有订单数据，尝试选择其他日期

**Q3: 可以对比跨月的日期吗？**
- A: 可以！只要在30天范围内，任意两天都可以对比

**Q4: 日维度对比时，变化幅度特别大怎么办？**
- A: 正常现象，日维度数据波动比周/月维度更大，可以适当放宽下滑阈值

---

## 更新日志

**v1.1 - 2025/10/16**
- ✅ 新增按日对比功能
- ✅ 支持任意两天的销量对比
- ✅ 自动列出最近30天的可用日期
- ✅ 优化日期显示格式（X月X日）
