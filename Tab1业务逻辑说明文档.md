# 📊 智能门店经营看板 Tab1 业务逻辑说明文档

**文档版本**: v3.0  
**更新时间**: 2025-11-24  
**重要更新**: ⭐ 新增渠道过滤逻辑说明  
**数据来源**: 从实际代码提取的真实计算逻辑  
**代码文件**: `智能门店看板_Dash版.py`

---

## 🎯 Tab1 核心功能概览

Tab1（订单数据概览）是智能门店经营看板的核心分析模块,提供以下功能:

1. **整体指标卡片** - 订单数、销售额、利润、客单价等核心KPI
2. **渠道表现对比** - 多渠道业绩对比与环比分析
3. **客单价深度分析** - 价格区间分布与购物篮深度
4. **一级分类销售趋势** - 品类销售表现与周趋势
5. **每日趋势图表** - 订单量/销售额/利润的时间序列分析
6. **异常诊断面板** - 低利润率订单、高配送成本等预警

---

## 🔍 关键前置逻辑: 渠道过滤 (v2025-11-24新增)

> ⚠️ **重要**: 在计算所有指标之前,必须先进行渠道过滤,这是确保数据准确性的关键步骤!

### 渠道分类定义

**代码位置**: 第389-400行

```python
PLATFORM_FEE_CHANNELS = [
    '饿了么',
    '京东到家',
    '美团共橙',
    '美团闪购',
    '抖音',
    '抖音直播',
    '淘鲜达',
    '京东秒送',
    '美团咖啡店',
    '饿了么咖啡店'
]
```

### 过滤规则

**代码位置**: 第11925-11933行

```python
# 只剔除【收费渠道 且 平台服务费=0】的订单
is_fee_channel = order_agg['渠道'].isin(PLATFORM_FEE_CHANNELS)
is_zero_fee = order_agg.get('平台服务费', 0) <= 0

# 剔除条件: 收费渠道 且 服务费=0
invalid_orders = is_fee_channel & is_zero_fee
filtered = order_agg[~invalid_orders]
```

### 业务规则说明

| 渠道类型 | 平台服务费 | 处理方式 | 原因 |
|---------|----------|---------|------|
| **收费渠道** (美团闪购等) | >0 | ✅ 保留 | 正常订单 |
| **收费渠道** | =0 | ❌ 剔除 | 异常订单/测试单 |
| **不收费渠道** (闪购小程序等) | =0 | ✅ 保留 | 正常状态(本身不收费) |
| **不收费渠道** | >0 | ✅ 保留 | 正常订单 |

### 为什么要区分渠道类型?

**历史问题** (v2025-11-21之前):
- 一刀切剔除所有`平台服务费=0`的订单
- 导致闪购小程序、收银机订单等**正常订单**被错误剔除
- 造成利润数据失真,少计收入和利润

**修复后** (v2025-11-21):
- 按渠道类型区分过滤逻辑
- 收费渠道: `服务费=0`视为异常 → 剔除
- 不收费渠道: `服务费=0`视为正常 → 保留
- 确保数据完整性和准确性

**示例统计输出**:
```
📊 [过滤逻辑-按渠道类型] 统计报告:
  总订单数: 10000 单
  收费渠道订单数: 8500 单
  不收费渠道订单数: 1500 单
  收费渠道中服务费=0的订单: 50 单 (异常订单,已剔除)
  不收费渠道中服务费=0的订单: 1500 单 (正常订单,已保留)
  最终保留订单数: 9950 单
```

---

## 📐 计算口径配置

> 📌 **注意**: 以下所有计算都基于渠道过滤后的数据(`filtered`)

系统支持三种计算口径,影响利润额与配送净成本的统计范围:

### 1. **仅平台服务费>0（已废弃）**
- **代码标识**: `service_fee_positive`
- **过滤规则**: 只保留 `平台服务费 > 0` 或 `平台佣金 > 0` 的订单
- **适用场景**: 财务口径统计,只计算已上报平台服务费的订单
- **影响**: 会**过滤掉闪购小程序**等平台服务费为0的订单
- **状态**: ⚠️ 已被渠道过滤逻辑取代

### 2. **全量（仅平台服务费）（当前默认）**
- **代码标识**: `all_no_fallback`
- **过滤规则**: 使用渠道过滤逻辑(区分收费/不收费渠道)
- **适用场景**: 全面业务分析,包含所有合法订单
- **影响**: 包含闪购小程序,利润计算只用平台服务费
- **状态**: ✅ 当前Tab1默认使用

### 3. **全量（服务费+佣金兜底）**
- **代码标识**: `all_with_fallback`
- **过滤规则**: 使用渠道过滤 + 平台佣金兜底
- **适用场景**: 环比计算、渠道对比,确保数据完整性
- **影响**: 完整包含所有订单类型,利润计算更全面
- **状态**: 用于特定场景

**⚠️ 重要**: Tab1的订单数据概览**使用**`all_no_fallback`模式,配合渠道过滤逻辑确保数据准确。

---

## 💰 核心计算公式

> 📌 **前提**: 以下所有公式基于渠道过滤后的数据计算

### 1. 订单实际利润（全局唯一公式）

**代码位置**: `_calculate_profit_formula()` 函数 (第11988-12030行)

```python
订单实际利润 = 利润额 - 平台服务费 - 物流配送费 + 企客后返
```

**字段说明**:
- **利润额**: 来自Excel数据,已包含商品成本扣减
- **平台服务费**: 商品级字段,订单聚合时sum
- **物流配送费**: 订单级原始值,不剔除任何配送平台
- **企客后返**: 商品级补偿项,订单聚合时sum

**兜底逻辑** (v2025-11-19已移除):
```python
# ❌ 旧版本(已废弃): 
# if 平台服务费 <= 0:
#     使用平台佣金替代平台服务费

# ✅ 新版本: 统一只使用平台服务费,通过渠道过滤保证数据质量
```

---

### 2. 配送净成本

**代码位置**: 第11828行

```python
配送净成本 = 物流配送费 - (用户支付配送费 - 配送费减免金额) - 企客后返
```

**业务含义**: 平台真实承担的配送支出

**计算示例**:
- 物流配送费: 10元 (支付给骑手)
- 用户支付配送费: 8元
- 配送费减免金额: 5元 (平台活动)
- 企客后返: 0元
- **配送净成本** = 10 - (8 - 5) - 0 = **7元** (平台亏损)

---

### 3. 商家活动成本

```python
商家活动成本 = 满减金额 + 商品减免金额 + 商家代金券 + 商家承担部分券 + 满赠金额 + 商家其他优惠
```

**包含字段**:
- 满减金额 (订单级)
- 商品减免金额 (订单级)
- 商家代金券 (订单级)
- 商家承担部分券 (订单级)
- 满赠金额 (订单级)
- 商家其他优惠 (订单级)

---

### 4. 客单价计算

```python
客单价 = 实收价格 / 订单数
```

**注意**: 使用**实收价格**(用户实际支付金额),不是商品原价或预估订单收入。

**代码位置**: Tab1的所有客单价计算都基于`实收价格`字段

---

## 📊 订单聚合逻辑

### 聚合规则 (来自`calculate_order_metrics`函数)

**订单级字段** (使用`first()`):
- 用户支付配送费
- 配送费减免金额
- 物流配送费
- 平台佣金
- 满减金额
- 商品减免金额
- 商家代金券
- 商家承担部分券
- 打包袋金额
- 配送平台
- 渠道
- 满赠金额
- 商家其他优惠
- 新客减免金额

**商品级字段** (使用`sum()`):
- 商品实售价
- 预计订单收入
- 月售
- 平台服务费
- 实收价格 ⭐
- 利润额
- 企客后返
- 商品采购成本

**⚠️ 关键理解**:
- **减免金额类字段**: 在原始数据中每个商品行都重复显示订单总减免,聚合时用`first()`避免重复计算
- **实收价格**: 每个商品有不同的实收价格,需要`sum()`求订单总实收

---

## 🔍 渠道对比分析逻辑

### 渠道过滤规则

**强制排除渠道**:
```python
CHANNELS_TO_REMOVE = ['饿了么咖啡', '美团咖啡']
```

**当前包含渠道**:
- 美团闪购 (主力渠道)
- 饿了么 (主力渠道)
- 京东到家 (次要渠道)
- 闪购小程序 (特殊渠道,平台服务费=0,需用all_with_fallback模式)

### 渠道环比计算

**周期计算逻辑**:
```python
period_days = (end_date - start_date).days + 1
prev_end_date = start_date - timedelta(days=1)
prev_start_date = prev_end_date - timedelta(days=period_days - 1)
```

**示例** (选择10月31日单天):
- 当前周期: 2024-10-31 ~ 2024-10-31 (1天)
- 上一周期: 2024-10-30 ~ 2024-10-30 (1天)

**环比指标**:
- 订单数环比
- 销售额环比 (基于实收价格)
- 总利润环比
- 客单价环比
- 利润率环比 (百分点差值,非百分比变化)

**代码位置**: `calculate_channel_comparison()` 函数 (第1510行)

---

## 📈 客单价区间分布

### 标准价格区间

```python
price_ranges = [
    (0, 10, '¥0-10'),
    (10, 20, '¥10-20'),
    (20, 30, '¥20-30'),
    (30, 40, '¥30-40'),
    (40, 50, '¥40-50'),
    (50, 100, '¥50-100'),
    (100, 200, '¥100-200'),
    (200, float('inf'), '¥200+')
]
```

### 四大业务价格组

**1. 流量区** (< ¥15)
- **业务定位**: 引流低价商品
- **典型商品**: 特价单品、促销品

**2. 主流区** (¥15-30)
- **业务定位**: 日常高频商品
- **特点**: 通常占订单量的50-60%

**3. 利润区** (¥30-50)
- **业务定位**: 毛利贡献主力
- **特点**: 利润率相对较高

**4. 高价区** (≥ ¥50)
- **业务定位**: 高端/大单商品
- **特点**: 单量少但客单价高

### 购物篮深度

```python
购物篮深度 = 订单平均SKU数 = 总商品行数 / 订单数
```

**统计方式**: 从原始数据(df)中按订单ID计算行数,再求平均值

---

## 📊 一级分类销售趋势

### 分类销售额计算

```python
# 按一级分类和周统计
分类周销售额 = order_agg.groupby(['一级分类', '周'])['实收价格'].sum()
```

**渠道筛选支持**:
- 支持按渠道过滤 (美团闪购、饿了么、京东到家等)
- 支持"全部渠道"模式
- 咖啡渠道自动排除

**趋势分析**:
- 周销售额趋势线
- 品类占比分析
- 环比变化百分比

**代码位置**: `create_category_trend_chart_echarts()` 函数 (第8756行)

---

## ⚠️ 异常诊断规则

### 1. 低利润率订单预警

**触发条件**:
```python
利润率 = (订单实际利润 / 实收价格) * 100
if 利润率 < 10%:  # 阈值可调整
    标记为低利润率订单
```

### 2. 高配送成本订单

**触发条件**:
```python
配送成本占比 = (配送净成本 / 实收价格) * 100
if 配送成本占比 > 30%:  # 阈值可调整
    标记为高配送成本订单
```

### 3. 负利润订单

**触发条件**:
```python
if 订单实际利润 < 0:
    标记为负利润订单(亏损)
```

---

## 🔄 环比计算逻辑

### 整体指标环比

**计算函数**: `calculate_comparison()` (第1220行)

**环比指标**:
- 订单数环比
- 商品实收额环比 (注:显示名为"预计零售额",实际用实收价格)
- 总利润环比
- 客单价环比
- 总利润率环比 (使用差值,非百分比)
- 动销商品数环比

**计算公式**:
```python
# 通用环比公式
环比变化率 = ((当前值 - 上期值) / 上期值) * 100

# 利润率特殊处理(使用百分点差值)
利润率环比 = 当前利润率 - 上期利润率
```

**强制使用** `all_with_fallback` 模式,确保当前期和上一期数据口径一致。

---

## 🎨 数据可视化组件

### 1. 整体指标卡片

**显示内容**:
- 核心数值 (当前周期)
- 环比徽章 (↑/↓ + 百分比)
- 趋势方向 (正向/负向指标判断)

**环比颜色规则**:
- 正向指标(订单数、销售额、利润) : 上升=绿色↑ 下降=红色↓
- 负向指标(配送成本) : 上升=红色↑ 下降=绿色↓

### 2. 渠道对比卡片

**每个渠道显示**:
- 订单数 + 环比
- 销售额 + 环比
- 利润额 + 环比
- 客单价 + 环比
- 利润率 + 环比
- 综合评级徽章 (优秀/良好/需改进)

### 3. ECharts图表

**类型**:
- 客单价区间柱状图 (含订单数标签)
- 一级分类趋势折线图 (多系列)
- 每日趋势组合图 (订单量/销售额/利润)

---

## 🔧 关键技术实现

### 1. 缓存机制

**三层缓存架构**:
1. **Redis缓存** (30分钟) - 跨会话共享
2. **内存缓存** (5分钟) - 单会话快速访问
3. **组件缓存** - 订单聚合数据和环比数据

**缓存失效触发**:
- 数据更新触发 (data-update-trigger变化)
- 门店切换
- 日期范围变化
- 缓存版本不匹配

### 2. 异步加载策略

**加载顺序**:
1. 数据信息卡片 (最先加载)
2. 整体指标卡片 + 环比数据
3. 渠道表现对比卡片
4. 客单价深度分析
5. 一级分类销售趋势
6. 每日趋势图表
7. 异常诊断面板

**优势**: 提升用户体验,避免长时间等待

### 3. 渠道字段合并逻辑

**问题**: `calculate_order_metrics`返回的订单聚合数据已包含`'渠道'`字段

**解决方案**:
```python
if '渠道' not in order_metrics.columns:
    # 需要从原始数据merge
    order_channel = data.groupby('订单ID')['渠道'].first().reset_index()
    order_metrics = order_metrics.merge(order_channel, on='订单ID', how='left')
else:
    # 已有渠道字段,跳过merge
    print("✅ order_metrics已包含'渠道'字段,跳过merge")
```

**重要**: 避免重复merge导致`'渠道'`被重命名为`'渠道_x'`和`'渠道_y'`

---

## 📋 数据质量要求

### 必需字段

**订单级**:
- 订单ID (主键)
- 渠道
- 物流配送费
- 平台佣金/平台服务费
- 用户支付配送费
- 配送费减免金额

**商品级**:
- 订单ID (外键)
- 实收价格
- 利润额
- 商品采购成本
- 预计订单收入

### 可选字段

- 企客后返 (缺失时默认为0)
- 新客减免金额 (缺失时默认为0)
- 满减金额/商品减免金额等 (营销成本分析)
- 配送平台 (配送成本优化)
- 一级分类 (品类分析)

### 数据类型要求

- **订单ID**: 字符串类型 (系统自动转换)
- **日期字段**: datetime类型 (自动解析'日期'或'下单时间')
- **金额字段**: 数值类型,空值填充为0
- **渠道字段**: 字符串,必须非空

---

## 🚀 性能优化建议

1. **使用Redis缓存**: 减少重复计算,提升多用户访问速度
2. **启用计算口径选择**: 根据分析场景选择合适模式
3. **合理设置日期范围**: 避免一次性加载过多数据
4. **定期清理缓存**: 避免内存占用过高

---

## 📝 版本更新记录

### v2.0 (2025-11-17)
- ✅ 基于实际代码重新梳理全部业务逻辑
- ✅ 添加三种计算口径详细说明
- ✅ 补充渠道字段合并逻辑
- ✅ 完善环比计算公式说明
- ✅ 添加客单价区间业务化解释
- ✅ 新增异步加载策略说明

### v1.0 (2025-09-25)
- 初始版本(已过时,不再适用)

---

**📌 重要提示**: 
1. 本文档所有公式和逻辑均从代码中提取,确保准确性
2. 如需修改计算逻辑,请同步更新本文档
3. 所有利润计算使用**全局唯一公式** `_calculate_profit_formula()`,修改时需谨慎
4. 环比和渠道对比强制使用`all_with_fallback`模式,确保包含闪购小程序等所有订单
