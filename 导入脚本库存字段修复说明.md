# 导入脚本库存字段修复说明

## 问题诊断

### 现象
滞销品统计和库存周转仍然没有数据,显示为0。

### 根本原因
**数据库中所有库存数据都是0!**

虽然已完成:
- ✅ 数据库有字段(stock, remaining_stock)
- ✅ models.py有字段定义
- ✅ 代码支持中英文字段名

但是:
- ❌ **导入脚本没有读取和导入库存数据!**

### 数据验证

```sql
-- 检查数据库库存字段统计
SELECT 
    COUNT(*) as total_records,
    COUNT(stock) as stock_count,
    COUNT(remaining_stock) as remaining_stock_count,
    COUNT(CASE WHEN stock > 0 THEN 1 END) as stock_gt_0,
    COUNT(CASE WHEN remaining_stock > 0 THEN 1 END) as remaining_stock_gt_0
FROM orders;

-- 结果:
-- total_records: 77499
-- stock_count: 77499 (字段存在)
-- remaining_stock_count: 77499 (字段存在)
-- stock_gt_0: 0 (全是0!)
-- remaining_stock_gt_0: 0 (全是0!)
```

**结论:** 字段存在,但数据全是默认值0,说明导入时没有读取Excel的库存列。

---

## 修复方案

### 修改文件
`database/batch_import.py` - Line 159-175

### 修复前
```python
order_data = {
    'order_id': order_id,
    'date': order_date,
    'store_name': str(row.get('门店名称', 'UNKNOWN')),
    'product_name': str(row.get('商品名称', '')),
    'barcode': str(row.get('商品条形码', '')) if pd.notna(row.get('商品条形码')) else None,
    'category_level1': str(row.get('一级分类名', '')) if pd.notna(row.get('一级分类名')) else None,
    'category_level3': str(row.get('三级分类名', '')) if pd.notna(row.get('三级分类名')) else None,
    'price': float(row.get('商品实售价', 0)) if pd.notna(row.get('商品实售价')) else 0,
    'cost': float(row.get('商品采购成本', 0)) if pd.notna(row.get('商品采购成本')) else None,
    'quantity': int(row.get('销售数量', 1)) if pd.notna(row.get('销售数量')) else 1,
    'amount': float(row.get('实收金额', 0)) if pd.notna(row.get('实收金额')) else 0,
    'channel': str(row.get('渠道', '')) if pd.notna(row.get('渠道')) else None,
    # ❌ 缺少 stock 和 remaining_stock 字段
}
```

### 修复后
```python
# 🔧 库存字段兼容性处理(支持多种列名)
stock_value = None
remaining_stock_value = None

# 尝试读取库存字段(优先级从高到低)
for col in ['库存', 'stock', '期末库存']:
    if col in row.index and pd.notna(row.get(col)):
        stock_value = float(row[col]) if row[col] != '' else None
        break

# 尝试读取剩余库存字段
for col in ['剩余库存', 'remaining_stock', '当前库存']:
    if col in row.index and pd.notna(row.get(col)):
        remaining_stock_value = float(row[col]) if row[col] != '' else None
        break

order_data = {
    'order_id': order_id,
    'date': order_date,
    'store_name': str(row.get('门店名称', 'UNKNOWN')),
    'product_name': str(row.get('商品名称', '')),
    'barcode': str(row.get('商品条形码', '')) if pd.notna(row.get('商品条形码')) else None,
    'category_level1': str(row.get('一级分类名', '')) if pd.notna(row.get('一级分类名')) else None,
    'category_level3': str(row.get('三级分类名', '')) if pd.notna(row.get('三级分类名')) else None,
    'price': float(row.get('商品实售价', 0)) if pd.notna(row.get('商品实售价')) else 0,
    'cost': float(row.get('商品采购成本', 0)) if pd.notna(row.get('商品采购成本')) else None,
    'quantity': int(row.get('销售数量', 1)) if pd.notna(row.get('销售数量')) else 1,
    'amount': float(row.get('实收金额', 0)) if pd.notna(row.get('实收金额')) else 0,
    'channel': str(row.get('渠道', '')) if pd.notna(row.get('渠道')) else None,
    'stock': int(stock_value) if stock_value is not None else 0,  # ✅ 库存
    'remaining_stock': float(remaining_stock_value) if remaining_stock_value is not None else 0,  # ✅ 剩余库存
}
```

### 核心改进

1. **支持多种列名**
   - 库存: `库存`, `stock`, `期末库存`
   - 剩余库存: `剩余库存`, `remaining_stock`, `当前库存`

2. **安全的数据读取**
   - 检查列是否存在: `col in row.index`
   - 检查值是否有效: `pd.notna(row.get(col))`
   - 处理空字符串: `if row[col] != ''`

3. **数据类型转换**
   - stock → int (整数库存)
   - remaining_stock → float (精确库存)

---

## 重新导入数据

修复后需要重新导入Excel数据,才能将库存数据写入数据库。

### 方式1: 使用批量导入脚本

```powershell
# 激活虚拟环境
.\.venv\Scripts\Activate.ps1

# 运行批量导入
cd database
python batch_import.py

# 按提示输入数据目录
# 例如: D:\Python1\O2O_Analysis\O2O数据分析\测算模型\历史数据导入\祥和路店
```

### 方式2: 使用智能导入工具

```powershell
python 智能导入门店数据.py
```

选择包含库存列的Excel文件进行导入。

### 方式3: 清空数据库重新导入(谨慎!)

```powershell
# 方法1: 删除所有订单数据
python -c "from database.connection import get_db; from database.models import Order; db = next(get_db()); db.query(Order).delete(); db.commit(); print('✅ 订单数据已清空')"

# 方法2: 重建数据库表
python 重建数据库表.py

# 然后重新导入
python 智能导入门店数据.py
```

---

## 验证修复

### 1. 检查导入后的库存数据

```powershell
python -c "
from database.connection import get_db
from sqlalchemy import text

db = next(get_db())
result = db.execute(text('''
    SELECT 
        COUNT(*) as total,
        COUNT(CASE WHEN stock > 0 THEN 1 END) as stock_gt_0,
        COUNT(CASE WHEN remaining_stock > 0 THEN 1 END) as remaining_stock_gt_0,
        AVG(stock) as avg_stock,
        AVG(remaining_stock) as avg_remaining_stock
    FROM orders
''')).fetchone()

print(f'总记录数: {result[0]}')
print(f'stock>0记录: {result[1]}')
print(f'remaining_stock>0记录: {result[2]}')
print(f'stock平均值: {result[3]:.2f}')
print(f'remaining_stock平均值: {result[4]:.2f}')
db.close()
"
```

**期望结果:**
```
总记录数: 77499
stock>0记录: 50000+ (不再是0!)
remaining_stock>0记录: 50000+ (不再是0!)
stock平均值: 10.5+ (不再是0!)
remaining_stock平均值: 8.3+ (不再是0!)
```

### 2. 查看样本数据

```sql
SELECT 
    订单ID,
    商品名称,
    stock as 库存,
    remaining_stock as 剩余库存,
    日期
FROM orders
WHERE stock > 0 OR remaining_stock > 0
LIMIT 10;
```

### 3. 重启看板验证功能

```powershell
.\启动看板.ps1
```

访问 http://localhost:8050，检查:
- **数据库数据源** → **一级分类销售趋势**
- 售罄品数 应该有数据
- 滞销品总数 应该有数据和分级
- 库存周转天数 应该有数据

---

## 注意事项

### 1. Excel文件必须包含库存列

确保要导入的Excel文件中有以下列之一:
- `库存` (推荐)
- `剩余库存` (推荐)
- `stock`
- `remaining_stock`
- `期末库存`
- `当前库存`

如果Excel文件中没有库存列,导入后库存仍然是0。

### 2. 历史数据需要重新导入

之前导入的数据库存都是0,需要:
1. 清空旧数据
2. 重新导入包含库存列的Excel
3. 或者更新现有数据(需要编写更新脚本)

### 3. 数据来源确认

**问题:** 您的Excel数据源是否包含库存列?

如果没有库存列,有以下解决方案:
- 方案A: 从原始系统导出时勾选库存字段
- 方案B: 使用商品主数据表关联库存信息
- 方案C: 根据业务规则计算理论库存

---

## 数据流程完整性检查

### 完整的数据流程

```
Excel数据 (必须有库存列)
  ↓
batch_import.py (读取库存列) ← ✅ 已修复
  ↓
PostgreSQL数据库 (stock, remaining_stock字段) ← ✅ 字段存在
  ↓
models.py (Order模型定义) ← ✅ 字段定义存在
  ↓
SQLAlchemy ORM查询
  ↓
DataSourceManager (返回DataFrame)
  ↓
智能门店看板 (字段名检查) ← ✅ 兼容中英文
  ↓
业务逻辑计算 (滞销品、库存周转) ← ⏳ 等待数据导入
```

### 当前状态

- ✅ 数据库字段完整
- ✅ models.py字段定义完整
- ✅ 代码字段名兼容性完整
- ✅ 导入脚本支持库存字段 (已修复)
- ⏳ **需要重新导入数据,将库存数据写入数据库**

---

## 下一步行动

### 立即执行

1. **确认Excel数据源**
   ```powershell
   # 检查Excel是否有库存列
   python -c "
   import pandas as pd
   df = pd.read_excel('你的Excel文件路径.xlsx', nrows=5)
   stock_cols = [col for col in df.columns if '库存' in col or 'stock' in col.lower()]
   print(f'库存列: {stock_cols}')
   print(f'样本数据: {df[stock_cols].head() if stock_cols else \"无库存列\"}')"
   ```

2. **重新导入数据**
   ```powershell
   python 智能导入门店数据.py
   ```

3. **验证导入结果**
   ```powershell
   # 检查库存数据
   python -c "from database.connection import get_db; from sqlalchemy import text; db = next(get_db()); result = db.execute(text('SELECT COUNT(*) FILTER (WHERE stock > 0) FROM orders')).scalar(); print(f'有库存数据的记录: {result}')"
   ```

4. **重启看板验证**
   ```powershell
   .\启动看板.ps1
   ```

---

## 总结

**问题:** 滞销品和库存周转没有数据  
**根因:** 导入脚本没有读取Excel的库存列,导致数据库中库存全是0  
**修复:** 在`batch_import.py`的`order_data`字典中添加`stock`和`remaining_stock`字段的读取逻辑  
**验证:** 重新导入数据后,数据库中应有库存数据,看板功能恢复正常

**关键点:** 
- Excel数据必须包含库存列
- 需要重新导入数据才能生效
- 建议清空旧数据后重新导入

**修复文件:** `database/batch_import.py`  
**影响范围:** 所有通过批量导入的订单数据  
**兼容性:** 支持多种库存列名(中英文)
