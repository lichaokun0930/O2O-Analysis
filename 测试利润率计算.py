"""
测试利润率计算逻辑

综合利润率 = 利润额 / 销售额 × 100
定价利润率 = (商品原价 - 单品成本) / 商品原价 × 100
"""

import pandas as pd
import numpy as np

# 模拟几个商品的数据
test_data = [
    {
        '商品名称': '可乐 330ml',
        '销售额': 1000,
        '利润额': 300,
        '商品原价': 3.5,
        '单品成本': 2.0,
        '销量': 300
    },
    {
        '商品名称': '矿泉水 500ml',
        '销售额': 500,
        '利润额': 50,
        '商品原价': 2.0,
        '单品成本': 1.5,
        '销量': 250
    },
    {
        '商品名称': '薯片 大包',
        '销售额': 800,
        '利润额': -100,  # 亏损商品
        '商品原价': 8.0,
        '单品成本': 5.0,
        '销量': 100
    },
    {
        '商品名称': '引流特价品',
        '销售额': 10,
        '利润额': -90,  # 战略引流，亏损
        '商品原价': 10.0,
        '单品成本': 5.0,
        '销量': 10
    }
]

df = pd.DataFrame(test_data)

print("=" * 80)
print("原始数据")
print("=" * 80)
print(df.to_string(index=False))

# 计算综合利润率
df['综合利润率_计算'] = np.where(
    df['销售额'] > 0,
    (df['利润额'] / df['销售额'] * 100),
    0
)

# 计算定价利润率
df['定价利润率_计算'] = np.where(
    df['商品原价'] > 0,
    ((df['商品原价'] - df['单品成本']) / df['商品原价'] * 100),
    0
)

# 计算实收单价（销售额÷销量）
df['实收单价'] = df['销售额'] / df['销量']

# 计算单品利润（利润额÷销量）
df['单品利润'] = df['利润额'] / df['销量']

# 计算实收利润率（单品利润÷实收单价）
df['实收利润率'] = np.where(
    df['实收单价'] > 0,
    (df['单品利润'] / df['实收单价'] * 100),
    0
)

print("\n" + "=" * 80)
print("计算结果")
print("=" * 80)
print(df[[
    '商品名称', 
    '销售额', '利润额', '销量',
    '实收单价', '单品利润',
    '综合利润率_计算', '实收利润率',
    '商品原价', '单品成本', '定价利润率_计算'
]].to_string(index=False))

print("\n" + "=" * 80)
print("公式验证")
print("=" * 80)

for idx, row in df.iterrows():
    print(f"\n【{row['商品名称']}】")
    print(f"  销售额: ¥{row['销售额']:.2f}, 利润额: ¥{row['利润额']:.2f}, 销量: {row['销量']}件")
    print(f"  实收单价: ¥{row['实收单价']:.2f}, 单品利润: ¥{row['单品利润']:.2f}")
    print(f"  ")
    print(f"  📊 综合利润率 = 利润额 ÷ 销售额 × 100")
    print(f"              = {row['利润额']:.2f} ÷ {row['销售额']:.2f} × 100")
    print(f"              = {row['综合利润率_计算']:.2f}%")
    print(f"  ")
    print(f"  📊 实收利润率 = 单品利润 ÷ 实收单价 × 100")
    print(f"              = {row['单品利润']:.2f} ÷ {row['实收单价']:.2f} × 100")
    print(f"              = {row['实收利润率']:.2f}%")
    print(f"  ")
    print(f"  💰 定价利润率 = (商品原价 - 单品成本) ÷ 商品原价 × 100")
    print(f"              = ({row['商品原价']:.2f} - {row['单品成本']:.2f}) ÷ {row['商品原价']:.2f} × 100")
    print(f"              = {row['定价利润率_计算']:.2f}%")
    
    # 验证：综合利润率 应该等于 实收利润率
    if abs(row['综合利润率_计算'] - row['实收利润率']) < 0.01:
        print(f"  ✅ 验证通过：综合利润率 = 实收利润率 = {row['综合利润率_计算']:.2f}%")
    else:
        print(f"  ⚠️ 验证失败：综合利润率({row['综合利润率_计算']:.2f}%) ≠ 实收利润率({row['实收利润率']:.2f}%)")

print("\n" + "=" * 80)
print("结论")
print("=" * 80)
print("""
1. 综合利润率 = 利润额 / 销售额 × 100
   - 这是汇总口径，反映整体盈利能力
   - 受促销、折扣影响
   
2. 定价利润率 = (商品原价 - 单品成本) / 商品原价 × 100
   - 这是定价口径，反映原价定价的利润空间
   - 不受促销、折扣影响
   
3. 实收利润率 = (实收单价 - 单品成本) / 实收单价 × 100
   - 这是实际成交口径
   - 理论上应该等于综合利润率（数学上等价）
   
📌 关键区别：
   - 综合利润率：基于汇总数据计算（总利润÷总销售额）
   - 定价利润率：基于原价定价计算
   - 实收利润率：基于实际成交价计算
""")
