# 销量下滑诊断 - 周期灵活对比与预计收入功能说明

## 📋 需求概览

**实施日期**: 2025-10-15  
**需求来源**: 用户反馈  
**功能模块**: 销量下滑诊断 (`diagnose_sales_decline`)

### 需求1: 新增"商品预计收入"列 ✅
- **目的**: 直观展示商品的预计收入,帮助识别高价值下滑商品
- **数据来源**: 源数据的`预计订单收入`字段
- **聚合方式**: 按商品名称求和
- **显示格式**: 金额格式(¥xxx.x)

### 需求2: 周期灵活对比 ✅
- **目的**: 让用户自主选择对比的两个周期,而不是固定的"本周vs上周"
- **改进点**:
  1. 动态表头显示具体周期(如"第38周销量"、"第37周销量")
  2. 支持跨周期对比(如第38周 vs 第35周)
  3. 提供周期选择器供UI调用

---

## 🎯 功能详解

### 1. 新增参数

#### `current_period_index` (当前周期索引)
- **类型**: `Optional[int]`
- **默认值**: `None` (等同于0,表示最新周期)
- **说明**: 
  - `0` = 最新周 (如第38周)
  - `1` = 上一周 (如第37周)
  - `2` = 上上周 (如第36周)
  - ...以此类推

#### `compare_period_index` (对比周期索引)
- **类型**: `Optional[int]`
- **默认值**: `None` (等同于`current_period_index + 1`)
- **说明**: 指定与哪个周期对比

**示例用法**:
```python
# 默认用法: 最新周 vs 上一周 (第38周 vs 第37周)
result = engine.diagnose_sales_decline()

# 自定义: 第38周 vs 第37周
result = engine.diagnose_sales_decline(
    current_period_index=0,
    compare_period_index=1
)

# 跨周对比: 第38周 vs 第35周
result = engine.diagnose_sales_decline(
    current_period_index=0,
    compare_period_index=3
)

# 历史对比: 第36周 vs 第34周
result = engine.diagnose_sales_decline(
    current_period_index=2,
    compare_period_index=4
)
```

### 2. 动态表头

#### 修改前（固定表头）:
```
| 商品名称 | 本周销量 | 上期销量 | 销量变化 | 变化幅度% |
```
❌ 问题: 不知道"本周"和"上期"具体是哪一周

#### 修改后（动态表头）:
```
| 商品名称 | 第38周销量 | 第37周销量 | 第38周预计收入 | 第37周预计收入 | 销量变化 | 变化幅度% |
```
✅ 改进: 
- 清楚显示对比周期
- 新增预计收入列
- 支持任意周期对比

### 3. 预计收入统计

**数据来源**:
- 优先使用: `预计订单收入`
- 备选使用: `预估订单收入`

**聚合逻辑**:
```python
# 按商品名称聚合收入
current_revenue = current_data.groupby('商品名称')['预计订单收入'].sum()
previous_revenue = previous_data.groupby('商品名称')['预计订单收入'].sum()

# 添加到结果DataFrame
comparison[f'{current_label}预计收入'] = current_revenue.fillna(0)
comparison[f'{compare_label}预计收入'] = previous_revenue.fillna(0)
```

**格式化**:
```python
# 金额格式: ¥xxx.x
result[col] = result[col].apply(
    lambda x: f"¥{x:.1f}" if pd.notna(x) and x > 0 else "¥0.0"
)
```

### 4. 辅助方法: `get_available_periods()`

**功能**: 获取可用的时间周期列表,供UI选择器使用

**参数**:
- `time_period`: `'week'` 或 `'month'`

**返回值**: 周期列表
```python
[
    {
        'index': 0,
        'label': '第38周 (2025年)',
        'date_range': '2025-09-16 ~ 2025-09-22',
        'start_date': datetime(2025, 9, 16),
        'end_date': datetime(2025, 9, 22)
    },
    {
        'index': 1,
        'label': '第37周 (2025年)',
        'date_range': '2025-09-09 ~ 2025-09-15',
        'start_date': datetime(2025, 9, 9),
        'end_date': datetime(2025, 9, 15)
    },
    ...
]
```

**用途**: 在Streamlit中生成下拉选择器
```python
# 在UI中使用
available_periods = engine.get_available_periods('week')
period_options = {p['label']: p['index'] for p in available_periods}

selected_current = st.selectbox(
    "选择当前周期",
    options=list(period_options.keys())
)
selected_compare = st.selectbox(
    "选择对比周期", 
    options=list(period_options.keys())
)

# 调用诊断方法
result = engine.diagnose_sales_decline(
    current_period_index=period_options[selected_current],
    compare_period_index=period_options[selected_compare]
)
```

---

## 📊 数据结构变化

### 结果DataFrame新增列

| 列名 | 数据类型 | 示例值 | 说明 |
|------|---------|--------|------|
| `第38周销量` | int | 5 | 当前周期销量（动态列名） |
| `第37周销量` | int | 8 | 对比周期销量（动态列名） |
| `第38周预计收入` | str | ¥125.5 | 当前周期预计收入（新增） |
| `第37周预计收入` | str | ¥198.0 | 对比周期预计收入（新增） |
| `销量变化` | int | -3 | 销量变化量 |
| `变化幅度%` | str | -37.5% | 变化百分比 |

### 完整示例表格

| 商品名称 | 一级分类名 | 三级分类名 | 第38周销量 | 第37周销量 | 第38周预计收入 | 第37周预计收入 | 销量变化 | 变化幅度% | 商品实售价 | 问题等级 | 建议操作 |
|---------|-----------|-----------|-----------|-----------|---------------|---------------|---------|----------|-----------|---------|---------|
| 可口可乐330ml*6 | 食品饮料 | 碳酸饮料 | 2 | 8 | ¥25.8 | ¥103.2 | -6 | -75.0% | ¥12.9 | 🔴 严重 | 季节性?竞品?库存? |
| 德青源鲜鸡蛋10枚 | 生鲜食品 | 禽蛋类 | 0 | 5 | ¥0.0 | ¥79.0 | -5 | -100.0% | ¥15.8 | 🔴 严重 | 库存问题或下架 |

---

## 🔧 技术实现细节

### 1. 周期计算逻辑

**修改前（固定逻辑）**:
```python
# 硬编码的时间范围
if time_period == 'week':
    current_start = max_date - timedelta(days=6)
    previous_start = current_start - timedelta(days=7)
    previous_end = current_start - timedelta(days=1)
```

**修改后（灵活逻辑）**:
```python
# 基于索引的动态计算
period_days = 7  # 周期天数

# 当前周期
current_start = max_date - timedelta(days=(current_period_index + 1) * period_days - 1)
current_end = max_date - timedelta(days=current_period_index * period_days)

# 对比周期
compare_start = max_date - timedelta(days=(compare_period_index + 1) * period_days - 1)
compare_end = max_date - timedelta(days=compare_period_index * period_days)

# 计算周数（ISO标准）
current_week = current_end.isocalendar()[1]
compare_week = compare_end.isocalendar()[1]
current_label = f'第{current_week}周'
compare_label = f'第{compare_week}周'
```

**周期计算示例** (假设max_date = 2025-09-22):

| current_period_index | 周期范围 | 标签 |
|---------------------|---------|------|
| 0 | 2025-09-16 ~ 2025-09-22 | 第38周 |
| 1 | 2025-09-09 ~ 2025-09-15 | 第37周 |
| 2 | 2025-09-02 ~ 2025-09-08 | 第36周 |
| 3 | 2025-08-26 ~ 2025-09-01 | 第35周 |

### 2. 收入聚合逻辑

```python
# 初始化空Series
current_revenue = pd.Series(dtype=float)
previous_revenue = pd.Series(dtype=float)

# 检测字段名（兼容两种命名）
if '预计订单收入' in current_data.columns:
    current_revenue = current_data.groupby('商品名称')['预计订单收入'].sum()
elif '预估订单收入' in current_data.columns:
    current_revenue = current_data.groupby('商品名称')['预估订单收入'].sum()

# 同样处理对比周期
if '预计订单收入' in previous_data.columns:
    previous_revenue = previous_data.groupby('商品名称')['预计订单收入'].sum()
elif '预估订单收入' in previous_data.columns:
    previous_revenue = previous_data.groupby('商品名称')['预估订单收入'].sum()

# 添加到结果（仅当有数据时）
if not current_revenue.empty:
    comparison[f'{current_label}预计收入'] = current_revenue.fillna(0)
if not previous_revenue.empty:
    comparison[f'{compare_label}预计收入'] = previous_revenue.fillna(0)
```

**为什么检查empty?**
- 如果源数据没有`预计订单收入`字段,就不添加该列
- 避免空列占用表格空间
- 保持向后兼容性

### 3. 动态列名格式化

```python
# 动态检测销量列（所有包含"销量"的列）
sales_columns = [col for col in result.columns if '销量' in col and col != '销量变化']
for col in sales_columns + ['销量变化']:
    if col in result.columns:
        result[col] = result[col].fillna(0).astype(int)

# 动态检测收入列（所有包含"预计收入"的列）
revenue_columns = [col for col in result.columns if '预计收入' in col]
for col in revenue_columns:
    if col in result.columns:
        result[col] = result[col].apply(
            lambda x: f"¥{x:.1f}" if pd.notna(x) and x > 0 else "¥0.0"
        )
```

**优势**: 无论周期标签如何变化(第38周、第37周、9月、8月),格式化逻辑都能正确应用

---

## 🎨 UI集成方案

### Streamlit实现示例

```python
import streamlit as st
from 问题诊断引擎 import ProblemDiagnosticEngine

# 初始化引擎
engine = ProblemDiagnosticEngine(order_data)

# 🆕 需求2: 周期选择器
st.subheader("📅 选择对比周期")

col1, col2 = st.columns(2)

with col1:
    period_type = st.radio(
        "周期类型",
        options=['week', 'month'],
        format_func=lambda x: '按周' if x == 'week' else '按月',
        horizontal=True
    )

# 获取可用周期
available_periods = engine.get_available_periods(period_type)
period_options = {p['label']: p['index'] for p in available_periods}

with col2:
    use_custom_compare = st.checkbox("自定义周期对比", value=False)

if use_custom_compare:
    col_a, col_b = st.columns(2)
    
    with col_a:
        selected_current = st.selectbox(
            "📊 当前周期",
            options=list(period_options.keys()),
            help="选择要分析的周期"
        )
    
    with col_b:
        # 过滤掉当前周期,避免自己跟自己比
        compare_options = {
            k: v for k, v in period_options.items() 
            if v != period_options[selected_current]
        }
        selected_compare = st.selectbox(
            "📉 对比周期", 
            options=list(compare_options.keys()),
            help="选择要对比的周期"
        )
    
    current_idx = period_options[selected_current]
    compare_idx = period_options[selected_compare]
    
    st.info(f"将对比: **{selected_current}** vs **{selected_compare}**")
else:
    current_idx = None  # 使用默认值(最新周)
    compare_idx = None  # 使用默认值(上一周)
    st.info("使用默认对比: **最新周** vs **上一周**")

# 执行诊断
if st.button("🔍 开始诊断", type="primary"):
    with st.spinner("正在分析销量下滑商品..."):
        result = engine.diagnose_sales_decline(
            time_period=period_type,
            threshold=-20.0,
            current_period_index=current_idx,
            compare_period_index=compare_idx
        )
    
    if len(result) > 0:
        st.success(f"✅ 发现 {len(result)} 个销量下滑商品")
        
        # 🆕 需求1: 显示包含预计收入的表格
        st.dataframe(
            result,
            use_container_width=True,
            height=400
        )
        
        # 下载按钮
        csv = result.to_csv(index=False, encoding='utf-8-sig')
        st.download_button(
            label="📥 下载诊断结果",
            data=csv,
            file_name=f"销量下滑诊断_{selected_current if use_custom_compare else '默认'}.csv",
            mime="text/csv"
        )
    else:
        st.info("🎉 未发现销量明显下滑的商品")
```

### UI效果展示

**默认模式（不勾选"自定义周期对比"）**:
```
┌─────────────────────────────────┐
│ 📅 选择对比周期                  │
├─────────────────────────────────┤
│ ⚪ 按周  ⚫ 按月                 │
│ ☐ 自定义周期对比                │
│                                 │
│ ℹ️ 使用默认对比: 最新周 vs 上一周 │
│                                 │
│ [🔍 开始诊断]                   │
└─────────────────────────────────┘
```

**自定义模式（勾选"自定义周期对比"）**:
```
┌──────────────────────────────────────────────┐
│ 📅 选择对比周期                               │
├──────────────────────────────────────────────┤
│ ⚪ 按周  ⚫ 按月                              │
│ ☑ 自定义周期对比                             │
│                                              │
│ 📊 当前周期        │ 📉 对比周期             │
│ ▼ 第38周 (2025年) │ ▼ 第35周 (2025年)      │
│                                              │
│ ℹ️ 将对比: 第38周 vs 第35周                  │
│                                              │
│ [🔍 开始诊断]                                │
└──────────────────────────────────────────────┘
```

---

## 📈 业务价值

### 1. 预计收入列的价值

**场景**: 两个商品都销量下滑-50%,但:
- 商品A: 第38周预计收入 ¥1250.0 → 第37周 ¥2500.0
- 商品B: 第38周预计收入 ¥12.5 → 第37周 ¥25.0

**决策差异**:
- ❗ 商品A: 高优先级处理(收入损失¥1250)
- ℹ️ 商品B: 低优先级关注(收入损失¥12.5)

**排序建议**:
```python
# 按收入损失排序(而不是只按变化幅度)
result['收入损失'] = (
    result[f'{compare_label}预计收入'] - 
    result[f'{current_label}预计收入']
)
result = result.sort_values('收入损失', ascending=False)
```

### 2. 灵活周期对比的价值

#### 场景1: 发现季节性规律
```
第38周 vs 第35周 (跨3周对比)
发现: 某些商品每3周会周期性下滑
决策: 调整备货周期,避免库存积压
```

#### 场景2: 验证营销效果
```
第38周(促销后) vs 第34周(促销前)
发现: 促销商品销量提升,但预计收入下降(降价过多)
决策: 优化折扣力度,平衡销量和利润
```

#### 场景3: 长期趋势分析
```
第38周 vs 第30周 (2个月前)
发现: 某品类持续下滑,而非短期波动
决策: 考虑品类调整或引入新品
```

---

## ✅ 测试验证

### 测试用例1: 默认对比

```python
# 使用默认参数
result = engine.diagnose_sales_decline()

# 预期结果
assert '第38周销量' in result.columns  # 动态列名
assert '第37周销量' in result.columns
assert '第38周预计收入' in result.columns  # 新增列
assert '第37周预计收入' in result.columns
```

### 测试用例2: 自定义周期

```python
# 第38周 vs 第35周
result = engine.diagnose_sales_decline(
    current_period_index=0,
    compare_period_index=3
)

# 预期结果
assert '第38周销量' in result.columns
assert '第35周销量' in result.columns  # 不是第37周
```

### 测试用例3: 收入数据缺失

```python
# 模拟数据中没有预计订单收入字段
test_data = order_data.drop(columns=['预计订单收入'])
engine = ProblemDiagnosticEngine(test_data)
result = engine.diagnose_sales_decline()

# 预期结果
revenue_cols = [col for col in result.columns if '预计收入' in col]
assert len(revenue_cols) == 0  # 不应该有收入列
```

### 测试用例4: 周期列表获取

```python
periods = engine.get_available_periods('week')

# 预期结果
assert len(periods) > 0
assert periods[0]['index'] == 0
assert '周' in periods[0]['label']
assert 'date_range' in periods[0]
```

---

## 🐛 已知问题与注意事项

### 1. ISO周数计算

**问题**: ISO 8601周数可能跨年(第1周可能在12月底)
```python
# 示例: 2025-12-29 是 2026年第1周
date = datetime(2025, 12, 29)
week = date.isocalendar()[1]  # week = 1
year = date.isocalendar()[0]  # year = 2026 (注意不是2025)
```

**解决方案**: 使用`isocalendar()[0]`获取ISO年份
```python
iso_year = end.isocalendar()[0]
week_num = end.isocalendar()[1]
label = f'第{week_num}周 ({iso_year}年)'  # 正确
```

### 2. 跨度过大的对比

**问题**: 如果对比周期跨度太大(如第38周 vs 第20周),业务意义可能不大

**建议**: 在UI中添加提示
```python
if abs(current_idx - compare_idx) > 4:
    st.warning("⚠️ 对比周期跨度较大,可能受季节性因素影响")
```

### 3. 数据量不足

**问题**: 如果某个周期没有数据,会导致对比无意义

**检查**: 添加数据验证
```python
if len(current_data) == 0:
    st.error(f"❌ {current_label} 无数据,请选择其他周期")
    return pd.DataFrame()

if len(previous_data) == 0:
    st.error(f"❌ {compare_label} 无数据,请选择其他周期")
    return pd.DataFrame()
```

---

## 📚 相关文档

1. **问题诊断列兼容性修复说明.md** - 可选列处理
2. **问题诊断字段显示修复说明.md** - 分类vs商品名称
3. **问题诊断商品级别分析修复说明.md** - 商品级别分组
4. **问题诊断数值格式化修复说明.md** - 数值格式优化
5. **本文档** - 周期对比与预计收入功能

---

## 🎓 总结

### 核心改进

1. ✅ **新增预计收入列**: 帮助识别高价值下滑商品,优化决策优先级
2. ✅ **灵活周期对比**: 支持任意周期选择,满足不同分析需求
3. ✅ **动态表头**: 清晰显示对比周期,避免混淆
4. ✅ **辅助方法**: `get_available_periods()`简化UI集成

### 技术亮点

- 基于索引的动态周期计算(支持任意跨度)
- 兼容两种收入字段名(`预计订单收入`/`预估订单收入`)
- 动态列名格式化(无论周期如何变化)
- ISO 8601周数标准(准确跨年处理)

### 业务价值

- 📊 更灵活的对比分析(验证营销、发现季节性)
- 💰 收入维度辅助决策(识别高价值商品)
- 🎯 精准的周期标注(避免误解)
- 🔄 向后兼容(默认行为不变)

---

**功能开发完成,请在Streamlit UI中集成周期选择器!** 🎉
