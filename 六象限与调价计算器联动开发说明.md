# 六象限与调价计算器联动功能 - 开发说明

> **开发时间**: 2025-12-10  
> **版本**: V3.0  
> **状态**: ✅ 阶段1和阶段2已完成

---

## 📋 功能概述

实现六象限分析与智能调价计算器的无缝联动，让用户在发现问题后能够快速采取行动。

### 核心价值

**发现问题 → 分析原因 → 采取行动** 的完整闭环

---

## 🎯 实施方案

### 方案A：从六象限跳转到调价计算器（主流程）

用户在六象限分析中发现问题，点击"调价"按钮，自动跳转到调价计算器并筛选该象限商品。

### 方案B：在调价计算器中选择象限（补充功能）

用户直接进入调价计算器，通过下拉框选择六象限商品。

---

## ✅ 已完成功能

### 阶段1：基础联动（2-3小时）

#### 1.1 六象限分布卡片添加"调价优化"按钮 ✅

**文件**: `O2O-Analysis/components/today_must_do/callbacks.py`  
**位置**: 第14376-14430行

**修改内容**:
- 在每个象限的进度条右侧添加"调价"按钮
- 按钮ID: `{'type': 'quadrant-to-pricing', 'quadrant': name}`
- 无商品时按钮禁用

**效果**:
```
🌟 明星商品: 218个 [━━━━━━━━━━] 25% [调价]
💎 潜力商品: 160个 [━━━━━━━━] 18% [调价]
⚡ 自然引流: 120个 [━━━━━] 14% [调价]
```

#### 1.2 添加数据存储组件 ✅

**文件**: `O2O-Analysis/智能门店看板_Dash版.py`  
**位置**: 第5670-5673行

**新增组件**:
```python
# 六象限与调价计算器联动数据存储（V3.0新增）
dcc.Store(id='pricing-quadrant-filter', data=None),  # 象限筛选数据
dcc.Store(id='pricing-source-context', data=None),  # 来源上下文信息
dcc.Store(id='product-scores-store', data=None),  # 六象限商品评分数据
```

#### 1.3 实现跳转回调函数 ✅

**文件**: `O2O-Analysis/components/today_must_do/callbacks.py`  
**位置**: 第18876-19000行（文件末尾）

**新增回调**:
1. `jump_to_pricing_from_quadrant()` - 从六象限跳转到调价计算器
2. `back_to_source()` - 返回商品健康分析

**功能**:
- 切换到调价计算器Tab
- 传递象限筛选数据（商品列表、数量）
- 传递来源上下文信息（来源模块、象限、门店、渠道）
- 保存六象限商品数据供后续使用

#### 1.4 调价计算器UI优化 ✅

**文件**: `O2O-Analysis/components/today_must_do/callbacks.py`  
**位置**: 第7507-7600行

**新增组件**:
1. **面包屑导航**: 显示来源信息和"返回"按钮
2. **六象限选择器**: 下拉框选择象限（方案B）
3. **快捷场景按钮**: 四大调价场景（亏损止血、利润修复、滞销清仓、促销引流）
4. **目标利润率输入**: 自动填充建议值
5. **调价结果表格**: 显示调价建议

---

### 阶段2：智能建议（4-5小时）

#### 2.1 根据象限自动匹配调价场景 ✅

**文件**: `O2O-Analysis/components/today_must_do/callbacks.py`  
**位置**: 第19050-19150行

**回调函数**: `show_source_context_and_suggestion()`

**象限与场景映射**:

| 六象限 | 调价场景 | 调价方向 | 目标利润率 |
|--------|---------|---------|-----------|
| 🌟 明星商品 | 利润修复 | 测试性提价 | 25% |
| 💎 潜力商品 | 促销引流 | 降价促销 | 15% |
| ⚡ 自然引流 | 利润修复 | 小幅提价 | 20% |
| 🐌 低效商品 | 滞销清仓 | 清仓降价 | 8% |
| 🔥 畅销商品 | 利润修复 | 谨慎提价 | 18% |
| 🎯 策略引流 | 亏损止血 | 监控效果 | 5% |

#### 2.2 智能建议卡片 ✅

**功能**:
- 根据象限自动生成调价建议
- 显示建议标题、描述、建议幅度
- 根据场景设置卡片颜色（成功/警告/危险）

**示例**:
```
💡 智能建议：降价促销
潜力商品利润好但销量低，建议降价促销提升销量。
建议降价幅度：5-15%，目标利润率：15%
```

#### 2.3 自动填充目标利润率 ✅

**功能**:
- 根据象限自动填充建议的目标利润率
- 用户可以手动调整

#### 2.4 方案B：下拉框选择象限 ✅

**文件**: `O2O-Analysis/components/today_must_do/callbacks.py`  
**位置**: 第19200-19350行

**新增回调**:
1. `toggle_quadrant_selector()` - 切换象限选择器显示/隐藏
2. `update_quadrant_dropdown_options()` - 更新下拉框选项（显示商品数量）
3. `filter_by_quadrant_dropdown()` - 根据选择的象限筛选商品

**功能**:
- 点击"选择象限"按钮显示下拉框
- 下拉框选项动态显示各象限商品数量
- 选择象限后自动筛选商品并提供智能建议

---

## 🎨 用户体验流程

### 流程1：从六象限跳转（主流程）

```
1. 用户在"商品健康分析"中查看六象限分布
   ↓
2. 发现问题：💎 潜力商品 160个
   ↓
3. 点击"调价"按钮
   ↓
4. 自动跳转到"智能调价计算器"
   ↓
5. 显示面包屑导航：来源：商品健康分析 > 💎 潜力商品 [← 返回]
   ↓
6. 显示智能建议：降价促销，建议降价幅度：5-15%
   ↓
7. 自动选择场景：促销引流
   ↓
8. 自动填充目标利润率：15%
   ↓
9. 点击"计算调价方案"
   ↓
10. 查看调价建议表格，导出Excel执行
```

### 流程2：在调价计算器中选择象限（补充流程）

```
1. 用户直接进入"智能调价计算器"
   ↓
2. 点击"选择象限"按钮
   ↓
3. 下拉框显示：
   - 🌟 明星商品 (218个)
   - 💎 潜力商品 (160个)
   - ⚡ 自然引流 (120个)
   - ...
   ↓
4. 选择"💎 潜力商品"
   ↓
5. 显示智能建议：降价促销
   ↓
6. 自动选择场景：促销引流
   ↓
7. 自动填充目标利润率：15%
   ↓
8. 点击"计算调价方案"
   ↓
9. 查看调价建议表格，导出Excel执行
```

---

## 🔧 技术实现细节

### 数据流转

```
六象限分析
  ↓ 计算商品评分
  product_scores DataFrame
  - 商品名称
  - 店内码
  - 象限分类
  - 利润率
  - 销量
  - 动销指数
  
  ↓ 点击"调价"按钮
  
  跳转回调函数
  ↓ 筛选该象限商品
  quadrant_products
  
  ↓ 传递数据
  
  调价计算器
  ↓ 接收数据
  - pricing-quadrant-filter: 象限筛选数据
  - pricing-source-context: 来源上下文
  - product-scores-store: 完整商品数据
  
  ↓ 显示智能建议
  
  智能建议回调函数
  ↓ 根据象限匹配策略
  - 调价场景
  - 建议标题
  - 建议描述
  - 目标利润率
  
  ↓ 用户点击"计算调价方案"
  
  调价计算回调函数
  ↓ 计算调价建议
  - 建议价格
  - 预估销量变化
  - 预估利润变化
```

### 关键回调函数

#### 1. jump_to_pricing_from_quadrant()

**触发**: 点击六象限"调价"按钮  
**输入**: 
- n_clicks: 按钮点击次数
- health_content: 商品健康分析内容
- selected_stores: 当前选择的门店
- channel: 当前选择的渠道

**输出**:
- active_tab: 'tab-pricing'（切换到调价计算器）
- quadrant_filter: 象限筛选数据
- source_context: 来源上下文信息
- product_scores: 完整商品评分数据

**逻辑**:
1. 获取点击的象限名称
2. 重新计算商品评分数据（确保最新）
3. 应用门店和渠道筛选
4. 筛选该象限的商品
5. 构建数据对象并返回

#### 2. show_source_context_and_suggestion()

**触发**: pricing-source-context数据更新  
**输入**: context（来源上下文信息）

**输出**:
- breadcrumb: 面包屑导航
- suggestion: 智能建议卡片
- scene: 调价场景
- target_margin: 目标利润率

**逻辑**:
1. 解析来源信息（模块、象限）
2. 根据象限查找对应策略
3. 生成面包屑导航（含返回按钮）
4. 生成智能建议卡片（含标题、描述）
5. 返回场景和目标利润率

#### 3. filter_by_quadrant_dropdown()

**触发**: 下拉框选择象限  
**输入**: 
- quadrant: 选择的象限
- product_scores: 完整商品评分数据

**输出**:
- quadrant_filter: 象限筛选数据
- suggestion: 智能建议卡片
- scene: 调价场景
- target_margin: 目标利润率

**逻辑**:
1. 从product_scores中筛选该象限商品
2. 构建象限筛选数据
3. 根据象限生成智能建议（复用逻辑）
4. 返回数据

---

## 📊 数据结构

### pricing-quadrant-filter

```python
{
    'quadrant': '💎 潜力商品',
    'products': [
        {
            '商品名称': '进口红酒',
            '店内码': 'SKU001',
            '象限分类': '💎 潜力商品',
            '利润率': 64.8,
            '销量': 5,
            '动销指数': 45.2,
            ...
        },
        ...
    ],
    'count': 160,
    'timestamp': '2025-12-10T10:30:00'
}
```

### pricing-source-context

```python
{
    'from': '商品健康分析',
    'quadrant': '💎 潜力商品',
    'stores': ['祥和路店'],
    'channel': '美团闪购',
    'timestamp': '2025-12-10T10:30:00'
}
```

### product-scores-store

```python
[
    {
        '商品名称': '进口红酒',
        '店内码': 'SKU001',
        '象限分类': '💎 潜力商品',
        '利润率': 64.8,
        '销量': 5,
        '动销指数': 45.2,
        '综合评分': 72.5,
        ...
    },
    ...
]
```

---

## 🎯 象限与调价策略映射表

| 六象限 | 业务特征 | 调价场景 | 调价方向 | 建议幅度 | 目标利润率 | 业务目标 |
|--------|---------|---------|---------|---------|-----------|---------|
| 🌟 明星商品 | 又赚钱又好卖 | 利润修复 | 测试性提价 | 3-8% | 25% | 评估价格弹性上限 |
| 💎 潜力商品 | 利润好销量低 | 促销引流 | 降价促销 | 5-15% | 15% | 提升销量 |
| ⚡ 自然引流 | 低利润高销量 | 利润修复 | 小幅提价 | 3-8% | 20% | 提升利润率 |
| 🐌 低效商品 | 既不赚钱也不好卖 | 滞销清仓 | 清仓降价 | 15-30% | 8% | 快速出清 |
| 🔥 畅销商品 | 刚需基础品 | 利润修复 | 谨慎提价 | 1-3% | 18% | 保持竞争力 |
| 🎯 策略引流 | 主动亏损引流 | 亏损止血 | 监控效果 | - | 5% | 控制成本 |

---

## 🐛 已知问题

### 问题1：潜力商品调价方向矛盾（已解决）

**问题描述**:
- 六象限建议：降价促销（提高销量）
- 调价计算器原逻辑：可提价

**解决方案**:
- 在智能建议中明确：潜力商品建议降价促销
- 自动选择"促销引流"场景
- 目标利润率设为15%（适合促销）

### 问题2：商品数据可能不是最新（已解决）

**问题描述**:
- 用户在六象限分析后，可能切换了门店或渠道
- 跳转到调价计算器时，数据可能不一致

**解决方案**:
- 在跳转回调中重新计算商品评分数据
- 应用当前的门店和渠道筛选
- 确保数据一致性

---

## 🚀 后续优化建议

### 短期优化（1-2周）

1. **效果预测优化**
   - 在智能建议中显示预估效果
   - 如：降价10%，预计销量+60%，利润-20%

2. **批量调价导入**
   - 支持从六象限批量选择商品
   - 一键导入到调价计算器

3. **调价历史记录**
   - 记录用户的调价决策
   - 用于弹性系数学习

### 中期优化（1-2月）

1. **A/B测试框架**
   - 验证调价效果
   - 优化策略

2. **个性化建议**
   - 根据门店特点调整建议
   - 学习用户历史决策

3. **竞品价格监控**
   - 考虑竞品价格因素
   - 优化定价策略

---

## 📝 测试清单

### 功能测试

- [ ] 点击六象限"调价"按钮，能否正常跳转
- [ ] 面包屑导航是否正确显示来源信息
- [ ] 智能建议是否根据象限正确匹配
- [ ] 调价场景是否自动选中
- [ ] 目标利润率是否自动填充
- [ ] 点击"返回"按钮，能否返回六象限分析
- [ ] 下拉框选择象限，能否正常筛选商品
- [ ] 下拉框选项是否显示商品数量

### 数据测试

- [ ] 筛选的商品数量是否与六象限一致
- [ ] 商品数据是否完整（名称、价格、成本等）
- [ ] 切换门店后，数据是否更新
- [ ] 切换渠道后，数据是否更新

### 边界测试

- [ ] 象限无商品时，"调价"按钮是否禁用
- [ ] 无全局数据时，是否正常处理
- [ ] 数据异常时，是否有错误提示

---

## 📚 相关文档

1. **智能调价计算器V3.0开发文档.md** - 调价计算器的完整技术文档
2. **六象限与智能调价联动方案评估.md** - 联动方案的评估报告
3. **六象限V7.3保守优化说明.md** - 六象限分类体系的优化说明

---

## 👥 开发团队

- **开发**: Kiro AI Assistant
- **需求**: 用户
- **时间**: 2025-12-10
- **版本**: V3.0

---

## 📞 联系方式

如有问题或建议，请在聊天中反馈。

---

**开发完成时间**: 2025-12-10  
**状态**: ✅ 阶段1和阶段2已完成  
**下一步**: 测试验证，收集用户反馈

