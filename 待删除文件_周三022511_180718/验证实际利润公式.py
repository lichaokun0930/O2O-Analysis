import pandas as pd
import numpy as np

# è¯»å–ç¥¥å’Œè·¯åº—æ•°æ®
file_path = r"å®é™…æ•°æ®\ç¥¥å’Œè·¯.xlsx"
df = pd.read_excel(file_path)

print("=" * 80)
print("éªŒè¯å®é™…åˆ©æ¶¦å…¬å¼å„å­—æ®µ")
print("=" * 80)

print(f"\nğŸ“Š åŸå§‹æ•°æ®: {len(df)}è¡Œ, {df['è®¢å•ID'].nunique()}ä¸ªè®¢å•")
print(f"åˆ—å: {list(df.columns)}")

# æ£€æŸ¥ä¼å®¢åè¿”å­—æ®µå(å¯èƒ½æœ‰ç©ºæ ¼)
ä¼å®¢å­—æ®µ = None
possible_cols = [col for col in df.columns if 'ä¼å®¢' in col and 'åè¿”' in col]
if possible_cols:
    ä¼å®¢å­—æ®µ = possible_cols[0]
    print(f"\nâœ… æ‰¾åˆ°ä¼å®¢åè¿”å­—æ®µ: '{ä¼å®¢å­—æ®µ}'")
else:
    print("\nâš ï¸ è­¦å‘Š: æ•°æ®ä¸­æ²¡æœ‰ä¼å®¢åè¿”å­—æ®µ")

# æŒ‰è®¢å•èšåˆ
agg_dict = {
    'åˆ©æ¶¦é¢': 'sum',           # å•†å“çº§,sum
    'å¹³å°æœåŠ¡è´¹': 'sum',        # å•†å“çº§,sum
    'ç‰©æµé…é€è´¹': 'first',      # è®¢å•çº§,first
    'æ¸ é“': 'first'
}

if ä¼å®¢å­—æ®µ:
    agg_dict[ä¼å®¢å­—æ®µ] = 'first'  # è®¢å•çº§,first

order_agg = df.groupby('è®¢å•ID').agg(agg_dict).reset_index()

print(f"\nğŸ“¦ èšåˆå: {len(order_agg)}ä¸ªè®¢å•")

# å‰”é™¤å¹³å°æœåŠ¡è´¹=0çš„è®¢å•
filtered = order_agg[order_agg['å¹³å°æœåŠ¡è´¹'] > 0].copy()
print(f"\nğŸ” å‰”é™¤å¹³å°æœåŠ¡è´¹=0å: {len(filtered)}ä¸ªè®¢å•")

# è®¡ç®—å„å­—æ®µæ€»å’Œ
print("\n" + "=" * 80)
print("å„å­—æ®µç»Ÿè®¡ (å‰”é™¤å¹³å°æœåŠ¡è´¹=0å)")
print("=" * 80)

åˆ©æ¶¦é¢_sum = filtered['åˆ©æ¶¦é¢'].sum()
ç‰©æµé…é€è´¹_sum = filtered['ç‰©æµé…é€è´¹'].sum()
å¹³å°æœåŠ¡è´¹_sum = filtered['å¹³å°æœåŠ¡è´¹'].sum()

print(f"\n1ï¸âƒ£ åˆ©æ¶¦é¢æ€»å’Œ: Â¥{åˆ©æ¶¦é¢_sum:,.2f}")
print(f"   - æ‚¨çš„æ•°æ®: Â¥55,921")
print(f"   - å·®å¼‚: Â¥{åˆ©æ¶¦é¢_sum - 55921:,.2f}")

print(f"\n2ï¸âƒ£ ç‰©æµé…é€è´¹æ€»å’Œ: Â¥{ç‰©æµé…é€è´¹_sum:,.2f}")
print(f"   - æ‚¨çš„æ•°æ®: Â¥22,957")
print(f"   - å·®å¼‚: Â¥{ç‰©æµé…é€è´¹_sum - 22957:,.2f}")

print(f"\n3ï¸âƒ£ å¹³å°æœåŠ¡è´¹æ€»å’Œ: Â¥{å¹³å°æœåŠ¡è´¹_sum:,.2f}")
print(f"   - æ‚¨çš„æ•°æ®: Â¥9,160")
print(f"   - å·®å¼‚: Â¥{å¹³å°æœåŠ¡è´¹_sum - 9160:,.2f}")

# ä¼å®¢åè¿”
if ä¼å®¢å­—æ®µ and ä¼å®¢å­—æ®µ in filtered.columns:
    ä¼å®¢åå_sum = filtered[ä¼å®¢å­—æ®µ].sum()
    print(f"\n4ï¸âƒ£ ä¼å®¢ååæ€»å’Œ: Â¥{ä¼å®¢åå_sum:,.2f}")
    print(f"   å­—æ®µå: '{ä¼å®¢å­—æ®µ}'")
else:
    ä¼å®¢åå_sum = 0
    print(f"\n4ï¸âƒ£ ä¼å®¢åå: å­—æ®µä¸å­˜åœ¨,é»˜è®¤ä¸ºÂ¥0.00")

# æŒ‰å…¬å¼è®¡ç®—å®é™…åˆ©æ¶¦
print("\n" + "=" * 80)
print("å®é™…åˆ©æ¶¦è®¡ç®—")
print("=" * 80)
print(f"\nå…¬å¼: å®é™…åˆ©æ¶¦ = åˆ©æ¶¦é¢ - ç‰©æµé…é€è´¹ - å¹³å°æœåŠ¡è´¹ + ä¼å®¢åå")
print(f"\nè®¡ç®—:")
print(f"  åˆ©æ¶¦é¢:        Â¥{åˆ©æ¶¦é¢_sum:>12,.2f}")
print(f"- ç‰©æµé…é€è´¹:    Â¥{ç‰©æµé…é€è´¹_sum:>12,.2f}")
print(f"- å¹³å°æœåŠ¡è´¹:    Â¥{å¹³å°æœåŠ¡è´¹_sum:>12,.2f}")
print(f"+ ä¼å®¢åå:      Â¥{ä¼å®¢åå_sum:>12,.2f}")
print(f"{'='*40}")

å®é™…åˆ©æ¶¦ = åˆ©æ¶¦é¢_sum - ç‰©æµé…é€è´¹_sum - å¹³å°æœåŠ¡è´¹_sum + ä¼å®¢åå_sum
print(f"= å®é™…åˆ©æ¶¦:      Â¥{å®é™…åˆ©æ¶¦:>12,.2f}")
print(f"\næ‚¨çš„æ•°æ®:        Â¥23,332.00")
print(f"å·®å¼‚:            Â¥{å®é™…åˆ©æ¶¦ - 23332:>12,.2f}")

# è¯¦ç»†æ£€æŸ¥ç‰©æµé…é€è´¹å’Œå¹³å°æœåŠ¡è´¹
print("\n" + "=" * 80)
print("è¯¦ç»†å­—æ®µæ£€æŸ¥")
print("=" * 80)

print("\nğŸ” ç‰©æµé…é€è´¹åˆ†å¸ƒ:")
print(filtered['ç‰©æµé…é€è´¹'].describe())
print(f"\néé›¶å€¼æ•°é‡: {(filtered['ç‰©æµé…é€è´¹'] > 0).sum()}/{len(filtered)}")
print(f"é›¶å€¼æ•°é‡: {(filtered['ç‰©æµé…é€è´¹'] == 0).sum()}/{len(filtered)}")

print("\nğŸ” å¹³å°æœåŠ¡è´¹åˆ†å¸ƒ:")
print(filtered['å¹³å°æœåŠ¡è´¹'].describe())
print(f"\néé›¶å€¼æ•°é‡: {(filtered['å¹³å°æœåŠ¡è´¹'] > 0).sum()}/{len(filtered)}")
print(f"é›¶å€¼æ•°é‡: {(filtered['å¹³å°æœåŠ¡è´¹'] == 0).sum()}/{len(filtered)}")

# åˆ†æ¸ é“ç»Ÿè®¡
print("\n" + "=" * 80)
print("åˆ†æ¸ é“å­—æ®µç»Ÿè®¡")
print("=" * 80)

for channel in filtered['æ¸ é“'].unique():
    channel_data = filtered[filtered['æ¸ é“'] == channel]
    åˆ©æ¶¦ = channel_data['åˆ©æ¶¦é¢'].sum()
    é…é€è´¹ = channel_data['ç‰©æµé…é€è´¹'].sum()
    æœåŠ¡è´¹ = channel_data['å¹³å°æœåŠ¡è´¹'].sum()
    ä¼å®¢ = channel_data[ä¼å®¢å­—æ®µ].sum() if ä¼å®¢å­—æ®µ and ä¼å®¢å­—æ®µ in channel_data.columns else 0
    å®é™… = åˆ©æ¶¦ - é…é€è´¹ - æœåŠ¡è´¹ + ä¼å®¢
    
    print(f"\n{channel}:")
    print(f"  è®¢å•æ•°: {len(channel_data)}")
    print(f"  åˆ©æ¶¦é¢: Â¥{åˆ©æ¶¦:,.2f}")
    print(f"  ç‰©æµé…é€è´¹: Â¥{é…é€è´¹:,.2f}")
    print(f"  å¹³å°æœåŠ¡è´¹: Â¥{æœåŠ¡è´¹:,.2f}")
    print(f"  ä¼å®¢åå: Â¥{ä¼å®¢:,.2f}")
    print(f"  å®é™…åˆ©æ¶¦: Â¥{å®é™…:,.2f}")

print("\n" + "=" * 80)
