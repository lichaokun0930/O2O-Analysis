# 周转率计算问题分析报告

## 问题发现时间
2024年（根据context）

## 问题描述

### 当前的周转率计算逻辑
```python
# 库存聚合方式
agg_dict[stock_field] = 'last'  # 取最后一条记录的库存

# 周转率计算
product_data['库存周转率'] = product_data['销量'] / product_data['库存']
```

### 数据特征
- **原始数据**：订单维度的数据（每一行是一个订单中的一个商品）
- **时间跨度**：通常是30天的订单数据
- **库存字段**：每条订单记录中都有当时的库存快照

### 问题分析

#### 问题1：库存取值不合理

**当前做法**：`agg_dict[stock_field] = 'last'`（取最后一条记录的库存）

**问题**：
1. **时间顺序不确定**：订单数据可能不是按时间排序的，`last`取的可能不是最新的库存
2. **库存波动被忽略**：30天内库存可能多次补货，只取最后一次不能反映真实情况
3. **逻辑不一致**：销量是30天累计，库存是某一时刻的快照，两者不匹配

**举例**：
```
商品A在30天内的订单记录：
日期    销量  库存快照
1号     5件   100件
5号     3件   95件
10号    8件   200件（补货了）
15号    4件   192件
20号    6件   50件（快卖完了）
25号    2件   150件（又补货了）
30号    7件   143件

当前计算：
- 销量 = 5+3+8+4+6+2+7 = 35件
- 库存 = 143件（last，取30号的）
- 周转率 = 35/143 = 0.24次

问题：
- 如果订单数据没排序，last可能取到其他日期的库存
- 库存在30天内波动很大（50-200件），取某一时刻不合理
```

#### 问题2：周转率定义不适用于订单数据

**传统周转率定义**：
```
库存周转率 = 销售成本 / 平均库存
或
库存周转率 = 销量 / 平均库存

适用场景：有完整的库存台账数据（每天的库存记录）
```

**当前数据情况**：
- 只有订单发生时的库存快照
- 没有每天的库存记录
- 无法计算"平均库存"

#### 问题3：周转率在动销指数中的权重

**当前动销指数**：
```
动销指数 = 标准化销量×50% + 标准化周转率×30% + 标准化订单数×20%
```

**问题**：
- 周转率占30%权重，但计算不准确
- 可能导致动销指数失真

---

## 解决方案

### 方案1：移除周转率，调整权重（推荐）

**理由**：
- 订单数据无法准确计算周转率
- 销量和订单数已经能很好地反映动销情况

**调整后的动销指数**：
```
动销指数 = 标准化销量×60% + 标准化订单数×40%
```

**优点**：
- 逻辑清晰，不依赖不准确的库存数据
- 销量反映总体规模，订单数反映购买频次
- 两者结合已经能很好地评估动销

**缺点**：
- 失去了"相对于库存，卖得快不快"的维度

---

### 方案2：使用期末库存（次优）

**做法**：
```python
# 按日期排序后取最后一条
df_copy = df_copy.sort_values('日期')
agg_dict[stock_field] = 'last'
```

**周转率含义**：
```
周转率 = 30天销量 / 期末库存
含义：如果按当前销售速度，期末库存能卖多久
```

**优点**：
- 有一定参考价值
- 实现简单

**缺点**：
- 仍然不是传统意义的周转率
- 如果期末刚好补货或缺货，数据会失真

---

### 方案3：计算平均库存（理想但复杂）

**做法**：
```python
# 1. 按商品+日期聚合，得到每天的销量和库存
daily_data = df.groupby(['商品名称', '日期']).agg({
    '销量': 'sum',
    '库存': 'last'  # 每天最后一次的库存
}).reset_index()

# 2. 计算平均库存
avg_stock = daily_data.groupby('商品名称')['库存'].mean()

# 3. 计算周转率
turnover = total_sales / avg_stock
```

**优点**：
- 更接近传统周转率定义
- 考虑了库存波动

**缺点**：
- 实现复杂
- 如果某些天没有订单，库存数据缺失
- 计算量大

---

## 建议

### 立即行动（推荐方案1）

1. **移除周转率**，调整动销指数公式：
   ```python
   动销指数 = 标准化销量×60% + 标准化订单数×40%
   ```

2. **更新操作指南**：
   - 删除周转率的解释
   - 更新动销指数公式

3. **理由**：
   - 当前周转率计算不准确，可能误导决策
   - 销量+订单数已经足够评估动销
   - 简化逻辑，提高可靠性

### 如果需要保留周转率（方案2）

1. **修复计算逻辑**：
   ```python
   # 按日期排序后取最后一条
   df_copy = df_copy.sort_values('日期')
   agg_dict[stock_field] = 'last'
   ```

2. **更新定义说明**：
   ```
   周转率 = 30天销量 / 期末库存
   含义：按当前销售速度，期末库存能卖多久
   ```

3. **在操作指南中说明局限性**

---

## 影响评估

### 如果采用方案1（移除周转率）

**影响范围**：
- 动销指数计算公式
- 六象限分类（依赖动销指数）
- 操作指南中的说明

**影响程度**：
- 动销指数的值会变化，但相对排序基本不变
- 六象限分类可能有小幅调整（5-10%商品）
- 需要更新操作指南

**风险**：
- 低风险，因为销量和订单数已经能很好地反映动销

### 如果采用方案2（修复周转率）

**影响范围**：
- 周转率计算逻辑
- 操作指南中的说明

**影响程度**：
- 周转率的值会变化
- 动销指数会有一定变化
- 六象限分类可能有小幅调整

**风险**：
- 中等风险，因为期末库存可能不稳定

---

## 结论

**推荐采用方案1：移除周转率，简化动销指数**

理由：
1. 当前周转率计算不准确，可能误导决策
2. 订单数据无法准确计算传统意义的周转率
3. 销量+订单数已经足够评估动销情况
4. 简化逻辑，提高系统可靠性

**你的意见？**
