---
inclusion: fileMatch
fileMatchPattern: "**/全看板性能优化实施.py,**/修复预聚合表.py,**/aggregation_service.py,**/企业级性能优化实施.py"
---

# ⚠️ 预聚合表修改提醒

你正在修改预聚合表相关文件，**修改后必须运行验证脚本**！

## 强制验证命令

```bash
cd 订单数据看板/订单数据看板/O2O-Analysis
python 验证预聚合表一致性.py
```

## 修改前检查清单

- [ ] **渠道过滤**：剔除收费渠道且平台服务费=0的异常订单
- [ ] **利润公式**：`利润额 - 平台服务费 - 物流配送费 + 企客后返`
- [ ] **字段聚合**：商品级字段用SUM，订单级字段用FIRST/MAX
- [ ] **动销商品数**：从原始订单表查询，跨日期去重
- [ ] **GMV**：剔除商品原价<=0的行，不受渠道过滤影响
- [ ] **营销成本**：7字段（不含配送费减免），不受渠道过滤影响

## 核心公式参考

```python
# 收费渠道列表
PLATFORM_FEE_CHANNELS = ['饿了么', '京东到家', '美团共橙', '美团闪购', '抖音', '抖音直播', '淘鲜达', '京东秒送', '美团咖啡店', '饿了么咖啡店']

# 渠道过滤规则
异常订单 = 收费渠道 且 平台服务费 <= 0
有效订单 = 全部订单 - 异常订单

# 订单实际利润
订单实际利润 = 利润额 - 平台服务费 - 物流配送费 + 企客后返

# GMV（不受渠道过滤影响）
GMV = Σ(商品原价 × 销量) + Σ(打包袋金额) + Σ(用户支付配送费)
# 前提：剔除商品原价 <= 0 的行

# 营销成本（7字段，不受渠道过滤影响）
营销成本 = 满减金额 + 商品减免金额 + 商家代金券 + 商家承担部分券 + 满赠金额 + 商家其他优惠 + 新客减免金额
```

## 历史教训（2026-01-19）

预聚合表生成逻辑与原始计算不一致导致：
- 订单数多120单
- 利润差22000元
- 动销商品数重复计算

**验证失败 = 禁止部署**
