# 诊断工具使用指南

## 📋 工具概览

项目提供了3个诊断工具，分别用于不同场景：

| 工具 | 类型 | 使用场景 | 运行方式 |
|------|------|----------|----------|
| `启动自检.py` | **自动** | 看板启动时 | 自动运行 |
| `诊断今日必做性能.py` | 手动 | 今日必做Tab慢 | 手动运行 |
| `通用模块诊断工具.py` | 手动 | 开发调试 | 手动运行 |

### 🚀 快捷启动方式

**最简单的方式**：双击运行
```
运行诊断工具.bat  （推荐，双击即可）
运行诊断工具.ps1  （PowerShell版本）
```

会显示菜单让你选择要运行的诊断工具。

---

## 1️⃣ 启动自检.py（自动）⭐

### 功能
在看板启动时**自动运行**，检查系统关键组件。

### 检查项目
- ✅ Python版本（关键）
- ✅ 必需包（关键）
- ✅ 数据库连接（关键）
- ⚠️ Redis缓存（非关键）
- ⚠️ 数据文件（非关键）
- ⚠️ 磁盘空间（非关键）
- ⚠️ 可用内存（非关键）

### 自动运行
```powershell
# 启动看板时自动运行
.\启动看板.ps1

# 输出示例：
# 🔍 运行系统自检...
# ✅ 系统自检通过
```

### 手动运行
```powershell
# 查看详细报告
python 启动自检.py

# 静默模式（只显示失败项）
python 启动自检.py --quiet
```

### 输出示例
```
================================================================================
 🔍 系统启动自检
================================================================================

[1/7] Python版本...
   ✅ Python版本正常（3.11.0）

[2/7] 必需包...
   ✅ 所有必需包已安装（6个）

[3/7] 数据库连接...
   ✅ 数据库连接正常（93,728条订单）

[4/7] Redis缓存...
   ✅ Redis缓存正常（17个键，命中率65%）

[5/7] 数据文件...
   ✅ 数据文件正常（3个文件）

[6/7] 磁盘空间...
   ✅ 磁盘空间充足（剩余50.2GB）

[7/7] 可用内存...
   ✅ 可用内存充足（剩余8.5GB）

================================================================================
 📊 自检总结
================================================================================

   通过: 7/7

   ✅ 所有检查通过，系统正常
================================================================================
```

### 失败处理
**关键检查失败**（Python版本、必需包、数据库）：
- ❌ 系统无法启动
- 💡 显示修复建议
- 需要修复后重试

**非关键检查失败**（Redis、数据文件等）：
- ⚠️ 系统可以启动但功能受限
- 💡 显示修复建议
- 可以继续使用

---

## 2️⃣ 诊断今日必做性能.py（手动）

### 功能
专门诊断**今日必做Tab性能问题**。

### 检查项目
1. Redis缓存状态
2. PostgreSQL数据库
3. 数据量统计
4. V8.6订单聚合优化
5. V8.8-V8.9优化
6. 性能建议

### 使用场景
- 今日必做Tab加载很慢（>10秒）
- 切换Tab后仍然很慢
- 怀疑缓存未生效

### 运行方式
```powershell
python 诊断今日必做性能.py
```

### 输出示例
```
================================================================================
今日必做Tab性能诊断
================================================================================

[1/6] 检查Redis缓存...
   ✅ Redis连接: 正常
   ✅ Redis缓存管理器: 已启用

[2/6] 检查PostgreSQL数据库...
   ✅ 数据库连接: 正常
   ✅ orders表索引数量: 32个

[3/6] 检查数据量...
   ✅ 订单总数: 93,728条

[4/6] 检查V8.6订单聚合优化...
   ✅ calculate_order_aggregation函数: 已导入

[5/6] 检查V8.8-V8.9优化...
   ✅ 防抖工具: 已导入
   ✅ 分页工具: 已导入

[6/6] 性能建议...
   ✅ 所有检查通过，系统配置正常

================================================================================
诊断完成
================================================================================
```

### 常见问题诊断

#### 问题1: Redis缓存管理器未启用
```
❌ Redis缓存管理器: 未启用

💡 建议:
   1. 确保Memurai服务正在运行
   2. 检查看板启动日志中的Redis初始化信息
   3. 运行: Get-Service Memurai | Start-Service
```

#### 问题2: 索引数量不足
```
⚠️  orders表索引数量: 15个（应该32个）

💡 建议:
   运行: python database/create_indexes.py
```

---

## 3️⃣ 通用模块诊断工具.py（手动）

### 功能
通用的模块诊断框架，可以检查任何模块的全局变量。

### 使用场景
- 开发新功能时检查模块初始化
- 调试全局变量问题
- 验证单例模式

### 基本用法
```powershell
# 检查Redis缓存管理器
python 通用模块诊断工具.py --example redis

# 检查数据库连接
python 通用模块诊断工具.py --example database

# 自定义检查
python 通用模块诊断工具.py --module redis_cache_manager --var REDIS_CACHE_MANAGER
```

### 输出示例
```
================================================================================
 模块诊断: redis_cache_manager.REDIS_CACHE_MANAGER
================================================================================

[1/4] 检查底层服务...
   ✅ 服务连接: 正常

[2/4] 检查模块导入...
   ✅ 模块导入: 成功

[3/4] 检查全局变量...
   ✅ REDIS_CACHE_MANAGER: 已初始化
   类型: RedisCacheManager
   ✅ 状态: 已启用

[4/4] 检查功能...
   ✅ 功能测试: 通过

📊 统计信息:
   enabled: True
   total_keys: 17
   used_memory_mb: 2.5
   hit_rate: 65.68

================================================================================
 诊断总结
================================================================================
✅ 所有检查通过，模块正常工作
================================================================================
```

### 高级用法（开发者）

#### 自定义诊断
```python
from 通用模块诊断工具 import ModuleDiagnostic

# 创建诊断工具
diagnostic = ModuleDiagnostic(
    module_name='my_module',
    global_var_name='MY_GLOBAL_VAR'
)

# 定义服务检查
def check_service():
    # 检查底层服务
    pass

# 定义功能测试
def test_functionality(global_var):
    # 测试功能
    pass

# 运行诊断
success = diagnostic.run(
    service_check=check_service,
    functionality_test=test_functionality
)
```

---

## 🔧 故障排查流程

### 场景1: 看板启动失败

1. **查看启动自检输出**
   ```powershell
   python 启动自检.py
   ```

2. **根据失败项修复**
   - Python版本过低 → 升级Python
   - 缺少必需包 → `pip install -r requirements.txt`
   - 数据库连接失败 → `.\启动数据库.ps1`

3. **重新启动**
   ```powershell
   .\启动看板.ps1
   ```

### 场景2: 今日必做Tab很慢

1. **运行性能诊断**
   ```powershell
   python 诊断今日必做性能.py
   ```

2. **根据诊断结果修复**
   - Redis未启用 → `Get-Service Memurai | Start-Service`
   - 索引不足 → `python database/create_indexes.py`
   - 数据量过大 → 正常，首次加载需要时间

3. **验证修复效果**
   - 首次加载应该<5秒
   - 二次加载应该<1秒

### 场景3: 开发新功能时模块初始化问题

1. **使用通用诊断工具**
   ```powershell
   python 通用模块诊断工具.py --module my_module --var MY_VAR
   ```

2. **检查输出**
   - 模块导入失败 → 检查import路径
   - 全局变量未初始化 → 检查初始化时机
   - 功能测试失败 → 检查具体功能

3. **参考最佳实践**
   - 阅读`Python模块全局变量最佳实践.md`
   - 使用推荐的初始化方案

---

## 📊 工具对比

| 特性 | 启动自检 | 今日必做诊断 | 通用诊断工具 |
|------|----------|--------------|--------------|
| 运行方式 | 自动 | 手动 | 手动 |
| 检查范围 | 全系统 | 今日必做Tab | 自定义模块 |
| 详细程度 | 中等 | 详细 | 非常详细 |
| 适用场景 | 日常启动 | 性能问题 | 开发调试 |
| 修复建议 | ✅ | ✅ | ❌ |
| 功能测试 | ❌ | ❌ | ✅ |

---

## 💡 最佳实践

### 日常使用
1. ✅ 启动看板时关注自检输出
2. ✅ 如果自检失败，先修复再使用
3. ✅ 定期检查Redis缓存命中率

### 遇到问题时
1. ✅ 先运行对应的诊断工具
2. ✅ 根据修复建议操作
3. ✅ 验证修复效果
4. ✅ 如果问题依然存在，提供诊断输出

### 开发新功能时
1. ✅ 参考`Python模块全局变量最佳实践.md`
2. ✅ 使用通用诊断工具验证
3. ✅ 添加到启动自检（如果是关键功能）

---

## 📚 相关文档

- `Python模块全局变量最佳实践.md` - 避免初始化问题
- `V8.9_Redis缓存修复报告.md` - Redis问题案例
- `V8.9快速验证指南.md` - Redis修复验证

---

**创建时间**: 2025-12-11  
**适用版本**: V8.9+  
**维护者**: 系统管理员
