# V8.4 实际数据规模评估报告

## 📊 用户实际数据规模

### 当前数据

- **单次上传**: 30-50MB
- **行数**: 20,000-40,000行
- **平均**: 约30,000行/次

### 100家门店场景

- **每家门店**: 30,000行
- **总数据量**: 3,000,000行（300万行）
- **原始内存**: 875MB

---

## 💾 内存使用评估

### V8.4分层缓存内存占用

```
Level 1 (原始数据 - 压缩后):
├─ 原始: 875MB
├─ 压缩率: 36.3%
└─ 压缩后: 318MB

Level 2 (聚合指标):
├─ 100家门店 × 30天
├─ 每个指标: ~20KB
└─ 总计: 60MB

Level 3 (诊断结果):
├─ 全局: 1个
├─ 单店: 100个
├─ 常用组合: 20个
├─ 每个: ~300KB
└─ 总计: 36MB

总计: 318 + 60 + 36 = 414MB
```

### 配置建议

| 配置 | 内存使用率 | 评估 | 推荐场景 |
|------|-----------|------|---------|
| 512MB | 80.9% | 🔴 接近上限 | 不推荐 |
| **1GB** | **40.4%** | **✅ 推荐** | **100家门店** |
| 2GB | 20.2% | ✅ 充裕 | 200+家门店 |

---

## 🎯 最终推荐配置

### 100家门店（你的场景）

```python
cache = HierarchicalCacheManager(
    host='localhost',
    port=6379,
    max_memory_mb=1024,      # 1GB内存
    enable_compression=True   # 必须启用压缩
)
```

**理由**:
- 内存使用率: 40.4%（健康范围）
- 预留空间: 610MB（应对数据增长）
- 性能稳定: 不会触发频繁淘汰

### Redis配置（Memurai）

```conf
# 在 Memurai 配置文件中设置
maxmemory 1gb
maxmemory-policy allkeys-lru
```

**配置位置**: 
- Windows: `C:\Program Files\Memurai\memurai.conf`
- 或通过 `redis-cli` 动态设置

---

## 📈 扩展能力评估

### 不同门店数的内存需求

| 门店数 | 数据量 | 原始内存 | 压缩后 | 总缓存 | 推荐配置 |
|-------|--------|---------|--------|--------|---------|
| 50家 | 150万行 | 438MB | 159MB | 207MB | 512MB |
| **100家** | **300万行** | **875MB** | **318MB** | **414MB** | **1GB** |
| 150家 | 450万行 | 1.3GB | 477MB | 621MB | 1GB |
| 200家 | 600万行 | 1.7GB | 636MB | 828MB | 2GB |

### 数据增长预测

假设每月新增10家门店：

| 月份 | 门店数 | 总缓存 | 配置 | 状态 |
|------|-------|--------|------|------|
| 当前 | 100家 | 414MB | 1GB | ✅ 健康 |
| +3个月 | 130家 | 538MB | 1GB | ✅ 健康 |
| +6个月 | 160家 | 662MB | 1GB | 🟡 注意 |
| +9个月 | 190家 | 786MB | 1GB | 🔴 接近上限 |
| +12个月 | 220家 | 910MB | 2GB | ✅ 升级后健康 |

**建议**: 当门店数达到150家时，升级到2GB配置

---

## ⚡ 性能预测

### 100家门店场景

#### 预热时间

```
阶段1: 全局数据
├─ 300万行数据
├─ 计算时间: ~10秒
└─ 缓存时间: ~2秒

阶段2: 热点门店（20家）
├─ 并行预热（5线程）
├─ 每家: ~3秒
└─ 总计: ~12秒

阶段3: 冷门店（20家）
├─ 串行预热
├─ 每家: ~3秒
└─ 总计: ~60秒

总预热时间: 10 + 12 + 60 = 82秒 ≈ 1.5分钟
```

#### 响应时间

| 场景 | 时间 | 说明 |
|------|------|------|
| 缓存命中 | <0.5秒 | 90%的请求 |
| 热点门店（首次） | 2-3秒 | 已预热 |
| 冷门店（首次） | 3-5秒 | 按需计算 |
| 门店组合 | 1-2秒 | Level 2重建 |

---

## 🔧 优化建议

### 1. Redis配置优化

```powershell
# 连接到Redis
redis-cli

# 设置内存限制
CONFIG SET maxmemory 1gb

# 设置淘汰策略
CONFIG SET maxmemory-policy allkeys-lru

# 持久化配置（保存到配置文件）
CONFIG REWRITE
```

### 2. 预热策略优化

针对100家门店，调整预热参数：

```python
# 在 background_tasks.py 中
# 热点门店数量（20%）
hot_count = max(20, total_stores // 5)

# 冷门店预热数量（限制30个）
cold_to_warmup = cold_stores[:30]
```

### 3. TTL优化

根据数据更新频率调整：

```python
# 如果数据每天更新一次
cache.cache_diagnosis(..., ttl=86400)  # 24小时

# 如果数据实时更新
cache.cache_diagnosis(..., ttl=3600)   # 1小时
```

---

## 🚨 监控告警

### 关键指标

```python
from hierarchical_cache_manager import get_hierarchical_cache

cache = get_hierarchical_cache()
stats = cache.get_stats()

# 1. 内存使用率告警
if stats['memory_usage_pct'] > 80:
    print("⚠️ 内存使用率过高，建议清理或升级")

# 2. 缓存命中率告警
if stats['hit_rate'] < 85:
    print("⚠️ 缓存命中率低，建议增加预热门店数")

# 3. 键数量告警
if stats['total_keys'] > 500:
    print("⚠️ 缓存键过多，建议减少TTL")
```

### 自动监控脚本

```python
# monitor_v84.py
import time
from hierarchical_cache_manager import get_hierarchical_cache

cache = get_hierarchical_cache()

while True:
    stats = cache.get_stats()
    
    print(f"\n[{time.strftime('%H:%M:%S')}] 缓存状态:")
    print(f"  内存: {stats['used_memory_mb']:.1f}MB / {stats['max_memory_mb']:.1f}MB ({stats['memory_usage_pct']:.1f}%)")
    print(f"  命中率: {stats['hit_rate']:.1f}%")
    print(f"  键数: {stats['total_keys']}")
    
    # 告警
    if stats['memory_usage_pct'] > 80:
        print("  ⚠️ 内存告警！")
    if stats['hit_rate'] < 85:
        print("  ⚠️ 命中率告警！")
    
    time.sleep(60)  # 每分钟检查一次
```

---

## 📋 实施清单

### 立即执行

- [x] 评估实际数据规模 ✅
- [x] 计算内存需求 ✅
- [x] 确定推荐配置 ✅
- [ ] 修改Redis配置为1GB
- [ ] 更新应用配置
- [ ] 测试验证

### 配置步骤

#### 步骤1: 修改Redis配置

```powershell
# 方法1: 通过redis-cli（临时）
redis-cli CONFIG SET maxmemory 1gb
redis-cli CONFIG SET maxmemory-policy allkeys-lru

# 方法2: 修改配置文件（永久）
# 编辑 C:\Program Files\Memurai\memurai.conf
# 添加或修改：
# maxmemory 1gb
# maxmemory-policy allkeys-lru
# 然后重启Memurai服务
```

#### 步骤2: 验证配置

```powershell
# 检查配置
redis-cli CONFIG GET maxmemory
redis-cli CONFIG GET maxmemory-policy

# 查看内存使用
redis-cli INFO memory
```

#### 步骤3: 测试缓存

```powershell
python 测试V8.4分层缓存.py
```

---

## 🎯 结论

### 配置确认

✅ **1GB配置完全支持100家门店**

- 内存使用率: 40.4%（健康）
- 预热时间: 1.5分钟（可接受）
- 响应速度: <0.5秒（优秀）
- 扩展空间: 可支持到150家门店

### 风险评估

| 风险 | 等级 | 缓解措施 |
|------|------|---------|
| 内存不足 | 🟢 低 | 1GB配置充裕 |
| 性能下降 | 🟢 低 | 压缩+分层优化 |
| 数据增长 | 🟡 中 | 监控+预警 |

### 下一步

1. **立即**: 修改Redis配置为1GB
2. **本周**: 集成到主应用并测试
3. **持续**: 监控内存使用率和命中率
4. **未来**: 当门店数达到150家时，升级到2GB

---

**评估日期**: 2025-12-11  
**数据规模**: 100家门店 × 30,000行  
**推荐配置**: 1GB内存  
**状态**: ✅ 配置充足，可以放心使用
