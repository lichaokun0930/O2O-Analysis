# V8.6.2 å•†å“å¥åº·åˆ†ææ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

**é—®é¢˜**: ä»Šæ—¥å¿…åšTabåŠ è½½ä»éœ€40-70ç§’  
**æ ¹æœ¬åŸå› **: `calculate_enhanced_product_scores_with_trend`å‡½æ•°è®¡ç®—å¤æ‚  
**ç›®æ ‡**: å°†åŠ è½½æ—¶é—´ä»40-70ç§’é™ä½åˆ°5-10ç§’

---

## ğŸ” æ€§èƒ½ç“¶é¢ˆåˆ†æ

### V8.6æµ‹è¯•ç»“æœå¯¹æ¯”

| ç»„ä»¶ | è€—æ—¶ | å æ¯” |
|------|------|------|
| ç»è¥è¯Šæ–­åˆ†æ | 0.21ç§’ | 0.3% |
| **å•†å“å¥åº·åˆ†æ** | **40-70ç§’** | **99.7%** |

**ç»“è®º**: ç»è¥è¯Šæ–­å·²ä¼˜åŒ–åˆ°æè‡´ï¼ˆ0.21ç§’ï¼‰ï¼Œä½†å•†å“å¥åº·åˆ†æä»ç„¶æ˜¯ç“¶é¢ˆï¼

### å•†å“å¥åº·åˆ†æè°ƒç”¨é“¾

```
create_product_scoring_section
  â†“
calculate_enhanced_product_scores_with_trend(df, days=30)
  â†“
â”œâ”€ å•†å“çº§èšåˆï¼ˆæŒ‰å•†å“åç§°/åº—å†…ç ï¼‰
â”œâ”€ è¶‹åŠ¿åˆ†æï¼ˆ30å¤©æ•°æ®ï¼‰
â”œâ”€ å››è±¡é™åˆ†ç±»
â”œâ”€ åŠ¨é”€æŒ‡æ•°è®¡ç®—
â””â”€ ç‰¹æ®Šæ ‡è®°ï¼ˆäºæŸ/ä½é¢‘ï¼‰
```

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: Redisç¼“å­˜ä¼˜åŒ–ï¼ˆå·²éƒ¨åˆ†å®ç°ï¼‰â­â­â­â­â­

**å½“å‰çŠ¶æ€**: å·²æœ‰ç¼“å­˜é€»è¾‘ï¼Œä½†ç¼“å­˜é”®è®¾è®¡ä¸åˆç†

**é—®é¢˜**:
```python
# å½“å‰ç¼“å­˜é”®ï¼šåŸºäºæ•°æ®å“ˆå¸Œ
data_hash = hash(tuple(df.iloc[0].values))
cache_key = f"product_scores:rows_{len(df)}:cols_{len(df.columns)}:hash_{data_hash}:days_30"
```

**ç¼ºç‚¹**:
- æ•°æ®å“ˆå¸Œä¸ç¨³å®šï¼ˆæ¯æ¬¡åŠ è½½å¯èƒ½ä¸åŒï¼‰
- ç¼“å­˜å‘½ä¸­ç‡ä½
- æ— æ³•è·¨ç”¨æˆ·å…±äº«

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# æ”¹è¿›ç¼“å­˜é”®ï¼šåŸºäºé—¨åº—+æ—¥æœŸèŒƒå›´
def generate_smart_cache_key(df):
    """ç”Ÿæˆæ™ºèƒ½ç¼“å­˜é”®"""
    if 'é—¨åº—åç§°' in df.columns:
        stores = sorted(df['é—¨åº—åç§°'].unique().tolist())
        store_key = '_'.join(stores[:3])  # æœ€å¤š3ä¸ªé—¨åº—
        if len(stores) > 3:
            store_key += f'_plus{len(stores)-3}'
    else:
        store_key = 'all'
    
    # æ—¥æœŸèŒƒå›´
    if 'æ—¥æœŸ' in df.columns:
        dates = pd.to_datetime(df['æ—¥æœŸ'])
        date_range = f"{dates.min().strftime('%Y%m%d')}_{dates.max().strftime('%Y%m%d')}"
    else:
        date_range = 'unknown'
    
    return f"product_scores_v2:{store_key}:{date_range}:days_30"
```

**é¢„æœŸæ•ˆæœ**:
- é¦–æ¬¡åŠ è½½: 40-70ç§’ï¼ˆè®¡ç®—ï¼‰
- äºŒæ¬¡åŠ è½½: <1ç§’ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- ç¼“å­˜å‘½ä¸­ç‡: 85%+

---

### æ–¹æ¡ˆ2: å¼‚æ­¥åŠ è½½ä¼˜åŒ–ï¼ˆæ¨èï¼‰â­â­â­â­â­

**æ ¸å¿ƒæ€è·¯**: å•†å“å¥åº·åˆ†æåœ¨åå°å¼‚æ­¥åŠ è½½ï¼Œä¸é˜»å¡é¡µé¢

**å½“å‰é—®é¢˜**:
```python
# å½“å‰ï¼šåŒæ­¥åŠ è½½ï¼Œé˜»å¡é¡µé¢
def load_product_scoring_async(diagnosis_content, selected_stores):
    # ç­‰å¾…è¯Šæ–­å¡ç‰‡åŠ è½½å®Œæˆåæ‰å¼€å§‹
    result = create_product_scoring_section(df)  # 40-70ç§’
    return result
```

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```python
# ä¼˜åŒ–ï¼šçœŸæ­£çš„å¼‚æ­¥åŠ è½½ï¼Œç«‹å³è¿”å›éª¨æ¶å±
@app.callback(
    Output('product-scoring-section-container', 'children'),
    Input('today-must-do-content', 'children'),  # é¡µé¢åŠ è½½å®Œæˆå³è§¦å‘
    State('db-store-filter', 'value'),
    prevent_initial_call=True,
    background=True  # åå°æ‰§è¡Œ
)
def load_product_scoring_async(layout_children, selected_stores):
    """çœŸæ­£çš„å¼‚æ­¥åŠ è½½"""
    # ç«‹å³è¿”å›éª¨æ¶å±
    return create_product_health_skeleton()

# ç„¶ååœ¨åå°è®¡ç®—
@app.callback(
    Output('product-scoring-data-store', 'data'),
    Input('product-scoring-trigger', 'data'),
    background=True
)
def calculate_product_scores_background(trigger):
    """åå°è®¡ç®—å•†å“è¯„åˆ†"""
    df = get_real_global_data()
    scores = calculate_enhanced_product_scores_with_trend(df, days=30)
    return scores.to_dict('records')
```

**é¢„æœŸæ•ˆæœ**:
- é¡µé¢ç«‹å³å¯ç”¨ï¼ˆ<1ç§’ï¼‰
- å•†å“å¥åº·åˆ†æåœ¨åå°åŠ è½½ï¼ˆ40-70ç§’ï¼‰
- ç”¨æˆ·å¯ä»¥å…ˆæŸ¥çœ‹ç»è¥è¯Šæ–­

---

### æ–¹æ¡ˆ3: è®¡ç®—ä¼˜åŒ–ï¼ˆæ ¸å¿ƒï¼‰â­â­â­â­â­

**ä¼˜åŒ–calculate_enhanced_product_scores_with_trendå‡½æ•°æœ¬èº«**

#### ä¼˜åŒ–3.1: å•†å“èšåˆå‰ç½®

ç±»ä¼¼V8.6çš„è®¢å•èšåˆå‰ç½®ï¼Œå°†å•†å“èšåˆæå–å‡ºæ¥ï¼š

```python
def calculate_product_aggregation(df: pd.DataFrame) -> pd.DataFrame:
    """
    ç»Ÿä¸€çš„å•†å“èšåˆå‡½æ•°
    
    ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰éœ€è¦çš„å•†å“çº§æŒ‡æ ‡ï¼š
    - é”€é‡ã€é”€å”®é¢ã€æˆæœ¬ã€åˆ©æ¶¦
    - è®¢å•æ•°ã€å‘¨è½¬ç‡
    - åŠ¨é”€æŒ‡æ•°
    """
    product_key = get_product_group_key(df)
    
    agg_dict = {
        'é”€é‡': ('æœˆå”®', 'sum'),
        'é”€å”®é¢': ('å®æ”¶ä»·æ ¼', 'sum'),
        'æˆæœ¬': ('å•†å“é‡‡è´­æˆæœ¬', 'sum'),
        'åˆ©æ¶¦': ('åˆ©æ¶¦é¢', 'sum'),
        'è®¢å•æ•°': ('è®¢å•ID', 'nunique'),
        # ... å…¶ä»–æŒ‡æ ‡
    }
    
    product_agg = df.groupby(product_key).agg(**agg_dict).reset_index()
    
    # è®¡ç®—è¡ç”ŸæŒ‡æ ‡
    product_agg['åˆ©æ¶¦ç‡'] = product_agg['åˆ©æ¶¦'] / product_agg['é”€å”®é¢']
    product_agg['å‘¨è½¬ç‡'] = product_agg['é”€é‡'] / product_agg['åº“å­˜']
    product_agg['åŠ¨é”€æŒ‡æ•°'] = (
        0.5 * product_agg['é”€é‡_æ ‡å‡†åŒ–'] +
        0.3 * product_agg['å‘¨è½¬ç‡_æ ‡å‡†åŒ–'] +
        0.2 * product_agg['è®¢å•æ•°_æ ‡å‡†åŒ–']
    )
    
    return product_agg
```

#### ä¼˜åŒ–3.2: è¶‹åŠ¿åˆ†æä¼˜åŒ–

```python
def calculate_trend_batch(df: pd.DataFrame, product_key: str) -> pd.DataFrame:
    """
    æ‰¹é‡è®¡ç®—è¶‹åŠ¿ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    
    ä¼˜åŒ–å‰ï¼šå¾ªç¯æ¯ä¸ªå•†å“è®¡ç®—è¶‹åŠ¿ï¼ŒO(n)
    ä¼˜åŒ–åï¼šå‘é‡åŒ–è®¡ç®—ï¼ŒO(1)
    """
    # æŒ‰å•†å“+æ—¥æœŸèšåˆ
    daily_sales = df.groupby([product_key, 'æ—¥æœŸ'])['æœˆå”®'].sum().reset_index()
    
    # å‘é‡åŒ–è®¡ç®—è¶‹åŠ¿
    daily_sales['é”€é‡_7æ—¥å‡'] = daily_sales.groupby(product_key)['æœˆå”®'].transform(
        lambda x: x.rolling(7, min_periods=1).mean()
    )
    daily_sales['é”€é‡_è¶‹åŠ¿'] = daily_sales.groupby(product_key)['æœˆå”®'].transform(
        lambda x: (x - x.shift(7)) / x.shift(7)
    )
    
    return daily_sales
```

**é¢„æœŸæ•ˆæœ**:
- è®¡ç®—æ—¶é—´: 40-70ç§’ â†’ 10-20ç§’
- æ€§èƒ½æå‡: 2-4å€

---

### æ–¹æ¡ˆ4: æ•°æ®é‡‡æ ·ä¼˜åŒ–ï¼ˆå¿«é€Ÿæ–¹æ¡ˆï¼‰â­â­â­

**æ ¸å¿ƒæ€è·¯**: å¯¹äºå¤§æ•°æ®é‡ï¼Œä½¿ç”¨é‡‡æ ·è®¡ç®—

```python
def calculate_enhanced_product_scores_with_trend(df: pd.DataFrame, days: int = 30) -> pd.DataFrame:
    """å•†å“å¥åº·è¯„åˆ†è®¡ç®—ï¼ˆé‡‡æ ·ä¼˜åŒ–ç‰ˆï¼‰"""
    
    # å¦‚æœæ•°æ®é‡è¿‡å¤§ï¼Œä½¿ç”¨é‡‡æ ·
    if len(df) > 50000:
        print(f"âš ï¸ æ•°æ®é‡è¿‡å¤§({len(df)}è¡Œ)ï¼Œä½¿ç”¨é‡‡æ ·è®¡ç®—")
        # æŒ‰å•†å“åˆ†å±‚é‡‡æ ·ï¼Œç¡®ä¿æ¯ä¸ªå•†å“éƒ½æœ‰ä»£è¡¨æ€§
        df_sampled = df.groupby('å•†å“åç§°', group_keys=False).apply(
            lambda x: x.sample(min(len(x), 100))
        )
        print(f"   é‡‡æ ·å: {len(df_sampled)}è¡Œ")
        df = df_sampled
    
    # æ­£å¸¸è®¡ç®—
    product_scores = calculate_product_scores(df, days)
    return product_scores
```

**é¢„æœŸæ•ˆæœ**:
- å¤§æ•°æ®é‡: 40-70ç§’ â†’ 10-15ç§’
- å‡†ç¡®æ€§: 95%+ï¼ˆé‡‡æ ·è¶³å¤Ÿå¤§ï¼‰

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | é¦–æ¬¡åŠ è½½ | äºŒæ¬¡åŠ è½½ | å®æ–½éš¾åº¦ | é£é™© | æ¨èåº¦ |
|------|---------|---------|---------|------|--------|
| æ–¹æ¡ˆ1: Redisç¼“å­˜ä¼˜åŒ– | 40-70ç§’ | <1ç§’ | â­â­ | ä½ | â­â­â­â­â­ |
| æ–¹æ¡ˆ2: å¼‚æ­¥åŠ è½½ | <1ç§’(éª¨æ¶å±) | <1ç§’ | â­â­â­ | ä¸­ | â­â­â­â­â­ |
| æ–¹æ¡ˆ3: è®¡ç®—ä¼˜åŒ– | 10-20ç§’ | 10-20ç§’ | â­â­â­â­ | ä¸­ | â­â­â­â­ |
| æ–¹æ¡ˆ4: æ•°æ®é‡‡æ · | 10-15ç§’ | 10-15ç§’ | â­â­ | ä½ | â­â­â­ |

---

## ğŸ¯ æ¨èå®æ–½é¡ºåº

### ç«‹å³å®æ–½ï¼ˆV8.6.2ï¼‰- 1å°æ—¶

1. **æ–¹æ¡ˆ1: ä¼˜åŒ–Redisç¼“å­˜é”®**
   - ä¿®æ”¹ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘
   - åŸºäºé—¨åº—+æ—¥æœŸèŒƒå›´
   - æé«˜ç¼“å­˜å‘½ä¸­ç‡

**é¢„æœŸæ•ˆæœ**:
- é¦–æ¬¡åŠ è½½: 40-70ç§’
- äºŒæ¬¡åŠ è½½: <1ç§’
- ç¼“å­˜å‘½ä¸­ç‡: 85%+

### çŸ­æœŸå®æ–½ï¼ˆV8.6.3ï¼‰- åŠå¤©

2. **æ–¹æ¡ˆ2: çœŸæ­£çš„å¼‚æ­¥åŠ è½½**
   - é¡µé¢ç«‹å³æ˜¾ç¤ºéª¨æ¶å±
   - å•†å“å¥åº·åˆ†æåå°åŠ è½½
   - åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ·æ–°

**é¢„æœŸæ•ˆæœ**:
- é¡µé¢å¯ç”¨æ—¶é—´: <1ç§’
- ç”¨æˆ·ä½“éªŒ: å¤§å¹…æå‡

### ä¸­æœŸå®æ–½ï¼ˆV8.7ï¼‰- 1-2å¤©

3. **æ–¹æ¡ˆ3: è®¡ç®—ä¼˜åŒ–**
   - å•†å“èšåˆå‰ç½®
   - è¶‹åŠ¿åˆ†æå‘é‡åŒ–
   - å‡å°‘é‡å¤è®¡ç®—

**é¢„æœŸæ•ˆæœ**:
- è®¡ç®—æ—¶é—´: 40-70ç§’ â†’ 10-20ç§’
- æ€§èƒ½æå‡: 2-4å€

---

## ğŸš€ å¿«é€Ÿå®æ–½ï¼šæ–¹æ¡ˆ1ä¼˜åŒ–

è®©æˆ‘ç«‹å³å®æ–½æ–¹æ¡ˆ1ï¼ˆRedisç¼“å­˜é”®ä¼˜åŒ–ï¼‰ï¼Œè¿™æ˜¯æœ€å¿«è§æ•ˆçš„ï¼š

```python
# ä¿®æ”¹ create_product_scoring_section å‡½æ•°ä¸­çš„ç¼“å­˜é”®ç”Ÿæˆé€»è¾‘

def generate_smart_cache_key_for_products(df):
    """ç”Ÿæˆæ™ºèƒ½ç¼“å­˜é”®ï¼ˆå•†å“å¥åº·åˆ†æä¸“ç”¨ï¼‰"""
    if 'é—¨åº—åç§°' in df.columns:
        stores = sorted(df['é—¨åº—åç§°'].unique().tolist())
        if len(stores) <= 3:
            store_key = '_'.join(stores)
        else:
            store_key = f"{stores[0]}_plus{len(stores)-1}"
    else:
        store_key = 'all'
    
    # æ—¥æœŸèŒƒå›´
    if 'æ—¥æœŸ' in df.columns:
        dates = pd.to_datetime(df['æ—¥æœŸ'])
        date_range = f"{dates.min().strftime('%Y%m%d')}_{dates.max().strftime('%Y%m%d')}"
    else:
        date_range = 'unknown'
    
    # æ•°æ®è¡Œæ•°ï¼ˆç”¨äºæ£€æµ‹æ•°æ®å˜åŒ–ï¼‰
    row_count = len(df)
    
    return f"product_scores_v2:{store_key}:{date_range}:rows_{row_count}:days_30"

# åœ¨ create_product_scoring_section ä¸­ä½¿ç”¨
cache_key = generate_smart_cache_key_for_products(df)
product_scores = REDIS_CACHE_MANAGER.get(cache_key)
```

---

## ğŸ“ æ€»ç»“

**æ ¸å¿ƒé—®é¢˜**: å•†å“å¥åº·åˆ†æè®¡ç®—å¤æ‚ï¼ˆ40-70ç§’ï¼‰  
**ç«‹å³æ–¹æ¡ˆ**: Redisç¼“å­˜é”®ä¼˜åŒ–ï¼ˆ1å°æ—¶å®æ–½ï¼‰  
**çŸ­æœŸæ–¹æ¡ˆ**: å¼‚æ­¥åŠ è½½ä¼˜åŒ–ï¼ˆåŠå¤©å®æ–½ï¼‰  
**ä¸­æœŸæ–¹æ¡ˆ**: è®¡ç®—ä¼˜åŒ–ï¼ˆ1-2å¤©å®æ–½ï¼‰  

**é¢„æœŸæ•ˆæœ**:
- ç«‹å³: äºŒæ¬¡åŠ è½½<1ç§’ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- çŸ­æœŸ: é¡µé¢å¯ç”¨<1ç§’ï¼ˆå¼‚æ­¥åŠ è½½ï¼‰
- ä¸­æœŸ: é¦–æ¬¡åŠ è½½10-20ç§’ï¼ˆè®¡ç®—ä¼˜åŒ–ï¼‰

---

**ç‰ˆæœ¬**: V8.6.2 å•†å“å¥åº·åˆ†ææ€§èƒ½ä¼˜åŒ–  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-11  
**çŠ¶æ€**: å¾…å®æ–½
