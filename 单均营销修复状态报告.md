# 单均营销修复状态报告

## 📋 问题描述

React版本的渠道对比API中，单均营销计算只包含3个营销字段，缺少5个字段，导致单均营销被严重低估约75%。

### 数据对比（惠宜选-泰州泰兴店，2026-01-12至2026-01-18）

| 渠道 | React版（修复前） | Dash版（正确） | 差异 |
|------|------------------|---------------|------|
| 饿了么 | ¥1.99 | ¥7.87 | -74.7% |
| 美团共橙 | ¥5.11 | ¥10.17 | -49.8% |

---

## ✅ 已完成的修复

### 1. 代码修改（已完成）

**文件**: `backend/app/api/v1/orders.py`  
**函数**: `calculate_channel_metrics` (第1407-1413行)

**修改内容**:
```python
# 修复前（只包含3个字段）
marketing_cost = (
    order_agg['满减金额'].fillna(0).sum() +
    order_agg['商品减免金额'].fillna(0).sum() +
    order_agg['新客减免金额'].fillna(0).sum()
)

# 修复后（包含完整的8个字段）
marketing_cost = 0
marketing_fields = ['配送费减免金额', '满减金额', '商品减免金额', '商家代金券', 
                   '商家承担部分券', '满赠金额', '商家其他优惠', '新客减免金额']
for field in marketing_fields:
    if field in order_agg.columns:
        marketing_cost += order_agg[field].fillna(0).sum()
```

**验证**: ✅ 代码已正确保存到文件

---

## ⚠️ 当前问题

### API仍返回旧数据

**测试结果** (2026-01-19):
```json
{
  "channel": "饿了么",
  "current": {
    "avg_marketing_per_order": 1.99  // ❌ 应该是 7.87
  }
},
{
  "channel": "美团共橙",
  "current": {
    "avg_marketing_per_order": 5.11  // ❌ 应该是 10.17
  }
}
```

**原因**: 后端服务未重启，仍在使用旧代码（Python模块已加载到内存）

---

## 🔧 需要执行的操作

### 步骤1: 重启后端服务

#### 方法A: 如果后端在终端运行
1. 找到运行后端的终端窗口
2. 按 `Ctrl+C` 停止服务
3. 重新启动:
   ```bash
   cd 订单数据看板/订单数据看板/O2O-Analysis
   .venv\Scripts\activate
   python backend/app/main.py
   ```

#### 方法B: 如果后端在后台运行
1. 查找进程:
   ```bash
   netstat -ano | findstr :8080
   ```
2. 停止进程（假设PID是21624）:
   ```bash
   taskkill /F /PID 21624
   ```
3. 重新启动:
   ```bash
   cd 订单数据看板/订单数据看板/O2O-Analysis
   .venv\Scripts\activate
   python backend/app/main.py
   ```

### 步骤2: 清除缓存

重启后端后，清除所有缓存:
```bash
cd 订单数据看板/订单数据看板/O2O-Analysis
python -c "import requests; requests.post('http://localhost:8080/api/v1/orders/clear-cache')"
```

### 步骤3: 验证修复

运行验证脚本:
```bash
cd 订单数据看板/订单数据看板/O2O-Analysis
python 验证单均营销修复.py
```

**预期结果**:
```
各渠道数据对比:
--------------------------------------------------------------------------------
渠道                          订单数         单均营销         单均配送
--------------------------------------------------------------------------------
饿了么                          1883             7.87             1.61
美团共橙                        1599            10.17             3.89
--------------------------------------------------------------------------------

🎉 所有测试通过！单均营销修复成功！
```

---

## 📊 8个营销字段说明

根据《权威业务逻辑与数据字典完整手册》，营销成本包含以下8个字段：

1. **配送费减免金额** - 平台补贴的配送费
2. **满减金额** - 满减活动优惠
3. **商品减免金额** - 商品折扣（虽然是商品折扣，但在数据中是订单级）
4. **商家代金券** - 商家发放的代金券
5. **商家承担部分券** - 商家承担的平台券
6. **满赠金额** - 满赠活动成本
7. **商家其他优惠** - 其他优惠活动
8. **新客减免金额** - 新客专享优惠

**注意**: 物流配送费不属于营销成本，属于配送成本。

---

## 🎯 修复影响范围

### 受影响的API
- ✅ `/api/v1/orders/channel-comparison` - 渠道环比对比（已修复代码）

### 不受影响的API
- `/api/v1/orders/overview` - 使用 `calculate_order_metrics`（已包含8个字段）
- `/api/v1/store-comparison/week-over-week` - 使用 `calculate_order_metrics`（已包含8个字段）

---

## 📝 后续建议

1. **统一计算逻辑**: 确保所有营销成本计算都使用相同的8个字段
2. **添加单元测试**: 为营销成本计算添加测试用例
3. **文档更新**: 在API文档中明确说明营销成本的计算方式
4. **监控告警**: 添加数据异常监控，当单均营销偏离历史均值时告警

---

## 📞 联系方式

如有问题，请联系开发团队。

**最后更新**: 2026-01-19
**状态**: 等待后端服务重启
