# 日历选择器功能测试指南

## ✅ 已完成的功能

### 1. 自动切换界面
- 当选择"📅 日度对比"时，周期选择器自动从下拉框切换为日历选择器
- 当选择"📅 周度对比"或"📅 月度对比"时，自动切换回下拉框

### 2. 日期范围验证
- 检测4个日期字段是否全部填写
- 未填写完整时显示提示：**"⚠️ 请选择完整的日期范围（当前周期和对比周期的开始/结束日期）"**

### 3. 自定义日期对比
- 支持灵活选择任意日期范围进行对比
- 例如：当前周期（9月2日-9月8日）vs 对比周期（9月9日-9月15日）

---

## 🧪 测试步骤

### 测试1: 界面切换功能

**操作**:
1. 打开智能门店看板
2. 切换到"📊 Tab-4: 问题诊断"
3. 在"对比维度"下拉框中选择不同选项

**预期结果**:
| 选择项 | 周期选择器类型 |
|--------|----------------|
| 📅 日度对比 | 日历选择器（DatePickerRange） |
| 📅 周度对比 | 下拉框（Dropdown） |
| 📅 月度对比 | 下拉框（Dropdown） |

---

### 测试2: 日期验证功能

**操作**:
1. 选择"📅 日度对比"
2. 只填写当前周期的开始日期，其他留空
3. 点击"🔍 开始诊断"

**预期结果**:
- 表格显示提示：**⚠️ 请选择完整的日期范围（当前周期和对比周期的开始/结束日期）**
- 不执行数据查询

---

### 测试3: 日期范围对比功能

**准备数据**: 确保数据中包含9月份的订单数据

**操作**:
```
1. 选择"📅 日度对比"
2. 当前周期开始日期: 2025-09-02
3. 当前周期结束日期: 2025-09-08
4. 对比周期开始日期: 2025-09-09
5. 对比周期结束日期: 2025-09-15
6. 销量变化阈值: -20%
7. 点击"🔍 开始诊断"
```

**预期结果**:
- 终端日志显示:
  ```
  日维度对比模式
     当前周期: 2025-09-02 至 2025-09-08
     对比周期: 2025-09-09 至 2025-09-15
  日维度对比模式（自定义日期范围）
     当前周期: 2025-09-02 ~ 2025-09-08
     对比周期: 2025-09-09 ~ 2025-09-15
     当前周期数据: XX 行
     对比周期数据: XX 行
     合并后: XX 个商品符合条件
  ```

- 表格显示:
  - 商品名称列
  - 当前周期销量（9月2-8日的总销量）
  - 对比周期销量（9月9-15日的总销量）
  - 销量变化
  - 变化幅度%

---

### 测试4: 场景和时段筛选

**操作**:
```
1. 选择"📅 日度对比"
2. 设置日期范围（如测试3）
3. 场景筛选: 选择"堂食"
4. 时段筛选: 选择"午市"
5. 点击"🔍 开始诊断"
```

**预期结果**:
- 只显示"堂食"场景 + "午市"时段的商品对比数据
- 其他场景/时段的商品被过滤

---

### 测试5: 不同日期范围长度

**操作**:
```
测试A: 7天 vs 7天
- 当前: 9月2日-9月8日
- 对比: 9月9日-9月15日

测试B: 3天 vs 3天
- 当前: 9月2日-9月4日
- 对比: 9月5日-9月7日

测试C: 14天 vs 14天
- 当前: 9月1日-9月14日
- 对比: 9月15日-9月28日
```

**预期结果**:
- 所有测试都能正常计算对比数据
- 销量统计准确（按日期范围聚合）

---

## 🔍 终端日志检查清单

成功运行时，应该看到以下日志：

```
日维度对比模式
   当前周期: 2025-09-02 至 2025-09-08
   对比周期: 2025-09-09 至 2025-09-15
🔍 点击次数: 1
日维度对比模式（自定义日期范围）
   当前周期: 2025-09-02 ~ 2025-09-08
   对比周期: 2025-09-09 ~ 2025-09-15
   使用日期字段: 日期
   当前周期数据: 150 行
   对比周期数据: 180 行
   合并后: 25 个商品符合条件
📊 诊断结果: 25 条记录
   字段: ['商品名称', '当前周期销量', '对比周期销量', '销量变化', '变化幅度%', ...]
   销量变化范围: [-50.00, -5.00]
🔧 开始补充'时段'和'场景'字段...
   ✅ 已添加'时段'字段
   ✅ 已添加'场景'字段
```

---

## ❌ 常见问题排查

### 问题1: 点击"开始诊断"后没有反应

**排查步骤**:
1. 检查是否选择了"📅 日度对比"
2. 检查4个日期字段是否全部填写
3. 查看浏览器控制台是否有JavaScript错误
4. 查看VS Code终端是否有Python报错

### 问题2: 表格显示"未找到日期字段"

**原因**: 数据中没有标准的日期字段

**解决方案**:
- 检查上传的数据文件是否包含"日期"、"下单时间"等字段
- 在代码中添加更多日期字段的匹配规则（第3180行附近）

### 问题3: 数据筛选后为空

**可能原因**:
1. 选择的日期范围内没有数据
2. 日期格式不匹配（例如数据是"2025/09/02"，但系统按"2025-09-02"筛选）

**解决方案**:
- 查看终端日志中的"当前周期数据: X 行"，如果是0说明没有匹配数据
- 检查原始数据的日期格式
- 尝试更宽的日期范围

### 问题4: 销量数据不准确

**排查步骤**:
1. 检查终端日志中的"使用日期字段"和"销量字段"
2. 确认数据中的销量字段名称（可能是"月售"、"销量"、"数量"等）
3. 检查聚合逻辑是否正确（SUM汇总）

---

## 📊 数据格式要求

为了确保日历选择器正常工作，上传的数据应该包含以下字段：

### 必需字段:
- **商品名称**: 用于分组聚合
- **日期字段**: "日期"、"下单时间"、"时间"等（任意一个）
- **销量字段**: "月售"、"销量"、"数量"等（任意一个）

### 可选字段:
- **场景**: 用于场景筛选（如"堂食"、"外卖"）
- **时段**: 用于时段筛选（如"午市"、"晚市"）

### 示例数据:
```
| 商品名称    | 日期       | 月售 | 场景 | 时段 |
|-------------|------------|------|------|------|
| 酸辣土豆丝  | 2025-09-02 | 15   | 堂食 | 午市 |
| 宫保鸡丁    | 2025-09-02 | 22   | 外卖 | 晚市 |
| 酸辣土豆丝  | 2025-09-03 | 18   | 堂食 | 午市 |
```

---

## 🎯 功能总结

| 功能 | 状态 | 说明 |
|------|------|------|
| 界面自动切换 | ✅ | 日度对比显示日历，周度/月度显示下拉框 |
| 日期范围验证 | ✅ | 4个日期字段必须全部填写 |
| 自定义日期对比 | ✅ | 支持任意日期范围对比 |
| 场景筛选 | ✅ | 支持按场景过滤数据 |
| 时段筛选 | ✅ | 支持按时段过滤数据 |
| 销量聚合 | ✅ | 按商品名称聚合日期范围内的销量 |
| 变化幅度计算 | ✅ | 自动计算销量变化和变化幅度% |
| 阈值筛选 | ✅ | 只显示变化幅度小于阈值的商品 |

---

## 🚀 开始测试

**步骤**:
1. 确保已安装所有依赖: `pip install -r requirements.txt`
2. 启动应用: `python 智能门店看板_Dash版.py` 或 `.\启动智能看板.ps1`
3. 浏览器打开: `http://127.0.0.1:8052`
4. 上传包含日期字段的订单数据
5. 按照上述测试步骤进行验证

**测试完成后，请反馈**:
- ✅ 哪些功能正常工作
- ❌ 哪些功能有问题
- 📝 是否有改进建议

---

**实现版本**: v2.5
**实现日期**: 2025-09-27
**功能状态**: 完全实现 ✅
