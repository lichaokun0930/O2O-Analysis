# æ—¥ç»´åº¦æ—¥å†é€‰æ‹©å™¨å®ç°è¯´æ˜

## ğŸ“‹ éœ€æ±‚

**ç”¨æˆ·éœ€æ±‚**: å°†æ—¥ç»´åº¦çš„å‘¨æœŸé€‰æ‹©ä»ä¸‹æ‹‰æ¡†æ”¹ä¸ºæ—¥å†é€‰æ‹©å™¨ï¼Œæ”¯æŒè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´å¯¹æ¯”ã€‚

**åœºæ™¯ç¤ºä¾‹**:
- å½“å‰å‘¨æœŸ: 2025-09-02 è‡³ 2025-09-08ï¼ˆ7å¤©ï¼‰
- å¯¹æ¯”å‘¨æœŸ: 2025-09-09 è‡³ 2025-09-15ï¼ˆ7å¤©ï¼‰

---

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. ç•Œé¢å±‚ä¿®æ”¹ï¼ˆâœ… å®Œæˆï¼‰

**æ–‡ä»¶**: `æ™ºèƒ½é—¨åº—çœ‹æ¿_Dashç‰ˆ.py` ç¬¬900-950è¡Œ

**ä¿®æ”¹å†…å®¹**:
1. å°†å½“å‰å‘¨æœŸå’Œå¯¹æ¯”å‘¨æœŸçš„å®¹å™¨æ”¹ä¸ºåŠ¨æ€IDï¼š
   - `current-period-container`
   - `compare-period-container`

2. æ·»åŠ æ–°çš„å›è°ƒå‡½æ•° `toggle_period_selector_style`ï¼ˆç¬¬2886-2945è¡Œï¼‰:
   - å½“`time_period == 'day'`æ—¶ï¼Œæ˜¾ç¤º`DatePickerRange`ï¼ˆæ—¥å†é€‰æ‹©å™¨ï¼‰
   - å½“`time_period == 'week/month'`æ—¶ï¼Œæ˜¾ç¤º`Dropdown`ï¼ˆä¸‹æ‹‰æ¡†ï¼‰

**æ—¥å†é€‰æ‹©å™¨ç»„ä»¶**:
```python
dcc.DatePickerRange(
    id='current-period-date-range',
    display_format='YYYY-MM-DD',
    start_date_placeholder_text="å¼€å§‹æ—¥æœŸ",
    end_date_placeholder_text="ç»“æŸæ—¥æœŸ"
)
```

---

### 2. å›è°ƒå‡½æ•°ä¿®æ”¹ï¼ˆâœ… å®Œæˆï¼‰

**æ–‡ä»¶**: `æ™ºèƒ½é—¨åº—çœ‹æ¿_Dashç‰ˆ.py` ç¬¬3076-3090è¡Œ

**æ·»åŠ çš„è¾“å…¥å‚æ•°**:
```python
State('current-period-date-range', 'start_date'),
State('current-period-date-range', 'end_date'),
State('compare-period-date-range', 'start_date'),
State('compare-period-date-range', 'end_date')
```

**å‡½æ•°ç­¾åæ›´æ–°**:
```python
def update_table(n_clicks, selected_scenes, selected_slots, sort_by, time_period, threshold, 
                 current_period_idx, compare_period_idx,
                 current_start_date, current_end_date,      # æ–°å¢
                 compare_start_date, compare_end_date):      # æ–°å¢
```

---

## ğŸ”§ éœ€è¦æ‰‹åŠ¨å®Œæˆçš„æ­¥éª¤

ç”±äºç¼–ç é—®é¢˜ï¼Œä»¥ä¸‹ä¿®æ”¹éœ€è¦æ‰‹åŠ¨åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­å®Œæˆï¼š

### æ­¥éª¤1: æ·»åŠ æ—¥æœŸéªŒè¯é€»è¾‘

**ä½ç½®**: ç¬¬3120è¡Œå·¦å³ï¼Œåœ¨`global DIAGNOSTIC_ENGINE, GLOBAL_DATA`ä¹‹åç«‹å³æ·»åŠ 

**ä»£ç **:
```python
# å¤„ç†æ—¥ç»´åº¦çš„æ—¥æœŸèŒƒå›´é€‰æ‹©
if time_period == 'day':
    print(f"ğŸ“… æ—¥ç»´åº¦å¯¹æ¯”æ¨¡å¼")
    print(f"   å½“å‰å‘¨æœŸ: {current_start_date} è‡³ {current_end_date}")
    print(f"   å¯¹æ¯”å‘¨æœŸ: {compare_start_date} è‡³ {compare_end_date}")
    
    # éªŒè¯æ—¥æœŸæ˜¯å¦å®Œæ•´
    if not all([current_start_date, current_end_date, compare_start_date, compare_end_date]):
        print("âš ï¸ æ—¥æœŸé€‰æ‹©ä¸å®Œæ•´")
        return (
            [], [],
            "0 ä¸ª", "0 å•", "Â¥0", "Â¥0",
            None,
            "âš ï¸ è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´ï¼ˆå½“å‰å‘¨æœŸå’Œå¯¹æ¯”å‘¨æœŸçš„å¼€å§‹/ç»“æŸæ—¥æœŸï¼‰",
            True
        )
    
    # è½¬æ¢æ—¥æœŸæ ¼å¼
    from datetime import datetime
    current_start = pd.to_datetime(current_start_date)
    current_end = pd.to_datetime(current_end_date)
    compare_start = pd.to_datetime(compare_start_date)
    compare_end = pd.to_datetime(compare_end_date)
    
    print(f"   è½¬æ¢åæ—¥æœŸ:")
    print(f"   å½“å‰: {current_start.date()} ~ {current_end.date()}")
    print(f"   å¯¹æ¯”: {compare_start.date()} ~ {compare_end.date()}")
```

### æ­¥éª¤2: ä¿®æ”¹è¯Šæ–­å¼•æ“è°ƒç”¨é€»è¾‘

**ä½ç½®**: ç¬¬3148è¡Œå·¦å³ï¼Œåœ¨`if time_period == 'all':`ä¹‹å‰æ·»åŠ æ—¥æœŸèŒƒå›´åˆ†æ”¯

**ä»£ç **:
```python
try:
    # æ ¹æ®å¯¹æ¯”å‘¨æœŸè°ƒç”¨è¯Šæ–­å¼•æ“
    if time_period == 'day':
        # æ—¥ç»´åº¦ï¼šä½¿ç”¨æ—¥æœŸèŒƒå›´è¿›è¡Œå¯¹æ¯”
        print(f"ğŸ“… æ—¥ç»´åº¦å¯¹æ¯”æ¨¡å¼ï¼ˆè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ï¼‰")
        
        # ç­›é€‰å½“å‰å‘¨æœŸæ•°æ®
        current_mask = (GLOBAL_DATA['æ—¥æœŸ'] >= current_start) & (GLOBAL_DATA['æ—¥æœŸ'] <= current_end)
        current_data = GLOBAL_DATA[current_mask].copy()
        
        # ç­›é€‰å¯¹æ¯”å‘¨æœŸæ•°æ®
        compare_mask = (GLOBAL_DATA['æ—¥æœŸ'] >= compare_start) & (GLOBAL_DATA['æ—¥æœŸ'] <= compare_end)
        compare_data = GLOBAL_DATA[compare_mask].copy()
        
        print(f"   å½“å‰å‘¨æœŸæ•°æ®: {len(current_data)} è¡Œ")
        print(f"   å¯¹æ¯”å‘¨æœŸæ•°æ®: {len(compare_data)} è¡Œ")
        
        # æŒ‰å•†å“èšåˆé”€é‡
        current_summary = current_data.groupby('å•†å“åç§°').agg({
            'æœˆå”®': 'sum'
        }).rename(columns={'æœˆå”®': 'å½“å‰å‘¨æœŸé”€é‡'})
        
        compare_summary = compare_data.groupby('å•†å“åç§°').agg({
            'æœˆå”®': 'sum'
        }).rename(columns={'æœˆå”®': 'å¯¹æ¯”å‘¨æœŸé”€é‡'})
        
        # åˆå¹¶æ•°æ®
        detail_result = current_summary.join(compare_summary, how='outer').fillna(0).reset_index()
        
        # è®¡ç®—å˜åŒ–
        detail_result['é”€é‡å˜åŒ–'] = detail_result['å½“å‰å‘¨æœŸé”€é‡'] - detail_result['å¯¹æ¯”å‘¨æœŸé”€é‡']
        detail_result['å˜åŒ–å¹…åº¦%'] = (detail_result['é”€é‡å˜åŒ–'] / detail_result['å¯¹æ¯”å‘¨æœŸé”€é‡'].replace(0, 1) * 100).round(2)
        
        # ç­›é€‰ä¸‹æ»‘å•†å“
        if threshold < 0:
            detail_result = detail_result[detail_result['å˜åŒ–å¹…åº¦%'] <= threshold].copy()
        
        print(f"   åˆå¹¶å: {len(detail_result)} ä¸ªå•†å“ç¬¦åˆæ¡ä»¶")
        
    elif time_period == 'all':
        # å…¨éƒ¨å•†å“æ¨¡å¼...
```

### æ­¥éª¤3: æ·»åŠ åœºæ™¯å’Œæ—¶æ®µå­—æ®µè¡¥å……

**ä½ç½®**: åœ¨ä¸Šè¿°ä»£ç å—ä¹‹åï¼Œä¸å…¶ä»–åˆ†æ”¯ä¿æŒä¸€è‡´

**ä»£ç **:
```python
# è¡¥å……åœºæ™¯å’Œæ—¶æ®µå­—æ®µ
if not detail_result.empty and 'å•†å“åç§°' in detail_result.columns:
    if 'æ—¶æ®µ' in GLOBAL_DATA.columns:
        product_slot_map = GLOBAL_DATA.groupby('å•†å“åç§°')['æ—¶æ®µ'].first().to_dict()
        detail_result['æ—¶æ®µ'] = detail_result['å•†å“åç§°'].map(product_slot_map)
    
    if 'åœºæ™¯' in GLOBAL_DATA.columns:
        product_scene_map = GLOBAL_DATA.groupby('å•†å“åç§°')['åœºæ™¯'].first().to_dict()
        detail_result['åœºæ™¯'] = detail_result['å•†å“åç§°'].map(product_scene_map)
```

---

## ğŸ¯ å®Œæ•´çš„æ—¥ç»´åº¦å¯¹æ¯”æµç¨‹

### ç”¨æˆ·æ“ä½œæµç¨‹:
1. é€‰æ‹©"ğŸ“… æ—¥åº¦å¯¹æ¯”"
2. ç•Œé¢è‡ªåŠ¨åˆ‡æ¢ä¸ºæ—¥å†é€‰æ‹©å™¨
3. é€‰æ‹©å½“å‰å‘¨æœŸæ—¥æœŸèŒƒå›´ï¼ˆä¾‹å¦‚: 9æœˆ2æ—¥ - 9æœˆ8æ—¥ï¼‰
4. é€‰æ‹©å¯¹æ¯”å‘¨æœŸæ—¥æœŸèŒƒå›´ï¼ˆä¾‹å¦‚: 9æœˆ9æ—¥ - 9æœˆ15æ—¥ï¼‰
5. ç‚¹å‡»"ğŸ” å¼€å§‹è¯Šæ–­"æŒ‰é’®
6. ç³»ç»Ÿè®¡ç®—ä¸¤ä¸ªæ—¥æœŸèŒƒå›´å†…çš„å•†å“é”€é‡å¯¹æ¯”

### æ•°æ®å¤„ç†é€»è¾‘:
```
å½“å‰å‘¨æœŸ (2025-09-02 ~ 2025-09-08):
â”œâ”€â”€ ç­›é€‰æ•°æ®: WHERE æ—¥æœŸ BETWEEN '2025-09-02' AND '2025-09-08'
â”œâ”€â”€ èšåˆ: GROUP BY å•†å“åç§°, SUM(æœˆå”®) AS å½“å‰å‘¨æœŸé”€é‡
â””â”€â”€ ç»“æœ: å•†å“A: 100å•, å•†å“B: 50å•...

å¯¹æ¯”å‘¨æœŸ (2025-09-09 ~ 2025-09-15):
â”œâ”€â”€ ç­›é€‰æ•°æ®: WHERE æ—¥æœŸ BETWEEN '2025-09-09' AND '2025-09-15'
â”œâ”€â”€ èšåˆ: GROUP BY å•†å“åç§°, SUM(æœˆå”®) AS å¯¹æ¯”å‘¨æœŸé”€é‡
â””â”€â”€ ç»“æœ: å•†å“A: 120å•, å•†å“B: 60å•...

åˆå¹¶å¯¹æ¯”:
â”œâ”€â”€ JOIN: ON å•†å“åç§°
â”œâ”€â”€ è®¡ç®—: é”€é‡å˜åŒ– = å½“å‰ - å¯¹æ¯”
â”œâ”€â”€ è®¡ç®—: å˜åŒ–å¹…åº¦% = (å˜åŒ– / å¯¹æ¯”) * 100
â””â”€â”€ ç­›é€‰: WHERE å˜åŒ–å¹…åº¦% <= é˜ˆå€¼
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®æ”¹å‰ï¼ˆä¸‹æ‹‰æ¡†ï¼‰:
```
å½“å‰å‘¨æœŸ: [ç¬¬40å‘¨ (09/23 - 09/29) â–¼]
å¯¹æ¯”å‘¨æœŸ: [ç¬¬39å‘¨ (09/16 - 09/22) â–¼]
```

### ä¿®æ”¹åï¼ˆæ—¥å†ï¼‰:
```
å½“å‰å‘¨æœŸï¼ˆæ—¥æœŸèŒƒå›´ï¼‰:
[2025-09-02 â–¼]  è‡³  [2025-09-08 â–¼]

å¯¹æ¯”å‘¨æœŸï¼ˆæ—¥æœŸèŒƒå›´ï¼‰:
[2025-09-09 â–¼]  è‡³  [2025-09-15 â–¼]
```

---

## âœ… éªŒè¯æ¸…å•

- [x] ç•Œé¢è‡ªåŠ¨åˆ‡æ¢ï¼ˆä¸‹æ‹‰æ¡† â†” æ—¥å†ï¼‰
- [x] æ—¥å†é€‰æ‹©å™¨æ˜¾ç¤ºæ­£å¸¸
- [ ] æ—¥æœŸèŒƒå›´éªŒè¯ï¼ˆéœ€æ‰‹åŠ¨å®Œæˆæ­¥éª¤1ï¼‰
- [ ] æ•°æ®ç­›é€‰é€»è¾‘ï¼ˆéœ€æ‰‹åŠ¨å®Œæˆæ­¥éª¤2ï¼‰
- [ ] é”€é‡èšåˆè®¡ç®—ï¼ˆéœ€æ‰‹åŠ¨å®Œæˆæ­¥éª¤2ï¼‰
- [ ] å­—æ®µè¡¥å……é€»è¾‘ï¼ˆéœ€æ‰‹åŠ¨å®Œæˆæ­¥éª¤3ï¼‰
- [ ] æµ‹è¯•ï¼šé€‰æ‹©9æœˆ2-8æ—¥ vs 9æœˆ9-15æ—¥
- [ ] æµ‹è¯•ï¼šæ—¥æœŸèŒƒå›´ä¸å®Œæ•´æ—¶çš„æç¤º

---

## ğŸ› å¯èƒ½çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: æ—¥æœŸå­—æ®µä¸å­˜åœ¨
**ç°è±¡**: æç¤º"æ•°æ®ä¸­ç¼ºå°‘'æ—¥æœŸ'å­—æ®µ"
**è§£å†³**: æ£€æŸ¥`GLOBAL_DATA`æ˜¯å¦æœ‰'æ—¥æœŸ'ã€'ä¸‹å•æ—¶é—´'ç­‰æ—¶é—´å­—æ®µ

### é—®é¢˜2: æ—¥æœŸæ ¼å¼ä¸åŒ¹é…
**ç°è±¡**: ç­›é€‰åæ•°æ®ä¸ºç©º
**è§£å†³**: ç¡®ä¿æ—¥æœŸå­—æ®µæ˜¯`datetime`ç±»å‹ï¼Œä½¿ç”¨`pd.to_datetime()`è½¬æ¢

### é—®é¢˜3: èšåˆå­—æ®µé”™è¯¯
**ç°è±¡**: KeyError: 'æœˆå”®'
**è§£å†³**: æ£€æŸ¥é”€é‡å­—æ®µåç§°ï¼ˆå¯èƒ½æ˜¯'é”€é‡'ã€'æœˆå”®'ã€'æ•°é‡'ç­‰ï¼‰

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **å¿«æ·æ—¥æœŸé€‰æ‹©**: æ·»åŠ å¿«æ·æŒ‰é’®ï¼ˆæœ¬å‘¨ã€ä¸Šå‘¨ã€æœ¬æœˆã€ä¸Šæœˆï¼‰
2. **æ—¥æœŸèŒƒå›´éªŒè¯**: æç¤ºä¸¤ä¸ªå‘¨æœŸçš„æ—¥æœŸèŒƒå›´åº”ç›¸åŒï¼ˆ7å¤© vs 7å¤©ï¼‰
3. **å¯è§†åŒ–å¯¹æ¯”**: åœ¨å›¾è¡¨ä¸­æ˜¾ç¤ºä¸¤ä¸ªæ—¥æœŸèŒƒå›´çš„æ ‡ç­¾
4. **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜å¸¸ç”¨æ—¥æœŸèŒƒå›´çš„è®¡ç®—ç»“æœ

---

**å®ç°çŠ¶æ€**: 70%å®Œæˆï¼ˆç•Œé¢âœ…ã€å›è°ƒâœ…ã€æ•°æ®å¤„ç†â³ï¼‰
**å‰©ä½™å·¥ä½œ**: æ‰‹åŠ¨å®Œæˆæ­¥éª¤1-3çš„ä»£ç æ’å…¥
**é¢„è®¡æ—¶é—´**: 5-10åˆ†é’Ÿ

**ä¸‹ä¸€æ­¥**: åœ¨VS Codeä¸­æ‰“å¼€æ–‡ä»¶ï¼ŒæŒ‰ç…§æ­¥éª¤1-3æ‰‹åŠ¨æ·»åŠ ä»£ç 
