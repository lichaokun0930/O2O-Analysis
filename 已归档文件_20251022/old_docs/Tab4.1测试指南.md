# Tab 4.1 销量下滑诊断 - 测试指南

## 📋 测试目标

验证Tab 4.1的以下方面：
1. ✅ 功能正常性 - 所有功能能正常运行
2. ✅ 计算准确性 - 数值与Tab 1/2保持一致
3. ✅ UI美观性 - 界面清晰、图表美观
4. ✅ 交互流畅性 - 操作响应及时

## 🌐 访问地址

打开浏览器访问: **http://localhost:8050**

## 📝 测试步骤

### 第一步：进入Tab 4.1

1. 在浏览器中打开系统
2. 点击顶部菜单的 **"🔍 问题诊断"** 标签
3. 在子标签中选择 **"📉 销量下滑诊断"**

**预期结果**: 页面加载成功，显示参数配置区域

---

### 第二步：基础功能测试

#### 测试2.1: 默认参数诊断

**操作**:
1. 保持默认参数不变:
   - 对比周期: 按周对比
   - 下滑阈值: -20%
   - 场景筛选: 空（全部）
   - 时段筛选: 空（全部）
   - 排序方式: 下滑幅度最大

2. 点击 **"🔍 开始诊断"** 按钮

**预期结果**:
- ✅ 页面显示Loading动画
- ✅ 3-5秒内加载完成
- ✅ 显示4个统计卡片（下滑商品数、总销量损失、总收入损失、总利润损失）
- ✅ 显示多个ECharts图表
- ✅ 底部显示数据表格
- ✅ 无报错信息

**检查要点**:
```
统计卡片示例:
📦 下滑商品数: XX 个
📉 总销量损失: XXX 单
💰 总收入损失: ¥XX,XXX
💸 总利润损失: ¥X,XXX
```

#### 测试2.2: 修改参数测试

**操作**:
1. 修改参数:
   - 对比周期: 按日对比
   - 下滑阈值: -30%
   
2. 点击 **"🔍 开始诊断"**

**预期结果**:
- ✅ 数据重新加载
- ✅ 下滑商品数量变少（因为阈值更严格）
- ✅ 图表内容更新
- ✅ 表格数据更新

---

### 第三步：可视化图表验证

#### 测试3.1: 核心指标可视化

**检查图表**:
1. ⏰ **分时段下滑分布**
   - 图表类型: 柱状图
   - X轴: 时段（早餐、午餐、下午茶、晚餐、夜宵）
   - Y轴: 下滑商品数量
   - 工具提示: 悬停显示详细数据

2. 🎭 **分场景下滑分布**
   - 图表类型: 柱状图
   - X轴: 场景类别
   - Y轴: 下滑商品数量

3. 💸 **收入损失TOP10**
   - 图表类型: 横向柱状图
   - 显示: TOP 10商品及其收入损失金额
   - 颜色: 红色系（表示损失）

**操作验证**:
- ✅ 鼠标悬停显示详细信息
- ✅ 可以导出为PNG图片（右上角工具栏）
- ✅ 图表可以缩放和平移
- ✅ 底部有业务洞察提示（蓝色Alert框）

#### 测试3.2: 周期销量对比

**检查图表**:
- 📊 **周期销量对比（TOP10商品）**
  - 图表类型: 分组柱状图
  - 显示: 当前周期（红色）vs 对比周期（蓝色）
  - X轴: 商品名称
  - Y轴: 销量

**验证要点**:
- ✅ 红色柱子明显短于蓝色柱子（表示下滑）
- ✅ 图例清晰标注
- ✅ 数值准确（与统计卡片一致）

---

### 第四步：高级分析验证

#### 测试4.1: 利润影响分析

**操作**:
1. 点击 **"高级分析"** 区域的 **"💰 利润影响分析"** 标签

**检查内容**:
1. **四维散点图**
   - X轴: 利润变化
   - Y轴: 商品实售价
   - 气泡大小: 销量变化
   - 颜色深度: 毛利率
   
2. **商品价格分布箱线图**
   - 显示各分类的价格分布
   - 识别异常值

**操作验证**:
- ✅ 散点图可交互（悬停查看详情）
- ✅ 箱线图正确显示四分位数
- ✅ 颜色梯度清晰可见

#### 测试4.2: 分类树状图

**操作**:
1. 点击 **"🌳 分类树状图"** 标签

**检查内容**:
- 📊 **三级分类收入损失树状图**
  - 层级结构: 一级分类 → 三级分类 → 商品
  - 方块面积: 收入损失绝对值（越大表示损失越多）
  - 颜色: 变化幅度（深红色=下滑严重）

**操作验证**:
- ✅ 可以点击方块深入查看下级分类
- ✅ 鼠标悬停显示详细数据
- ✅ 颜色区分清晰

#### 测试4.3: 时段×场景热力图

**操作**:
1. 点击 **"🔥 时段×场景热力图"** 标签

**检查内容**:
- 📊 **热力图矩阵**
  - X轴: 场景
  - Y轴: 时段
  - 颜色深度: 下滑商品数（深红色=问题严重）

- 📊 **交叉分析详细数据表**
  - 显示所有时段×场景组合的详细数据
  - 可排序、可筛选

**操作验证**:
- ✅ 热力图颜色渐变清晰
- ✅ 表格数据完整
- ✅ 可以进行排序和筛选

---

### 第五步：数据表格验证

#### 测试5.1: 表格显示

**检查内容**:
- 📋 **下滑商品明细表**
  - 显示字段: 商品名称、一级分类名、销量变化、变化幅度%、收入变化、商品实售价等
  - 数据格式: 
    - 金额: ¥XX.X
    - 百分比: XX.X%
    - 整数: XXX

**操作验证**:
- ✅ 表格可以排序（点击表头）
- ✅ 表格可以筛选（输入框）
- ✅ 表格可以翻页
- ✅ 数据格式统一（保留1位小数）

#### 测试5.2: 数据导出

**操作**:
1. 滚动到页面底部
2. 点击 **"⬇️ 导出CSV"** 按钮

**预期结果**:
- ✅ 自动下载CSV文件
- ✅ 文件名包含时间戳
- ✅ 用Excel打开后数据完整
- ✅ 格式正确（中文不乱码）

---

### 第六步：计算准确性验证

#### 测试6.1: 对比Tab 1数据

**操作**:
1. 打开Tab 1（运营概览）
2. 查看某个商品的销售数据
3. 回到Tab 4.1
4. 找到同一个商品

**验证要点**:
- ✅ 销量数据一致
- ✅ 收入数据一致（使用预计订单收入）
- ✅ 利润数据一致（收入-成本-配送费-佣金）
- ✅ 计算逻辑统一

#### 测试6.2: 手动验证计算

**选择一个商品进行手动计算**:

```
示例商品: "农夫山泉550ml"

当前周期数据:
- 销量: 50件
- 预计订单收入: ¥150.0 (50件 × ¥3.0)

对比周期数据:
- 销量: 80件  
- 预计订单收入: ¥240.0 (80件 × ¥3.0)

计算验证:
✅ 销量变化 = 50 - 80 = -30件
✅ 变化幅度% = -30 / 80 × 100% = -37.5%
✅ 收入变化 = ¥150.0 - ¥240.0 = -¥90.0
```

**验证方法**:
在表格中找到该商品，检查：
- ✅ 销量变化 = -30
- ✅ 变化幅度% = -37.5%
- ✅ 收入变化 = -¥90.0

---

### 第七步：边界情况测试

#### 测试7.1: 极端参数

**操作**:
1. 设置下滑阈值为 -80%（非常严格）
2. 点击诊断

**预期结果**:
- ✅ 下滑商品数很少或为0
- ✅ 显示友好提示: "未发现下滑商品" 或 "下滑商品数: 0 个"
- ✅ 图表显示为空状态
- ✅ 无报错

#### 测试7.2: 单一场景筛选

**操作**:
1. 场景筛选: 只选择"午餐"
2. 时段筛选: 只选择"午餐"
3. 点击诊断

**预期结果**:
- ✅ 只显示午餐场景的下滑商品
- ✅ 分场景图表只显示"午餐"
- ✅ 数据量减少（符合预期）

---

## ✅ 测试检查清单

### 功能测试
- [ ] 默认参数诊断功能正常
- [ ] 参数修改后能正确更新
- [ ] 场景/时段筛选有效
- [ ] 排序功能正常
- [ ] CSV导出功能正常

### 可视化测试
- [ ] 7个核心图表都能正常显示
- [ ] 图表交互功能（悬停、缩放）正常
- [ ] 高级分析3个标签页都能正常切换
- [ ] 图表配色美观统一
- [ ] 业务洞察提示显示正确

### 数据准确性
- [ ] 统计卡片数值正确
- [ ] 表格数据与图表一致
- [ ] 数值格式统一（1位小数）
- [ ] 与Tab 1/2数据一致
- [ ] 计算逻辑正确

### UI/UX测试
- [ ] 页面加载速度快（<5秒）
- [ ] 布局美观整洁
- [ ] 响应式设计正常
- [ ] 无错误提示
- [ ] Loading动画显示正常

### 边界测试
- [ ] 极端参数处理正常
- [ ] 空数据状态友好
- [ ] 大数据量加载正常
- [ ] 错误情况有提示

---

## 🐛 已知问题 & 解决方案

### 问题1: 格式化错误（已修复）
**现象**: ValueError: Unknown format code 'f' for object of type 'str'  
**原因**: 诊断引擎返回的数据已经格式化为字符串，但callback又尝试格式化  
**解决**: 修改callback函数，增加类型检查，跳过已格式化的字符串  
**状态**: ✅ 已修复

---

## 📊 测试报告模板

测试完成后，请记录以下信息：

```
Tab 4.1 测试报告
==================

测试时间: 2025-10-18
测试人员: [您的名字]
系统版本: Dash版

功能测试结果:
✅ 基础诊断功能: 通过/失败
✅ 参数筛选功能: 通过/失败  
✅ 数据导出功能: 通过/失败
✅ 图表交互功能: 通过/失败

数据准确性:
✅ 计算逻辑: 正确/错误
✅ 与Tab 1一致性: 一致/不一致
✅ 数值格式: 统一/不统一

UI/UX评估:
✅ 界面美观度: 优秀/良好/一般
✅ 响应速度: 快速/正常/缓慢
✅ 交互流畅度: 流畅/一般/卡顿

发现的问题:
1. [问题描述]
2. [问题描述]

改进建议:
1. [建议内容]
2. [建议内容]

总体评价: 优秀/良好/需改进

是否建议继续重构其他Tab: 是/否
```

---

## 🎯 下一步

测试完成后，请告知结果：
- ✅ **测试通过**: 可以继续重构Tab 4.2-4.6
- ⚠️ **发现问题**: 先修复问题再继续
- 🔄 **需要调整**: 根据反馈优化Tab 4.1

---

**文档版本**: v1.0  
**创建时间**: 2025-10-18  
**作者**: AI Assistant
