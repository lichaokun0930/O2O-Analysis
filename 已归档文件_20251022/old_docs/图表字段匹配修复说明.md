# 📊 图表字段匹配修复说明

## 🔍 问题诊断

### 问题现象
用户反馈：点击"开始诊断"后，三个对比图表（分时段、分场景、收入TOP10）显示空白，没有任何数据展示。

### 根本原因

通过查看 `callback_debug.txt` 日志发现：

```python
'时段' in columns: True
'当前周期销量' in columns: False  # ❌ 字段不存在
'对比周期销量' in columns: False  # ❌ 字段不存在
```

**原代码逻辑**：查找包含`'当前'`和`'对比'`关键字的销量/收入字段
```python
# 错误的查找逻辑
for col in df.columns:
    if '当前' in col and '销量' in col:
        current_qty_col = col
    if '对比' in col and '销量' in col:
        compare_qty_col = col
```

**实际数据字段**：
```python
['商品名称', '第40周销量', '第39周销量', '第40周预计收入', '第39周预计收入', ...]
```

数据中的字段是 `第40周销量`、`第39周销量`，而不是 `当前周期销量`、`对比周期销量`！

## ✅ 修复方案

### 修复策略
改为**通用匹配逻辑**：
1. 查找所有包含"销量"的列
2. 假设前两个销量列分别是当前周期和对比周期
3. 对收入字段使用同样的逻辑

### 修复的三个图表回调

#### 1. 分时段销量对比 (`update_slot_distribution_chart`)

**修复前**：
```python
for col in df.columns:
    if '当前' in col and '销量' in col:
        current_qty_col = col
    if '对比' in col and '销量' in col:
        compare_qty_col = col
```

**修复后**：
```python
# 查找所有销量列
qty_cols = [col for col in df.columns if '销量' in col]

if len(qty_cols) >= 2:
    # 前两个销量列分别是当前周期和对比周期
    current_qty_col = qty_cols[0]  # 第40周销量
    compare_qty_col = qty_cols[1]  # 第39周销量
    use_fallback = False
else:
    use_fallback = True  # 降级方案
```

#### 2. 分场景销量对比 (`update_scene_distribution_chart`)

**同样的修复逻辑**，替换字段查找代码为通用列表查找。

#### 3. 收入对比TOP10 (`update_revenue_top10_chart`)

**修复前**：
```python
for col in df.columns:
    if '当前' in col and '收入' in col:
        current_revenue_col = col
    if '对比' in col and '收入' in col:
        compare_revenue_col = col
```

**修复后**：
```python
# 查找所有收入列（排除'收入变化'、'收入损失'等衍生字段）
revenue_cols = [col for col in df.columns if '收入' in col and '变化' not in col and '损失' not in col]

if len(revenue_cols) >= 2:
    current_revenue_col = revenue_cols[0]  # 第40周预计收入
    compare_revenue_col = revenue_cols[1]  # 第39周预计收入
    use_fallback = False
else:
    use_fallback = True  # 降级为瀑布图
```

## 📝 代码修改位置

### 文件：`智能门店看板_Dash版.py`

| 回调函数 | 行数范围 | 修改内容 |
|---------|---------|---------|
| `update_slot_distribution_chart` | ~3318-3330 | 销量字段查找逻辑 |
| `update_scene_distribution_chart` | ~3506-3523 | 销量字段查找逻辑 |
| `update_revenue_top10_chart` | ~4191-4210 | 收入字段查找逻辑 |

## 🎯 修复效果

### 修复前
- ❌ 图表显示空白
- ❌ 日志显示：`'当前周期销量' in columns: False`
- ❌ 使用降级方案但降级逻辑未完成，导致返回空数据

### 修复后
- ✅ 自动识别任何格式的销量/收入字段（`第X周销量`、`第X期销量` 等）
- ✅ 正确提取周期标签（如 `第40周`、`第39周`）
- ✅ 图表正常显示分组柱状图对比
- ✅ 日志显示：`✅ 找到销量字段: 第40周销量, 第39周销量`

## 🔧 降级方案

如果数据中销量/收入列少于2个，自动启用降级方案：

| 图表 | 降级显示 |
|------|---------|
| 分时段销量对比 | 单柱状图（统计下滑商品数） |
| 分场景销量对比 | 饼图（显示下滑商品占比） |
| 收入TOP10 | 瀑布图（显示收入变化） |

## 📊 支持的字段格式

修复后支持以下所有格式：

### 销量字段
- ✅ `第40周销量`、`第39周销量`
- ✅ `第1期销量`、`第2期销量`
- ✅ `当前周期销量`、`对比周期销量`
- ✅ `本周销量`、`上周销量`

### 收入字段
- ✅ `第40周预计收入`、`第39周预计收入`
- ✅ `第1期收入`、`第2期收入`
- ✅ `当前周期收入`、`对比周期收入`
- ✅ `本周收入`、`上周收入`

## 🧪 测试步骤

1. 启动应用：`python 智能门店看板_Dash版.py`
2. 访问：http://localhost:8050
3. 点击"问题诊断"Tab
4. 点击"🔍 开始诊断"按钮
5. 验证三个图表：
   - ⏰ 分时段销量对比：显示红蓝分组柱状图
   - 🎭 分场景销量对比：显示红蓝分组柱状图
   - 💸 收入对比TOP10：显示红蓝分组柱状图

## 📌 注意事项

1. **字段顺序假设**：代码假设第一个销量列是当前周期，第二个是对比周期。如果实际数据顺序相反，图表标签可能颠倒。

2. **周期标签提取**：
   ```python
   # 从 '第40周销量' 提取 '第40周'
   current_label = current_qty_col.replace('销量', '').replace('(', '').replace(')', '')
   ```

3. **日志调试**：所有字段查找逻辑都添加了详细日志，可查看 `callback_debug.txt` 文件。

## 🚀 下一步优化建议

### 优化1：智能识别当前/对比周期
```python
# 根据周期编号自动判断哪个是当前周期
def sort_by_period(cols):
    # 提取周期编号（如第40周 → 40）
    def extract_number(col):
        import re
        match = re.search(r'第(\d+)周', col)
        return int(match.group(1)) if match else 0
    
    return sorted(cols, key=extract_number, reverse=True)
```

### 优化2：支持更多字段格式
```python
# 支持日期格式
# '2025-10-01销量', '2025-09-24销量'
```

### 优化3：明确的字段配置
```python
# 在配置文件中明确指定字段映射
FIELD_MAPPING = {
    'current_qty': '第40周销量',
    'compare_qty': '第39周销量',
    'current_revenue': '第40周预计收入',
    'compare_revenue': '第39周预计收入'
}
```

---

**修复完成时间**：2025-10-19 17:05  
**修复文件**：`智能门店看板_Dash版.py`  
**影响范围**：问题诊断Tab - 核心指标可视化（3个图表）
