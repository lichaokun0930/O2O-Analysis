#!/usr/bin/envpython3#-*-coding:utf-8-*-r"""æ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿-å¯è§†åŒ–ç•Œé¢é›†æˆStreamlitæ„å»ºäº¤äº’å¼çœ‹æ¿ï¼Œå±•ç¤ºäº”å¤§AIæ¨¡å‹çš„åˆ†æç»“æœğŸš€å¿«é€Ÿå¯åŠ¨ï¼š=============å¯åŠ¨å‘½ä»¤ï¼šcd"d:\Python1\O2O_Analysis\O2Oæ•°æ®åˆ†æ\æµ‹ç®—æ¨¡å‹"&"d:\Python1\O2O_Analysis\O2Oæ•°æ®åˆ†æ\.venv\Scripts\streamlit.exe"runæ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿_å¯è§†åŒ–.py--server.port8502ç®€åŒ–å‘½ä»¤ï¼šcd"d:\Python1\O2O_Analysis\O2Oæ•°æ®åˆ†æ\æµ‹ç®—æ¨¡å‹"..\\.venv\\Scripts\\streamlitrunæ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿_å¯è§†åŒ–.py--server.port8502è®¿é—®åœ°å€ï¼šæœ¬åœ°åœ°å€:http://localhost:8502ç½‘ç»œåœ°å€:http://26.26.26.1:8502ğŸ“‹åŠŸèƒ½æ¨¡å—ï¼š=============-ğŸ’¹æ¯”ä»·åˆ†æï¼šæ”¯æŒä¸Šä¼ æ¯”ä»·ç»“æœExcelæ–‡ä»¶è¿›è¡Œå¯è§†åŒ–åˆ†æ-ğŸ“Šè®¢å•åˆ†æï¼šé—¨åº—è®¢å•æ•°æ®çš„æ·±åº¦åˆ†æå’Œè¶‹åŠ¿é¢„æµ‹-ğŸ¯æ™ºèƒ½å†³ç­–ï¼šåŸºäºAIæ¨¡å‹çš„ç»è¥å»ºè®®å’Œä¼˜åŒ–æ–¹æ¡ˆ-ğŸ“ˆå®æ—¶ç›‘æ§ï¼šå…³é”®ç»è¥æŒ‡æ ‡çš„å®æ—¶ç›‘æ§å’Œé¢„è­¦-ğŸ”ç«å¯¹åˆ†æï¼šç«äº‰å¯¹æ‰‹åˆ†æå’Œå¸‚åœºå®šä½å»ºè®®ğŸ’¡ä½¿ç”¨æç¤ºï¼š=============-ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»-é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ä¸‹è½½AIæ¨¡å‹ï¼Œè¯·è€å¿ƒç­‰å¾…-æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼šExcel(.xlsx,.xls),JSON-å»ºè®®ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ä»¥è·å¾—æœ€ä½³ä½“éªŒ"""importstreamlitasstimportpandasaspdimportnumpyasnpimportplotly.expressaspximportplotly.graph_objectsasgofromplotly.subplotsimportmake_subplotsfromdatetimeimportdatetimeimportjsonimportsysimportosfrompathlibimportPathfromtypingimportAny,Dict,List,Optional,TupleAPP_DIR=Path(__file__).resolve().parentifstr(APP_DIR)notinsys.path:sys.path.insert(0,str(APP_DIR))#å¯¼å…¥å•†å“åˆ†ç±»ç»“æ„åˆ†ææ¨¡å—try:fromå•†å“åˆ†ç±»ç»“æ„åˆ†æimportrender_category_analysisCATEGORY_ANALYSIS_AVAILABLE=Trueprint("âœ…å•†å“åˆ†ç±»ç»“æ„åˆ†ææ¨¡å—å·²åŠ è½½")exceptImportErrorase:CATEGORY_ANALYSIS_AVAILABLE=Falseprint(f"âš ï¸å•†å“åˆ†ç±»ç»“æ„åˆ†ææ¨¡å—åŠ è½½å¤±è´¥:{e}")#å¯¼å…¥ç»Ÿä¸€ä¸šåŠ¡é€»è¾‘é…ç½®try:sys.path.append(str(APP_DIR.parent))fromstandard_business_configimportStandardBusinessConfig,StandardBusinessLogic,create_order_level_summary,apply_standard_business_logicSTANDARD_CONFIG_AVAILABLE=Trueprint("âœ…å·²åŠ è½½ç»Ÿä¸€ä¸šåŠ¡é€»è¾‘é…ç½®")exceptImportErrorase:print(f"âš ï¸æœªæ‰¾åˆ°standard_business_configæ¨¡å—:{e}")print("å°†ä½¿ç”¨é»˜è®¤é…ç½®")STANDARD_CONFIG_AVAILABLE=False#å¯¼å…¥çœ‹æ¿ç³»ç»Ÿæ¨¡å—ï¼ˆæœ¬åœ°æ¨¡å—ï¼‰try:fromæ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿ç³»ç»ŸimportSmartStoreDashboardfromçœŸå®æ•°æ®å¤„ç†å™¨importRealDataProcessorfromprice_comparison_dashboardimportcreate_price_comparison_dashboardDASHBOARD_MODULES_AVAILABLE=Trueprint("[âœ“]æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ¨¡å—å·²åŠ è½½")exceptImportErrorase:print(f"âš ï¸çœ‹æ¿ç³»ç»Ÿæ¨¡å—å¯¼å…¥å¤±è´¥:{e}")print("éƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨")DASHBOARD_MODULES_AVAILABLE=False#åˆ›å»ºå ä½ç±»é¿å…é”™è¯¯classSmartStoreDashboard:passclassRealDataProcessor:passdefcreate_price_comparison_dashboard():st.warning("æ¯”ä»·åˆ†ææ¨¡å—æš‚ä¸å¯ç”¨")#å¯¼å…¥æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆä¸Šçº§ç›®å½•ï¼‰try:sys.path.append(str(APP_DIR.parent))fromæ ¸å¿ƒä¸šåŠ¡é€»è¾‘importCoreBusinessLogicprint("[âœ“]æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ¨¡å—å·²åŠ è½½")exceptImportErrorase:print(f"âš ï¸æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ¨¡å—å¯¼å…¥å¤±è´¥:{e}")classCoreBusinessLogic:pass#å¯¼å…¥è®¢å•åˆ†æå¢å¼ºæ¨¡å—try:fromè®¢å•åˆ†æå¢å¼ºæ¨¡å—import(render_enhanced_order_overview,render_enhanced_profit_analysis)ORDER_ENHANCEMENT_AVAILABLE=Trueprint("âœ…è®¢å•åˆ†æå¢å¼ºæ¨¡å—å·²åŠ è½½")exceptImportErrorase:print(f"âš ï¸è®¢å•åˆ†æå¢å¼ºæ¨¡å—æœªåŠ è½½:{e}")ORDER_ENHANCEMENT_AVAILABLE=False#å¯¼å…¥åœºæ™¯è¥é”€æ™ºèƒ½å†³ç­–å¼•æ“try:fromåœºæ™¯è¥é”€æ™ºèƒ½å†³ç­–å¼•æ“import(SceneMarketingIntelligence,ProductCombinationMiner,SceneRecognitionModel,RFMCustomerSegmentation,SceneDecisionTreeRules)SCENE_INTELLIGENCE_AVAILABLE=Trueprint("âœ…åœºæ™¯è¥é”€æ™ºèƒ½å†³ç­–å¼•æ“å·²åŠ è½½")exceptImportErrorase:print(f"âš ï¸åœºæ™¯è¥é”€æ™ºèƒ½å†³ç­–å¼•æ“æœªåŠ è½½:{e}")SCENE_INTELLIGENCE_AVAILABLE=False#å¯¼å…¥é—®é¢˜è¯Šæ–­å¼•æ“try:fromé—®é¢˜è¯Šæ–­å¼•æ“importProblemDiagnosticEnginePROBLEM_DIAGNOSTIC_AVAILABLE=Trueprint("âœ…é—®é¢˜è¯Šæ–­å¼•æ“å·²åŠ è½½")exceptImportErrorase:print(f"âš ï¸é—®é¢˜è¯Šæ–­å¼•æ“æœªåŠ è½½:{e}")PROBLEM_DIAGNOSTIC_AVAILABLE=FalsePRICE_PANEL_INTERMEDIATE_DIR=APP_DIR.parent/"æ¯”ä»·æ•°æ®"/"intermediate"#é¡µé¢é…ç½®st.set_page_config(page_title="æ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿",page_icon="ğŸª",layout="wide",initial_sidebar_state="expanded")#è‡ªå®šä¹‰CSSæ ·å¼st.markdown("""<style>.main-header{font-size:2.5rem;color:#1f77b4;text-align:center;margin-bottom:2rem;font-weight:bold;}.metric-card{background-color:#f8f9fa;padding:1rem;border-radius:0.5rem;border-left:4pxsolid#1f77b4;margin:1rem0;}.recommendation-box{background-color:#e8f5e8;padding:1rem;border-radius:0.5rem;border-left:4pxsolid#28a745;margin:0.5rem0;}.risk-warning{background-color:#fff3cd;padding:1rem;border-radius:0.5rem;border-left:4pxsolid#ffc107;margin:0.5rem0;}.high-risk{background-color:#f8d7da;padding:1rem;border-radius:0.5rem;border-left:4pxsolid#dc3545;margin:0.5rem0;}</style>""",unsafe_allow_html=True)@st.cache_resourcedefload_dashboard_system()->SmartStoreDashboard:"""åŠ è½½æ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿ç³»ç»Ÿå®ä¾‹"""returnSmartStoreDashboard()@st.cache_resourcedefload_data_processor()->RealDataProcessor:"""åŠ è½½çœŸå®æ•°æ®å¤„ç†å™¨å®ä¾‹"""returnRealDataProcessor("å®é™…æ•°æ®")COLUMN_NAME_FIXES:Dict[str,str]={#æ­£å¸¸åˆ—åé€ä¼ "å•†å“åç§°":"å•†å“åç§°","å•†å“å®å”®ä»·":"å•†å“å®å”®ä»·","å•†å“åŸä»·":"å•†å“åŸä»·","é—¨åº—åç§°":"é—¨åº—åç§°","é—¨åº—ç¼–ç ":"é—¨åº—ç¼–ç ","è®¢å•ID":"è®¢å•ID","ä¸‹å•æ—¶é—´":"ä¸‹å•æ—¶é—´","æ”¶è´§åœ°å€":"æ”¶è´§åœ°å€","ç”¨æˆ·ID":"ç”¨æˆ·ID","ç”¨æˆ·åç§°":"ç”¨æˆ·åç§°","æ•°é‡":"æ•°é‡","å‰©ä½™åº“å­˜":"å‰©ä½™åº“å­˜","ç¾å›¢ä¸€çº§åˆ†ç±»":"ç¾å›¢ä¸€çº§åˆ†ç±»","ç¾å›¢ä¸‰çº§åˆ†ç±»":"ç¾å›¢ä¸‰çº§åˆ†ç±»","é…é€æ–¹å¼":"é…é€æ–¹å¼","æ¸ é“":"æ¸ é“","åŸå¸‚åç§°":"åŸå¸‚åç§°","ç‰©æµé…é€è´¹":"ç‰©æµé…é€è´¹","å¹³å°ä½£é‡‘":"å¹³å°ä½£é‡‘","å®æ”¶ä»·æ ¼":"å®æ”¶ä»·æ ¼","é¢„ä¼°è®¢å•æ”¶å…¥":"é¢„ä¼°è®¢å•æ”¶å…¥","ç”¨æˆ·æ”¯ä»˜é…é€è´¹":"ç”¨æˆ·æ”¯ä»˜é…é€è´¹","é…é€è´¹å‡å…é‡‘é¢":"é…é€è´¹å‡å…é‡‘é¢","å•†å“ä¼˜æƒ é‡‘é¢":"å•†å“ä¼˜æƒ é‡‘é¢","å•†å“å‡å…é‡‘é¢":"å•†å“å‡å…é‡‘é¢",#å¸¸è§ä¹±ç æ˜ å°„"Ò»":"ä¸€çº§åˆ†ç±»","":"åŸå¸‚åç§°","":"ä¸‰çº§åˆ†ç±»","Æ·":"å•†å“åç§°","Æ·":"å•†å“ç¼–ç ","Æ·ÊµÛ¼":"å•†å“å®å”®ä»·","Æ·Ô­":"å•†å“åŸä»·","":"æ•°é‡","Ê£":"å‰©ä½™åº“å­˜","Æ·":"å•†å“ä¼˜æƒ é‡‘é¢","":"é…é€æ–¹å¼","ID":"è®¢å•ID","Ã»ID":"ç”¨æˆ·ID","Ã»":"ç”¨æˆ·åç§°","Ì»":"é—¨åº—åç§°","Åµ":"é—¨åº—åç§°","ÂµÊ±":"ä¸‹å•æ—¶é—´","Õ»Ö·":"æ”¶è´§åœ°å€","Æ½Ì¨Ó¶":"å¹³å°ä½£é‡‘","ÊµÕ¼Û¸":"å®æ”¶ä»·æ ¼","Ô¤Æ¶":"é¢„ä¼°è®¢å•æ”¶å…¥","Ã»Ö§":"ç”¨æˆ·æ”¯ä»˜é…é€è´¹","Ã»Ö§Í·":"é…é€è´¹å‡å…é‡‘é¢","Í·Ñ¼":"ç‰©æµé…é€è´¹","Æ·":"å•†å“åç§°","Ì¼Ò³ĞµÈ¯":"å•†å®¶ä¼˜æƒ åˆ¸","Ì¼Ò´È¯":"å•†å®¶ä¼˜æƒ åˆ¸","":"å•†å“å‡å…é‡‘é¢","":"æ¸ é“",}SHEET_KEYWORDS:Dict[str,List[str]]={"order":["é—¨åº—è®¢å•","è®¢å•","order"],"competitor":["ç«å¯¹","ç«å“","å¯¹æ‰‹"],"cost":["æˆæœ¬","è´¹ç”¨","cost"],"traffic":["æµé‡","äº¤é€š","å®¢æµ","traffic"],}NUMERIC_COLUMNS=["å•†å“å®å”®ä»·","å•†å“åŸä»·","æ•°é‡","å‰©ä½™åº“å­˜","å¹³å°ä½£é‡‘","ç‰©æµé…é€è´¹","ç”¨æˆ·æ”¯ä»˜é…é€è´¹","é…é€è´¹å‡å…é‡‘é¢","é¢„ä¼°è®¢å•æ”¶å…¥","å®æ”¶ä»·æ ¼","å•†å“ä¼˜æƒ é‡‘é¢","å•†å“å‡å…é‡‘é¢",]CHANNELS_TO_REMOVE=CoreBusinessLogic.CHANNELS_TO_REMOVE#====================ğŸ“Šæ•°æ®è´¨é‡æ£€æŸ¥ä¸ç¼“å­˜ç®¡ç†====================defperform_data_quality_check(df:pd.DataFrame)->Dict[str,Any]:"""æ‰§è¡Œå…¨é¢çš„æ•°æ®è´¨é‡æ£€æŸ¥Returns:åŒ…å«è´¨é‡æ£€æŸ¥ç»“æœçš„å­—å…¸"""quality_report={'total_rows':len(df),'total_columns':len(df.columns),'issues':[],'warnings':[],'summary':{},'score':100#åˆå§‹åˆ†æ•°100åˆ†}#1.æ£€æŸ¥ç¼ºå¤±å€¼missing_data=df.isnull().sum()ifmissing_data.sum()>0:missing_cols=missing_data[missing_data>0]quality_report['summary']['missing_values']=missing_cols.to_dict()forcol,countinmissing_cols.items():percentage=(count/len(df))*100ifpercentage>50:quality_report['issues'].append({'type':'ä¸¥é‡','column':col,'description':f'ç¼ºå¤±å€¼è¿‡å¤šï¼š{count}è¡Œ({percentage:.1f}%)'})quality_report['score']-=10elifpercentage>10:quality_report['warnings'].append({'type':'è­¦å‘Š','column':col,'description':f'å­˜åœ¨ç¼ºå¤±å€¼ï¼š{count}è¡Œ({percentage:.1f}%)'})quality_report['score']-=3#2.æ£€æŸ¥å®Œå…¨é‡å¤çš„æ•°æ®è¡Œduplicate_rows=df.duplicated().sum()ifduplicate_rows>0:quality_report['issues'].append({'type':'è­¦å‘Š','column':'æ•°æ®è¡Œ','description':f'å‘ç°å®Œå…¨é‡å¤çš„æ•°æ®è¡Œï¼š{duplicate_rows}æ¡ï¼ˆæ‰€æœ‰å­—æ®µå®Œå…¨ç›¸åŒï¼‰'})quality_report['score']-=5#2.1æ£€æŸ¥è®¢å•-å•†å“æ˜ç»†ç»“æ„ï¼ˆä¿¡æ¯æ€§æ£€æŸ¥ï¼Œä¸æ‰£åˆ†ï¼‰if'è®¢å•ID'indf.columns:unique_orders=df['è®¢å•ID'].nunique()total_rows=len(df)items_per_order=total_rows/unique_ordersifunique_orders>0else0quality_report['issues'].append({'type':'ä¿¡æ¯','column':'è®¢å•ç»“æ„','description':f'è®¢å•-å•†å“æ˜ç»†çº§æ•°æ®ï¼š{unique_orders}ä¸ªè®¢å•ï¼Œ{total_rows}æ¡æ˜ç»†ï¼ˆå¹³å‡æ¯å•{items_per_order:.1f}ä¸ªå•†å“ï¼‰'})#3.æ£€æŸ¥æ—¥æœŸæ ¼å¼if'ä¸‹å•æ—¶é—´'indf.columns:try:date_series=pd.to_datetime(df['ä¸‹å•æ—¶é—´'],errors='coerce')invalid_dates=date_series.isnull().sum()ifinvalid_dates>0:quality_report['warnings'].append({'type':'è­¦å‘Š','column':'ä¸‹å•æ—¶é—´','description':f'æ— æ•ˆæ—¥æœŸæ ¼å¼ï¼š{invalid_dates}è¡Œ'})quality_report['score']-=3exceptExceptionase:quality_report['issues'].append({'type':'ä¸¥é‡','column':'ä¸‹å•æ—¶é—´','description':f'æ—¥æœŸè§£æå¤±è´¥ï¼š{str(e)}'})quality_report['score']-=10#4.æ£€æŸ¥æ•°å€¼å¼‚å¸¸numeric_cols=['å•†å“å®å”®ä»·','å•†å“åŸä»·','é”€é‡','åˆ©æ¶¦é¢','è®¢å•é›¶å”®é¢']forcolinnumeric_cols:ifcolindf.columns:try:numeric_series=pd.to_numeric(df[col],errors='coerce')#æ£€æŸ¥è´Ÿæ•°ï¼ˆæŸäº›å­—æ®µä¸åº”ä¸ºè´Ÿï¼‰ifcolin['å•†å“å®å”®ä»·','å•†å“åŸä»·','é”€é‡']:negative_count=(numeric_series<0).sum()ifnegative_count>0:quality_report['warnings'].append({'type':'è­¦å‘Š','column':col,'description':f'å­˜åœ¨è´Ÿæ•°ï¼š{negative_count}è¡Œ'})quality_report['score']-=2#æ£€æŸ¥å¼‚å¸¸å€¼ï¼ˆè¶…å‡ºåˆç†èŒƒå›´ï¼‰ifcol=='å•†å“å®å”®ä»·':outliers=((numeric_series>10000)|(numeric_series<0.1)).sum()ifoutliers>0:quality_report['warnings'].append({'type':'æç¤º','column':col,'description':f'å¯èƒ½å­˜åœ¨å¼‚å¸¸ä»·æ ¼ï¼š{outliers}è¡Œï¼ˆ<0.1æˆ–>10000ï¼‰'})exceptException:pass#5.æ£€æŸ¥å¿…éœ€å­—æ®µrequired_fields=['è®¢å•ID','å•†å“åç§°','å•†å“å®å”®ä»·','é”€é‡','ä¸‹å•æ—¶é—´']missing_required=[fieldforfieldinrequired_fieldsiffieldnotindf.columns]ifmissing_required:quality_report['issues'].append({'type':'ä¸¥é‡','column':','.join(missing_required),'description':f'ç¼ºå°‘å¿…éœ€å­—æ®µï¼š{missing_required}'})quality_report['score']-=15#ç¡®ä¿åˆ†æ•°ä¸ä½äº0quality_report['score']=max(0,quality_report['score'])#ç”Ÿæˆç­‰çº§ifquality_report['score']>=90:quality_report['grade']='ä¼˜ç§€'quality_report['grade_color']='green'elifquality_report['score']>=70:quality_report['grade']='è‰¯å¥½'quality_report['grade_color']='blue'elifquality_report['score']>=50:quality_report['grade']='ä¸€èˆ¬'quality_report['grade_color']='orange'else:quality_report['grade']='è¾ƒå·®'quality_report['grade_color']='red'returnquality_reportdefsave_data_to_cache(df:pd.DataFrame,file_name:str)->str:"""ä¿å­˜æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜Args:df:è¦ä¿å­˜çš„DataFramefile_name:åŸå§‹æ–‡ä»¶åReturns:ä¿å­˜çš„æ–‡ä»¶è·¯å¾„"""importhashlibfromdatetimeimportdatetimeimportpickleimportgzip#åˆ›å»ºç¼“å­˜ç›®å½•cache_dir=APP_DIR/"å­¦ä¹ æ•°æ®ä»“åº“"/"uploaded_data"cache_dir.mkdir(parents=True,exist_ok=True)#ç”Ÿæˆæ–‡ä»¶åï¼ˆåŸºäºå†…å®¹hashå’Œæ—¶é—´æˆ³ï¼‰content_hash=hashlib.md5(df.to_json().encode()).hexdigest()[:8]timestamp=datetime.now().strftime('%Y%m%d_%H%M%S')safe_name=file_name.replace('.xlsx','').replace('.xls','')cache_file=cache_dir/f"{safe_name}_{content_hash}_{timestamp}.pkl.gz"#ä¿å­˜å…ƒæ•°æ®metadata={'original_file':file_name,'upload_time':datetime.now().isoformat(),'rows':len(df),'columns':list(df.columns),'data_hash':content_hash}#ä½¿ç”¨gzipå‹ç¼©ä¿å­˜withgzip.open(cache_file,'wb')asf:pickle.dump({'data':df,'metadata':metadata},f)returnstr(cache_file)defload_cached_data_list()->List[Dict[str,Any]]:"""è·å–æ‰€æœ‰ç¼“å­˜æ•°æ®çš„åˆ—è¡¨Returns:ç¼“å­˜æ•°æ®ä¿¡æ¯åˆ—è¡¨"""importpickleimportgzipcache_dir=APP_DIR/"å­¦ä¹ æ•°æ®ä»“åº“"/"uploaded_data"ifnotcache_dir.exists():return[]cached_files=[]forfileinsorted(cache_dir.glob("*.pkl.gz"),reverse=True):try:withgzip.open(file,'rb')asf:cached=pickle.load(f)metadata=cached.get('metadata',{})cached_files.append({'file_path':str(file),'file_name':file.name,'original_file':metadata.get('original_file','Unknown'),'upload_time':metadata.get('upload_time','Unknown'),'rows':metadata.get('rows',0),'size_mb':file.stat().st_size/(1024*1024)})exceptException:continuereturncached_filesdefload_data_from_cache(file_path:str)->Optional[pd.DataFrame]:"""ä»ç¼“å­˜åŠ è½½æ•°æ®Args:file_path:ç¼“å­˜æ–‡ä»¶è·¯å¾„Returns:DataFrameæˆ–None"""importpickleimportgziptry:withgzip.open(file_path,'rb')asf:cached=pickle.load(f)returncached.get('data')exceptExceptionase:st.error(f"âŒåŠ è½½ç¼“å­˜å¤±è´¥:{str(e)}")returnNonedefnormalize_label(label:Any)->Any:"""å°è¯•è§„æ•´åˆ—å/è¡¨åï¼Œå…¼å®¹ä¹±ç """ifnotisinstance(label,str):returnlabeltrimmed=label.strip()iftrimmedinCOLUMN_NAME_FIXES:returnCOLUMN_NAME_FIXES[trimmed]#å¤šç§ç¼–ç å›é€€forsourcein("latin1","cp1252"):fortargetin("gbk","gb2312"):try:decoded=trimmed.encode(source,errors="ignore").decode(target,errors="ignore").strip()ifdecoded:returnCOLUMN_NAME_FIXES.get(decoded,decoded)exceptException:continuereturnCOLUMN_NAME_FIXES.get(trimmed,trimmed)defrename_columns(df:pd.DataFrame,extra_map:Optional[Dict[str,str]]=None)->pd.DataFrame:"""ç»Ÿä¸€DataFrameåˆ—å"""extra_map=extra_mapor{}rename_map:Dict[str,str]={}forcolindf.columns:normalized=normalize_label(col)normalized=extra_map.get(normalized,normalized)rename_map[col]=normalizedreturndf.rename(columns=rename_map)defconvert_numeric(df:pd.DataFrame,columns:List[str])->pd.DataFrame:forcolincolumns:ifcolindf.columns:df[col]=pd.to_numeric(df[col],errors="coerce")returndfdefaggregate_product_data(order_df:pd.DataFrame)->pd.DataFrame:if"å•†å“åç§°"notinorder_df.columns:returnpd.DataFrame()agg_map:Dict[str,str]={}if"å•†å“å®å”®ä»·"inorder_df.columns:agg_map["å•†å“å®å”®ä»·"]="mean"if"å•†å“åŸä»·"inorder_df.columns:agg_map["å•†å“åŸä»·"]="mean"if"æ•°é‡"inorder_df.columns:agg_map["æ•°é‡"]="sum"if"å‰©ä½™åº“å­˜"inorder_df.columns:agg_map["å‰©ä½™åº“å­˜"]="max"if"ä¸€çº§åˆ†ç±»"inorder_df.columns:agg_map["ä¸€çº§åˆ†ç±»"]="first"if"ä¸‰çº§åˆ†ç±»"inorder_df.columns:agg_map["ä¸‰çº§åˆ†ç±»"]="first"ifnotagg_map:returnpd.DataFrame()product_df=order_df.groupby("å•†å“åç§°",as_index=False).agg(agg_map)rename_map={"å•†å“å®å”®ä»·":"å”®ä»·","å•†å“åŸä»·":"åŸä»·","æ•°é‡":"æœˆå”®","å‰©ä½™åº“å­˜":"åº“å­˜","ä¸€çº§åˆ†ç±»":"ç¾å›¢ä¸€çº§åˆ†ç±»","ä¸‰çº§åˆ†ç±»":"ç¾å›¢ä¸‰çº§åˆ†ç±»",}returnproduct_df.rename(columns={k:vfork,vinrename_map.items()ifkinproduct_df.columns})defbuild_sales_summary(order_df:pd.DataFrame)->pd.DataFrame:"""æ„å»ºé”€å”®æ±‡æ€»æ•°æ®-ç®€åŒ–ç‰ˆï¼Œé¿å…å¤æ‚èšåˆé—®é¢˜"""if"ä¸‹å•æ—¶é—´"inorder_df.columns:order_df=order_df.copy()order_df["ä¸‹å•æ—¶é—´"]=pd.to_datetime(order_df["ä¸‹å•æ—¶é—´"],errors="coerce")order_df["ä¸‹å•æ—¥æœŸ"]=order_df["ä¸‹å•æ—¶é—´"].dt.dateif"ä¸‹å•æ—¥æœŸ"notinorder_df.columns:returnpd.DataFrame()#ç®€åŒ–èšåˆé€»è¾‘ï¼Œåªèšåˆæ•°å€¼åˆ—agg_dict:Dict[str,Any]={"ä¸‹å•æ—¥æœŸ":"first"}if"é¢„ä¼°è®¢å•æ”¶å…¥"inorder_df.columns:agg_dict["é¢„ä¼°è®¢å•æ”¶å…¥"]="sum"if"å®æ”¶ä»·æ ¼"inorder_df.columns:agg_dict["å®æ”¶ä»·æ ¼"]="sum"if"æ•°é‡"inorder_df.columns:agg_dict["æ•°é‡"]="sum"#ä¸åœ¨è¿™é‡Œèšåˆè®¢å•IDï¼Œé¿å…ç»´åº¦é—®é¢˜#ç›´æ¥æŒ‰æ—¥æœŸåˆ†ç»„èšåˆæ•°å€¼try:summary=order_df.groupby("ä¸‹å•æ—¥æœŸ").agg(agg_dict).reset_index(drop=True)exceptExceptionase:#å¦‚æœèšåˆå¤±è´¥ï¼Œè¿”å›ç©ºDataFramereturnpd.DataFrame()rename_map={"ä¸‹å•æ—¥æœŸ":"date","é¢„ä¼°è®¢å•æ”¶å…¥":"estimated_revenue","å®æ”¶ä»·æ ¼":"net_revenue","æ•°é‡":"items_sold",}returnsummary.rename(columns={k:vfork,vinrename_map.items()ifkinsummary.columns})defbuild_customer_profile(order_df:pd.DataFrame)->pd.DataFrame:candidate_cols=["è®¢å•ID","ç”¨æˆ·ID","ç”¨æˆ·åç§°","ä¸‹å•æ—¶é—´","æ”¶è´§åœ°å€","åŸå¸‚åç§°","æ¸ é“","é…é€æ–¹å¼","é—¨åº—åç§°",]available=[colforcolincandidate_colsifcolinorder_df.columns]ifnotavailable:returnpd.DataFrame()profile=order_df[available].copy()if"ä¸‹å•æ—¶é—´"inprofile.columns:profile["ä¸‹å•æ—¶é—´"]=pd.to_datetime(profile["ä¸‹å•æ—¶é—´"],errors="coerce")if"è®¢å•ID"inprofile.columns:profile=profile.drop_duplicates(subset=["è®¢å•ID"],keep="last")returnprofiledeffilter_channels(order_df:pd.DataFrame)->pd.DataFrame:if"æ¸ é“"notinorder_df.columns:returnorder_dffiltered=order_df[~order_df["æ¸ é“"].isin(CHANNELS_TO_REMOVE)].copy()returnfiltereddefdetect_data_period(order_df:pd.DataFrame)->Optional[str]:date_series=Noneif"ä¸‹å•æ—¶é—´"inorder_df.columns:date_series=pd.to_datetime(order_df["ä¸‹å•æ—¶é—´"],errors="coerce")elif"ä¸‹å•æ—¥æœŸ"inorder_df.columns:date_series=pd.to_datetime(order_df["ä¸‹å•æ—¥æœŸ"],errors="coerce")ifdate_seriesisNoneordate_series.dropna().empty:returnNonedate_series=date_series.dropna()start,end=date_series.min(),date_series.max()try:returnf"{start:%Y-%m-%d}~{end:%Y-%m-%d}"exceptException:returnNone@st.cache_data(ttl=60)#1åˆ†é’Ÿç¼“å­˜ï¼Œé…é€æˆæœ¬å‡€æˆæœ¬æ¨¡å¼æœ€ç»ˆä¿®æ­£2025-10-13defload_real_business_data(_cache_version:str="v11_NEW_DATA_2025_10_15")->Tuple[Optional[Dict[str,Any]],List[str]]:"""æ‰«æå¹¶åŠ è½½çœŸå®ä¸šåŠ¡æ•°æ®ï¼Œè¿”å›(æ•°æ®,æç¤ºä¿¡æ¯)é‡è¦æ›´æ–°2025-10-13:é…é€æˆæœ¬å‡€æˆæœ¬æ¨¡å¼æœ€ç»ˆä¿®æ­£-é…é€æˆæœ¬å…¬å¼:(é…é€è´¹å‡å…+ç‰©æµé…é€è´¹)-ç”¨æˆ·æ”¯ä»˜é…é€è´¹=å‡€æˆæœ¬-è®¢å•æ€»æ”¶å…¥:å•†å“å®å”®ä»·+æ‰“åŒ…è´¹+ç”¨æˆ·æ”¯ä»˜é…é€è´¹ï¼ˆå®Œæ•´æ”¶å…¥ï¼‰-åˆ©æ¶¦å…¬å¼:æ€»æ”¶å…¥-å•†å“æˆæœ¬-é…é€å‡€æˆæœ¬-å…¶ä»–æˆæœ¬Args:_cache_version:ç¼“å­˜ç‰ˆæœ¬å·ï¼Œä¿®æ”¹æ­¤å‚æ•°å¯å¼ºåˆ¶åˆ·æ–°ç¼“å­˜"""messages:List[str]=[]candidate_dirs=[APP_DIR/"å®é™…æ•°æ®",APP_DIR.parent/"å®é™…æ•°æ®",APP_DIR/"é—¨åº—æ•°æ®",APP_DIR.parent/"æµ‹ç®—æ¨¡å‹"/"é—¨åº—æ•°æ®",APP_DIR.parent/"æµ‹ç®—æ¨¡å‹"/"é—¨åº—æ•°æ®"/"æ¯”ä»·çœ‹æ¿æ¨¡å—",]data_dir:Optional[Path]=Nonecandidates:List[Path]=[]forpathincandidate_dirs:ifnotpath.exists():continuecurrent_candidates=sorted(fforfinpath.glob("*.xlsx")ifnotf.name.startswith("~$"))ifcurrent_candidates:data_dir=pathcandidates=current_candidatesbreakifdata_dirisNone:tried="ï¼›".join(str(path)forpathincandidate_dirs)messages.append(f"æœªæ‰¾åˆ°æ•°æ®ç›®å½•ï¼Œå¯åœ¨ä»¥ä¸‹ä½ç½®ä¹‹ä¸€åˆ›å»º:{tried}")returnNone,messagesifnotcandidates:messages.append("æ•°æ®ç›®å½•ä¸‹æœªæ‰¾åˆ°Excelæ–‡ä»¶")returnNone,messagestarget_file=next((fforfincandidatesif"æµ‹è¯•æ•°æ®"inf.name),candidates[0])try:xls=pd.ExcelFile(target_file)exceptExceptionasexc:messages.append(f"è¯»å–{target_file.name}å¤±è´¥:{exc}")returnNone,messagesdefpick_sheet(kind:str)->Optional[str]:keywords=SHEET_KEYWORDS.get(kind,[])forsheetinxls.sheet_names:normalized=str(normalize_label(sheet)).replace("","")forkwinkeywords:ifkwinnormalized:returnsheetreturnNonesheet_map={"order":pick_sheet("order")or(xls.sheet_names[0]ifxls.sheet_nameselseNone),"competitor":pick_sheet("competitor"),"cost":pick_sheet("cost"),"traffic":pick_sheet("traffic"),}ifsheet_map["competitor"]isNone:forsheetinxls.sheet_names:normalized=str(normalize_label(sheet)).replace("","")if"ç«å¯¹"innormalizedor"ç«å“"innormalized:sheet_map["competitor"]=sheetbreakifsheet_map["cost"]isNone:forsheetinxls.sheet_names:normalized=str(normalize_label(sheet)).replace("","")if"æˆæœ¬"innormalizedor"è´¹ç”¨"innormalized:sheet_map["cost"]=sheetbreakifsheet_map["traffic"]isNone:forsheetinxls.sheet_names:normalized=str(normalize_label(sheet)).replace("","")if"æµé‡"innormalizedor"å®¢æµ"innormalized:sheet_map["traffic"]=sheetbreakdata_frames:Dict[str,pd.DataFrame]={}forkey,sheet_nameinsheet_map.items():ifsheet_nameisNone:messages.append(f"æœªæ‰¾åˆ°{key}ç›¸å…³çš„å·¥ä½œè¡¨")continuetry:df=pd.read_excel(xls,sheet_name=sheet_name)data_frames[key]=rename_columns(df)exceptExceptionasexc:messages.append(f"è¯»å–å·¥ä½œè¡¨{sheet_name}å¤±è´¥:{exc}")order_df=data_frames.get("order",pd.DataFrame())iforder_df.empty:messages.append("æœªè·å–åˆ°é—¨åº—è®¢å•æ•°æ®")returnNone,messagesorder_df=convert_numeric(order_df,NUMERIC_COLUMNS)filtered_order_df=filter_channels(order_df)removed_rows=len(order_df)-len(filtered_order_df)ifremoved_rows>0:messages.append(f"å·²å‰”é™¤æŒ‡å®šæ¸ é“è®¢å•{removed_rows:,}æ¡")order_df=filtered_order_dfproduct_df=aggregate_product_data(order_df)sales_summary=build_sales_summary(order_df)customer_df=build_customer_profile(order_df)competitor_df=data_frames.get("competitor",pd.DataFrame())ifnotcompetitor_df.empty:competitor_df=convert_numeric(competitor_df,["å”®ä»·","åŸä»·","æœˆå”®"])cost_df=data_frames.get("cost",pd.DataFrame())traffic_df=data_frames.get("traffic",pd.DataFrame())store_identifier=order_df.get("é—¨åº—åç§°")store_id="REAL_STORE_DATA"ifstore_identifierisnotNoneandnotstore_identifier.dropna().empty:store_id=str(store_identifier.mode().iat[0])data_period=detect_data_period(order_df)or"è¿‘30å¤©"#å®‰å…¨è®¡ç®—è®¢å•æ•°å’Œå•†å“æ•°try:if"è®¢å•ID"inorder_df.columns:total_orders=int(order_df["è®¢å•ID"].nunique())else:total_orders=len(order_df)exceptException:total_orders=len(order_df)try:ifnotproduct_df.emptyand"å•†å“åç§°"inproduct_df.columns:total_products=int(product_df["å•†å“åç§°"].nunique())elif"å•†å“åç§°"inorder_df.columns:total_products=int(order_df["å•†å“åç§°"].nunique())else:total_products=0exceptException:total_products=0result:Dict[str,Any]={"store_id":store_id,"order_data":order_df,"raw_data":order_df,#æ·»åŠ raw_dataé”®ç”¨äºåœºæ™¯è¥é”€åˆ†æ"product_data":product_df,"sales_data":sales_summary,"customer_data":customer_df,"competitor_data":competitor_df,"cost_data":cost_df,"traffic_data":traffic_df,"data_source":f"æ–‡ä»¶:{target_file.name}","data_period":data_period,"total_orders":total_orders,"total_products":total_products,}returnresult,messagesdefprocess_uploaded_comparison_file(comparison_file)->Optional[Dict[str,Any]]:"""å¤„ç†ä¸Šä¼ çš„å·²æ¯”å¯¹å¥½çš„Excelæ–‡ä»¶"""ifnotcomparison_file:returnNonetry:#è¯»å–Excelæ–‡ä»¶çš„æ‰€æœ‰Sheetst.info("ğŸ“Šæ­£åœ¨è¯»å–æ¯”ä»·ç»“æœæ–‡ä»¶...")excel_file=pd.ExcelFile(comparison_file)sheet_names=excel_file.sheet_namesst.success(f"âœ…æ£€æµ‹åˆ°{len(sheet_names)}ä¸ªSheet:{sheet_names}")#è¯»å–å„ä¸ªSheetçš„æ•°æ®sheets_data={}forsheet_nameinsheet_names:try:df=pd.read_excel(comparison_file,sheet_name=sheet_name)iflen(df)>0:sheets_data[sheet_name]=dfst.info(f"âœ…{sheet_name}:{len(df)}æ¡è®°å½•")else:st.info(f"âš ï¸{sheet_name}:ç©ºè¡¨")exceptExceptionase:st.warning(f"âŒè¯»å–{sheet_name}å¤±è´¥:{e}")continueifnotsheets_data:st.error("Excelæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼")returnNone#è§£ææ¯”ä»·æ•°æ®å¹¶ç”Ÿæˆç»Ÿè®¡æŒ‡æ ‡st.info("ğŸ”„æ­£åœ¨è§£ææ¯”ä»·ç»“æœ...")#ç»Ÿè®¡åŒ¹é…æƒ…å†µbarcode_matches=sheets_data.get('1-æ¡ç ç²¾ç¡®åŒ¹é…',pd.DataFrame())name_matches=sheets_data.get('2-åç§°æ¨¡ç³ŠåŒ¹é…(æ— æ¡ç )',pd.DataFrame())barcode_match_count=len(barcode_matches)name_match_count=len(name_matches)total_matches=barcode_match_count+name_match_count#ç»Ÿè®¡ç‹¬æœ‰å•†å“store_a_unique_key=Nonestore_b_unique_key=Nonestore_names=[]forsheet_nameinsheet_names:if'ç‹¬æœ‰å•†å“'insheet_name:ifsheet_name.startswith('3-'):store_a_unique_key=sheet_name#æå–åº—é“ºåç§°parts=sheet_name.split('-')iflen(parts)>=2:store_name=parts[1]store_names.append(store_name)elifsheet_name.startswith('4-'):store_b_unique_key=sheet_name#æå–åº—é“ºåç§°parts=sheet_name.split('-')iflen(parts)>=2:store_name=parts[1]store_names.append(store_name)store_a_unique=sheets_data.get(store_a_unique_key,pd.DataFrame())store_b_unique=sheets_data.get(store_b_unique_key,pd.DataFrame())store_a_unique_count=len(store_a_unique)store_b_unique_count=len(store_b_unique)#ä»·æ ¼ä¼˜åŠ¿åˆ†æprice_advantage=sheets_data.get('5-åº“å­˜>0&AæŠ˜æ‰£â‰¥BæŠ˜æ‰£',pd.DataFrame())price_advantage_count=len(price_advantage)#è®¡ç®—ä»·æ ¼å·®å¼‚ç»Ÿè®¡ï¼ˆä»åŒ¹é…çš„å•†å“ä¸­ï¼‰avg_price_diff=0max_price_diff=0#å°è¯•ä»åŒ¹é…æ•°æ®ä¸­è®¡ç®—ä»·æ ¼å·®å¼‚iflen(barcode_matches)>0:price_cols=[colforcolinbarcode_matches.columnsif'å”®ä»·'incolor'ä»·æ ¼'incol]iflen(price_cols)>=2:try:price_diffs=barcode_matches[price_cols[0]]-barcode_matches[price_cols[1]]avg_price_diff=price_diffs.mean()max_price_diff=price_diffs.abs().max()exceptException:pass#æ„é€ åˆ†æç»“æœstore_display_names=store_namesiflen(store_names)>=2else['é—¨åº—A','é—¨åº—B']analysis_result={"generated_at":pd.Timestamp.now().isoformat(),"comparison_type":"multi_store_comparison","sheets_data":sheets_data,"sheet_names":sheet_names,"stores":[{"display_name":store_display_names[0],"unique_products":store_a_unique_count},{"display_name":store_display_names[1],"unique_products":store_b_unique_count}],"metrics":[{"id":"barcode_matches","label":"æ¡ç ç²¾ç¡®åŒ¹é…","value":barcode_match_count,"unit":"ä¸ª","context":{"type":"exact_match"}},{"id":"name_matches","label":"åç§°æ¨¡ç³ŠåŒ¹é…","value":name_match_count,"unit":"ä¸ª","context":{"type":"fuzzy_match"}},{"id":"total_matches","label":"æ€»åŒ¹é…å•†å“æ•°","value":total_matches,"unit":"ä¸ª","context":{"barcode":barcode_match_count,"name":name_match_count}},{"id":"unique_store_a","label":f"{store_display_names[0]}ç‹¬æœ‰å•†å“","value":store_a_unique_count,"unit":"ä¸ª","context":{"store":store_display_names[0]}},{"id":"unique_store_b","label":f"{store_display_names[1]}ç‹¬æœ‰å•†å“","value":store_b_unique_count,"unit":"ä¸ª","context":{"store":store_display_names[1]}},{"id":"price_advantage","label":"ä»·æ ¼ä¼˜åŠ¿å•†å“æ•°","value":price_advantage_count,"unit":"ä¸ª","context":{"criteria":"åº“å­˜>0&AæŠ˜æ‰£â‰¥BæŠ˜æ‰£"}}],"summary":{"avg_price_diff":avg_price_diff,"max_price_diff":max_price_diff,"comparison_coverage":total_matches/(total_matches+store_a_unique_count+store_b_unique_count)if(total_matches+store_a_unique_count+store_b_unique_count)>0else0},"warnings":[]}#æ·»åŠ è­¦å‘Šiftotal_matches<10:analysis_result["warnings"].append("åŒ¹é…å•†å“æ•°é‡è¾ƒå°‘ï¼Œå¯èƒ½å½±å“åˆ†æå‡†ç¡®æ€§")ifstore_a_unique_count+store_b_unique_count>total_matches:analysis_result["warnings"].append("ç‹¬æœ‰å•†å“æ•°é‡è¾ƒå¤šï¼Œå»ºè®®æ£€æŸ¥å•†å“åˆ†ç±»å’Œå‘½åè§„èŒƒ")st.success(f"ğŸ‰æ¯”ä»·ç»“æœè§£æå®Œæˆï¼åŒ¹é…{total_matches}ä¸ªå•†å“(æ¡ç :{barcode_match_count},åç§°:{name_match_count})")returnanalysis_resultexceptExceptionase:st.error(f"âŒå¤„ç†æ¯”ä»·ç»“æœæ–‡ä»¶æ—¶å‡ºé”™:{str(e)}")importtracebackst.error(f"è¯¦ç»†é”™è¯¯:{traceback.format_exc()}")returnNonedefrender_comparison_file_analysis(price_panel_payload:Dict[str,Any])->None:"""æ¸²æŸ“æ¯”ä»·ç»“æœæ–‡ä»¶åˆ†æ"""try:#æ˜¾ç¤ºåŸºç¡€ç»Ÿè®¡st.subheader("ğŸ“Šæ¯”ä»·ç»“æœæ¦‚è§ˆ")#åŸºç¡€æŒ‡æ ‡å¡ç‰‡col1,col2,col3,col4=st.columns(4)metrics=price_panel_payload.get("metrics",[])stores=price_panel_payload.get("stores",[])summary=price_panel_payload.get("summary",{})#æ‰¾åˆ°ç›¸å…³æŒ‡æ ‡total_matches=0barcode_matches=0name_matches=0store_a_unique=0store_b_unique=0formetricinmetrics:metric_id=metric.get("id","")value=metric.get("value",0)ifmetric_id=="total_matches":total_matches=valueelifmetric_id=="barcode_matches":barcode_matches=valueelifmetric_id=="name_matches":name_matches=valueelifmetric_id=="unique_store_a":store_a_unique=valueelifmetric_id=="unique_store_b":store_b_unique=valuewithcol1:st.metric("æ€»åŒ¹é…å•†å“",f"{total_matches:,}",help="æ¡ç åŒ¹é…+åç§°åŒ¹é…çš„æ€»å•†å“æ•°é‡")withcol2:st.metric("æ¡ç ç²¾ç¡®åŒ¹é…",f"{barcode_matches:,}",help="é€šè¿‡æ¡ç ç²¾ç¡®åŒ¹é…çš„å•†å“æ•°é‡")withcol3:st.metric("åç§°æ¨¡ç³ŠåŒ¹é…",f"{name_matches:,}",help="é€šè¿‡å•†å“åç§°æ¨¡ç³ŠåŒ¹é…çš„å•†å“æ•°é‡")withcol4:coverage=summary.get("comparison_coverage",0)st.metric("åŒ¹é…è¦†ç›–ç‡",f"{coverage:.1%}",help="åŒ¹é…å•†å“æ•°å æ€»å•†å“æ•°çš„æ¯”ä¾‹")#åº—é“ºå¯¹æ¯”st.subheader("ğŸªåº—é“ºå•†å“å¯¹æ¯”")col1,col2=st.columns(2)withcol1:iflen(stores)>0:store_name_a=stores[0].get("display_name","åº—é“ºA")st.metric(f"{store_name_a}ç‹¬æœ‰å•†å“",f"{store_a_unique:,}",help=f"{store_name_a}ç‰¹æœ‰çš„å•†å“æ•°é‡")withcol2:iflen(stores)>1:store_name_b=stores[1].get("display_name","åº—é“ºB")st.metric(f"{store_name_b}ç‹¬æœ‰å•†å“",f"{store_b_unique:,}",help=f"{store_name_b}ç‰¹æœ‰çš„å•†å“æ•°é‡")#åŒ¹é…ç»“æœå¯è§†åŒ–st.subheader("ğŸ“ˆåŒ¹é…ç»“æœåˆ†æ")#åŒ¹é…ç±»å‹åˆ†å¸ƒé¥¼å›¾iftotal_matches>0:col1,col2=st.columns(2)withcol1:#åŒ¹é…ç±»å‹åˆ†å¸ƒmatch_data={"åŒ¹é…ç±»å‹":["æ¡ç ç²¾ç¡®åŒ¹é…","åç§°æ¨¡ç³ŠåŒ¹é…"],"æ•°é‡":[barcode_matches,name_matches]}fig_match=px.pie(values=match_data["æ•°é‡"],names=match_data["åŒ¹é…ç±»å‹"],title="åŒ¹é…ç±»å‹åˆ†å¸ƒ",color_discrete_sequence=px.colors.qualitative.Set3)st.plotly_chart(fig_match,use_container_width=True)withcol2:#å•†å“åˆ†å¸ƒå¯¹æ¯”all_data={"ç±»åˆ«":["åŒ¹é…å•†å“",f"{store_name_a}ç‹¬æœ‰",f"{store_name_b}ç‹¬æœ‰"],"æ•°é‡":[total_matches,store_a_unique,store_b_unique]}fig_distribution=px.bar(x=all_data["ç±»åˆ«"],y=all_data["æ•°é‡"],title="å•†å“åˆ†å¸ƒå¯¹æ¯”",color=all_data["ç±»åˆ«"],color_discrete_sequence=px.colors.qualitative.Pastel)fig_distribution.update_layout(showlegend=False)st.plotly_chart(fig_distribution,use_container_width=True)#è¯¦ç»†Sheetæ•°æ®å±•ç¤ºst.subheader("ğŸ“‹è¯¦ç»†æ•°æ®æŸ¥çœ‹")sheets_data=price_panel_payload.get("sheets_data",{})sheet_names=price_panel_payload.get("sheet_names",[])ifsheets_data:#åˆ›å»ºSheeté€‰æ‹©å™¨selected_sheet=st.selectbox("é€‰æ‹©è¦æŸ¥çœ‹çš„æ•°æ®Sheet:",options=sheet_names,help="é€‰æ‹©ä¸åŒçš„SheetæŸ¥çœ‹è¯¦ç»†æ•°æ®å†…å®¹")ifselected_sheetandselected_sheetinsheets_data:df=sheets_data[selected_sheet]st.write(f"**{selected_sheet}**-å…±{len(df)}æ¡è®°å½•")iflen(df)>0:#æ˜¾ç¤ºå‰å‡ è¡Œæ•°æ®st.dataframe(df.head(20),use_container_width=True)#æä¾›ä¸‹è½½é€‰é¡¹csv_data=df.to_csv(index=False,encoding='utf-8-sig')st.download_button(label=f"ä¸‹è½½{selected_sheet}æ•°æ®(CSV)",data=csv_data,file_name=f"{selected_sheet}_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.csv",mime="text/csv",key=f"download_{selected_sheet}")else:st.info("æ­¤Sheetæš‚æ— æ•°æ®")#æ·»åŠ æ™ºèƒ½æ´å¯ŸæŠ¥å‘Šç”ŸæˆæŒ‰é’®st.markdown("---")ifst.button("ğŸ¯ç”Ÿæˆæ™ºèƒ½æ´å¯ŸæŠ¥å‘Š",help="åŸºäºå½“å‰æ•°æ®ç”Ÿæˆè¯¦ç»†çš„æ¯”ä»·åˆ†ææŠ¥å‘Š"):generate_insight_report(price_panel_payload)#æ–°å¢é«˜çº§åˆ†ææ¨¡å—st.markdown("---")render_advanced_price_analysis(price_panel_payload)#è­¦å‘Šä¿¡æ¯warnings=price_panel_payload.get("warnings",[])ifwarnings:st.subheader("âš ï¸æ³¨æ„äº‹é¡¹")forwarninginwarnings:st.warning(warning)exceptExceptionase:st.error(f"æ¸²æŸ“æ¯”ä»·åˆ†ææ—¶å‡ºé”™:{str(e)}")importtracebackst.error(f"è¯¦ç»†é”™è¯¯:{traceback.format_exc()}")defrender_advanced_price_analysis(price_panel_payload:Dict[str,Any])->None:"""æ¸²æŸ“é«˜çº§æ¯”ä»·åˆ†ææ¨¡å—"""st.subheader("ğŸ¯é«˜çº§ä»·æ ¼åˆ†æ")sheets_data=price_panel_payload.get("sheets_data",{})stores=price_panel_payload.get("stores",[])ifnotsheets_data:st.info("æš‚æ— è¯¦ç»†æ•°æ®ï¼Œæ— æ³•è¿›è¡Œé«˜çº§åˆ†æ")return#è·å–åŒ¹é…æ•°æ®barcode_matches=sheets_data.get('1-æ¡ç ç²¾ç¡®åŒ¹é…',pd.DataFrame())name_matches=sheets_data.get('2-åç§°æ¨¡ç³ŠåŒ¹é…(æ— æ¡ç )',pd.DataFrame())#åˆå¹¶åŒ¹é…æ•°æ®all_matches=pd.DataFrame()ifnotbarcode_matches.empty:barcode_matches['åŒ¹é…ç±»å‹']='æ¡ç ç²¾ç¡®åŒ¹é…'all_matches=pd.concat([all_matches,barcode_matches],ignore_index=True)ifnotname_matches.empty:name_matches['åŒ¹é…ç±»å‹']='åç§°æ¨¡ç³ŠåŒ¹é…'all_matches=pd.concat([all_matches,name_matches],ignore_index=True)ifall_matches.empty:st.info("æš‚æ— åŒ¹é…æ•°æ®ï¼Œæ— æ³•è¿›è¡Œä»·æ ¼åˆ†æ")return#åˆ›å»ºåˆ†æé€‰é¡¹å¡analysis_tabs=st.tabs(["ğŸ’°ä»·æ ¼ç«äº‰åŠ›çƒ­åŠ›å›¾","ğŸ“Šä»·æ ¼åˆ†å±‚åˆ†æ","ğŸ¯åŒ¹é…è´¨é‡åˆ†æ","ğŸ“ˆåº“å­˜-ä»·æ ¼å…³ç³»","ğŸ†ç«äº‰ä¼˜åŠ¿åˆ†æ"])withanalysis_tabs[0]:render_price_competitiveness_heatmap(all_matches,stores)withanalysis_tabs[1]:render_price_tier_analysis(all_matches,stores)withanalysis_tabs[2]:render_match_quality_analysis(all_matches,price_panel_payload)withanalysis_tabs[3]:render_inventory_price_analysis(all_matches,stores)withanalysis_tabs[4]:render_competitive_advantage_analysis(all_matches,sheets_data,stores)defrender_price_competitiveness_heatmap(all_matches:pd.DataFrame,stores:List[Dict])->None:"""æ¸²æŸ“ä»·æ ¼ç«äº‰åŠ›çƒ­åŠ›å›¾"""st.write("**ğŸ’°æŒ‰å•†å“åˆ†ç±»çš„ä»·æ ¼ç«äº‰åŠ›çƒ­åŠ›å›¾**")try:#å¯»æ‰¾ä»·æ ¼åˆ—price_cols=[colforcolinall_matches.columnsif'å”®ä»·'incolor'ä»·æ ¼'incol]category_cols=[colforcolinall_matches.columnsif'åˆ†ç±»'incol]iflen(price_cols)<2ornotcategory_cols:st.info("æ•°æ®ä¸­ç¼ºå°‘ä»·æ ¼æˆ–åˆ†ç±»ä¿¡æ¯ï¼Œæ— æ³•ç”Ÿæˆçƒ­åŠ›å›¾")returnprice_col_a=price_cols[0]price_col_b=price_cols[1]iflen(price_cols)>1elseprice_cols[0]category_col=category_cols[0]#è®¡ç®—ä»·æ ¼ä¼˜åŠ¿all_matches=all_matches.copy()all_matches['ä»·æ ¼å·®å¼‚']=pd.to_numeric(all_matches[price_col_a],errors='coerce')-pd.to_numeric(all_matches[price_col_b],errors='coerce')all_matches['ä»·æ ¼ä¼˜åŠ¿ç‡']=(all_matches['ä»·æ ¼å·®å¼‚']/pd.to_numeric(all_matches[price_col_b],errors='coerce'))*100#å®šä¹‰ä»·æ ¼åŒºé—´all_matches['ä»·æ ¼åŒºé—´']=pd.cut(pd.to_numeric(all_matches[price_col_a],errors='coerce'),bins=[0,10,30,50,100,float('inf')],labels=['ä½ä»·(<10å…ƒ)','ä¸­ä½ä»·(10-30å…ƒ)','ä¸­ä»·(30-50å…ƒ)','ä¸­é«˜ä»·(50-100å…ƒ)','é«˜ä»·(>100å…ƒ)'])#æŒ‰åˆ†ç±»å’Œä»·æ ¼åŒºé—´èšåˆheatmap_data=all_matches.groupby([category_col,'ä»·æ ¼åŒºé—´']).agg({'ä»·æ ¼ä¼˜åŠ¿ç‡':'mean',price_col_a:'count'}).reset_index()#åˆ›å»ºé€è§†è¡¨ç”¨äºçƒ­åŠ›å›¾pivot_data=heatmap_data.pivot(index=category_col,columns='ä»·æ ¼åŒºé—´',values='ä»·æ ¼ä¼˜åŠ¿ç‡')ifnotpivot_data.empty:fig=px.imshow(pivot_data.values,x=pivot_data.columns,y=pivot_data.index,color_continuous_scale='RdYlGn',title="ä»·æ ¼ç«äº‰åŠ›çƒ­åŠ›å›¾(ç»¿è‰²=æœ‰ä¼˜åŠ¿ï¼Œçº¢è‰²=å¤„åŠ£åŠ¿)",labels={'color':'ä»·æ ¼ä¼˜åŠ¿ç‡(%)'})fig.update_layout(height=max(400,len(pivot_data.index)*30),xaxis_title="ä»·æ ¼åŒºé—´",yaxis_title="å•†å“åˆ†ç±»")st.plotly_chart(fig,use_container_width=True)#æ˜¾ç¤ºæ•°æ®è¡¨withst.expander("ğŸ“Šè¯¦ç»†æ•°æ®"):display_data=heatmap_data.copy()display_data['ä»·æ ¼ä¼˜åŠ¿ç‡']=display_data['ä»·æ ¼ä¼˜åŠ¿ç‡'].round(2)display_data=display_data.rename(columns={price_col_a:'å•†å“æ•°é‡'})st.dataframe(display_data,use_container_width=True)else:st.info("æ•°æ®ä¸è¶³ä»¥ç”Ÿæˆçƒ­åŠ›å›¾")exceptExceptionase:st.error(f"ç”Ÿæˆä»·æ ¼ç«äº‰åŠ›çƒ­åŠ›å›¾æ—¶å‡ºé”™:{str(e)}")defrender_price_tier_analysis(all_matches:pd.DataFrame,stores:List[Dict])->None:"""æ¸²æŸ“ä»·æ ¼åˆ†å±‚åˆ†æ"""st.write("**ğŸ“Šä»·æ ¼åˆ†å±‚ç«äº‰åˆ†æ**")try:price_cols=[colforcolinall_matches.columnsif'å”®ä»·'incolor'ä»·æ ¼'incol]iflen(price_cols)<2:st.info("æ•°æ®ä¸­ç¼ºå°‘è¶³å¤Ÿçš„ä»·æ ¼ä¿¡æ¯")returnprice_col_a=price_cols[0]price_col_b=price_cols[1]#æ•°æ®å¤„ç†df=all_matches.copy()df[price_col_a]=pd.to_numeric(df[price_col_a],errors='coerce')df[price_col_b]=pd.to_numeric(df[price_col_b],errors='coerce')df=df.dropna(subset=[price_col_a,price_col_b])#å®šä¹‰ä»·æ ¼åˆ†å±‚df['ä»·æ ¼åˆ†å±‚_A']=pd.cut(df[price_col_a],bins=[0,10,30,50,100,float('inf')],labels=['ä½ä»·','ä¸­ä½ä»·','ä¸­ä»·','ä¸­é«˜ä»·','é«˜ä»·'])df['ä»·æ ¼åˆ†å±‚_B']=pd.cut(df[price_col_b],bins=[0,10,30,50,100,float('inf')],labels=['ä½ä»·','ä¸­ä½ä»·','ä¸­ä»·','ä¸­é«˜ä»·','é«˜ä»·'])col1,col2=st.columns(2)withcol1:#ä»·æ ¼åˆ†å±‚åˆ†å¸ƒå¯¹æ¯”tier_counts_a=df['ä»·æ ¼åˆ†å±‚_A'].value_counts()tier_counts_b=df['ä»·æ ¼åˆ†å±‚_B'].value_counts()fig=go.Figure()store_name_a=stores[0].get('display_name','åº—é“ºA')ifstoreselse'åº—é“ºA'store_name_b=stores[1].get('display_name','åº—é“ºB')iflen(stores)>1else'åº—é“ºB'fig.add_trace(go.Bar(name=store_name_a,x=tier_counts_a.index,y=tier_counts_a.values,marker_color='lightblue'))fig.add_trace(go.Bar(name=store_name_b,x=tier_counts_b.index,y=tier_counts_b.values,marker_color='lightcoral'))fig.update_layout(title='ä»·æ ¼åˆ†å±‚åˆ†å¸ƒå¯¹æ¯”',xaxis_title='ä»·æ ¼åˆ†å±‚',yaxis_title='å•†å“æ•°é‡',barmode='group')st.plotly_chart(fig,use_container_width=True)withcol2:#ä»·æ ¼å·®å¼‚ç®±çº¿å›¾df['ä»·æ ¼å·®å¼‚']=df[price_col_a]-df[price_col_b]fig=px.box(df,x='ä»·æ ¼åˆ†å±‚_A',y='ä»·æ ¼å·®å¼‚',title='å„ä»·æ ¼åˆ†å±‚çš„ä»·æ ¼å·®å¼‚åˆ†å¸ƒ',labels={'ä»·æ ¼åˆ†å±‚_A':'ä»·æ ¼åˆ†å±‚','ä»·æ ¼å·®å¼‚':'ä»·æ ¼å·®å¼‚(å…ƒ)'})fig.add_hline(y=0,line_dash="dash",line_color="red",annotation_text="ä»·æ ¼æŒå¹³çº¿")st.plotly_chart(fig,use_container_width=True)#ä»·æ ¼ä¼˜åŠ¿ç»Ÿè®¡st.write("**ğŸ“ˆä»·æ ¼ä¼˜åŠ¿ç»Ÿè®¡**")df['ä»·æ ¼ä¼˜åŠ¿']=df['ä»·æ ¼å·®å¼‚'].apply(lambdax:'æˆ‘æ–¹ä¼˜åŠ¿'ifx<0else'å¯¹æ‰‹ä¼˜åŠ¿'ifx>0else'ä»·æ ¼ç›¸ç­‰')advantage_stats=df.groupby(['ä»·æ ¼åˆ†å±‚_A','ä»·æ ¼ä¼˜åŠ¿']).size().unstack(fill_value=0)ifnotadvantage_stats.empty:#è®¡ç®—ä¼˜åŠ¿æ¯”ä¾‹advantage_pct=advantage_stats.div(advantage_stats.sum(axis=1),axis=0)*100fig=px.bar(advantage_pct.reset_index(),x='ä»·æ ¼åˆ†å±‚_A',y=['æˆ‘æ–¹ä¼˜åŠ¿','å¯¹æ‰‹ä¼˜åŠ¿','ä»·æ ¼ç›¸ç­‰']ifall(colinadvantage_pct.columnsforcolin['æˆ‘æ–¹ä¼˜åŠ¿','å¯¹æ‰‹ä¼˜åŠ¿','ä»·æ ¼ç›¸ç­‰'])elseadvantage_pct.columns,title='å„ä»·æ ¼åˆ†å±‚çš„ç«äº‰ä¼˜åŠ¿å æ¯”',labels={'value':'å æ¯”(%)','ä»·æ ¼åˆ†å±‚_A':'ä»·æ ¼åˆ†å±‚'})st.plotly_chart(fig,use_container_width=True)exceptExceptionase:st.error(f"ç”Ÿæˆä»·æ ¼åˆ†å±‚åˆ†ææ—¶å‡ºé”™:{str(e)}")defrender_match_quality_analysis(all_matches:pd.DataFrame,price_panel_payload:Dict[str,Any])->None:"""æ¸²æŸ“åŒ¹é…è´¨é‡åˆ†æ"""st.write("**ğŸ¯å•†å“åŒ¹é…è´¨é‡åˆ†æ**")try:col1,col2=st.columns(2)withcol1:#åŒ¹é…ç±»å‹è´¨é‡åˆ†å¸ƒif'åŒ¹é…ç±»å‹'inall_matches.columns:match_type_counts=all_matches['åŒ¹é…ç±»å‹'].value_counts()fig=px.pie(values=match_type_counts.values,names=match_type_counts.index,title="åŒ¹é…æ–¹å¼åˆ†å¸ƒ",color_discrete_sequence=['#2E8B57','#4682B4','#DC143C'])st.plotly_chart(fig,use_container_width=True)withcol2:#åŒ¹é…ç½®ä¿¡åº¦åˆ†æï¼ˆå¦‚æœæœ‰ç›¸ä¼¼åº¦æ•°æ®ï¼‰similarity_cols=[colforcolinall_matches.columnsif'ç›¸ä¼¼åº¦'incolor'ç½®ä¿¡åº¦'incolor'similarity'incol.lower()]ifsimilarity_cols:similarity_col=similarity_cols[0]similarity_data=pd.to_numeric(all_matches[similarity_col],errors='coerce').dropna()ifnotsimilarity_data.empty:fig=px.histogram(x=similarity_data,title="åŒ¹é…ç½®ä¿¡åº¦åˆ†å¸ƒ",labels={'x':'ç½®ä¿¡åº¦','y':'å•†å“æ•°é‡'},nbins=20)fig.add_vline(x=0.8,line_dash="dash",line_color="green",annotation_text="é«˜è´¨é‡åŒ¹é…çº¿(0.8)")fig.add_vline(x=0.6,line_dash="dash",line_color="orange",annotation_text="ä¸­ç­‰è´¨é‡åŒ¹é…çº¿(0.6)")st.plotly_chart(fig,use_container_width=True)else:st.info("æš‚æ— æœ‰æ•ˆçš„ç½®ä¿¡åº¦æ•°æ®")else:#åŸºäºåŒ¹é…ç±»å‹çš„è´¨é‡è¯„ä¼°quality_map={'æ¡ç ç²¾ç¡®åŒ¹é…':'é«˜è´¨é‡','åç§°æ¨¡ç³ŠåŒ¹é…':'ä¸­ç­‰è´¨é‡'}all_matches['åŒ¹é…è´¨é‡']=all_matches['åŒ¹é…ç±»å‹'].map(quality_map)quality_counts=all_matches['åŒ¹é…è´¨é‡'].value_counts()fig=px.bar(x=quality_counts.index,y=quality_counts.values,title="åŒ¹é…è´¨é‡åˆ†å¸ƒ",color=quality_counts.values,color_continuous_scale='Viridis')st.plotly_chart(fig,use_container_width=True)#æœªåŒ¹é…åŸå› åˆ†æst.write("**ğŸ“‹æœªåŒ¹é…å•†å“åˆ†æ**")sheets_data=price_panel_payload.get("sheets_data",{})#è·å–ç‹¬æœ‰å•†å“æ•°æ®unique_products=[]forsheet_name,dfinsheets_data.items():if'ç‹¬æœ‰å•†å“'insheet_nameandnotdf.empty:unique_products.append({'sheet':sheet_name,'count':len(df),'store':sheet_name.split('-')[1]if'-'insheet_nameelsesheet_name})ifunique_products:unique_df=pd.DataFrame(unique_products)fig=px.bar(unique_df,x='store',y='count',title='å„åº—é“ºç‹¬æœ‰å•†å“æ•°é‡',color='count',color_continuous_scale='Reds')st.plotly_chart(fig,use_container_width=True)#æ˜¾ç¤ºæœªåŒ¹é…åŸå› åˆ†æwithst.expander("ğŸ”å¯èƒ½çš„æœªåŒ¹é…åŸå› "):st.markdown("""**å¸¸è§æœªåŒ¹é…åŸå› ï¼š**-ğŸ·ï¸**å•†å“åç§°å·®å¼‚**ï¼šåŒä¸€å•†å“åœ¨ä¸åŒå¹³å°ä½¿ç”¨ä¸åŒåç§°-ğŸ“¦**è§„æ ¼æè¿°ä¸ä¸€è‡´**ï¼šåŒ…è£…è§„æ ¼ã€å®¹é‡æè¿°æ–¹å¼ä¸åŒ-ğŸª**ç‹¬å®¶å•†å“**ï¼šæŸåº—é“ºç‹¬æœ‰çš„å•†å“æˆ–å“ç‰Œ-ğŸ“Š**åˆ†ç±»ä½“ç³»å·®å¼‚**ï¼šä¸åŒå¹³å°çš„å•†å“åˆ†ç±»æ ‡å‡†ä¸åŒ-ğŸ”¢**æ¡ç ç¼ºå¤±**ï¼šéƒ¨åˆ†å•†å“ç¼ºå°‘æ ‡å‡†æ¡ç ä¿¡æ¯**å»ºè®®æ”¹è¿›æªæ–½ï¼š**-å®Œå–„å•†å“ä¸»æ•°æ®ç®¡ç†-ç»Ÿä¸€å•†å“å‘½åè§„èŒƒ-è¡¥å……ç¼ºå¤±çš„æ¡ç ä¿¡æ¯-å»ºç«‹åˆ†ç±»æ˜ å°„å…³ç³»""")exceptExceptionase:st.error(f"ç”ŸæˆåŒ¹é…è´¨é‡åˆ†ææ—¶å‡ºé”™:{str(e)}")defrender_inventory_price_analysis(all_matches:pd.DataFrame,stores:List[Dict])->None:"""æ¸²æŸ“åº“å­˜-ä»·æ ¼å…³ç³»åˆ†æ"""st.write("**ğŸ“ˆåº“å­˜ä¸ä»·æ ¼ç­–ç•¥åˆ†æ**")try:#å¯»æ‰¾åº“å­˜å’Œä»·æ ¼ç›¸å…³åˆ—inventory_cols=[colforcolinall_matches.columnsif'åº“å­˜'incolor'åº“å­˜é‡'incolor'stock'incol.lower()]price_cols=[colforcolinall_matches.columnsif'å”®ä»·'incolor'ä»·æ ¼'incol]sales_cols=[colforcolinall_matches.columnsif'é”€é‡'incolor'æœˆå”®'incolor'sales'incol.lower()]ifnotinventory_colsorlen(price_cols)<2:st.info("æ•°æ®ä¸­ç¼ºå°‘åº“å­˜æˆ–ä»·æ ¼ä¿¡æ¯ï¼Œæ— æ³•è¿›è¡Œåº“å­˜-ä»·æ ¼åˆ†æ")returninventory_col=inventory_cols[0]price_col_a=price_cols[0]price_col_b=price_cols[1]iflen(price_cols)>1elseprice_cols[0]#æ•°æ®å¤„ç†df=all_matches.copy()df[inventory_col]=pd.to_numeric(df[inventory_col],errors='coerce')df[price_col_a]=pd.to_numeric(df[price_col_a],errors='coerce')df[price_col_b]=pd.to_numeric(df[price_col_b],errors='coerce')df=df.dropna(subset=[inventory_col,price_col_a,price_col_b])ifdf.empty:st.info("å¤„ç†åæ— æœ‰æ•ˆæ•°æ®")returndf['ä»·æ ¼å·®å¼‚']=df[price_col_a]-df[price_col_b]col1,col2=st.columns(2)withcol1:#åº“å­˜-ä»·æ ¼æ•£ç‚¹å›¾fig=px.scatter(df,x=inventory_col,y=price_col_a,size='ä»·æ ¼å·®å¼‚'if'ä»·æ ¼å·®å¼‚'indf.columnselseNone,color='ä»·æ ¼å·®å¼‚',title='åº“å­˜é‡ä¸ä»·æ ¼å…³ç³»',labels={inventory_col:'åº“å­˜é‡',price_col_a:'æˆ‘æ–¹ä»·æ ¼(å…ƒ)'},color_continuous_scale='RdYlGn_r')st.plotly_chart(fig,use_container_width=True)withcol2:#åº“å­˜é¢„è­¦åˆ†æifsales_cols:sales_col=sales_cols[0]df[sales_col]=pd.to_numeric(df[sales_col],errors='coerce')df=df.dropna(subset=[sales_col])#è®¡ç®—åº“é”€æ¯”df['åº“é”€æ¯”']=df[inventory_col]/(df[sales_col]+1)#+1é¿å…é™¤é›¶#å®šä¹‰é¢„è­¦ç­‰çº§defget_warning_level(row):ifrow['åº“é”€æ¯”']<0.5:return'é«˜é£é™©'elifrow['åº“é”€æ¯”']<1.0:return'ä¸­é£é™©'elifrow['åº“é”€æ¯”']<2.0:return'ä½é£é™©'else:return'å®‰å…¨'df['é¢„è­¦ç­‰çº§']=df.apply(get_warning_level,axis=1)warning_counts=df['é¢„è­¦ç­‰çº§'].value_counts()fig=px.pie(values=warning_counts.values,names=warning_counts.index,title="åº“å­˜é¢„è­¦ç­‰çº§åˆ†å¸ƒ",color_discrete_map={'é«˜é£é™©':'#DC143C','ä¸­é£é™©':'#FF8C00','ä½é£é™©':'#32CD32','å®‰å…¨':'#228B22'})st.plotly_chart(fig,use_container_width=True)else:#åº“å­˜æ°´å¹³åˆ†å¸ƒdf['åº“å­˜æ°´å¹³']=pd.cut(df[inventory_col],bins=[0,10,50,100,500,float('inf')],labels=['æä½åº“å­˜','ä½åº“å­˜','ä¸­ç­‰åº“å­˜','é«˜åº“å­˜','è¿‡é‡åº“å­˜'])inventory_dist=df['åº“å­˜æ°´å¹³'].value_counts()fig=px.bar(x=inventory_dist.index,y=inventory_dist.values,title='åº“å­˜æ°´å¹³åˆ†å¸ƒ',color=inventory_dist.values,color_continuous_scale='Blues')st.plotly_chart(fig,use_container_width=True)#é«˜é£é™©å•†å“æé†’ifsales_colsand'é¢„è­¦ç­‰çº§'indf.columns:high_risk_products=df[df['é¢„è­¦ç­‰çº§']=='é«˜é£é™©']ifnothigh_risk_products.empty:st.warning(f"âš ï¸å‘ç°{len(high_risk_products)}ä¸ªé«˜é£é™©å•†å“ï¼ˆåº“å­˜ä¸è¶³ï¼‰")withst.expander("æŸ¥çœ‹é«˜é£é™©å•†å“è¯¦æƒ…"):risk_display=high_risk_products[['å•†å“åç§°',inventory_col,sales_col,'åº“é”€æ¯”','ä»·æ ¼å·®å¼‚']].copy()if'å•†å“åç§°'inhigh_risk_products.columnselsehigh_risk_products[[inventory_col,sales_col,'åº“é”€æ¯”','ä»·æ ¼å·®å¼‚']].copy()risk_display=risk_display.round(2)st.dataframe(risk_display,use_container_width=True)exceptExceptionase:st.error(f"ç”Ÿæˆåº“å­˜-ä»·æ ¼åˆ†ææ—¶å‡ºé”™:{str(e)}")defrender_competitive_advantage_analysis(all_matches:pd.DataFrame,sheets_data:Dict,stores:List[Dict])->None:"""æ¸²æŸ“ç«äº‰ä¼˜åŠ¿åˆ†æ"""st.write("**ğŸ†ç»¼åˆç«äº‰ä¼˜åŠ¿åˆ†æ**")try:price_cols=[colforcolinall_matches.columnsif'å”®ä»·'incolor'ä»·æ ¼'incol]iflen(price_cols)<2:st.info("æ•°æ®ä¸­ç¼ºå°‘è¶³å¤Ÿçš„ä»·æ ¼ä¿¡æ¯")returnprice_col_a=price_cols[0]price_col_b=price_cols[1]#æ•°æ®å¤„ç†df=all_matches.copy()df[price_col_a]=pd.to_numeric(df[price_col_a],errors='coerce')df[price_col_b]=pd.to_numeric(df[price_col_b],errors='coerce')df=df.dropna(subset=[price_col_a,price_col_b])#è®¡ç®—ç«äº‰æŒ‡æ ‡df['ä»·æ ¼å·®å¼‚']=df[price_col_a]-df[price_col_b]df['ä»·æ ¼ä¼˜åŠ¿ç‡']=(df['ä»·æ ¼å·®å¼‚']/df[price_col_b])*100store_name_a=stores[0].get('display_name','åº—é“ºA')ifstoreselse'åº—é“ºA'store_name_b=stores[1].get('display_name','åº—é“ºB')iflen(stores)>1else'åº—é“ºB'col1,col2=st.columns(2)withcol1:#ä»·æ ¼ä¼˜åŠ¿åˆ†å¸ƒdf['ç«äº‰çŠ¶æ€']=df['ä»·æ ¼ä¼˜åŠ¿ç‡'].apply(lambdax:f'{store_name_a}æ˜¾è‘—ä¼˜åŠ¿'ifx<-10elsef'{store_name_a}è½»å¾®ä¼˜åŠ¿'ifx<0else'ä»·æ ¼ç›¸å½“'ifabs(x)<5elsef'{store_name_b}è½»å¾®ä¼˜åŠ¿'ifx<10elsef'{store_name_b}æ˜¾è‘—ä¼˜åŠ¿')competitive_dist=df['ç«äº‰çŠ¶æ€'].value_counts()colors={f'{store_name_a}æ˜¾è‘—ä¼˜åŠ¿':'#228B22',f'{store_name_a}è½»å¾®ä¼˜åŠ¿':'#90EE90','ä»·æ ¼ç›¸å½“':'#FFD700',f'{store_name_b}è½»å¾®ä¼˜åŠ¿':'#FFA07A',f'{store_name_b}æ˜¾è‘—ä¼˜åŠ¿':'#DC143C'}fig=px.pie(values=competitive_dist.values,names=competitive_dist.index,title='ç«äº‰ä¼˜åŠ¿åˆ†å¸ƒ',color=competitive_dist.index,color_discrete_map=colors)st.plotly_chart(fig,use_container_width=True)withcol2:#åˆ†ç±»åˆ«ç«äº‰ä¼˜åŠ¿category_cols=[colforcolindf.columnsif'åˆ†ç±»'incol]ifcategory_cols:category_col=category_cols[0]category_advantage=df.groupby(category_col).agg({'ä»·æ ¼ä¼˜åŠ¿ç‡':'mean',price_col_a:'count'}).reset_index()category_advantage=category_advantage.rename(columns={price_col_a:'å•†å“æ•°é‡'})category_advantage['ä¼˜åŠ¿æ–¹']=category_advantage['ä»·æ ¼ä¼˜åŠ¿ç‡'].apply(lambdax:store_name_aifx<0elsestore_name_b)fig=px.bar(category_advantage,x=category_col,y='ä»·æ ¼ä¼˜åŠ¿ç‡',color='ä¼˜åŠ¿æ–¹',title='å„åˆ†ç±»ä»·æ ¼ä¼˜åŠ¿å¯¹æ¯”',color_discrete_map={store_name_a:'#1f77b4',store_name_b:'#ff7f0e'})fig.add_hline(y=0,line_dash="dash",line_color="black",annotation_text="å¹³è¡¡çº¿")st.plotly_chart(fig,use_container_width=True)else:#ä»·æ ¼ä¼˜åŠ¿ç‡åˆ†å¸ƒç›´æ–¹å›¾fig=px.histogram(df,x='ä»·æ ¼ä¼˜åŠ¿ç‡',title='ä»·æ ¼ä¼˜åŠ¿ç‡åˆ†å¸ƒ',labels={'ä»·æ ¼ä¼˜åŠ¿ç‡':'ä»·æ ¼ä¼˜åŠ¿ç‡(%)','count':'å•†å“æ•°é‡'},nbins=30)fig.add_vline(x=0,line_dash="dash",line_color="black",annotation_text="å¹³è¡¡çº¿")fig.add_vline(x=-10,line_dash="dash",line_color="green",annotation_text="æ˜¾è‘—ä¼˜åŠ¿çº¿")fig.add_vline(x=10,line_dash="dash",line_color="red",annotation_text="æ˜¾è‘—åŠ£åŠ¿çº¿")st.plotly_chart(fig,use_container_width=True)#ç«äº‰ç­–ç•¥å»ºè®®st.subheader("ğŸ’¡ç«äº‰ç­–ç•¥å»ºè®®")#è®¡ç®—å…³é”®æŒ‡æ ‡total_products=len(df)our_advantage=len(df[df['ä»·æ ¼ä¼˜åŠ¿ç‡']<-5])competitor_advantage=len(df[df['ä»·æ ¼ä¼˜åŠ¿ç‡']>5])similar_price=total_products-our_advantage-competitor_advantageour_advantage_rate=our_advantage/total_products*100competitor_advantage_rate=competitor_advantage/total_products*100col1,col2,col3=st.columns(3)withcol1:st.metric(f"{store_name_a}ä¼˜åŠ¿å•†å“",f"{our_advantage}ä¸ª",delta=f"{our_advantage_rate:.1f}%",delta_color="normal")withcol2:st.metric("ä»·æ ¼ç›¸å½“å•†å“",f"{similar_price}ä¸ª",delta=f"{similar_price/total_products*100:.1f}%",delta_color="off")withcol3:st.metric(f"{store_name_b}ä¼˜åŠ¿å•†å“",f"{competitor_advantage}ä¸ª",delta=f"{competitor_advantage_rate:.1f}%",delta_color="inverse")#ç­–ç•¥å»ºè®®ifour_advantage_rate>50:st.success(f"ğŸ‰æ•´ä½“ä»·æ ¼ç«äº‰åŠ›è¾ƒå¼ºï¼åœ¨{our_advantage_rate:.1f}%çš„å•†å“ä¸Šå…·æœ‰ä»·æ ¼ä¼˜åŠ¿")elifour_advantage_rate>30:st.info(f"ğŸ’ªä»·æ ¼ç«äº‰åŠ›ä¸­ç­‰ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨{store_name_b}ä¼˜åŠ¿å•†å“çš„å®šä»·ç­–ç•¥")else:st.warning(f"âš ï¸ä»·æ ¼ç«äº‰åŠ›è¾ƒå¼±ï¼Œå»ºè®®å…¨é¢å®¡è§†å®šä»·ç­–ç•¥ï¼Œç‰¹åˆ«æ˜¯{competitor_advantage}ä¸ªåŠ£åŠ¿å•†å“")#å…·ä½“å»ºè®®withst.expander("ğŸ“‹è¯¦ç»†ç­–ç•¥å»ºè®®"):ifour_advantage_rate>40:st.markdown(f"""**ğŸ¯ç»´æŒä¼˜åŠ¿ç­–ç•¥ï¼š**-ä¿æŒç°æœ‰{our_advantage}ä¸ªä¼˜åŠ¿å•†å“çš„ä»·æ ¼ç«äº‰åŠ›-é€‚å½“æå‡ä¼˜åŠ¿å•†å“çš„æ¯›åˆ©ç‡-é‡ç‚¹æ¨å¹¿ä»·æ ¼ä¼˜åŠ¿å•†å“ï¼Œæå‡é”€é‡""")ifcompetitor_advantage>0:st.markdown(f"""**âš¡åŠ£åŠ¿æ”¹è¿›ç­–ç•¥ï¼š**-ç´§æ€¥è°ƒæ•´{competitor_advantage}ä¸ªåŠ£åŠ¿å•†å“å®šä»·-åˆ†ææˆæœ¬ç»“æ„ï¼Œå¯»æ‰¾é™ä»·ç©ºé—´-è€ƒè™‘æ†ç»‘é”€å”®æˆ–ä¿ƒé”€æ´»åŠ¨""")ifsimilar_price>0:st.markdown(f"""**ğŸ”„å‡åŠ¿å•†å“ç­–ç•¥ï¼š**-é€šè¿‡æœåŠ¡å·®å¼‚åŒ–è·å¾—ç«äº‰ä¼˜åŠ¿-è€ƒè™‘å°å¹…è°ƒä»·æµ‹è¯•å¸‚åœºååº”-å…³æ³¨åº“å­˜å’Œé”€é‡æƒ…å†µï¼Œä¼˜åŒ–å•†å“ç»„åˆ""")exceptExceptionase:st.error(f"ç”Ÿæˆç«äº‰ä¼˜åŠ¿åˆ†ææ—¶å‡ºé”™:{str(e)}")defgenerate_insight_report(price_panel_payload:Dict[str,Any])->None:"""ç”Ÿæˆæ™ºèƒ½æ´å¯ŸæŠ¥å‘Š"""try:st.subheader("ğŸ¯æ™ºèƒ½æ´å¯ŸæŠ¥å‘Š")sheets_data=price_panel_payload.get("sheets_data",{})stores=price_panel_payload.get("stores",[])metrics=price_panel_payload.get("metrics",[])summary=price_panel_payload.get("summary",{})#è·å–åŸºç¡€æ•°æ®barcode_matches=sheets_data.get('1-æ¡ç ç²¾ç¡®åŒ¹é…',pd.DataFrame())name_matches=sheets_data.get('2-åç§°æ¨¡ç³ŠåŒ¹é…(æ— æ¡ç )',pd.DataFrame())store_name_a=stores[0].get('display_name','åº—é“ºA')ifstoreselse'åº—é“ºA'store_name_b=stores[1].get('display_name','åº—é“ºB')iflen(stores)>1else'åº—é“ºB'#åˆå¹¶åŒ¹é…æ•°æ®è¿›è¡Œåˆ†æall_matches=pd.DataFrame()ifnotbarcode_matches.empty:all_matches=pd.concat([all_matches,barcode_matches],ignore_index=True)ifnotname_matches.empty:all_matches=pd.concat([all_matches,name_matches],ignore_index=True)report_content=[]#1.æ‰§è¡Œæ‘˜è¦report_content.append("##ğŸ“‹æ‰§è¡Œæ‘˜è¦")total_matches=len(all_matches)barcode_match_count=len(barcode_matches)name_match_count=len(name_matches)coverage=summary.get("comparison_coverage",0)report_content.append(f"""**æ¯”ä»·æ¦‚å†µï¼š**-æˆåŠŸåŒ¹é…å•†å“**{total_matches:,}**ä¸ªï¼Œè¦†ç›–ç‡**{coverage:.1%}**-æ¡ç ç²¾ç¡®åŒ¹é…**{barcode_match_count:,}**ä¸ªï¼Œåç§°æ¨¡ç³ŠåŒ¹é…**{name_match_count:,}**ä¸ª-æ•°æ®è´¨é‡è¯„ä¼°ï¼š{'ä¼˜ç§€'ifcoverage>0.8else'è‰¯å¥½'ifcoverage>0.6else'å¾…æ”¹å–„'}""")#2.ä»·æ ¼ç«äº‰åŠ›åˆ†æifnotall_matches.empty:price_cols=[colforcolinall_matches.columnsif'å”®ä»·'incolor'ä»·æ ¼'incol]iflen(price_cols)>=2:price_col_a=price_cols[0]price_col_b=price_cols[1]#ä»·æ ¼åˆ†ædf=all_matches.copy()df[price_col_a]=pd.to_numeric(df[price_col_a],errors='coerce')df[price_col_b]=pd.to_numeric(df[price_col_b],errors='coerce')df=df.dropna(subset=[price_col_a,price_col_b])ifnotdf.empty:df['ä»·æ ¼å·®å¼‚']=df[price_col_a]-df[price_col_b]df['ä»·æ ¼ä¼˜åŠ¿ç‡']=(df['ä»·æ ¼å·®å¼‚']/df[price_col_b])*100our_advantage_count=len(df[df['ä»·æ ¼ä¼˜åŠ¿ç‡']<-5])competitor_advantage_count=len(df[df['ä»·æ ¼ä¼˜åŠ¿ç‡']>5])similar_price_count=len(df)-our_advantage_count-competitor_advantage_countour_advantage_rate=our_advantage_count/len(df)*100avg_price_advantage=df['ä»·æ ¼ä¼˜åŠ¿ç‡'].mean()report_content.append("##ğŸ’°ä»·æ ¼ç«äº‰åŠ›åˆ†æ")competitive_status=""ifour_advantage_rate>50:competitive_status="ğŸŸ¢**ä»·æ ¼ç«äº‰åŠ›å¼º**"elifour_advantage_rate>30:competitive_status="ğŸŸ¡**ä»·æ ¼ç«äº‰åŠ›ä¸­ç­‰**"else:competitive_status="ğŸ”´**ä»·æ ¼ç«äº‰åŠ›è¾ƒå¼±**"report_content.append(f"""**ç«äº‰åŠ›è¯„ä¼°ï¼š**{competitive_status}**è¯¦ç»†æŒ‡æ ‡ï¼š**-{store_name_a}ä¼˜åŠ¿å•†å“ï¼š**{our_advantage_count:,}**ä¸ª({our_advantage_rate:.1f}%)-{store_name_b}ä¼˜åŠ¿å•†å“ï¼š**{competitor_advantage_count:,}**ä¸ª({competitor_advantage_count/len(df)*100:.1f}%)-ä»·æ ¼ç›¸å½“å•†å“ï¼š**{similar_price_count:,}**ä¸ª({similar_price_count/len(df)*100:.1f}%)-å¹³å‡ä»·æ ¼ä¼˜åŠ¿ç‡ï¼š**{avg_price_advantage:.1f}%**{'(æˆ‘æ–¹å ä¼˜)'ifavg_price_advantage<0else'(å¯¹æ‰‹å ä¼˜)'ifavg_price_advantage>0else'(åŠ¿å‡åŠ›æ•Œ)'}""")#3.åˆ†ç±»ç«äº‰åˆ†æifnotall_matches.empty:category_cols=[colforcolinall_matches.columnsif'åˆ†ç±»'incol]ifcategory_colsandlen(price_cols)>=2:category_col=category_cols[0]category_analysis=df.groupby(category_col).agg({'ä»·æ ¼ä¼˜åŠ¿ç‡':['mean','count'],price_col_a:'mean'}).round(2)category_analysis.columns=['å¹³å‡ä¼˜åŠ¿ç‡','å•†å“æ•°é‡','å¹³å‡ä»·æ ¼']category_analysis=category_analysis.reset_index()category_analysis['ç«äº‰çŠ¶æ€']=category_analysis['å¹³å‡ä¼˜åŠ¿ç‡'].apply(lambdax:f'{store_name_a}ä¼˜åŠ¿'ifx<-5elsef'{store_name_b}ä¼˜åŠ¿'ifx>5else'åŠ¿å‡åŠ›æ•Œ')report_content.append("##ğŸ“Šåˆ†ç±»ç«äº‰åˆ†æ")#æ‰¾å‡ºä¼˜åŠ¿å’ŒåŠ£åŠ¿åˆ†ç±»our_advantage_categories=category_analysis[category_analysis['å¹³å‡ä¼˜åŠ¿ç‡']<-5]competitor_advantage_categories=category_analysis[category_analysis['å¹³å‡ä¼˜åŠ¿ç‡']>5]ifnotour_advantage_categories.empty:report_content.append(f"""**ğŸŸ¢{store_name_a}ä¼˜åŠ¿åˆ†ç±»ï¼š**""")for_,rowinour_advantage_categories.iterrows():report_content.append(f"-**{row[category_col]}**ï¼šä¼˜åŠ¿ç‡{row['å¹³å‡ä¼˜åŠ¿ç‡']:.1f}%ï¼Œ{row['å•†å“æ•°é‡']}ä¸ªå•†å“")ifnotcompetitor_advantage_categories.empty:report_content.append(f"""**ğŸ”´{store_name_b}ä¼˜åŠ¿åˆ†ç±»ï¼š**""")for_,rowincompetitor_advantage_categories.iterrows():report_content.append(f"-**{row[category_col]}**ï¼šåŠ£åŠ¿{row['å¹³å‡ä¼˜åŠ¿ç‡']:.1f}%ï¼Œ{row['å•†å“æ•°é‡']}ä¸ªå•†å“")#4.åº“å­˜é£é™©é¢„è­¦inventory_cols=[colforcolinall_matches.columnsif'åº“å­˜'incol]sales_cols=[colforcolinall_matches.columnsif'é”€é‡'incolor'æœˆå”®'incol]ifinventory_colsandsales_cols:inventory_col=inventory_cols[0]sales_col=sales_cols[0]df[inventory_col]=pd.to_numeric(df[inventory_col],errors='coerce')df[sales_col]=pd.to_numeric(df[sales_col],errors='coerce')inventory_df=df.dropna(subset=[inventory_col,sales_col])ifnotinventory_df.empty:inventory_df['åº“é”€æ¯”']=inventory_df[inventory_col]/(inventory_df[sales_col]+1)high_risk_products=inventory_df[inventory_df['åº“é”€æ¯”']<0.5]low_inventory_products=inventory_df[inventory_df[inventory_col]<10]ifnothigh_risk_products.emptyornotlow_inventory_products.empty:report_content.append("##âš ï¸åº“å­˜é£é™©é¢„è­¦")ifnothigh_risk_products.empty:report_content.append(f"""**ğŸ”´é«˜é£é™©å•†å“ï¼ˆåº“é”€æ¯”<0.5ï¼‰ï¼š**{len(high_risk_products)}ä¸ª-å»ºè®®ç«‹å³è¡¥è´§æˆ–è°ƒæ•´é”€å”®ç­–ç•¥""")ifnotlow_inventory_products.empty:report_content.append(f"""**ğŸŸ¡ä½åº“å­˜å•†å“ï¼ˆåº“å­˜<10ï¼‰ï¼š**{len(low_inventory_products)}ä¸ª-å»ºè®®å…³æ³¨é”€å”®æƒ…å†µï¼ŒåŠæ—¶è¡¥è´§""")#5.ç­–ç•¥å»ºè®®report_content.append("##ğŸ’¡ç­–ç•¥å»ºè®®")suggestions=[]ifnotall_matches.emptyandlen(price_cols)>=2:ifour_advantage_rate>50:suggestions.append("ğŸ¯**ç»´æŒä¼˜åŠ¿ç­–ç•¥**ï¼šä¿æŒç°æœ‰ä»·æ ¼ä¼˜åŠ¿ï¼Œé‡ç‚¹æ¨å¹¿ä¼˜åŠ¿å•†å“")suggestions.append("ğŸ“ˆ**æå‡ç›ˆåˆ©**ï¼šé€‚å½“æå‡ä¼˜åŠ¿å•†å“æ¯›åˆ©ç‡ï¼Œå¢åŠ æ•´ä½“æ”¶ç›Š")elifour_advantage_rate>30:suggestions.append("âš¡**é‡ç‚¹æ”¹è¿›**ï¼šå…³æ³¨å¯¹æ‰‹ä¼˜åŠ¿å•†å“ï¼Œåˆ†ææˆæœ¬ç»“æ„å¯»æ‰¾é™ä»·ç©ºé—´")suggestions.append("ğŸ”„**å·®å¼‚åŒ–ç­–ç•¥**ï¼šé€šè¿‡æœåŠ¡ã€å“è´¨ç­‰éä»·æ ¼å› ç´ è·å¾—ç«äº‰ä¼˜åŠ¿")else:suggestions.append("ğŸš¨**ç´§æ€¥è°ƒæ•´**ï¼šå…¨é¢å®¡è§†å®šä»·ç­–ç•¥ï¼Œé‡ç‚¹è°ƒæ•´åŠ£åŠ¿å•†å“ä»·æ ¼")suggestions.append("ğŸ**ä¿ƒé”€æ´»åŠ¨**ï¼šè€ƒè™‘æ†ç»‘é”€å”®ã€é™æ—¶æŠ˜æ‰£ç­‰ä¿ƒé”€æ‰‹æ®µ")#åŒ¹é…è´¨é‡å»ºè®®ifbarcode_match_count<total_matches*0.6:suggestions.append("ğŸ“Š**æ•°æ®ä¼˜åŒ–**ï¼šå®Œå–„å•†å“æ¡ç ä¿¡æ¯ï¼Œæå‡åŒ¹é…å‡†ç¡®åº¦")ifcoverage<0.7:suggestions.append("ğŸ”**æ‰©å¤§è¦†ç›–**ï¼šå¢åŠ å•†å“å“ç±»ï¼Œå®Œå–„å•†å“ä¸»æ•°æ®ç®¡ç†")fori,suggestioninenumerate(suggestions,1):report_content.append(f"{i}.{suggestion}")#6.æ•°æ®è´¨é‡è¯„ä¼°report_content.append("##ğŸ“ˆæ•°æ®è´¨é‡è¯„ä¼°")quality_score=0quality_factors=[]#åŒ¹é…ç‡è¯„åˆ†ifcoverage>0.8:quality_score+=25quality_factors.append("âœ…åŒ¹é…è¦†ç›–ç‡ä¼˜ç§€")elifcoverage>0.6:quality_score+=15quality_factors.append("ğŸŸ¡åŒ¹é…è¦†ç›–ç‡è‰¯å¥½")else:quality_score+=5quality_factors.append("âŒåŒ¹é…è¦†ç›–ç‡å¾…æ”¹å–„")#ç²¾ç¡®åŒ¹é…ç‡è¯„åˆ†iftotal_matches>0:exact_match_rate=barcode_match_count/total_matchesifexact_match_rate>0.7:quality_score+=25quality_factors.append("âœ…ç²¾ç¡®åŒ¹é…ç‡é«˜")elifexact_match_rate>0.4:quality_score+=15quality_factors.append("ğŸŸ¡ç²¾ç¡®åŒ¹é…ç‡ä¸­ç­‰")else:quality_score+=5quality_factors.append("âŒç²¾ç¡®åŒ¹é…ç‡ä½")#æ•°æ®å®Œæ•´æ€§è¯„åˆ†ifnotall_matches.empty:completeness=1-(all_matches.isnull().sum().sum()/(len(all_matches)*len(all_matches.columns)))ifcompleteness>0.9:quality_score+=25quality_factors.append("âœ…æ•°æ®å®Œæ•´æ€§ä¼˜ç§€")elifcompleteness>0.7:quality_score+=15quality_factors.append("ğŸŸ¡æ•°æ®å®Œæ•´æ€§è‰¯å¥½")else:quality_score+=5quality_factors.append("âŒæ•°æ®å­˜åœ¨ç¼ºå¤±")#æ•°æ®ä¸€è‡´æ€§è¯„åˆ†iflen(sheets_data)>=5:quality_score+=25quality_factors.append("âœ…æ•°æ®ç»“æ„å®Œæ•´")eliflen(sheets_data)>=3:quality_score+=15quality_factors.append("ğŸŸ¡æ•°æ®ç»“æ„åŸºæœ¬å®Œæ•´")else:quality_score+=5quality_factors.append("âŒæ•°æ®ç»“æ„ä¸å®Œæ•´")quality_level="ä¼˜ç§€"ifquality_score>80else"è‰¯å¥½"ifquality_score>60else"å¾…æ”¹å–„"report_content.append(f"""**æ€»ä½“è¯„åˆ†ï¼š**{quality_score}/100({quality_level})**è¯„ä¼°æ˜ç»†ï¼š**""")forfactorinquality_factors:report_content.append(f"-{factor}")#æ˜¾ç¤ºå®Œæ•´æŠ¥å‘Šreport_text="\n".join(report_content)st.markdown(report_text)#æä¾›ä¸‹è½½é€‰é¡¹st.download_button(label="ğŸ“¥ä¸‹è½½å®Œæ•´æŠ¥å‘Š(Markdown)",data=report_text,file_name=f"æ¯”ä»·åˆ†ææŠ¥å‘Š_{pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')}.md",mime="text/markdown",key="download_insight_report")exceptExceptionase:st.error(f"ç”Ÿæˆæ´å¯ŸæŠ¥å‘Šæ—¶å‡ºé”™:{str(e)}")@st.cache_data(ttl=300)#5åˆ†é’Ÿç¼“å­˜defload_price_panel_metrics(uploaded_file=None)->Optional[Dict[str,Any]]:"""è¯»å–æ¯”ä»·é¢æ¿æŒ‡æ ‡ï¼Œæ”¯æŒä¸Šä¼ æ–‡ä»¶æˆ–æœ¬åœ°è·¯å¾„"""#ä¼˜å…ˆä½¿ç”¨ä¸Šä¼ çš„æ–‡ä»¶ifuploaded_fileisnotNone:try:#è¯»å–ä¸Šä¼ çš„JSONæ–‡ä»¶content=uploaded_file.read()ifisinstance(content,bytes):content=content.decode('utf-8')payload=json.loads(content)#éªŒè¯æ•°æ®ç»“æ„ifnotisinstance(payload,dict):st.error("âš ï¸ä¸Šä¼ çš„æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ä¸Šä¼ æœ‰æ•ˆçš„JSONæ–‡ä»¶")returnNone#æ£€æŸ¥å¿…è¦å­—æ®µif"metrics"notinpayload:st.warning("âš ï¸ä¸Šä¼ çš„æ–‡ä»¶ä¸­ç¼ºå°‘'metrics'å­—æ®µ")st.success(f"âœ…æˆåŠŸåŠ è½½ä¸Šä¼ çš„æ¯”ä»·æ•°æ®ï¼š{uploaded_file.name}")returnpayloadexceptjson.JSONDecodeErrorase:st.error(f"âŒJSONè§£æé”™è¯¯:{str(e)}")returnNoneexceptExceptionase:st.error(f"âŒåŠ è½½ä¸Šä¼ æ–‡ä»¶å¤±è´¥:{str(e)}")returnNone#å¦‚æœæ²¡æœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œå°è¯•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰metrics_path=PRICE_PANEL_INTERMEDIATE_DIR/"price_panel_metrics.json"ifnotPRICE_PANEL_INTERMEDIATE_DIR.exists():returnNoneifnotmetrics_path.exists():returnNonetry:withopen(metrics_path,"r",encoding="utf-8")asfp:payload=json.load(fp)#éªŒè¯æ•°æ®ç»“æ„ifnotisinstance(payload,dict):returnNone#æ·»åŠ æ•°æ®æ–°é²œåº¦æ£€æŸ¥timestamp=payload.get("generated_at")iftimestamp:try:fromdatetimeimportdatetimegen_time=datetime.fromisoformat(timestamp.replace('Z','+00:00'))age_minutes=(datetime.now()-gen_time.replace(tzinfo=None)).total_seconds()/60ifage_minutes>60:#æ•°æ®è¶…è¿‡1å°æ—¶st.info(f"ğŸ—ºï¸æ£€æµ‹åˆ°æœ¬åœ°æ•°æ®({age_minutes:.0f}åˆ†é’Ÿå‰)ï¼Œå»ºè®®ä¸Šä¼ æœ€æ–°æ•°æ®")exceptException:passreturnpayloadexceptjson.JSONDecodeError:returnNoneexceptException:returnNonedefpreview_uploaded_data(payload:Dict[str,Any])->None:"""é¢„è§ˆä¸Šä¼ çš„æ¯”ä»·æ•°æ®"""ifnotpayload:returnwithst.expander("ğŸ”æ•°æ®é¢„è§ˆä¸éªŒè¯",expanded=False):col1,col2=st.columns(2)withcol1:st.write("**ğŸ“ˆæ•°æ®æ¦‚è§ˆ**")#åŸºæœ¬ä¿¡æ¯timestamp=payload.get("generated_at","N/A")iftimestamp!="N/A":timestamp=timestamp.replace('T','')[:19]st.metric("ç”Ÿæˆæ—¶é—´",timestamp)metrics_count=len(payload.get("metrics",[]))st.metric("æŒ‡æ ‡æ•°é‡",metrics_count)warnings_count=len(payload.get("warnings",[]))st.metric("è­¦å‘Šæ•°é‡",warnings_count)withcol2:st.write("**ğŸ¢é—¨åº—ä¿¡æ¯**")stores=payload.get("stores",[])ifstores:fori,storeinenumerate(stores[:2],1):store_name=store.get("display_name",f"é—¨åº—{i}")st.write(f"â€¢{store_name}")else:st.write("âš ï¸æœªæ£€æµ‹åˆ°é—¨åº—ä¿¡æ¯")#è­¦å‘Šä¿¡æ¯warnings=payload.get("warnings",[])ifwarnings:st.write("**âš ï¸è­¦å‘Šä¿¡æ¯**")forwarninginwarnings:st.warning(warning)#JSONç»“æ„é¢„è§ˆst.write("**ğŸ“œJSONç»“æ„é¢„è§ˆ**")structure={key:type(value).__name__forkey,valueinpayload.items()}st.json(structure)def_format_metric_value(metric:Dict[str,Any])->str:value=metric.get("value")unit=metric.get("unit")ifvalueisNone:return"â€”"ifunit=="%":returnf"{float(value):.1f}%"ifunit=="ä¸ª":try:returnf"{int(value):,}"exceptException:returnstr(value)ifisinstance(value,float):returnf"{value:,.2f}"ifisinstance(value,int):returnf"{value:,}"returnstr(value)def_build_metric_context_lines(metric:Dict[str,Any],payload:Dict[str,Any])->List[str]:context=metric.get("context")or{}metric_id=metric.get("id")lines:List[str]=[]ifmetric_id=="matched_pairs":stores=context.get("stores")or[store.get("display_name","")forstoreinpayload.get("stores",[])[:2]]stores=[sforsinstoresifs]ifstores:lines.append("vs".join(stores))elifmetric_idin{"match_rate_store_a","match_rate_store_b"}:matched=context.get("matched")total=context.get("total")ifmatchedisnotNoneandtotal:lines.append(f"åŒ¹é…{int(matched):,}/æ€»{int(total):,}")elifmetric_idin{"unique_store_a","unique_store_b"}:total=context.get("total")value=metric.get("value")ifvalueisnotNoneandtotal:lines.append(f"ç‹¬æœ‰{int(value):,}/æ€»{int(total):,}")elifmetric_id=="stockout_alert":stores=payload.get("stores",[])[:2]forstoreinstores:name=store.get("display_name")details=context.get(name,{})ifnameelse{}zero=details.get("zero")with_sales=details.get("with_sales")ifzeroisNone:continueline=f"{name}:{int(zero):,}ä¸ª"ifwith_sales:line+=f"ï¼ˆå«é”€é‡{int(with_sales):,}ï¼‰"lines.append(line)diff=context.get("difference")ifisinstance(diff,(int,float))anddiff!=0:symbol="+"ifdiff>0else""lines.append(f"å·®å€¼{symbol}{int(diff):,}")returnlinesdefrender_price_panel_overview(payload:Dict[str,Any])->None:"""æ¸²æŸ“æ¯”ä»·åŸºç¡€çœ‹æ¿æŒ‡æ ‡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"""st.subheader("ğŸ’¹æ¯”ä»·åŸºç¡€çœ‹æ¿")#æ˜¾ç¤ºæ•°æ®æ›´æ–°æ—¶é—´timestamp=payload.get("generated_at")iftimestamp:formatted_time=timestamp.replace('T','')[:19]st.caption(f"ğŸ”„æ•°æ®æ›´æ–°:{formatted_time}")#æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯warnings=payload.get("warnings",[])or[]ifwarnings:forwarninwarnings:st.warning(f"âš ï¸{warn}")#è·å–æŒ‡æ ‡æ•°æ®metrics=payload.get("metrics")or[]ifnotmetrics:st.info("ğŸ“ˆæš‚æ— æ¯”ä»·æŒ‡æ ‡ï¼Œè¯·å…ˆè¿è¡Œæ¯”ä»·ETLã€‚")#æä¾›å¸®åŠ©ä¿¡æ¯withst.expander("ğŸ”§å¦‚ä½•ç”Ÿæˆæ¯”ä»·æ•°æ®ï¼Ÿ"):st.markdown("""**æ­¥éª¤è¯´æ˜:**1.ç¡®ä¿æ¯”ä»·æ•°æ®æ–‡ä»¶å­˜åœ¨äº:`æ¯”ä»·æ•°æ®/`ç›®å½•2.è¿è¡Œæ¯”ä»·ETLå¤„ç†è„šæœ¬3.ç­‰å¾…ç”Ÿæˆ`price_panel_metrics.json`æ–‡ä»¶4.åˆ·æ–°æœ¬é¡µé¢æŸ¥çœ‹æ•°æ®""")return#æ˜¾ç¤ºæŒ‡æ ‡ç»Ÿè®¡st.caption(f"ğŸ“Šå…±{len(metrics)}ä¸ªæ¯”ä»·æŒ‡æ ‡")#æŒ‰è¡Œæ˜¾ç¤ºæŒ‡æ ‡ï¼ˆæ¯è¡Œ3ä¸ªï¼‰forstartinrange(0,len(metrics),3):row_metrics=metrics[start:start+3]columns=st.columns(len(row_metrics))forcol,metricinzip(columns,row_metrics):withcol:metric_label=metric.get("label","æœªçŸ¥æŒ‡æ ‡")metric_value=_format_metric_value(metric)#æ˜¾ç¤ºæŒ‡æ ‡st.metric(metric_label,metric_value)#æ˜¾ç¤ºä¸Šä¸‹æ–‡ä¿¡æ¯context_lines=_build_metric_context_lines(metric,payload)ifcontext_lines:context_text="|".join(context_lines)st.caption(f"ğŸ“{context_text}")#æ·»åŠ åˆ·æ–°æŒ‰é’®col1,col2,col3=st.columns([1,1,2])withcol1:ifst.button("ğŸ”„åˆ·æ–°æ¯”ä»·æ•°æ®"):st.cache_data.clear()st.rerun()withcol2:ifst.button("ğŸ“ˆè¯¦ç»†åˆ†æ"):#è·³è½¬åˆ°æ¯”ä»·çœ‹æ¿é€‰é¡¹å¡st.info("ğŸ‘†è¯·ç‚¹å‡»ä¸Šæ–¹'æ¯”ä»·çœ‹æ¿'é€‰é¡¹å¡æŸ¥çœ‹è¯¦ç»†åˆ†æ")defrender_unified_price_comparison_module()->None:"""ç»Ÿä¸€çš„æ¯”ä»·æ¨¡å—æ¸²æŸ“å‡½æ•°ï¼ˆæ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼‰"""st.subheader("ğŸ’¹æ¯”ä»·åˆ†ææ¨¡å—")#é€‰æ‹©æ•°æ®è¾“å…¥æ–¹å¼input_method=st.radio("ğŸ“é€‰æ‹©æ•°æ®è¾“å…¥æ–¹å¼",["ä¸Šä¼ æ¯”ä»·ç»“æœæ–‡ä»¶","ä¸Šä¼ JSONæ–‡ä»¶","ä½¿ç”¨æœ¬åœ°æ•°æ®"],horizontal=True,key="price_comparison_input_method_radio")price_panel_payload=Noneifinput_method=="ä¸Šä¼ æ¯”ä»·ç»“æœæ–‡ä»¶":st.write("**ğŸ“Šæ¯”ä»·ç»“æœæ–‡ä»¶åˆ†æ**")st.info("ğŸ¯ä¸Šä¼ é€šè¿‡æ¯”ä»·è„šæœ¬ç”Ÿæˆçš„å®Œæ•´æ¯”ä»·ç»“æœExcelæ–‡ä»¶")comparison_file=st.file_uploader("ğŸ“¤é€‰æ‹©æ¯”ä»·ç»“æœExcelæ–‡ä»¶",type=['xlsx','xls'],help="ä¸Šä¼ é€šè¿‡product_comparison_tool_local.pyç”Ÿæˆçš„æ¯”ä»·ç»“æœæ–‡ä»¶",key="comparison_file_uploader")#æ˜¾ç¤ºæ–‡ä»¶è¦æ±‚withst.expander("ğŸ“‹æ¯”ä»·ç»“æœæ–‡ä»¶è¯´æ˜"):st.markdown("""**æ”¯æŒçš„æ–‡ä»¶ç±»å‹:**-âœ…é€šè¿‡`product_comparison_tool_local.py`ç”Ÿæˆçš„æ¯”ä»·ç»“æœæ–‡ä»¶-âœ…æ–‡ä»¶åæ ¼å¼:`matched_products_comparison_final_YYYYMMDD_HHMMSS.xlsx`**æ–‡ä»¶åº”åŒ…å«çš„Sheet:**-**1-æ¡ç ç²¾ç¡®åŒ¹é…**:æ¡ç ç›¸åŒçš„å•†å“åŒ¹é…ç»“æœ-**2-åç§°æ¨¡ç³ŠåŒ¹é…(æ— æ¡ç )**:åŸºäºå•†å“åç§°çš„åŒ¹é…ç»“æœ-**3-{åº—é“ºA}-ç‹¬æœ‰å•†å“**:åº—é“ºAç‹¬æœ‰çš„å•†å“-**4-{åº—é“ºB}-ç‹¬æœ‰å•†å“**:åº—é“ºBç‹¬æœ‰çš„å•†å“-**5-åº“å­˜>0&AæŠ˜æ‰£â‰¥BæŠ˜æ‰£**:ä»·æ ¼ä¼˜åŠ¿å•†å“-**6-8**:æ¸…æ´—æ•°æ®å¯¹æ¯”Sheet(å¯é€‰)**ä½¿ç”¨æµç¨‹:**1.ğŸ”§å…ˆç”¨æ¯”ä»·è„šæœ¬å¤„ç†ä¸¤ä¸ªåº—é“ºçš„åŸå§‹æ•°æ®2.ğŸ“¤ä¸Šä¼ ç”Ÿæˆçš„æ¯”ä»·ç»“æœExcelæ–‡ä»¶3.ğŸ“Šç³»ç»Ÿè‡ªåŠ¨è§£æå¹¶å±•ç¤ºå¯è§†åŒ–åˆ†æç»“æœ**æ³¨æ„äº‹é¡¹:**-ç¡®ä¿æ–‡ä»¶æ˜¯æœ€æ–°çš„æ¯”ä»·ç»“æœ-æ£€æŸ¥å„ä¸ªSheetæ˜¯å¦åŒ…å«æœ‰æ•ˆæ•°æ®-æ”¯æŒä¸­æ–‡å•†å“åç§°å’Œåº—é“ºåç§°""")#å½“æ–‡ä»¶ä¸Šä¼ åï¼Œæ‰§è¡Œåˆ†æifcomparison_file:price_panel_payload=process_uploaded_comparison_file(comparison_file)elifinput_method=="ä¸Šä¼ JSONæ–‡ä»¶":st.write("**ï¿½JSONæ–‡ä»¶ä¸Šä¼ **")uploaded_file=st.file_uploader("ğŸ“¤é€‰æ‹©æ¯”ä»·æ•°æ®æ–‡ä»¶(JSON)",type=['json'],help="è¯·ä¸Šä¼ ç”±æ¯”ä»·ETLç”Ÿæˆçš„price_panel_metrics.jsonæ–‡ä»¶",key="json_uploader")ifuploaded_file:price_panel_payload=load_price_panel_metrics(uploaded_file)else:#ä½¿ç”¨æœ¬åœ°æ•°æ®st.write("**ğŸ’¾æœ¬åœ°æ•°æ®è¯»å–**")price_panel_payload=load_price_panel_metrics()ifprice_panel_payload:st.info("ğŸ—‚ï¸å·²åŠ è½½æœ¬åœ°æ¯”ä»·æ•°æ®")else:st.warning("âš ï¸æœªæ‰¾åˆ°æœ¬åœ°æ¯”ä»·æ•°æ®æ–‡ä»¶")#æ•°æ®æœ‰æ•ˆæ—¶æ˜¾ç¤ºåˆ†æç»“æœifprice_panel_payload:st.markdown("---")#æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©ä¸åŒçš„å±•ç¤ºæ–¹å¼ifprice_panel_payload.get("comparison_type")=="multi_store_comparison":#æ–°çš„æ¯”ä»·ç»“æœæ–‡ä»¶å±•ç¤ºrender_comparison_file_analysis(price_panel_payload)else:#ä¼ ç»Ÿçš„JSONæ–‡ä»¶å±•ç¤ºtab1,tab2=st.tabs(["ğŸ“ˆåŸºç¡€æŒ‡æ ‡","ğŸ—ºï¸è¯¦ç»†åˆ†æ"])withtab1:ifprice_panel_payload.get("metrics"):render_price_panel_overview(price_panel_payload)else:st.warning("ğŸš«æ•°æ®ä¸­æœªåŒ…å«æœ‰æ•ˆæŒ‡æ ‡")withtab2:st.caption("ğŸ”è¯¦ç»†æ¯”ä»·åˆ†æçœ‹æ¿")#åªæœ‰åœ¨ä½¿ç”¨æœ¬åœ°æ•°æ®æ—¶æ‰è°ƒç”¨è€çš„dashboardifinput_method=="ä½¿ç”¨æœ¬åœ°æ•°æ®":try:create_price_comparison_dashboard()exceptExceptionase:st.error(f"âŒåŠ è½½è¯¦ç»†åˆ†æå¤±è´¥:{str(e)}")st.info("ğŸ“å»ºè®®æ£€æŸ¥ä¸Šä¼ çš„æ•°æ®æ–‡ä»¶æ ¼å¼")else:st.info("ğŸ“Šè¯·ä¸Šä¼ æ¯”ä»·ç»“æœæ–‡ä»¶æˆ–JSONæ–‡ä»¶ä»¥æŸ¥çœ‹è¯¦ç»†åˆ†æ")else:#æ ¹æ®é€‰æ‹©çš„è¾“å…¥æ–¹å¼æ˜¾ç¤ºä¸åŒçš„æç¤ºifinput_method=="ä¸Šä¼ æ¯”ä»·ç»“æœæ–‡ä»¶":st.info("ğŸ‘†è¯·ä¸Šä¼ æ¯”ä»·ç»“æœExcelæ–‡ä»¶å¼€å§‹åˆ†æ")elifinput_method=="ä¸Šä¼ JSONæ–‡ä»¶":st.info("ğŸ‘†è¯·ä¸Šä¼ JSONæ–‡ä»¶å¼€å§‹åˆ†æ")else:#ä½¿ç”¨æœ¬åœ°æ•°æ®st.info("ğŸ”æ­£åœ¨å°è¯•åŠ è½½æœ¬åœ°æ¯”ä»·æ•°æ®...")#åªæœ‰é€‰æ‹©æœ¬åœ°æ•°æ®æ—¶æ‰æ˜¾ç¤ºè€çš„dashboardtry:create_price_comparison_dashboard()exceptExceptionase:st.warning("âš ï¸æœªæ‰¾åˆ°æœ¬åœ°æ¯”ä»·æ•°æ®æ–‡ä»¶")st.info("ğŸ’¡å»ºè®®ä¸Šä¼ æ¯”ä»·ç»“æœæ–‡ä»¶æˆ–JSONæ–‡ä»¶è¿›è¡Œåˆ†æ")defrender_order_data_uploader():"""æ¸²æŸ“è®¢å•æ•°æ®ä¸Šä¼ å’Œåˆ†ææ¨¡å—-æ”¯æŒæ‰¹é‡ä¸Šä¼ """st.info("ğŸ“¤ä¸Šä¼ è®¢å•æ•°æ®Excelæ–‡ä»¶è¿›è¡Œæ·±åº¦åˆ†æï¼ˆæ”¯æŒæ‰¹é‡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼‰")#æ·»åŠ æ•°æ®æ¥æºé€‰æ‹©data_source_tab1,data_source_tab2=st.tabs(["ğŸ“¤ä¸Šä¼ æ–°æ•°æ®","ğŸ“‚åŠ è½½å†å²æ•°æ®"])order_data_to_analyze=Nonedata_source_label=""withdata_source_tab1:#æ–‡ä»¶ä¸Šä¼ -æ”¯æŒå¤šæ–‡ä»¶order_files=st.file_uploader("é€‰æ‹©è®¢å•æ•°æ®æ–‡ä»¶ï¼ˆå¯é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼‰",type=['xlsx','xls'],help="ä¸Šä¼ åŒ…å«è®¢å•ä¿¡æ¯çš„Excelæ–‡ä»¶ï¼Œæ”¯æŒåŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶è¿›è¡Œåˆå¹¶åˆ†æ",key="order_data_uploader",accept_multiple_files=True#å¯ç”¨å¤šæ–‡ä»¶ä¸Šä¼ )iforder_files:data_source_label="æ–°ä¸Šä¼ æ•°æ®"#åç»­å¤„ç†é€»è¾‘...withdata_source_tab2:st.write("**ğŸ“¦å†å²ç¼“å­˜æ•°æ®**")#è·å–å†å²ç¼“å­˜åˆ—è¡¨cached_list=load_cached_data_list()ifnotcached_list:st.info("ğŸ“­æš‚æ— å†å²ç¼“å­˜æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ æ–°æ•°æ®")else:st.success(f"âœ…æ‰¾åˆ°{len(cached_list)}ä¸ªå†å²æ•°æ®ç‰ˆæœ¬")#åˆ›å»ºé€‰æ‹©åˆ—è¡¨cache_options=[]foridx,cache_infoinenumerate(cached_list):upload_time=cache_info['upload_time']ifupload_time!='Unknown':try:fromdatetimeimportdatetimedt=datetime.fromisoformat(upload_time)time_str=dt.strftime('%Y-%m-%d%H:%M')except:time_str=upload_timeelse:time_str="æœªçŸ¥æ—¶é—´"label=f"{cache_info['original_file']}|{time_str}|{cache_info['rows']:,}è¡Œ|{cache_info['size_mb']:.1f}MB"cache_options.append((label,cache_info['file_path']))#é€‰æ‹©è¦åŠ è½½çš„ç¼“å­˜selected_cache_label=st.selectbox("é€‰æ‹©è¦åŠ è½½çš„å†å²æ•°æ®",options=[opt[0]foroptincache_options],key="cached_data_selector")ifst.button("ğŸ”„åŠ è½½é€‰ä¸­çš„å†å²æ•°æ®",key="load_cached_btn"):#æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶è·¯å¾„selected_path=next(opt[1]foroptincache_optionsifopt[0]==selected_cache_label)withst.spinner("ğŸ“–æ­£åœ¨åŠ è½½å†å²æ•°æ®..."):order_data_to_analyze=load_data_from_cache(selected_path)iforder_data_to_analyzeisnotNone:st.success(f"âœ…æˆåŠŸåŠ è½½å†å²æ•°æ®ï¼š{len(order_data_to_analyze):,}è¡Œ")data_source_label=f"å†å²æ•°æ®:{selected_cache_label}"#è®¾ç½®åˆ°session_stateä¾›å…¶ä»–æ ‡ç­¾é¡µä½¿ç”¨if'current_data'notinst.session_state:st.session_state['current_data']={}st.session_state['current_data']['raw_data']=order_data_to_analyzest.session_state['uploaded_order_data']=st.session_state['current_data']st.info("ğŸ’¡æ•°æ®å·²åŠ è½½ï¼Œå¯å‰å¾€å…¶ä»–æ ‡ç­¾é¡µï¼ˆå¦‚AIåœºæ™¯è¥é”€ï¼‰æŸ¥çœ‹åˆ†æ")#åªæœ‰å½“æœ‰æ•°æ®éœ€è¦åˆ†ææ—¶æ‰ç»§ç»­iforder_files:#åŸæœ‰çš„ä¸Šä¼ å¤„ç†é€»è¾‘pass#å°†åœ¨ä¸‹é¢æ›¿æ¢#æ˜¾ç¤ºæ–‡ä»¶æ ¼å¼è¦æ±‚withst.expander("ğŸ“‹è®¢å•æ•°æ®æ ¼å¼è¦æ±‚"):st.markdown("""**å¿…éœ€å­—æ®µï¼š**-`è®¢å•ID`:è®¢å•å”¯ä¸€æ ‡è¯†-`å•†å“åç§°`:å•†å“åç§°-`å•†å“å®å”®ä»·`:å•†å“å”®ä»·-`é”€é‡`:å•†å“æ•°é‡-`ä¸‹å•æ—¶é—´`:è®¢å•æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDHH:MM:SSï¼‰-`é—¨åº—åç§°`:é—¨åº—æ ‡è¯†-`æ¸ é“`:é”€å”®æ¸ é“ï¼ˆå¦‚ï¼šç¾å›¢ã€é¥¿äº†ä¹ˆç­‰ï¼‰**æ¨èå­—æ®µï¼ˆç”¨äºå®Œæ•´åˆ†æï¼‰ï¼š**-`ç‰©æµé…é€è´¹`:é…é€è´¹ç”¨-`å¹³å°ä½£é‡‘`:å¹³å°æŠ½æˆ-`é…é€è·ç¦»`:é…é€è·ç¦»ï¼ˆç±³æˆ–å…¬é‡Œï¼‰-`ç¾å›¢ä¸€çº§åˆ†ç±»`:å•†å“ä¸€çº§åˆ†ç±»-`ç¾å›¢ä¸‰çº§åˆ†ç±»`:å•†å“ä¸‰çº§åˆ†ç±»-`æ”¶è´§åœ°å€`:é…é€åœ°å€-`é…é€è´¹å‡å…`ã€`æ»¡å‡`ã€`å•†å“å‡å…`ã€`ä»£é‡‘åˆ¸`:å„ç±»ä¼˜æƒ é‡‘é¢-`ç”¨æˆ·æ”¯ä»˜é…é€è´¹`ã€`è®¢å•é›¶å”®é¢`ã€`æ‰“åŒ…è´¹`:è®¢å•é‡‘é¢æ˜ç»†**åˆ†æåŠŸèƒ½ï¼š**-âœ…13ä¸ªæ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ï¼ˆè®¢å•æ•°ã€æ”¶å…¥ã€åˆ©æ¶¦ã€å®¢å•ä»·ç­‰ï¼‰-âœ…è´Ÿæ¯›åˆ©å•†å“è¯†åˆ«Top50-âœ…æˆæœ¬ç»“æ„åˆ†æï¼ˆå•†å®¶æ´»åŠ¨ã€å¹³å°ä½£é‡‘ã€é…é€æˆæœ¬ï¼‰-âœ…ä¸»å•å“vså‡‘å•å“å¯¹æ¯”-âœ…æ¯æ—¥åˆ©æ¶¦è¶‹åŠ¿å›¾ï¼ˆåˆ©æ¶¦é¢+åˆ©æ¶¦ç‡ï¼‰-âœ…æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š""")#å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæ”¯æŒå¤šæ–‡ä»¶åˆå¹¶ï¼‰æˆ–åŠ è½½å†å²æ•°æ®iforder_filesororder_data_to_analyzeisnotNone:st.markdown("""**å¿…éœ€å­—æ®µï¼š**-`è®¢å•ID`:è®¢å•å”¯ä¸€æ ‡è¯†-`å•†å“åç§°`:å•†å“åç§°-`å•†å“å®å”®ä»·`:å•†å“å”®ä»·-`é”€é‡`:å•†å“æ•°é‡-`ä¸‹å•æ—¶é—´`:è®¢å•æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDHH:MM:SSï¼‰-`é—¨åº—åç§°`:é—¨åº—æ ‡è¯†-`æ¸ é“`:é”€å”®æ¸ é“ï¼ˆå¦‚ï¼šç¾å›¢ã€é¥¿äº†ä¹ˆç­‰ï¼‰**æ¨èå­—æ®µï¼ˆç”¨äºå®Œæ•´åˆ†æï¼‰ï¼š**-`ç‰©æµé…é€è´¹`:é…é€è´¹ç”¨-`å¹³å°ä½£é‡‘`:å¹³å°æŠ½æˆ-`é…é€è·ç¦»`:é…é€è·ç¦»ï¼ˆç±³æˆ–å…¬é‡Œï¼‰-`ç¾å›¢ä¸€çº§åˆ†ç±»`:å•†å“ä¸€çº§åˆ†ç±»-`ç¾å›¢ä¸‰çº§åˆ†ç±»`:å•†å“ä¸‰çº§åˆ†ç±»-`æ”¶è´§åœ°å€`:é…é€åœ°å€-`é…é€è´¹å‡å…`ã€`æ»¡å‡`ã€`å•†å“å‡å…`ã€`ä»£é‡‘åˆ¸`:å„ç±»ä¼˜æƒ é‡‘é¢-`ç”¨æˆ·æ”¯ä»˜é…é€è´¹`ã€`è®¢å•é›¶å”®é¢`ã€`æ‰“åŒ…è´¹`:è®¢å•é‡‘é¢æ˜ç»†**åˆ†æåŠŸèƒ½ï¼š**-âœ…13ä¸ªæ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ï¼ˆè®¢å•æ•°ã€æ”¶å…¥ã€åˆ©æ¶¦ã€å®¢å•ä»·ç­‰ï¼‰-âœ…è´Ÿæ¯›åˆ©å•†å“è¯†åˆ«Top50-âœ…æˆæœ¬ç»“æ„åˆ†æï¼ˆå•†å®¶æ´»åŠ¨ã€å¹³å°ä½£é‡‘ã€é…é€æˆæœ¬ï¼‰-âœ…ä¸»å•å“vså‡‘å•å“å¯¹æ¯”-âœ…æ¯æ—¥åˆ©æ¶¦è¶‹åŠ¿å›¾ï¼ˆåˆ©æ¶¦é¢+åˆ©æ¶¦ç‡ï¼‰-âœ…æ•°æ®è´¨é‡æ£€æŸ¥æŠ¥å‘Š""")#å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæ”¯æŒå¤šæ–‡ä»¶åˆå¹¶ï¼‰æˆ–åŠ è½½å†å²æ•°æ®iforder_filesororder_data_to_analyzeisnotNone:try:#åŒºåˆ†ä¸¤ç§æ•°æ®æ¥æºiforder_data_to_analyzeisnotNone:#ä½¿ç”¨å†å²ç¼“å­˜æ•°æ®order_data=order_data_to_analyzeoriginal_count=len(order_data)st.success(f"âœ…å·²åŠ è½½å†å²æ•°æ®ï¼š{original_count:,}æ¡è®¢å•")else:#å¤„ç†æ–°ä¸Šä¼ çš„æ–‡ä»¶#å¦‚æœä¸Šä¼ äº†å¤šä¸ªæ–‡ä»¶ï¼Œå…ˆæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨iflen(order_files)>1:st.success(f"âœ…æ£€æµ‹åˆ°{len(order_files)}ä¸ªæ–‡ä»¶ï¼Œå°†è‡ªåŠ¨åˆå¹¶åˆ†æ")withst.expander("ğŸ“‚æ–‡ä»¶åˆ—è¡¨"):foridx,fileinenumerate(order_files,1):st.write(f"{idx}.{file.name}")withst.spinner("ğŸ“–æ­£åœ¨è¯»å–è®¢å•æ•°æ®..."):#è¯»å–æ‰€æœ‰Excelæ–‡ä»¶å¹¶åˆå¹¶all_order_data=[]file_stats=[]forfileinorder_files:try:df=pd.read_excel(file)all_order_data.append(df)file_stats.append({'æ–‡ä»¶å':file.name,'è®¢å•è¡Œæ•°':len(df),'çŠ¶æ€':'âœ…æˆåŠŸ'})exceptExceptionase:file_stats.append({'æ–‡ä»¶å':file.name,'è®¢å•è¡Œæ•°':0,'çŠ¶æ€':f'âŒå¤±è´¥:{str(e)}'})st.error(f"âŒè¯»å–æ–‡ä»¶{file.name}å¤±è´¥:{str(e)}")#æ˜¾ç¤ºæ–‡ä»¶è¯»å–ç»Ÿè®¡iflen(order_files)>1:st.dataframe(pd.DataFrame(file_stats),use_container_width=True,hide_index=True)#åˆå¹¶æ‰€æœ‰æ•°æ®ifnotall_order_data:st.error("âŒæ²¡æœ‰æˆåŠŸè¯»å–ä»»ä½•æ–‡ä»¶")returnorder_data=pd.concat(all_order_data,ignore_index=True)original_count=len(order_data)#æ™ºèƒ½å»é‡ï¼šåªåˆ é™¤å®Œå…¨ç›¸åŒçš„è¡Œï¼ˆæ‰€æœ‰å­—æ®µéƒ½ç›¸åŒï¼‰before_dedup=len(order_data)order_data=order_data.drop_duplicates(keep='first')after_dedup=len(order_data)ifbefore_dedup>after_dedup:st.info(f"ğŸ”„å·²å»é™¤å®Œå…¨é‡å¤çš„æ•°æ®è¡Œï¼š{before_dedup:,}â†’{after_dedup:,}è¡Œï¼ˆå»é™¤{before_dedup-after_dedup:,}è¡Œï¼‰")st.caption("ğŸ’¡è¯´æ˜ï¼šåªåˆ é™¤æ‰€æœ‰å­—æ®µå®Œå…¨ç›¸åŒçš„è¡Œï¼Œä¿ç•™è®¢å•-å•†å“æ˜ç»†çº§æ•°æ®")#æ£€æŸ¥è®¢å•-å•†å“æ˜ç»†ç»“æ„if'è®¢å•ID'inorder_data.columns:unique_orders=order_data['è®¢å•ID'].nunique()total_items=len(order_data)avg_items=total_items/unique_ordersifunique_orders>0else0st.success(f"âœ…æˆåŠŸåŠ è½½æ•°æ®ï¼š{unique_orders:,}ä¸ªè®¢å•ï¼Œ{total_items:,}ä¸ªå•†å“æ˜ç»†ï¼ˆå¹³å‡æ¯å•{avg_items:.1f}ä¸ªå•†å“ï¼‰")else:st.success(f"âœ…æˆåŠŸåŠ è½½{after_dedup:,}æ¡æ•°æ®")#ğŸ”æ•°æ®è´¨é‡æ£€æŸ¥ï¼ˆä»…å¯¹æ–°ä¸Šä¼ æ•°æ®ï¼‰withst.spinner("ğŸ”æ­£åœ¨è¿›è¡Œæ•°æ®è´¨é‡æ£€æŸ¥..."):quality_report=perform_data_quality_check(order_data)#æ˜¾ç¤ºè´¨é‡æ£€æŸ¥ç»“æœcol1,col2,col3=st.columns(3)withcol1:st.metric("æ•°æ®è´¨é‡è¯„åˆ†",f"{quality_report['score']}åˆ†")withcol2:st.metric("è´¨é‡ç­‰çº§",quality_report['grade'])withcol3:st.metric("é—®é¢˜æ•°é‡",f"{len(quality_report['issues'])}ä¸ª")#è¯¦ç»†è´¨é‡æŠ¥å‘Šifquality_report['issues']orquality_report['warnings']:withst.expander("ğŸ“‹æ•°æ®è´¨é‡è¯¦ç»†æŠ¥å‘Š"):ifquality_report['issues']:st.write("**ğŸ”´ä¸¥é‡é—®é¢˜ï¼š**")forissueinquality_report['issues']:st.error(f"â€¢{issue['column']}:{issue['description']}")ifquality_report['warnings']:st.write("**âš ï¸è­¦å‘Šæç¤ºï¼š**")forwarninginquality_report['warnings']:st.warning(f"â€¢{warning['column']}:{warning['description']}")else:st.success("âœ…æ•°æ®è´¨é‡ä¼˜ç§€ï¼Œæœªå‘ç°é—®é¢˜")#ğŸ’¾è‡ªåŠ¨ä¿å­˜åˆ°ç¼“å­˜withst.spinner("ğŸ’¾æ­£åœ¨ä¿å­˜æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜..."):try:#ä¿å­˜åŸå§‹åˆå¹¶æ•°æ®file_name=order_files[0].nameiflen(order_files)==1elsef"åˆå¹¶æ•°æ®_{len(order_files)}ä¸ªæ–‡ä»¶"cache_path=save_data_to_cache(order_data,file_name)st.success(f"ğŸ’¾æ•°æ®å·²ä¿å­˜åˆ°ç¼“å­˜ï¼Œä¸‹æ¬¡å¯å¿«é€ŸåŠ è½½")exceptExceptionase:st.warning(f"âš ï¸ç¼“å­˜ä¿å­˜å¤±è´¥ï¼ˆä¸å½±å“åˆ†æï¼‰:{str(e)}")#æ˜¾ç¤ºæ•°æ®é¢„è§ˆï¼ˆä¸¤ç§æ¥æºé€šç”¨ï¼‰withst.expander("ğŸ‘€æ•°æ®é¢„è§ˆï¼ˆå‰10è¡Œï¼‰"):st.dataframe(order_data.head(10))#æ•°æ®å¤„ç†å’Œåˆ†æwithst.spinner("ğŸ”„æ­£åœ¨å¤„ç†å’Œåˆ†ææ•°æ®..."):try:#è°ƒç”¨æ ‡å‡†ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆä¼šè‡ªåŠ¨å‰”é™¤è€—ææ•°æ®ï¼‰processed_order_data=preprocess_order_data(order_data)#æ˜¾ç¤ºè€—æå‰”é™¤ä¿¡æ¯processed_count=len(processed_order_data)ifprocessed_count<original_count:removed_count=original_count-processed_countst.warning(f"ğŸ”´å·²è‡ªåŠ¨å‰”é™¤{removed_count}è¡Œè€—ææ•°æ®ï¼ˆå¦‚è´­ç‰©è¢‹ï¼‰ï¼Œå®é™…åˆ†æ{processed_count:,}è¡Œæ•°æ®")order_summary=calculate_order_metrics(processed_order_data)#ä¿å­˜æ•°æ®åˆ°session_stateä¾›å…¶ä»–æ ‡ç­¾é¡µä½¿ç”¨if'current_data'notinst.session_state:st.session_state['current_data']={}st.session_state['current_data']['raw_data']=processed_order_datast.session_state['current_data']['order_summary']=order_summary#åŒæ—¶è®¾ç½®uploaded_order_dataæ ‡å¿—st.session_state['uploaded_order_data']=st.session_state['current_data']st.success("âœ…æ•°æ®å¤„ç†å®Œæˆï¼å¯ä»¥å‰å¾€å…¶ä»–æ ‡ç­¾é¡µï¼ˆå¦‚AIåœºæ™¯è¥é”€ï¼‰æŸ¥çœ‹æ›´å¤šåˆ†æ")#åˆ›å»ºåˆ†æé€‰é¡¹å¡st.markdown("---")analysis_tabs=st.tabs(["ğŸ“Šè®¢å•æ¦‚è§ˆ","ğŸ’°åˆ©æ¶¦åˆ†æ","â°æ—¶é—´åˆ†æ","ğŸªé—¨åº—åˆ†æ","ğŸ“¦å•†å“åˆ†æ"])withanalysis_tabs[0]:ifORDER_ENHANCEMENT_AVAILABLE:render_enhanced_order_overview(processed_order_data,order_summary)else:render_order_overview(processed_order_data,order_summary)withanalysis_tabs[1]:ifORDER_ENHANCEMENT_AVAILABLE:render_enhanced_profit_analysis(processed_order_data,order_summary)else:render_profit_analysis(processed_order_data,order_summary)withanalysis_tabs[2]:render_time_analysis(processed_order_data)withanalysis_tabs[3]:render_store_analysis(processed_order_data)withanalysis_tabs[4]:render_product_analysis(processed_order_data)exceptExceptionase:st.error(f"âŒæ•°æ®å¤„ç†å¤±è´¥:{str(e)}")st.info("ğŸ’¡è¯·æ£€æŸ¥ä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦åŒ…å«å¿…éœ€å­—æ®µ")#æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯withst.expander("ğŸ”é”™è¯¯è¯¦æƒ…"):st.code(str(e))importtracebackst.code(traceback.format_exc())exceptExceptionase:st.error(f"âŒæ–‡ä»¶è¯»å–å¤±è´¥:{str(e)}")st.info("ğŸ’¡è¯·ç¡®ä¿ä¸Šä¼ çš„æ˜¯æœ‰æ•ˆçš„Excelæ–‡ä»¶ï¼ˆ.xlsxæˆ–.xlsï¼‰")@st.cache_datadefload_sample_data():"""åŠ è½½ç¤ºä¾‹æ•°æ®"""return{'store_id':'DEMO_STORE_001','product_data':pd.DataFrame({'å•†å“åç§°':['å¯å£å¯ä¹330ml','å†œå¤«å±±æ³‰550ml','åº·å¸ˆå‚…çº¢çƒ§ç‰›è‚‰é¢','äº”ç²®æ¶²52åº¦500ml','é£å¤©èŒ…å°53åº¦500ml','åŒæ±‡ç«è…¿è‚ ','ç»Ÿä¸€ç»¿èŒ¶','å¥¥åˆ©å¥¥é¥¼å¹²','å¾·èŠ™å·§å…‹åŠ›','æ—ºæ—ºä»™è´'],'å”®ä»·':[3.5,2.0,4.5,168.0,2680.0,6.8,3.2,12.5,28.0,8.9],'åŸä»·':[4.0,2.5,5.0,188.0,2980.0,8.0,4.0,15.0,32.0,10.0],'æœˆå”®':[1500,2800,800,50,5,1200,900,600,300,450],'åº“å­˜':[200,300,150,20,3,180,120,80,50,75],'ç¾å›¢ä¸€çº§åˆ†ç±»':['é¥®å“','é¥®å“','é£Ÿå“','é…’ç±»','é…’ç±»','é£Ÿå“','é¥®å“','é£Ÿå“','é£Ÿå“','é£Ÿå“'],'ç¾å›¢ä¸‰çº§åˆ†ç±»':['ç¢³é…¸é¥®æ–™','æ°´','æ–¹ä¾¿é¢','ç™½é…’','ç™½é…’','è‚‰åˆ¶å“','èŒ¶é¥®æ–™','é¥¼å¹²','å·§å…‹åŠ›','è†¨åŒ–é£Ÿå“']}),'competitor_data':pd.DataFrame({'å•†å“åç§°':['å¯å£å¯ä¹330ml','å†œå¤«å±±æ³‰550ml','åº·å¸ˆå‚…çº¢çƒ§ç‰›è‚‰é¢','é›ªç¢§æŸ æª¬å‘³','ç™¾äº‹å¯ä¹'],'å”®ä»·':[3.2,1.8,4.2,3.0,3.3],'åŸä»·':[3.8,2.2,4.8,3.5,3.8],'æœˆå”®':[1800,3200,900,1400,1100],'é—¨åº—åç§°':['ç«å¯¹A','ç«å¯¹A','ç«å¯¹A','ç«å¯¹A','ç«å¯¹A'],'ç¾å›¢ä¸€çº§åˆ†ç±»':['é¥®å“','é¥®å“','é£Ÿå“','é¥®å“','é¥®å“']})}defmain():"""ä¸»å‡½æ•°-ç®€åŒ–çš„æ ‡ç­¾é¡µç•Œé¢"""#é¡µé¢æ ‡é¢˜st.markdown('<h1class="main-header">ğŸªæ™ºèƒ½é—¨åº—ç»è¥çœ‹æ¿</h1>',unsafe_allow_html=True)st.markdown("---")#åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶dashboard=load_dashboard_system()data_processor=load_data_processor()#åˆ›å»º7ä¸ªåŠŸèƒ½æ ‡ç­¾é¡µtab1,tab2,tab3,tab4,tab5,tab6,tab7=st.tabs(["ğŸ“Šè®¢å•æ•°æ®åˆ†æ","ğŸ’°æ¯”ä»·åˆ†æ","ğŸ¯AIåœºæ™¯è¥é”€","ğŸ“‹é—®é¢˜è¯Šæ–­","ğŸ›’å¤šå•†å“è®¢å•å¼•å¯¼","ğŸªå•†å“åˆ†ç±»ç»“æ„ç«äº‰åŠ›","âš™ï¸é«˜çº§åŠŸèƒ½"])#===Tab1:è®¢å•æ•°æ®åˆ†æ===withtab1:st.header("ğŸ“Šè®¢å•æ•°æ®åˆ†æ")#ç›´æ¥æ˜¾ç¤ºä¸Šä¼ ç•Œé¢render_order_data_uploader()#å¦‚æœå·²æœ‰åˆ†æç»“æœï¼Œæ˜¾ç¤ºif"analysis_result"inst.session_stateand"è®¢å•åˆ†æ"inst.session_state.get("analysis_result",{}):st.markdown("---")st.subheader("ğŸ“ˆåˆ†æç»“æœ")#æ˜¾ç¤ºè®¢å•åˆ†æéƒ¨åˆ†ç»“æœanalysis_result=st.session_state["analysis_result"]#åŸºç¡€æŒ‡æ ‡if"åŸºç¡€æŒ‡æ ‡"inanalysis_result:metrics=analysis_result["åŸºç¡€æŒ‡æ ‡"]col1,col2,col3,col4=st.columns(4)col1.metric("è®¢å•æ€»æ•°",f"{metrics.get('è®¢å•æ€»æ•°',0):,}")col2.metric("æ€»é”€å”®é¢",f"Â¥{metrics.get('æ€»é”€å”®é¢',0):,.2f}")col3.metric("æ€»åˆ©æ¶¦",f"Â¥{metrics.get('æ€»åˆ©æ¶¦',0):,.2f}")col4.metric("åˆ©æ¶¦ç‡",f"{metrics.get('åˆ©æ¶¦ç‡',0):.1f}%")#===Tab2:æ¯”ä»·åˆ†æ===withtab2:st.header("ğŸ’°æ¯”ä»·åˆ†æ")render_unified_price_comparison_module()#===Tab3:AIåœºæ™¯è¥é”€===withtab3:st.header("ğŸ¯AIåœºæ™¯è¥é”€")#æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ å¹¶å¤„ç†æ•°æ®has_data=Falsecurrent_data={}#ä¼˜å…ˆæ£€æŸ¥å·²å¤„ç†çš„æ•°æ®if"current_data"inst.session_stateand"raw_data"inst.session_state["current_data"]:current_data=st.session_state["current_data"]has_data=True#å…¶æ¬¡æ£€æŸ¥ä¸Šä¼ çš„æ•°æ®elif"uploaded_order_data"inst.session_state:current_data=st.session_state["uploaded_order_data"]has_data=Trueifnothas_data:st.warning("âš ï¸è¯·å…ˆåœ¨ã€è®¢å•æ•°æ®åˆ†æã€æ ‡ç­¾é¡µä¸Šä¼ æ•°æ®")st.info("ğŸ’¡åœºæ™¯è¥é”€åˆ†æéœ€è¦åŸºäºè®¢å•æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶")#æä¾›å¿«é€Ÿæ¼”ç¤ºå…¥å£ifst.button("ğŸªä½¿ç”¨ç¤ºä¾‹æ•°æ®æ¼”ç¤ºåœºæ™¯è¥é”€",type="secondary"):sample_data=load_sample_data()st.session_state["uploaded_order_data"]=sample_datast.session_state["current_data"]=sample_datast.success("âœ…å·²åŠ è½½ç¤ºä¾‹æ•°æ®")st.rerun()else:#ç›´æ¥æ˜¾ç¤ºåœºæ™¯è¥é”€çœ‹æ¿display_scenario_marketing_dashboard(current_data)#===Tab4:é—®é¢˜è¯Šæ–­===withtab4:st.header("ğŸ“‹æ™ºèƒ½é—®é¢˜è¯Šæ–­")st.info("""**ğŸ¯åŠŸèƒ½è¯´æ˜**ï¼šåŸºäºè®¢å•æ•°æ®ï¼Œæ™ºèƒ½è¯†åˆ«ç»è¥ä¸­çš„æ½œåœ¨é—®é¢˜ï¼Œå¹¶æä¾›é’ˆå¯¹æ€§çš„è§£å†³æ–¹æ¡ˆ**ğŸ’¡è¯Šæ–­ç»´åº¦**ï¼š-ğŸ“‰é”€å”®ä¸‹æ»‘åˆ†æ-ğŸ’°åˆ©æ¶¦å¼‚å¸¸è¯Šæ–­-ğŸ“¦åº“å­˜é—®é¢˜è¯†åˆ«-ğŸ¯å•†å“ç»“æ„ä¼˜åŒ–-ğŸ‘¥å®¢æˆ·æµå¤±é¢„è­¦-âš ï¸è¿è¥é£é™©æç¤º""")#æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ å¹¶å¤„ç†æ•°æ®has_data=Falsecurrent_data={}#ä¼˜å…ˆæ£€æŸ¥å·²å¤„ç†çš„æ•°æ®if"current_data"inst.session_stateand"raw_data"inst.session_state["current_data"]:current_data=st.session_state["current_data"]has_data=True#å…¶æ¬¡æ£€æŸ¥ä¸Šä¼ çš„æ•°æ®elif"uploaded_order_data"inst.session_state:current_data=st.session_state["uploaded_order_data"]has_data=Trueifnothas_data:st.warning("âš ï¸è¯·å…ˆåœ¨ã€è®¢å•æ•°æ®åˆ†æã€æ ‡ç­¾é¡µä¸Šä¼ æ•°æ®")st.info("ğŸ’¡é—®é¢˜è¯Šæ–­éœ€è¦åŸºäºè®¢å•æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶")#æ˜¾ç¤ºåŠŸèƒ½ä»‹ç»withst.expander("ğŸ“‹æŸ¥çœ‹è¯Šæ–­åŠŸèƒ½è¯¦æƒ…"):st.markdown("""**é—®é¢˜è¯Šæ–­ä¸­å¿ƒæä¾›ä»¥ä¸‹åŠŸèƒ½**ï¼š1.**è‡ªåŠ¨é—®é¢˜è¯†åˆ«**-æ™ºèƒ½æ‰«ææ•°æ®ï¼Œè¯†åˆ«æ½œåœ¨é—®é¢˜-é—®é¢˜ä¸¥é‡ç¨‹åº¦åˆ†çº§ï¼ˆä¸¥é‡ã€è­¦å‘Šã€å»ºè®®ï¼‰-æä¾›é—®é¢˜å½±å“èŒƒå›´å’Œé‡‘é¢ä¼°ç®—2.**æ ¹å› åˆ†æ**-æ·±åº¦æŒ–æ˜é—®é¢˜äº§ç”Ÿçš„æ ¹æœ¬åŸå› -å¤šç»´åº¦äº¤å‰åˆ†æ-æ•°æ®å¯è§†åŒ–å‘ˆç°3.**è§£å†³æ–¹æ¡ˆæ¨è**-åŸºäºè¡Œä¸šæœ€ä½³å®è·µçš„å»ºè®®-å¯é‡åŒ–çš„æ”¹è¿›ç›®æ ‡-åˆ†æ­¥éª¤å®æ–½è®¡åˆ’4.**è¯Šæ–­æŠ¥å‘Šå¯¼å‡º**-ç”Ÿæˆå®Œæ•´çš„è¯Šæ–­æŠ¥å‘Š-æ”¯æŒExcelæ ¼å¼ä¸‹è½½-åŒ…å«é—®é¢˜æ¸…å•å’Œè§£å†³æ–¹æ¡ˆ""")else:#è°ƒç”¨é—®é¢˜è¯Šæ–­æ¨¡å—try:#é¢„å¤„ç†æ•°æ®ï¼šç¡®ä¿æœ‰æ—¥æœŸåˆ—#é‡è¦ï¼šä½¿ç”¨æ·±æ‹·è´é¿å…ä¿®æ”¹åŸå§‹æ•°æ®processed_data={'raw_data':current_data.get('raw_data',pd.DataFrame()).copy()}raw_df=processed_data['raw_data']#ğŸ”DEBUG:æ£€æŸ¥æ•°æ®é‡print(f"[DEBUG]Tab4-è·å–åˆ°çš„åŸå§‹æ•°æ®é‡:{len(raw_df)}è¡Œ")ifnotraw_df.empty:#ç¡®ä¿æœ‰æ—¥æœŸåˆ—ï¼ˆé—®é¢˜è¯Šæ–­å¼•æ“éœ€è¦ï¼‰if'ä¸‹å•æ—¶é—´'inraw_df.columns:if'æ—¥æœŸ'notinraw_df.columns:raw_df['æ—¥æœŸ']=pd.to_datetime(raw_df['ä¸‹å•æ—¶é—´'],errors='coerce')else:#å¦‚æœå·²æœ‰æ—¥æœŸåˆ—,ç¡®ä¿æ ¼å¼æ­£ç¡®raw_df['æ—¥æœŸ']=pd.to_datetime(raw_df['æ—¥æœŸ'],errors='coerce')#ğŸ”DEBUG:æ£€æŸ¥æ—¥æœŸèŒƒå›´if'æ—¥æœŸ'inraw_df.columns:valid_dates=raw_df['æ—¥æœŸ'].dropna()iflen(valid_dates)>0:print(f"[DEBUG]Tab4-æ—¥æœŸèŒƒå›´:{valid_dates.min()}è‡³{valid_dates.max()}")print(f"[DEBUG]Tab4-å”¯ä¸€æ—¥æœŸæ•°:{valid_dates.dt.date.nunique()}")#æ£€æŸ¥æ•°æ®æ—¶é—´èŒƒå›´if'æ—¥æœŸ'inraw_df.columns:valid_dates=raw_df['æ—¥æœŸ'].dropna()iflen(valid_dates)>0:date_range=(valid_dates.max()-valid_dates.min()).daysifdate_range<7:st.warning(f"""âš ï¸æ•°æ®æ—¶é—´èŒƒå›´è¾ƒçŸ­ï¼ˆä»…{date_range}å¤©ï¼‰ï¼Œéƒ¨åˆ†å‘¨æœŸå¯¹æ¯”åˆ†æåŠŸèƒ½å¯èƒ½å—é™**ğŸ’¡å»ºè®®**ï¼š-ä¸Šä¼ è‡³å°‘7å¤©ä»¥ä¸Šçš„æ•°æ®ä»¥è¿›è¡Œå‘¨å¯¹å‘¨åˆ†æ-ä¸Šä¼ è‡³å°‘30å¤©ä»¥ä¸Šçš„æ•°æ®ä»¥è¿›è¡Œæœˆå¯¹æœˆåˆ†æ-å½“å‰æ•°æ®èŒƒå›´ï¼š{valid_dates.min().strftime('%Y-%m-%d')}~{valid_dates.max().strftime('%Y-%m-%d')}""")st.info("ğŸ“Šä»å¯ä½¿ç”¨åŸºç¡€è¯Šæ–­åŠŸèƒ½ï¼ˆè´Ÿæ¯›åˆ©é¢„è­¦ã€è§’è‰²å¤±è¡¡ç­‰ï¼‰")#æ›´æ–°processed_dataprocessed_data['raw_data']=raw_dfdisplay_problem_diagnostic_center(processed_data)exceptExceptionase:st.error(f"âŒé—®é¢˜è¯Šæ–­åŠ è½½å¤±è´¥:{str(e)}")withst.expander("ğŸ”æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"):importtracebackst.code(traceback.format_exc())#===Tab5:å¤šå•†å“è®¢å•å¼•å¯¼===withtab5:st.header("ğŸ›’å¤šå•†å“è®¢å•å¼•å¯¼åˆ†æ")st.info("""**ğŸ“Šç»Ÿè®¡å‘ç°**ï¼šå•†å“æ•°é‡æ¯å¢åŠ 1ä¸ªï¼Œå®¢å•ä»·å¹³å‡å¢åŠ **Â¥3.16**ï¼ˆåŸºäº6297ä¸ªè®¢å•çš„å›å½’åˆ†æï¼‰**ğŸ¯åˆ†æç›®æ ‡**ï¼šé€šè¿‡æ•°æ®åˆ†æï¼Œæ‰¾åˆ°æå‡å¤šå•†å“è®¢å•ç‡çš„æœ‰æ•ˆç­–ç•¥ï¼Œä»è€Œæå‡æ•´ä½“å®¢å•ä»·""")#æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ æ•°æ®has_data=Falsecurrent_df=Noneif"uploaded_order_data"inst.session_state:current_data=st.session_state["uploaded_order_data"]if"raw_data"incurrent_data:current_df=current_data["raw_data"]has_data=Trueifnothas_data:st.warning("âš ï¸è¯·å…ˆåœ¨ã€è®¢å•æ•°æ®åˆ†æã€æ ‡ç­¾é¡µä¸Šä¼ æ•°æ®")withst.expander("ğŸ“‹æŸ¥çœ‹æ‰€éœ€æ•°æ®æ ¼å¼"):st.markdown("""**å¿…éœ€å­—æ®µ**ï¼š-`è®¢å•ID`:è®¢å•å”¯ä¸€æ ‡è¯†-`å•†å“åç§°`:å•†å“åç§°-`å•†å“å®å”®ä»·`:å•†å“å®é™…å”®ä»·**å¯é€‰å­—æ®µ**ï¼ˆå¢å¼ºåˆ†æï¼‰ï¼š-`ä¸‹å•æ—¶é—´`:è®¢å•æ—¶é—´-`ä¸€çº§åˆ†ç±»å`:å•†å“åˆ†ç±»-`åˆ©æ¶¦é¢`:å•†å“åˆ©æ¶¦**ç¤ºä¾‹æ•°æ®**ï¼š```è®¢å•ID|å•†å“åç§°|å•†å“å®å”®ä»·ORD001|å¯å£å¯ä¹|3.5ORD001|è–¯ç‰‡|5.8ORD002|ç‰›å¥¶|12.0```""")else:#å¯¼å…¥å¤šå•†å“è®¢å•åˆ†ææ¨¡å—try:fromå¤šå•†å“è®¢å•å¼•å¯¼åˆ†æçœ‹æ¿import(filter_retail_data,calculate_order_item_stats,render_order_quantity_distribution,render_item_quantity_analysis,render_frequent_combos,render_single_order_diagnosis,render_promotion_suggestions)#è¿‡æ»¤O2Oé›¶å”®æ•°æ®ï¼ˆå‰”é™¤å’–å•¡ç­‰å…¶ä»–ä¸šåŠ¡æ¸ é“ï¼‰current_df_filtered=filter_retail_data(current_df)#æ˜¾ç¤ºè¿‡æ»¤ä¿¡æ¯iflen(current_df_filtered)<len(current_df):excluded_count=len(current_df)-len(current_df_filtered)st.info(f"â„¹ï¸å·²è‡ªåŠ¨å‰”é™¤å’–å•¡æ¸ é“æ•°æ®{excluded_count}è¡Œï¼Œä¿ç•™O2Oé›¶å”®æ•°æ®{len(current_df_filtered)}è¡Œ")#è®¡ç®—è®¢å•ç»Ÿè®¡order_stats=calculate_order_item_stats(current_df_filtered)#æ˜¾ç¤ºå„ä¸ªåˆ†ææ¨¡å—st.markdown("---")render_order_quantity_distribution(order_stats)st.markdown("---")render_item_quantity_analysis(order_stats)st.markdown("---")render_frequent_combos(current_df_filtered)st.markdown("---")render_single_order_diagnosis(current_df_filtered,order_stats)st.markdown("---")render_promotion_suggestions(order_stats)exceptExceptionase:st.error(f"åˆ†æè¿‡ç¨‹å‡ºé”™:{str(e)}")withst.expander("æŸ¥çœ‹è¯¦ç»†é”™è¯¯"):importtracebackst.code(traceback.format_exc())#===Tab6:å•†å“åˆ†ç±»ç»“æ„ç«äº‰åŠ›===withtab6:#æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ å¹¶å¤„ç†æ•°æ®has_data=Falsecurrent_df=None#ä¼˜å…ˆæ£€æŸ¥å·²å¤„ç†çš„æ•°æ®if"current_data"inst.session_stateand"raw_data"inst.session_state["current_data"]:current_df=st.session_state["current_data"]["raw_data"]has_data=True#å…¶æ¬¡æ£€æŸ¥ä¸Šä¼ çš„æ•°æ®elif"uploaded_order_data"inst.session_stateand"raw_data"inst.session_state["uploaded_order_data"]:current_df=st.session_state["uploaded_order_data"]["raw_data"]has_data=Trueifnothas_data:st.warning("âš ï¸è¯·å…ˆåœ¨ã€è®¢å•æ•°æ®åˆ†æã€æ ‡ç­¾é¡µä¸Šä¼ æ•°æ®")st.info("ğŸ’¡å•†å“åˆ†ç±»åˆ†æéœ€è¦åŸºäºè®¢å•æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®ä¸­éœ€è¦åŒ…å«ã€ä¸€çº§åˆ†ç±»åã€å­—æ®µ")#æ˜¾ç¤ºæ•°æ®è¦æ±‚withst.expander("ğŸ“‹æŸ¥çœ‹æ•°æ®è¦æ±‚"):st.markdown("""**å¿…éœ€å­—æ®µ**ï¼š-`è®¢å•ID`:è®¢å•å”¯ä¸€æ ‡è¯†-`å•†å“åç§°`:å•†å“åç§°-`å•†å“å®å”®ä»·`:å•†å“å®é™…å”®ä»·-`ä¸€çº§åˆ†ç±»å`:å•†å“ä¸€çº§åˆ†ç±»ï¼ˆ**æ ¸å¿ƒå­—æ®µ**ï¼‰**å¯é€‰å­—æ®µ**ï¼ˆå¢å¼ºåˆ†æï¼‰ï¼š-`ä¸‰çº§åˆ†ç±»å`:å•†å“ä¸‰çº§åˆ†ç±»-`æˆæœ¬`:å•†å“æˆæœ¬ï¼ˆç”¨äºè®¡ç®—æ¯›åˆ©ç‡ï¼‰-`æ¸ é“`:è®¢å•æ¥æºæ¸ é“""")else:#æ£€æŸ¥å¿…éœ€å­—æ®µrequired_fields=['è®¢å•ID','å•†å“åç§°','å•†å“å®å”®ä»·']category_field='ä¸€çº§åˆ†ç±»å'if'ä¸€çº§åˆ†ç±»å'incurrent_df.columnselse'ä¸€çº§åˆ†ç±»'missing_fields=[fforfinrequired_fieldsiffnotincurrent_df.columns]ifmissing_fields:st.error(f"âŒæ•°æ®ç¼ºå°‘å¿…éœ€å­—æ®µ:{','.join(missing_fields)}")returnifcategory_fieldnotincurrent_df.columns:st.error("âŒæ•°æ®ä¸­ç¼ºå°‘åˆ†ç±»å­—æ®µï¼ˆä¸€çº§åˆ†ç±»åæˆ–ä¸€çº§åˆ†ç±»ï¼‰")st.info("ğŸ’¡å•†å“åˆ†ç±»åˆ†æéœ€è¦å•†å“åˆ†ç±»ä¿¡æ¯ï¼Œè¯·ç¡®ä¿æ•°æ®ä¸­åŒ…å«ã€ä¸€çº§åˆ†ç±»åã€æˆ–ã€ä¸€çº§åˆ†ç±»ã€å­—æ®µ")return#æ˜¾ç¤ºæ•°æ®æ¦‚è§ˆst.success(f"âœ…æ•°æ®å·²åŠ è½½ï¼š{len(current_df)}è¡Œè®¢å•æ•°æ®")#è°ƒç”¨å•†å“åˆ†ç±»åˆ†ææ¨¡å—ifCATEGORY_ANALYSIS_AVAILABLE:try:render_category_analysis(current_df)exceptExceptionase:st.error(f"âŒåˆ†æè¿‡ç¨‹å‡ºé”™:{str(e)}")withst.expander("ğŸ”æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"):importtracebackst.code(traceback.format_exc())#æä¾›å¯èƒ½çš„è§£å†³æ–¹æ¡ˆst.info("""**ğŸ’¡å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š1.æ£€æŸ¥æ•°æ®ä¸­æ˜¯å¦åŒ…å«ã€ä¸€çº§åˆ†ç±»åã€æˆ–ã€ä¸‰çº§åˆ†ç±»åã€å­—æ®µ2.ç¡®ä¿åˆ†ç±»å­—æ®µä¸ä¸ºç©º3.å¦‚æœæœ‰ç‰¹æ®Šå­—ç¬¦æˆ–ç¼–ç é—®é¢˜ï¼Œè¯·å°è¯•é‡æ–°å¯¼å‡ºæ•°æ®""")else:st.error("âŒå•†å“åˆ†ç±»ç»“æ„åˆ†ææ¨¡å—æœªåŠ è½½")st.info("è¯·æ£€æŸ¥`å•†å“åˆ†ç±»ç»“æ„åˆ†æ.py`æ–‡ä»¶æ˜¯å¦å­˜åœ¨")#===Tab7:é«˜çº§åŠŸèƒ½===withtab7:st.header("âš™ï¸é«˜çº§åŠŸèƒ½")#============å­æ ‡ç­¾é¡µ============adv_tab1,adv_tab2,adv_tab3,adv_tab4=st.tabs(["ğŸ”¬AIç»¼åˆåˆ†æ","ğŸ§ AIå­¦ä¹ ç³»ç»Ÿ","â„¹ï¸ç³»ç»Ÿä¿¡æ¯","ğŸ®æ¼”ç¤ºæ¨¡å¼"])#===é«˜çº§Tab1:AIç»¼åˆåˆ†æ===withadv_tab1:st.subheader("ğŸ”¬AIç»¼åˆåˆ†æ")st.info("æ­¤åŠŸèƒ½åŒ…å«ï¼šé”€å”®åˆ†æã€ç«å¯¹åˆ†æã€é£é™©è¯„ä¼°ã€ç­–ç•¥å»ºè®®ã€é¢„æµ‹åˆ†æç­‰å…¨é¢åˆ†æ")#æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ æ•°æ®if"uploaded_order_data"notinst.session_state:st.warning("âš ï¸è¯·å…ˆåœ¨ã€è®¢å•æ•°æ®åˆ†æã€æ ‡ç­¾é¡µä¸Šä¼ æ•°æ®")else:#åˆ†æå‚æ•°è®¾ç½®col1,col2=st.columns([3,1])withcol1:analysis_scope=st.multiselect("é€‰æ‹©åˆ†æç»´åº¦",["é”€å”®åˆ†æ","ç«å¯¹åˆ†æ","é£é™©è¯„ä¼°","ç­–ç•¥å»ºè®®","é¢„æµ‹åˆ†æ"],default=["é”€å”®åˆ†æ","ç­–ç•¥å»ºè®®"],)withcol2:forecast_days=st.number_input("é¢„æµ‹å¤©æ•°",7,90,30)#å¼€å§‹åˆ†ææŒ‰é’®ifst.button("ğŸš€å¼€å§‹AIç»¼åˆåˆ†æ",type="primary",use_container_width=True):current_data=st.session_state["uploaded_order_data"]withst.spinner("æ­£åœ¨è¿›è¡ŒAIç»¼åˆåˆ†æ..."):analysis_result=dashboard.comprehensive_analysis(current_data,current_data.get("competitor_data"),)st.session_state["analysis_result"]=analysis_resultst.session_state["current_data"]=current_datast.session_state["forecast_days"]=forecast_days#ä¿å­˜åˆ°æ•°æ®å¤„ç†å™¨data_processor.processed_data={"sales_data":current_data.get("product_data",pd.DataFrame()),"order_data":current_data.get("order_data",pd.DataFrame()),}st.success("âœ…åˆ†æå®Œæˆï¼")st.rerun()#æ˜¾ç¤ºåˆ†æç»“æœif"analysis_result"inst.session_state:st.markdown("---")display_analysis_results(st.session_state["analysis_result"],analysis_scope,dashboard)#===é«˜çº§Tab2:AIå­¦ä¹ ç³»ç»Ÿ===withadv_tab2:st.subheader("ğŸ§ AIå­¦ä¹ ç³»ç»Ÿ")learning_status=dashboard.get_learning_status()iflearning_status.get("enabled"):st.success("âœ…AIå­¦ä¹ ç³»ç»Ÿå·²å¯ç”¨")#å­¦ä¹ ç»Ÿè®¡learning_stats=learning_status.get("learning_statistics",{})iflearning_stats:col1,col2,col3=st.columns(3)col1.metric("æ€»å­¦ä¹ æ¬¡æ•°",learning_stats.get('total_learning_sessions',0))col2.metric("åœ¨çº¿æ›´æ–°",learning_stats.get('online_updates',0))col3.metric("æ‰¹é‡æ›´æ–°",learning_stats.get('batch_updates',0))#å­¦ä¹ æ“ä½œcol1,col2=st.columns(2)withcol1:ifst.button("ğŸ”„æ‰‹åŠ¨æ¨¡å‹è®­ç»ƒ",help="ä½¿ç”¨å†å²æ•°æ®æ‰‹åŠ¨è®­ç»ƒæ¨¡å‹"):sample_data=load_sample_data()withst.spinner("æ­£åœ¨è®­ç»ƒæ¨¡å‹..."):training_result=dashboard.manual_model_training([sample_data])iftraining_result.get("success"):st.success("ğŸ‰æ¨¡å‹è®­ç»ƒå®Œæˆ")else:st.error(f"âŒè®­ç»ƒå¤±è´¥:{training_result.get('error','æœªçŸ¥é”™è¯¯')}")withcol2:ifst.button("ğŸ“„å¯¼å‡ºå­¦ä¹ æŠ¥å‘Š"):report_path=dashboard.export_learning_insights()ifreport_path:st.success(f"âœ…æŠ¥å‘Šå·²å¯¼å‡º:{report_path}")else:st.error("âŒå¯¼å‡ºå¤±è´¥")else:st.info("AIå­¦ä¹ ç³»ç»Ÿæš‚æœªå¯ç”¨")#===é«˜çº§Tab3:ç³»ç»Ÿä¿¡æ¯===withadv_tab3:st.subheader("â„¹ï¸ç³»ç»Ÿä¿¡æ¯")real_data,load_messages=load_real_business_data()ifload_messages:st.warning("âš ï¸æ•°æ®åŠ è½½æ¶ˆæ¯:")formsginload_messages:st.write(f"â€¢{msg}")ifreal_dataisnotNone:st.success("âœ…ç³»ç»Ÿå·²æ£€æµ‹åˆ°çœŸå®æ•°æ®æ–‡ä»¶")col1,col2=st.columns(2)col1.metric("æ•°æ®æº",real_data['data_source'])col2.metric("æ•°æ®æœŸé—´",real_data['data_period'])col1.metric("è®¢å•æ•°",f"{real_data['total_orders']:,}")col2.metric("å•†å“ç§ç±»",f"{real_data['total_products']:,}")else:st.info("æœªæ£€æµ‹åˆ°çœŸå®æ•°æ®æ–‡ä»¶")#===é«˜çº§Tab4:æ¼”ç¤ºæ¨¡å¼===withadv_tab4:st.subheader("ğŸ®æ¼”ç¤ºæ¨¡å¼")st.info("æ¼”ç¤ºæ¨¡å¼ä½¿ç”¨å†…ç½®ç¤ºä¾‹æ•°æ®ï¼Œå¯ç”¨äºç•Œé¢æ¼”ç¤ºå’ŒåŠŸèƒ½æµ‹è¯•")ifst.button("ğŸªå¯åŠ¨ç¤ºä¾‹æ•°æ®æ¼”ç¤º",type="secondary"):sample_data=load_sample_data()st.session_state["uploaded_order_data"]=sample_datast.session_state["current_data"]=sample_datast.success("âœ…å·²åŠ è½½ç¤ºä¾‹æ•°æ®ï¼Œè¯·å‰å¾€å…¶ä»–æ ‡ç­¾é¡µä½“éªŒåŠŸèƒ½")st.rerun()defdisplay_analysis_results(analysis_result,analysis_scope,dashboard_instance):"""æ˜¾ç¤ºåˆ†æç»“æœ"""#1.æ€»ä½“æ¦‚è§ˆst.subheader("ğŸ“Šåˆ†ææ¦‚è§ˆ")col1,col2,col3,col4=st.columns(4)withcol1:st.metric("æ•°æ®è´¨é‡è¯„åˆ†",f"{analysis_result['store_overview']['data_quality_score']:.2f}",delta="è‰¯å¥½"ifanalysis_result['store_overview']['data_quality_score']>0.7else"éœ€æ”¹å–„")withcol2:st.metric("ç”Ÿæˆå‡è®¾æ•°é‡",len(analysis_result['hypothesis_analysis']),delta="å·²éªŒè¯")withcol3:total_decisions=sum(len(options)foroptionsinanalysis_result['strategic_decisions'].values())st.metric("ç­–ç•¥å»ºè®®æ•°",total_decisions,delta="å¯æ‰§è¡Œ")withcol4:st.metric("ç»¼åˆå»ºè®®æ•°",len(analysis_result['comprehensive_recommendations']),delta="ä¼˜å…ˆçº§æ’åº")#2.æ ¸å¿ƒå»ºè®®å±•ç¤ºst.subheader("ğŸ¯æ ¸å¿ƒå»ºè®®")fori,recommendationinenumerate(analysis_result['comprehensive_recommendations'][:5],1):st.markdown(f"""<divclass="recommendation-box"><strong>å»ºè®®{i}:</strong>{recommendation}</div>""",unsafe_allow_html=True)#3.é€‰é¡¹å¡å¼è¯¦ç»†åˆ†ætabs_to_create=["ğŸ›ï¸å•†å“ç­–ç•¥","ğŸ“ˆè¶‹åŠ¿é¢„æµ‹","âš ï¸é£é™©è¯„ä¼°","ğŸ¢ç«å¯¹åˆ†æ","ğŸ”¬å‡è®¾éªŒè¯","ğŸ§ å­¦ä¹ æ•ˆæœ","ğŸ’¹æ¯”ä»·çœ‹æ¿","ğŸ¯åœºæ™¯è¥é”€","ğŸ“‹é—®é¢˜è¯Šæ–­"]tab_objects=st.tabs(tabs_to_create)tab_map={name:objforname,objinzip(tabs_to_create,tab_objects)}withtab_map["ğŸ›ï¸å•†å“ç­–ç•¥"]:display_product_strategy(analysis_result)withtab_map["ğŸ“ˆè¶‹åŠ¿é¢„æµ‹"]:display_trend_analysis(analysis_result)withtab_map["âš ï¸é£é™©è¯„ä¼°"]:display_risk_assessment(analysis_result)withtab_map["ğŸ¢ç«å¯¹åˆ†æ"]:display_competitor_analysis(analysis_result)withtab_map["ğŸ”¬å‡è®¾éªŒè¯"]:display_hypothesis_validation(analysis_result)withtab_map["ğŸ§ å­¦ä¹ æ•ˆæœ"]:display_learning_effects(analysis_result,dashboard_instance)withtab_map["ğŸ’¹æ¯”ä»·çœ‹æ¿"]:st.caption("ğŸ”åˆ†æç»“æœä¸­çš„æ¯”ä»·çœ‹æ¿")render_unified_price_comparison_module()#æ·»åŠ è®¢å•æ•°æ®ä¸Šä¼ åŠŸèƒ½st.markdown("---")st.subheader("ğŸ“Šè®¢å•æ•°æ®åˆ†æ")render_order_data_uploader()withtab_map["ğŸ¯åœºæ™¯è¥é”€"]:display_scenario_marketing_dashboard(st.session_state.get("current_data",{}))withtab_map["ğŸ“‹é—®é¢˜è¯Šæ–­"]:display_problem_diagnostic_center(st.session_state.get("current_data",{}))defdisplay_product_strategy(analysis_result):"""æ˜¾ç¤ºå•†å“ç­–ç•¥åˆ†æ"""st.subheader("ğŸ›ï¸å•†å“ç­–ç•¥åˆ†æ")if'strategic_decisions'inanalysis_result:decisions=analysis_result['strategic_decisions']#æµé‡å“ç­–ç•¥if'æµé‡å“é€‰æ‹©'indecisions:st.write("**ğŸ¯æµé‡å“å»ºè®®**")traffic_options=decisions['æµé‡å“é€‰æ‹©']iftraffic_options:foroptionintraffic_options:col1,col2=st.columns([3,1])withcol1:st.write(f"**{option.description}**")st.write(f"é¢„æœŸå®¢æµå¢é•¿:+{option.expected_outcome.get('å®¢æµé‡å¢é•¿',0)*100:.1f}%")st.write(f"å…³è”é”€å”®æå‡:+{option.expected_outcome.get('å…³è”é”€å”®æå‡',0)*100:.1f}%")withcol2:confidence_color="green"ifoption.confidence_score>0.7else"orange"st.markdown(f"<divstyle='text-align:center;color:{confidence_color};font-size:1.2em;font-weight:bold;'>ç½®ä¿¡åº¦<br>{option.confidence_score:.1%}</div>",unsafe_allow_html=True)#æŠ˜æ‰£å“ç­–ç•¥if'æŠ˜æ‰£å“ç­–ç•¥'indecisions:st.write("**ğŸ’°æŠ˜æ‰£å“å»ºè®®**")discount_options=decisions['æŠ˜æ‰£å“ç­–ç•¥']ifdiscount_options:foroptionindiscount_options:withst.expander(f"æŠ˜æ‰£æ–¹æ¡ˆ:{option.description}"):#åˆ›å»ºæŒ‡æ ‡å±•ç¤ºcol1,col2,col3=st.columns(3)withcol1:st.metric("é¢„æœŸé”€é‡æå‡",f"+{option.expected_outcome.get('é”€é‡æå‡',0)*100:.0f}%")withcol2:st.metric("åº“å­˜å‘¨è½¬æ”¹å–„",f"+{option.expected_outcome.get('åº“å­˜å‘¨è½¬',0)*100:.0f}%")withcol3:impact=option.expected_outcome.get('æ¯›åˆ©ç‡å½±å“',0)st.metric("æ¯›åˆ©ç‡å½±å“",f"{impact*100:+.0f}%",delta="é¢„æœŸèŒƒå›´å†…"ifabs(impact)<0.3else"éœ€è°¨æ…")#å®šä»·ç­–ç•¥if'å®šä»·ç­–ç•¥'indecisions:st.write("**ğŸ’²å®šä»·ç­–ç•¥åˆ†æ**")pricing_options=decisions['å®šä»·ç­–ç•¥']#åˆ›å»ºå®šä»·ç­–ç•¥å¯¹æ¯”è¡¨ifpricing_options:pricing_data=[]foroptioninpricing_options:pricing_data.append({'ç­–ç•¥':option.description,'é£é™©ç­‰çº§':f"{option.risk_level:.1%}",'é¢„æœŸå¸‚åœºä»½é¢':f"+{option.expected_outcome.get('å¸‚åœºä»½é¢',0)*100:.1f}%",'é¢„æœŸæ¯›åˆ©å½±å“':f"{option.expected_outcome.get('æ¯›åˆ©ç‡',0)*100:+.1f}%",'æ¨èåº¦':f"{option.confidence_score:.1%}"})pricing_df=pd.DataFrame(pricing_data)st.dataframe(pricing_df,width='stretch')defdisplay_trend_analysis(analysis_result):"""æ˜¾ç¤ºè¶‹åŠ¿åˆ†æ"""st.subheader("ğŸ“ˆé”€å”®è¶‹åŠ¿é¢„æµ‹")if'trend_predictions'inanalysis_result:predictions=analysis_result['trend_predictions']#è¶‹åŠ¿å›¾if'predictions'inpredictions:pred_df=predictions['predictions']fig=go.Figure()#ä¸»è¶‹åŠ¿çº¿fig.add_trace(go.Scatter(x=pred_df['date'],y=pred_df['predicted_growth_rate'],mode='lines+markers',name='é¢„æµ‹å¢é•¿ç‡',line=dict(color='#1f77b4',width=3)))#ç½®ä¿¡åŒºé—´fig.add_trace(go.Scatter(x=pred_df['date'],y=pred_df['confidence_upper'],mode='lines',line=dict(width=0),showlegend=False))fig.add_trace(go.Scatter(x=pred_df['date'],y=pred_df['confidence_lower'],fill='tonexty',mode='lines',line=dict(width=0),name='ç½®ä¿¡åŒºé—´',fillcolor='rgba(31,119,180,0.2)'))fig.update_layout(title="æœªæ¥30å¤©é”€å”®å¢é•¿è¶‹åŠ¿é¢„æµ‹",xaxis_title="æ—¥æœŸ",yaxis_title="å¢é•¿ç‡",hovermode='xunified',template='plotly_white')st.plotly_chart(fig,width='stretch',key='prediction_sales_growth_trend')#è¶‹åŠ¿æ´å¯Ÿif'trend_summary'inpredictions:trend_summary=predictions['trend_summary']col1,col2,col3=st.columns(3)withcol1:trend_color="green"iftrend_summary['overall_trend']=="ä¸Šå‡"else"red"st.markdown(f"""<divclass="metric-card"><h4>æ•´ä½“è¶‹åŠ¿</h4><spanstyle="color:{trend_color};font-size:1.5em;font-weight:bold;">{trend_summary['overall_trend']}</span></div>""",unsafe_allow_html=True)withcol2:volatility_color="red"iftrend_summary['volatility']=="é«˜"else"green"st.markdown(f"""<divclass="metric-card"><h4>æ³¢åŠ¨æ€§</h4><spanstyle="color:{volatility_color};font-size:1.5em;font-weight:bold;">{trend_summary['volatility']}</span></div>""",unsafe_allow_html=True)withcol3:peak_count=len(trend_summary['peak_periods'])st.markdown(f"""<divclass="metric-card"><h4>é”€å”®é«˜å³°æœŸ</h4><spanstyle="color:#1f77b4;font-size:1.5em;font-weight:bold;">{peak_count}ä¸ª</span></div>""",unsafe_allow_html=True)#å…³é”®æ´å¯Ÿif'key_insights'inpredictions:st.write("**ğŸ”å…³é”®æ´å¯Ÿ**")forinsightinpredictions['key_insights']:st.markdown(f"â€¢{insight}")defdisplay_risk_assessment(analysis_result):"""æ˜¾ç¤ºé£é™©è¯„ä¼°"""st.subheader("âš ï¸é£é™©è¯„ä¼°åˆ†æ")if'risk_assessment'inanalysis_result:risks=analysis_result['risk_assessment']#é£é™©çŸ©é˜µå¯è§†åŒ–risk_data=[]all_risks=[]forcategory,risk_factorsinrisks.items():forfactor,risk_infoinrisk_factors.items():risk_data.append({'category':category,'factor':factor,'probability':risk_info['probability'],'impact':risk_info['impact'],'risk_score':risk_info['risk_score']})all_risks.append(risk_info['risk_score'])#åˆ›å»ºé£é™©çŸ©é˜µå›¾risk_df=pd.DataFrame(risk_data)fig=px.scatter(risk_df,x='probability',y='impact',size='risk_score',color='category',hover_data=['factor'],title="é£é™©çŸ©é˜µåˆ†æ",labels={'probability':'å‘ç”Ÿæ¦‚ç‡','impact':'å½±å“ç¨‹åº¦','category':'é£é™©ç±»åˆ«'})fig.update_layout(xaxis=dict(range=[0,1]),yaxis=dict(range=[0,1]),template='plotly_white')st.plotly_chart(fig,width='stretch',key='risk_probability_impact_matrix')#é«˜é£é™©é¡¹ç›®è­¦ç¤ºhigh_risks=[itemforiteminrisk_dataifitem['risk_score']>0.5]ifhigh_risks:st.write("**ğŸš¨é«˜é£é™©è­¦ç¤º**")forriskinhigh_risks:risk_level="high-risk"ifrisk['risk_score']>0.7else"risk-warning"st.markdown(f"""<divclass="{risk_level}"><strong>âš ï¸{risk['factor']}</strong><br>å‘ç”Ÿæ¦‚ç‡:{risk['probability']:.1%}|å½±å“ç¨‹åº¦:{risk['impact']:.1%}|é£é™©è¯„åˆ†:{risk['risk_score']:.2f}</div>""",unsafe_allow_html=True)#ç¼“è§£ç­–ç•¥st.write("**ğŸ›¡ï¸é£é™©ç¼“è§£ç­–ç•¥**")forcategory,risk_factorsinrisks.items():withst.expander(f"{category}ç¼“è§£ç­–ç•¥"):forfactor,risk_infoinrisk_factors.items():ifrisk_info['risk_score']>0.3:#æ˜¾ç¤ºä¸­é«˜é£é™©çš„ç¼“è§£ç­–ç•¥st.write(f"**{factor}:**")forsuggestioninrisk_info['mitigation_suggestions']:st.write(f"â€¢{suggestion}")defdisplay_competitor_analysis(analysis_result):"""æ˜¾ç¤ºç«å¯¹åˆ†æ"""st.subheader("ğŸ¢ç«å¯¹åˆ†æ")if'competitor_analysis'inanalysis_result:competitor_data=analysis_result['competitor_analysis']#å®šä»·å¯¹æ¯”åˆ†æif'å®šä»·å¯¹æ¯”'incompetitor_dataand'comparison_details'incompetitor_data['å®šä»·å¯¹æ¯”']:st.write("**ğŸ’°ä»·æ ¼ç«äº‰åŠ›åˆ†æ**")price_comparisons=competitor_data['å®šä»·å¯¹æ¯”']['comparison_details']ifprice_comparisons:#åˆ›å»ºä»·æ ¼å¯¹æ¯”å›¾comparison_df=pd.DataFrame(price_comparisons)fig=go.Figure()#ç«å“ä»·æ ¼fig.add_trace(go.Bar(name='ç«å“ä»·æ ¼',x=comparison_df['product'],y=comparison_df['competitor_price'],marker_color='lightcoral'))#è‡ªå·±ä»·æ ¼fig.add_trace(go.Bar(name='æˆ‘æ–¹ä»·æ ¼',x=comparison_df['product'],y=comparison_df['own_price'],marker_color='lightblue'))fig.update_layout(title='ä»·æ ¼å¯¹æ¯”åˆ†æ',xaxis_title='å•†å“',yaxis_title='ä»·æ ¼(å…ƒ)',barmode='group',template='plotly_white')st.plotly_chart(fig,width='stretch',key='strategy_price_comparison')#ä»·æ ¼å»ºè®®è¡¨st.write("**ä»·æ ¼è°ƒæ•´å»ºè®®**")recommendation_data=[]foriteminprice_comparisons:recommendation_data.append({'å•†å“':item['product'],'ç«å“ä»·æ ¼':f"Â¥{item['competitor_price']:.2f}",'æˆ‘æ–¹ä»·æ ¼':f"Â¥{item['own_price']:.2f}",'ä»·å·®':f"{item['price_gap_pct']:.1%}",'å»ºè®®':item['recommendation']})rec_df=pd.DataFrame(recommendation_data)st.dataframe(rec_df,width='stretch')#æˆæœ¬åˆ©æ¶¦å€’æ¨if'æˆæœ¬åˆ©æ¶¦å€’æ¨'incompetitor_data:st.write("**ğŸ“Šç«å“ç›ˆåˆ©èƒ½åŠ›åˆ†æ**")profitability=competitor_data['æˆæœ¬åˆ©æ¶¦å€’æ¨']if'high_margin_products'inprofitability:high_margin=profitability['high_margin_products']ifhigh_margin:st.write("ç«å“é«˜åˆ©æ¶¦å•†å“TOP5:")margin_df=pd.DataFrame(high_margin[:5])fig=px.bar(margin_df,x='product',y='margin',title='ç«å“é«˜åˆ©æ¶¦å•†å“åˆ†æ',labels={'product':'å•†å“','margin':'æ¯›åˆ©ç‡'})st.plotly_chart(fig,width='stretch',key='strategy_competitor_high_margin')if'estimated_monthly_revenue'inprofitability:estimated_revenue=profitability['estimated_monthly_revenue']st.metric("ç«å“é¢„ä¼°æœˆè¥æ”¶",f"Â¥{estimated_revenue:,.0f}",help="åŸºäºå”®ä»·å’Œæœˆé”€é‡ä¼°ç®—")#é€‰å€å»ºè®®if'é€‰å€å»ºè®®'incompetitor_data:location_rec=competitor_data['é€‰å€å»ºè®®']st.write("**ğŸ¢é€‰å€ç­–ç•¥å»ºè®®**")col1,col2=st.columns(2)withcol1:st.markdown(f"""<divclass="recommendation-box"><h4>é€‰å€ç­–ç•¥</h4>{location_rec['proximity_strategy']}</div>""",unsafe_allow_html=True)withcol2:if'risk_assessment'inlocation_rec:risks=location_rec['risk_assessment']fig=go.Figure(go.Bar(x=list(risks.keys()),y=list(risks.values()),marker_color=['red'ifv>0.6else'orange'ifv>0.4else'green'forvinrisks.values()]))fig.update_layout(title='é€‰å€é£é™©è¯„ä¼°',yaxis_title='é£é™©ç¨‹åº¦',template='plotly_white')st.plotly_chart(fig,width='stretch',key='strategy_location_risk_assessment')defdisplay_hypothesis_validation(analysis_result):"""æ˜¾ç¤ºå‡è®¾éªŒè¯"""st.subheader("ğŸ”¬å•†ä¸šå‡è®¾éªŒè¯")if'hypothesis_analysis'inanalysis_result:hypotheses=analysis_result['hypothesis_analysis']ifhypotheses:forhyp_id,hypothesisinhypotheses.items():withst.expander(f"å‡è®¾{hyp_id}:{hypothesis['description']}"):col1,col2=st.columns(2)withcol1:st.write("**å‡è®¾è¯¦æƒ…**")st.write(f"å‡è®¾ID:{hypothesis['hypothesis_id']}")st.write(f"ç½®ä¿¡åº¦:{hypothesis['confidence_level']:.1%}")ifhypothesis['validation_result']isnotNone:status="âœ…å·²éªŒè¯"ifhypothesis['validation_result']else"âŒæœªé€šè¿‡"st.write(f"éªŒè¯çŠ¶æ€:{status}")withcol2:st.write("**æµ‹è¯•æŒ‡æ ‡**")formetricinhypothesis['test_metrics']:st.write(f"â€¢{metric}")st.write("**æ”¯æŒæ•°æ®**")supporting_data=hypothesis['supporting_data']#åˆ›å»ºæ”¯æŒæ•°æ®çš„å¯è§†åŒ–ifsupporting_data:data_items=list(supporting_data.items())iflen(data_items)>0:#æ•°å€¼å‹æ•°æ®ç”¨å›¾è¡¨å±•ç¤ºnumeric_data={k:vfork,vindata_itemsifisinstance(v,(int,float))}ifnumeric_data:fig=go.Figure(go.Bar(x=list(numeric_data.keys()),y=list(numeric_data.values()),marker_color='lightblue'))fig.update_layout(title='å‡è®¾æ”¯æŒæ•°æ®',template='plotly_white')st.plotly_chart(fig,width='stretch',key=f'hypothesis_chart_{hyp_id}')else:#éæ•°å€¼æ•°æ®ç”¨è¡¨æ ¼å±•ç¤ºst.json(supporting_data)else:st.info("æš‚æ— å•†ä¸šå‡è®¾æ•°æ®ï¼Œç³»ç»Ÿå°†åŸºäºå®é™…ç»è¥æ•°æ®è‡ªåŠ¨ç”Ÿæˆå‡è®¾")defdisplay_learning_effects(analysis_result,dashboard_instance):"""æ˜¾ç¤ºå­¦ä¹ æ•ˆæœåˆ†æ"""st.subheader("ğŸ§ AIå­¦ä¹ æ•ˆæœåˆ†æ")#æ£€æŸ¥å­¦ä¹ å…ƒæ•°æ®learning_metadata=analysis_result.get('learning_metadata',{})ifnotlearning_metadata.get('learning_enabled',False):st.warning("âš ï¸AIå­¦ä¹ ç³»ç»Ÿæœªå¯ç”¨æˆ–è¿è¡Œå¼‚å¸¸")if'error'inlearning_metadata:st.error(f"é”™è¯¯ä¿¡æ¯:{learning_metadata['error']}")return#1.å­¦ä¹ çŠ¶æ€æ¦‚è§ˆst.write("**ğŸ“Šå­¦ä¹ çŠ¶æ€æ¦‚è§ˆ**")learning_stats=learning_metadata.get('learning_statistics',{})col1,col2,col3,col4=st.columns(4)withcol1:total_sessions=learning_stats.get('total_learning_sessions',0)st.metric("æ€»å­¦ä¹ æ¬¡æ•°",total_sessions,delta="ç´¯ç§¯ç»éªŒ"iftotal_sessions>0else"å¾…å¼€å§‹")withcol2:online_updates=learning_stats.get('online_updates',0)st.metric("åœ¨çº¿å­¦ä¹ ",online_updates,delta="å®æ—¶ä¼˜åŒ–"ifonline_updates>0else"æš‚æ— ")withcol3:batch_updates=learning_stats.get('batch_updates',0)st.metric("æ‰¹é‡è®­ç»ƒ",batch_updates,delta="æ·±åº¦å­¦ä¹ "ifbatch_updates>0else"æš‚æ— ")withcol4:recent_activity=learning_stats.get('recent_activity',{})recent_sessions=recent_activity.get('total_sessions',0)st.metric("è¿‘7å¤©æ´»åŠ¨",recent_sessions,delta="æ´»è·ƒ"ifrecent_sessions>5else"ç¨³å®š"ifrecent_sessions>0else"å¾…æ¿€æ´»")#2.æ¨¡å‹æ€§èƒ½è¶‹åŠ¿if'performance_trends'inlearning_stats:st.write("**ğŸ“ˆæ¨¡å‹æ€§èƒ½è¶‹åŠ¿**")performance_trends=learning_stats['performance_trends']ifperformance_trends:#åˆ›å»ºæ€§èƒ½è¶‹åŠ¿å›¾è¡¨trend_data=[]formodel_name,trend_infoinperformance_trends.items():trend_data.append({'Model':model_name,'Direction':trend_info['direction'],'Rate':trend_info['rate'],'Current_MAE':trend_info['current_mae'],'Sample_Count':trend_info['sample_count']})trend_df=pd.DataFrame(trend_data)#æ€§èƒ½æ–¹å‘é¥¼å›¾direction_counts=trend_df['Direction'].value_counts()fig_pie=px.pie(values=direction_counts.values,names=direction_counts.index,title="æ¨¡å‹æ€§èƒ½è¶‹åŠ¿åˆ†å¸ƒ",color_discrete_map={'improving':'#2E8B57','declining':'#DC143C','stable':'#4682B4'})col1,col2=st.columns(2)withcol1:st.plotly_chart(fig_pie,key="performance_pie")withcol2:#æ€§èƒ½è¯¦ç»†è¡¨æ ¼st.write("**æ¨¡å‹æ€§èƒ½è¯¦æƒ…**")display_df=trend_df.copy()display_df['Direction']=display_df['Direction'].map({'improving':'ğŸ“ˆæ”¹å–„ä¸­','declining':'ğŸ“‰ä¸‹é™ä¸­','stable':'â¡ï¸ç¨³å®š'})display_df['Rate']=display_df['Rate'].apply(lambdax:f"{x:.1%}")display_df['Current_MAE']=display_df['Current_MAE'].apply(lambdax:f"{x:.4f}")st.dataframe(display_df,key="performance_table")else:st.info("æš‚æ— æ¨¡å‹æ€§èƒ½è¶‹åŠ¿æ•°æ®")#3.å¢å¼ºé¢„æµ‹ç»“æœif'enhanced_predictions'inanalysis_result:st.write("**ğŸ”®AIå¢å¼ºé¢„æµ‹ç»“æœ**")enhanced_predictions=analysis_result['enhanced_predictions']prediction_meta=enhanced_predictions.get('meta',{})#æ˜¾ç¤ºé¢„æµ‹å…ƒä¿¡æ¯col1,col2,col3=st.columns(3)withcol1:st.metric("é¢„æµ‹æ—¶é—´",prediction_meta.get('prediction_time','N/A')[:19]ifprediction_meta.get('prediction_time')else'N/A',delta="æœ€æ–°")withcol2:st.metric("ç‰¹å¾ç»´åº¦",prediction_meta.get('feature_count',0),delta="å¤šç»´åˆ†æ")withcol3:models_used=prediction_meta.get('models_used',[])st.metric("ä½¿ç”¨æ¨¡å‹",len(models_used),delta="é›†æˆé¢„æµ‹")#æ˜¾ç¤ºå„æ¨¡å‹é¢„æµ‹ç»“æœformodel_name,prediction_statsinenhanced_predictions.items():ifmodel_name=='meta':continuewithst.expander(f"æ¨¡å‹{model_name}é¢„æµ‹è¯¦æƒ…"):col1,col2,col3,col4=st.columns(4)withcol1:st.metric("é¢„æµ‹å‡å€¼",f"{prediction_stats.get('mean',0):.2f}")withcol2:st.metric("æ ‡å‡†å·®",f"{prediction_stats.get('std',0):.2f}")withcol3:st.metric("æœ€å°å€¼",f"{prediction_stats.get('min',0):.2f}")withcol4:st.metric("æœ€å¤§å€¼",f"{prediction_stats.get('max',0):.2f}")#é¢„æµ‹å€¼åˆ†å¸ƒå›¾predictions_list=prediction_stats.get('predictions',[])ifpredictions_list:fig_hist=px.histogram(x=predictions_list,title=f"{model_name}é¢„æµ‹å€¼åˆ†å¸ƒ",labels={'x':'é¢„æµ‹å€¼','y':'é¢‘æ¬¡'})st.plotly_chart(fig_hist,key=f"pred_hist_{model_name}")#4.è‡ªé€‚åº”å»ºè®®adaptive_recs=learning_metadata.get('adaptive_recommendations',[])ifadaptive_recs:st.write("**ğŸ’¡AIè‡ªé€‚åº”å»ºè®®**")fori,recommendationinenumerate(adaptive_recs,1):st.markdown(f"""<divclass="recommendation-box"><strong>AIå»ºè®®{i}:</strong>{recommendation}</div>""",unsafe_allow_html=True)else:st.info("æš‚æ— AIè‡ªé€‚åº”å»ºè®®ï¼Œç³»ç»Ÿæ­£åœ¨å­¦ä¹ ä¸­...")#5.æ•°æ®è´¨é‡è¯„ä¼°try:learning_status=dashboard_instance.get_learning_status()data_stats=learning_status.get('data_statistics',{})ifdata_stats:st.write("**ğŸ“Šå­¦ä¹ æ•°æ®è´¨é‡æ¦‚è§ˆ**")col1,col2,col3=st.columns(3)withcol1:st.metric("æ•°æ®é›†æ€»æ•°",data_stats.get('total_datasets',0),delta="å†å²ç§¯ç´¯")withcol2:avg_quality=data_stats.get('average_quality_score',0)quality_label="ä¼˜ç§€"ifavg_quality>0.8else"è‰¯å¥½"ifavg_quality>0.6else"å¾…æ”¹å–„"st.metric("å¹³å‡è´¨é‡è¯„åˆ†",f"{avg_quality:.3f}",delta=quality_label)withcol3:recent_datasets=data_stats.get('recent_datasets_7days',0)st.metric("è¿‘æœŸæ–°å¢",recent_datasets,delta="æŒç»­æ›´æ–°"ifrecent_datasets>0else"ç¨³å®šæœŸ")#æ•°æ®è´¨é‡åˆ†å¸ƒquality_dist=data_stats.get('quality_distribution',{})ifquality_dist:fig_quality=px.bar(x=list(quality_dist.keys()),y=list(quality_dist.values()),title="æ•°æ®è´¨é‡åˆ†å¸ƒ",labels={'x':'è´¨é‡ç­‰çº§','y':'æ•°æ®é›†æ•°é‡'},color=list(quality_dist.values()),color_continuous_scale=['red','orange','yellow','green'])st.plotly_chart(fig_quality,key="quality_distribution")exceptExceptionase:st.error(f"è·å–å­¦ä¹ çŠ¶æ€å¤±è´¥:{e}")defrender_order_analysis_module(current_data:Dict[str,Any])->None:"""æ¸²æŸ“è®¢å•æ•°æ®åˆ†ææ¨¡å—"""st.write("**è®¢å•æ•°æ®ç»¼åˆåˆ†æ-åŸºäºå®é™…ä¸šåŠ¡æ•°æ®æ·±åº¦æ´å¯Ÿ**")#æ£€æŸ¥æ˜¯å¦æœ‰è®¢å•æ•°æ®order_data=current_data.get("order_data",pd.DataFrame())iforder_data.empty:st.info("ğŸ“ˆæš‚æ— è®¢å•æ•°æ®ï¼Œè¯·åŠ è½½åŒ…å«è®¢å•ä¿¡æ¯çš„Excelæ–‡ä»¶")#æ˜¾ç¤ºè®¢å•æ•°æ®æ ¼å¼è¦æ±‚withst.expander("ğŸ“‹è®¢å•æ•°æ®æ ¼å¼è¦æ±‚"):st.markdown("""**å¿…éœ€å­—æ®µï¼š**-`è®¢å•ID`:è®¢å•å”¯ä¸€æ ‡è¯†-`å•†å“åç§°`:å•†å“åç§°-`å•†å“å®å”®ä»·`:å•†å“å”®ä»·-`é”€é‡`:å•†å“æ•°é‡-`ä¸‹å•æ—¶é—´`:è®¢å•æ—¶é—´-`é—¨åº—åç§°`:é—¨åº—æ ‡è¯†-`æ¸ é“`:é”€å”®æ¸ é“-`æ”¶è´§åœ°å€`:é…é€åœ°å€**å¯é€‰å­—æ®µï¼š**-`åˆ©æ¶¦é¢`:å•å“åˆ©æ¶¦-`æˆæœ¬`:å•†å“æˆæœ¬-`ç‰©æµé…é€è´¹`:é…é€è´¹ç”¨-`å¹³å°ä½£é‡‘`:å¹³å°æŠ½æˆ-`é…é€è·ç¦»`:é…é€è·ç¦»-`ç¾å›¢ä¸€çº§åˆ†ç±»`:å•†å“åˆ†ç±»""")returnst.success(f"âœ…å·²åŠ è½½è®¢å•æ•°æ®ï¼š{len(order_data):,}æ¡è®°å½•")#æ•°æ®é¢„å¤„ç†å’Œç‰¹å¾å·¥ç¨‹try:processed_order_data=preprocess_order_data(order_data)order_summary=calculate_order_metrics(processed_order_data)#åˆ›å»ºåˆ†æé€‰é¡¹å¡analysis_tabs=st.tabs(["ğŸ“Šè®¢å•æ¦‚è§ˆ","ğŸ’°åˆ©æ¶¦åˆ†æ","â°æ—¶é—´åˆ†æ","ğŸªé—¨åº—åˆ†æ","ğŸ“¦å•†å“åˆ†æ","ğŸššé…é€åˆ†æ","ğŸ’¡æ™ºèƒ½æ´å¯Ÿ"])withanalysis_tabs[0]:ifORDER_ENHANCEMENT_AVAILABLE:render_enhanced_order_overview(processed_order_data,order_summary)else:render_order_overview(processed_order_data,order_summary)withanalysis_tabs[1]:ifORDER_ENHANCEMENT_AVAILABLE:render_enhanced_profit_analysis(processed_order_data,order_summary)else:render_profit_analysis(processed_order_data,order_summary)withanalysis_tabs[2]:render_time_analysis(processed_order_data)withanalysis_tabs[3]:render_store_analysis(processed_order_data)withanalysis_tabs[4]:render_product_analysis(processed_order_data)withanalysis_tabs[5]:render_delivery_analysis(processed_order_data)withanalysis_tabs[6]:render_order_insights(processed_order_data,order_summary)exceptExceptionase:st.error(f"è®¢å•æ•°æ®åˆ†ææ—¶å‡ºé”™:{str(e)}")st.info("ğŸ’¡è¯·æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚")defpreprocess_order_data(order_data:pd.DataFrame)->pd.DataFrame:"""è®¢å•æ•°æ®é¢„å¤„ç†-æ ¹æ®æ ‡å‡†ä¸šåŠ¡é€»è¾‘"""try:df=order_data.copy()#ğŸ”´**å…³é”®ä¸šåŠ¡è§„åˆ™1ï¼šå‰”é™¤è€—ææ•°æ®**-æ ¹æ®ä¸šåŠ¡é€»è¾‘æœ€ç»ˆç¡®è®¤æ–‡æ¡£#è¯†åˆ«æ ‡å‡†ï¼šä¸€çº§åˆ†ç±»å=='è€—æ'#å‚è€ƒï¼šè®¢å•æ•°æ®ä¸šåŠ¡é€»è¾‘ç¡®è®¤.mdoriginal_rows=len(df)#æ”¯æŒå¤šç§åˆ—åå˜ä½“category_col=Noneforcol_namein['ä¸€çº§åˆ†ç±»å','ç¾å›¢ä¸€çº§åˆ†ç±»','ä¸€çº§åˆ†ç±»']:ifcol_nameindf.columns:category_col=col_namebreakifcategory_col:df=df[df[category_col]!='è€—æ'].copy()removed_rows=original_rows-len(df)ifremoved_rows>0:st.info(f"ğŸ”´å·²è‡ªåŠ¨å‰”é™¤{removed_rows}è¡Œè€—ææ•°æ®ï¼ˆè´­ç‰©è¢‹ç­‰ï¼‰ï¼Œä»{original_rows}è¡Œå‡å°‘åˆ°{len(df)}è¡Œ")print(f"âœ…å·²å‰”é™¤{removed_rows}è¡Œè€—ææ•°æ®ï¼ˆè´­ç‰©è¢‹ç­‰ï¼‰ï¼Œä»{original_rows}è¡Œå‡å°‘åˆ°{len(df)}è¡Œ")else:st.warning(f"âš ï¸æœªæ‰¾åˆ°ä¸€çº§åˆ†ç±»åˆ—ï¼ˆæŸ¥æ‰¾äº†ï¼šä¸€çº§åˆ†ç±»åã€ç¾å›¢ä¸€çº§åˆ†ç±»ã€ä¸€çº§åˆ†ç±»ï¼‰ï¼Œæ— æ³•å‰”é™¤è€—æ")print(f"âš ï¸æœªæ‰¾åˆ°ä¸€çº§åˆ†ç±»åˆ—ï¼Œæ•°æ®åˆ—å:{list(df.columns[:10])}")#ğŸ”´**å…³é”®ä¸šåŠ¡è§„åˆ™2ï¼šå‰”é™¤å’–å•¡æ¸ é“æ•°æ®**-å’–å•¡ä¸šåŠ¡éO2Oé›¶å”®#è¯†åˆ«æ ‡å‡†ï¼šæ¸ é“in['é¥¿äº†ä¹ˆå’–å•¡','ç¾å›¢å’–å•¡']if'æ¸ é“'indf.columns:exclude_channels=['é¥¿äº†ä¹ˆå’–å•¡','ç¾å›¢å’–å•¡']before_filter=len(df)df=df[~df['æ¸ é“'].isin(exclude_channels)].copy()after_filter=len(df)coffee_removed=before_filter-after_filterifcoffee_removed>0:st.info(f"â˜•å·²è‡ªåŠ¨å‰”é™¤å’–å•¡æ¸ é“æ•°æ®{coffee_removed}è¡Œï¼ˆé¥¿äº†ä¹ˆå’–å•¡ã€ç¾å›¢å’–å•¡ï¼‰ï¼Œä»{before_filter}è¡Œå‡å°‘åˆ°{after_filter}è¡Œ")print(f"âœ…å·²å‰”é™¤{coffee_removed}è¡Œå’–å•¡æ¸ é“æ•°æ®ï¼Œä»{before_filter}è¡Œå‡å°‘åˆ°{after_filter}è¡Œ")#æ•°æ®ç±»å‹è½¬æ¢-æ ¹æ®ä¸šåŠ¡é€»è¾‘ç¡®è®¤æ–‡æ¡£çš„å­—æ®µå®šä¹‰numeric_columns=[#åŸºç¡€å•†å“å­—æ®µ'å•†å“å®å”®ä»·','å•†å“åŸä»·','é”€é‡','åˆ©æ¶¦é¢','æˆæœ¬','é…é€è·ç¦»',#æ ‡å‡†ä¸šåŠ¡é€»è¾‘å­—æ®µ'ç‰©æµé…é€è´¹','å¹³å°ä½£é‡‘','ç”¨æˆ·æ”¯ä»˜é…é€è´¹','é…é€è´¹å‡å…é‡‘é¢','æ»¡å‡é‡‘é¢','å•†å®¶ä»£é‡‘åˆ¸','å•†å“å‡å…é‡‘é¢','æ‰“åŒ…è´¹','è®¢å•é›¶å”®é¢',#å…¶ä»–å¯é€‰æˆæœ¬å­—æ®µ'æ»¡èµ é‡‘é¢','å•†å®¶æ‰¿æ‹…éƒ¨åˆ†åˆ¸','é€€æ¬¾é‡‘é¢','æ–°å®¢å‡å…é‡‘é¢']forcolinnumeric_columns:ifcolindf.columns:df[col]=pd.to_numeric(df[col],errors='coerce')#å¯¹äºç¼ºå¤±çš„è¥é”€æˆæœ¬å­—æ®µï¼Œå¡«å……0ä»¥ä¿è¯è®¡ç®—çš„å‡†ç¡®æ€§ifcolin['ç‰©æµé…é€è´¹','å¹³å°ä½£é‡‘','ç”¨æˆ·æ”¯ä»˜é…é€è´¹','é…é€è´¹å‡å…é‡‘é¢','æ»¡å‡é‡‘é¢','å•†å®¶ä»£é‡‘åˆ¸']:df[col]=df[col].fillna(0)#æ—¶é—´å­—æ®µå¤„ç†if'ä¸‹å•æ—¶é—´'indf.columns:df['ä¸‹å•æ—¶é—´']=pd.to_datetime(df['ä¸‹å•æ—¶é—´'],errors='coerce')df['ä¸‹å•æ—¥æœŸ']=df['ä¸‹å•æ—¶é—´'].dt.datedf['ä¸‹å•å°æ—¶']=df['ä¸‹å•æ—¶é—´'].dt.hourdf['ä¸‹å•æ˜ŸæœŸ']=df['ä¸‹å•æ—¶é—´'].dt.day_name()#æ—¶é—´æ®µæ˜ å°„hour_mapping={0:'å‡Œæ™¨',1:'å‡Œæ™¨',2:'å‡Œæ™¨',3:'å‡Œæ™¨',4:'å‡Œæ™¨',5:'æ¸…æ™¨',6:'æ¸…æ™¨',7:'æ—©æ™¨',8:'ä¸Šåˆ',9:'ä¸Šåˆ',10:'ä¸Šåˆ',11:'ä¸­åˆ',12:'ä¸­åˆ',13:'ä¸‹åˆ',14:'ä¸‹åˆ',15:'ä¸‹åˆ',16:'ä¸‹åˆ',17:'å‚æ™š',18:'å‚æ™š',19:'æ™šä¸Š',20:'æ™šä¸Š',21:'æ™šä¸Š',22:'å¤œæ™š',23:'å¤œæ™š'}df['ä¸‹å•æ—¶é—´æ®µ']=df['ä¸‹å•å°æ—¶'].map(hour_mapping)#å•†å“è§’è‰²åˆ¤æ–­(æ ¹æ®å•†å“å®å”®ä»·åˆ¤æ–­ä¸»åŠ›å“)if'å•†å“å®å”®ä»·'indf.columnsand'è®¢å•ID'indf.columns:max_price_per_order=df.groupby('è®¢å•ID')['å•†å“å®å”®ä»·'].transform('max')df['å•†å“è§’è‰²']=np.where(df['å•†å“å®å”®ä»·']==max_price_per_order,'ä¸»åŠ›å“','å‡‘å•å“')#é…é€è·ç¦»åˆ†æ®µif'é…é€è·ç¦»'indf.columns:df['é…é€è·ç¦»_km']=df['é…é€è·ç¦»']/1000df['é…é€è·ç¦»åˆ†æ®µ']=pd.cut(df['é…é€è·ç¦»_km'],bins=[0,1,2,3,4,5,float('inf')],labels=['1kmå†…','1-2km','2-3km','3-4km','4-5km','5kmä»¥ä¸Š'])#ä»·æ ¼åˆ†æ®µ(æ ¹æ®å•†å“å®å”®ä»·)if'å•†å“å®å”®ä»·'indf.columns:df['ä»·æ ¼åˆ†æ®µ']=pd.cut(df['å•†å“å®å”®ä»·'],bins=[0,10,30,50,100,float('inf')],labels=['ä½ä»·(<10å…ƒ)','ä¸­ä½ä»·(10-30å…ƒ)','ä¸­ä»·(30-50å…ƒ)','é«˜ä»·(50-100å…ƒ)','è¶…é«˜ä»·(>100å…ƒ)'])returndfexceptExceptionase:st.error(f"æ•°æ®é¢„å¤„ç†å¤±è´¥:{str(e)}")returnorder_datadefcalculate_order_metrics(df:pd.DataFrame)->Dict[str,Any]:"""è®¡ç®—è®¢å•çº§æŒ‡æ ‡-ä½¿ç”¨ç»Ÿä¸€çš„æ ‡å‡†ä¸šåŠ¡é€»è¾‘"""try:order_summary={}if'è®¢å•ID'notindf.columns:returnorder_summary#å¦‚æœå¯ç”¨ï¼Œä½¿ç”¨ç»Ÿä¸€ä¸šåŠ¡é€»è¾‘é…ç½®ifSTANDARD_CONFIG_AVAILABLE:print("ğŸ”§ä½¿ç”¨æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—è®¢å•æŒ‡æ ‡")#ä½¿ç”¨ç»Ÿä¸€é…ç½®åˆ›å»ºè®¢å•çº§æ±‡æ€»order_agg=create_order_level_summary(df,StandardBusinessConfig)#åº”ç”¨æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—order_agg=apply_standard_business_logic(order_agg)#ç”Ÿæˆæ±‡æ€»æŒ‡æ ‡order_summary['è®¢å•æ€»æ•°']=len(order_agg)order_summary['å•†å“æ€»æ•°']=len(df)order_summary['å¹³å‡æ¯å•å•†å“æ•°']=len(df)/len(order_agg)iflen(order_agg)>0else0#é”€å”®é¢ç»Ÿè®¡(åŸºäºæ ‡å‡†ä¸šåŠ¡é€»è¾‘)if'å•†å“å®å”®ä»·æ€»å’Œ'inorder_agg.columns:total_sales=order_agg['å•†å“å®å”®ä»·æ€»å’Œ'].sum()order_summary['æ€»é”€å”®é¢']=total_salesorder_summary['å¹³å‡å®¢å•ä»·']=total_sales/len(order_agg)iflen(order_agg)>0else0order_summary['å®¢å•ä»·ä¸­ä½æ•°']=order_agg['å•†å“å®å”®ä»·æ€»å’Œ'].median()#è®¢å•æ€»æ”¶å…¥ç»Ÿè®¡ï¼ˆå•†å“å®å”®ä»·+æ‰“åŒ…è´¹+ç”¨æˆ·æ”¯ä»˜é…é€è´¹ï¼‰if'é¢„ä¼°è®¢å•æ”¶å…¥'inorder_agg.columns:total_revenue=order_agg['é¢„ä¼°è®¢å•æ”¶å…¥'].sum()order_summary['è®¢å•æ€»æ”¶å…¥']=total_revenueorder_summary['å¹³å‡è®¢å•æ”¶å…¥']=total_revenue/len(order_agg)iflen(order_agg)>0else0#åˆ©æ¶¦ç»Ÿè®¡(ä½¿ç”¨æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—çš„å®é™…åˆ©æ¶¦)if'è®¢å•å®é™…åˆ©æ¶¦é¢'inorder_agg.columns:actual_profit_series=order_agg['è®¢å•å®é™…åˆ©æ¶¦é¢']total_profit=actual_profit_series.sum()order_summary['æ€»åˆ©æ¶¦é¢']=total_profitorder_summary['å¹³å‡è®¢å•åˆ©æ¶¦']=actual_profit_series.mean()order_summary['ç›ˆåˆ©è®¢å•æ•°']=(actual_profit_series>0).sum()order_summary['ç›ˆåˆ©è®¢å•æ¯”ä¾‹']=(actual_profit_series>0).mean()#ğŸ”è°ƒè¯•è¾“å‡º-åˆ©æ¶¦è®¡ç®—print(f"\nğŸ’°[DEBUG]åˆ©æ¶¦è®¡ç®—éªŒè¯:")print(f"-æ€»åˆ©æ¶¦é¢:Â¥{total_profit:,.2f}")ifall(colinorder_agg.columnsforcolin['å•†å“å®å”®ä»·æ€»å’Œ','æˆæœ¬','é…é€æˆæœ¬','æ´»åŠ¨è¥é”€æˆæœ¬','å•†å“æŠ˜æ‰£æˆæœ¬','å¹³å°ä½£é‡‘']):packing_fee=order_agg['æ‰“åŒ…è¢‹é‡‘é¢'].sum()if'æ‰“åŒ…è¢‹é‡‘é¢'inorder_agg.columnselse0user_pay_delivery=order_agg['ç”¨æˆ·æ”¯ä»˜é…é€è´¹'].sum()if'ç”¨æˆ·æ”¯ä»˜é…é€è´¹'inorder_agg.columnselse0revenue_sum=(order_agg['å•†å“å®å”®ä»·æ€»å’Œ'].sum()+packing_fee+user_pay_delivery)cost_sum=order_agg['æˆæœ¬'].sum()delivery_sum=order_agg['é…é€æˆæœ¬'].sum()activity_sum=order_agg['æ´»åŠ¨è¥é”€æˆæœ¬'].sum()discount_sum=order_agg['å•†å“æŠ˜æ‰£æˆæœ¬'].sum()commission_sum=order_agg['å¹³å°ä½£é‡‘'].sum()print(f"-è®¢å•æ€»æ”¶å…¥:Â¥{revenue_sum:,.2f}(å•†å“Â¥{order_agg['å•†å“å®å”®ä»·æ€»å’Œ'].sum():,.2f}+æ‰“åŒ…Â¥{packing_fee:,.2f}+ç”¨æˆ·æ”¯ä»˜é…é€è´¹Â¥{user_pay_delivery:,.2f})")print(f"-å•†å“æˆæœ¬:Â¥{cost_sum:,.2f}")print(f"-é…é€æˆæœ¬:Â¥{delivery_sum:,.2f}")print(f"-æ´»åŠ¨è¥é”€æˆæœ¬:Â¥{activity_sum:,.2f}")print(f"-å•†å“æŠ˜æ‰£æˆæœ¬:Â¥{discount_sum:,.2f}")print(f"-å¹³å°ä½£é‡‘:Â¥{commission_sum:,.2f}")expected=revenue_sum-cost_sum-delivery_sum-activity_sum-discount_sum-commission_sumprint(f"-å…¬å¼éªŒè¯:Â¥{revenue_sum:,.2f}-Â¥{cost_sum:,.2f}-Â¥{delivery_sum:,.2f}-Â¥{activity_sum:,.2f}-Â¥{discount_sum:,.2f}-Â¥{commission_sum:,.2f}=Â¥{expected:,.2f}")print(f"-å·®å¼‚:Â¥{total_profit-expected:,.2f}")else:print(f"âš ï¸ç¼ºå°‘å¿…è¦å­—æ®µï¼Œæ— æ³•éªŒè¯è¯¦ç»†è®¡ç®—")#é…é€æˆæœ¬ç»Ÿè®¡(ä½¿ç”¨æ ‡å‡†ä¸šåŠ¡é€»è¾‘)if'é…é€æˆæœ¬'inorder_agg.columns:delivery_cost_series=order_agg['é…é€æˆæœ¬']total_delivery_cost=delivery_cost_series.sum()order_summary['å¹³å‡é…é€æˆæœ¬']=delivery_cost_series.mean()order_summary['æ€»é…é€æˆæœ¬']=total_delivery_cost#ğŸ”è°ƒè¯•è¾“å‡ºprint(f"ğŸ”[DEBUG]é…é€æˆæœ¬è®¡ç®—:")print(f"-æ€»é…é€æˆæœ¬:Â¥{total_delivery_cost:,.2f}")print(f"-å¹³å‡é…é€æˆæœ¬:Â¥{delivery_cost_series.mean():,.2f}")if'ç”¨æˆ·æ”¯ä»˜é…é€è´¹'inorder_agg.columnsand'é…é€è´¹å‡å…é‡‘é¢'inorder_agg.columnsand'ç‰©æµé…é€è´¹'inorder_agg.columns:user_pay=order_agg['ç”¨æˆ·æ”¯ä»˜é…é€è´¹'].sum()exemption_sum=order_agg['é…é€è´¹å‡å…é‡‘é¢'].sum()logistics_sum=order_agg['ç‰©æµé…é€è´¹'].sum()print(f"-é…é€è´¹å‡å…ï¼ˆæ”¯å‡ºï¼‰:Â¥{exemption_sum:,.2f}")print(f"-ç‰©æµé…é€è´¹ï¼ˆæ”¯å‡ºï¼‰:Â¥{logistics_sum:,.2f}")print(f"-ç”¨æˆ·æ”¯ä»˜é…é€è´¹ï¼ˆæ”¶å…¥ï¼‰:Â¥{user_pay:,.2f}")print(f"-é…é€å‡€æˆæœ¬å…¬å¼:({exemption_sum:,.2f}+{logistics_sum:,.2f})-{user_pay:,.2f}=Â¥{exemption_sum+logistics_sum-user_pay:,.2f}")#æ´»åŠ¨è¥é”€æˆæœ¬ç»Ÿè®¡ï¼ˆä¸å«å•†å“æŠ˜æ‰£ï¼‰if'æ´»åŠ¨è¥é”€æˆæœ¬'inorder_agg.columns:activity_marketing_series=order_agg['æ´»åŠ¨è¥é”€æˆæœ¬']order_summary['æ€»æ´»åŠ¨è¥é”€æˆæœ¬']=activity_marketing_series.sum()order_summary['å¹³å‡æ´»åŠ¨è¥é”€æˆæœ¬']=activity_marketing_series.mean()#å•†å“æŠ˜æ‰£æˆæœ¬ç»Ÿè®¡if'å•†å“æŠ˜æ‰£æˆæœ¬'inorder_agg.columns:product_discount_series=order_agg['å•†å“æŠ˜æ‰£æˆæœ¬']order_summary['æ€»å•†å“æŠ˜æ‰£æˆæœ¬']=product_discount_series.sum()order_summary['å¹³å‡å•†å“æŠ˜æ‰£æˆæœ¬']=product_discount_series.mean()#æ€»è¥é”€æˆæœ¬ç»Ÿè®¡ï¼ˆæ´»åŠ¨è¥é”€+å•†å“æŠ˜æ‰£ï¼‰if'å•†å®¶æ´»åŠ¨æ”¯å‡º'inorder_agg.columns:marketing_cost_series=order_agg['å•†å®¶æ´»åŠ¨æ”¯å‡º']order_summary['æ€»è¥é”€æˆæœ¬']=marketing_cost_series.sum()order_summary['å¹³å‡è¥é”€æˆæœ¬']=marketing_cost_series.mean()else:#ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬çš„è®¡ç®—é€»è¾‘ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰print("âš ï¸ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬çš„è®¢å•æŒ‡æ ‡è®¡ç®—")order_summary=calculate_order_metrics_fallback(df)returnorder_summaryexceptExceptionase:st.error(f"æŒ‡æ ‡è®¡ç®—å¤±è´¥:{str(e)}")return{}defcalculate_order_metrics_fallback(df:pd.DataFrame)->Dict[str,Any]:"""å¤‡ç”¨çš„è®¢å•æŒ‡æ ‡è®¡ç®—æ–¹æ³•(å…¼å®¹æ€§å¤„ç†)"""order_summary={}#åŸºç¡€è®¢å•æŒ‡æ ‡order_summary['è®¢å•æ€»æ•°']=df['è®¢å•ID'].nunique()order_summary['å•†å“æ€»æ•°']=len(df)order_summary['å¹³å‡æ¯å•å•†å“æ•°']=len(df)/df['è®¢å•ID'].nunique()#é”€å”®é¢ç»Ÿè®¡if'å•†å“å®å”®ä»·'indf.columnsand'é”€é‡'indf.columns:df['å•†å“é”€å”®é¢']=df['å•†å“å®å”®ä»·']*df['é”€é‡']order_sales=df.groupby('è®¢å•ID')['å•†å“é”€å”®é¢'].sum()order_summary['æ€»é”€å”®é¢']=order_sales.sum()order_summary['å¹³å‡å®¢å•ä»·']=order_sales.mean()order_summary['å®¢å•ä»·ä¸­ä½æ•°']=order_sales.median()#ç®€åŒ–çš„åˆ©æ¶¦ç»Ÿè®¡if'åˆ©æ¶¦é¢'indf.columns:order_profit=df.groupby('è®¢å•ID')['åˆ©æ¶¦é¢'].sum()order_summary['æ€»åˆ©æ¶¦é¢']=order_profit.sum()order_summary['å¹³å‡è®¢å•åˆ©æ¶¦']=order_profit.mean()order_summary['ç›ˆåˆ©è®¢å•æ•°']=(order_profit>0).sum()order_summary['ç›ˆåˆ©è®¢å•æ¯”ä¾‹']=(order_profit>0).mean()#é…é€è´¹ç»Ÿè®¡if'ç‰©æµé…é€è´¹'indf.columns:order_delivery=df.groupby('è®¢å•ID')['ç‰©æµé…é€è´¹'].first()order_summary['å¹³å‡é…é€æˆæœ¬']=order_delivery.mean()order_summary['æ€»é…é€æˆæœ¬']=order_delivery.sum()returnorder_summarydefrender_order_overview(df:pd.DataFrame,order_summary:Dict[str,Any])->None:"""æ¸²æŸ“è®¢å•æ¦‚è§ˆ-å±•ç¤ºæ ‡å‡†ä¸šåŠ¡é€»è¾‘æŒ‡æ ‡"""st.write("**ğŸ“Šè®¢å•ä¸šåŠ¡æ¦‚è§ˆ(æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—)**")#æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡-åŸºç¡€ä¸šåŠ¡æŒ‡æ ‡col1,col2,col3,col4=st.columns(4)withcol1:st.metric("è®¢å•æ€»æ•°",f"{order_summary.get('è®¢å•æ€»æ•°',0):,}",help="ç»Ÿè®¡æœŸé—´å†…çš„æ€»è®¢å•æ•°é‡")withcol2:st.metric("å•†å“æ€»æ•°",f"{order_summary.get('å•†å“æ€»æ•°',0):,}",help="æ‰€æœ‰è®¢å•ä¸­çš„å•†å“æ¡ç›®æ€»æ•°")withcol3:st.metric("å¹³å‡å®¢å•ä»·",f"Â¥{order_summary.get('å¹³å‡å®¢å•ä»·',0):.2f}",help="æ¯ä¸ªè®¢å•çš„å¹³å‡é”€å”®é¢(å•†å“å®å”®ä»·Ã—é”€é‡)")withcol4:if'ç›ˆåˆ©è®¢å•æ¯”ä¾‹'inorder_summary:st.metric("ç›ˆåˆ©è®¢å•æ¯”ä¾‹",f"{order_summary.get('ç›ˆåˆ©è®¢å•æ¯”ä¾‹',0):.1%}",help="æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—çš„å®é™…ç›ˆåˆ©è®¢å•å æ¯”")#æ ‡å‡†ä¸šåŠ¡é€»è¾‘å…³é”®æŒ‡æ ‡st.write("**ğŸ¨æ ‡å‡†ä¸šåŠ¡é€»è¾‘å…³é”®æŒ‡æ ‡**")col1,col2,col3,col4=st.columns(4)withcol1:st.metric("æ€»åˆ©æ¶¦é¢(å®é™…)",f"Â¥{order_summary.get('æ€»åˆ©æ¶¦é¢',0):,.2f}",help="æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—:é¢„ä¼°è®¢å•æ”¶å…¥-é…é€æˆæœ¬")withcol2:st.metric("å¹³å‡è®¢å•åˆ©æ¶¦",f"Â¥{order_summary.get('å¹³å‡è®¢å•åˆ©æ¶¦',0):.2f}",help="æ¯ä¸ªè®¢å•çš„å¹³å‡å®é™…åˆ©æ¶¦é¢")withcol3:st.metric("æ€»é…é€æˆæœ¬",f"Â¥{order_summary.get('æ€»é…é€æˆæœ¬',0):,.2f}",help="å•†å®¶é…é€å‡€æ”¯å‡º:(é…é€è´¹å‡å…+ç‰©æµé…é€è´¹)-ç”¨æˆ·æ”¯ä»˜é…é€è´¹")withcol4:st.metric("å¹³å‡é…é€æˆæœ¬",f"Â¥{order_summary.get('å¹³å‡é…é€æˆæœ¬',0):.2f}",help="æ¯ä¸ªè®¢å•çš„å¹³å‡é…é€æˆæœ¬")#æ•°æ®è´¨é‡æ¦‚è§ˆcol1,col2=st.columns(2)withcol1:st.write("**ğŸ“ˆä¸šåŠ¡æ•°æ®åˆ†å¸ƒ**")#é—¨åº—åˆ†å¸ƒif'é—¨åº—åç§°'indf.columns:store_dist=df['é—¨åº—åç§°'].value_counts()fig=px.pie(values=store_dist.values,names=store_dist.index,title="é—¨åº—è®¢å•åˆ†å¸ƒ")st.plotly_chart(fig,use_container_width=True)withcol2:st.write("**ğŸ•è®¢å•æ—¶é—´åˆ†å¸ƒ**")#æ—¶é—´æ®µåˆ†å¸ƒif'ä¸‹å•æ—¶é—´æ®µ'indf.columns:time_dist=df['ä¸‹å•æ—¶é—´æ®µ'].value_counts()fig=px.bar(x=time_dist.index,y=time_dist.values,title="æ—¶é—´æ®µè®¢å•é‡åˆ†å¸ƒ")st.plotly_chart(fig,use_container_width=True)#ä¸šåŠ¡é€»è¾‘è¯´æ˜withst.expander("ğŸ“„æ ‡å‡†ä¸šåŠ¡é€»è¾‘è¯´æ˜"):st.markdown("""**æœ¬çœ‹æ¿é‡‡ç”¨çš„æ ‡å‡†ä¸šåŠ¡é€»è¾‘:**1.**é¢„ä¼°è®¢å•æ”¶å…¥**=(è®¢å•é›¶å”®é¢+æ‰“åŒ…è´¹-å•†å®¶æ´»åŠ¨æ”¯å‡º-å¹³å°ä½£é‡‘+ç”¨æˆ·æ”¯ä»˜é…é€è´¹)2.**å•†å®¶æ´»åŠ¨æ”¯å‡º**=(é…é€è´¹å‡å…é‡‘é¢+æ»¡å‡é‡‘é¢+å•†å“å‡å…é‡‘é¢+å•†å®¶ä»£é‡‘åˆ¸)3.**é…é€æˆæœ¬**=(ç”¨æˆ·æ”¯ä»˜é…é€è´¹-é…é€è´¹å‡å…é‡‘é¢-ç‰©æµé…é€è´¹)4.**è®¢å•å®é™…åˆ©æ¶¦é¢**=é¢„ä¼°è®¢å•æ”¶å…¥-é…é€æˆæœ¬**å­—æ®µå«ä¹‰:**-**å•†å“å®å”®ä»·**:å•†å“åœ¨å‰ç«¯å±•ç¤ºçš„åŸä»·-**ç”¨æˆ·æ”¯ä»˜é‡‘é¢**:ç”¨æˆ·å®é™…æ”¯ä»˜ä»·æ ¼(è€ƒè™‘å„ç§è¡¥è´´æ´»åŠ¨)-**åŒä¸€è®¢å•IDå¤šè¡Œ**:æ¯è¡Œä»£è¡¨ä¸€ä¸ªå•†å“SKUï¼Œè®¢å•çº§å­—æ®µä¼šé‡å¤æ˜¾ç¤º""")defrender_profit_analysis(df:pd.DataFrame,order_summary:Dict[str,Any])->None:"""æ¸²æŸ“åˆ©æ¶¦åˆ†æ-æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘"""st.write("**ğŸ’°è®¢å•åˆ©æ¶¦æ·±åº¦åˆ†æ(æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—)**")if'åˆ©æ¶¦é¢'notindf.columns:st.info("ç¼ºå°‘åˆ©æ¶¦é¢å­—æ®µï¼Œæ— æ³•è¿›è¡Œåˆ©æ¶¦åˆ†æ")return#åˆ©æ¶¦æ¦‚è§ˆ-æ‰€æœ‰æŒ‡æ ‡éƒ½åŸºäºæ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—col1,col2,col3,col4=st.columns(4)withcol1:st.metric("æ€»åˆ©æ¶¦é¢(å®é™…)",f"Â¥{order_summary.get('æ€»åˆ©æ¶¦é¢',0):,.2f}",help="æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘:é¢„ä¼°è®¢å•æ”¶å…¥-é…é€æˆæœ¬")withcol2:st.metric("å¹³å‡è®¢å•åˆ©æ¶¦",f"Â¥{order_summary.get('å¹³å‡è®¢å•åˆ©æ¶¦',0):.2f}",help="æ¯ä¸ªè®¢å•çš„å¹³å‡å®é™…åˆ©æ¶¦é¢")withcol3:st.metric("ç›ˆåˆ©è®¢å•æ•°",f"{order_summary.get('ç›ˆåˆ©è®¢å•æ•°',0):,}",help="å®é™…åˆ©æ¶¦>0çš„è®¢å•æ•°é‡")withcol4:st.metric("ç›ˆåˆ©ç‡",f"{order_summary.get('ç›ˆåˆ©è®¢å•æ¯”ä¾‹',0):.1%}",help="ç›ˆåˆ©è®¢å•åœ¨æ‰€æœ‰è®¢å•ä¸­çš„å æ¯”")#ä¸šåŠ¡é€»è¾‘æˆæœ¬ç»†åˆ†st.write("**ğŸ“„æˆæœ¬ç»†åˆ†åˆ†æ(æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘)**")col1,col2,col3=st.columns(3)withcol1:st.metric("æ€»é…é€æˆæœ¬",f"Â¥{order_summary.get('æ€»é…é€æˆæœ¬',0):,.2f}",help="å•†å®¶é…é€å‡€æ”¯å‡º:(é…é€è´¹å‡å…+ç‰©æµé…é€è´¹)-ç”¨æˆ·æ”¯ä»˜é…é€è´¹")withcol2:#è®¡ç®—å•†å®¶æ´»åŠ¨æ”¯å‡ºæ€»é¢(å¦‚æœæ•°æ®ä¸­æœ‰çš„è¯)marketing_cost_fields=['é…é€è´¹å‡å…é‡‘é¢','æ»¡å‡é‡‘é¢','å•†å“å‡å…é‡‘é¢','å•†å®¶ä»£é‡‘åˆ¸']total_marketing_cost=0forfieldinmarketing_cost_fields:iffieldindf.columns:total_marketing_cost+=df[field].sum()st.metric("å•†å®¶æ´»åŠ¨æ”¯å‡º",f"Â¥{total_marketing_cost:,.2f}",help="é…é€è´¹å‡å…+æ»¡å‡+å•†å“å‡å…+å•†å®¶ä»£é‡‘åˆ¸")withcol3:#è®¡ç®—å¹³å°ä½£é‡‘æ€»é¢platform_commission=df['å¹³å°ä½£é‡‘'].sum()if'å¹³å°ä½£é‡‘'indf.columnselse0st.metric("å¹³å°ä½£é‡‘æ€»é¢",f"Â¥{platform_commission:,.2f}",help="å„ä¸ªå¹³å°æ¸ é“æ”¶å–çš„æœåŠ¡è´¹")#åˆ©æ¶¦åˆ†æå›¾è¡¨col1,col2=st.columns(2)withcol1:#è®¢å•åˆ©æ¶¦åˆ†å¸ƒ-ä½¿ç”¨æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—çš„å®é™…åˆ©æ¶¦if'è®¢å•ID'indf.columns:#é‡æ–°è®¡ç®—æ¯ä¸ªè®¢å•çš„å®é™…åˆ©æ¶¦(ç®€åŒ–ç‰ˆæœ¬)order_profit_simple=df.groupby('è®¢å•ID')['åˆ©æ¶¦é¢'].sum()#è¿™é‡Œç”¨ç®€åŒ–ç‰ˆæœ¬ä½œä¸ºç¤ºä¾‹fig=px.histogram(x=order_profit_simple,nbins=30,title="è®¢å•åˆ©æ¶¦åˆ†å¸ƒ(æŒ‰æ ‡å‡†ä¸šåŠ¡é€»è¾‘)",labels={'x':'è®¢å•å®é™…åˆ©æ¶¦(å…ƒ)','y':'è®¢å•æ•°é‡'})fig.add_vline(x=0,line_dash="dash",line_color="red",annotation_text="ç›ˆäºå¹³è¡¡çº¿")st.plotly_chart(fig,use_container_width=True)withcol2:#å•†å“ƒåˆ©æ¶¦è´¡çŒ®-æ˜¾ç¤ºç®€åŒ–çš„å•†å“åˆ©æ¶¦if'å•†å“åç§°'indf.columns:#è¿™é‡Œä½¿ç”¨åŸå§‹åˆ©æ¶¦é¢ä½œä¸ºç¤ºä¾‹ï¼Œå®é™…åº”è¯¥ç”¨è®¢å•çº§åˆ©æ¶¦åˆ†é…product_profit=df.groupby('å•†å“åç§°')['åˆ©æ¶¦é¢'].sum().sort_values(ascending=False).head(10)fig=px.bar(x=product_profit.values,y=product_profit.index,orientation='h',title="TOP10å•†å“åˆ©æ¶¦è´¡çŒ®",labels={'x':'åˆ©æ¶¦è´¡çŒ®(å…ƒ)','y':'å•†å“åç§°'})st.plotly_chart(fig,use_container_width=True)#æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—å…¬å¼è¯´æ˜withst.expander("ğŸ§®æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—å…¬å¼"):st.markdown("""**æœ¬åˆ†æé‡‡ç”¨çš„æ ‡å‡†ä¸šåŠ¡é€»è¾‘è®¡ç®—å…¬å¼:****1.é¢„ä¼°è®¢å•æ”¶å…¥è®¡ç®—:**```é¢„ä¼°è®¢å•æ”¶å…¥=(è®¢å•é›¶å”®é¢+æ‰“åŒ…è´¹-å•†å®¶æ´»åŠ¨æ”¯å‡º-å¹³å°ä½£é‡‘+ç”¨æˆ·æ”¯ä»˜é…é€è´¹)```**2.å•†å®¶æ´»åŠ¨æ”¯å‡ºè®¡ç®—:**```å•†å®¶æ´»åŠ¨æ”¯å‡º=(é…é€è´¹å‡å…é‡‘é¢+æ»¡å‡é‡‘é¢+å•†å“å‡å…é‡‘é¢+å•†å®¶ä»£é‡‘åˆ¸)```**3.é…é€æˆæœ¬è®¡ç®—:**âœ…2025-10-13ä¿®æ­£```é…é€æˆæœ¬=é…é€è´¹å‡å…é‡‘é¢+ç‰©æµé…é€è´¹è¯´æ˜ï¼šè¿™ä¸¤é¡¹æ˜¯å•†å®¶åœ¨é…é€ç¯èŠ‚çš„å®é™…æ”¯å‡º```**4.æœ€ç»ˆåˆ©æ¶¦è®¡ç®—:**```è®¢å•å®é™…åˆ©æ¶¦é¢=é¢„ä¼°è®¢å•æ”¶å…¥-é…é€æˆæœ¬```**é‡è¦è¯´æ˜:**-æ‰€æœ‰æŒ‡æ ‡éƒ½é‡‡ç”¨è®¢å•çº§èšåˆï¼Œé¿å…é‡å¤è®¡ç®—-è®¢å•çº§å­—æ®µ(å¦‚é…é€è´¹ã€ä½£é‡‘)ä½¿ç”¨`.first()`å–å€¼-å•†å“çº§å­—æ®µ(å¦‚åˆ©æ¶¦é¢ã€æˆæœ¬)ä½¿ç”¨`.sum()`èšåˆ""")defrender_time_analysis(df:pd.DataFrame)->None:"""æ¸²æŸ“æ—¶é—´åˆ†æ"""st.write("**â°æ—¶é—´ç»´åº¦åˆ†æ**")if'ä¸‹å•æ—¶é—´'notindf.columns:st.info("ç¼ºå°‘ä¸‹å•æ—¶é—´å­—æ®µï¼Œæ— æ³•è¿›è¡Œæ—¶é—´åˆ†æ")return#æ—¶é—´åˆ†å¸ƒåˆ†æcol1,col2=st.columns(2)withcol1:#æ¯æ—¥è®¢å•é‡è¶‹åŠ¿if'ä¸‹å•æ—¥æœŸ'indf.columns:daily_orders=df.groupby('ä¸‹å•æ—¥æœŸ').size()fig=px.line(x=daily_orders.index,y=daily_orders.values,title="æ¯æ—¥è®¢å•é‡è¶‹åŠ¿",labels={'x':'æ—¥æœŸ','y':'è®¢å•æ•°é‡'})st.plotly_chart(fig,use_container_width=True)withcol2:#å°æ—¶åˆ†å¸ƒçƒ­åŠ›å›¾if'ä¸‹å•å°æ—¶'indf.columnsand'ä¸‹å•æ˜ŸæœŸ'indf.columns:hourly_heat=df.groupby(['ä¸‹å•æ˜ŸæœŸ','ä¸‹å•å°æ—¶']).size().unstack(fill_value=0)fig=px.imshow(hourly_heat.values,x=hourly_heat.columns,y=hourly_heat.index,title="æ˜ŸæœŸ-å°æ—¶è®¢å•çƒ­åŠ›å›¾",labels={'x':'å°æ—¶','y':'æ˜ŸæœŸ','color':'è®¢å•æ•°é‡'})st.plotly_chart(fig,use_container_width=True)defrender_store_analysis(df:pd.DataFrame)->None:"""æ¸²æŸ“é—¨åº—åˆ†æ"""st.write("**ğŸªé—¨åº—ç»´åº¦åˆ†æ**")if'é—¨åº—åç§°'notindf.columns:st.info("ç¼ºå°‘é—¨åº—åç§°å­—æ®µï¼Œæ— æ³•è¿›è¡Œé—¨åº—åˆ†æ")return#é—¨åº—ä¸šç»©å¯¹æ¯”store_metrics=df.groupby('é—¨åº—åç§°').agg({'è®¢å•ID':'nunique','å•†å“å®å”®ä»·':lambdax:(x*df.loc[x.index,'é”€é‡']).sum()if'é”€é‡'indf.columnselsex.sum(),'åˆ©æ¶¦é¢':'sum'if'åˆ©æ¶¦é¢'indf.columnselselambdax:0}).round(2)store_metrics.columns=['è®¢å•æ•°','é”€å”®é¢','åˆ©æ¶¦é¢']iflen(store_metrics)>0:col1,col2=st.columns(2)withcol1:#é—¨åº—é”€å”®é¢å¯¹æ¯”fig=px.bar(x=store_metrics.index,y=store_metrics['é”€å”®é¢'],title="é—¨åº—é”€å”®é¢å¯¹æ¯”",labels={'x':'é—¨åº—','y':'é”€å”®é¢(å…ƒ)'})st.plotly_chart(fig,use_container_width=True)withcol2:#é—¨åº—åˆ©æ¶¦å¯¹æ¯”ifstore_metrics['åˆ©æ¶¦é¢'].sum()>0:fig=px.bar(x=store_metrics.index,y=store_metrics['åˆ©æ¶¦é¢'],title="é—¨åº—åˆ©æ¶¦å¯¹æ¯”",labels={'x':'é—¨åº—','y':'åˆ©æ¶¦é¢(å…ƒ)'})st.plotly_chart(fig,use_container_width=True)#é—¨åº—æ•°æ®è¡¨st.write("**é—¨åº—ä¸šç»©è¯¦æƒ…**")st.dataframe(store_metrics,use_container_width=True)defrender_product_analysis(df:pd.DataFrame)->None:"""æ¸²æŸ“å•†å“åˆ†æ"""st.write("**ğŸ“¦å•†å“ç»´åº¦åˆ†æ**")col1,col2=st.columns(2)withcol1:#å•†å“è§’è‰²åˆ†æif'å•†å“è§’è‰²'indf.columns:role_dist=df['å•†å“è§’è‰²'].value_counts()fig=px.pie(values=role_dist.values,names=role_dist.index,title="å•†å“è§’è‰²åˆ†å¸ƒ")st.plotly_chart(fig,use_container_width=True)withcol2:#ä»·æ ¼åˆ†æ®µåˆ†æif'ä»·æ ¼åˆ†æ®µ'indf.columns:price_dist=df['ä»·æ ¼åˆ†æ®µ'].value_counts()fig=px.bar(x=price_dist.index,y=price_dist.values,title="ä»·æ ¼åˆ†æ®µå•†å“åˆ†å¸ƒ",labels={'x':'ä»·æ ¼åˆ†æ®µ','y':'å•†å“æ•°é‡'})st.plotly_chart(fig,use_container_width=True)#çƒ­é”€å•†å“TOPæ¦œif'å•†å“åç§°'indf.columnsand'é”€é‡'indf.columns:top_products=df.groupby('å•†å“åç§°')['é”€é‡'].sum().sort_values(ascending=False).head(10)st.write("**ğŸ”¥çƒ­é”€å•†å“TOP10**")top_products_df=pd.DataFrame({'å•†å“åç§°':top_products.index,'æ€»é”€é‡':top_products.values})st.dataframe(top_products_df,use_container_width=True)defrender_delivery_analysis(df:pd.DataFrame)->None:"""æ¸²æŸ“é…é€åˆ†æ"""st.write("**ğŸššé…é€ç»´åº¦åˆ†æ**")col1,col2=st.columns(2)withcol1:#é…é€è·ç¦»åˆ†å¸ƒif'é…é€è·ç¦»åˆ†æ®µ'indf.columns:distance_dist=df['é…é€è·ç¦»åˆ†æ®µ'].value_counts()fig=px.bar(x=distance_dist.index,y=distance_dist.values,title="é…é€è·ç¦»åˆ†å¸ƒ",labels={'x':'é…é€è·ç¦»','y':'è®¢å•æ•°é‡'})st.plotly_chart(fig,use_container_width=True)withcol2:#é…é€è´¹åˆ†æif'ç‰©æµé…é€è´¹'indf.columns:avg_delivery_fee=df.groupby('é…é€è·ç¦»åˆ†æ®µ')['ç‰©æµé…é€è´¹'].mean()fig=px.bar(x=avg_delivery_fee.index,y=avg_delivery_fee.values,title="å¹³å‡é…é€è´¹vsé…é€è·ç¦»",labels={'x':'é…é€è·ç¦»','y':'å¹³å‡é…é€è´¹(å…ƒ)'})st.plotly_chart(fig,use_container_width=True)#é«˜é…é€è´¹è®¢å•é¢„è­¦if'ç‰©æµé…é€è´¹'indf.columns:high_delivery_orders=df[df['ç‰©æµé…é€è´¹']>6]ifnothigh_delivery_orders.empty:st.warning(f"âš ï¸å‘ç°{len(high_delivery_orders)}ä¸ªé«˜é…é€è´¹è®¢å•ï¼ˆ>6å…ƒï¼‰")withst.expander("æŸ¥çœ‹é«˜é…é€è´¹è®¢å•è¯¦æƒ…"):display_cols=['è®¢å•ID','å•†å“åç§°','ç‰©æµé…é€è´¹','é…é€è·ç¦»_km','æ”¶è´§åœ°å€']available_cols=[colforcolindisplay_colsifcolinhigh_delivery_orders.columns]ifavailable_cols:st.dataframe(high_delivery_orders[available_cols].head(20),use_container_width=True)defrender_order_insights(df:pd.DataFrame,order_summary:Dict[str,Any])->None:"""æ¸²æŸ“æ™ºèƒ½æ´å¯Ÿ"""st.write("**ğŸ’¡æ™ºèƒ½ä¸šåŠ¡æ´å¯Ÿ**")insights=[]#åŸºäºæ•°æ®ç”Ÿæˆæ´å¯Ÿiforder_summary:#ç›ˆåˆ©æ´å¯Ÿprofit_ratio=order_summary.get('ç›ˆåˆ©è®¢å•æ¯”ä¾‹',0)ifprofit_ratio>0.8:insights.append("ğŸ‰è®¢å•ç›ˆåˆ©ç‡ä¼˜ç§€ï¼Œè¶…è¿‡80%çš„è®¢å•éƒ½èƒ½äº§ç”Ÿåˆ©æ¶¦")elifprofit_ratio>0.6:insights.append("ğŸ‘è®¢å•ç›ˆåˆ©ç‡è‰¯å¥½ï¼Œå»ºè®®ä¼˜åŒ–å‰©ä½™äºæŸè®¢å•")else:insights.append("âš ï¸è®¢å•ç›ˆåˆ©ç‡åä½ï¼Œå»ºè®®é‡ç‚¹å…³æ³¨æˆæœ¬æ§åˆ¶å’Œå®šä»·ç­–ç•¥")#å®¢å•ä»·æ´å¯Ÿavg_order_value=order_summary.get('å¹³å‡å®¢å•ä»·',0)ifavg_order_value>50:insights.append(f"ğŸ’°å¹³å‡å®¢å•ä»·è¡¨ç°è‰¯å¥½({avg_order_value:.2f}å…ƒ)ï¼Œå®¢æˆ·æ¶ˆè´¹æ°´å¹³è¾ƒé«˜")elifavg_order_value>30:insights.append(f"ğŸ“ˆå¹³å‡å®¢å•ä»·é€‚ä¸­({avg_order_value:.2f}å…ƒ)ï¼Œå¯é€šè¿‡å¥—é¤æ¨èç­‰æ–¹å¼æå‡")else:insights.append(f"ğŸ“Šå¹³å‡å®¢å•ä»·è¾ƒä½({avg_order_value:.2f}å…ƒ)ï¼Œå»ºè®®åŠ å¼ºå®¢å•ä»·æå‡ç­–ç•¥")#æ—¶é—´æ´å¯Ÿif'ä¸‹å•æ—¶é—´æ®µ'indf.columns:peak_time=df['ä¸‹å•æ—¶é—´æ®µ'].value_counts().index[0]insights.append(f"â°è®¢å•é«˜å³°æ—¶æ®µä¸º{peak_time}ï¼Œå»ºè®®åœ¨æ­¤æ—¶æ®µåŠ å¼ºæœåŠ¡å’Œå¤‡è´§")#å•†å“æ´å¯Ÿif'å•†å“è§’è‰²'indf.columns:main_products_ratio=(df['å•†å“è§’è‰²']=='ä¸»åŠ›å“').mean()ifmain_products_ratio>0.6:insights.append("ğŸ¯ä¸»åŠ›å•†å“å æ¯”è¾ƒé«˜ï¼Œå•†å“ç»“æ„å¥åº·")else:insights.append("ğŸ“¦å‡‘å•å•†å“è¾ƒå¤šï¼Œå»ºè®®ä¼˜åŒ–å•†å“ç»„åˆå’Œæ¨èç­–ç•¥")#é…é€æ´å¯Ÿif'ç‰©æµé…é€è´¹'indf.columns:avg_delivery_fee=df['ç‰©æµé…é€è´¹'].mean()high_delivery_ratio=(df['ç‰©æµé…é€è´¹']>6).mean()ifhigh_delivery_ratio>0.2:insights.append(f"ğŸššé«˜é…é€è´¹è®¢å•å æ¯”{high_delivery_ratio:.1%}ï¼Œå»ºè®®ä¼˜åŒ–é…é€ç­–ç•¥")insights.append(f"ğŸ“å¹³å‡é…é€è´¹ä¸º{avg_delivery_fee:.2f}å…ƒï¼Œå¯è€ƒè™‘é…é€è´¹ä¼˜åŒ–æ–¹æ¡ˆ")#æ˜¾ç¤ºæ´å¯Ÿifinsights:fori,insightinenumerate(insights,1):st.markdown(f"""<divclass="recommendation-box"><strong>æ´å¯Ÿ{i}:</strong>{insight}</div>""",unsafe_allow_html=True)else:st.info("æ•°æ®åˆ†æä¸­ï¼Œæ›´å¤šæ´å¯Ÿæ­£åœ¨ç”Ÿæˆ...")#ç”Ÿæˆä¸šåŠ¡å»ºè®®st.subheader("ğŸ“‹ä¸šåŠ¡ä¼˜åŒ–å»ºè®®")suggestions=["ğŸ“ˆ**é”€å”®æå‡**:åˆ†æçƒ­é”€æ—¶æ®µå’Œçƒ­é”€å•†å“ï¼Œä¼˜åŒ–åº“å­˜å’Œæ¨å¹¿ç­–ç•¥","ğŸ’°**æˆæœ¬æ§åˆ¶**:é‡ç‚¹å…³æ³¨äºæŸè®¢å•ï¼Œåˆ†ææˆæœ¬æ„æˆå¹¶åˆ¶å®šæ”¹è¿›æªæ–½","ğŸšš**é…é€ä¼˜åŒ–**:ä¼˜åŒ–é…é€è·¯çº¿å’Œè´¹ç”¨ç»“æ„ï¼Œæå‡é…é€æ•ˆç‡","ğŸ¯**ç²¾å‡†è¥é”€**:åŸºäºå®¢æˆ·æ¶ˆè´¹è¡Œä¸ºï¼Œåˆ¶å®šä¸ªæ€§åŒ–æ¨èå’Œä¿ƒé”€ç­–ç•¥","ğŸ“Š**æ•°æ®ç›‘æ§**:å»ºç«‹å…³é”®æŒ‡æ ‡ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°ä¸šåŠ¡å¼‚å¸¸"]forsuggestioninsuggestions:st.markdown(f"-{suggestion}")#============================================================================#åœºæ™¯è¥é”€çœ‹æ¿æ¨¡å—#============================================================================deffilter_data_by_time_dimension(df:pd.DataFrame,time_dimension:str,selected_period:str=None,latest_only:bool=True)->pd.DataFrame:"""æ ¹æ®æ—¶é—´ç»´åº¦ç­›é€‰æ•°æ®å‚æ•°:df:æ•°æ®æ¡†ï¼ˆéœ€åŒ…å«æ—¶é—´ç»´åº¦å­—æ®µï¼‰time_dimension:æ—¶é—´ç»´åº¦('æ—¥','å‘¨','æœˆ')selected_period:é€‰æ‹©çš„å…·ä½“å‘¨æœŸï¼ˆNoneæˆ–"å…¨éƒ¨XXX"è¡¨ç¤ºä¸ç­›é€‰å…·ä½“å‘¨æœŸï¼‰latest_only:æ˜¯å¦åªä¿ç•™æœ€è¿‘ä¸€ä¸ªå‘¨æœŸçš„æ•°æ®ï¼ˆé»˜è®¤Trueï¼Œå½“selected_periodä¸ºNoneæˆ–"å…¨éƒ¨XXX"æ—¶ç”Ÿæ•ˆï¼‰è¿”å›:ç­›é€‰åçš„æ•°æ®æ¡†"""dim_mapping={'æ—¥':'æ—¥æœŸ_datetime','å‘¨':'å¹´å‘¨','æœˆ':'å¹´æœˆ'}time_col=dim_mapping.get(time_dimension)iftime_colnotindf.columns:returndf#å¦‚æœæŒ‡å®šäº†å…·ä½“å‘¨æœŸä¸”ä¸æ˜¯"å…¨éƒ¨XXX"ï¼Œåˆ™ç­›é€‰è¯¥å‘¨æœŸifselected_periodandnotselected_period.startswith("å…¨éƒ¨"):iftime_dimension=="æ—¥":#å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºdatetimeè¿›è¡Œæ¯”è¾ƒselected_date=pd.to_datetime(selected_period)returndf[df[time_col]==selected_date].copy()eliftime_dimension=="å‘¨":returndf[df[time_col]==selected_period].copy()else:#æœˆreturndf[df[time_col]==selected_period].copy()#å¦åˆ™ï¼Œå¦‚æœlatest_only=Trueï¼Œè¿”å›æœ€è¿‘ä¸€ä¸ªå‘¨æœŸiflatest_only:latest_period=df[time_col].max()returndf[df[time_col]==latest_period].copy()else:returndf.copy()defcalculate_period_over_period(df:pd.DataFrame,dimension:str,metric_col:str)->pd.DataFrame:"""è®¡ç®—ç¯æ¯”å˜åŒ–ï¼ˆæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦ï¼‰å‚æ•°:df:æ•°æ®æ¡†ï¼ˆéœ€åŒ…å«å¯¹åº”çš„æ—¶é—´ç»´åº¦å­—æ®µï¼‰dimension:æ—¶é—´ç»´åº¦('æ—¥','å‘¨','æœˆ')metric_col:æŒ‡æ ‡åˆ—åè¿”å›:åŒ…å«ç¯æ¯”å˜åŒ–çš„æ•°æ®æ¡†ï¼ˆä¸ºæ¯ä¸ªæŒ‡æ ‡å¢åŠ ç‹¬ç«‹çš„ç¯æ¯”åˆ—ï¼‰"""#æ˜ å°„ç»´åº¦åˆ°å­—æ®µådim_mapping={'æ—¥':'æ—¥æœŸ_datetime','å‘¨':'å¹´å‘¨','æœˆ':'å¹´æœˆ'}time_col=dim_mapping.get(dimension)iftime_colnotindf.columns:returndf#æŒ‰æ—¶é—´ç»´åº¦æ’åºdf=df.sort_values(time_col).reset_index(drop=True)#ä¸ºæ¯ä¸ªæŒ‡æ ‡åˆ›å»ºç‹¬ç«‹çš„ç¯æ¯”åˆ—prev_col=f'{metric_col}_ä¸ŠæœŸå€¼'change_col=f'{metric_col}_ç¯æ¯”å˜åŒ–'rate_col=f'{metric_col}_ç¯æ¯”ç‡'#è®¡ç®—ä¸ŠæœŸå€¼df[prev_col]=df[metric_col].shift(1)#è®¡ç®—ç¯æ¯”å˜åŒ–ï¼ˆç»å¯¹å€¼å’Œç™¾åˆ†æ¯”ï¼‰df[change_col]=df[metric_col]-df[prev_col]df[rate_col]=((df[metric_col]-df[prev_col])/df[prev_col]*100).round(2)#å¤„ç†æ— ç©·å¤§å’ŒNaNå€¼df[rate_col]=df[rate_col].replace([np.inf,-np.inf],np.nan)returndfdefformat_period_label(value,dimension:str)->str:"""æ ¼å¼åŒ–æ—¶é—´ç»´åº¦æ ‡ç­¾"""ifdimension=='æ—¥':ifisinstance(value,(pd.Timestamp,datetime)):returnvalue.strftime('%Y-%m-%d')returnstr(value)elifdimension=='å‘¨':returnstr(value)#å·²ç»æ˜¯'2024-W01'æ ¼å¼else:#æœˆreturnstr(value)#å·²ç»æ˜¯'2024-01'æ ¼å¼defrender_metric_with_comparison(col,metric_name:str,current_value,previous_value=None,format_type='number',unit=''):"""æ¸²æŸ“å¸¦ç¯æ¯”çš„æŒ‡æ ‡å¡ç‰‡å‚æ•°:col:streamlitåˆ—å¯¹è±¡metric_name:æŒ‡æ ‡åç§°current_value:å½“å‰å€¼previous_value:ä¸ŠæœŸå€¼format_type:æ ¼å¼åŒ–ç±»å‹('number','percent','currency')unit:å•ä½"""withcol:#æ ¼å¼åŒ–å½“å‰å€¼ifformat_type=='number':display_value=f"{int(current_value):,}{unit}"ifnotpd.isna(current_value)else"N/A"elifformat_type=='percent':display_value=f"{current_value:.2f}%"elifformat_type=='currency':display_value=f"Â¥{current_value:,.2f}"else:display_value=str(current_value)#è®¡ç®—ç¯æ¯”ifprevious_valueisnotNoneandnotpd.isna(previous_value)andprevious_value!=0:change_rate=((current_value-previous_value)/previous_value*100)change_abs=current_value-previous_value#åˆ¤æ–­æ¶¨è·Œifchange_rate>0:arrow="ğŸ“ˆ"color="green"sign="+"elifchange_rate<0:arrow="ğŸ“‰"color="red"sign=""else:arrow="â¡ï¸"color="gray"sign=""st.metric(label=metric_name,value=display_value,delta=f"{sign}{change_rate:.2f}%",delta_color="normal"ifchange_rate>=0else"inverse")else:st.metric(label=metric_name,value=display_value)defextract_time_features(df:pd.DataFrame)->pd.DataFrame:"""æå–æ—¶é—´ç‰¹å¾ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦ï¼‰"""df=df.copy()if'ä¸‹å•æ—¶é—´'indf.columns:df['ä¸‹å•æ—¶é—´']=pd.to_datetime(df['ä¸‹å•æ—¶é—´'])#åŸºç¡€æ—¶é—´å­—æ®µdf['æ—¥æœŸ']=df['ä¸‹å•æ—¶é—´'].dt.datedf['æ—¥æœŸ_datetime']=pd.to_datetime(df['æ—¥æœŸ'])df['å°æ—¶']=df['ä¸‹å•æ—¶é—´'].dt.hourdf['æ˜ŸæœŸ']=df['ä¸‹å•æ—¶é—´'].dt.dayofweekdf['æ˜ŸæœŸå']=df['ä¸‹å•æ—¶é—´'].dt.day_name()#å‘¨ç»´åº¦å­—æ®µdf['å¹´']=df['ä¸‹å•æ—¶é—´'].dt.isocalendar().yeardf['å‘¨']=df['ä¸‹å•æ—¶é—´'].dt.isocalendar().weekdf['å¹´å‘¨']=df['å¹´'].astype(str)+'-W'+df['å‘¨'].astype(str).str.zfill(2)#æœˆç»´åº¦å­—æ®µdf['å¹´æœˆ']=df['ä¸‹å•æ—¶é—´'].dt.to_period('M').astype(str)df['æœˆä»½']=df['ä¸‹å•æ—¶é—´'].dt.month#O2Oå¤–å–è¡Œä¸šæ—¶æ®µåˆ’åˆ†ï¼ˆåŸºäºç”¨æˆ·è¡Œä¸ºåœºæ™¯ï¼‰defget_time_period(hour):if6<=hour<8:return'æ¸…æ™¨(6-8ç‚¹)'elif8<=hour<9:return'æ—©é«˜å³°(8-9ç‚¹)'elif9<=hour<11:return'ä¸Šåˆ(9-11ç‚¹)'elif11<=hour<12:return'åˆé«˜å³°(11-12ç‚¹)'elif12<=hour<14:return'æ­£åˆ(12-14ç‚¹)'elif14<=hour<17:return'ä¸‹åˆ(14-17ç‚¹)'elif17<=hour<18:return'æ™šé«˜å³°å‰(17-18ç‚¹)'elif18<=hour<21:return'å‚æ™š(18-21ç‚¹)'elif21<=hour<24:return'æ™šé—´(21-24ç‚¹)'elif0<=hour<3:return'æ·±å¤œ(0-3ç‚¹)'else:#3-6ç‚¹return'å‡Œæ™¨(3-6ç‚¹)'#åœºæ™¯æ ‡ç­¾ï¼ˆç”¨äºåˆ†æå’Œè¥é”€ï¼‰defget_scene_label(hour):if6<=hour<8:return'å‡ºè¡Œ/æ•´ç†/æ—©é¤'elif8<=hour<9:return'é€šå‹¤/æ—©é¤'elif9<=hour<11:return'åŠå…¬/å±…å®¶/æ—¥ç”¨è¡¥å……'elif11<=hour<12:return'åˆé¤è®¢é¤é«˜å³°'elif12<=hour<14:return'åˆé¤/åˆä¼‘'elif14<=hour<17:return'å·¥ä½œ/å®¶åŠ¡/äº²å­/ä¸‹åˆèŒ¶'elif17<=hour<18:return'ä¸‹ç­å‰å¤‡é¤'elif18<=hour<21:return'ä¸‹ç­/å½’å®¶/æ™šé¤/è·¯é€”'elif21<=hour<24:return'å±…å®¶/å¤œç”Ÿæ´»/ç¡å‰'elif0<=hour<3:return'çªå‘/æ€¥ç”¨/å¤œå®µ'else:#3-6ç‚¹return'ä¸‡ç±ä¿±å¯‚/ç†¬å¤œå…š'df['æ—¶æ®µ']=df['å°æ—¶'].apply(get_time_period)df['åœºæ™¯æ ‡ç­¾']=df['å°æ—¶'].apply(get_scene_label)returndfdefrender_time_period_marketing(df:pd.DataFrame,time_dimension:str='æ—¥',selected_period:str=None):"""æ—¶æ®µåœºæ™¯è¥é”€åˆ†æï¼ˆæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦åˆ‡æ¢ï¼‰"""st.markdown('<pclass="sub-header">â°æ—¶æ®µåœºæ™¯è¥é”€åˆ†æ</p>',unsafe_allow_html=True)#====================åœºæ™¯è¥é”€ç†å¿µè¯´æ˜====================withst.expander("ğŸ’¡ä»€ä¹ˆæ˜¯çœŸæ­£çš„ã€Œåœºæ™¯è¥é”€ã€ï¼Ÿï¼ˆå¿«æ¶ˆé›¶å”®è§†è§’ï¼‰",expanded=False):st.markdown("""###ğŸ¯å¿«æ¶ˆé›¶å”®çš„åœºæ™¯æœ¬è´¨**åœºæ™¯=éœ€æ±‚è§¦å‘ç‚¹+è´­ä¹°æ—¶æœº+å•†å“è§£å†³æ–¹æ¡ˆ**####å¿«æ¶ˆé›¶å”®çš„æ ¸å¿ƒåœºæ™¯é—®é¢˜ï¼š1.**ä»€ä¹ˆåœºæ™¯ä¸‹ç”¨æˆ·ä¼šçªç„¶æƒ³ä¹°é›¶é£Ÿé¥®æ–™æ—¥ç”¨å“ï¼Ÿ**-ğŸ¢**åŠå…¬åœºæ™¯**ï¼šä¸‹åˆçŠ¯å›°â†’å’–å•¡ã€åŠŸèƒ½é¥®æ–™ã€é›¶é£Ÿ-ğŸ **å±…å®¶åœºæ™¯**ï¼šè¿½å‰§ã€æ¸¸æˆâ†’è–¯ç‰‡ã€ç“œå­ã€å¯ä¹-ğŸ‰**èšä¼šåœºæ™¯**ï¼šæœ‹å‹æ¥äº†â†’å•¤é…’ã€é›¶é£Ÿã€æ°´æœ-ğŸš¨**åº”æ€¥åœºæ™¯**ï¼šçªç„¶æƒ³èµ·ç¼ºæŸç‰©â†’çº¸å·¾ã€æ´—å‘æ°´ã€ç”µæ± -ğŸŒ™**æ·±å¤œåœºæ™¯**ï¼šå¤±çœ ã€åŠ ç­â†’æ³¡é¢ã€é›¶é£Ÿã€é¥®æ–™2.**å¦‚ä½•æ»¡è¶³ç”¨æˆ·çš„ã€Œå³åˆ»éœ€æ±‚ã€å’Œã€Œæ€¥éœ€ç—›ç‚¹ã€ï¼Ÿ**-âš¡**é€Ÿåº¦ä¸ºç‹**ï¼š30åˆ†é’Ÿå†…é€è¾¾ï¼ˆç«å¯¹ä¹Ÿèƒ½åšåˆ°ï¼‰-ğŸ¯**15åˆ†é’Ÿå¿…è¾¾**ï¼š1å…¬é‡Œæ ¸å¿ƒåœˆçš„ç«äº‰å£å’-ğŸ“¦**å“ç±»é½å…¨**ï¼šç”¨æˆ·ä¸€æ¬¡æ€§ä¹°é½æ‰€éœ€ï¼ˆå‡å°‘è·³è½¬å…¶ä»–å¹³å°ï¼‰-ï¿½**æ™ºèƒ½æ¨è**ï¼šä¹°é›¶é£Ÿæ¨èé¥®æ–™ï¼Œä¹°å•¤é…’æ¨èä¸‹é…’èœ3.**å¦‚ä½•æ¯”ç¾å›¢ã€é¥¿äº†ä¹ˆä¸Šçš„å…¶ä»–å•†å®¶æ›´å¿«ï¼Ÿ**-ğŸƒ**è·ç¦»ä¼˜åŠ¿**ï¼š1å…¬é‡Œå†…å¿…æœ‰ä»“ï¼Œç‰©ç†è·ç¦»æœ€çŸ­-ğŸ¤–**å¤‡è´§ä¼˜åŠ¿**ï¼šé«˜é¢‘å•†å“å……è¶³åº“å­˜ï¼Œä¸ç¼ºè´§-ğŸ“±**ä¾¿æ·ä¼˜åŠ¿**ï¼šä¸€é”®å¤è´­ã€è´­ç‰©è½¦æ™ºèƒ½æ¨è-â°**æ—¶æ®µä¼˜åŠ¿**ï¼šé¢„åˆ¤éœ€æ±‚é«˜å³°ï¼ˆå¦‚ä¸‹åˆ3ç‚¹å’–å•¡éœ€æ±‚ï¼‰####å¿«æ¶ˆé›¶å”®çš„æ ¸å¿ƒæ—¶æ®µåœºæ™¯ï¼š**ğŸ“Šå·¥ä½œæ—¥åœºæ™¯**-**ä¸Šåˆåœºæ™¯ï¼ˆ9-11ç‚¹ï¼‰**ï¼šåŠå…¬æç¥â†’å’–å•¡ã€èŒ¶é¥®ã€åšæœã€å·§å…‹åŠ›-**ä¸‹åˆåœºæ™¯ï¼ˆ14-17ç‚¹ï¼‰**ï¼šä¸‹åˆèŒ¶ã€çŠ¯å›°â†’å¥¶èŒ¶ã€åŠŸèƒ½é¥®æ–™ã€é¥¼å¹²ã€ç³–æœ-**æ™šé—´åœºæ™¯ï¼ˆ19-22ç‚¹ï¼‰**ï¼šå±…å®¶æ”¾æ¾â†’é›¶é£Ÿã€é¥®æ–™ã€æ°´æœã€é…’æ°´-**æ·±å¤œåœºæ™¯ï¼ˆ22-24ç‚¹ï¼‰**ï¼šè¿½å‰§ã€æ¸¸æˆã€å¤±çœ â†’æ³¡é¢ã€è†¨åŒ–é£Ÿå“ã€é¥®æ–™**ğŸ¡å‘¨æœ«åœºæ™¯**-**å®¶åº­é‡‡è´­ï¼ˆ10-18ç‚¹ï¼‰**ï¼šå›¤è´§ã€è®¡åˆ’æ€§è´­ä¹°â†’æ—¥ç”¨ç™¾è´§ã€å¤§åŒ…è£…é›¶é£Ÿ-**èšä¼šåœºæ™¯ï¼ˆ18-23ç‚¹ï¼‰**ï¼šæœ‹å‹èšä¼šã€å®¶åº­å¨±ä¹â†’å•¤é…’ã€çƒ§çƒ¤é›¶é£Ÿã€å¤å‘³**ğŸš¨åº”æ€¥åœºæ™¯ï¼ˆå…¨æ—¶æ®µï¼‰**-çªç„¶å‘ç°ç¼ºæŸç‰©ï¼šçº¸å·¾ã€æ´—è¡£æ¶²ã€åƒåœ¾è¢‹ã€ç”µæ± ã€å……ç”µå™¨-ä¸´æ—¶æ¥å®¢äººï¼šé¥®æ–™ã€é›¶é£Ÿã€æ°´æœã€é…’æ°´-å©´å„¿ç”¨å“ï¼šå¥¶ç²‰ã€å°¿ä¸æ¹¿ã€æ¹¿å·¾ï¼ˆé€Ÿåº¦ç¬¬ä¸€ï¼‰####æœ¬çœ‹æ¿æä¾›çš„åœºæ™¯æ´å¯Ÿï¼š-è¯†åˆ«**é«˜é¢‘è´­ä¹°æ—¶æ®µ**ï¼ˆä»€ä¹ˆæ—¶å€™ç”¨æˆ·æœ€çˆ±ä¹°ï¼‰-åˆ†æ**æ—¶æ®µå•†å“åå¥½**ï¼ˆä¸åŒæ—¶æ®µå–ä»€ä¹ˆï¼‰-å‘ç°**é…é€æ—¶æ•ˆç—›ç‚¹**ï¼ˆå“ªäº›æ—¶æ®µé…é€å‹åŠ›å¤§ï¼‰-æä¾›**åœºæ™¯åŒ–è¿è¥ç­–ç•¥**ï¼ˆå¦‚ä½•ç²¾å‡†æ»¡è¶³å³æ—¶éœ€æ±‚ï¼‰---**ğŸ’¼å¿«æ¶ˆé›¶å”®çš„ç»ˆæç›®æ ‡**ï¼šåœ¨ç”¨æˆ·æƒ³èµ·æ¥çš„**é‚£ä¸€åˆ»**ï¼Œä»¥**æœ€å¿«é€Ÿåº¦**é€è¾¾ä»–ä»¬**æ€¥éœ€çš„å•†å“**ï¼""")df=extract_time_features(df)#æ˜ å°„ç»´åº¦åˆ°å­—æ®µådim_mapping={'æ—¥':'æ—¥æœŸ_datetime','å‘¨':'å¹´å‘¨','æœˆ':'å¹´æœˆ'}time_col=dim_mapping[time_dimension]#å®šä¹‰æ—¶æ®µé¡ºåºï¼ˆæŒ‰æ—¶é—´è‡ªç„¶é¡ºåºï¼‰time_period_order=['å‡Œæ™¨(3-6ç‚¹)','æ¸…æ™¨(6-8ç‚¹)','æ—©é«˜å³°(8-9ç‚¹)','ä¸Šåˆ(9-11ç‚¹)','åˆé«˜å³°(11-12ç‚¹)','æ­£åˆ(12-14ç‚¹)','ä¸‹åˆ(14-17ç‚¹)','æ™šé«˜å³°å‰(17-18ç‚¹)','å‚æ™š(18-21ç‚¹)','æ™šé—´(21-24ç‚¹)','æ·±å¤œ(0-3ç‚¹)']#åœºæ™¯è¯´æ˜scene_descriptions={'å‡Œæ™¨(3-6ç‚¹)':'ä¸‡ç±ä¿±å¯‚/ç†¬å¤œå…š','æ¸…æ™¨(6-8ç‚¹)':'å‡ºè¡Œ/æ•´ç†/æ—©é¤','æ—©é«˜å³°(8-9ç‚¹)':'é€šå‹¤/æ—©é¤','ä¸Šåˆ(9-11ç‚¹)':'åŠå…¬/å±…å®¶/æ—¥ç”¨è¡¥å……','åˆé«˜å³°(11-12ç‚¹)':'åˆé¤è®¢é¤é«˜å³°','æ­£åˆ(12-14ç‚¹)':'åˆé¤/åˆä¼‘','ä¸‹åˆ(14-17ç‚¹)':'å·¥ä½œ/å®¶åŠ¡/äº²å­/ä¸‹åˆèŒ¶','æ™šé«˜å³°å‰(17-18ç‚¹)':'ä¸‹ç­å‰å¤‡é¤','å‚æ™š(18-21ç‚¹)':'ä¸‹ç­/å½’å®¶/æ™šé¤/è·¯é€”','æ™šé—´(21-24ç‚¹)':'å±…å®¶/å¤œç”Ÿæ´»/ç¡å‰','æ·±å¤œ(0-3ç‚¹)':'çªå‘/æ€¥ç”¨/å¤œå®µ'}#====================æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ï¼ˆå¸¦ç¯æ¯”ï¼‰====================st.markdown(f"###ğŸ“ˆæ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆï¼ˆæŒ‰{time_dimension}ï¼‰")#æŒ‰æ—¶é—´ç»´åº¦èšåˆæ•°æ®iftime_colindf.columns:#å®‰å…¨åœ°è·å–åˆ—ï¼Œé¿å…é‡å¤åˆ—åé—®é¢˜try:#æ£€æŸ¥å¹¶å¤„ç†é‡å¤åˆ—åifisinstance(df['è®¢å•ID'],pd.DataFrame):#å¦‚æœæ˜¯DataFrameï¼Œè¯´æ˜æœ‰é‡å¤åˆ—åï¼Œå–ç¬¬ä¸€åˆ—order_id_series=df['è®¢å•ID'].iloc[:,0]else:order_id_series=df['è®¢å•ID']ifisinstance(df['å•†å“å®å”®ä»·'],pd.DataFrame):price_series=df['å•†å“å®å”®ä»·'].iloc[:,0]else:price_series=df['å•†å“å®å”®ä»·']ifisinstance(df['æ”¶è´§åœ°å€'],pd.DataFrame):address_series=df['æ”¶è´§åœ°å€'].iloc[:,0]else:address_series=df['æ”¶è´§åœ°å€']#åˆ›å»ºä¸´æ—¶DataFrameç”¨äºèšåˆtemp_df=pd.DataFrame({time_col:df[time_col],'è®¢å•ID_temp':order_id_series,'å•†å“å®å”®ä»·_temp':price_series,'æ”¶è´§åœ°å€_temp':address_series})time_agg=temp_df.groupby(time_col).agg({'è®¢å•ID_temp':'nunique','å•†å“å®å”®ä»·_temp':'sum','æ”¶è´§åœ°å€_temp':'nunique'}).reset_index()time_agg.columns=[time_col,'è®¢å•æ•°','é”€å”®é¢','å®¢æˆ·æ•°']exceptExceptionase:st.error(f"èšåˆæ•°æ®æ—¶å‡ºé”™:{str(e)}")st.info("ä½¿ç”¨ç®€åŒ–çš„æ•°æ®èšåˆæ–¹å¼")#ä½¿ç”¨æœ€ç®€å•çš„æ–¹å¼èšåˆtime_agg=df.groupby(time_col).size().reset_index(name='è®¢å•æ•°')time_agg['é”€å”®é¢']=0time_agg['å®¢æˆ·æ•°']=0#è®¡ç®—ç¯æ¯”time_agg=calculate_period_over_period(time_agg,time_dimension,'è®¢å•æ•°')time_agg=calculate_period_over_period(time_agg,time_dimension,'é”€å”®é¢')time_agg=calculate_period_over_period(time_agg,time_dimension,'å®¢æˆ·æ•°')#è·å–å½“å‰æœŸå’Œä¸Šä¸€æœŸæ•°æ®ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©æˆ–æœ€è¿‘ä¸€æœŸï¼‰iflen(time_agg)>=1:#å¦‚æœç”¨æˆ·é€‰æ‹©äº†å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨é€‰æ‹©çš„å‘¨æœŸï¼›å¦åˆ™ä½¿ç”¨æœ€è¿‘ä¸€æœŸifselected_periodandnotselected_period.startswith("å…¨éƒ¨"):iftime_dimension=="æ—¥":selected_date=pd.to_datetime(selected_period)latest_idx=time_agg[time_agg[time_col]==selected_date].indexelse:latest_idx=time_agg[time_agg[time_col]==selected_period].indexiflen(latest_idx)>0:latest=time_agg.loc[latest_idx[0]]#è·å–ä¸Šä¸€æœŸæ•°æ®current_position=latest_idx[0]previous=time_agg.iloc[current_position-1]ifcurrent_position>0elseNoneelse:latest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNoneelse:#æœªé€‰æ‹©å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨æœ€è¿‘ä¸€æœŸlatest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNonecol1,col2,col3,col4=st.columns(4)#å½“å‰å‘¨æœŸwithcol1:period_label=format_period_label(latest[time_col],time_dimension)st.metric(label=f"å½“å‰{time_dimension}",value=period_label)#è®¢å•æ•°ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col2,f"è®¢å•æ•°",latest['è®¢å•æ•°'],previous['è®¢å•æ•°']ifpreviousisnotNoneelseNone,format_type='number',unit='å•')#é”€å”®é¢ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col3,f"é”€å”®é¢",latest['é”€å”®é¢'],previous['é”€å”®é¢']ifpreviousisnotNoneelseNone,format_type='currency')#å®¢æˆ·æ•°ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col4,f"å®¢æˆ·æ•°",latest['å®¢æˆ·æ•°'],previous['å®¢æˆ·æ•°']ifpreviousisnotNoneelseNone,format_type='number',unit='äºº')st.markdown("---")#====================è¶‹åŠ¿å›¾ï¼ˆå¤šæœŸå¯¹æ¯”ï¼‰====================st.markdown(f"###ğŸ“Š{time_dimension}åº¦è¶‹åŠ¿åˆ†æ")tab1,tab2,tab3=st.tabs(["è®¢å•é‡è¶‹åŠ¿","é”€å”®é¢è¶‹åŠ¿","å®¢æˆ·æ•°è¶‹åŠ¿"])withtab1:fig=px.line(time_agg,x=time_col,y='è®¢å•æ•°',title=f'è®¢å•æ•°{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#1f77b4',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)#ç¯æ¯”å˜åŒ–è¡¨æ ¼if'è®¢å•æ•°_ç¯æ¯”ç‡'intime_agg.columns:st.write("**ç¯æ¯”å˜åŒ–è¯¦æƒ…**")display_df=time_agg[[time_col,'è®¢å•æ•°','è®¢å•æ•°_ä¸ŠæœŸå€¼','è®¢å•æ•°_ç¯æ¯”å˜åŒ–','è®¢å•æ•°_ç¯æ¯”ç‡']].tail(10)display_df.columns=['æ—¶é—´å‘¨æœŸ','å½“å‰è®¢å•æ•°','ä¸ŠæœŸè®¢å•æ•°','ç¯æ¯”å˜åŒ–é‡','ç¯æ¯”å˜åŒ–ç‡(%)']st.dataframe(display_df.style.format({'å½“å‰è®¢å•æ•°':'{:.0f}','ä¸ŠæœŸè®¢å•æ•°':'{:.0f}','ç¯æ¯”å˜åŒ–é‡':'{:+.0f}','ç¯æ¯”å˜åŒ–ç‡(%)':'{:+.2f}%'}),use_container_width=True)withtab2:fig=px.line(time_agg,x=time_col,y='é”€å”®é¢',title=f'é”€å”®é¢{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#2ca02c',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)#ç¯æ¯”å˜åŒ–è¡¨æ ¼if'é”€å”®é¢_ç¯æ¯”ç‡'intime_agg.columns:st.write("**ç¯æ¯”å˜åŒ–è¯¦æƒ…**")display_df=time_agg[[time_col,'é”€å”®é¢','é”€å”®é¢_ä¸ŠæœŸå€¼','é”€å”®é¢_ç¯æ¯”å˜åŒ–','é”€å”®é¢_ç¯æ¯”ç‡']].tail(10)display_df.columns=['æ—¶é—´å‘¨æœŸ','å½“å‰é”€å”®é¢','ä¸ŠæœŸé”€å”®é¢','ç¯æ¯”å˜åŒ–é¢','ç¯æ¯”å˜åŒ–ç‡(%)']st.dataframe(display_df.style.format({'å½“å‰é”€å”®é¢':'Â¥{:,.2f}','ä¸ŠæœŸé”€å”®é¢':'Â¥{:,.2f}','ç¯æ¯”å˜åŒ–é¢':'Â¥{:+,.2f}','ç¯æ¯”å˜åŒ–ç‡(%)':'{:+.2f}%'}),use_container_width=True)withtab3:fig=px.line(time_agg,x=time_col,y='å®¢æˆ·æ•°',title=f'å®¢æˆ·æ•°{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#ff7f0e',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)#ç¯æ¯”å˜åŒ–è¡¨æ ¼if'å®¢æˆ·æ•°_ç¯æ¯”ç‡'intime_agg.columns:st.write("**ç¯æ¯”å˜åŒ–è¯¦æƒ…**")display_df=time_agg[[time_col,'å®¢æˆ·æ•°','å®¢æˆ·æ•°_ä¸ŠæœŸå€¼','å®¢æˆ·æ•°_ç¯æ¯”å˜åŒ–','å®¢æˆ·æ•°_ç¯æ¯”ç‡']].tail(10)display_df.columns=['æ—¶é—´å‘¨æœŸ','å½“å‰å®¢æˆ·æ•°','ä¸ŠæœŸå®¢æˆ·æ•°','ç¯æ¯”å˜åŒ–é‡','ç¯æ¯”å˜åŒ–ç‡(%)']st.dataframe(display_df.style.format({'å½“å‰å®¢æˆ·æ•°':'{:.0f}','ä¸ŠæœŸå®¢æˆ·æ•°':'{:.0f}','ç¯æ¯”å˜åŒ–é‡':'{:+.0f}','ç¯æ¯”å˜åŒ–ç‡(%)':'{:+.2f}%'}),use_container_width=True)st.markdown("---")#====================æ—¶æ®µåˆ†å¸ƒï¼ˆæ ¹æ®é€‰å®šçš„æ—¶é—´ç»´åº¦ç­›é€‰æœ€è¿‘ä¸€æœŸï¼‰====================st.markdown(f"###â°åˆ†æ—¶æ®µåœºæ™¯åˆ†æï¼ˆå½“å‰{time_dimension}æ•°æ®ï¼‰")#ç­›é€‰æœ€è¿‘ä¸€ä¸ªå‘¨æœŸçš„æ•°æ®ç”¨äºæ—¶æ®µåˆ†æfiltered_df=filter_data_by_time_dimension(df,time_dimension,selected_period,latest_only=True)iflen(filtered_df)==0:st.warning(f"âš ï¸å½“å‰{time_dimension}æš‚æ— æ•°æ®")return#æ˜¾ç¤ºå½“å‰åˆ†æçš„æ—¶é—´èŒƒå›´iftime_colinfiltered_df.columns:current_period=filtered_df[time_col].iloc[0]period_label=format_period_label(current_period,time_dimension)st.info(f"ğŸ“…å½“å‰åˆ†ææ—¶é—´ï¼š{period_label}")col1,col2=st.columns(2)withcol1:st.write("**ğŸ“Šåˆ†æ—¶æ®µè®¢å•é‡åˆ†å¸ƒ**")if'æ—¶æ®µ'infiltered_df.columns:#åˆå§‹åŒ–å˜é‡peak_period="N/A"peak_orders=0low_period="N/A"low_orders=0try:#åˆ›å»ºä¸´æ—¶DataFrameå¤„ç†é‡å¤åˆ—åtemp_df=filtered_df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]ifisinstance(temp_df['æ—¶æ®µ'],pd.DataFrame):temp_df['æ—¶æ®µ']=temp_df['æ—¶æ®µ'].iloc[:,0]#æŒ‰æ—¶æ®µç»Ÿè®¡å”¯ä¸€è®¢å•æ•°order_by_period=temp_df.groupby('æ—¶æ®µ')['è®¢å•ID'].nunique()#é‡æ–°ç´¢å¼•åˆ°æ‰€æœ‰æ—¶æ®µiflen(order_by_period)>0:order_by_period=order_by_period.reindex(time_period_order,fill_value=0)fig=px.bar(x=order_by_period.index,y=order_by_period.values,labels={'x':'æ—¶æ®µ','y':'è®¢å•é‡'},title=f'å„æ—¶æ®µè®¢å•é‡å¯¹æ¯”ï¼ˆ{period_label}ï¼‰',color=order_by_period.values,color_continuous_scale='Blues')fig.update_layout(showlegend=False,height=400)st.plotly_chart(fig,use_container_width=True)peak_period=order_by_period.idxmax()peak_orders=int(order_by_period.max())low_period=order_by_period.idxmin()low_orders=int(order_by_period.min())else:st.info("æš‚æ— æ—¶æ®µæ•°æ®")exceptExceptionase:st.error(f"ç»˜åˆ¶æ—¶æ®µåˆ†å¸ƒå›¾æ—¶å‡ºé”™:{str(e)}")st.write(f"è°ƒè¯•ä¿¡æ¯-filtered_dfå½¢çŠ¶:{filtered_df.shape}")if'æ—¶æ®µ'infiltered_df.columns:st.write(f"æ—¶æ®µåˆ—å”¯ä¸€å€¼:{filtered_df['æ—¶æ®µ'].unique()}")#åªæœ‰åœ¨æœ‰æœ‰æ•ˆæ•°æ®æ—¶æ‰æ˜¾ç¤ºæ´å¯Ÿifpeak_period!="N/A":st.markdown(f"""<divclass="insight-box"><b>ğŸ’¡å…³é”®æ´å¯Ÿï¼š</b><br>â€¢é«˜å³°æ—¶æ®µï¼š<b>{peak_period}</b>ï¼ˆ{peak_orders:,}å•ï¼‰<br>â€¢ä½è°·æ—¶æ®µï¼š<b>{low_period}</b>ï¼ˆ{low_orders:,}å•ï¼‰<br>â€¢å³°è°·å·®å¼‚ï¼š{(peak_orders-low_orders):,}å•ï¼ˆ{(peak_orders/max(low_orders,1)-1)*100:.1f}%ï¼‰</div>""",unsafe_allow_html=True)else:st.info("æ— æ—¶é—´æ•°æ®")withcol2:st.write("**ğŸ’°åˆ†æ—¶æ®µå®¢å•ä»·åˆ†å¸ƒ**")if'æ—¶æ®µ'infiltered_df.columns:try:#åˆ›å»ºä¸´æ—¶DataFrameï¼Œå¤„ç†é‡å¤åˆ—åtemp_df=filtered_df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]ifisinstance(temp_df['å•†å“å®å”®ä»·'],pd.DataFrame):temp_df['å•†å“å®å”®ä»·']=temp_df['å•†å“å®å”®ä»·'].iloc[:,0]period_sales=temp_df.groupby(['æ—¶æ®µ','è®¢å•ID'])['å•†å“å®å”®ä»·'].sum().groupby('æ—¶æ®µ').mean()period_sales=period_sales.reindex(time_period_order,fill_value=0)fig=px.line(x=period_sales.index,y=period_sales.values,labels={'x':'æ—¶æ®µ','y':'å¹³å‡å®¢å•ä»·(å…ƒ)'},title=f'å„æ—¶æ®µå¹³å‡å®¢å•ä»·è¶‹åŠ¿ï¼ˆ{period_label}ï¼‰',markers=True)fig.update_traces(line_color='#ff7f0e',marker=dict(size=10))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)high_value_period=period_sales.idxmax()high_value=period_sales.max()st.markdown(f"""<divclass="insight-box"><b>ğŸ’¡å…³é”®æ´å¯Ÿï¼š</b><br>â€¢é«˜ä»·å€¼æ—¶æ®µï¼š<b>{high_value_period}</b>ï¼ˆÂ¥{high_value:.2f}ï¼‰<br>â€¢å…¨å¤©å¹³å‡å®¢å•ä»·ï¼šÂ¥{period_sales.mean():.2f}<br>â€¢å»ºè®®ï¼šé«˜ä»·å€¼æ—¶æ®µå¯å‡å°‘ä¿ƒé”€åŠ›åº¦ï¼Œæå‡åˆ©æ¶¦ç‡</div>""",unsafe_allow_html=True)exceptExceptionase:st.error(f"è®¡ç®—å®¢å•ä»·åˆ†å¸ƒæ—¶å‡ºé”™:{str(e)}")else:st.info("æ— æ—¶é—´æ•°æ®")#æ·»åŠ è¯¦ç»†æ—¶æ®µåœºæ™¯åˆ†æè¡¨st.write(f"**ğŸ“‹æ—¶æ®µåœºæ™¯è¯¦ç»†åˆ†æï¼ˆ{period_label}ï¼‰**")if'æ—¶æ®µ'infiltered_df.columns:try:#åˆ›å»ºä¸´æ—¶DataFrameå¤„ç†é‡å¤åˆ—åtemp_df=filtered_df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]ifisinstance(temp_df['å•†å“å®å”®ä»·'],pd.DataFrame):temp_df['å•†å“å®å”®ä»·']=temp_df['å•†å“å®å”®ä»·'].iloc[:,0]period_detail=[]total_orders=temp_df['è®¢å•ID'].nunique()forperiodintime_period_order:period_df=temp_df[temp_df['æ—¶æ®µ']==period]iflen(period_df)==0:continueorders=period_df['è®¢å•ID'].nunique()items=len(period_df)avg_price=period_df.groupby('è®¢å•ID')['å•†å“å®å”®ä»·'].sum().mean()period_detail.append({'æ—¶æ®µ':period,'åœºæ™¯':scene_descriptions.get(period,'-'),'è®¢å•é‡':f'{orders:,}','å•†å“æ•°':f'{items:,}','å¹³å‡å®¢å•ä»·':f'Â¥{avg_price:.2f}','è®¢å•å æ¯”':f'{orders/total_orders*100:.1f}%'})ifperiod_detail:detail_df=pd.DataFrame(period_detail)st.dataframe(detail_df,use_container_width=True,hide_index=True)else:st.info("æš‚æ— æ—¶æ®µè¯¦ç»†æ•°æ®")exceptExceptionase:st.error(f"ç”Ÿæˆæ—¶æ®µè¯¦ç»†åˆ†ææ—¶å‡ºé”™:{str(e)}")#====================åœºæ™¯å•†å“åˆ†æ====================st.markdown(f"###ğŸ›ï¸åœºæ™¯å•†å“æ´å¯Ÿï¼šä»€ä¹ˆæ—¶æ®µç”¨æˆ·ä¹°ä»€ä¹ˆï¼Ÿ")if'æ—¶æ®µ'infiltered_df.columnsand'ä¸‰çº§åˆ†ç±»å'infiltered_df.columns:#å®šä¹‰å¿«æ¶ˆé›¶å”®çš„æ ¸å¿ƒåœºæ™¯æ—¶æ®µï¼ˆåŸºäºO2Oé…é€ç‰¹å¾ä¼˜åŒ–ï¼‰#âš ï¸æ³¨æ„ï¼šæ—¶æ®µåç§°å¿…é¡»ä¸extract_time_featureså‡½æ•°ä¸­å®šä¹‰çš„å®Œå…¨ä¸€è‡´key_scenes={'æ—©é¤åˆšéœ€':['æ¸…æ™¨(6-8ç‚¹)','æ—©é«˜å³°(8-9ç‚¹)'],#ä¿®æ­£ï¼šå¯¹åº”6-9ç‚¹æ—©é¤æ—¶æ®µ'æ—¥å¸¸è¡¥ç»™':['ä¸Šåˆ(9-11ç‚¹)','ä¸‹åˆ(14-17ç‚¹)'],'æ­£é¤é«˜å³°':['åˆé«˜å³°(11-12ç‚¹)','æ­£åˆ(12-14ç‚¹)','æ™šé«˜å³°å‰(17-18ç‚¹)','å‚æ™š(18-21ç‚¹)'],#ä¿®æ­£ï¼šåŒ…å«å®Œæ•´åˆé¤å’Œæ™šé¤æ—¶æ®µ'ä¼‘é—²å¨±ä¹':['ä¸‹åˆ(14-17ç‚¹)','æ™šé—´(21-24ç‚¹)'],'æ·±å¤œåº”æ€¥':['æ·±å¤œ(0-3ç‚¹)','å‡Œæ™¨(3-6ç‚¹)']}tabs=st.tabs(list(key_scenes.keys()))foridx,(scene_name,time_periods)inenumerate(key_scenes.items()):withtabs[idx]:scene_df=filtered_df[filtered_df['æ—¶æ®µ'].isin(time_periods)]iflen(scene_df)>0:#å•†å“é”€é‡TOP10top_products=scene_df.groupby('ä¸‰çº§åˆ†ç±»å').size().sort_values(ascending=False).head(10)col_a,col_b=st.columns([2,1])withcol_a:fig=px.bar(x=top_products.values,y=top_products.index,orientation='h',title=f'{scene_name}-TOP10çƒ­é”€å•†å“',labels={'x':'é”€é‡','y':'å•†å“åˆ†ç±»'},color=top_products.values,color_continuous_scale='Oranges')fig.update_layout(showlegend=False,height=400,yaxis={'categoryorder':'totalascending'})st.plotly_chart(fig,use_container_width=True)withcol_b:st.write(f"**{scene_name}æ•°æ®**")scene_orders=scene_df['è®¢å•ID'].nunique()scene_sales=scene_df.groupby('è®¢å•ID')['å•†å“å®å”®ä»·'].sum().sum()scene_avg_price=scene_sales/scene_ordersifscene_orders>0else0st.metric("è®¢å•é‡",f"{scene_orders:,}å•")st.metric("é”€å”®é¢",f"Â¥{scene_sales:,.2f}")st.metric("å¹³å‡å®¢å•ä»·",f"Â¥{scene_avg_price:.2f}")#åœºæ™¯ç‰¹å¾å•†å“iflen(top_products)>=3:st.write("**ğŸ¯åœºæ™¯ç‰¹å¾å•†å“**")fori,(prod,cnt)inenumerate(top_products.head(3).items(),1):st.markdown(f"{i}.**{prod}**ï¼ˆ{cnt}ä»¶ï¼‰")#O2Oå¿«æ¶ˆé›¶å”®åœºæ™¯ç­–ç•¥å»ºè®®ï¼ˆåŸºäº8æ—¶æ®µæ¡†æ¶ï¼‰scene_strategy={'æ—©é¤åˆšéœ€':"""<divclass="insight-box"><b>ğŸ’¡æ—©é¤åˆšéœ€åœºæ™¯ç­–ç•¥ï¼ˆ6-9ç‚¹ï¼‰</b><br><b>æ—¶æ®µè¦†ç›–</b>ï¼šæ¸…æ™¨(6-8ç‚¹)+æ—©é«˜å³°(8-9ç‚¹)<br><b>ç”¨æˆ·ç”»åƒ</b>ï¼šé€šå‹¤ä¸Šç­æ—ã€å­¦ç”Ÿå…šã€æ—©èµ·è¿åŠ¨è€…<br><b>æ ¸å¿ƒå•†å“</b>ï¼šé¢åŒ…ã€åŒ…å­ã€ç‰›å¥¶ã€è±†æµ†ã€æ²¹æ¡ã€èŒ¶å¶è›‹ã€ç²¥ç±»ã€å’–å•¡<br><b>è¡Œä¸ºç‰¹å¾</b>ï¼šæ—¶é—´ç´§è¿«ã€å³ä¹°å³èµ°ã€å¤è´­ç‡é«˜ã€å¯¹é€Ÿåº¦æåº¦æ•æ„Ÿ<br><b>è¿è¥ç­–ç•¥</b>ï¼š<br>â€¢<b>é€Ÿåº¦è‡³ä¸Š</b>ï¼šæ‰¿è¯º15åˆ†é’Ÿè¾¾ï¼Œè¿Ÿåˆ°ç«‹å‡/å…å•<br>â€¢<b>æ—©é¤å¥—é¤</b>ï¼šè±†æµ†+æ²¹æ¡ã€é¢åŒ…+ç‰›å¥¶ä¸€é”®ä¸‹å•<br>â€¢<b>è®¢é˜…æœåŠ¡</b>ï¼šå·¥ä½œæ—¥æ—©é¤åŒ…æœˆï¼Œå›ºå®šæ—¶é—´é€è¾¾<br>â€¢<b>æå‰å¤‡è´§</b>ï¼š6-8ç‚¹çƒ­é”€å“é¢„å¤‡2å€åº“å­˜</div>""",'æ—¥å¸¸è¡¥ç»™':"""<divclass="insight-box"><b>ğŸ’¡æ—¥å¸¸è¡¥ç»™åœºæ™¯ç­–ç•¥ï¼ˆ9-12ç‚¹&14-17ç‚¹ï¼‰</b><br><b>ç”¨æˆ·ç”»åƒ</b>ï¼šå±…å®¶ä¸»å¦‡/ä¸»å¤«ã€è¿œç¨‹åŠå…¬è€…ã€é€€ä¼‘è€äºº<br><b>æ ¸å¿ƒå•†å“</b>ï¼šè”¬èœæ°´æœã€ç±³é¢ç²®æ²¹ã€è°ƒå‘³å“ã€æ—¥ç”¨å“ã€é›¶é£Ÿé¥®æ–™<br><b>è¡Œä¸ºç‰¹å¾</b>ï¼šè®¡åˆ’æ€§é‡‡è´­ã€ä»·æ ¼æ•æ„Ÿã€å“ç±»å¤šæ ·ã€å…³æ³¨å“è´¨<br><b>è¿è¥ç­–ç•¥</b>ï¼š<br>â€¢<b>æ»¡å‡ä¿ƒé”€</b>ï¼šæ»¡50å‡5ã€æ»¡100å‡15é˜¶æ¢¯ä¼˜æƒ <br>â€¢<b>ç»„åˆæ¨è</b>ï¼šæ ¹æ®å†å²è®¢å•æ™ºèƒ½æ¨èï¼ˆç•ªèŒ„â†’é¸¡è›‹ï¼‰<br>â€¢<b>å“è´¨ä¿éšœ</b>ï¼šç”Ÿé²œå“è´¨æ‰¿è¯ºï¼Œä¸æ»¡æ„é€€æ¬¾<br>â€¢<b>ä¼šå‘˜ç¦åˆ©</b>ï¼šæ—¥å¸¸ç”¨å“ä¼šå‘˜ä»·ï¼Œä¸“å±æŠ˜æ‰£</div>""",'æ­£é¤é«˜å³°':"""<divclass="insight-box"><b>ğŸ’¡æ­£é¤é«˜å³°åœºæ™¯ç­–ç•¥ï¼ˆ11-14ç‚¹&17-21ç‚¹ï¼‰</b><br><b>æ—¶æ®µè¦†ç›–</b>ï¼šåˆé«˜å³°(11-12ç‚¹)+æ­£åˆ(12-14ç‚¹)+æ™šé«˜å³°å‰(17-18ç‚¹)+å‚æ™š(18-21ç‚¹)<br><b>ç”¨æˆ·ç”»åƒ</b>ï¼šä¸Šç­æ—ã€å­¦ç”Ÿã€å®¶åº­èšé¤ã€åŠ ç­äººç¾¤<br><b>æ ¸å¿ƒå•†å“</b>ï¼šåŠæˆå“èœã€é€Ÿé£Ÿï¼ˆæ³¡é¢/è‡ªçƒ­é¥­ï¼‰ã€é¥®æ–™ã€é…’æ°´ã€è°ƒå‘³æ–™<br><b>è¡Œä¸ºç‰¹å¾</b>ï¼šé›†ä¸­ä¸‹å•ã€æ—¶é—´ç´§è¿«ã€å®¢å•ä»·é«˜ã€è¿½æ±‚ä¾¿åˆ©<br><b>è¿è¥ç­–ç•¥</b>ï¼š<br>â€¢<b>æ­£é¤å¥—é¤</b>ï¼šé€Ÿé£Ÿ+é¥®æ–™ã€åŠæˆå“+è°ƒæ–™ç»„åˆ<br>â€¢<b>é«˜å³°åŠ æ€¥</b>ï¼š11:30-12:30ä¼˜å…ˆé…é€ï¼Œä¿è¯ç”¨é¤æ—¶é—´<br>â€¢<b>æ™šé¤æ¨è</b>ï¼š17:30æ¨é€æ™šé¤æé†’+ä¼˜æƒ åˆ¸<br>â€¢<b>å®¶åº­è£…</b>ï¼š3-4äººä»½å¥—é¤ï¼Œæ€§ä»·æ¯”çªå‡º</div>""",'ä¼‘é—²å¨±ä¹':"""<divclass="insight-box"><b>ğŸ’¡ä¼‘é—²å¨±ä¹åœºæ™¯ç­–ç•¥ï¼ˆ14-17ç‚¹&21-24ç‚¹ï¼‰</b><br><b>ç”¨æˆ·ç”»åƒ</b>ï¼šè¿½å‰§å…šã€æ¸¸æˆç©å®¶ã€æœ‹å‹èšä¼šã€å±…å®¶ä¼‘é—²<br><b>æ ¸å¿ƒå•†å“</b>ï¼šè–¯ç‰‡ã€ç“œå­ã€å¯ä¹ã€å•¤é…’ã€å¤å‘³ã€æ°´æœã€å†°æ·‡æ·‹ã€å¥¶èŒ¶<br><b>è¡Œä¸ºç‰¹å¾</b>ï¼šå†²åŠ¨æ¶ˆè´¹ã€å“ç±»é›†ä¸­ã€ç¤¾äº¤å±æ€§å¼ºã€å¯¹ä»·æ ¼ä¸æ•æ„Ÿ<br><b>è¿è¥ç­–ç•¥</b>ï¼š<br>â€¢<b>åœºæ™¯å¥—é¤</b>ï¼šè¿½å‰§å¥—é¤ã€æ¸¸æˆå¥—é¤ã€èšä¼šå¥—é¤<br>â€¢<b>ä¹°èµ æ´»åŠ¨</b>ï¼šä¹°é¥®æ–™é€é›¶é£Ÿã€ä¹°2é€1<br>â€¢<b>ç½‘çº¢æ–°å“</b>ï¼šä¸»æ¨æ–°å¥‡ç‰¹é›¶é£Ÿï¼Œåˆºæ¿€å°é²œ<br>â€¢<b>ç¤¾äº¤åˆ†äº«</b>ï¼šæ‹¼å›¢ä¼˜æƒ ï¼Œå¤šäººä¸‹å•æ›´åˆ’ç®—</div>""",'æ·±å¤œåº”æ€¥':"""<divclass="insight-box"><b>ğŸ’¡æ·±å¤œåº”æ€¥åœºæ™¯ç­–ç•¥ï¼ˆ0-6ç‚¹ï¼‰</b><br><b>ç”¨æˆ·ç”»åƒ</b>ï¼šå¤œç­å·¥ä½œè€…ã€ç†¬å¤œå…šã€æ–°æ‰‹çˆ¶æ¯ã€å¤±çœ äººç¾¤<br><b>æ ¸å¿ƒå•†å“</b>ï¼šæ³¡é¢ã€çº¸å·¾ã€ç”µæ± ã€å©´å„¿ç”¨å“ã€åŠŸèƒ½é¥®æ–™ã€å¸¸å¤‡å°è¯<br><b>è¡Œä¸ºç‰¹å¾</b>ï¼šçªå‘éœ€æ±‚ã€ä»·æ ¼ä¸æ•æ„Ÿã€å“ç±»å•ä¸€ã€é€Ÿåº¦è¦æ±‚é«˜<br><b>è¿è¥ç­–ç•¥</b>ï¼š<br>â€¢<b>åº”æ€¥ä¼˜å…ˆ</b>ï¼š24å°æ—¶ä¿éšœæ ¸å¿ƒå“ç±»åº“å­˜<br>â€¢<b>æ·±å¤œåŠ ä»·</b>ï¼š22ç‚¹åé…é€è´¹+3-5å…ƒï¼ˆåº”æ€¥æº¢ä»·ï¼‰<br>â€¢<b>å“ç±»ç²¾ç®€</b>ï¼šåªä¿ç•™é«˜é¢‘åº”æ€¥å“ï¼Œå‡å°‘é€‰æ‹©å›°éš¾<br>â€¢<b>é€Ÿåº¦æ‰¿è¯º</b>ï¼šæ·±å¤œ30åˆ†é’Ÿè¾¾ï¼Œå»ºç«‹ä¿¡ä»»åº¦</div>"""}st.markdown(scene_strategy.get(scene_name,""),unsafe_allow_html=True)else:st.info(f"âš ï¸{scene_name}æš‚æ— æ•°æ®")st.markdown("---")#====================ğŸ¤–AIåœºæ™¯è¯†åˆ«æ¨¡å‹====================st.markdown("###ğŸ¤–AIåœºæ™¯è¯†åˆ«ä¸é¢„æµ‹")ifSCENE_INTELLIGENCE_AVAILABLE:withst.expander("ğŸ’¡åŸºäºXGBoostçš„åœºæ™¯è¯†åˆ«æ¨¡å‹",expanded=True):st.info("ğŸ“Šä½¿ç”¨æœºå™¨å­¦ä¹ ç®—æ³•è‡ªåŠ¨è¯†åˆ«è®¢å•åœºæ™¯ï¼Œé¢„æµ‹æœªæ¥è®¢å•çš„åœºæ™¯åˆ†å¸ƒ")col1,col2=st.columns([3,1])withcol2:ifst.button("ğŸš€è®­ç»ƒåœºæ™¯è¯†åˆ«æ¨¡å‹",key="train_scene_model"):withst.spinner("â³æ­£åœ¨è®­ç»ƒæ¨¡å‹..."):try:#æ•°æ®è¯Šæ–­ï¼šè®­ç»ƒå‰æ£€æŸ¥st.info(f"""ğŸ“Š**è®­ç»ƒæ•°æ®æ¦‚å†µ**ï¼š-æ€»è®¢å•æ•°ï¼š{len(df):,}-æ•°æ®åˆ—æ•°ï¼š{len(df.columns)}-æ˜¯å¦åŒ…å«'ä¸‹å•æ—¶é—´'ï¼š{'âœ…'if'ä¸‹å•æ—¶é—´'indf.columnselse'âŒ'}""")#å¦‚æœæœ‰ä¸‹å•æ—¶é—´ï¼Œæ˜¾ç¤ºæ—¶é—´èŒƒå›´if'ä¸‹å•æ—¶é—´'indf.columns:time_series=pd.to_datetime(df['ä¸‹å•æ—¶é—´'],errors='coerce')ifnottime_series.dropna().empty:min_time=time_series.min()max_time=time_series.max()days_span=(max_time-min_time).days+1hour_coverage=time_series.dt.hour.nunique()st.success(f"""â°**æ—¶é—´èŒƒå›´**ï¼š-èµ·å§‹ï¼š{min_time.strftime('%Y-%m-%d%H:%M')}-ç»“æŸï¼š{max_time.strftime('%Y-%m-%d%H:%M')}-è·¨åº¦ï¼š{days_span}å¤©-è¦†ç›–æ—¶æ®µï¼š{hour_coverage}/24å°æ—¶""")#åˆå§‹åŒ–æ¨¡å‹scene_model=SceneRecognitionModel()#è®­ç»ƒæ¨¡å‹-ä½¿ç”¨å…¨éƒ¨æ•°æ®è€Œéç­›é€‰åçš„æ•°æ®#æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨dfï¼ˆå…¨éƒ¨æ•°æ®ï¼‰è€Œä¸æ˜¯filtered_dfï¼ˆä»…æœ€è¿‘ä¸€ä¸ªå‘¨æœŸï¼‰train_result=scene_model.train(df)iftrain_result.get('status')=='success':#ä¿å­˜åˆ°session_stateï¼ˆåŒ…æ‹¬è®­ç»ƒæ•°æ®ç”¨äºè¯Šæ–­ï¼‰st.session_state['scene_model']=scene_modelst.session_state['scene_train_result']=train_resultst.session_state['scene_train_data']=df#ä¿å­˜å®Œæ•´çš„è®­ç»ƒæ•°æ®st.success(f"âœ…æ¨¡å‹è®­ç»ƒå®Œæˆï¼æµ‹è¯•å‡†ç¡®ç‡:{train_result['test_score']:.1%}")else:st.error(f"âŒè®­ç»ƒå¤±è´¥ï¼š{train_result.get('message')}")exceptExceptionase:st.error(f"âŒè®­ç»ƒè¿‡ç¨‹å‡ºé”™:{str(e)}")#å¦‚æœæ¨¡å‹å·²è®­ç»ƒï¼Œæ˜¾ç¤ºç»“æœif'scene_model'inst.session_stateand'scene_train_result'inst.session_state:scene_model=st.session_state['scene_model']train_result=st.session_state['scene_train_result']#åˆ›å»ºæ ‡ç­¾é¡µtab1,tab2,tab3=st.tabs(["ğŸ“Šæ¨¡å‹æ€§èƒ½","ğŸ¯åœºæ™¯é¢„æµ‹","ğŸ“ˆç‰¹å¾é‡è¦æ€§"])withtab1:st.markdown("####ğŸ“Šæ¨¡å‹æ€§èƒ½æŒ‡æ ‡")col1,col2,col3=st.columns(3)withcol1:st.metric("è®­ç»ƒé›†å‡†ç¡®ç‡",f"{train_result['train_score']:.1%}")withcol2:st.metric("æµ‹è¯•é›†å‡†ç¡®ç‡",f"{train_result['test_score']:.1%}")withcol3:overfitting=train_result['train_score']-train_result['test_score']st.metric("è¿‡æ‹Ÿåˆç¨‹åº¦",f"{overfitting:.1%}",delta="ä½"ifoverfitting<0.05else"éœ€å…³æ³¨",delta_color="inverse")#æ•°æ®è¯Šæ–­ï¼šæ—¶æ®µåˆ†å¸ƒåˆ†æst.markdown("**â°æ•°æ®æ—¶æ®µè¦†ç›–è¯Šæ–­**")#è·å–è®­ç»ƒæ—¶ä½¿ç”¨çš„æ•°æ®train_data=st.session_state.get('scene_train_data')iftrain_dataisnotNoneand'ä¸‹å•æ—¶é—´'intrain_data.columns:hour_dist=pd.to_datetime(train_data['ä¸‹å•æ—¶é—´'],errors='coerce').dt.hour.value_counts().sort_index()col_diag1,col_diag2=st.columns([2,1])withcol_diag1:#æ—¶æ®µåˆ†å¸ƒæŸ±çŠ¶å›¾fig_hour=px.bar(x=hour_dist.index,y=hour_dist.values,labels={'x':'å°æ—¶','y':'è®¢å•æ•°'},title='è®¢å•æ—¶æ®µåˆ†å¸ƒï¼ˆ0-23ç‚¹ï¼‰')fig_hour.update_layout(height=250)st.plotly_chart(fig_hour,use_container_width=True)withcol_diag2:total_hours_covered=len(hour_dist)main_hours=hour_dist.head(3).index.tolist()st.metric("è¦†ç›–æ—¶æ®µæ•°",f"{total_hours_covered}/24å°æ—¶")st.info(f"**ä¸»è¦æ—¶æ®µï¼š**{','.join([f'{h}æ—¶'forhinmain_hours])}")iftotal_hours_covered<12:st.warning(f"âš ï¸æ•°æ®ä»…è¦†ç›–{total_hours_covered}ä¸ªå°æ—¶ï¼Œåœºæ™¯è¯†åˆ«å¯èƒ½ä¸å¤Ÿä¸°å¯Œ")else:st.info("ğŸ’¡æ•°æ®è¯Šæ–­éœ€è¦åŒ…å«'ä¸‹å•æ—¶é—´'å­—æ®µ")st.markdown("---")#åœºæ™¯åˆ†å¸ƒst.markdown("**ğŸ­è®­ç»ƒæ•°æ®åœºæ™¯åˆ†å¸ƒ**")scene_dist=train_result.get('scene_distribution',{})ifscene_dist:dist_df=pd.DataFrame(list(scene_dist.items()),columns=['åœºæ™¯','è®¢å•æ•°'])dist_df['å æ¯”']=(dist_df['è®¢å•æ•°']/dist_df['è®¢å•æ•°'].sum()*100).round(1)#åœºæ™¯å¤šæ ·æ€§è¯Šæ–­scene_count=len(scene_dist)ifscene_count==1:st.error(f"ğŸš¨**æ•°æ®é—®é¢˜**ï¼šä»…è¯†åˆ«å‡º1ä¸ªåœºæ™¯ï¼ˆ{list(scene_dist.keys())[0]}ï¼‰")st.warning("""ğŸ’¡**å¯èƒ½çš„åŸå› ï¼š**1.**æ•°æ®æ—¶æ®µè¿‡äºé›†ä¸­**ï¼šæ‚¨çš„è®¢å•æ•°æ®å¯èƒ½éƒ½é›†ä¸­åœ¨æŸä¸ªç‰¹å®šæ—¶æ®µï¼ˆå¦‚éƒ½æ˜¯æ·±å¤œä¸‹å•ï¼‰2.**æ•°æ®é‡å¤ªå°‘**ï¼šæ ·æœ¬æ•°é‡ä¸è¶³ï¼Œæ— æ³•è¦†ç›–å¤šä¸ªåœºæ™¯3.**æ•°æ®æ—¶é—´èŒƒå›´å¤ªçª„**ï¼šåªæœ‰æŸä¸€å¤©æˆ–æŸå‡ ä¸ªå°æ—¶çš„æ•°æ®**è§£å†³æ–¹æ³•ï¼š**-ç¡®ä¿æ•°æ®åŒ…å«**æ—©ã€ä¸­ã€æ™š**ä¸åŒæ—¶æ®µçš„è®¢å•-æ‰©å¤§æ•°æ®æ—¶é—´èŒƒå›´ï¼ˆå»ºè®®è‡³å°‘7å¤©ä»¥ä¸Šï¼‰-æ£€æŸ¥ä¸Šæ–¹çš„"æ—¶æ®µè¦†ç›–è¯Šæ–­"ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦è¦†ç›–24å°æ—¶""")elifscene_count<3:st.warning(f"âš ï¸ä»…è¯†åˆ«å‡º{scene_count}ä¸ªåœºæ™¯ï¼Œå»ºè®®æ‰©å¤§æ•°æ®æ—¶é—´èŒƒå›´ä»¥è¦†ç›–æ›´å¤šåœºæ™¯ã€‚")col_scene1,col_scene2=st.columns([2,1])withcol_scene1:fig=px.pie(dist_df,values='è®¢å•æ•°',names='åœºæ™¯',title='åœºæ™¯åˆ†å¸ƒ')st.plotly_chart(fig,use_container_width=True)withcol_scene2:st.dataframe(dist_df,use_container_width=True,hide_index=True)#æ˜¾ç¤ºåœºæ™¯å®šä¹‰å‚è€ƒwithst.expander("ğŸ“–åœºæ™¯æ—¶æ®µå®šä¹‰"):st.markdown("""-**æ—©é¤åˆšéœ€**ï¼š6-8ç‚¹-**æ—¥å¸¸è¡¥ç»™**ï¼š9-11ç‚¹ã€14-17ç‚¹-**æ­£é¤é«˜å³°**ï¼š12-13ç‚¹ã€18-20ç‚¹-**ä¼‘é—²å¨±ä¹**ï¼š21-23ç‚¹-**æ·±å¤œåº”æ€¥**ï¼š0-5ç‚¹ğŸ’¡å¦‚æœæ‚¨çš„æ•°æ®åªè¦†ç›–æŸä¸ªæ—¶æ®µï¼Œåœºæ™¯è¯†åˆ«ä¼šç›¸åº”å—é™ã€‚""")withtab2:st.markdown("####ğŸ¯è®¢å•åœºæ™¯é¢„æµ‹")try:#é¢„æµ‹åœºæ™¯-ä½¿ç”¨å…¨éƒ¨æ•°æ®è¿›è¡Œé¢„æµ‹predictions=scene_model.predict_scene(df)#åœºæ™¯é¢„æµ‹ç»Ÿè®¡pred_dist=predictions['predicted_scene'].value_counts()col1,col2=st.columns([2,1])withcol1:fig=px.bar(x=pred_dist.values,y=pred_dist.index,orientation='h',title='é¢„æµ‹åœºæ™¯åˆ†å¸ƒ',labels={'x':'è®¢å•æ•°','y':'åœºæ™¯'},color=pred_dist.values,color_continuous_scale='Viridis')fig.update_layout(showlegend=False,height=400)st.plotly_chart(fig,use_container_width=True)withcol2:st.write("**ğŸ“Šåœºæ™¯é¢„æµ‹ç»Ÿè®¡**")forscene,countinpred_dist.items():pct=count/len(predictions)*100st.metric(scene,f"{count:,}å•",delta=f"{pct:.1f}%")#æ˜¾ç¤ºé¢„æµ‹æ ·ä¾‹st.markdown("**ğŸ”é¢„æµ‹ç»“æœæ ·ä¾‹ï¼ˆå‰10æ¡ï¼‰**")sample_pred=predictions.head(10)#æ˜¾ç¤ºæ¦‚ç‡æœ€é«˜çš„åœºæ™¯åŠå…¶æ¦‚ç‡prob_cols=[colforcolinsample_pred.columnsifcol.startswith('prob_')]ifprob_cols:display_cols=['è®¢å•ID','predicted_scene']+prob_colsst.dataframe(sample_pred[display_cols],use_container_width=True,hide_index=True)exceptExceptionase:st.error(f"âŒé¢„æµ‹å¤±è´¥:{str(e)}")withtab3:st.markdown("####ğŸ“ˆç‰¹å¾é‡è¦æ€§åˆ†æ")importance_fig=scene_model.visualize_feature_importance()st.plotly_chart(importance_fig,use_container_width=True)st.markdown("""**ç‰¹å¾è¯´æ˜ï¼š**-**hour**:ä¸‹å•å°æ—¶ï¼ˆ0-23ï¼‰-**weekday**:æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨ä¸€ï¼Œ6=å‘¨æ—¥ï¼‰-**é…é€è·ç¦»**:ç”¨æˆ·è·ç¦»é—¨åº—çš„è·ç¦»-**è®¢å•é‡‘é¢**:è®¢å•æ€»é‡‘é¢-**å¹³å‡å•ä»·**:å•†å“å¹³å‡å•ä»·-**å•†å“æ•°**:è®¢å•ä¸­çš„å•†å“ä»¶æ•°-**delivery_fee_ratio**:é…é€è´¹å è®¢å•é‡‘é¢çš„æ¯”ä¾‹""")else:st.warning("âš ï¸åœºæ™¯è¥é”€æ™ºèƒ½å†³ç­–å¼•æ“æœªåŠ è½½ï¼Œè¯·ç¡®ä¿å·²å®‰è£…xgboostæˆ–scikit-learn")st.markdown("---")#ä¼˜åŒ–åçš„è¥é”€å»ºè®®st.markdown("""<divclass="warning-box"><b>ğŸ¯ç²¾å‡†æ—¶æ®µè¥é”€ç­–ç•¥ï¼š</b><br><br><b>ğŸ“ˆé«˜å³°æ—¶æ®µç­–ç•¥ï¼š</b><br>â€¢<b>åˆé«˜å³°(11-12ç‚¹)</b>ï¼šæå‰æ¨é€åˆé¤å¥—é¤ï¼Œæ»¡å‡é—¨æ§›é€‚å½“æé«˜ï¼Œä¿éšœé…é€æ•ˆç‡<br>â€¢<b>æ™šé«˜å³°å‰(17-18ç‚¹)</b>ï¼šæ¨é€"æå‰è®¢æ™šé¤"ä¼˜æƒ ï¼Œç¼“è§£18ç‚¹åå‹åŠ›<br>â€¢<b>å‚æ™š(18-21ç‚¹)</b>ï¼šä¸»åŠ›æ—¶æ®µï¼Œå‡å°‘ä¿ƒé”€åŠ›åº¦ï¼Œé‡ç‚¹ä¿éšœæœåŠ¡è´¨é‡<br><br><b>ğŸ“‰ä½è°·æ—¶æ®µç­–ç•¥ï¼š</b><br>â€¢<b>æ¸…æ™¨(6-8ç‚¹)</b>ï¼šæ¨å‡º"æ—©é¤ä¸“äº«"æŠ˜æ‰£ï¼ŒåŸ¹å…»æ—©é¤å¤–å–ä¹ æƒ¯<br>â€¢<b>ä¸Šåˆ(9-11ç‚¹)</b>ï¼šæ¨é€"ä¸ŠåˆèŒ¶æ­‡"å¥—é¤ï¼Œæ—¥ç”¨å“ç±»æ»¡å‡åˆ¸<br>â€¢<b>ä¸‹åˆ(14-17ç‚¹)</b>ï¼šä¸‹åˆèŒ¶æ—¶æ®µï¼Œæ¨å‡º"ç¬¬äºŒä»¶åŠä»·"ã€ç”œå“é¥®å“ç»„åˆ<br><br><b>ğŸŒ™ç‰¹æ®Šæ—¶æ®µç­–ç•¥ï¼š</b><br>â€¢<b>æ™šé—´(21-24ç‚¹)</b>ï¼šå¤œå®µå“ç±»ä¸“é¡¹ä¿ƒé”€ï¼Œçƒ§çƒ¤ã€å°åƒã€å®µå¤œå¥—é¤<br>â€¢<b>æ·±å¤œ(0-3ç‚¹)</b>ï¼šåº”æ€¥åœºæ™¯ï¼Œæä¾›"æ·±å¤œæš–å¿ƒ"æœåŠ¡ï¼Œé€‚å½“åŠ æ”¶é…é€è´¹<br>â€¢<b>å‡Œæ™¨(3-6ç‚¹)</b>ï¼šæå°‘è®¢å•ï¼Œå¯æš‚åœé…é€æˆ–ä»…ä¿ç•™ä¾¿åˆ©åº—åˆä½œ<br><br><b>â°åŠ¨æ€æ¨é€ç­–ç•¥ï¼š</b><br>â€¢æå‰30åˆ†é’Ÿæ¨é€ä¸‹ä¸€æ—¶æ®µä¼˜æƒ åˆ¸ï¼ˆå¦‚10:30æ¨é€åˆé¤åˆ¸ï¼‰<br>â€¢é«˜å³°æ—¶æ®µå‰1å°æ—¶æ¨é€"é”™å³°ä¼˜æƒ "ï¼ˆå¦‚10ç‚¹æ¨é€11ç‚¹å‰ä¸‹å•ç«‹å‡ï¼‰<br>â€¢ç»“åˆå¤©æ°”ã€èŠ‚å‡æ—¥è°ƒæ•´æ—¶æ®µç­–ç•¥ï¼ˆé›¨å¤©å¢åŠ é…é€è´¹å‡å…ï¼‰</div>""",unsafe_allow_html=True)defrender_location_marketing(df:pd.DataFrame,time_dimension:str='æ—¥',selected_period:str=None):"""é—¨åº—å•†åœˆåœºæ™¯è¥é”€ï¼ˆæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦ï¼‰"""st.markdown('<pclass="sub-header">ğŸªé—¨åº—å•†åœˆåœºæ™¯åˆ†æ</p>',unsafe_allow_html=True)#====================åœºæ™¯è¥é”€ç†å¿µè¯´æ˜====================withst.expander("ğŸ’¡å•†åœˆåœºæ™¯çš„ç«äº‰æœ¬è´¨ï¼šé€Ÿåº¦ä¸ºç‹",expanded=False):st.markdown("""###âš¡é…é€é€Ÿåº¦=æ ¸å¿ƒç«äº‰åŠ›####ä¸ºä»€ä¹ˆé€Ÿåº¦è¿™ä¹ˆé‡è¦ï¼Ÿ1.**å³æ—¶éœ€æ±‚**ï¼šå¿˜è®°ä¹°çº¸å·¾ã€æ€¥éœ€é€€çƒ§è¯ã€ä¸´æ—¶æ¥å®¢äººâ†’15åˆ†é’Ÿå†…é€è¾¾2.**ç”Ÿé²œå“è´¨**ï¼šå†°æ·‡æ·‹ã€çƒ­é£Ÿã€å†·é“¾â†’è¶Šå¿«è¶Šæ–°é²œ3.**ç”¨æˆ·ä½“éªŒ**ï¼šç­‰å¾…æ—¶é—´æ¯å¢åŠ 5åˆ†é’Ÿï¼Œå¤è´­ç‡ä¸‹é™10%4.**ç«äº‰å£å’**ï¼šç¾å›¢ã€é¥¿äº†ä¹ˆã€ç›’é©¬ã€å®å’šä¹°èœéƒ½åœ¨æ‹¼é€Ÿåº¦####å¦‚ä½•åšåˆ°æ¯”ç«å¯¹æ›´å¿«ï¼Ÿ**1.å‰ç½®ä»“å¸ƒå±€ç­–ç•¥**-ğŸ¯**1å…¬é‡Œæ ¸å¿ƒåœˆ**ï¼šè®¢å•å¯†åº¦æœ€é«˜ï¼Œå¿…é¡»15åˆ†é’Ÿè¾¾-ğŸƒ**2-3å…¬é‡Œä¸»åŠ›åœˆ**ï¼š30åˆ†é’Ÿè¾¾ï¼Œè¦†ç›–å¤§éƒ¨åˆ†ç”¨æˆ·-ğŸš´**3-5å…¬é‡Œè¾¹ç¼˜åœˆ**ï¼š45åˆ†é’Ÿè¾¾ï¼Œè°¨æ…æ‹“å±•-âŒ**5å…¬é‡Œä»¥å¤–**ï¼šå»ºè®®æš‚åœæˆ–é«˜é¢é…é€è´¹**2.é…é€è´¹æˆæœ¬ä¼˜åŒ–**-ğŸ’°**è·ç¦»æˆæœ¬åˆ†æ**ï¼šæ¯å…¬é‡Œå¢åŠ å¤šå°‘é…é€æˆæœ¬ï¼Ÿ-ğŸ**å·®å¼‚åŒ–å®šä»·**ï¼š1å…¬é‡Œå†…å…è´¹ï¼Œ3å…¬é‡Œå¤–é€’å¢-ğŸ“¦**æ»¡å‡é—¨æ§›**ï¼šè¿œè·ç¦»æé«˜æ»¡å‡é‡‘é¢ï¼Œå¹³è¡¡æˆæœ¬**3.å•†åœˆåœºæ™¯åŒ–è¿è¥**-ğŸ¢**åŠå…¬åŒºå•†åœˆ**ï¼šåˆé¤é«˜å³°ï¼Œå›¢è´­ä¼˜å…ˆ-ğŸ **ä½å®…åŒºå•†åœˆ**ï¼šæ™šé¤å¤œå®µï¼Œå®¶åº­å¥—é¤-ğŸ«**å­¦æ ¡å•†åœˆ**ï¼šä¸‹åˆèŒ¶ã€å¤œå®µï¼Œå°ä»½ä¼˜æƒ -ğŸ¥**åŒ»é™¢å•†åœˆ**ï¼šåº”æ€¥åœºæ™¯ï¼Œé€Ÿåº¦ä¼˜å…ˆ---**ğŸ“Šæœ¬çœ‹æ¿æä¾›çš„å†³ç­–ä¾æ®**ï¼š-é…é€è·ç¦»åˆ†å¸ƒâ†’ç¡®å®šæ ¸å¿ƒæœåŠ¡åŠå¾„-é…é€è´¹æˆæœ¬åˆ†æâ†’ä¼˜åŒ–å®šä»·ç­–ç•¥-è·ç¦»æ®µå®¢å•ä»·â†’åˆ¶å®šå·®å¼‚åŒ–æ»¡å‡-é«˜ä»·å€¼å•†åœˆè¯†åˆ«â†’é‡ç‚¹èµ„æºå€¾æ–œ""")if'é…é€è·ç¦»'notindf.columns:st.warning("âš ï¸æ•°æ®ä¸­ç¼ºå°‘é…é€è·ç¦»å­—æ®µï¼Œæ— æ³•è¿›è¡Œå•†åœˆåˆ†æ")returndf=df.copy()df=extract_time_features(df)#æ˜ å°„ç»´åº¦åˆ°å­—æ®µådim_mapping={'æ—¥':'æ—¥æœŸ_datetime','å‘¨':'å¹´å‘¨','æœˆ':'å¹´æœˆ'}time_col=dim_mapping[time_dimension]#å°†é…é€è·ç¦»è½¬æ¢ä¸ºå…¬é‡Œï¼ˆå¦‚æœå•ä½æ˜¯ç±³ï¼‰#åˆ¤æ–­ï¼šå¦‚æœå¹³å‡è·ç¦»>100ï¼Œåˆ™è®¤ä¸ºå•ä½æ˜¯ç±³ï¼Œéœ€è¦è½¬æ¢ä¸ºå…¬é‡Œavg_distance=df['é…é€è·ç¦»'].mean()ifavg_distance>100:df['é…é€è·ç¦»_å…¬é‡Œ']=df['é…é€è·ç¦»']/1000st.info("ğŸ“æ£€æµ‹åˆ°é…é€è·ç¦»å•ä½ä¸ºç±³ï¼Œå·²è‡ªåŠ¨è½¬æ¢ä¸ºå…¬é‡Œ")else:df['é…é€è·ç¦»_å…¬é‡Œ']=df['é…é€è·ç¦»']#è®¡ç®—é…é€è´¹æˆæœ¬ï¼ˆè®¢å•çº§ï¼‰#é…é€æˆæœ¬=ç”¨æˆ·æ”¯ä»˜é…é€è´¹-é…é€è´¹å‡å…é‡‘é¢-ç‰©æµé…é€è´¹if'ç”¨æˆ·æ”¯ä»˜é…é€è´¹'indf.columnsand'é…é€è´¹å‡å…é‡‘é¢'indf.columnsand'ç‰©æµé…é€è´¹'indf.columns:df['é…é€è´¹æˆæœ¬']=(df['ç”¨æˆ·æ”¯ä»˜é…é€è´¹'].fillna(0)-df['é…é€è´¹å‡å…é‡‘é¢'].fillna(0)-df['ç‰©æµé…é€è´¹'].fillna(0))elif'ç‰©æµé…é€è´¹'indf.columns:#å¦‚æœç¼ºå°‘æŸäº›å­—æ®µï¼Œç®€åŒ–è®¡ç®—df['é…é€è´¹æˆæœ¬']=-df['ç‰©æµé…é€è´¹'].fillna(0)st.info("âš ï¸éƒ¨åˆ†é…é€è´¹å­—æ®µç¼ºå¤±ï¼Œé…é€æˆæœ¬ä»…åŸºäºç‰©æµé…é€è´¹è®¡ç®—")else:df['é…é€è´¹æˆæœ¬']=0st.warning("âš ï¸ç¼ºå°‘é…é€è´¹ç›¸å…³å­—æ®µï¼Œé…é€æˆæœ¬æ— æ³•è®¡ç®—")#====================æ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆï¼ˆå¸¦ç¯æ¯”ï¼‰====================st.markdown(f"###ğŸ“ˆæ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆï¼ˆæŒ‰{time_dimension}ï¼‰")iftime_colindf.columnsand'è®¢å•ID'indf.columns:try:#å¤„ç†é‡å¤åˆ—åtemp_df=df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]ifisinstance(temp_df['é…é€è·ç¦»_å…¬é‡Œ'],pd.DataFrame):temp_df['é…é€è·ç¦»_å…¬é‡Œ']=temp_df['é…é€è·ç¦»_å…¬é‡Œ'].iloc[:,0]#æŒ‰è®¢å•çº§èšåˆï¼ˆé¿å…æ˜ç»†çº§é‡å¤è®¡ç®—ï¼‰agg_config={'é…é€è·ç¦»_å…¬é‡Œ':'first','æ”¶è´§åœ°å€':'first','é…é€è´¹æˆæœ¬':'first'}#åŠ¨æ€æ·»åŠ å¯é€‰å­—æ®µforcolin['ç‰©æµé…é€è´¹','ç”¨æˆ·æ”¯ä»˜é…é€è´¹','é…é€è´¹å‡å…é‡‘é¢']:ifcolintemp_df.columns:ifisinstance(temp_df[col],pd.DataFrame):temp_df[col]=temp_df[col].iloc[:,0]agg_config[col]='first'order_summary=temp_df.groupby(['è®¢å•ID',time_col]).agg(agg_config).reset_index()#æŒ‰æ—¶é—´ç»´åº¦èšåˆagg_dict={'è®¢å•ID':'nunique','é…é€è·ç¦»_å…¬é‡Œ':'mean','æ”¶è´§åœ°å€':'nunique','é…é€è´¹æˆæœ¬':'sum'}if'ç‰©æµé…é€è´¹'inorder_summary.columns:agg_dict['ç‰©æµé…é€è´¹']='sum'if'ç”¨æˆ·æ”¯ä»˜é…é€è´¹'inorder_summary.columns:agg_dict['ç”¨æˆ·æ”¯ä»˜é…é€è´¹']='sum'if'é…é€è´¹å‡å…é‡‘é¢'inorder_summary.columns:agg_dict['é…é€è´¹å‡å…é‡‘é¢']='sum'time_agg=order_summary.groupby(time_col).agg(agg_dict).reset_index()time_agg.columns=[time_col,'è®¢å•æ•°','å¹³å‡é…é€è·ç¦»','è¦†ç›–åœ°å€æ•°','é…é€è´¹æˆæœ¬']+\(['ç‰©æµé…é€è´¹']if'ç‰©æµé…é€è´¹'inagg_dictelse[])+\(['ç”¨æˆ·æ”¯ä»˜é…é€è´¹']if'ç”¨æˆ·æ”¯ä»˜é…é€è´¹'inagg_dictelse[])+\(['é…é€è´¹å‡å…é‡‘é¢']if'é…é€è´¹å‡å…é‡‘é¢'inagg_dictelse[])#è®¡ç®—å¹³å‡é…é€è´¹æˆæœ¬time_agg['å¹³å‡é…é€è´¹æˆæœ¬']=time_agg['é…é€è´¹æˆæœ¬']/time_agg['è®¢å•æ•°']exceptExceptionase:st.error(f"è®¡ç®—æ ¸å¿ƒæŒ‡æ ‡æ—¶å‡ºé”™:{str(e)}")time_agg=Noneelse:time_agg=Noneiftime_aggisnotNone:time_agg=calculate_period_over_period(time_agg,time_dimension,'è®¢å•æ•°')time_agg=calculate_period_over_period(time_agg,time_dimension,'å¹³å‡é…é€è·ç¦»')time_agg=calculate_period_over_period(time_agg,time_dimension,'è¦†ç›–åœ°å€æ•°')time_agg=calculate_period_over_period(time_agg,time_dimension,'é…é€è´¹æˆæœ¬')time_agg=calculate_period_over_period(time_agg,time_dimension,'å¹³å‡é…é€è´¹æˆæœ¬')#è·å–å½“å‰æœŸå’Œä¸Šä¸€æœŸæ•°æ®ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©æˆ–æœ€è¿‘ä¸€æœŸï¼‰iflen(time_agg)>=1:#å¦‚æœç”¨æˆ·é€‰æ‹©äº†å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨é€‰æ‹©çš„å‘¨æœŸï¼›å¦åˆ™ä½¿ç”¨æœ€è¿‘ä¸€æœŸifselected_periodandnotselected_period.startswith("å…¨éƒ¨"):iftime_dimension=="æ—¥":selected_date=pd.to_datetime(selected_period)latest_idx=time_agg[time_agg[time_col]==selected_date].indexelse:latest_idx=time_agg[time_agg[time_col]==selected_period].indexiflen(latest_idx)>0:latest=time_agg.loc[latest_idx[0]]#è·å–ä¸Šä¸€æœŸæ•°æ®current_position=latest_idx[0]previous=time_agg.iloc[current_position-1]ifcurrent_position>0elseNoneelse:latest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNoneelse:#æœªé€‰æ‹©å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨æœ€è¿‘ä¸€æœŸlatest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNone#ç¬¬ä¸€è¡ŒæŒ‡æ ‡å¡ç‰‡col1,col2,col3,col4=st.columns(4)#å½“å‰å‘¨æœŸwithcol1:period_label=format_period_label(latest[time_col],time_dimension)st.metric(label=f"å½“å‰{time_dimension}",value=period_label)#è®¢å•æ•°ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col2,f"è®¢å•æ•°",latest['è®¢å•æ•°'],previous['è®¢å•æ•°']ifpreviousisnotNoneelseNone,format_type='number',unit='å•')#å¹³å‡é…é€è·ç¦»ï¼ˆå¸¦ç¯æ¯”ï¼‰withcol3:current_dist=latest['å¹³å‡é…é€è·ç¦»']previous_dist=previous['å¹³å‡é…é€è·ç¦»']ifpreviousisnotNoneelseNoneifprevious_distisnotNoneandnotpd.isna(previous_dist)andprevious_dist!=0:change_rate=((current_dist-previous_dist)/previous_dist*100)st.metric(label="å¹³å‡é…é€è·ç¦»",value=f"{current_dist:.2f}å…¬é‡Œ",delta=f"{change_rate:+.2f}%",delta_color="inverse"#è·ç¦»å¢åŠ æ˜¾ç¤ºä¸ºçº¢è‰²ï¼ˆä¸å¥½ï¼‰)else:st.metric(label="å¹³å‡é…é€è·ç¦»",value=f"{current_dist:.2f}å…¬é‡Œ")#è¦†ç›–åœ°å€æ•°ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col4,f"è¦†ç›–åœ°å€æ•°",latest['è¦†ç›–åœ°å€æ•°'],previous['è¦†ç›–åœ°å€æ•°']ifpreviousisnotNoneelseNone,format_type='number',unit='ä¸ª')#ç¬¬äºŒè¡Œï¼šé…é€è´¹æˆæœ¬åˆ†æst.markdown("####ğŸ’°é…é€è´¹æˆæœ¬åˆ†æ")col5,col6,col7,col8=st.columns(4)#é…é€è´¹æˆæœ¬ï¼ˆå¸¦ç¯æ¯”ï¼‰withcol5:current_cost=latest['é…é€è´¹æˆæœ¬']previous_cost=previous['é…é€è´¹æˆæœ¬']ifpreviousisnotNoneelseNoneifprevious_costisnotNoneandnotpd.isna(previous_cost)andprevious_cost!=0:change_rate=((current_cost-previous_cost)/abs(previous_cost)*100)st.metric(label="é…é€è´¹æˆæœ¬",value=f"Â¥{current_cost:,.2f}",delta=f"{change_rate:+.2f}%",delta_color="inverse",#æˆæœ¬å¢åŠ æ˜¾ç¤ºä¸ºçº¢è‰²help="é…é€æˆæœ¬=ç”¨æˆ·æ”¯ä»˜é…é€è´¹-é…é€è´¹å‡å…-ç‰©æµé…é€è´¹")else:st.metric(label="é…é€è´¹æˆæœ¬",value=f"Â¥{current_cost:,.2f}",help="é…é€æˆæœ¬=ç”¨æˆ·æ”¯ä»˜é…é€è´¹-é…é€è´¹å‡å…-ç‰©æµé…é€è´¹")#å¹³å‡é…é€è´¹æˆæœ¬ï¼ˆå¸¦ç¯æ¯”ï¼‰withcol6:current_avg_cost=latest['å¹³å‡é…é€è´¹æˆæœ¬']previous_avg_cost=previous['å¹³å‡é…é€è´¹æˆæœ¬']ifpreviousisnotNoneelseNoneifprevious_avg_costisnotNoneandnotpd.isna(previous_avg_cost)andprevious_avg_cost!=0:change_rate=((current_avg_cost-previous_avg_cost)/abs(previous_avg_cost)*100)st.metric(label="å•å‡é…é€æˆæœ¬",value=f"Â¥{current_avg_cost:.2f}",delta=f"{change_rate:+.2f}%",delta_color="inverse",help="é…é€è´¹æˆæœ¬/è®¢å•æ•°")else:st.metric(label="å•å‡é…é€æˆæœ¬",value=f"Â¥{current_avg_cost:.2f}",help="é…é€è´¹æˆæœ¬/è®¢å•æ•°")#ç‰©æµé…é€è´¹ï¼ˆå¦‚æœæœ‰ï¼‰if'ç‰©æµé…é€è´¹'inlatest.index:withcol7:current_logistics=latest['ç‰©æµé…é€è´¹']previous_logistics=previous['ç‰©æµé…é€è´¹']ifpreviousisnotNoneand'ç‰©æµé…é€è´¹'inprevious.indexelseNoneifprevious_logisticsisnotNoneandnotpd.isna(previous_logistics)andprevious_logistics!=0:change_rate=((current_logistics-previous_logistics)/previous_logistics*100)st.metric(label="ç‰©æµé…é€è´¹",value=f"Â¥{current_logistics:,.2f}",delta=f"{change_rate:+.2f}%",delta_color="inverse",help="æ”¯ä»˜ç»™é…é€å¹³å°çš„è´¹ç”¨")else:st.metric(label="ç‰©æµé…é€è´¹",value=f"Â¥{current_logistics:,.2f}",help="æ”¯ä»˜ç»™é…é€å¹³å°çš„è´¹ç”¨")#é…é€è´¹å‡å…ï¼ˆå¦‚æœæœ‰ï¼‰if'é…é€è´¹å‡å…é‡‘é¢'inlatest.index:withcol8:current_discount=latest['é…é€è´¹å‡å…é‡‘é¢']previous_discount=previous['é…é€è´¹å‡å…é‡‘é¢']ifpreviousisnotNoneand'é…é€è´¹å‡å…é‡‘é¢'inprevious.indexelseNoneifprevious_discountisnotNoneandnotpd.isna(previous_discount)andprevious_discount!=0:change_rate=((current_discount-previous_discount)/previous_discount*100)st.metric(label="é…é€è´¹å‡å…",value=f"Â¥{current_discount:,.2f}",delta=f"{change_rate:+.2f}%",help="ç»™ç”¨æˆ·çš„é…é€è´¹ä¼˜æƒ ï¼ˆå·²åœ¨é…é€æˆæœ¬ä¸­æŠµæ‰£ï¼‰")else:st.metric(label="é…é€è´¹å‡å…",value=f"Â¥{current_discount:,.2f}",help="ç»™ç”¨æˆ·çš„é…é€è´¹ä¼˜æƒ ï¼ˆå·²åœ¨é…é€æˆæœ¬ä¸­æŠµæ‰£ï¼‰")st.markdown("---")#====================è¶‹åŠ¿å›¾====================st.markdown(f"###ğŸ“Š{time_dimension}åº¦è¶‹åŠ¿åˆ†æ")tab1,tab2,tab3,tab4=st.tabs(["è®¢å•é‡è¶‹åŠ¿","å¹³å‡é…é€è·ç¦»è¶‹åŠ¿","è¦†ç›–åœ°å€æ•°è¶‹åŠ¿","é…é€è´¹æˆæœ¬è¶‹åŠ¿"])withtab1:fig=px.line(time_agg,x=time_col,y='è®¢å•æ•°',title=f'è®¢å•æ•°{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#3498db',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)withtab2:fig=px.line(time_agg,x=time_col,y='å¹³å‡é…é€è·ç¦»',title=f'å¹³å‡é…é€è·ç¦»{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#e67e22',width=3))fig.update_layout(height=400,yaxis_title='å¹³å‡é…é€è·ç¦»(å…¬é‡Œ)')st.plotly_chart(fig,use_container_width=True)#ç¯æ¯”å˜åŒ–è¡¨æ ¼if'å¹³å‡é…é€è·ç¦»_ç¯æ¯”ç‡'intime_agg.columns:st.write("**ç¯æ¯”å˜åŒ–è¯¦æƒ…**")display_df=time_agg[[time_col,'å¹³å‡é…é€è·ç¦»','å¹³å‡é…é€è·ç¦»_ä¸ŠæœŸå€¼','å¹³å‡é…é€è·ç¦»_ç¯æ¯”å˜åŒ–','å¹³å‡é…é€è·ç¦»_ç¯æ¯”ç‡']].tail(10)display_df.columns=['æ—¶é—´å‘¨æœŸ','å½“å‰å¹³å‡è·ç¦»','ä¸ŠæœŸå¹³å‡è·ç¦»','ç¯æ¯”å˜åŒ–(km)','ç¯æ¯”å˜åŒ–ç‡(%)']st.dataframe(display_df.style.format({'å½“å‰å¹³å‡è·ç¦»':'{:.2f}å…¬é‡Œ','ä¸ŠæœŸå¹³å‡è·ç¦»':'{:.2f}å…¬é‡Œ','ç¯æ¯”å˜åŒ–(km)':'{:+.2f}','ç¯æ¯”å˜åŒ–ç‡(%)':'{:+.2f}%'}),use_container_width=True)withtab3:fig=px.line(time_agg,x=time_col,y='è¦†ç›–åœ°å€æ•°',title=f'è¦†ç›–åœ°å€æ•°{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#27ae60',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)withtab4:#é…é€è´¹æˆæœ¬è¶‹åŠ¿å›¾fig=px.line(time_agg,x=time_col,y='é…é€è´¹æˆæœ¬',title=f'é…é€è´¹æˆæœ¬{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#e74c3c',width=3))fig.update_layout(height=400,yaxis_title='é…é€è´¹æˆæœ¬(å…ƒ)')st.plotly_chart(fig,use_container_width=True)#å¹³å‡é…é€è´¹æˆæœ¬è¶‹åŠ¿å›¾fig2=px.line(time_agg,x=time_col,y='å¹³å‡é…é€è´¹æˆæœ¬',title=f'å•å‡é…é€æˆæœ¬{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig2.update_traces(line=dict(color='#9b59b6',width=3))fig2.update_layout(height=400,yaxis_title='å•å‡é…é€æˆæœ¬(å…ƒ)')st.plotly_chart(fig2,use_container_width=True)#ç¯æ¯”å˜åŒ–è¡¨æ ¼if'é…é€è´¹æˆæœ¬_ç¯æ¯”ç‡'intime_agg.columns:st.write("**é…é€è´¹æˆæœ¬ç¯æ¯”è¯¦æƒ…**")display_df=time_agg[[time_col,'é…é€è´¹æˆæœ¬','é…é€è´¹æˆæœ¬_ä¸ŠæœŸå€¼','é…é€è´¹æˆæœ¬_ç¯æ¯”å˜åŒ–','é…é€è´¹æˆæœ¬_ç¯æ¯”ç‡']].tail(10)display_df.columns=['æ—¶é—´å‘¨æœŸ','å½“å‰æˆæœ¬','ä¸ŠæœŸæˆæœ¬','ç¯æ¯”å˜åŒ–(å…ƒ)','ç¯æ¯”å˜åŒ–ç‡(%)']st.dataframe(display_df.style.format({'å½“å‰æˆæœ¬':'Â¥{:,.2f}','ä¸ŠæœŸæˆæœ¬':'Â¥{:,.2f}','ç¯æ¯”å˜åŒ–(å…ƒ)':'Â¥{:+,.2f}','ç¯æ¯”å˜åŒ–ç‡(%)':'{:+.2f}%'}),use_container_width=True)#é…é€è´¹æˆæœ¬æ„æˆåˆ†æï¼ˆå¦‚æœæœ‰è¯¦ç»†å­—æ®µï¼‰ifall(colintime_agg.columnsforcolin['ç‰©æµé…é€è´¹','ç”¨æˆ·æ”¯ä»˜é…é€è´¹','é…é€è´¹å‡å…é‡‘é¢']):st.write("**é…é€è´¹æˆæœ¬æ„æˆåˆ†æï¼ˆæœ€è¿‘ä¸€æœŸï¼‰**")latest_data=time_agg.iloc[-1]col_a,col_b,col_c=st.columns(3)withcol_a:st.metric("ç‰©æµé…é€è´¹æ”¯å‡º",f"Â¥{latest_data['ç‰©æµé…é€è´¹']:,.2f}",help="æ”¯ä»˜ç»™é…é€å¹³å°")withcol_b:st.metric("ç”¨æˆ·æ”¯ä»˜é…é€è´¹",f"Â¥{latest_data['ç”¨æˆ·æ”¯ä»˜é…é€è´¹']:,.2f}",help="ç”¨æˆ·æ‰¿æ‹…éƒ¨åˆ†")withcol_c:st.metric("é…é€è´¹å‡å…",f"Â¥{latest_data['é…é€è´¹å‡å…é‡‘é¢']:,.2f}",help="ä¼˜æƒ ç»™ç”¨æˆ·")st.markdown(f"""<divclass="insight-box"><b>ğŸ’¡é…é€è´¹æˆæœ¬è®¡ç®—å…¬å¼ï¼š</b><br>é…é€è´¹æˆæœ¬=ç”¨æˆ·æ”¯ä»˜(Â¥{latest_data['ç”¨æˆ·æ”¯ä»˜é…é€è´¹']:,.2f})-é…é€è´¹å‡å…(Â¥{latest_data['é…é€è´¹å‡å…é‡‘é¢']:,.2f})-ç‰©æµé…é€è´¹(Â¥{latest_data['ç‰©æµé…é€è´¹']:,.2f})=<b>Â¥{latest_data['é…é€è´¹æˆæœ¬']:,.2f}</b></div>""",unsafe_allow_html=True)st.markdown("---")#====================é…é€è·ç¦»åˆ†å¸ƒï¼ˆæ ¹æ®é€‰å®šçš„æ—¶é—´ç»´åº¦ç­›é€‰æœ€è¿‘ä¸€æœŸï¼‰====================st.markdown(f"###ğŸ“é…é€è·ç¦»åˆ†å¸ƒåˆ†æï¼ˆå½“å‰{time_dimension}æ•°æ®ï¼‰")#ç­›é€‰æœ€è¿‘ä¸€ä¸ªå‘¨æœŸçš„æ•°æ®filtered_df=filter_data_by_time_dimension(df,time_dimension,selected_period,latest_only=True)iflen(filtered_df)==0:st.warning(f"âš ï¸å½“å‰{time_dimension}æš‚æ— æ•°æ®")return#æ˜¾ç¤ºå½“å‰åˆ†æçš„æ—¶é—´èŒƒå›´iftime_colinfiltered_df.columns:current_period=filtered_df[time_col].iloc[0]period_label=format_period_label(current_period,time_dimension)st.info(f"ğŸ“…å½“å‰åˆ†ææ—¶é—´ï¼š{period_label}")defget_distance_range(distance_km):ifpd.isna(distance_km):return'æœªçŸ¥'elifdistance_km<1:return'1å…¬é‡Œä»¥ä¸‹'elifdistance_km<2:return'1-2å…¬é‡Œ'elifdistance_km<3:return'2-3å…¬é‡Œ'elifdistance_km<4:return'3-4å…¬é‡Œ'elifdistance_km<5:return'4-5å…¬é‡Œ'else:return'5å…¬é‡Œä»¥ä¸Š'filtered_df['è·ç¦»åˆ†å±‚']=filtered_df['é…é€è·ç¦»_å…¬é‡Œ'].apply(get_distance_range)distance_order=['1å…¬é‡Œä»¥ä¸‹','1-2å…¬é‡Œ','2-3å…¬é‡Œ','3-4å…¬é‡Œ','4-5å…¬é‡Œ','5å…¬é‡Œä»¥ä¸Š','æœªçŸ¥']col1,col2=st.columns(2)withcol1:st.write("**ğŸ“é…é€è·ç¦»åˆ†å¸ƒ**")distance_orders=filtered_df.groupby('è·ç¦»åˆ†å±‚')['è®¢å•ID'].nunique()distance_orders=distance_orders.reindex(distance_order,fill_value=0)#æ’é™¤"æœªçŸ¥"ç±»åˆ«ç”¨äºå›¾è¡¨æ˜¾ç¤ºdistance_orders_valid=distance_orders[distance_orders.index!='æœªçŸ¥']fig=px.pie(values=distance_orders_valid.values,names=distance_orders_valid.index,title=f'è®¢å•é…é€è·ç¦»åˆ†å¸ƒï¼ˆ{period_label}ï¼‰',hole=0.4)fig.update_traces(textposition='inside',textinfo='percent+label')st.plotly_chart(fig,use_container_width=True)#è®¡ç®—æ€»è®¢å•æ•°ï¼ˆæ’é™¤æœªçŸ¥ï¼‰total_orders_valid=distance_orders_valid.sum()total_orders=filtered_df['è®¢å•ID'].nunique()unknown_count=distance_orders.get('æœªçŸ¥',0)ifunknown_count>0:st.caption(f"â„¹ï¸æœ‰{unknown_count}å•è®¢å•ç¼ºå°‘é…é€è·ç¦»æ•°æ®ï¼ˆå·²ä»å›¾è¡¨ä¸­æ’é™¤ï¼‰")main_ratio=(distance_orders['1å…¬é‡Œä»¥ä¸‹']+distance_orders['1-2å…¬é‡Œ']+distance_orders['2-3å…¬é‡Œ'])/total_orders_valid*100st.markdown(f"""<divclass="insight-box"><b>ğŸ’¡å…³é”®æ´å¯Ÿï¼š</b><br>â€¢ä¸»è¦æœåŠ¡åŠå¾„ï¼š<b>3å…¬é‡Œä»¥å†…</b>å æ¯”{main_ratio:.1f}%<br>â€¢1å…¬é‡Œä»¥ä¸‹ï¼š<b>{distance_orders['1å…¬é‡Œä»¥ä¸‹']}</b>å•ï¼ˆæ ¸å¿ƒåŒºåŸŸï¼‰<br>â€¢1-2å…¬é‡Œï¼š<b>{distance_orders['1-2å…¬é‡Œ']}</b>å•ï¼ˆä¸»åŠ›åŒºåŸŸï¼‰<br>â€¢å»ºè®®ï¼š3kmå†…åŒºåŸŸä¸ºæ ¸å¿ƒå•†åœˆï¼Œé‡ç‚¹å¸ƒå±€</div>""",unsafe_allow_html=True)withcol2:st.write("**ğŸ’°è·ç¦»æ®µå®¢å•ä»·å¯¹æ¯”**")try:#å¤„ç†é‡å¤åˆ—åtemp_df=filtered_df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]ifisinstance(temp_df['å•†å“å®å”®ä»·'],pd.DataFrame):temp_df['å•†å“å®å”®ä»·']=temp_df['å•†å“å®å”®ä»·'].iloc[:,0]distance_price=temp_df.groupby(['è·ç¦»åˆ†å±‚','è®¢å•ID'])['å•†å“å®å”®ä»·'].sum().groupby('è·ç¦»åˆ†å±‚').mean()distance_price=distance_price.reindex(distance_order,fill_value=0)#æ’é™¤"æœªçŸ¥"ç±»åˆ«ç”¨äºå›¾è¡¨æ˜¾ç¤ºdistance_price_valid=distance_price[distance_price.index!='æœªçŸ¥']fig=px.bar(x=distance_price_valid.index,y=distance_price_valid.values,labels={'x':'é…é€è·ç¦»','y':'å¹³å‡å®¢å•ä»·(å…ƒ)'},title=f'å„è·ç¦»æ®µå¹³å‡å®¢å•ä»·ï¼ˆ{period_label}ï¼‰',color=distance_price_valid.values,color_continuous_scale='Greens')fig.update_layout(showlegend=False)st.plotly_chart(fig,use_container_width=True)exceptExceptionase:st.error(f"è®¡ç®—è·ç¦»æ®µå®¢å•ä»·æ—¶å‡ºé”™:{str(e)}")#è®¡ç®—è·ç¦»æ®µçš„é…é€è´¹æˆæœ¬ï¼ˆæŒ‰è®¢å•çº§èšåˆï¼‰if'é…é€è´¹æˆæœ¬'infiltered_df.columns:try:#å¤„ç†é‡å¤åˆ—åtemp_df=filtered_df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]ifisinstance(temp_df['é…é€è´¹æˆæœ¬'],pd.DataFrame):temp_df['é…é€è´¹æˆæœ¬']=temp_df['é…é€è´¹æˆæœ¬'].iloc[:,0]order_delivery_cost=temp_df.groupby(['è®¢å•ID','è·ç¦»åˆ†å±‚'])['é…é€è´¹æˆæœ¬'].first().groupby('è·ç¦»åˆ†å±‚').mean()order_delivery_cost=order_delivery_cost.reindex(distance_order,fill_value=0)st.write("**ğŸššè·ç¦»æ®µé…é€è´¹æˆæœ¬åˆ†æ**")col_a,col_b=st.columns(2)withcol_a:#é…é€è´¹æˆæœ¬æŒ‰è·ç¦»æ®µå¯¹æ¯”cost_valid=order_delivery_cost[order_delivery_cost.index!='æœªçŸ¥']fig=px.bar(x=cost_valid.index,y=cost_valid.values,labels={'x':'é…é€è·ç¦»','y':'å•å‡é…é€æˆæœ¬(å…ƒ)'},title=f'å„è·ç¦»æ®µå•å‡é…é€è´¹æˆæœ¬ï¼ˆ{period_label}ï¼‰',color=cost_valid.values,color_continuous_scale='Reds')fig.update_layout(showlegend=False)st.plotly_chart(fig,use_container_width=True)withcol_b:#è·ç¦»ä¸æˆæœ¬å…³ç³»æ´å¯Ÿmax_cost_range=cost_valid.idxmax()ifnotcost_valid.emptyelseNonemin_cost_range=cost_valid.idxmin()ifnotcost_valid.emptyelseNonest.markdown(f"""<divclass="insight-box"><b>ğŸ’¡é…é€è´¹æˆæœ¬æ´å¯Ÿï¼š</b><br>â€¢æœ€é«˜æˆæœ¬è·ç¦»æ®µï¼š<b>{max_cost_range}</b>ï¼ˆÂ¥{cost_valid.get(max_cost_range,0):.2f}/å•ï¼‰<br>â€¢æœ€ä½æˆæœ¬è·ç¦»æ®µï¼š<b>{min_cost_range}</b>ï¼ˆÂ¥{cost_valid.get(min_cost_range,0):.2f}/å•ï¼‰<br>â€¢æˆæœ¬å·®å¼‚ï¼šÂ¥{abs(cost_valid.get(max_cost_range,0)-cost_valid.get(min_cost_range,0)):.2f}/å•<br>â€¢å»ºè®®ï¼šä¼˜åŒ–è¿œè·ç¦»è®¢å•é…é€ç­–ç•¥ï¼Œé™ä½é…é€æˆæœ¬</div>""",unsafe_allow_html=True)#é…é€è´¹æˆæœ¬å å®¢å•ä»·æ¯”ä¾‹iflen(distance_price_valid)>0andlen(cost_valid)>0:st.write("**é…é€æˆæœ¬å å®¢å•ä»·æ¯”ä¾‹**")fordistincost_valid.index:ifdistindistance_price_valid.index:price=distance_price_valid[dist]cost=cost_valid[dist]ratio=(abs(cost)/price*100)ifprice>0else0st.progress(min(ratio/20,1.0),text=f"{dist}:{ratio:.2f}%")exceptExceptionase:st.error(f"è®¡ç®—é…é€è´¹æˆæœ¬åˆ†ææ—¶å‡ºé”™:{str(e)}")order_delivery_cost=pd.Series(dtype=float)#ç©ºSeriesä½œä¸ºåå¤‡else:#å¦‚æœæ²¡æœ‰é…é€è´¹æˆæœ¬åˆ—ï¼Œåˆå§‹åŒ–ä¸ºç©ºSeriesorder_delivery_cost=pd.Series(dtype=float)#æ·»åŠ è¯¦ç»†æ•°æ®è¡¨æ ¼st.write(f"**ğŸ“‹é…é€è·ç¦»è¯¦ç»†æ•°æ®ï¼ˆ{period_label}ï¼‰**")distance_detail=[]fordist_rangeindistance_order:ifdist_range=='æœªçŸ¥':continuecount=distance_orders.get(dist_range,0)ratio=(count/total_orders_valid*100)iftotal_orders_valid>0else0avg_price=distance_price.get(dist_range,0)detail_row={'è·ç¦»èŒƒå›´':dist_range,'è®¢å•æ•°':f'{count:,}','å æ¯”':f'{ratio:.1f}%','å¹³å‡å®¢å•ä»·':f'Â¥{avg_price:.2f}'}#å¦‚æœæœ‰é…é€è´¹æˆæœ¬æ•°æ®ï¼Œæ·»åŠ åˆ°è¡¨æ ¼iflen(order_delivery_cost)>0:avg_cost=order_delivery_cost.get(dist_range,0)detail_row['å•å‡é…é€æˆæœ¬']=f'Â¥{avg_cost:.2f}'cost_ratio=(abs(avg_cost)/avg_price*100)ifavg_price>0else0detail_row['æˆæœ¬å æ¯”']=f'{cost_ratio:.2f}%'distance_detail.append(detail_row)detail_df=pd.DataFrame(distance_detail)st.dataframe(detail_df,use_container_width=True,hide_index=True)st.markdown("""<divclass="warning-box"><b>ğŸ¯å•†åœˆè¥é”€å»ºè®®ï¼š</b><br>1.<b>1å…¬é‡Œä»¥ä¸‹ï¼ˆæ ¸å¿ƒåŒºï¼‰</b>ï¼šå¸¸å®¢åŒºåŸŸï¼Œæ¨VIPä¼šå‘˜ï¼Œæé«˜å¤è´­ç‡<br>2.<b>1-2å…¬é‡Œï¼ˆä¸»åŠ›åŒºï¼‰</b>ï¼šè®¢å•é‡æœ€å¤§ï¼Œè®¾ç½®"æ»¡Xå…é…é€è´¹"å¸å¼•è®¢å•<br>3.<b>2-3å…¬é‡Œï¼ˆæ¬¡ä¸»åŠ›åŒºï¼‰</b>ï¼šä»æœ‰æ½œåŠ›ï¼Œå¯é€‚å½“æé«˜æ»¡å‡é—¨æ§›<br>4.<b>3-5å…¬é‡Œï¼ˆè¾¹ç¼˜åŒºï¼‰</b>ï¼šæé«˜æœ€ä½æ¶ˆè´¹ï¼Œæˆ–ä¸ç¤¾åŒºå›¢è´­åˆä½œ<br>5.<b>5å…¬é‡Œä»¥ä¸Šï¼ˆè¿œè·ç¦»ï¼‰</b>ï¼šå»ºè®®æš‚åœé…é€æˆ–æ”¶å–é«˜é¢é…é€è´¹</div>""",unsafe_allow_html=True)defrender_price_sensitivity_marketing(df:pd.DataFrame,time_dimension:str='æ—¥',selected_period:str=None):"""ä»·æ ¼æ•æ„Ÿåº¦è¥é”€ï¼ˆæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦ï¼‰"""st.markdown('<pclass="sub-header">ğŸ’°ä»·æ ¼æ•æ„Ÿåº¦åœºæ™¯åˆ†æ</p>',unsafe_allow_html=True)#====================åœºæ™¯è¥é”€ç†å¿µè¯´æ˜====================withst.expander("ğŸ’¡ä»·æ ¼åœºæ™¯ï¼šä¸åŒäººç¾¤çš„ä¸åŒéœ€æ±‚",expanded=False):st.markdown("""###ğŸ¯ä»·æ ¼æ•æ„Ÿåº¦çš„åœºæ™¯æœ¬è´¨####è°åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹å¯¹ä»·æ ¼æ•æ„Ÿï¼Ÿ**1.é«˜ä»·å€¼ç”¨æˆ·ï¼ˆä½ä»·æ ¼æ•æ„Ÿï¼‰**-**åœºæ™¯**ï¼šåº”æ€¥ã€å“è´¨éœ€æ±‚ã€æ—¶é—´ç´§è¿«-**ç‰¹å¾**ï¼šå®¢å•ä»·é«˜ã€å¤è´­ç‡é«˜ã€å¯¹ä¼˜æƒ ä¸æ•æ„Ÿ-**ç­–ç•¥**ï¼šä¼šå‘˜åˆ¶ã€å“è´¨ä¿éšœã€å¿«é€Ÿé…é€ã€ç§¯åˆ†æƒç›Š-**ä¸¾ä¾‹**ï¼šå·¥ä½œæ—¥åˆé¤ã€å©´å„¿ç”¨å“ã€è¿›å£é£Ÿå“**2.ä»·æ ¼æ•æ„Ÿç”¨æˆ·ï¼ˆé«˜ä»·æ ¼æ•æ„Ÿï¼‰**-**åœºæ™¯**ï¼šæ—¥å¸¸é‡‡è´­ã€æå‰è®¡åˆ’ã€éç´§æ€¥-**ç‰¹å¾**ï¼šå®¢å•ä»·ä½ã€æ¯”ä»·å¤šã€ä¼˜æƒ é©±åŠ¨-**ç­–ç•¥**ï¼šæ»¡å‡ã€å›¢è´­ã€ç§’æ€ã€ä¼˜æƒ åˆ¸-**ä¸¾ä¾‹**ï¼šå‘¨æœ«å›¤è´§ã€ç”Ÿé²œç‰¹ä»·ã€æ¸…ä»“ä¿ƒé”€**3.ä¸­é—´ç”¨æˆ·ï¼ˆå¹³è¡¡å‹ï¼‰**-**åœºæ™¯**ï¼šå¸¸è§„éœ€æ±‚ã€å“è´¨ä¸ä»·æ ¼å¹¶é‡-**ç‰¹å¾**ï¼šå®¢å•ä»·ä¸­ç­‰ã€ç¨³å®šå¤è´­-**ç­–ç•¥**ï¼šå¥—é¤ç»„åˆã€ä¼šå‘˜æŠ˜æ‰£ã€å“ç±»æ¨è-**ä¸¾ä¾‹**ï¼šå·¥ä½œæ—¥æ™šé¤ã€æ—¥ç”¨å“è¡¥è´§####åœºæ™¯åŒ–å®šä»·ç­–ç•¥**æ—¶æ®µÃ—ä»·æ ¼åœºæ™¯**-â°**é«˜å³°æ—¶æ®µ**ï¼ˆåˆé¤ã€æ™šé¤ï¼‰ï¼šå‡å°‘æŠ˜æ‰£ï¼Œä¿éšœæœåŠ¡-ğŸŒ™**ä½è°·æ—¶æ®µ**ï¼ˆä¸Šåˆã€ä¸‹åˆèŒ¶ï¼‰ï¼šæ»¡å‡ã€ç¬¬äºŒä»¶åŠä»·-ğŸŒƒ**æ·±å¤œæ—¶æ®µ**ï¼šæº¢ä»·é…é€ï¼Œåº”æ€¥éœ€æ±‚ä¸æ•æ„Ÿ**è·ç¦»Ã—ä»·æ ¼åœºæ™¯**-ğŸ“**è¿‘è·ç¦»**ï¼ˆ1kmå†…ï¼‰ï¼šå…é…é€è´¹ï¼ŒåŸ¹å…»é«˜é¢‘-ğŸš´**ä¸­è·ç¦»**ï¼ˆ2-3kmï¼‰ï¼šé€‚åº¦æ»¡å‡ï¼Œå¹³è¡¡æˆæœ¬-ğŸš—**è¿œè·ç¦»**ï¼ˆ3km+ï¼‰ï¼šæé«˜é—¨æ§›ï¼Œè¦†ç›–æˆæœ¬**å“ç±»Ã—ä»·æ ¼åœºæ™¯**-ğŸ**ç”Ÿé²œå“ç±»**ï¼šå¼•æµå“ï¼Œä½æ¯›åˆ©é«˜é¢‘-ğŸº**é¥®æ–™é›¶é£Ÿ**ï¼šåˆ©æ¶¦å“ï¼Œæ­å”®ç»„åˆ-ğŸ **æ—¥ç”¨ç™¾è´§**ï¼šç¨³å®šå“ï¼Œä¼šå‘˜ä¸“äº«---**ğŸ’¼æœ¬çœ‹æ¿çš„æ ¸å¿ƒä»·å€¼**ï¼š-è¯†åˆ«ä¸åŒä»·æ ¼æ®µçš„ç”¨æˆ·è¡Œä¸º-åˆ¶å®šå·®å¼‚åŒ–å®šä»·ç­–ç•¥-å¹³è¡¡é”€é‡ä¸åˆ©æ¶¦-æå‡æ•´ä½“å®¢å•ä»·""")df=extract_time_features(df)#æ˜ å°„ç»´åº¦åˆ°å­—æ®µådim_mapping={'æ—¥':'æ—¥æœŸ_datetime','å‘¨':'å¹´å‘¨','æœˆ':'å¹´æœˆ'}time_col=dim_mapping[time_dimension]#====================æ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆï¼ˆå¸¦ç¯æ¯”ï¼‰====================st.markdown(f"###ğŸ“ˆæ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆï¼ˆæŒ‰{time_dimension}ï¼‰")iftime_colindf.columnsand'è®¢å•ID'indf.columns:try:#å¤„ç†é‡å¤åˆ—åtemp_df=df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]ifisinstance(temp_df['å•†å“å®å”®ä»·'],pd.DataFrame):temp_df['å•†å“å®å”®ä»·']=temp_df['å•†å“å®å”®ä»·'].iloc[:,0]#æŒ‰æ—¶é—´ç»´åº¦èšåˆè®¢å•çº§æ•°æ®order_level=temp_df.groupby(['è®¢å•ID',time_col]).agg({'å•†å“å®å”®ä»·':'sum'}).reset_index()order_level.columns=['è®¢å•ID',time_col,'å®¢å•ä»·']#æŒ‰æ—¶é—´ç»´åº¦èšåˆtime_agg=order_level.groupby(time_col).agg({'è®¢å•ID':'count','å®¢å•ä»·':'mean'}).reset_index()time_agg.columns=[time_col,'è®¢å•æ•°','å¹³å‡å®¢å•ä»·']#è®¡ç®—ç¯æ¯”time_agg=calculate_period_over_period(time_agg,time_dimension,'è®¢å•æ•°')time_agg=calculate_period_over_period(time_agg,time_dimension,'å¹³å‡å®¢å•ä»·')exceptExceptionase:st.error(f"è®¡ç®—æ ¸å¿ƒæŒ‡æ ‡æ—¶å‡ºé”™:{str(e)}")time_agg=Noneelse:time_agg=Noneiftime_aggisnotNone:#è·å–å½“å‰æœŸå’Œä¸Šä¸€æœŸæ•°æ®ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©æˆ–æœ€è¿‘ä¸€æœŸï¼‰iflen(time_agg)>=1:#å¦‚æœç”¨æˆ·é€‰æ‹©äº†å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨é€‰æ‹©çš„å‘¨æœŸï¼›å¦åˆ™ä½¿ç”¨æœ€è¿‘ä¸€æœŸifselected_periodandnotselected_period.startswith("å…¨éƒ¨"):iftime_dimension=="æ—¥":selected_date=pd.to_datetime(selected_period)latest_idx=time_agg[time_agg[time_col]==selected_date].indexelse:latest_idx=time_agg[time_agg[time_col]==selected_period].indexiflen(latest_idx)>0:latest=time_agg.loc[latest_idx[0]]#è·å–ä¸Šä¸€æœŸæ•°æ®current_position=latest_idx[0]previous=time_agg.iloc[current_position-1]ifcurrent_position>0elseNoneelse:latest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNoneelse:#æœªé€‰æ‹©å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨æœ€è¿‘ä¸€æœŸlatest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNonecol1,col2,col3=st.columns(3)#å½“å‰å‘¨æœŸwithcol1:period_label=format_period_label(latest[time_col],time_dimension)st.metric(label=f"å½“å‰{time_dimension}",value=period_label)#è®¢å•æ•°ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col2,f"è®¢å•æ•°",latest['è®¢å•æ•°'],previous['è®¢å•æ•°']ifpreviousisnotNoneelseNone,format_type='number',unit='å•')#å¹³å‡å®¢å•ä»·ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col3,f"å¹³å‡å®¢å•ä»·",latest['å¹³å‡å®¢å•ä»·'],previous['å¹³å‡å®¢å•ä»·']ifpreviousisnotNoneelseNone,format_type='currency')st.markdown("---")#====================è¶‹åŠ¿å›¾====================st.markdown(f"###ğŸ“Š{time_dimension}åº¦è¶‹åŠ¿åˆ†æ")tab1,tab2=st.tabs(["å®¢å•ä»·è¶‹åŠ¿","è®¢å•é‡è¶‹åŠ¿"])withtab1:fig=px.line(time_agg,x=time_col,y='å¹³å‡å®¢å•ä»·',title=f'å¹³å‡å®¢å•ä»·{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#e74c3c',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)#ç¯æ¯”å˜åŒ–è¡¨æ ¼if'å¹³å‡å®¢å•ä»·_ç¯æ¯”ç‡'intime_agg.columns:st.write("**ç¯æ¯”å˜åŒ–è¯¦æƒ…**")display_df=time_agg[[time_col,'å¹³å‡å®¢å•ä»·','å¹³å‡å®¢å•ä»·_ä¸ŠæœŸå€¼','å¹³å‡å®¢å•ä»·_ç¯æ¯”å˜åŒ–','å¹³å‡å®¢å•ä»·_ç¯æ¯”ç‡']].tail(10)display_df.columns=['æ—¶é—´å‘¨æœŸ','å½“å‰å®¢å•ä»·','ä¸ŠæœŸå®¢å•ä»·','ç¯æ¯”å˜åŒ–é¢','ç¯æ¯”å˜åŒ–ç‡(%)']st.dataframe(display_df.style.format({'å½“å‰å®¢å•ä»·':'Â¥{:,.2f}','ä¸ŠæœŸå®¢å•ä»·':'Â¥{:,.2f}','ç¯æ¯”å˜åŒ–é¢':'Â¥{:+,.2f}','ç¯æ¯”å˜åŒ–ç‡(%)':'{:+.2f}%'}),use_container_width=True)withtab2:fig=px.line(time_agg,x=time_col,y='è®¢å•æ•°',title=f'è®¢å•æ•°{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#3498db',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)st.markdown("---")#====================ä»·æ ¼æ•æ„Ÿåº¦åˆ†å±‚ï¼ˆæ ¹æ®é€‰å®šçš„æ—¶é—´ç»´åº¦ç­›é€‰æœ€è¿‘ä¸€æœŸï¼‰====================st.markdown(f"###ğŸ’°å®¢å•ä»·åˆ†å±‚åˆ†æï¼ˆå½“å‰{time_dimension}æ•°æ®ï¼‰")#ç­›é€‰æœ€è¿‘ä¸€ä¸ªå‘¨æœŸçš„æ•°æ®filtered_df=filter_data_by_time_dimension(df,time_dimension,selected_period,latest_only=True)iflen(filtered_df)==0:st.warning(f"âš ï¸å½“å‰{time_dimension}æš‚æ— æ•°æ®")return#æ˜¾ç¤ºå½“å‰åˆ†æçš„æ—¶é—´èŒƒå›´iftime_colinfiltered_df.columns:current_period=filtered_df[time_col].iloc[0]period_label=format_period_label(current_period,time_dimension)st.info(f"ğŸ“…å½“å‰åˆ†ææ—¶é—´ï¼š{period_label}")order_prices=filtered_df.groupby('è®¢å•ID')['å•†å“å®å”®ä»·'].sum()defget_price_range(price):ifprice<20:return'ä½ä»·(<20å…ƒ)'elifprice<40:return'ä¸­ä½(20-40å…ƒ)'elifprice<60:return'ä¸­é«˜(40-60å…ƒ)'else:return'é«˜ä»·(â‰¥60å…ƒ)'price_segments=order_prices.apply(get_price_range)price_range_order=['ä½ä»·(<20å…ƒ)','ä¸­ä½(20-40å…ƒ)','ä¸­é«˜(40-60å…ƒ)','é«˜ä»·(â‰¥60å…ƒ)']col1,col2=st.columns(2)withcol1:st.write("**ğŸ“Šå®¢å•ä»·åˆ†å±‚ç”¨æˆ·åˆ†å¸ƒ**")price_dist=price_segments.value_counts().reindex(price_range_order,fill_value=0)fig=px.bar(x=price_dist.index,y=price_dist.values,labels={'x':'å®¢å•ä»·åŒºé—´','y':'è®¢å•æ•°'},title=f'å®¢å•ä»·åˆ†å¸ƒï¼ˆ{period_label}ï¼‰',color=price_dist.values,color_continuous_scale='Greens')fig.update_layout(showlegend=False)st.plotly_chart(fig,use_container_width=True)main_segment=price_dist.idxmax()main_ratio=price_dist.max()/price_dist.sum()*100st.markdown(f"""<divclass="insight-box"><b>ğŸ’¡å®¢ç¾¤æ´å¯Ÿï¼š</b><br>â€¢ä¸»è¦å®¢ç¾¤ï¼š<b>{main_segment}</b>ï¼ˆ{main_ratio:.1f}%ï¼‰<br>â€¢å¹³å‡å®¢å•ä»·ï¼šÂ¥{order_prices.mean():.2f}<br>â€¢å®¢å•ä»·ä¸­ä½æ•°ï¼šÂ¥{order_prices.median():.2f}</div>""",unsafe_allow_html=True)withcol2:st.write("**ğŸæ»¡å‡é—¨æ§›è¾¾æˆåˆ†æ**")manjian_thresholds=[20,30,40,50,60,80]threshold_reach=[]forthresholdinmanjian_thresholds:reach_orders=(order_prices>=threshold).sum()reach_ratio=reach_orders/len(order_prices)*100threshold_reach.append({'é—¨æ§›':f'{threshold}å…ƒ','è¾¾æ ‡ç‡':reach_ratio})threshold_df=pd.DataFrame(threshold_reach)fig=px.line(threshold_df,x='é—¨æ§›',y='è¾¾æ ‡ç‡',title=f'æ»¡å‡é—¨æ§›è¾¾æ ‡ç‡ï¼ˆ{period_label}ï¼‰',markers=True)fig.update_traces(line_color='#e74c3c',marker=dict(size=10))fig.update_layout(yaxis_title='è¾¾æ ‡ç‡(%)')st.plotly_chart(fig,use_container_width=True)#æ‰¾åˆ°60-80%ä¹‹é—´çš„é—¨æ§›optimal=Noneforiteminthreshold_reach:if60<=item['è¾¾æ ‡ç‡']<=80:optimal=item['é—¨æ§›']breakifoptimal:st.markdown(f"""<divclass="insight-box"><b>ğŸ’¡æœ€ä¼˜æ»¡å‡å»ºè®®ï¼š</b><br>â€¢å»ºè®®è®¾ç½®æ»¡å‡é—¨æ§›ï¼š<b>æ»¡{optimal}</b><br>â€¢ç†ç”±ï¼šè¾¾æ ‡ç‡åœ¨60-80%ä¹‹é—´ï¼Œå¹³è¡¡åˆºæ¿€ä¸è¡¥è´´</div>""",unsafe_allow_html=True)st.markdown("""<divclass="warning-box"><b>ğŸ¯ä»·æ ¼è¥é”€å»ºè®®ï¼š</b><br>1.<b>ä½ä»·å®¢ç¾¤</b>ï¼šæ¨é€å°é¢åˆ¸ï¼ˆ5-8å…ƒï¼‰ï¼ŒåŸ¹å…»æ¶ˆè´¹ä¹ æƒ¯<br>2.<b>ä¸­ä»·å®¢ç¾¤</b>ï¼šæ»¡å‡æ´»åŠ¨ä¸ºä¸»ï¼Œæå‡å®¢å•ä»·<br>3.<b>é«˜ä»·å®¢ç¾¤</b>ï¼šå‡å°‘ä¿ƒé”€ï¼Œæä¾›ä¼˜è´¨æœåŠ¡å’Œä¼šå‘˜æƒç›Š<br>4.<b>åŠ¨æ€å®šä»·</b>ï¼šé«˜å³°æ—¶æ®µå‡å°‘æŠ˜æ‰£ï¼Œä½å³°æ—¶æ®µåŠ å¤§åŠ›åº¦</div>""",unsafe_allow_html=True)#====================ğŸ¤–RFMå®¢æˆ·åˆ†ç¾¤åˆ†æ====================st.markdown("---")st.markdown("###ğŸ¤–RFMå®¢æˆ·åˆ†ç¾¤ä¸ç”»åƒ")ifSCENE_INTELLIGENCE_AVAILABLE:withst.expander("ğŸ’¡åŸºäºRFM+K-Meansçš„å®¢æˆ·åˆ†ç¾¤",expanded=True):st.info("ğŸ“Šç»“åˆRFMæ¨¡å‹ä¸èšç±»ç®—æ³•ï¼Œè¯†åˆ«é«˜é¢‘åº”æ€¥ã€è®¡åˆ’å›¤è´§ã€ä»·æ ¼æ•æ„Ÿã€å¶å‘å°é²œå››ç±»ç”¨æˆ·")col1,col2=st.columns([3,1])withcol2:ifst.button("ğŸš€è¿è¡Œå®¢æˆ·åˆ†ç¾¤",key="run_rfm_clustering"):withst.spinner("â³æ­£åœ¨è®¡ç®—RFMç‰¹å¾å¹¶èšç±»..."):try:#åˆå§‹åŒ–åˆ†ç¾¤æ¨¡å‹rfm_model=RFMCustomerSegmentation(n_clusters=4)#è®¡ç®—RFMrfm_data=rfm_model.calculate_rfm(filtered_df)#æ‰§è¡Œèšç±»segment_result=rfm_model.segment_customers()ifsegment_result.get('status')=='success':#ä¿å­˜åˆ°session_statest.session_state['rfm_model']=rfm_modelst.session_state['rfm_result']=segment_resultst.success(f"âœ…åˆ†ç¾¤å®Œæˆï¼è¯†åˆ«{segment_result['n_clusters']}ä¸ªå®¢æˆ·ç¾¤ç»„")else:st.error(f"âŒåˆ†ç¾¤å¤±è´¥ï¼š{segment_result.get('message')}")exceptExceptionase:st.error(f"âŒåˆ†ç¾¤è¿‡ç¨‹å‡ºé”™:{str(e)}")importtracebackst.code(traceback.format_exc())#å¦‚æœåˆ†ç¾¤å·²å®Œæˆï¼Œæ˜¾ç¤ºç»“æœif'rfm_model'inst.session_stateand'rfm_result'inst.session_state:rfm_model=st.session_state['rfm_model']segment_result=st.session_state['rfm_result']#åˆ›å»ºæ ‡ç­¾é¡µtab1,tab2,tab3=st.tabs(["ğŸ‘¥å®¢æˆ·ç¾¤ç»„","ğŸ“Š3Då¯è§†åŒ–","ğŸ“‹ç­–ç•¥å»ºè®®"])withtab1:st.markdown("####ğŸ‘¥å®¢æˆ·ç¾¤ç»„ç”»åƒ")#åˆ†ç¾¤è´¨é‡æŒ‡æ ‡col1,col2,col3=st.columns(3)withcol1:st.metric("å®¢æˆ·ç¾¤ç»„æ•°",segment_result['n_clusters'])withcol2:st.metric("è½®å»“ç³»æ•°",f"{segment_result['silhouette_score']:.3f}",help="è½®å»“ç³»æ•°è¶Šæ¥è¿‘1ï¼Œåˆ†ç¾¤è´¨é‡è¶Šå¥½")withcol3:total_customers=sum(segment_result['distribution'].values())st.metric("æ€»å®¢æˆ·æ•°",f"{total_customers:,}")#ç¾¤ç»„æ‘˜è¦è¡¨st.markdown("**ğŸ“Šå„å®¢æˆ·ç¾¤ç»„ç‰¹å¾**")summary_df=rfm_model.get_cluster_summary()st.dataframe(summary_df,use_container_width=True,hide_index=True)#ç¾¤ç»„åˆ†å¸ƒé¥¼å›¾st.markdown("**ğŸ“ˆå®¢æˆ·ç¾¤ç»„åˆ†å¸ƒ**")dist_df=pd.DataFrame(list(segment_result['distribution'].items()),columns=['ç¾¤ç»„ID','ç”¨æˆ·æ•°'])dist_df['ç¾¤ç»„åç§°']=dist_df['ç¾¤ç»„ID'].map(lambdax:segment_result['cluster_profiles'][x]['name'])fig=px.pie(dist_df,values='ç”¨æˆ·æ•°',names='ç¾¤ç»„åç§°',title='å®¢æˆ·ç¾¤ç»„å æ¯”')st.plotly_chart(fig,use_container_width=True)withtab2:st.markdown("####ğŸ“ŠRFM3Då¯è§†åŒ–")st.caption("*Xè½´=æœ€è¿‘è´­ä¹°å¤©æ•°ï¼ŒYè½´=è´­ä¹°é¢‘æ¬¡ï¼ŒZè½´=è´­ä¹°é‡‘é¢*")cluster_3d_fig=rfm_model.visualize_clusters()st.plotly_chart(cluster_3d_fig,use_container_width=True)st.markdown("""**ç»´åº¦è¯´æ˜ï¼š**-**Recencyï¼ˆæœ€è¿‘è´­ä¹°ï¼‰**:è·ç¦»ä¸Šæ¬¡è´­ä¹°çš„å¤©æ•°ï¼Œè¶Šå°è¶Šæ´»è·ƒ-**Frequencyï¼ˆè´­ä¹°é¢‘æ¬¡ï¼‰**:æ€»è´­ä¹°æ¬¡æ•°ï¼Œè¶Šå¤šè¶Šå¿ è¯š-**Monetaryï¼ˆè´­ä¹°é‡‘é¢ï¼‰**:ç´¯è®¡æ¶ˆè´¹é‡‘é¢ï¼Œè¶Šé«˜è¶Šæœ‰ä»·å€¼-**AvgDistanceï¼ˆå¹³å‡è·ç¦»ï¼‰**:å¹³å‡é…é€è·ç¦»ï¼Œåæ˜ ä¾¿åˆ©æ€§éœ€æ±‚-**AvgFeeRatioï¼ˆé…é€è´¹å æ¯”ï¼‰**:é…é€è´¹å è®¢å•é‡‘é¢æ¯”ä¾‹ï¼Œåæ˜ åº”æ€¥ç¨‹åº¦""")withtab3:st.markdown("####ğŸ“‹å·®å¼‚åŒ–è¥é”€ç­–ç•¥")forcluster_id,profileinsegment_result['cluster_profiles'].items():withst.container():st.markdown(f"###{profile['name']}")col1,col2=st.columns([1,2])withcol1:st.metric("ç”¨æˆ·æ•°",f"{profile['size']:,}")st.metric("å æ¯”",f"{profile['percentage']:.1f}%")#è·å–æ•°æ®å‘¨æœŸå’ŒåŸå§‹è®¢å•æ•°data_days=int(profile.get('data_span_days',30))avg_total_orders=profile.get('avg_total_orders',profile['avg_frequency'])#æ˜¾ç¤ºå‘¨æœŸå†…è®¢å•æ•°ï¼ˆæ›´ç›´è§‚ï¼‰st.metric(f"{data_days}å¤©å†…è®¢å•",f"{avg_total_orders:.1f}å•",help=f"è¯¥ç¾¤ç»„ç”¨æˆ·åœ¨{data_days}å¤©å†…å¹³å‡ä¸‹å•æ¬¡æ•°")#æ˜¾ç¤ºæ ‡å‡†åŒ–é¢‘æ¬¡ï¼ˆç”¨äºèšç±»ï¼‰st.metric("è´­ä¹°é¢‘æ¬¡",f"{profile['avg_frequency']:.2f}æ¬¡/å‘¨",help="æ ‡å‡†åŒ–åçš„æ¯å‘¨å¹³å‡è®¢å•æ•°ï¼Œç”¨äºä¸åŒå‘¨æœŸæ•°æ®å¯¹æ¯”")st.metric("å¹³å‡æ¶ˆè´¹",f"Â¥{profile['avg_monetary']:.0f}")withcol2:st.markdown(f"""<divclass="insight-box"><b>ï¿½ç¾¤ç»„å®šä¹‰ï¼š</b><br>{profile.get('definition','æš‚æ— å®šä¹‰')}<br><br><b>ğŸ“Šå…³é”®ç‰¹å¾ï¼ˆç¾¤ç»„å¹³å‡å€¼ï¼‰ï¼š</b><br>â€¢å¹³å‡æœ€è¿‘è´­ä¹°:{profile['avg_recency']:.0f}å¤©å‰<br>â€¢å¹³å‡é…é€è·ç¦»:{profile['avg_distance']:.1f}km<br>â€¢å¹³å‡é…é€è´¹å æ¯”:{profile['avg_fee_ratio']*100:.1f}%<br>â€¢å¹³å‡å•†å“æ•°:{profile.get('avg_items_per_order',0):.1f}ä»¶/å•<br>â€¢å¹³å‡å“ç±»æ•°:{profile.get('avg_categories_per_order',0):.1f}ç§/å•<br><br><b>ğŸ¯è¥é”€ç­–ç•¥ï¼š</b><br>{profile['strategy']}</div>""",unsafe_allow_html=True)st.markdown("---")else:st.warning("âš ï¸åœºæ™¯è¥é”€æ™ºèƒ½å†³ç­–å¼•æ“æœªåŠ è½½ï¼Œè¯·ç¡®ä¿å·²å®‰è£…scikit-learn")defrender_product_combination_marketing(df:pd.DataFrame,time_dimension:str='æ—¥',selected_period:str=None):"""å•†å“ç»„åˆåœºæ™¯è¥é”€ï¼ˆæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦ï¼‰"""st.markdown('<pclass="sub-header">ğŸ“¦å•†å“ç»„åˆåœºæ™¯åˆ†æ</p>',unsafe_allow_html=True)#====================åœºæ™¯è¥é”€ç†å¿µè¯´æ˜====================withst.expander("ğŸ’¡å•†å“ç»„åˆï¼šå¿«æ¶ˆé›¶å”®çš„åœºæ™¯åŒ–éœ€æ±‚æ»¡è¶³",expanded=False):st.markdown("""###ğŸ¯å¿«æ¶ˆé›¶å”®å•†å“ç»„åˆçš„åœºæ™¯é€»è¾‘####ä¸ºä»€ä¹ˆè¦åšå•†å“ç»„åˆï¼Ÿ**1.åœºæ™¯å®Œæ•´æ€§**-âŒ**å•å“æ€ç»´**ï¼šç”¨æˆ·ä¹°è–¯ç‰‡ï¼Œè¿˜å¾—å•ç‹¬ä¹°å¯ä¹-âœ…**åœºæ™¯æ€ç»´**ï¼šç›´æ¥æ¨"è¿½å‰§å¥—é¤"ï¼ˆè–¯ç‰‡+å¯ä¹+ç“œå­ï¼‰ï¼Œä¸€é”®ä¸‹å•**2.é™ä½å†³ç­–æˆæœ¬**-ç”¨æˆ·ä¸ç”¨æ€è€ƒ"è¿˜éœ€è¦ä»€ä¹ˆ"-ç³»ç»Ÿæ™ºèƒ½æ¨è"ä¹°è¿™ä¸ªçš„äººè¿˜ä¹°äº†..."-å‡å°‘è´­ç‰©è½¦å¼ƒå•ç‡**3.æå‡å®¢å•ä»·**-å•å“è´­ä¹°ï¼šå¹³å‡25å…ƒ-ç»„åˆè´­ä¹°ï¼šå¹³å‡40å…ƒï¼ˆæå‡60%ï¼‰-äº¤å‰é”€å”®ï¼šå¸¦åŠ¨ä½é¢‘å“ç±»####å¿«æ¶ˆé›¶å”®çš„åœºæ™¯åŒ–å•†å“ç»„åˆç­–ç•¥**ğŸ¿è¿½å‰§æ”¾æ¾åœºæ™¯ç»„åˆ**```æ ¸å¿ƒåœºæ™¯ï¼šæ™šé—´åœ¨å®¶è¿½å‰§ã€æ”¾æ¾å¨±ä¹å…¸å‹ç»„åˆï¼š-åŸºç¡€å¥—é¤ï¼šè–¯ç‰‡+å¯ä¹+çº¸å·¾ï¼ˆÂ¥18ï¼‰-å‡çº§å¥—é¤ï¼šè†¨åŒ–é£Ÿå“+é¥®æ–™+åšæœ+æ°´æœï¼ˆÂ¥35ï¼‰-åˆ†äº«å¥—é¤ï¼šå¤§åŒ…è£…é›¶é£Ÿ+2å‡è£…é¥®æ–™ï¼ˆÂ¥45ï¼‰å…³è”æ¨èï¼šä¹°è–¯ç‰‡â†’æ¨èå¯ä¹ã€é¥®æ–™```**ğŸ®æ¸¸æˆèšä¼šåœºæ™¯ç»„åˆ**```æ ¸å¿ƒåœºæ™¯ï¼šæœ‹å‹èšä¼šã€æ¸¸æˆå¨±ä¹å…¸å‹ç»„åˆï¼š-èšä¼šå¥—é¤ï¼šå•¤é…’+å¤å‘³+èŠ±ç”Ÿ+è–¯ç‰‡ï¼ˆÂ¥68ï¼‰-æ¸¸æˆå¥—é¤ï¼šé¥®æ–™+é›¶é£Ÿ+æ°´æœæ‹¼ç›˜ï¼ˆÂ¥45ï¼‰-å¤œå®µå¥—é¤ï¼šçƒ¤è‚ +é¸­è„–+å•¤é…’ï¼ˆÂ¥55ï¼‰å…³è”æ¨èï¼šä¹°å•¤é…’â†’æ¨èå¤å‘³ã€èŠ±ç”Ÿã€çƒ¤è‚ ```**â˜•åŠå…¬æç¥åœºæ™¯ç»„åˆ**```æ ¸å¿ƒåœºæ™¯ï¼šä¸Šåˆ/ä¸‹åˆåŠå…¬å®¤å·¥ä½œå…¸å‹ç»„åˆï¼š-æç¥å¥—é¤ï¼šå’–å•¡+åšæœ+å·§å…‹åŠ›ï¼ˆÂ¥25ï¼‰-ä¸‹åˆèŒ¶å¥—é¤ï¼šå¥¶èŒ¶+é¥¼å¹²+ç³–æœï¼ˆÂ¥20ï¼‰-èƒ½é‡å¥—é¤ï¼šåŠŸèƒ½é¥®æ–™+èƒ½é‡æ£’+å£é¦™ç³–ï¼ˆÂ¥22ï¼‰å…³è”æ¨èï¼šä¹°å’–å•¡â†’æ¨èåšæœã€å·§å…‹åŠ›```**ğŸ å®¶åº­æ—¥å¸¸åœºæ™¯ç»„åˆ**```æ ¸å¿ƒåœºæ™¯ï¼šå‘¨æœ«å®¶åº­å›¤è´§ã€æ—¥å¸¸è¡¥å……å…¸å‹ç»„åˆï¼š-æ—¥ç”¨å¥—é¤ï¼šçº¸å·¾+æ´—è¡£æ¶²+åƒåœ¾è¢‹ï¼ˆÂ¥45ï¼‰-æ¸…æ´å¥—é¤ï¼šæ´—æ´ç²¾+æ´—æ‰‹æ¶²+æŠ½çº¸ï¼ˆÂ¥35ï¼‰-æ´—æŠ¤å¥—é¤ï¼šæ´—å‘æ°´+æ²æµ´éœ²+ç‰™è†ï¼ˆÂ¥68ï¼‰å…³è”æ¨èï¼šä¹°çº¸å·¾â†’æ¨èåƒåœ¾è¢‹ã€æ´—è¡£æ¶²```**ğŸš¨åº”æ€¥åœºæ™¯ç»„åˆ**```æ ¸å¿ƒåœºæ™¯ï¼šçªç„¶å‘ç°ç¼ºæŸç‰©ã€ä¸´æ—¶éœ€æ±‚å…¸å‹ç»„åˆï¼š-åº”æ€¥åŒ…ï¼šçº¸å·¾+åƒåœ¾è¢‹+ç”µæ± ï¼ˆÂ¥20ï¼‰-ä¸´æ—¶å®¢äººï¼šé¥®æ–™+é›¶é£Ÿ+æ°´æœï¼ˆÂ¥35ï¼‰-å©´å„¿åº”æ€¥ï¼šå°¿ä¸æ¹¿+æ¹¿å·¾+çº¸å·¾ï¼ˆÂ¥58ï¼‰å…³è”æ¨èï¼šä¹°çº¸å·¾â†’æ¨èå…¶ä»–æ—¥ç”¨å“```####æ™ºèƒ½æ¨èç­–ç•¥ï¼ˆåŸºäºè´­ç‰©ç¯®åˆ†æï¼‰**1.é«˜é¢‘å…³è”ç»„åˆ**-ğŸºå•¤é…’â†’å¤å‘³ã€èŠ±ç”Ÿã€è–¯ç‰‡ï¼ˆå…³è”åº¦80%ï¼‰-ğŸ¿è–¯ç‰‡â†’å¯ä¹ã€é¥®æ–™ã€ç“œå­ï¼ˆå…³è”åº¦75%ï¼‰-â˜•å’–å•¡â†’åšæœã€å·§å…‹åŠ›ã€é¥¼å¹²ï¼ˆå…³è”åº¦70%ï¼‰-ğŸ§»çº¸å·¾â†’åƒåœ¾è¢‹ã€æ´—è¡£æ¶²ã€æŠ½çº¸ï¼ˆå…³è”åº¦65%ï¼‰**2.åœºæ™¯è§¦å‘æ¨è**-æ™šä¸Š19-23ç‚¹ä¸‹å•â†’è‡ªåŠ¨æ¨èè¿½å‰§å¥—é¤-å‘¨æœ«10-18ç‚¹ä¸‹å•â†’è‡ªåŠ¨æ¨èå®¶åº­å›¤è´§å¥—é¤-åŠå…¬åŒºåœ°å€â†’è‡ªåŠ¨æ¨èæç¥å¥—é¤**3.ç”¨æˆ·ç”»åƒæ¨è**-é«˜é¢‘ç”¨æˆ·â†’æ¨èä¼šå‘˜ä¸“äº«ç»„åˆ-ä½é¢‘ç”¨æˆ·â†’æ¨èæ–°äººä¼˜æƒ å¥—é¤-å®¶åº­ç”¨æˆ·â†’æ¨èå¤§åŒ…è£…ç»„åˆ---**ğŸ“Šæœ¬çœ‹æ¿æä¾›çš„ç»„åˆæ´å¯Ÿ**ï¼š-å‘ç°é«˜é¢‘å•†å“å…³è”ï¼ˆå“ªäº›å•†å“ç»å¸¸ä¸€èµ·ä¹°ï¼‰-è¯†åˆ«åœºæ™¯åŒ–éœ€æ±‚ï¼ˆä»€ä¹ˆåœºæ™¯ä¹°ä»€ä¹ˆç»„åˆï¼‰-ä¼˜åŒ–å¥—é¤è®¾è®¡ï¼ˆè®¾è®¡é«˜å®¢å•ä»·ç»„åˆï¼‰-æå‡è¿å¸¦é”€å”®ï¼ˆæ™ºèƒ½æ¨èå…³è”å•†å“ï¼‰""")df=extract_time_features(df)#æ˜ å°„ç»´åº¦åˆ°å­—æ®µådim_mapping={'æ—¥':'æ—¥æœŸ_datetime','å‘¨':'å¹´å‘¨','æœˆ':'å¹´æœˆ'}time_col=dim_mapping[time_dimension]#====================æ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆï¼ˆå¸¦ç¯æ¯”ï¼‰====================st.markdown(f"###ğŸ“ˆæ ¸å¿ƒæŒ‡æ ‡æ€»è§ˆï¼ˆæŒ‰{time_dimension}ï¼‰")iftime_colindf.columnsand'è®¢å•ID'indf.columns:try:#å¤„ç†é‡å¤åˆ—åtemp_df=df.copy()ifisinstance(temp_df['è®¢å•ID'],pd.DataFrame):temp_df['è®¢å•ID']=temp_df['è®¢å•ID'].iloc[:,0]#è®¡ç®—æ¯ä¸ªè®¢å•çš„å•†å“ä»¶æ•°items_per_order=temp_df.groupby(['è®¢å•ID',time_col]).size().reset_index(name='å•†å“ä»¶æ•°')#æŒ‰æ—¶é—´ç»´åº¦èšåˆtime_agg=items_per_order.groupby(time_col).agg({'è®¢å•ID':'count','å•†å“ä»¶æ•°':'mean'}).reset_index()time_agg.columns=[time_col,'è®¢å•æ•°','å¹³å‡ä»¶æ•°']#è®¡ç®—ç»„åˆè®¢å•æ¯”ä¾‹ï¼ˆä»¶æ•°>1ï¼‰combo_orders=items_per_order[items_per_order['å•†å“ä»¶æ•°']>1].groupby(time_col).size().reset_index(name='ç»„åˆè®¢å•æ•°')time_agg=time_agg.merge(combo_orders,on=time_col,how='left')time_agg['ç»„åˆè®¢å•æ•°']=time_agg['ç»„åˆè®¢å•æ•°'].fillna(0)time_agg['ç»„åˆè®¢å•æ¯”ä¾‹']=(time_agg['ç»„åˆè®¢å•æ•°']/time_agg['è®¢å•æ•°']*100).round(2)#è®¡ç®—ç¯æ¯”time_agg=calculate_period_over_period(time_agg,time_dimension,'è®¢å•æ•°')time_agg=calculate_period_over_period(time_agg,time_dimension,'å¹³å‡ä»¶æ•°')time_agg=calculate_period_over_period(time_agg,time_dimension,'ç»„åˆè®¢å•æ¯”ä¾‹')exceptExceptionase:st.error(f"è®¡ç®—æ ¸å¿ƒæŒ‡æ ‡æ—¶å‡ºé”™:{str(e)}")time_agg=Noneelse:time_agg=Noneiftime_aggisnotNone:#è·å–å½“å‰æœŸå’Œä¸Šä¸€æœŸæ•°æ®ï¼ˆæ ¹æ®ç”¨æˆ·é€‰æ‹©æˆ–æœ€è¿‘ä¸€æœŸï¼‰iflen(time_agg)>=1:#å¦‚æœç”¨æˆ·é€‰æ‹©äº†å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨é€‰æ‹©çš„å‘¨æœŸï¼›å¦åˆ™ä½¿ç”¨æœ€è¿‘ä¸€æœŸifselected_periodandnotselected_period.startswith("å…¨éƒ¨"):iftime_dimension=="æ—¥":selected_date=pd.to_datetime(selected_period)latest_idx=time_agg[time_agg[time_col]==selected_date].indexelse:latest_idx=time_agg[time_agg[time_col]==selected_period].indexiflen(latest_idx)>0:latest=time_agg.loc[latest_idx[0]]#è·å–ä¸Šä¸€æœŸæ•°æ®current_position=latest_idx[0]previous=time_agg.iloc[current_position-1]ifcurrent_position>0elseNoneelse:latest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNoneelse:#æœªé€‰æ‹©å…·ä½“å‘¨æœŸï¼Œä½¿ç”¨æœ€è¿‘ä¸€æœŸlatest=time_agg.iloc[-1]previous=time_agg.iloc[-2]iflen(time_agg)>=2elseNonecol1,col2,col3,col4=st.columns(4)#å½“å‰å‘¨æœŸwithcol1:period_label=format_period_label(latest[time_col],time_dimension)st.metric(label=f"å½“å‰{time_dimension}",value=period_label)#å¹³å‡ä»¶æ•°ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col2,f"å¹³å‡ä»¶æ•°/å•",latest['å¹³å‡ä»¶æ•°'],previous['å¹³å‡ä»¶æ•°']ifpreviousisnotNoneelseNone,format_type='number',unit='ä»¶')#ç»„åˆè®¢å•æ¯”ä¾‹ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col3,f"ç»„åˆè®¢å•æ¯”ä¾‹",latest['ç»„åˆè®¢å•æ¯”ä¾‹'],previous['ç»„åˆè®¢å•æ¯”ä¾‹']ifpreviousisnotNoneelseNone,format_type='percent')#è®¢å•æ•°ï¼ˆå¸¦ç¯æ¯”ï¼‰render_metric_with_comparison(col4,f"è®¢å•æ•°",latest['è®¢å•æ•°'],previous['è®¢å•æ•°']ifpreviousisnotNoneelseNone,format_type='number',unit='å•')st.markdown("---")#====================è¶‹åŠ¿å›¾====================st.markdown(f"###ğŸ“Š{time_dimension}åº¦è¶‹åŠ¿åˆ†æ")tab1,tab2,tab3=st.tabs(["å¹³å‡ä»¶æ•°è¶‹åŠ¿","ç»„åˆè®¢å•æ¯”ä¾‹è¶‹åŠ¿","è®¢å•é‡è¶‹åŠ¿"])withtab1:fig=px.line(time_agg,x=time_col,y='å¹³å‡ä»¶æ•°',title=f'å¹³å‡ä»¶æ•°{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#9b59b6',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)#ç¯æ¯”å˜åŒ–è¡¨æ ¼if'å¹³å‡ä»¶æ•°_ç¯æ¯”ç‡'intime_agg.columns:st.write("**ç¯æ¯”å˜åŒ–è¯¦æƒ…**")display_df=time_agg[[time_col,'å¹³å‡ä»¶æ•°','å¹³å‡ä»¶æ•°_ä¸ŠæœŸå€¼','å¹³å‡ä»¶æ•°_ç¯æ¯”å˜åŒ–','å¹³å‡ä»¶æ•°_ç¯æ¯”ç‡']].tail(10)display_df.columns=['æ—¶é—´å‘¨æœŸ','å½“å‰å¹³å‡ä»¶æ•°','ä¸ŠæœŸå¹³å‡ä»¶æ•°','ç¯æ¯”å˜åŒ–é‡','ç¯æ¯”å˜åŒ–ç‡(%)']st.dataframe(display_df.style.format({'å½“å‰å¹³å‡ä»¶æ•°':'{:.2f}','ä¸ŠæœŸå¹³å‡ä»¶æ•°':'{:.2f}','ç¯æ¯”å˜åŒ–é‡':'{:+.2f}','ç¯æ¯”å˜åŒ–ç‡(%)':'{:+.2f}%'}),use_container_width=True)withtab2:fig=px.line(time_agg,x=time_col,y='ç»„åˆè®¢å•æ¯”ä¾‹',title=f'ç»„åˆè®¢å•æ¯”ä¾‹{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#16a085',width=3))fig.update_layout(height=400,yaxis_title='ç»„åˆè®¢å•æ¯”ä¾‹(%)')st.plotly_chart(fig,use_container_width=True)withtab3:fig=px.line(time_agg,x=time_col,y='è®¢å•æ•°',title=f'è®¢å•æ•°{time_dimension}åº¦è¶‹åŠ¿',markers=True)fig.update_traces(line=dict(color='#3498db',width=3))fig.update_layout(height=400)st.plotly_chart(fig,use_container_width=True)st.markdown("---")#====================å•†å“ç»„åˆåˆ†æï¼ˆæ ¹æ®é€‰å®šçš„æ—¶é—´ç»´åº¦ç­›é€‰æœ€è¿‘ä¸€æœŸï¼‰====================st.markdown(f"###ğŸ›’è´­ç‰©ç¯®åˆ†æ-å•†å“å…³è”å‘ç°ï¼ˆå½“å‰{time_dimension}æ•°æ®ï¼‰")#ç­›é€‰æœ€è¿‘ä¸€ä¸ªå‘¨æœŸçš„æ•°æ®filtered_df=filter_data_by_time_dimension(df,time_dimension,selected_period,latest_only=True)iflen(filtered_df)==0:st.warning(f"âš ï¸å½“å‰{time_dimension}æš‚æ— æ•°æ®")return#æ˜¾ç¤ºå½“å‰åˆ†æçš„æ—¶é—´èŒƒå›´iftime_colinfiltered_df.columns:current_period=filtered_df[time_col].iloc[0]period_label=format_period_label(current_period,time_dimension)st.info(f"ğŸ“…å½“å‰åˆ†ææ—¶é—´ï¼š{period_label}")if'ä¸€çº§åˆ†ç±»å'infiltered_df.columns:fromitertoolsimportcombinationsorder_categories=filtered_df.groupby('è®¢å•ID')['ä¸€çº§åˆ†ç±»å'].apply(list)category_pairs={}fororder_id,categoriesinorder_categories.items():unique_cats=list(set(categories))iflen(unique_cats)>=2:forpairincombinations(sorted(unique_cats),2):key=f"{pair[0]}+{pair[1]}"category_pairs[key]=category_pairs.get(key,0)+1ifcategory_pairs:top_pairs=sorted(category_pairs.items(),key=lambdax:x[1],reverse=True)[:10]col1,col2=st.columns([2,1])withcol1:pairs_df=pd.DataFrame(top_pairs,columns=['å•†å“ç»„åˆ','å…±ç°æ¬¡æ•°'])fig=px.bar(pairs_df,x='å…±ç°æ¬¡æ•°',y='å•†å“ç»„åˆ',orientation='h',title=f'Top10å•†å“åˆ†ç±»ç»„åˆï¼ˆ{period_label}ï¼‰',color='å…±ç°æ¬¡æ•°',color_continuous_scale='Blues')fig.update_layout(showlegend=False,height=400)st.plotly_chart(fig,use_container_width=True)withcol2:st.write("**ğŸ”Top5çƒ­é—¨ç»„åˆ**")fori,(pair,count)inenumerate(top_pairs[:5],1):st.markdown(f"""<divclass="metric-card"><b>{i}.{pair}</b><br>å…±ç°{count}æ¬¡</div>""",unsafe_allow_html=True)top_pair=top_pairs[0]st.markdown(f"""<divclass="insight-box"><b>ğŸ’¡å¥—é¤è®¾è®¡å»ºè®®ï¼š</b><br>â€¢æœ€ä½³ç»„åˆï¼š<b>{top_pair[0]}</b>ï¼ˆå…±ç°{top_pair[1]}æ¬¡ï¼‰<br>â€¢å»ºè®®ï¼šå°†è¿™ä¸¤ç±»å•†å“æ‰“åŒ…ä¸ºå¥—é¤ï¼Œå®šä»·ç•¥ä½äºå•ä¹°æ€»ä»·<br>â€¢é¢„æœŸï¼šæå‡å®¢å•ä»·10-15%ï¼Œæé«˜ç”¨æˆ·æ»¡æ„åº¦</div>""",unsafe_allow_html=True)#å•å“vsç»„åˆè®¢å•å¯¹æ¯”st.write(f"**ğŸ“Šå•å“è®¢å•vsç»„åˆè®¢å•å¯¹æ¯”ï¼ˆ{period_label}ï¼‰**")items_per_order=filtered_df.groupby('è®¢å•ID').size()single_item_orders=items_per_order[items_per_order==1].indexcombo_orders=items_per_order[items_per_order>1].indexcol1,col2,col3=st.columns(3)withcol1:single_count=len(single_item_orders)total_orders=filtered_df['è®¢å•ID'].nunique()st.metric("å•å“è®¢å•",f"{single_count:,}",delta=f"{single_count/total_orders*100:.1f}%")withcol2:combo_count=len(combo_orders)st.metric("ç»„åˆè®¢å•",f"{combo_count:,}",delta=f"{combo_count/total_orders*100:.1f}%")withcol3:avg_items_combo=items_per_order[items_per_order>1].mean()st.metric("ç»„åˆè®¢å•å¹³å‡ä»¶æ•°",f"{avg_items_combo:.1f}ä»¶")st.markdown("""<divclass="warning-box"><b>ğŸ¯å•†å“ç»„åˆè¥é”€å»ºè®®ï¼š</b><br>1.<b>å¥—é¤è®¾è®¡</b>ï¼šå¼•æµå“+åˆ©æ¶¦å“ï¼Œå®ç°é”€é‡ä¸åˆ©æ¶¦å¹³è¡¡<br>2.<b>äº¤å‰é”€å”®</b>ï¼šè´­ä¹°Aå•†å“åæ¨èå¸¸æ­é…çš„Bå•†å“<br>3.<b>æ»¡ä»¶ä¼˜æƒ </b>ï¼š"ç¬¬äºŒä»¶åŠä»·"ä¿ƒè¿›å¤šä»¶è´­ä¹°<br>4.<b>æ™ºèƒ½æ¨è</b>ï¼šåŸºäºè´­ç‰©ç¯®åˆ†æï¼Œç²¾å‡†æ¨èç»„åˆå•†å“</div>""",unsafe_allow_html=True)#====================ğŸ¤–AIæ™ºèƒ½å†³ç­–åˆ†æ====================st.markdown("---")st.markdown("###ğŸ¤–AIæ™ºèƒ½å•†å“ç»„åˆæŒ–æ˜")ifSCENE_INTELLIGENCE_AVAILABLE:withst.expander("ğŸ’¡åŸºäºFP-Growthç®—æ³•çš„å…³è”è§„åˆ™æŒ–æ˜",expanded=True):st.info("ğŸ“Šä½¿ç”¨æœºå™¨å­¦ä¹ ç®—æ³•è‡ªåŠ¨å‘ç°å•†å“è´­ä¹°å…³è”è§„åˆ™ï¼Œç”Ÿæˆåœºæ™¯åŒ–å¥—é¤å»ºè®®")#è¿è¡ŒæŒ‰é’®ifst.button("ğŸš€å¼€å§‹æ™ºèƒ½åˆ†æ",key="run_product_mining"):withst.spinner("â³æ­£åœ¨åˆ†æå•†å“ç»„åˆè§„å¾‹..."):try:#æ•°æ®é‡æ£€æŸ¥total_orders=filtered_df['è®¢å•ID'].nunique()st.info(f"ğŸ“¦è®¢å•æ•°é‡:{total_orders}|å•†å“ç§ç±»:{filtered_df['å•†å“åç§°'].nunique()}")#æ ¹æ®æ•°æ®é‡åŠ¨æ€è°ƒæ•´é˜ˆå€¼iftotal_orders<100:min_sup,min_conf=0.02,0.2#è¶…å°æ•°æ®é›†eliftotal_orders<500:min_sup,min_conf=0.01,0.25#å°æ•°æ®é›†else:min_sup,min_conf=0.005,0.3#æ­£å¸¸æ•°æ®é›†#åˆå§‹åŒ–æŒ–æ˜å¼•æ“miner=ProductCombinationMiner(min_support=min_sup,min_confidence=min_conf)st.caption(f"âš™ï¸å½“å‰é˜ˆå€¼:æ”¯æŒåº¦â‰¥{min_sup*100:.1f}%,ç½®ä¿¡åº¦â‰¥{min_conf*100:.0f}%")#æ‰§è¡ŒæŒ–æ˜result=miner.mine_from_orders(filtered_df)ifresult.get('status')=='success':st.success(f"âœ…åˆ†æå®Œæˆï¼å‘ç°{result['stats']['rules_count']}æ¡å…³è”è§„åˆ™")#åˆ›å»ºæ ‡ç­¾é¡µtab1,tab2,tab3,tab4=st.tabs(["ğŸ“ŠTOPå…³è”è§„åˆ™","ğŸåœºæ™¯åŒ–å¥—é¤","ğŸ•¸ï¸å…³è”ç½‘ç»œ","ğŸ“ˆç»Ÿè®¡æ‘˜è¦"])withtab1:st.markdown("####ğŸ”TOP10å…³è”è§„åˆ™")st.caption("*è§„åˆ™æ ¼å¼:å•†å“Aâ†’å•†å“Bï¼ˆå¦‚æœè´­ä¹°Aï¼Œåˆ™æ¨èBï¼‰*")top_rules=miner.get_top_rules(top_n=10,sort_by='lift')ifnottop_rules.empty:#æ ¼å¼åŒ–æ˜¾ç¤ºdisplay_rules=top_rules.copy()display_rules['æ”¯æŒåº¦']=display_rules['support'].apply(lambdax:f"{x*100:.2f}%")display_rules['ç½®ä¿¡åº¦']=display_rules['confidence'].apply(lambdax:f"{x*100:.1f}%")display_rules['æå‡åº¦']=display_rules['lift'].apply(lambdax:f"{x:.2f}x")st.dataframe(display_rules[['rule','æ”¯æŒåº¦','ç½®ä¿¡åº¦','æå‡åº¦']],use_container_width=True,hide_index=True)#è§£é‡Šè¯´æ˜st.markdown("""**æŒ‡æ ‡è¯´æ˜ï¼š**-**æ”¯æŒåº¦**:è¯¥å•†å“ç»„åˆåœ¨æ‰€æœ‰è®¢å•ä¸­å‡ºç°çš„é¢‘ç‡-**ç½®ä¿¡åº¦**:è´­ä¹°å‰é¡¹å•†å“åï¼Œè´­ä¹°åé¡¹å•†å“çš„æ¦‚ç‡-**æå‡åº¦**:ç›¸æ¯”éšæœºæƒ…å†µï¼Œè¯¥è§„åˆ™çš„æ¨èæ•ˆæœï¼ˆ>1è¡¨ç¤ºæ­£ç›¸å…³ï¼‰""")else:st.warning(f"""âš ï¸**æœªæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„å…³è”è§„åˆ™**å½“å‰é˜ˆå€¼:æ”¯æŒåº¦â‰¥{min_sup*100:.1f}%,ç½®ä¿¡åº¦â‰¥{min_conf*100:.0f}%**å¯èƒ½åŸå› ï¼š**-è®¢å•æ•°é‡è¾ƒå°‘ï¼ˆå½“å‰{total_orders}ä¸ªè®¢å•ï¼‰-å•†å“ç»„åˆè¾ƒåˆ†æ•£ï¼Œç¼ºä¹æ˜æ˜¾å…³è”-æ¯ä¸ªè®¢å•å•†å“æ•°é‡è¾ƒå°‘**å»ºè®®ï¼š**1.å¢åŠ åˆ†ææ—¶é—´èŒƒå›´ï¼Œè·å–æ›´å¤šè®¢å•æ•°æ®2.èšç„¦ç‰¹å®šå“ç±»æˆ–åœºæ™¯è¿›è¡Œåˆ†æ3.æŸ¥çœ‹"ç»Ÿè®¡æ‘˜è¦"äº†è§£æ•°æ®åˆ†å¸ƒæƒ…å†µ""")withtab2:st.markdown("####ğŸåœºæ™¯åŒ–å¥—é¤æ¨è")scene_packages=result.get('scene_packages',{})ifscene_packages:forscene_name,packagesinscene_packages.items():withst.container():st.markdown(f"**{scene_name}**")fori,pkginenumerate(packages[:3],1):items_str="+".join(pkg['items'])support=pkg['support']st.markdown(f"""<divclass="metric-card"><b>å¥—é¤{i}ï¼š</b>{items_str}<br><small>æ”¯æŒåº¦:{support*100:.2f}%|åŒ¹é…åº¦:â­{'â­'*pkg['match_score']}</small></div>""",unsafe_allow_html=True)else:st.info("ğŸ’¡æç¤ºï¼šå¯è°ƒæ•´åœºæ™¯å…³é”®è¯ä»¥è¯†åˆ«æ›´å¤šåœºæ™¯å¥—é¤")withtab3:st.markdown("####ğŸ•¸ï¸å•†å“å…³è”ç½‘ç»œå›¾")st.caption("*å±•ç¤ºå•†å“ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œçº¿æ¡ç²—ç»†è¡¨ç¤ºå…³è”å¼ºåº¦*")network_fig=miner.visualize_rules_network(top_n=15)st.plotly_chart(network_fig,use_container_width=True)withtab4:st.markdown("####ğŸ“ˆæŒ–æ˜ç»Ÿè®¡æ‘˜è¦")stats=result.get('stats',{})col1,col2,col3=st.columns(3)withcol1:st.metric("åˆ†æè®¢å•æ•°",f"{stats.get('total_baskets',0):,}")st.caption(f"å¹³å‡æ¯å•{filtered_df.groupby('è®¢å•ID').size().mean():.1f}ä»¶å•†å“")withcol2:st.metric("é¢‘ç¹é¡¹é›†æ•°",f"{stats.get('frequent_itemsets_count',0):,}")st.caption(f"å•†å“ç§ç±»:{filtered_df['å•†å“åç§°'].nunique()}")withcol3:st.metric("å…³è”è§„åˆ™æ•°",f"{stats.get('rules_count',0):,}")st.caption(f"å½“å‰é˜ˆå€¼:{min_sup*100:.1f}%/{min_conf*100:.0f}%")#æ•°æ®è´¨é‡è¯Šæ–­st.markdown("---")st.markdown("**ğŸ“Šæ•°æ®è´¨é‡è¯Šæ–­**")order_sizes=filtered_df.groupby('è®¢å•ID').size()quality_col1,quality_col2=st.columns(2)withquality_col1:st.markdown(f"""-å•å•†å“è®¢å•:**{(order_sizes==1).sum()}**å•({(order_sizes==1).sum()/len(order_sizes)*100:.1f}%)-2-3ä»¶è®¢å•:**{((order_sizes>=2)&(order_sizes<=3)).sum()}**å•-4+ä»¶è®¢å•:**{(order_sizes>=4).sum()}**å•""")withquality_col2:ifstats.get('rules_count',0)==0:st.warning("""**ğŸ’¡ä¼˜åŒ–å»ºè®®ï¼š**-å•å•†å“è®¢å•å æ¯”è¿‡é«˜ä¼šé™ä½å…³è”æ€§-å»ºè®®ç­›é€‰å¤šä»¶è®¢å•å†åˆ†æ-æˆ–æ‰©å¤§æ—¶é—´èŒƒå›´å¢åŠ æ•°æ®é‡""")else:st.success("âœ…æ•°æ®è´¨é‡è‰¯å¥½ï¼Œå…³è”åˆ†ææœ‰æ•ˆ")#TOPå•†å“ç»„åˆst.markdown("---")st.markdown("**ğŸ”TOP5é«˜é¢‘å•†å“ç»„åˆ**")top_combos=miner.get_top_combinations(top_n=5)ifnottop_combos.empty:foridx,rowintop_combos.iterrows():st.markdown(f"-{row['items_str']}(æ”¯æŒåº¦:{row['support']*100:.2f}%)")elifresult.get('status')=='warning':st.warning(f"âš ï¸{result.get('message')}")st.info("ğŸ’¡å»ºè®®ï¼šé™ä½æœ€å°æ”¯æŒåº¦é˜ˆå€¼ï¼ˆå¦‚0.005ï¼‰ä»¥å‘ç°æ›´å¤šè§„åˆ™")else:st.error(f"âŒåˆ†æå¤±è´¥ï¼š{result.get('message')}")exceptExceptionase:st.error(f"âŒåˆ†æè¿‡ç¨‹å‡ºé”™:{str(e)}")importtracebackst.code(traceback.format_exc())else:st.warning("âš ï¸åœºæ™¯è¥é”€æ™ºèƒ½å†³ç­–å¼•æ“æœªåŠ è½½ï¼Œè¯·ç¡®ä¿å·²å®‰è£…mlxtendåº“:`pipinstallmlxtend`")defdisplay_scenario_marketing_dashboard(current_data:Dict):"""åœºæ™¯è¥é”€çœ‹æ¿ä¸»å…¥å£ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦åˆ‡æ¢ï¼‰"""st.markdown('<pclass="sub-header">ğŸ¯åœºæ™¯è¥é”€çœ‹æ¿</p>',unsafe_allow_html=True)#è·å–åŸå§‹æ•°æ®ï¼ˆä¼˜å…ˆä»current_dataï¼Œå…¶æ¬¡ä»session_stateï¼‰raw_data=current_data.get('raw_data')#å¦‚æœcurrent_dataä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»session_stateè·å–ï¼ˆä¸Šä¼ æ•°æ®çš„æƒ…å†µï¼‰ifraw_dataisNoneor(isinstance(raw_data,pd.DataFrame)andraw_data.empty):if'current_data'inst.session_state:raw_data=st.session_state['current_data'].get('raw_data')#æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨æ•°æ®ifraw_dataisNoneor(isinstance(raw_data,pd.DataFrame)andraw_data.empty):st.warning("âš ï¸è¯·å…ˆåŠ è½½æ•°æ®åï¼Œæ‰èƒ½æŸ¥çœ‹åœºæ™¯è¥é”€åˆ†æ")st.info("""ğŸ’¡**åœºæ™¯è¥é”€çœ‹æ¿åŠŸèƒ½ï¼š**1.â°**æ—¶æ®µåœºæ™¯è¥é”€**-è¯†åˆ«é»„é‡‘é”€å”®æ—¶æ®µï¼Œä¼˜åŒ–è¥é”€æŠ•æ”¾2.ğŸª**é—¨åº—å•†åœˆåœºæ™¯**-å‘ç°é«˜ä»·å€¼å•†åœˆï¼Œä¼˜åŒ–é—¨åº—å¸ƒå±€3.ğŸ’°**ä»·æ ¼æ•æ„Ÿåº¦**-ç²¾å‡†å®šä»·ç­–ç•¥ï¼Œæå‡å®¢å•ä»·4.ğŸ“¦**å•†å“ç»„åˆåœºæ™¯**-å‘ç°å•†å“å…³è”ï¼Œè®¾è®¡ç»„åˆå¥—é¤**ä¸¤ç§åŠ è½½æ–¹å¼ï¼š**-æ–¹å¼1ï¼šåœ¨å·¦ä¾§ç‚¹å‡»"ğŸš€å¼€å§‹æ™ºèƒ½åˆ†æ"åŠ è½½å®é™…æ•°æ®-æ–¹å¼2ï¼šåœ¨"ğŸ’¹æ¯”ä»·çœ‹æ¿"æ ‡ç­¾é¡µä¸Šä¼ è®¢å•æ•°æ®Excelæ–‡ä»¶""")return#==========æ•°æ®è¿‡æ»¤ï¼šå‰”é™¤å’–å•¡æ¸ é“==========if'æ¸ é“'inraw_data.columns:exclude_channels=['é¥¿äº†ä¹ˆå’–å•¡','ç¾å›¢å’–å•¡']original_count=len(raw_data)raw_data=raw_data[~raw_data['æ¸ é“'].isin(exclude_channels)].copy()filtered_count=len(raw_data)excluded_count=original_count-filtered_countifexcluded_count>0:st.info(f"â„¹ï¸å·²è‡ªåŠ¨å‰”é™¤å’–å•¡æ¸ é“æ•°æ®{excluded_count}è¡Œï¼ˆ{excluded_count/original_count*100:.1f}%ï¼‰ï¼Œä¿ç•™O2Oé›¶å”®æ•°æ®{filtered_count}è¡Œ")#è°ƒè¯•:æ£€æŸ¥åŸå§‹æ•°æ®æ—¶é—´åˆ†å¸ƒif'ä¸‹å•æ—¶é—´'inraw_data.columns:withst.expander("ğŸ”åŸå§‹æ•°æ®æ—¶é—´è¯Šæ–­ï¼ˆç‚¹å‡»å±•å¼€ï¼‰",expanded=False):st.write("**ä¸‹å•æ—¶é—´æ ·æœ¬ï¼ˆå‰10æ¡ï¼‰ï¼š**")time_samples=raw_data['ä¸‹å•æ—¶é—´'].head(10)st.dataframe(pd.DataFrame({'ä¸‹å•æ—¶é—´':time_samples}),use_container_width=True)#è½¬æ¢ä¸ºdatetimeå¹¶æ˜¾ç¤ºå°æ—¶åˆ†å¸ƒtime_series=pd.to_datetime(raw_data['ä¸‹å•æ—¶é—´'],errors='coerce')ifnottime_series.dropna().empty:hour_dist=time_series.dt.hour.value_counts().sort_index()st.write(f"**æ—¶é—´èŒƒå›´ï¼š**{time_series.min()}~{time_series.max()}")st.write(f"**è¦†ç›–å°æ—¶æ•°ï¼š**{len(hour_dist)}/24")st.write("**å„å°æ—¶è®¢å•æ•°ï¼š**")st.bar_chart(hour_dist)#æå–æ—¶é—´ç‰¹å¾ï¼ˆæ”¯æŒæ—¥/å‘¨/æœˆç»´åº¦ï¼‰raw_data=extract_time_features(raw_data)#æ£€æŸ¥æ˜¯å¦æˆåŠŸæå–æ—¶é—´ç‰¹å¾if'æ—¥æœŸ_datetime'notinraw_data.columns:st.error("âš ï¸æ•°æ®æ ¼å¼é”™è¯¯ï¼šæ— æ³•æå–æ—¶é—´ç‰¹å¾")st.warning("""**å¯èƒ½çš„åŸå› ï¼š**1.æ•°æ®ä¸­ç¼ºå°‘'ä¸‹å•æ—¶é—´'åˆ—2.'ä¸‹å•æ—¶é—´'åˆ—çš„æ ¼å¼ä¸æ­£ç¡®**è¯·æ£€æŸ¥ï¼š**-ç¡®ä¿Excelæ–‡ä»¶ä¸­æœ‰'ä¸‹å•æ—¶é—´'åˆ—-ç¡®ä¿æ—¶é—´æ ¼å¼æ­£ç¡®ï¼ˆå¦‚ï¼š2025-01-0112:00:00ï¼‰""")st.info(f"å½“å‰æ•°æ®åˆ—å:{list(raw_data.columns)[:30]}")return#æ—¶é—´ç»´åº¦é€‰æ‹©å™¨st.markdown("###ğŸ“…æ•°æ®åˆ†æç»´åº¦")col1,col2,col3=st.columns([1,2,2])withcol1:time_dimension=st.selectbox("é€‰æ‹©æ—¶é—´ç»´åº¦",["æ—¥","å‘¨","æœˆ"],help="é€‰æ‹©ä¸åŒçš„æ—¶é—´ç»´åº¦æŸ¥çœ‹æ•°æ®è¶‹åŠ¿å’Œç¯æ¯”å˜åŒ–",key="scenario_marketing_time_dimension")#æ ¹æ®ç»´åº¦åŠ¨æ€ç”Ÿæˆæ—¶é—´å‘¨æœŸé€‰æ‹©å™¨selected_period=Nonewithcol2:iftime_dimension=="æ—¥":available_dates=sorted(raw_data['æ—¥æœŸ_datetime'].dropna().unique(),reverse=True)date_options=["å…¨éƒ¨æ—¥æœŸ"]+[d.strftime('%Y-%m-%d')fordinavailable_dates]selected_period=st.selectbox("é€‰æ‹©å…·ä½“æ—¥æœŸ",date_options,help="é€‰æ‹©æŸ¥çœ‹æŸä¸€å¤©çš„æ•°æ®ï¼Œæˆ–æŸ¥çœ‹å…¨éƒ¨æ—¥æœŸçš„è¶‹åŠ¿",key="scenario_marketing_date_selector")eliftime_dimension=="å‘¨":available_weeks=sorted(raw_data['å¹´å‘¨'].dropna().unique(),reverse=True)week_options=["å…¨éƒ¨å‘¨"]+[f"{w}"forwinavailable_weeks]selected_period=st.selectbox("é€‰æ‹©å…·ä½“å‘¨",week_options,help="é€‰æ‹©æŸ¥çœ‹æŸä¸€å‘¨çš„æ•°æ®ï¼Œæˆ–æŸ¥çœ‹å…¨éƒ¨å‘¨çš„è¶‹åŠ¿",key="scenario_marketing_week_selector")else:#æœˆavailable_months=sorted(raw_data['å¹´æœˆ'].dropna().unique(),reverse=True)month_options=["å…¨éƒ¨æœˆä»½"]+[f"{m}"forminavailable_months]selected_period=st.selectbox("é€‰æ‹©å…·ä½“æœˆä»½",month_options,help="é€‰æ‹©æŸ¥çœ‹æŸä¸€æœˆçš„æ•°æ®ï¼Œæˆ–æŸ¥çœ‹å…¨éƒ¨æœˆä»½çš„è¶‹åŠ¿",key="scenario_marketing_month_selector")withcol3:#æ˜¾ç¤ºæ•°æ®èŒƒå›´å’Œé€‰æ‹©çŠ¶æ€è¯´æ˜if'ä¸‹å•æ—¶é—´'inraw_data.columns:min_date=raw_data['ä¸‹å•æ—¶é—´'].min().strftime('%Y-%m-%d')max_date=raw_data['ä¸‹å•æ—¶é—´'].max().strftime('%Y-%m-%d')total_days=(raw_data['ä¸‹å•æ—¶é—´'].max()-raw_data['ä¸‹å•æ—¶é—´'].min()).days+1#æ ¹æ®ç”¨æˆ·é€‰æ‹©æ˜¾ç¤ºä¸åŒä¿¡æ¯ifselected_periodandnotselected_period.startswith("å…¨éƒ¨"):#é€‰æ‹©äº†å…·ä½“å‘¨æœŸiftime_dimension=="æ—¥":st.info(f"ğŸ“Šå·²é€‰æ‹©ï¼š{selected_period}ï½œæŸ¥çœ‹å•æ—¥æ•°æ®")eliftime_dimension=="å‘¨":st.info(f"ğŸ“Šå·²é€‰æ‹©ï¼š{selected_period}ï½œæŸ¥çœ‹å•å‘¨æ•°æ®")else:#æœˆst.info(f"ğŸ“Šå·²é€‰æ‹©ï¼š{selected_period}ï½œæŸ¥çœ‹å•æœˆæ•°æ®")else:#æœªé€‰æ‹©å…·ä½“å‘¨æœŸï¼Œæ˜¾ç¤ºå…¨é‡æ•°æ®èŒƒå›´iftime_dimension=="æ—¥":st.info(f"ğŸ“Šæ•°æ®èŒƒå›´ï¼š{min_date}è‡³{max_date}ï¼ˆå…±{total_days}å¤©ï¼‰ï½œç¯æ¯”ï¼šä¸å‰ä¸€æ—¥å¯¹æ¯”")eliftime_dimension=="å‘¨":total_weeks=raw_data['å¹´å‘¨'].nunique()st.info(f"ğŸ“Šæ•°æ®èŒƒå›´ï¼š{min_date}è‡³{max_date}ï¼ˆå…±{total_weeks}å‘¨ï¼‰ï½œç¯æ¯”ï¼šä¸ä¸Šå‘¨å¯¹æ¯”")else:#æœˆtotal_months=raw_data['å¹´æœˆ'].nunique()st.info(f"ğŸ“Šæ•°æ®èŒƒå›´ï¼š{min_date}è‡³{max_date}ï¼ˆå…±{total_months}æœˆï¼‰ï½œç¯æ¯”ï¼šä¸ä¸Šæœˆå¯¹æ¯”")st.markdown("---")#åœºæ™¯é€‰æ‹©ï¼ˆç§»é™¤é—®é¢˜è¯Šæ–­ï¼Œå·²ç‹¬ç«‹ä¸ºä¸»Tabï¼‰scenario=st.radio("é€‰æ‹©è¥é”€åœºæ™¯",["â°æ—¶æ®µåœºæ™¯è¥é”€","ğŸªé—¨åº—å•†åœˆåœºæ™¯","ğŸ’°ä»·æ ¼æ•æ„Ÿåº¦","ğŸ“¦å•†å“ç»„åˆåœºæ™¯"],horizontal=True,key="scenario_marketing_radio")st.markdown("---")#æ¸²æŸ“å¯¹åº”åœºæ™¯ï¼ˆä¼ é€’æ—¶é—´ç»´åº¦å’Œé€‰å®šå‘¨æœŸå‚æ•°ï¼‰ifscenario=="â°æ—¶æ®µåœºæ™¯è¥é”€":render_time_period_marketing(raw_data,time_dimension,selected_period)elifscenario=="ğŸªé—¨åº—å•†åœˆåœºæ™¯":render_location_marketing(raw_data,time_dimension,selected_period)elifscenario=="ğŸ’°ä»·æ ¼æ•æ„Ÿåº¦":render_price_sensitivity_marketing(raw_data,time_dimension,selected_period)elifscenario=="ğŸ“¦å•†å“ç»„åˆåœºæ™¯":render_product_combination_marketing(raw_data,time_dimension,selected_period)#====================é—®é¢˜è¯Šæ–­ä¸­å¿ƒæ¨¡å—====================defdisplay_problem_diagnostic_center(data_dict:Dict):"""æ˜¾ç¤ºé—®é¢˜è¯Šæ–­ä¸­å¿ƒParameters:-----------data_dict:DictåŒ…å«åŸå§‹æ•°æ®çš„å­—å…¸"""st.markdown('<h2class="section-header">ğŸ“‹é—®é¢˜è¯Šæ–­ä¸­å¿ƒ</h2>',unsafe_allow_html=True)ifnotPROBLEM_DIAGNOSTIC_AVAILABLE:st.error("âš ï¸é—®é¢˜è¯Šæ–­å¼•æ“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ä¾èµ–é¡¹")return#è·å–æ•°æ®ï¼ˆä¸åœºæ™¯è¥é”€çœ‹æ¿ä¿æŒä¸€è‡´çš„æ•°æ®è·å–é€»è¾‘ï¼‰raw_data=data_dict.get('raw_data')#å¦‚æœcurrent_dataä¸­æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»session_stateè·å–ï¼ˆä¸Šä¼ æ•°æ®çš„æƒ…å†µï¼‰ifraw_dataisNoneor(isinstance(raw_data,pd.DataFrame)andraw_data.empty):if'current_data'inst.session_state:raw_data=st.session_state['current_data'].get('raw_data')#æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨æ•°æ®ifraw_dataisNoneor(isinstance(raw_data,pd.DataFrame)andraw_data.empty):st.warning("âš ï¸è¯·å…ˆåŠ è½½æ•°æ®åï¼Œæ‰èƒ½ä½¿ç”¨é—®é¢˜è¯Šæ–­åŠŸèƒ½")st.info("""ğŸ’¡**é—®é¢˜è¯Šæ–­ä¸­å¿ƒåŠŸèƒ½ï¼š**1.ğŸ“‰**é”€é‡ä¸‹æ»‘è¯Šæ–­**-è¯†åˆ«é”€é‡ä¸‹é™çš„å•†å“åŠåŸå› 2.ğŸ’°**å®¢å•ä»·å½’å› åˆ†æ**-åˆ†æå®¢å•ä»·å˜åŒ–çš„å…·ä½“å•†å“3.ğŸš¨**è´Ÿæ¯›åˆ©å•†å“é¢„è­¦**-è‡ªåŠ¨è¯†åˆ«äºæœ¬å•†å“4.ğŸšš**é«˜é…é€è´¹ä¼˜åŒ–**-ä¼˜åŒ–é…é€æˆæœ¬5.âš–ï¸**å•†å“è§’è‰²å¤±è¡¡**-æ£€æµ‹æµé‡å“/åˆ©æ¶¦å“é…æ¯”6.ğŸ“Š**å¼‚å¸¸æ³¢åŠ¨é¢„è­¦**-è¯†åˆ«çˆ†å•/æ»é”€å•†å“**ä¸¤ç§åŠ è½½æ–¹å¼ï¼š**-æ–¹å¼1ï¼šåœ¨å·¦ä¾§ç‚¹å‡»"ğŸš€å¼€å§‹æ™ºèƒ½åˆ†æ"åŠ è½½å®é™…æ•°æ®-æ–¹å¼2ï¼šåœ¨"ğŸ’¹æ¯”ä»·çœ‹æ¿"æ ‡ç­¾é¡µä¸Šä¼ è®¢å•æ•°æ®Excelæ–‡ä»¶""")return#æ•°æ®éªŒè¯ï¼ˆæ£€æŸ¥å¿…éœ€åˆ—ï¼‰required_cols=['è®¢å•ID','ä¸‰çº§åˆ†ç±»å','å•†å“å®å”®ä»·']missing_cols=[colforcolinrequired_colsifcolnotinraw_data.columns]ifmissing_cols:st.error(f"âš ï¸æ•°æ®ç¼ºå°‘å¿…è¦åˆ—:{','.join(missing_cols)}")st.info(f"ğŸ“‹å½“å‰æ•°æ®åˆ—:{','.join(raw_data.columns.tolist()[:10])}...")returnst.info("ğŸ”è‡ªåŠ¨è¯Šæ–­è¿è¥é—®é¢˜ï¼Œå¿«é€Ÿå®šä½ä¼˜åŒ–æœºä¼š")#åˆå§‹åŒ–è¯Šæ–­å¼•æ“try:diagnostic_engine=ProblemDiagnosticEngine(raw_data)exceptExceptionase:st.error(f"âŒè¯Šæ–­å¼•æ“åˆå§‹åŒ–å¤±è´¥:{str(e)}")return#é¡¶éƒ¨æ§åˆ¶é¢æ¿col1,col2,col3=st.columns([2,2,1])withcol1:st.markdown("###ğŸ¯å¿«é€Ÿè¯Šæ–­")withcol2:ifst.button("ğŸš€ä¸€é”®ç”Ÿæˆç»¼åˆé—®é¢˜æŠ¥å‘Š",type="primary",use_container_width=True):withst.spinner("æ­£åœ¨ç”Ÿæˆç»¼åˆè¯Šæ–­æŠ¥å‘Š..."):try:timestamp=datetime.now().strftime("%Y%m%d_%H%M%S")output_path=f"é—®é¢˜è¯Šæ–­æŠ¥å‘Š_{timestamp}.xlsx"report=diagnostic_engine.generate_comprehensive_report(output_path)st.success(f"âœ…ç»¼åˆæŠ¥å‘Šå·²ç”Ÿæˆ:{output_path}")#æ˜¾ç¤ºæ‘˜è¦if'è¯Šæ–­æ‘˜è¦'inreportandlen(report['è¯Šæ–­æ‘˜è¦'])>0:st.dataframe(report['è¯Šæ–­æ‘˜è¦'],use_container_width=True)#æä¾›ä¸‹è½½ifos.path.exists(output_path):withopen(output_path,'rb')asf:st.download_button(label="â¬‡ï¸ä¸‹è½½å®Œæ•´è¯Šæ–­æŠ¥å‘Š",data=f,file_name=output_path,mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")exceptExceptionase:st.error(f"âŒæŠ¥å‘Šç”Ÿæˆå¤±è´¥:{str(e)}")withcol3:total_orders=raw_data['è®¢å•ID'].nunique()st.metric("æ€»è®¢å•æ•°",f"{total_orders:,}")st.markdown("---")#è¯Šæ–­æ ‡ç­¾é¡µï¼ˆç§»é™¤è¡¨æƒ…ç¬¦å·ï¼‰diagnostic_tabs=st.tabs(["é”€é‡ä¸‹æ»‘","å®¢å•ä»·å½’å› ","è´Ÿæ¯›åˆ©é¢„è­¦","é«˜é…é€è´¹","è§’è‰²å¤±è¡¡","å¼‚å¸¸æ³¢åŠ¨"])#Tab1:é”€é‡ä¸‹æ»‘è¯Šæ–­withdiagnostic_tabs[0]:st.markdown("###é”€é‡ä¸‹æ»‘å•†å“è¯Šæ–­")#ç¬¬ä¸€è¡Œï¼šåŸºç¡€é…ç½®col1,col2,col3,col4=st.columns(4)withcol1:time_period=st.selectbox("å¯¹æ¯”å‘¨æœŸ",["week","month"],format_func=lambdax:"æŒ‰å‘¨å¯¹æ¯”"ifx=="week"else"æŒ‰æœˆå¯¹æ¯”",key="decline_period")withcol2:threshold=st.slider("ä¸‹æ»‘é˜ˆå€¼%",min_value=-80.0,max_value=-5.0,value=-20.0,step=5.0,key="decline_threshold")withcol3:scene_options=[]if'åœºæ™¯'inraw_data.columns:scene_options=['å…¨éƒ¨åœºæ™¯']+sorted(raw_data['åœºæ™¯'].dropna().unique().tolist())scene_filter=st.multiselect("åœºæ™¯ç­›é€‰",scene_options,default=['å…¨éƒ¨åœºæ™¯']ifscene_optionselse[],key="decline_scene")withcol4:time_slot_options=[]if'æ—¶æ®µ'inraw_data.columns:time_slot_options=['å…¨éƒ¨æ—¶æ®µ']+sorted(raw_data['æ—¶æ®µ'].dropna().unique().tolist())time_slot_filter=st.multiselect("æ—¶æ®µç­›é€‰",time_slot_options,default=['å…¨éƒ¨æ—¶æ®µ']iftime_slot_optionselse[],key="decline_timeslot")#ç¬¬äºŒè¡Œï¼šå‘¨æœŸé€‰æ‹©å™¨ï¼ˆæ–°åŠŸèƒ½ï¼‰st.markdown("---")st.markdown("####ğŸ“…è‡ªå®šä¹‰å‘¨æœŸå¯¹æ¯”")#è·å–å¯ç”¨å‘¨æœŸåˆ—è¡¨try:available_periods=diagnostic_engine.get_available_periods(time_period)iflen(available_periods)>=2:col5,col6,col7=st.columns([2,2,1])withcol5:#å½“å‰å‘¨æœŸé€‰æ‹©current_options={p['label']:p['index']forpinavailable_periods}current_label=st.selectbox("ğŸ“å½“å‰å‘¨æœŸ",options=list(current_options.keys()),index=0,key="current_period_selector",help="é€‰æ‹©è¦åˆ†æçš„å½“å‰å‘¨æœŸ")current_period_index=current_options[current_label]#æ˜¾ç¤ºæ—¥æœŸèŒƒå›´current_period_info=next(pforpinavailable_periodsifp['index']==current_period_index)st.caption(f"ğŸ“†{current_period_info['date_range']}")withcol6:#å¯¹æ¯”å‘¨æœŸé€‰æ‹©compare_label=st.selectbox("ğŸ“å¯¹æ¯”å‘¨æœŸ",options=list(current_options.keys()),index=1,key="compare_period_selector",help="é€‰æ‹©è¦å¯¹æ¯”çš„å†å²å‘¨æœŸ")compare_period_index=current_options[compare_label]#æ˜¾ç¤ºæ—¥æœŸèŒƒå›´compare_period_info=next(pforpinavailable_periodsifp['index']==compare_period_index)st.caption(f"ğŸ“†{compare_period_info['date_range']}")withcol7:st.markdown("<br>",unsafe_allow_html=True)use_custom_period=st.checkbox("å¯ç”¨è‡ªå®šä¹‰",value=False,key="use_custom_period")else:st.warning("âš ï¸æ•°æ®æ—¶é—´èŒƒå›´ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œå‘¨æœŸå¯¹æ¯”åˆ†æ")use_custom_period=Falsecurrent_period_index=Nonecompare_period_index=NoneexceptExceptionase:st.warning(f"âš ï¸æ— æ³•è·å–å‘¨æœŸåˆ—è¡¨:{str(e)}")use_custom_period=Falsecurrent_period_index=Nonecompare_period_index=Nonest.markdown("---")ifst.button("å¼€å§‹è¯Šæ–­",key="btn_decline"):withst.spinner("æ­£åœ¨åˆ†æé”€é‡ä¸‹æ»‘å•†å“..."):try:#å¤„ç†ç­›é€‰æ¡ä»¶scene_list=Noneif'å…¨éƒ¨åœºæ™¯'inscene_filterelse[sforsinscene_filterifs!='å…¨éƒ¨åœºæ™¯']slot_list=Noneif'å…¨éƒ¨æ—¶æ®µ'intime_slot_filterelse[sforsintime_slot_filterifs!='å…¨éƒ¨æ—¶æ®µ']#æ„å»ºå‚æ•°ï¼ˆæ ¹æ®æ˜¯å¦å¯ç”¨è‡ªå®šä¹‰å‘¨æœŸï¼‰diagnose_params={'time_period':time_period,'threshold':threshold,'scene_filter':scene_list,'time_slot_filter':slot_list}#å¦‚æœå¯ç”¨è‡ªå®šä¹‰å‘¨æœŸï¼Œæ·»åŠ å‘¨æœŸå‚æ•°ifuse_custom_periodandcurrent_period_indexisnotNoneandcompare_period_indexisnotNone:diagnose_params['current_period_index']=current_period_indexdiagnose_params['compare_period_index']=compare_period_indexst.info(f"ğŸ“Šå¯¹æ¯”å‘¨æœŸ:{current_label}vs{compare_label}")result=diagnostic_engine.diagnose_sales_decline(**diagnose_params)iflen(result)>0:st.success(f"å‘ç°{len(result)}ä¸ªé”€é‡ä¸‹æ»‘å•†å“")#æ•°æ®å±•ç¤ºï¼ˆç§»é™¤è¡¨æƒ…ç¬¦å·çš„æ ·å¼åŒ¹é…ï¼‰st.dataframe(result.style.apply(lambdax:['background-color:#ffcccc'ifv=='ä¸¥é‡'else'background-color:#ffe6cc'ifv=='è­¦å‘Š'else''forvinx],subset=['é—®é¢˜ç­‰çº§']),use_container_width=True,height=400)#æ˜¾ç¤ºåˆ—åæç¤ºrevenue_cols=[colforcolinresult.columnsif'é¢„è®¡æ”¶å…¥'incol]ifrevenue_cols:st.info(f"å·²åŒ…å«é¢„è®¡æ”¶å…¥æ•°æ®:{','.join(revenue_cols)}")#å¯¼å‡ºæŒ‰é’®-åˆ›å»ºå¯¼å‡ºä¸“ç”¨ç‰ˆæœ¬ï¼ˆç§»é™¤æ‰€æœ‰æ ¼å¼åŒ–ç¬¦å·ï¼‰export_df=result.copy()#è‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†æ‰€æœ‰åŒ…å«Â¥ç¬¦å·çš„åˆ—forcolinexport_df.columns:ifexport_df[col].dtype=='object':#åªå¤„ç†å­—ç¬¦ä¸²ç±»å‹çš„åˆ—#æ£€æŸ¥æ˜¯å¦åŒ…å«Â¥ç¬¦å·sample_value=export_df[col].iloc[0]iflen(export_df)>0else""ifisinstance(sample_value,str)and'Â¥'insample_value:try:#æ¸…ç†Â¥ç¬¦å·ã€åƒåˆ†ä½é€—å·ã€N/Aï¼Œè½¬ä¸ºæ•°å€¼export_df[col]=(export_df[col].astype(str).str.replace('Â¥','').str.replace(',','').str.replace('N/A','0').replace('','0').astype(float))except:pass#å¦‚æœè½¬æ¢å¤±è´¥ï¼Œä¿æŒåŸæ ·#ğŸ†•éœ€æ±‚1:ä¿ç•™å˜åŒ–å¹…åº¦%çš„%ç¬¦å·ï¼Œä¸åšæ¸…ç†#æ³¨é‡Šæ‰åŸæœ‰çš„%ç¬¦å·æ¸…ç†é€»è¾‘ï¼Œä¿æŒå˜åŒ–å¹…åº¦%åˆ—åŸæ ·å¯¼å‡º#if'å˜åŒ–å¹…åº¦%'inexport_df.columns:#try:#export_df['å˜åŒ–å¹…åº¦%']=(export_df['å˜åŒ–å¹…åº¦%']#.astype(str)#.str.replace('%','')#.astype(float))#except:#pass#ç”ŸæˆCSV-å…ˆç”Ÿæˆå­—ç¬¦ä¸²ï¼Œå†ç”¨BOMç¼–ç ç¡®ä¿Excelè¯†åˆ«fromioimportBytesIO#åˆ›å»ºå­—èŠ‚æµç¼“å†²åŒºcsv_buffer=BytesIO()#å†™å…¥BOMæ ‡è®°ï¼ˆUTF-8withBOMï¼‰csv_buffer.write('\ufeff'.encode('utf-8'))#å†™å…¥CSVå†…å®¹csv_string=export_df.to_csv(index=False)csv_buffer.write(csv_string.encode('utf-8'))#è·å–å­—èŠ‚æ•°æ®csv_bytes=csv_buffer.getvalue()st.download_button(label="å¯¼å‡ºCSVï¼ˆçº¯æ•°å€¼ï¼‰",data=csv_bytes,file_name=f"é”€é‡ä¸‹æ»‘å•†å“_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",mime="text/csv",help="å¯¼å‡ºçº¯æ•°å€¼CSVï¼ˆæ— Â¥ã€%ç¬¦å·ï¼‰ï¼Œå¯ç”¨Excelç›´æ¥æ‰“å¼€å’Œè®¡ç®—")else:st.info("æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„é”€é‡ä¸‹æ»‘å•†å“")exceptExceptionase:st.error(f"è¯Šæ–­å¤±è´¥:{str(e)}")importtracebackst.error(traceback.format_exc())#Tab2:å®¢å•ä»·å½’å› åˆ†æwithdiagnostic_tabs[1]:st.markdown("###å®¢å•ä»·ä¸‹æ»‘å½’å› åˆ†æ")#æ·»åŠ å®¢å•ä»·å®šä¹‰è¯´æ˜withst.expander("å®¢å•ä»·å®šä¹‰ä¸è¯´æ˜",expanded=False):st.markdown("""**å®¢å•ä»·å®šä¹‰**ï¼š-**å®¢å•ä»·**=è®¢å•æ€»é‡‘é¢Ã·è®¢å•æ•°é‡-åæ˜ å¹³å‡æ¯ç¬”è®¢å•çš„æ¶ˆè´¹é‡‘é¢**åˆ†æç»´åº¦**ï¼š-**æŒ‰å‘¨åˆ†æ**ï¼šå¯¹æ¯”ç›¸é‚»å‘¨çš„å®¢å•ä»·å˜åŒ–ï¼ˆå¦‚ç¬¬39å‘¨vsç¬¬40å‘¨ï¼‰-**æŒ‰æ—¥åˆ†æ**ï¼šå¯¹æ¯”ç›¸é‚»æ—¥çš„å®¢å•ä»·å˜åŒ–ï¼ˆå¦‚09-29vs09-30ï¼‰**åˆ—åè¯´æ˜**ï¼š-**ä¹‹å‰å®¢å•ä»·**ï¼šæ—¶é—´ä¸Šæ›´æ—©çš„å‘¨æœŸï¼ˆå¯¹æ¯”åŸºå‡†ï¼‰-**å½“å‰å®¢å•ä»·**ï¼šæ—¶é—´ä¸Šæ›´æ–°çš„å‘¨æœŸï¼ˆå½“å‰çŠ¶æ€ï¼‰-**ä¸‹æ»‘TOPå•†å“**ï¼šå½“å‰æœŸé”€å”®é¢æœ€é«˜çš„å‰5ä¸ªå•†å“ï¼Œæ˜¾ç¤ºã€åˆ†ç±»ã€‘å•†å“å(å•ä»·)**é—®é¢˜ç­‰çº§**ï¼š-ğŸ”´**ä¸¥é‡**ï¼šå®¢å•ä»·ä¸‹æ»‘â‰¥10%-ğŸŸ **è­¦å‘Š**ï¼šå®¢å•ä»·ä¸‹æ»‘<10%""")#ğŸ†•P2ä¼˜åŒ–:æ·»åŠ å‘¨æœŸé€‰æ‹©åŠŸèƒ½col1,col2=st.columns(2)withcol1:price_period=st.selectbox("åˆ†æç²’åº¦",["week","daily"],format_func=lambdax:"æŒ‰å‘¨åˆ†æ"ifx=="week"else"æŒ‰æ—¥åˆ†æ",key="price_period",index=0#é»˜è®¤é€‰æ‹©"æŒ‰å‘¨åˆ†æ")withcol2:price_threshold=st.slider("å®¢å•ä»·ä¸‹æ»‘é˜ˆå€¼%",min_value=-30.0,max_value=-1.0,value=-5.0,step=1.0,key="price_threshold")#ğŸ†•P2ä¼˜åŒ–:çµæ´»å‘¨æœŸå¯¹æ¯”é€‰æ‹©st.markdown("####ğŸ“…é€‰æ‹©å¯¹æ¯”å‘¨æœŸ")#æ·»åŠ åˆ†ææ¨¡å¼é€‰æ‹©analysis_mode=st.radio("åˆ†ææ¨¡å¼",["æ‰¹é‡åˆ†æï¼ˆæ‰€æœ‰ä¸‹æ»‘å‘¨æœŸï¼‰","ç²¾å‡†å¯¹æ¯”ï¼ˆæŒ‡å®šä¸¤ä¸ªå‘¨æœŸï¼‰"],key="price_analysis_mode",horizontal=True)current_period_idx=Nonecompare_period_idx=Noneifanalysis_mode=="ç²¾å‡†å¯¹æ¯”ï¼ˆæŒ‡å®šä¸¤ä¸ªå‘¨æœŸï¼‰":#è·å–å¯ç”¨å‘¨æœŸåˆ—è¡¨try:available_periods=diagnostic_engine.get_available_price_periods(time_period=price_period)iflen(available_periods)>=2:col3,col4=st.columns(2)withcol3:current_period_options={p['index']:f"{p['label']}({p['date_range']})"forpinavailable_periods}current_period_idx=st.selectbox("å½“å‰å‘¨æœŸ",options=list(current_period_options.keys()),format_func=lambdax:current_period_options[x],index=0,#é»˜è®¤é€‰æ‹©æœ€æ–°å‘¨æœŸkey="price_current_period")withcol4:compare_period_options={p['index']:f"{p['label']}({p['date_range']})"forpinavailable_periodsifp['index']>current_period_idx}compare_period_idx=st.selectbox("å¯¹æ¯”å‘¨æœŸ",options=list(compare_period_options.keys())ifcompare_period_optionselse[current_period_idx+1],format_func=lambdax:compare_period_options.get(x,f"ç¬¬{x}å‘¨æœŸ"),index=0,#é»˜è®¤é€‰æ‹©ç´§é‚»çš„ä¸Šä¸€å‘¨æœŸkey="price_compare_period")else:st.warning("âš ï¸æ•°æ®é‡ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œå‘¨æœŸå¯¹æ¯”")exceptExceptionase:st.error(f"è·å–å‘¨æœŸåˆ—è¡¨å¤±è´¥:{str(e)}")else:st.info("ğŸ’¡æ‰¹é‡åˆ†ææ¨¡å¼ï¼šè‡ªåŠ¨éå†æ‰€æœ‰å‘¨æœŸï¼Œæ‰¾å‡ºæ‰€æœ‰å®¢å•ä»·ä¸‹æ»‘çš„å‘¨æœŸ")ifst.button("ğŸ”å¼€å§‹å½’å› ",key="btn_price"):withst.spinner("æ­£åœ¨åˆ†æå®¢å•ä»·ä¸‹æ»‘åŸå› ..."):try:#ğŸ†•ä½¿ç”¨æ–°çš„åˆ†Sheetæ–¹æ³•sheets_data=diagnostic_engine.diagnose_customer_price_decline_by_sheets(time_period=price_period,threshold=price_threshold,current_period_index=current_period_idx,compare_period_index=compare_period_idx)#æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®has_data=any(len(df_sheet)>0fordf_sheetinsheets_data.values())ifhas_data:#ç»Ÿè®¡æ•°æ®è¡Œæ•°total_rows=sum(len(df_sheet)fordf_sheetinsheets_data.values()iflen(df_sheet)>0)st.success(f"âœ…åˆ†æå®Œæˆï¼å…±{len([dffordfinsheets_data.values()iflen(df)>0])}ä¸ªç»´åº¦ï¼Œ{total_rows}è¡Œæ•°æ®")#ä½¿ç”¨Tabå±•ç¤ºä¸‰ä¸ªç»´åº¦sheet_tabs=st.tabs(["ğŸ“Šå®¢å•ä»·å˜åŒ–","ğŸ“‰ä¸‹æ»‘å•†å“åˆ†æ","ğŸ“ˆä¸Šæ¶¨å•†å“åˆ†æ"])#Tab1:å®¢å•ä»·å˜åŒ–withsheet_tabs[0]:price_change_df=sheets_data.get('å®¢å•ä»·å˜åŒ–',pd.DataFrame())iflen(price_change_df)>0:st.markdown("####å®¢å•ä»·å˜åŒ–æ±‡æ€»")st.dataframe(price_change_df,use_container_width=True,height=300)else:st.info("æš‚æ— æ•°æ®")#Tab2:ä¸‹æ»‘å•†å“åˆ†æwithsheet_tabs[1]:declining_df=sheets_data.get('ä¸‹æ»‘å•†å“åˆ†æ',pd.DataFrame())iflen(declining_df)>0:st.markdown("####TOP5é—®é¢˜å•†å“")st.markdown("*åªåŒ…å«å”®ç½„ã€æ¶¨ä»·å¯¼è‡´é”€é‡é™ã€é”€é‡ä¸‹æ»‘ç­‰é—®é¢˜å•†å“*")st.dataframe(declining_df,use_container_width=True,height=400)else:st.info("æš‚æ— ä¸‹æ»‘å•†å“")#Tab3:ä¸Šæ¶¨å•†å“åˆ†æwithsheet_tabs[2]:rising_df=sheets_data.get('ä¸Šæ¶¨å•†å“åˆ†æ',pd.DataFrame())iflen(rising_df)>0:st.markdown("####TOP5ä¼˜åŠ¿å•†å“")st.markdown("*åªåŒ…å«æ¶¨ä»·(é”€é‡å¢)ã€é™ä»·ä¿ƒé”€æˆåŠŸã€é”€é‡å¢é•¿ç­‰ä¼˜åŠ¿å•†å“*")st.dataframe(rising_df,use_container_width=True,height=400)else:st.info("æš‚æ— ä¸Šæ¶¨å•†å“")#å¯¼å‡ºåŠŸèƒ½-æä¾›Excelå’ŒCSVä¸¤ç§æ ¼å¼st.markdown("---")st.markdown("###ğŸ“¥å¯¼å‡ºæ•°æ®")col1,col2=st.columns(2)#Excelå¯¼å‡ºï¼ˆåˆ†Sheetï¼‰withcol1:fromioimportBytesIO#å‡†å¤‡Excelå¯¼å‡ºexcel_buffer=BytesIO()withpd.ExcelWriter(excel_buffer,engine='openpyxl')aswriter:forsheet_name,df_sheetinsheets_data.items():iflen(df_sheet)>0:#æ¸…ç†æ•°æ®ä¸­çš„Â¥ç¬¦å·ç­‰æ ¼å¼export_df=df_sheet.copy()forcolinexport_df.columns:ifexport_df[col].dtype=='object':sample_value=export_df[col].iloc[0]iflen(export_df)>0else""ifisinstance(sample_value,str)and'Â¥'insample_value:try:export_df[col]=(export_df[col].astype(str).str.replace('Â¥','').str.replace(',','').str.replace('N/A','0').replace('','0').astype(float))except:passexport_df.to_excel(writer,sheet_name=sheet_name,index=False)excel_bytes=excel_buffer.getvalue()st.download_button(label="â¬‡ï¸å¯¼å‡ºExcelï¼ˆåˆ†Sheetï¼‰",data=excel_bytes,file_name=f"å®¢å•ä»·å½’å› åˆ†æ_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx",mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",help="Excelæ–‡ä»¶åŒ…å«3ä¸ªSheetï¼šå®¢å•ä»·å˜åŒ–ã€ä¸‹æ»‘å•†å“åˆ†æã€ä¸Šæ¶¨å•†å“åˆ†æ")#CSVå¯¼å‡ºï¼ˆåˆå¹¶æ‰€æœ‰æ•°æ®ï¼‰withcol2:#è·å–åŸå§‹çš„åˆå¹¶æ•°æ®result=diagnostic_engine.diagnose_customer_price_decline(time_period=price_period,threshold=price_threshold,current_period_index=current_period_idx,compare_period_index=compare_period_idx)iflen(result)>0:#å‡†å¤‡CSVå¯¼å‡ºæ•°æ®export_df=result.copy()#æ¸…ç†æ•°æ®forcolinexport_df.columns:ifexport_df[col].dtype=='object':sample_value=export_df[col].iloc[0]iflen(export_df)>0else""ifisinstance(sample_value,str)and'Â¥'insample_value:try:export_df[col]=(export_df[col].astype(str).str.replace('Â¥','').str.replace(',','').str.replace('N/A','0').replace('','0').astype(float))except:pass#ç”ŸæˆCSV-ä½¿ç”¨BOMç¼–ç ç¡®ä¿Excelè¯†åˆ«ä¸­æ–‡csv_buffer=BytesIO()csv_buffer.write('\ufeff'.encode('utf-8'))#BOMæ ‡è®°csv_string=export_df.to_csv(index=False)csv_buffer.write(csv_string.encode('utf-8'))csv_bytes=csv_buffer.getvalue()st.download_button(label="â¬‡ï¸å¯¼å‡ºCSVï¼ˆå•æ–‡ä»¶ï¼‰",data=csv_bytes,file_name=f"å®¢å•ä»·å½’å› _{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",mime="text/csv",help="CSVæ–‡ä»¶åŒ…å«æ‰€æœ‰å­—æ®µï¼ˆå•ä¸ªæ–‡ä»¶ï¼‰")else:st.info("âœ¨æœªå‘ç°å®¢å•ä»·æ˜æ˜¾ä¸‹æ»‘å‘¨æœŸ")exceptExceptionase:st.error(f"âŒåˆ†æå¤±è´¥:{str(e)}")importtracebackst.code(traceback.format_exc())#Tab3:è´Ÿæ¯›åˆ©å•†å“é¢„è­¦withdiagnostic_tabs[2]:st.markdown("###ğŸš¨è´Ÿæ¯›åˆ©å•†å“é¢„è­¦")st.info("ğŸ’¡è‡ªåŠ¨è¯†åˆ«å”®ä»·ä½äºæˆæœ¬çš„å•†å“ï¼Œå¸®åŠ©åŠæ—¶æ­¢æŸ")ifst.button("ğŸ”ç«‹å³æ£€æµ‹",key="btn_margin"):withst.spinner("æ­£åœ¨æ£€æµ‹è´Ÿæ¯›åˆ©å•†å“..."):try:result=diagnostic_engine.diagnose_negative_margin_products()iflen(result)>0:total_loss=result['ç´¯è®¡äºæŸé¢'].sum()st.error(f"âš ï¸å‘ç°{len(result)}ä¸ªè´Ÿæ¯›åˆ©å•†å“ï¼Œç´¯è®¡äºæŸÂ¥{abs(total_loss):.2f}")st.dataframe(result.style.apply(lambdax:['background-color:#ffcccc'ifv=='ğŸ”´ä¸¥é‡'else'background-color:#ffe6cc'ifv=='ğŸŸ è­¦å‘Š'else''forvinx],subset=['é—®é¢˜ç­‰çº§']),use_container_width=True,height=400)csv=result.to_csv(index=False,encoding='utf-8-sig')st.download_button(label="â¬‡ï¸å¯¼å‡ºCSV",data=csv,file_name=f"è´Ÿæ¯›åˆ©å•†å“_{datetime.now().strftime('%Y%m%d')}.csv",mime="text/csv")else:st.success("âœ…æœªå‘ç°è´Ÿæ¯›åˆ©å•†å“ï¼Œç»è¥å¥åº·ï¼")exceptExceptionase:st.error(f"âŒæ£€æµ‹å¤±è´¥:{str(e)}")#Tab4:é«˜é…é€è´¹è®¢å•ä¼˜åŒ–withdiagnostic_tabs[3]:st.markdown("###ğŸššé«˜é…é€è´¹è®¢å•è¯Šæ–­")col1,col2=st.columns(2)withcol1:fee_threshold=st.slider("é…é€è´¹å æ¯”é˜ˆå€¼%",min_value=10.0,max_value=50.0,value=20.0,step=5.0,key="fee_threshold")withcol2:st.metric("æ­£å¸¸é…é€è´¹å æ¯”","<15%",delta="ä¼˜ç§€",delta_color="normal")ifst.button("ğŸ”å¼€å§‹è¯Šæ–­",key="btn_delivery"):withst.spinner("æ­£åœ¨åˆ†æé«˜é…é€è´¹è®¢å•..."):try:result=diagnostic_engine.diagnose_high_delivery_fee_orders(threshold=fee_threshold)iflen(result)>0:st.warning(f"âš ï¸å‘ç°{len(result)}ä¸ªåœ°å€é…é€è´¹å æ¯”è¿‡é«˜")st.dataframe(result,use_container_width=True,height=400)csv=result.to_csv(index=False,encoding='utf-8-sig')st.download_button(label="â¬‡ï¸å¯¼å‡ºCSV",data=csv,file_name=f"é«˜é…é€è´¹è®¢å•_{datetime.now().strftime('%Y%m%d')}.csv",mime="text/csv")else:st.success("âœ…é…é€è´¹æ§åˆ¶è‰¯å¥½ï¼Œæ— å¼‚å¸¸è®¢å•")exceptExceptionase:st.error(f"âŒè¯Šæ–­å¤±è´¥:{str(e)}")#Tab5:å•†å“è§’è‰²å¤±è¡¡withdiagnostic_tabs[4]:st.markdown("###âš–ï¸æµé‡å“&åˆ©æ¶¦å“å¤±è¡¡è¯Šæ–­")st.info("ğŸ’¡æ£€æµ‹å„åœºæ™¯ä¸­æµé‡å“å’Œåˆ©æ¶¦å“çš„é…æ¯”æ˜¯å¦åˆç†")ifst.button("ğŸ”å¼€å§‹æ£€æµ‹",key="btn_balance"):withst.spinner("æ­£åœ¨åˆ†æå•†å“è§’è‰²é…æ¯”..."):try:result=diagnostic_engine.diagnose_product_role_imbalance()iflen(result)>0:st.warning(f"âš ï¸å‘ç°{len(result)}ä¸ªåœºæ™¯å•†å“è§’è‰²å¤±è¡¡")st.dataframe(result,use_container_width=True,height=400)csv=result.to_csv(index=False,encoding='utf-8-sig')st.download_button(label="â¬‡ï¸å¯¼å‡ºCSV",data=csv,file_name=f"å•†å“è§’è‰²å¤±è¡¡_{datetime.now().strftime('%Y%m%d')}.csv",mime="text/csv")else:st.success("âœ…å„åœºæ™¯å•†å“è§’è‰²é…æ¯”åˆç†")exceptExceptionase:st.error(f"âŒæ£€æµ‹å¤±è´¥:{str(e)}")#Tab6:å¼‚å¸¸æ³¢åŠ¨é¢„è­¦withdiagnostic_tabs[5]:st.markdown("###ğŸ“Šå¼‚å¸¸æ³¢åŠ¨å•†å“é¢„è­¦")col1,col2=st.columns(2)withcol1:fluctuation_threshold=st.slider("æ³¢åŠ¨é˜ˆå€¼ï¼ˆç¯æ¯”%ï¼‰",min_value=30.0,max_value=100.0,value=50.0,step=10.0,key="fluctuation_threshold")withcol2:st.info("ğŸ“ˆçˆ†å•ï¼šé”€é‡ç¯æ¯”å¢é•¿è¶…è¿‡é˜ˆå€¼\nğŸ“‰æ»é”€ï¼šé”€é‡ç¯æ¯”ä¸‹é™è¶…è¿‡é˜ˆå€¼")ifst.button("ğŸ”å¼€å§‹é¢„è­¦",key="btn_fluctuation"):withst.spinner("æ­£åœ¨æ£€æµ‹å¼‚å¸¸æ³¢åŠ¨å•†å“..."):try:result=diagnostic_engine.diagnose_abnormal_fluctuation(threshold=fluctuation_threshold)iflen(result)>0:boom_count=len(result[result['å¼‚å¸¸ç±»å‹']=='ğŸ“ˆçˆ†å•'])slow_count=len(result[result['å¼‚å¸¸ç±»å‹']=='ğŸ“‰æ»é”€'])st.warning(f"âš ï¸å‘ç°{len(result)}ä¸ªå¼‚å¸¸æ³¢åŠ¨å•†å“ï¼ˆçˆ†å•:{boom_count}|æ»é”€:{slow_count}ï¼‰")st.dataframe(result.style.apply(lambdax:['background-color:#ccffcc'ifv=='ğŸ“ˆçˆ†å•'else'background-color:#ffcccc'forvinx],subset=['å¼‚å¸¸ç±»å‹']),use_container_width=True,height=400)csv=result.to_csv(index=False,encoding='utf-8-sig')st.download_button(label="â¬‡ï¸å¯¼å‡ºCSV",data=csv,file_name=f"å¼‚å¸¸æ³¢åŠ¨å•†å“_{datetime.now().strftime('%Y%m%d')}.csv",mime="text/csv")else:st.success("âœ…æœªå‘ç°å¼‚å¸¸æ³¢åŠ¨å•†å“")exceptExceptionase:st.error(f"âŒé¢„è­¦å¤±è´¥:{str(e)}")if__name__=="__main__":main()