"""
å±•ç¤ºé€»è¾‘é‡æ„æµ‹è¯•è„šæœ¬

æµ‹è¯•ç›®æ ‡ï¼š
1. éªŒè¯ä¸‹æ»‘å•†å“åªåŒ…å«é—®é¢˜å•†å“
2. éªŒè¯ä¸Šæ¶¨å•†å“åªåŒ…å«è¡¨ç°è‰¯å¥½çš„å•†å“
3. éªŒè¯å­—æ®µåç§°æ­£ç¡®æ€§
4. éªŒè¯æ•°æ®å‡†ç¡®æ€§
"""

import pandas as pd
import sys
from pathlib import Path

# æ·»åŠ è·¯å¾„
current_dir = Path(__file__).parent
sys.path.insert(0, str(current_dir))

# å¯¼å…¥é—®é¢˜è¯Šæ–­å¼•æ“
from é—®é¢˜è¯Šæ–­å¼•æ“ import ProblemDiagnosticEngine


def åˆ›å»ºæµ‹è¯•æ•°æ®():
    """åˆ›å»ºæµ‹è¯•æ•°æ®ï¼ŒåŒ…å«ä¸‹æ»‘å’Œä¸Šæ¶¨ä¸¤ç±»å•†å“"""
    data = []
    
    # æ¡ˆä¾‹1: å”®ç½„å•†å“ï¼ˆä¸‹æ»‘ï¼‰
    data.extend([
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '001', 'å•†å“åç§°': 'å•†å“A_å”®ç½„', 'å•†å“å®å”®ä»·': 100, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«1', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»1', 'å‰©ä½™åº“å­˜': 10},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '002', 'å•†å“åç§°': 'å•†å“A_å”®ç½„', 'å•†å“å®å”®ä»·': 100, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«1', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»1', 'å‰©ä½™åº“å­˜': 0},
    ])
    
    # æ¡ˆä¾‹2: æ¶¨ä»·é”€é‡å¢ï¼ˆä¸Šæ¶¨ï¼‰
    data.extend([
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '003', 'å•†å“åç§°': 'å•†å“B_æ¶¨ä»·é”€é‡å¢', 'å•†å“å®å”®ä»·': 80, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«1', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»1', 'å‰©ä½™åº“å­˜': 50},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '004', 'å•†å“åç§°': 'å•†å“B_æ¶¨ä»·é”€é‡å¢', 'å•†å“å®å”®ä»·': 80, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«1', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»1', 'å‰©ä½™åº“å­˜': 50},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '005', 'å•†å“åç§°': 'å•†å“B_æ¶¨ä»·é”€é‡å¢', 'å•†å“å®å”®ä»·': 90, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«1', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»1', 'å‰©ä½™åº“å­˜': 45},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '006', 'å•†å“åç§°': 'å•†å“B_æ¶¨ä»·é”€é‡å¢', 'å•†å“å®å”®ä»·': 90, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«1', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»1', 'å‰©ä½™åº“å­˜': 45},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '007', 'å•†å“åç§°': 'å•†å“B_æ¶¨ä»·é”€é‡å¢', 'å•†å“å®å”®ä»·': 90, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«1', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»1', 'å‰©ä½™åº“å­˜': 45},
    ])
    
    # æ¡ˆä¾‹3: æ¶¨ä»·å¯¼è‡´é”€é‡é™ï¼ˆä¸‹æ»‘ï¼‰
    data.extend([
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '008', 'å•†å“åç§°': 'å•†å“C_æ¶¨ä»·é”€é‡é™', 'å•†å“å®å”®ä»·': 50, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 30},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '009', 'å•†å“åç§°': 'å•†å“C_æ¶¨ä»·é”€é‡é™', 'å•†å“å®å”®ä»·': 50, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 30},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '010', 'å•†å“åç§°': 'å•†å“C_æ¶¨ä»·é”€é‡é™', 'å•†å“å®å”®ä»·': 50, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 30},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '011', 'å•†å“åç§°': 'å•†å“C_æ¶¨ä»·é”€é‡é™', 'å•†å“å®å”®ä»·': 60, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 28},
    ])
    
    # æ¡ˆä¾‹4: é™ä»·ä¿ƒé”€æˆåŠŸï¼ˆä¸Šæ¶¨ï¼‰
    data.extend([
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '012', 'å•†å“åç§°': 'å•†å“D_é™ä»·ä¿ƒé”€', 'å•†å“å®å”®ä»·': 120, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 40},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '013', 'å•†å“åç§°': 'å•†å“D_é™ä»·ä¿ƒé”€', 'å•†å“å®å”®ä»·': 100, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 37},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '014', 'å•†å“åç§°': 'å•†å“D_é™ä»·ä¿ƒé”€', 'å•†å“å®å”®ä»·': 100, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 37},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '015', 'å•†å“åç§°': 'å•†å“D_é™ä»·ä¿ƒé”€', 'å•†å“å®å”®ä»·': 100, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«2', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»2', 'å‰©ä½™åº“å­˜': 37},
    ])
    
    # æ¡ˆä¾‹5: é”€é‡ä¸‹æ»‘ï¼ˆä¸‹æ»‘ï¼‰
    data.extend([
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '016', 'å•†å“åç§°': 'å•†å“E_é”€é‡ä¸‹æ»‘', 'å•†å“å®å”®ä»·': 70, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«3', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»3', 'å‰©ä½™åº“å­˜': 60},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '017', 'å•†å“åç§°': 'å•†å“E_é”€é‡ä¸‹æ»‘', 'å•†å“å®å”®ä»·': 70, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«3', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»3', 'å‰©ä½™åº“å­˜': 60},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '018', 'å•†å“åç§°': 'å•†å“E_é”€é‡ä¸‹æ»‘', 'å•†å“å®å”®ä»·': 70, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«3', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»3', 'å‰©ä½™åº“å­˜': 60},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-01'), 'è®¢å•ID': '019', 'å•†å“åç§°': 'å•†å“E_é”€é‡ä¸‹æ»‘', 'å•†å“å®å”®ä»·': 70, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«3', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»3', 'å‰©ä½™åº“å­˜': 60},
        {'æ—¥æœŸ': pd.Timestamp('2025-01-02'), 'è®¢å•ID': '020', 'å•†å“åç§°': 'å•†å“E_é”€é‡ä¸‹æ»‘', 'å•†å“å®å”®ä»·': 70, 'ä¸€çº§åˆ†ç±»å': 'ç±»åˆ«3', 'ä¸‰çº§åˆ†ç±»å': 'å­ç±»3', 'å‰©ä½™åº“å­˜': 59},
    ])
    
    return pd.DataFrame(data)


def æµ‹è¯•å®¢å•ä»·å½’å› åˆ†æ():
    """æµ‹è¯•å®¢å•ä»·å½’å› åˆ†æçš„è¾“å‡ºç»“æ„"""
    print("\n" + "="*60)
    print("æµ‹è¯•1: å®¢å•ä»·å½’å› åˆ†æ - æ•°æ®å¤„ç†å‡½æ•°æµ‹è¯•")
    print("="*60)
    
    df = åˆ›å»ºæµ‹è¯•æ•°æ®()
    engine = ProblemDiagnosticEngine(df)
    
    # ç›´æ¥è°ƒç”¨å†…éƒ¨å‡½æ•°æµ‹è¯•æ•°æ®å¤„ç†
    current_data = df[df['æ—¥æœŸ'] == pd.Timestamp('2025-01-02')]
    compare_data = df[df['æ—¥æœŸ'] == pd.Timestamp('2025-01-01')]
    
    result_dict = engine._get_top_declining_products_with_reason(
        current_data=current_data,
        compare_data=compare_data,
        top_n=5
    )
    
    print(f"\nâœ“ æˆåŠŸè°ƒç”¨_get_top_declining_products_with_reason")
    print(f"\nè¿”å›å­—å…¸çš„é”®:")
    for key in sorted(result_dict.keys()):
        print(f"  - {key}")
    
    for key in sorted(result_dict.keys()):
        print(f"  - {key}")
    
    # éªŒè¯å­—æ®µå
    expected_fields = {
        'ä¸‹æ»‘å•†å“': ['å•†å“åç§°', 'åˆ†ç±»', 'å½“å‰å•ä»·', 'ä¹‹å‰å•ä»·', 'å•ä»·å˜åŒ–', 'é”€é‡å˜åŒ–', 'é—®é¢˜åŸå› '],
        'ä¸Šæ¶¨å•†å“': ['å•†å“åç§°', 'åˆ†ç±»', 'å½“å‰å•ä»·', 'ä¹‹å‰å•ä»·', 'å•ä»·å˜åŒ–', 'é”€é‡å˜åŒ–', 'å¢é•¿åŸå› ']
    }
    
    all_passed = True
    for category, fields in expected_fields.items():
        print(f"\næ£€æŸ¥{category}å­—æ®µ:")
        for field in fields:
            full_key = f'{category}-{field}'
            if full_key in result_dict:
                print(f"  âœ“ {full_key}")
            else:
                print(f"  âŒ ç¼ºå°‘å­—æ®µ: {full_key}")
                all_passed = False
    
    # æ£€æŸ¥æ•°æ®å†…å®¹
    print(f"\næ•°æ®å†…å®¹ç¤ºä¾‹:")
    
    print(f"\nä¸‹æ»‘å•†å“:")
    for i in range(min(3, len(result_dict.get('ä¸‹æ»‘å•†å“-å•†å“åç§°', [])))):
        name = result_dict['ä¸‹æ»‘å•†å“-å•†å“åç§°'][i]
        reason = result_dict['ä¸‹æ»‘å•†å“-é—®é¢˜åŸå› '][i]
        if name:
            print(f"  å•†å“{i+1}: {name} - {reason}")
    
    print(f"\nä¸Šæ¶¨å•†å“:")
    for i in range(min(3, len(result_dict.get('ä¸Šæ¶¨å•†å“-å•†å“åç§°', [])))):
        name = result_dict['ä¸Šæ¶¨å•†å“-å•†å“åç§°'][i]
        reason = result_dict['ä¸Šæ¶¨å•†å“-å¢é•¿åŸå› '][i]
        if name:
            print(f"  å•†å“{i+1}: {name} - {reason}")
    
    # éªŒè¯é€»è¾‘
    print(f"\né€»è¾‘éªŒè¯:")
    
    # æ£€æŸ¥ä¸‹æ»‘å•†å“çš„åŸå› 
    declining_reasons = [r for r in result_dict.get('ä¸‹æ»‘å•†å“-é—®é¢˜åŸå› ', []) if r]
    
    print(f"  ä¸‹æ»‘å•†å“åŸå› : {declining_reasons}")
    
    # ä¸‹æ»‘åŸå› åº”è¯¥åªåŒ…å«é—®é¢˜ç±»å‹
    problem_keywords = ['å”®ç½„', 'æ¶¨ä»·å¯¼è‡´é”€é‡é™', 'é™ä»·ä»é™é‡', 'é”€é‡ä¸‹æ»‘', 'åº“å­˜ä¸è¶³', 'æ»é”€']
    good_keywords = ['æ¶¨ä»·(é”€é‡å¢)', 'é™ä»·ä¿ƒé”€æˆåŠŸ', 'é”€é‡å¢é•¿']
    
    has_problem = False
    has_good_in_decline = False
    for reason in declining_reasons:
        if any(k in reason for k in problem_keywords):
            has_problem = True
        if any(k in reason for k in good_keywords):
            has_good_in_decline = True
    
    if has_good_in_decline:
        print(f"  âŒ ä¸‹æ»‘å•†å“ä¸­åŒ…å«éé—®é¢˜åŸå› ")
        all_passed = False
    else:
        print(f"  âœ“ ä¸‹æ»‘å•†å“åªåŒ…å«é—®é¢˜åŸå› ")
    
    # æ£€æŸ¥ä¸Šæ¶¨å•†å“çš„åŸå› 
    rising_reasons = [r for r in result_dict.get('ä¸Šæ¶¨å•†å“-å¢é•¿åŸå› ', []) if r]
    
    print(f"  ä¸Šæ¶¨å•†å“åŸå› : {rising_reasons}")
    
    has_good_reason = False
    has_problem_in_rise = False
    for reason in rising_reasons:
        if any(k in reason for k in good_keywords):
            has_good_reason = True
        if any(k in reason for k in problem_keywords):
            has_problem_in_rise = True
    
    if has_problem_in_rise:
        print(f"  âŒ ä¸Šæ¶¨å•†å“ä¸­åŒ…å«é—®é¢˜åŸå› ")
        all_passed = False
    else:
        print(f"  âœ“ ä¸Šæ¶¨å•†å“åªåŒ…å«ä¼˜åŠ¿åŸå› ")
    
    if all_passed:
        print(f"\nâœ… å®¢å•ä»·å½’å› åˆ†ææµ‹è¯•é€šè¿‡")
    else:
        print(f"\nâŒ å®¢å•ä»·å½’å› åˆ†ææµ‹è¯•å¤±è´¥")
    
    return all_passed


def æµ‹è¯•é”€é‡ä¸‹æ»‘è¯Šæ–­():
    """æµ‹è¯•é”€é‡ä¸‹æ»‘è¯Šæ–­çš„è¾“å‡ºç»“æ„"""
    print("\n" + "="*60)
    print("æµ‹è¯•2: æ•°æ®å­—æ®µä¸€è‡´æ€§éªŒè¯")
    print("="*60)
    
    df = åˆ›å»ºæµ‹è¯•æ•°æ®()
    engine = ProblemDiagnosticEngine(df)
    
    # ç›´æ¥è°ƒç”¨å†…éƒ¨å‡½æ•°æµ‹è¯•æ•°æ®å¤„ç†
    current_data = df[df['æ—¥æœŸ'] == pd.Timestamp('2025-01-02')]
    compare_data = df[df['æ—¥æœŸ'] == pd.Timestamp('2025-01-01')]
    
    result_dict = engine._get_top_declining_products_with_reason(
        current_data=current_data,
        compare_data=compare_data,
        top_n=5
    )
    
    print(f"\nâœ“ æˆåŠŸè°ƒç”¨_get_top_declining_products_with_reason")
    
    # éªŒè¯æ•°æ®é•¿åº¦ä¸€è‡´æ€§
    print(f"\næ•°æ®é•¿åº¦éªŒè¯:")
    
    all_passed = True
    
    # æ£€æŸ¥ä¸‹æ»‘å•†å“æ•°æ®
    declining_fields = ['å•†å“åç§°', 'åˆ†ç±»', 'å½“å‰å•ä»·', 'ä¹‹å‰å•ä»·', 'å•ä»·å˜åŒ–', 'é”€é‡å˜åŒ–', 'é—®é¢˜åŸå› ']
    declining_lengths = {}
    for field in declining_fields:
        key = f'ä¸‹æ»‘å•†å“-{field}'
        length = len(result_dict.get(key, []))
        declining_lengths[field] = length
    
    print(f"  ä¸‹æ»‘å•†å“å­—æ®µé•¿åº¦: {declining_lengths}")
    lengths_set = set(declining_lengths.values())
    if len(lengths_set) == 1:
        print(f"  âœ“ ä¸‹æ»‘å•†å“æ‰€æœ‰å­—æ®µé•¿åº¦ä¸€è‡´: {list(lengths_set)[0]}")
    else:
        print(f"  âŒ ä¸‹æ»‘å•†å“å­—æ®µé•¿åº¦ä¸ä¸€è‡´")
        all_passed = False
    
    # æ£€æŸ¥ä¸Šæ¶¨å•†å“æ•°æ®
    rising_fields = ['å•†å“åç§°', 'åˆ†ç±»', 'å½“å‰å•ä»·', 'ä¹‹å‰å•ä»·', 'å•ä»·å˜åŒ–', 'é”€é‡å˜åŒ–', 'å¢é•¿åŸå› ']
    rising_lengths = {}
    for field in rising_fields:
        key = f'ä¸Šæ¶¨å•†å“-{field}'
        length = len(result_dict.get(key, []))
        rising_lengths[field] = length
    
    print(f"  ä¸Šæ¶¨å•†å“å­—æ®µé•¿åº¦: {rising_lengths}")
    lengths_set = set(rising_lengths.values())
    if len(lengths_set) == 1:
        print(f"  âœ“ ä¸Šæ¶¨å•†å“æ‰€æœ‰å­—æ®µé•¿åº¦ä¸€è‡´: {list(lengths_set)[0]}")
    else:
        print(f"  âŒ ä¸Šæ¶¨å•†å“å­—æ®µé•¿åº¦ä¸ä¸€è‡´")
        print(f"  âŒ ä¸Šæ¶¨å•†å“å­—æ®µé•¿åº¦ä¸ä¸€è‡´")
        all_passed = False
    
    if all_passed:
        print(f"\nâœ… æ•°æ®å­—æ®µä¸€è‡´æ€§éªŒè¯é€šè¿‡")
    else:
        print(f"\nâŒ æ•°æ®å­—æ®µä¸€è‡´æ€§éªŒè¯å¤±è´¥")
    
    return all_passed


def ä¸»æµ‹è¯•():
    """æ‰§è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\n" + "="*60)
    print("å±•ç¤ºé€»è¾‘é‡æ„æµ‹è¯•")
    print("="*60)
    print("\næµ‹è¯•ç›®æ ‡:")
    print("1. ä¸‹æ»‘å•†å“åªåŒ…å«é—®é¢˜å•†å“")
    print("2. ä¸Šæ¶¨å•†å“åªåŒ…å«è¡¨ç°è‰¯å¥½çš„å•†å“")
    print("3. å­—æ®µåç§°æ­£ç¡®ï¼ˆä¸‹æ»‘å•†å“-é—®é¢˜åŸå› ï¼Œä¸Šæ¶¨å•†å“-å¢é•¿åŸå› ï¼‰")
    print("4. æ•°æ®å‡†ç¡®æ€§éªŒè¯")
    
    results = []
    
    # æµ‹è¯•1: æ•°æ®ç»“æ„å’Œé€»è¾‘
    results.append(("æ•°æ®ç»“æ„å’Œé€»è¾‘éªŒè¯", æµ‹è¯•å®¢å•ä»·å½’å› åˆ†æ()))
    
    # æµ‹è¯•2: æ•°æ®å­—æ®µä¸€è‡´æ€§
    results.append(("æ•°æ®å­—æ®µä¸€è‡´æ€§éªŒè¯", æµ‹è¯•é”€é‡ä¸‹æ»‘è¯Šæ–­()))
    
    # æ±‡æ€»ç»“æœ
    print("\n" + "="*60)
    print("æµ‹è¯•ç»“æœæ±‡æ€»")
    print("="*60)
    
    all_passed = True
    for test_name, passed in results:
        status = "âœ… é€šè¿‡" if passed else "âŒ å¤±è´¥"
        print(f"{test_name}: {status}")
        if not passed:
            all_passed = False
    
    print("\n" + "="*60)
    if all_passed:
        print("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å±•ç¤ºé€»è¾‘é‡æ„æˆåŠŸï¼")
    else:
        print("âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥ä»£ç ")
    print("="*60)
    
    return all_passed


if __name__ == "__main__":
    ä¸»æµ‹è¯•()
