# 另一台电脑数据库同步指南

## 问题说明
两台电脑使用独立的 PostgreSQL 数据库，当前电脑已添加 `remaining_stock` 字段并修复了库存周转和滞销品统计功能，另一台电脑克隆代码后需要同步数据库结构。

---

## 🔧 解决方案：手动执行数据库迁移

### 步骤 1: 克隆仓库
```powershell
cd D:\Python\订单数据看板
git clone https://github.com/lichaokun0930/O2O-Analysis.git
cd O2O-Analysis
```

### 步骤 2: 添加 `remaining_stock` 字段到数据库
在 PowerShell 中执行以下 SQL 命令：

```powershell
# 方法1: 使用 psql 命令行工具
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "ALTER TABLE orders ADD COLUMN IF NOT EXISTS remaining_stock FLOAT DEFAULT 0;"
```

或者创建临时 Python 脚本执行：

```powershell
# 方法2: 创建并运行迁移脚本
@"
from sqlalchemy import create_engine, text
from database.config import get_db_config

config = get_db_config()
engine = create_engine(
    f"postgresql://{config['user']}:{config['password']}@{config['host']}:{config['port']}/{config['database']}"
)

with engine.connect() as conn:
    conn.execute(text('''
        ALTER TABLE orders 
        ADD COLUMN IF NOT EXISTS remaining_stock FLOAT DEFAULT 0;
    '''))
    conn.commit()
    print("✅ remaining_stock 字段添加成功！")
"@ | Out-File -Encoding UTF8 -FilePath add_remaining_stock.py

# 激活虚拟环境并运行
.\.venv\Scripts\Activate.ps1
python add_remaining_stock.py
```

### 步骤 3: 重新导入数据
如果另一台电脑的数据库已有历史数据，需要重新导入包含"剩余库存"列的 Excel 文件：

```powershell
# 清除导入历史（可选，如果需要重新导入）
python -c "from database.connection import get_db; from database.models import ImportHistory; db = next(get_db()); db.query(ImportHistory).delete(); db.commit(); print('✅ 导入历史已清除')"

# 重新导入数据
python 智能导入门店数据.py
# 选择包含"剩余库存"列的 Excel 文件进行导入
```

### 步骤 4: 验证字段存在
```powershell
# 检查字段是否添加成功
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "\d orders" | Select-String "remaining_stock"
```

如果输出类似以下内容，说明字段添加成功：
```
 remaining_stock     | double precision |           | default 0
```

### 步骤 5: 启动看板验证
```powershell
.\启动看板.ps1
```

访问 http://localhost:8050，进入 **数据库数据源** → **一级分类销售趋势** → **详细数据明细**，检查"滞销品统计"和"库存周转"列是否正常显示数据。

---

## ⚠️ 重要提示

1. **数据库密码**: 确保另一台电脑的 `.env` 文件中数据库密码正确（默认 `308352588`）

2. **Excel 数据要求**: 
   - 必须包含 **"剩余库存"** 列
   - 如果没有此列，滞销品统计和库存周转仍会显示 "-"

3. **两台电脑数据同步**:
   - 两台电脑的数据库完全独立
   - 需要在另一台电脑上重新导入相同的 Excel 数据
   - 或者考虑使用数据库备份/还原功能同步数据

4. **自动化选项**（可选）:
   如果经常需要同步，可以创建数据库迁移脚本：
   ```powershell
   # 使用已存在的 重建数据库表.py
   python 重建数据库表.py
   # 这会自动创建包含 remaining_stock 字段的表结构
   ```

---

## 📋 快速检查清单

- [ ] Git 克隆仓库成功
- [ ] 执行 SQL 添加 `remaining_stock` 字段
- [ ] 验证字段存在（`\d orders`）
- [ ] 重新导入包含"剩余库存"列的 Excel 数据
- [ ] 启动看板验证功能正常
- [ ] 确认"滞销品统计"和"库存周转"显示数据

---

## 🆘 常见问题

**Q: 执行 ALTER TABLE 时提示 "column already exists"**
A: 说明字段已存在，可以跳过此步骤

**Q: 滞销品统计和库存周转仍显示 "-"**
A: 检查以下几点：
1. 数据库中是否有 `remaining_stock` 字段（执行 `\d orders` 查看）
2. 导入的 Excel 文件是否包含"剩余库存"列
3. 数据是否成功导入（检查 `orders` 表的 `remaining_stock` 列是否有数值）

**Q: 如何查看当前数据库中的库存数据？**
```powershell
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "SELECT COUNT(*) as total, COUNT(remaining_stock) FILTER (WHERE remaining_stock > 0) as has_stock FROM orders;"
```

**Q: 能否直接复制当前电脑的数据库到另一台？**
A: 可以，使用数据库导出导入功能：
```powershell
# 当前电脑导出
.\一键导出数据库.bat

# 复制生成的 .sql 文件到另一台电脑
# 另一台电脑导入
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -f "数据库导出/o2o_dashboard_full_XXXXXXXX_XXXXXX.sql"
```
