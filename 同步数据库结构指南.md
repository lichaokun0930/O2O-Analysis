# 数据库结构同步完整指南

## 背景

当从B电脑克隆代码到A电脑时,如果B电脑对数据库表结构进行了迭代(添加了新字段),A电脑的数据库需要同步这些变更。

**典型场景:**
- B电脑迭代了orders表,添加了`stock`, `remaining_stock`, `delivery_distance`, `store_id`, `city`等字段
- A电脑克隆代码后,models.py已有字段定义,但数据库表还没有这些列
- 需要执行ALTER TABLE命令添加缺失字段

---

## 🚀 快速同步方案 (推荐)

### 方案A: 一键自动同步脚本 ⭐

```powershell
# 激活虚拟环境
.\.venv\Scripts\Activate.ps1

# 执行自动同步脚本
python 同步数据库结构.py
```

**脚本功能:**
- ✅ 自动检测缺失字段
- ✅ 批量添加所有字段
- ✅ 自动验证同步结果
- ✅ 友好的进度提示

**输出示例:**
```
============================================================
数据库结构自动同步
============================================================

检查字段: stock
  + 已添加字段: stock (INTEGER)

检查字段: remaining_stock
  ✓ 字段已存在: remaining_stock

检查字段: delivery_distance
  + 已添加字段: delivery_distance (FLOAT)

检查字段: store_id
  + 已添加字段: store_id (VARCHAR(100))

检查字段: city
  + 已添加字段: city (VARCHAR(100))

============================================================
同步结果
============================================================
已存在字段: 1 个
  - remaining_stock

新增字段: 4 个
  + stock
  + delivery_distance
  + store_id
  + city

当前orders表共有 44 个字段

============================================================
✓ 数据库结构同步完成!
============================================================
```

---

## 📋 缺失字段清单

models.py定义了以下字段,但数据库可能缺失:

| 字段名 | 数据类型 | 默认值 | 说明 |
|--------|----------|--------|------|
| `stock` | INTEGER | 0 | 库存数量 |
| `remaining_stock` | FLOAT | 0 | 剩余库存(精确到小数) |
| `delivery_distance` | FLOAT | 0 | 配送距离(公里) |
| `store_id` | VARCHAR(100) | NULL | 门店ID |
| `city` | VARCHAR(100) | NULL | 城市 |

---

## 🛠️ 手动同步方案

### 方案B: 执行SQL脚本

---

## 🛠️ 手动同步方案

### 方案B: 执行SQL命令

```powershell
# 使用psql命令行工具
$env:PGPASSWORD="308352588"

# 添加所有缺失字段
psql -U postgres -d o2o_dashboard -c "
ALTER TABLE orders ADD COLUMN IF NOT EXISTS stock INTEGER DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS remaining_stock FLOAT DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_distance FLOAT DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS store_id VARCHAR(100);
ALTER TABLE orders ADD COLUMN IF NOT EXISTS city VARCHAR(100);

COMMENT ON COLUMN orders.stock IS '库存';
COMMENT ON COLUMN orders.remaining_stock IS '剩余库存';
COMMENT ON COLUMN orders.delivery_distance IS '配送距离(公里)';
COMMENT ON COLUMN orders.store_id IS '门店ID';
COMMENT ON COLUMN orders.city IS '城市';
"
```

### 方案C: 使用Python脚本

创建临时脚本 `add_fields.py`:

```python
from sqlalchemy import create_engine, text
from database.config import get_db_config

config = get_db_config()
engine = create_engine(
    f"postgresql://{config['user']}:{config['password']}@{config['host']}:{config['port']}/{config['database']}"
)

fields = [
    "ALTER TABLE orders ADD COLUMN IF NOT EXISTS stock INTEGER DEFAULT 0;",
    "ALTER TABLE orders ADD COLUMN IF NOT EXISTS remaining_stock FLOAT DEFAULT 0;",
    "ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_distance FLOAT DEFAULT 0;",
    "ALTER TABLE orders ADD COLUMN IF NOT EXISTS store_id VARCHAR(100);",
    "ALTER TABLE orders ADD COLUMN IF NOT EXISTS city VARCHAR(100);"
]

with engine.connect() as conn:
    for sql in fields:
        conn.execute(text(sql))
    conn.commit()
    print("✅ 所有字段添加成功！")
```

执行:
```powershell
.\.venv\Scripts\Activate.ps1
python add_fields.py
```

---

## ✅ 验证同步结果

### 1. 检查字段是否存在

```powershell
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "\d orders" | Select-String "stock|delivery_distance|store_id|city"
```

期望输出:
```
 stock              | integer          |           | default 0
 remaining_stock    | double precision |           | default 0
 delivery_distance  | double precision |           | default 0
 store_id           | character varying(100) |      |
 city               | character varying(100) |      |
```

### 2. 检查字段总数

```powershell
python -c "from database.models import Order; from sqlalchemy import inspect; print(f'models.py字段数: {len(inspect(Order).columns)}')"
```

期望输出: `models.py字段数: 44`

### 3. 启动看板验证功能

```powershell
.\启动看板.ps1
```

访问 http://localhost:8050，检查:
- **数据库数据源** → **一级分类销售趋势** → 滞销品统计和库存周转是否有数据
- 确认不再报错 `column orders.xxx does not exist`

---

## 📂 完整克隆流程

### 步骤1: 克隆仓库
---

## 📂 完整克隆流程 (新电脑首次使用)

### 步骤1: 克隆仓库

```powershell
cd D:\Python1\O2O_Analysis
git clone https://github.com/lichaokun0930/O2O-Analysis.git
cd O2O-Analysis\O2O数据分析\测算模型
```

### 步骤2: 同步数据库结构

**推荐方式:**
```powershell
.\.venv\Scripts\Activate.ps1
python 同步数据库结构.py
```

**或手动方式:**
```powershell
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "
ALTER TABLE orders ADD COLUMN IF NOT EXISTS stock INTEGER DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS remaining_stock FLOAT DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_distance FLOAT DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS store_id VARCHAR(100);
ALTER TABLE orders ADD COLUMN IF NOT EXISTS city VARCHAR(100);
"
```

### 步骤3: 重新导入数据

如果数据库已有历史数据,需要重新导入包含新字段的Excel:

```powershell
# (可选)清除导入历史
python -c "from database.connection import get_db; from database.models import ImportHistory; db = next(get_db()); db.query(ImportHistory).delete(); db.commit(); print('✅ 导入历史已清除')"

# 重新导入数据
python 智能导入门店数据.py
# 选择包含"剩余库存"列的Excel文件进行导入
```

### 步骤4: 验证功能

```powershell
.\启动看板.ps1
```

检查一级分类销售趋势中的滞销品统计和库存周转是否正常显示。

---

## ⚠️ 重要提示

### 1. 数据库密码
确保 `.env` 文件中数据库密码正确:
```
DB_PASSWORD=308352588
```

### 2. Excel数据要求
- 必须包含 **"剩余库存"** 列
- 如果没有此列,滞销品统计和库存周转仍会显示 "-"

### 3. 两台电脑数据同步
- 两台电脑的数据库完全独立
- 需要在新电脑上重新导入相同的Excel数据
- 或者使用数据库备份/还原功能同步数据

### 4. 字段名兼容性
代码已支持中英文字段名自动识别:
- 中文: `库存`, `剩余库存`
- 英文: `stock`, `remaining_stock`

无需担心字段名不匹配问题。

---

## 🆘 常见问题

### Q1: 执行ALTER TABLE时提示 "column already exists"
**A:** 说明字段已存在,可以跳过此步骤。

### Q2: 滞销品统计和库存周转仍显示 "-"
**A:** 检查以下几点:
1. 数据库中是否有字段:
   ```powershell
   psql -U postgres -d o2o_dashboard -c "\d orders"
   ```
2. 导入的Excel是否包含"剩余库存"列
3. 数据是否成功导入:
   ```powershell
   psql -U postgres -d o2o_dashboard -c "SELECT COUNT(*) as total, COUNT(remaining_stock) FILTER (WHERE remaining_stock > 0) as has_stock FROM orders;"
   ```

### Q3: 如何查看当前数据库字段列表?
```powershell
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'orders' 
ORDER BY ordinal_position;
"
```

### Q4: 能否直接复制数据库到另一台电脑?
**A:** 可以,使用数据库导出导入功能:

**当前电脑导出:**
```powershell
.\一键导出数据库.bat
```

**新电脑导入:**
```powershell
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -f "数据库导出/o2o_dashboard_full_XXXXXXXX_XXXXXX.sql"
```

### Q5: 同步脚本报错 "No module named 'database'"
**A:** 确保已激活虚拟环境:
```powershell
.\.venv\Scripts\Activate.ps1
```

---

## 📋 快速检查清单

克隆代码后按此清单验证:

- [ ] Git克隆仓库成功
- [ ] 执行 `python 同步数据库结构.py` 或手动添加字段
- [ ] 验证字段存在 (`\d orders`)
- [ ] models.py有44个字段
- [ ] 重新导入包含"剩余库存"列的Excel
- [ ] 启动看板验证功能正常
- [ ] 确认"滞销品统计"和"库存周转"显示数据

---

## 🔗 相关文档

- `models字段同步修复说明.md` - 详细的字段同步问题分析
- `新电脑完整配置指南.md` - 新电脑首次配置的完整流程
- `B电脑克隆清单.md` - B电脑克隆时需要注意的事项
- `数据结构统一标准.md` - 数据字段标准和业务逻辑
