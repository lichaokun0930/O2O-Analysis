# -*- coding: utf-8 -*-
import pandas as pd
import sys
import io
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

df = pd.read_excel('实际数据/金寨.xlsx')
df_meituan = df[df['渠道'] == '美团闪购'].copy()

print("=" * 80)
print("反推分析：您的计算 ¥13,716 vs 正确结果 ¥14,246.69")
print("差异：¥530.69")
print("=" * 80)

# 正确的计算
df_meituan['物流配送费'] = df_meituan['物流配送费'].fillna(0)
df_meituan['配送费减免金额'] = df_meituan['配送费减免金额'].fillna(0)
df_meituan['用户支付配送费'] = df_meituan['用户支付配送费'].fillna(0)

order_agg = df_meituan.groupby('订单ID').agg({
    '预计订单收入': 'sum',
    '成本': 'sum',
    '平台佣金': 'first',
    '物流配送费': 'first',
    '配送费减免金额': 'first',
    '用户支付配送费': 'first',
}).reset_index()

# 各组成部分
预计订单收入 = order_agg['预计订单收入'].sum()
成本 = order_agg['成本'].sum()
平台佣金 = order_agg['平台佣金'].sum()
物流配送费 = order_agg['物流配送费'].sum()
配送费减免 = order_agg['配送费减免金额'].sum()
用户支付配送费 = order_agg['用户支付配送费'].sum()

正确利润 = 预计订单收入 - 成本 - 平台佣金 - 物流配送费 - 配送费减免 + 用户支付配送费
您的利润 = 13716

差异 = 正确利润 - 您的利润

print(f"\n正确计算的各项金额：")
print(f"  预计订单收入:    +¥{预计订单收入:>12,.2f}")
print(f"  成本:            -¥{成本:>12,.2f}")
print(f"  平台佣金:        -¥{平台佣金:>12,.2f}")
print(f"  物流配送费:      -¥{物流配送费:>12,.2f}")
print(f"  配送费减免:      -¥{配送费减免:>12,.2f}")
print(f"  用户支付配送费:  +¥{用户支付配送费:>12,.2f}")
print(f"  {'=' * 50}")
print(f"  正确利润:         ¥{正确利润:>12,.2f}")
print(f"  您的利润:         ¥{您的利润:>12,.2f}")
print(f"  差异:             ¥{差异:>12,.2f}")

print(f"\n" + "=" * 80)
print("反推分析：可能的差异原因")
print("=" * 80)

# 尝试各种组合，看哪个能得到您的结果
可能性 = {}

# 可能1: 配送费减免金额没有扣除（即公式中没有 -配送费减免）
可能1 = 预计订单收入 - 成本 - 平台佣金 - 物流配送费 + 用户支付配送费
可能性['未扣除配送费减免'] = 可能1
print(f"\n可能1: 未扣除'配送费减免金额'")
print(f"  公式: 收入 - 成本 - 佣金 - 配送费 + 用户配送费")
print(f"  结果: ¥{可能1:,.2f}")
print(f"  与您的差异: ¥{abs(可能1 - 您的利润):,.2f}")

# 可能2: 用户支付配送费没有加上
可能2 = 预计订单收入 - 成本 - 平台佣金 - 物流配送费 - 配送费减免
可能性['未加用户支付配送费'] = 可能2
print(f"\n可能2: 未加上'用户支付配送费'")
print(f"  公式: 收入 - 成本 - 佣金 - 配送费 - 配送减免")
print(f"  结果: ¥{可能2:,.2f}")
print(f"  与您的差异: ¥{abs(可能2 - 您的利润):,.2f}")

# 可能3: 配送相关项计算错误
可能3 = 预计订单收入 - 成本 - 平台佣金 - 物流配送费
可能性['未处理任何配送优化'] = 可能3
print(f"\n可能3: 未处理任何配送费优化项")
print(f"  公式: 收入 - 成本 - 佣金 - 配送费")
print(f"  结果: ¥{可能3:,.2f}")
print(f"  与您的差异: ¥{abs(可能3 - 您的利润):,.2f}")

# 可能4: 使用了配送净成本概念
配送净成本 = 物流配送费 - 配送费减免 + 用户支付配送费
可能4 = 预计订单收入 - 成本 - 平台佣金 - 配送净成本
可能性['使用配送净成本'] = 可能4
print(f"\n可能4: 使用'配送净成本'概念")
print(f"  配送净成本 = 配送费 - 配送减免 + 用户付配送 = ¥{配送净成本:,.2f}")
print(f"  公式: 收入 - 成本 - 佣金 - 配送净成本")
print(f"  结果: ¥{可能4:,.2f}")
print(f"  与您的差异: ¥{abs(可能4 - 您的利润):,.2f}")

# 可能5: 配送费减免金额计算错误（可能用了错误的聚合方式）
# 错误的聚合：直接求和（会重复计数）
配送费减免_错误 = df_meituan['配送费减免金额'].sum()
可能5 = 预计订单收入 - 成本 - 平台佣金 - 物流配送费 - 配送费减免_错误 + 用户支付配送费
可能性['配送减免用错误求和'] = 可能5
print(f"\n可能5: '配送费减免'用了错误的聚合方式（直接求和）")
print(f"  配送费减免(错误-直接求和): ¥{配送费减免_错误:,.2f}")
print(f"  配送费减免(正确-订单聚合): ¥{配送费减免:,.2f}")
print(f"  公式: 收入 - 成本 - 佣金 - 配送费 - 配送减免(错误) + 用户配送费")
print(f"  结果: ¥{可能5:,.2f}")
print(f"  与您的差异: ¥{abs(可能5 - 您的利润):,.2f}")

# 可能6: 用户支付配送费计算错误
用户支付配送费_错误 = df_meituan['用户支付配送费'].sum()
可能6 = 预计订单收入 - 成本 - 平台佣金 - 物流配送费 - 配送费减免 + 用户支付配送费_错误
可能性['用户配送费用错误求和'] = 可能6
print(f"\n可能6: '用户支付配送费'用了错误的聚合方式（直接求和）")
print(f"  用户支付配送费(错误-直接求和): ¥{用户支付配送费_错误:,.2f}")
print(f"  用户支付配送费(正确-订单聚合): ¥{用户支付配送费:,.2f}")
print(f"  公式: 收入 - 成本 - 佣金 - 配送费 - 配送减免 + 用户配送费(错误)")
print(f"  结果: ¥{可能6:,.2f}")
print(f"  与您的差异: ¥{abs(可能6 - 您的利润):,.2f}")

# 可能7: 组合错误 - 配送费减免和用户配送费都用错误聚合
可能7 = 预计订单收入 - 成本 - 平台佣金 - 物流配送费 - 配送费减免_错误 + 用户支付配送费_错误
可能性['两个配送字段都错误'] = 可能7
print(f"\n可能7: 配送费减免和用户配送费都用错误聚合")
print(f"  结果: ¥{可能7:,.2f}")
print(f"  与您的差异: ¥{abs(可能7 - 您的利润):,.2f}")

# 找出最接近的
print(f"\n" + "=" * 80)
print("最可能的原因")
print("=" * 80)

最接近 = min(可能性.items(), key=lambda x: abs(x[1] - 您的利润))
print(f"\n✅ 最接近您计算结果的是：{最接近[0]}")
print(f"   计算结果: ¥{最接近[1]:,.2f}")
print(f"   与您的差异: ¥{abs(最接近[1] - 您的利润):,.2f}")

if abs(最接近[1] - 您的利润) < 1:
    print(f"\n🎯 找到了！您的计算问题是：{最接近[0]}")
    
    # 给出具体建议
    if '未扣除配送费减免' in 最接近[0]:
        print(f"\n📝 修正建议：")
        print(f"   您的公式可能是: 收入 - 成本 - 佣金 - 配送费 + 用户配送费")
        print(f"   正确公式应该: 收入 - 成本 - 佣金 - 配送费 - 配送减免 + 用户配送费")
        print(f"   缺少了: -配送费减免金额 (¥{配送费减免:,.2f})")
    elif '未加用户支付配送费' in 最接近[0]:
        print(f"\n📝 修正建议：")
        print(f"   您的公式可能缺少了: +用户支付配送费 (¥{用户支付配送费:,.2f})")
    elif '错误求和' in 最接近[0]:
        print(f"\n📝 修正建议：")
        print(f"   您在聚合订单级字段时，可能用了直接求和而不是按订单去重")
        print(f"   正确做法: 先按订单ID聚合，订单级字段用first()取第一个值")
else:
    print(f"\n❓ 差异较大，可能是多个因素的组合")
    print(f"\n所有可能性对比：")
    for name, value in sorted(可能性.items(), key=lambda x: abs(x[1] - 您的利润)):
        print(f"  {name:30s} ¥{value:>12,.2f}  (差异: ¥{abs(value - 您的利润):>8,.2f})")
