# 滞销品和库存周转不显示问题解决方案

## 问题现象
Excel有剩余库存字段,且重新导入文件了,但滞销品统计和库存周转仍然不显示。

---

## 根本原因

**Redis缓存问题!**

虽然已完成:
- ✅ 数据库有库存字段(stock, remaining_stock)
- ✅ models.py有字段定义
- ✅ 导入脚本支持库存字段读取
- ✅ Excel有剩余库存列
- ✅ 数据成功导入(40,267条记录有库存数据)
- ✅ 数据源管理器正确读取库存

但是:
- ❌ **看板使用了Redis缓存的旧数据!**

### 数据验证

**数据库验证:**
```sql
-- 数据库中有库存数据
SELECT COUNT(*) FROM orders WHERE remaining_stock > 0;
-- 结果: 40267 条记录
```

**数据源管理器验证:**
```python
# 运行: python 诊断库存数据.py
# 结果: ✅ 库存数据正常
#   11条记录中有10条有库存
#   库存平均值: 7.64
```

**结论:** 数据完全正常,但看板显示的是缓存的旧数据!

---

## 解决方案

### 步骤1: 清理Redis缓存

```powershell
python 清理Redis缓存.py
```

**执行结果:**
```
Redis连接成功
发现 3 个缓存key
已删除 3 个缓存key
剩余 0 个key

Redis缓存已清空!
```

### 步骤2: 重启看板

```powershell
.\启动看板.ps1
```

### 步骤3: 重新加载数据

1. 访问 http://localhost:8050
2. 选择**数据库数据源**
3. 选择门店: 惠宜选超市（徐州祥和路店）
4. 选择日期范围
5. 点击**加载数据库数据**

### 步骤4: 验证功能

进入**一级分类销售趋势**,检查:
- ✅ 售罄品数 应该有数据
- ✅ 滞销品总数 应该有数据和分级
- ✅ 库存周转天数 应该有数据

---

## 完整数据流程验证

### 1. 数据库层 ✅

```sql
-- 最新10条订单的库存数据
SELECT order_id, product_name, stock, remaining_stock
FROM orders
ORDER BY created_at DESC
LIMIT 10;

-- 结果: remaining_stock有数据(5.0, 10.0, 296.0等)
```

### 2. 导入层 ✅

**文件:** `database/batch_import.py`

```python
# 库存字段兼容性处理
for col in ['库存', 'stock', '期末库存']:
    if col in row.index and pd.notna(row.get(col)):
        stock_value = float(row[col])
        break

for col in ['剩余库存', 'remaining_stock', '当前库存']:
    if col in row.index and pd.notna(row.get(col)):
        remaining_stock_value = float(row[col])
        break

order_data = {
    # ...
    'stock': int(stock_value) if stock_value is not None else 0,
    'remaining_stock': float(remaining_stock_value) if remaining_stock_value is not None else 0,
}
```

### 3. 数据源层 ✅

**文件:** `database/data_source_manager.py` Line 119-120

```python
'库存': order.remaining_stock if order.remaining_stock is not None else 0,
'剩余库存': order.remaining_stock if order.remaining_stock is not None else 0,
```

### 4. 看板层 ✅

**文件:** `智能门店看板_Dash版.py` Line 9613, 9754, 19488

```python
# 字段检查支持中英文
elif field == '库存':
    if any(col in df.columns for col in ['剩余库存', 'stock', 'remaining_stock', '库存']):
        required_fields[field] = True

# 库存字段获取支持中英文
stock_col = None
for col in ['库存', '剩余库存', 'stock', 'remaining_stock']:
    if col in df.columns:
        stock_col = col
        break
```

### 5. 缓存层 ❌ → ✅

**问题:** Redis缓存了旧数据(库存全是0)

**解决:** 清理Redis缓存,重启看板重新加载

---

## 关键诊断脚本

### 1. 诊断库存数据

```powershell
python 诊断库存数据.py
```

**功能:**
- 检查数据源管理器读取的库存数据
- 统计有库存的记录数
- 显示样本数据

### 2. 清理Redis缓存

```powershell
python 清理Redis缓存.py
```

**功能:**
- 自动删除所有Redis缓存
- 确保看板重新加载最新数据

---

## 为什么会有缓存问题?

### Redis缓存机制

看板使用Redis缓存数据库查询结果,提升性能:

```python
# redis_cache_manager.py
@cache_dataframe(redis_cache, 'store_data', expire=1800)
def load_from_database(...):
    # 第一次: 查数据库存Redis(30分钟)
    # 后续: 直接从Redis读
```

### 问题场景

1. **第一次加载数据**(库存全是0)
   - 查询数据库(库存=0)
   - 缓存到Redis
   - 有效期30分钟

2. **重新导入数据**(库存有值)
   - 数据库已更新(库存>0)
   - 但Redis缓存未过期
   - 看板仍读取旧缓存(库存=0)

3. **解决方案**
   - 清理Redis缓存
   - 重启看板
   - 重新加载数据

---

## 预防措施

### 方案1: 导入后自动清理缓存

在导入脚本中添加:

```python
# 智能导入门店数据.py
def import_data(...):
    # 导入数据
    # ...
    
    # 清理Redis缓存
    from redis_config import get_redis_client
    redis_client = get_redis_client()
    redis_client.delete('store_data:*')
    print("已清理相关缓存")
```

### 方案2: 缩短缓存时间

```python
# redis_cache_manager.py
@cache_dataframe(redis_cache, 'store_data', expire=300)  # 改为5分钟
```

### 方案3: 手动刷新按钮

在看板添加"刷新缓存"按钮:

```python
@app.callback(...)
def clear_cache(n_clicks):
    redis_client.delete('store_data:*')
    return "缓存已清理"
```

---

## 总结

**问题:** 滞销品和库存周转不显示  
**表面原因:** Excel有库存,重新导入了,但还是不显示  
**真实原因:** Redis缓存了旧数据(库存=0),看板读取缓存而不是数据库  
**解决方案:** 清理Redis缓存 + 重启看板

**关键点:**
- ✅ 数据库有正确的库存数据(40,267条)
- ✅ 数据源管理器正确读取(验证通过)
- ✅ 代码逻辑完全正确
- ❌ Redis缓存未更新(已解决)

**验证工具:**
- `诊断库存数据.py` - 验证数据源层
- `清理Redis缓存.py` - 清理缓存
- 重启看板 - 重新加载数据

**预防建议:**
- 数据导入后自动清理缓存
- 或者添加手动刷新缓存按钮
- 或者缩短缓存有效期

---

## 快速解决清单

- [x] 数据库有库存字段
- [x] models.py有字段定义
- [x] 导入脚本支持库存
- [x] Excel有剩余库存列
- [x] 数据成功导入
- [x] 数据源管理器正确读取
- [x] **清理Redis缓存** ← 关键步骤!
- [ ] 重启看板验证

**下一步: 重启看板并验证功能!**

```powershell
.\启动看板.ps1
```
