# 📊 问题诊断图表对比优化 - 实施说明

## 🎯 优化目标

将问题诊断Tab中的三个核心图表从"单一指标展示"升级为"双周期对比"，更符合问题诊断的业务逻辑。

---

## ✅ 已完成的修改

### 1. **分时段下滑分布** → **分时段销量对比**

**修改前**:
- 图表类型: 柱状图
- 显示内容: 各时段的下滑商品数
- 问题: 只知道"有多少商品下滑"，不知道"下滑了多少"

**修改后**:
- 图表类型: **分组柱状图**
- 显示内容: **当前周期销量 vs 对比周期销量**
- 颜色标识:
  - 🔴 **红色柱** = 当前周期销量
  - 🔵 **蓝色柱** = 对比周期销量
- 标题示例: `"⏰ 分时段销量对比（第40周 vs 第39周）"`
- 优势: **直观看出每个时段的销量对比，柱子高度差即下滑幅度**

---

### 2. **分场景下滑分布** → **分场景销量对比**

**修改前**:
- 图表类型: 饼图
- 显示内容: 各场景的下滑商品占比
- 问题: 只知道"哪个场景商品多"，不知道"销量差多少"

**修改后**:
- 图表类型: **分组柱状图**
- 显示内容: **当前周期销量 vs 对比周期销量**
- 颜色标识:
  - 🔴 **红色柱** = 当前周期销量
  - 🔵 **蓝色柱** = 对比周期销量
- 标题示例: `"🎭 分场景销量对比（第40周 vs 第39周）"`
- 优势: **识别问题场景的同时，看到具体销量差距**

---

### 3. **收入损失TOP10** → **收入对比TOP10**

**修改前**:
- 图表类型: 瀑布图
- 显示内容: 收入变化值（负值表示损失）
- 问题: 只知道"损失金额"，不知道"原来有多少收入"

**修改后**:
- 图表类型: **分组柱状图**
- 显示内容: **当前周期收入 vs 对比周期收入**
- 颜色标识:
  - 🔴 **红色柱** = 当前周期收入
  - 🔵 **蓝色柱** = 对比周期收入
- 标题示例: `"💸 收入对比TOP10（第40周 vs 第39周）"`
- 优势: **不仅看到损失，还能看到收入基数，更有决策价值**

---

## 🔧 技术实现细节

### 数据字段要求

三个图表现在都需要从诊断数据中提取以下字段：

1. **分时段图表**:
   - `时段` (必需)
   - `当前周期销量(第XX周)` (必需)
   - `对比周期销量(第XX周)` (必需)

2. **分场景图表**:
   - `场景` (必需)
   - `当前周期销量(第XX周)` (必需)
   - `对比周期销量(第XX周)` (必需)

3. **收入TOP10图表**:
   - `商品名称` (必需)
   - `当前周期收入(第XX周)` (必需)
   - `对比周期收入(第XX周)` (必需)

### 降级方案

如果数据中**没有**上述对比字段，系统会自动降级：
- 分时段/场景图: 使用"下滑商品数"统计
- 收入TOP10: 使用"收入变化"瀑布图

### 周期标签提取

从字段名中自动提取周期标签，例如：
- `当前周期销量(第40周)` → 提取 `"第40周"`
- `对比周期销量(第39周)` → 提取 `"第39周"`
- 显示在图表标题中: `"分时段销量对比（第40周 vs 第39周）"`

---

## 📈 业务价值提升

### 修改前（单一指标）:
```
问题: 早餐时段有5个商品下滑
结论: ❓ 是小幅下滑还是崩盘式下跌？不知道！
```

### 修改后（双周期对比）:
```
问题: 早餐时段销量对比
- 第40周: 150单
- 第39周: 300单
结论: ✅ 下滑50%，属于严重问题，需立即处理！
```

---

## 🎨 视觉效果

### ECharts分组柱状图配置

```javascript
{
    "title": "⏰ 分时段销量对比（第40周 vs 第39周）",
    "legend": {
        "data": ["第40周", "第39周"]
    },
    "series": [
        {
            "name": "第40周",
            "type": "bar",
            "data": [...],
            "itemStyle": {"color": "#ef5350"}  // 红色
        },
        {
            "name": "第39周",
            "type": "bar",
            "data": [...],
            "itemStyle": {"color": "#42a5f5"}  // 蓝色
        }
    ]
}
```

---

## 🧪 测试检查清单

### 测试步骤

1. **启动应用**:
   ```bash
   python 智能门店看板_Dash版.py
   ```

2. **进入问题诊断Tab**:
   - Tab 4 → "📉 销量下滑诊断"

3. **点击"开始诊断"按钮**

4. **检查三个图表**:
   - [ ] 分时段销量对比：是否显示红蓝两组柱子？
   - [ ] 分场景销量对比：是否显示红蓝两组柱子？
   - [ ] 收入对比TOP10：是否显示红蓝两组柱子？
   - [ ] 标题是否显示周期信息（如"第40周 vs 第39周"）？
   - [ ] 图例是否正确显示两个周期？
   - [ ] 鼠标悬停是否显示详细数值？

### 预期效果

#### ✅ 正常情况（有对比字段）:
- 三个图表都显示分组柱状图
- 标题包含周期标签
- 红色=当前周期，蓝色=对比周期
- 柱子高度差直观反映变化

#### ⚠️ 降级情况（无对比字段）:
- 分时段/场景：显示下滑商品数统计
- 收入TOP10：显示收入变化瀑布图
- Console会有提示: `"⚠️ 缺少销量对比字段，使用降级方案"`

---

## 🔍 常见问题排查

### Q1: 图表不显示对比数据，仍是单柱或饼图？

**原因**: 诊断数据中缺少"当前周期销量/对比周期销量"字段

**排查**:
1. 检查诊断引擎是否返回对比字段
2. 查看终端日志: `找到销量字段: 当前周期销量(第X周), 对比周期销量(第Y周)`
3. 如无此日志，则使用了降级方案

**解决**: 
- 确保诊断引擎 `diagnose_sales_decline()` 函数返回对比字段
- 或接受降级方案，仍可正常使用

### Q2: 周期标签显示错误（如"当前周期 vs 对比周期"）？

**原因**: 字段名中没有包含周期信息

**排查**:
1. 检查诊断数据的列名，是否包含括号如 `(第40周)`
2. 查看终端日志: `对比模式: 第40周 vs 第39周`

**解决**:
- 诊断引擎返回数据时，列名应包含周期标识，如:
  - `当前周期销量(第40周)`
  - `对比周期收入(09-29)`

### Q3: 图表显示异常或报错？

**排查步骤**:
1. 打开浏览器控制台（F12）→ Console
2. 查看终端日志
3. 检查 `callback_debug.txt` 文件

**常见错误**:
- `字段类型错误`: 销量/收入字段未转换为数值型
- `数据为空`: 筛选条件过严，导致无数据
- `ECharts未加载`: 检查 `ECHARTS_AVAILABLE` 变量

---

## 📝 修改文件清单

### 已修改文件

1. **智能门店看板_Dash版.py**:
   - 函数 `update_slot_distribution_chart()` (3263-3425行)
   - 函数 `update_scene_distribution_chart()` (3428-3631行)
   - 函数 `update_revenue_top10_chart()` (4169-4347行)
   - 前端界面提示文字 (1124行, 1145行, 1166行)

### 新增文件

1. **图表对比优化说明.md** (本文档)

---

## 🚀 下一步优化建议

### 可选增强功能

1. **增加变化幅度标注**:
   - 在图表上方显示: `"↓ 下滑35%"` 或 `"↑ 增长12%"`

2. **颜色动态调整**:
   - 下滑严重的时段/场景：红色加深
   - 持平或微增的：绿色标识

3. **支持更多对比模式**:
   - 日度对比
   - 月度对比
   - 同比对比（去年同期）

4. **导出对比报告**:
   - Excel中包含对比图表
   - 自动生成对比分析摘要

---

## ✅ 总结

### 核心改进

| 维度 | 修改前 | 修改后 | 提升 |
|------|--------|--------|------|
| **分时段图表** | 下滑商品数 | 销量对比 | ⭐⭐⭐⭐⭐ |
| **分场景图表** | 下滑商品占比 | 销量对比 | ⭐⭐⭐⭐⭐ |
| **收入TOP10** | 损失金额 | 收入对比 | ⭐⭐⭐⭐⭐ |
| **业务洞察** | 知道"有问题" | 知道"问题多严重" | 🎯 核心提升 |
| **决策支持** | 方向性指引 | 量化决策依据 | 💡 关键价值 |

---

**修改完成时间**: 2025年10月19日  
**修改人**: GitHub Copilot  
**版本**: v2.0 - 对比升级版
