# 配送距离分布分析 - 配送费成本计算说明

## 📊 问题：距离段配送费成本如何计算？

用户询问："在配送距离分布分析中，各距离段配送费成本你是怎么计算的？"

---

## 💰 配送费成本计算公式

### 第一步：订单级配送费成本计算（第5723-5733行）

```python
# 完整计算（三个字段齐全的情况）
df['配送费成本'] = (
    df['用户支付配送费'].fillna(0) - 
    df['配送费减免金额'].fillna(0) - 
    df['物流配送费'].fillna(0)
)

# 简化计算（仅有物流配送费字段）
df['配送费成本'] = -df['物流配送费'].fillna(0)

# 无法计算（缺少配送费字段）
df['配送费成本'] = 0
```

### 📐 公式解释

**配送费成本（净成本）= 用户支付 - 减免 - 物流费**

| 字段名 | 含义 | 正负 | 示例 |
|--------|------|------|------|
| 用户支付配送费 | 用户实际支付的配送费 | + | +5元 |
| 配送费减免金额 | 平台给用户的配送费优惠 | - | -3元（减免3元） |
| 物流配送费 | 平台支付给骑手/物流公司的费用 | - | -6元（成本） |
| **配送费成本（净）** | **商家实际承担的配送成本** | **正/负** | **-4元（亏4元）** |

### 💡 业务逻辑示例

**示例1：平台有补贴的订单**
- 用户支付：5元
- 平台减免：3元（用户实际只付2元，平台补贴3元）
- 物流费：6元
- **净成本 = 5 - 3 - 6 = -4元**（商家倒贴4元）

**示例2：无补贴订单**
- 用户支付：8元
- 平台减免：0元
- 物流费：6元
- **净成本 = 8 - 0 - 6 = +2元**（商家盈利2元）

**示例3：免配送费订单**
- 用户支付：0元
- 平台减免：5元（免配送费活动）
- 物流费：6元
- **净成本 = 0 - 5 - 6 = -11元**（商家倒贴11元）

---

## 📍 第二步：按距离段聚合（第6182行）

```python
# 核心聚合逻辑
order_delivery_cost = (
    temp_df
    .groupby(['订单ID', '距离分层'])['配送费成本']  # 先按订单+距离分层分组
    .first()                                         # 每个订单只取第一个值（订单级成本）
    .groupby('距离分层')                            # 再按距离分层分组
    .mean()                                          # 计算平均值
)
```

### 🔍 计算步骤详解

#### 2.1 为什么用 `.first()`？

因为原始数据是**订单-商品明细级**：

```
订单ID    商品      配送距离  配送费成本
A001     可乐      1.5km     -4元
A001     薯片      1.5km     -4元  ← 同一订单的重复值
A001     矿泉水    1.5km     -4元  ← 同一订单的重复值
```

配送费成本是**订单级**属性（一个订单只产生一次配送费），所以需要先去重：

```python
.groupby(['订单ID', '距离分层'])['配送费成本'].first()
```

结果：
```
订单ID    距离分层      配送费成本
A001     1-2公里        -4元    ← 只保留一条
B002     2-3公里        -5元
C003     1公里以下      -2元
```

#### 2.2 为什么用 `.mean()`？

第二次聚合计算每个距离段的**平均单均配送成本**：

```python
.groupby('距离分层').mean()
```

结果：
```
距离分层         单均配送成本
1公里以下        -2.5元    ← 该距离段所有订单的平均成本
1-2公里          -3.8元
2-3公里          -5.2元    ← 距离越远，成本越高
3-4公里          -6.5元
4-5公里          -7.8元
5公里以上        -10.2元
```

---

## 📈 第三步：可视化展示（第6187-6219行）

### 柱状图：各距离段单均配送费成本

```python
fig = px.bar(
    x=cost_valid.index,          # X轴：距离段（1公里以下、1-2公里...）
    y=cost_valid.values,         # Y轴：单均配送成本（-2.5元、-3.8元...）
    labels={'y': '单均配送成本(元)'},
    color=cost_valid.values,
    color_continuous_scale='Reds'  # 红色色阶（成本越高越红）
)
```

### 洞察分析

```python
max_cost_range = cost_valid.idxmax()  # 成本最高的距离段（如：5公里以上）
min_cost_range = cost_valid.idxmin()  # 成本最低的距离段（如：1公里以下）

# 显示关键信息
• 最高成本距离段：5公里以上（¥-10.20/单）
• 最低成本距离段：1公里以下（¥-2.50/单）
• 成本差异：¥7.70/单
• 建议：优化远距离订单配送策略，降低配送成本
```

### 配送成本占客单价比例

```python
for dist in cost_valid.index:
    price = distance_price_valid[dist]  # 该距离段的平均客单价
    cost = cost_valid[dist]             # 该距离段的平均配送成本
    ratio = (abs(cost) / price * 100)   # 成本占比（取绝对值）
    
    st.progress(ratio/20, text=f"{dist}: {ratio:.2f}%")
```

示例：
```
1公里以下:  5.2%  ████░░░░░░░░░░░░░░░░
1-2公里:    8.3%  ████████░░░░░░░░░░░░
2-3公里:   12.5%  ████████████░░░░░░░░
3-4公里:   18.7%  ██████████████████░░
```

---

## 🎯 关键业务逻辑总结

### 1. 成本是订单级属性

- **订单-商品明细表**：一个订单有多行（每个商品一行）
- **配送费成本**：一个订单只产生一次配送费（所有明细行的配送费成本都相同）
- **必须先聚合到订单级**：避免重复计算（否则一个订单的配送费会被算多次）

### 2. 距离分层定义

```python
def get_distance_range(distance_km):
    if distance_km < 1:    return '1公里以下'
    elif distance_km < 2:  return '1-2公里'
    elif distance_km < 3:  return '2-3公里'
    elif distance_km < 4:  return '3-4公里'
    elif distance_km < 5:  return '4-5公里'
    else:                  return '5公里以上'
```

### 3. 计算链路

```
原始数据（明细级）
    ↓
计算配送费成本 = 用户支付 - 减免 - 物流费
    ↓
添加距离分层标签（1公里以下、1-2公里...）
    ↓
按 [订单ID + 距离分层] 聚合，取first（去重）
    ↓
按 [距离分层] 聚合，取mean（计算平均单均成本）
    ↓
可视化展示（柱状图 + 洞察分析）
```

---

## ⚠️ 注意事项

### 1. 负值含义

配送费成本通常是**负值**（表示成本）：
- **负值（如 -4元）**：商家倒贴4元配送费
- **正值（如 +2元）**：商家从配送费中盈利2元
- **接近0**：配送费基本平衡

### 2. 数据要求

**必需字段**：
- `用户支付配送费`（用户实际付款）
- `配送费减免金额`（平台补贴）
- `物流配送费`（骑手/物流成本）
- `配送距离`（米或公里）

**缺少字段时的降级处理**：
- 仅有`物流配送费`：配送费成本 = -物流配送费
- 完全缺失：配送费成本 = 0，并显示警告

### 3. 单位转换

```python
if df['配送距离'].max() > 100:
    df['配送距离_公里'] = df['配送距离'] / 1000
    st.info("📏 检测到配送距离单位为米，已自动转换为公里")
```

---

## 📊 实际应用场景

### 场景1：优化配送范围

```
距离段        订单量    单均成本    客单价    成本占比
1公里以下     1200单    -2.5元     48元      5.2%    ← 核心盈利区
1-2公里       800单     -3.8元     46元      8.3%    ← 主力区域
2-3公里       450单     -5.2元     42元     12.4%    ← 可接受
3-4公里       180单     -6.5元     38元     17.1%    ← 边缘区
4-5公里        60单     -7.8元     35元     22.3%    ← 亏损严重
5公里以上      20单    -10.2元     32元     31.9%    ← 重度亏损

建议：
✅ 主攻 3公里以内（成本占比<15%）
⚠️ 限制 4-5公里（成本占比>20%，考虑提高起送价）
❌ 关闭 5公里以上（成本占比>30%，严重亏损）
```

### 场景2：动态配送费策略

```python
# 根据距离段设置差异化配送费
if 距离 < 1km:
    用户配送费 = 2元（吸引近距离用户）
elif 距离 < 3km:
    用户配送费 = 5元（主力区域）
elif 距离 < 5km:
    用户配送费 = 8元（覆盖成本）
else:
    用户配送费 = 12元 or 拒绝配送
```

### 场景3：满减活动优化

```
当前：满50减5，全距离通用
问题：5公里以上订单亏损31.9%，满减加剧亏损

优化方案：
- 1公里以下：满40减8（吸引核心用户）
- 1-3公里：满50减5（标准活动）
- 3-5公里：满80减5（提高起送价）
- 5公里以上：满100减5 or 取消配送
```

---

## 🔧 代码位置索引

| 功能 | 文件 | 行号 |
|------|------|------|
| 配送费成本计算 | 智能门店经营看板_可视化.py | 5723-5733 |
| 距离分层定义 | 智能门店经营看板_可视化.py | 6085-6098 |
| 按距离段聚合 | 智能门店经营看板_可视化.py | 6182 |
| 可视化展示 | 智能门店经营看板_可视化.py | 6187-6219 |

---

## 📝 修订记录

- **创建时间**：2025-10-15 17:15
- **文档版本**：v1.0
- **适用版本**：智能门店经营看板_可视化.py (7842行)
- **创建人**：GitHub Copilot

---

**总结**：各距离段配送费成本 = 先计算订单级净成本（用户支付 - 减免 - 物流费），再按距离分层聚合求平均值。这样可以准确反映不同配送距离下的真实成本水平，为优化配送策略提供数据支持。
