# å…­è±¡é™ä¸Žè°ƒä»·è®¡ç®—å™¨è”åŠ¨åŠŸèƒ½ - é‡æ–°è®¾è®¡æ–¹æ¡ˆ

> **è®¾è®¡æ—¶é—´**: 2025-12-10  
> **ç‰ˆæœ¬**: V3.1ï¼ˆé‡æ–°è®¾è®¡ï¼‰  
> **çŠ¶æ€**: ðŸ“ è®¾è®¡ä¸­

---

## ðŸ” é—®é¢˜æ ¹æºåˆ†æž

### æž¶æž„ç†è§£é”™è¯¯

**é”™è¯¯ç†è§£**ï¼š
- ä»¥ä¸ºæ™ºèƒ½è°ƒä»·è®¡ç®—å™¨æ˜¯ä¸»çœ‹æ¿çš„ä¸€ä¸ªç‹¬ç«‹Tabï¼ˆå¦‚Tab8ï¼‰
- ä»¥ä¸ºå¯ä»¥é€šè¿‡åˆ‡æ¢`main-tabs`çš„`active_tab`æ¥è·³è½¬

**å®žé™…æž¶æž„**ï¼š
```
ä¸»çœ‹æ¿ (main-tabs)
â”œâ”€â”€ Tab0: ä»Šæ—¥å¿…åš (tab-today-must-do)
â”‚   â”œâ”€â”€ å®¢å•ä»·è¯Šæ–­å¡ç‰‡
â”‚   â”œâ”€â”€ å•†å“å¥åº·åˆ†æžå¡ç‰‡
â”‚   â”‚   â””â”€â”€ å…­è±¡é™åˆ†å¸ƒ
â”‚   â””â”€â”€ æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨å¡ç‰‡
â”‚       â”œâ”€â”€ è‡ªç”±è°ƒä»· (tab-free)
â”‚       â”œâ”€â”€ ç›®æ ‡å¯¼å‘ (tab-goal)
â”‚       â””â”€â”€ ...
â”œâ”€â”€ Tab1: è®¢å•æ•°æ®æ¦‚è§ˆ
â”œâ”€â”€ Tab2: æ¸ é“å¯¹æ¯”
â””â”€â”€ ...
```

**ç»“è®º**ï¼š
- æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨æ˜¯ä»Šæ—¥å¿…åš**å†…éƒ¨**çš„ä¸€ä¸ªå¡ç‰‡
- å…­è±¡é™åˆ†å¸ƒä¹Ÿæ˜¯ä»Šæ—¥å¿…åš**å†…éƒ¨**çš„ä¸€ä¸ªå¡ç‰‡
- å®ƒä»¬åœ¨**åŒä¸€ä¸ªé¡µé¢**ä¸Šï¼Œåªæ˜¯ä½ç½®ä¸åŒ

---

## ðŸ’¡ æ­£ç¡®çš„è”åŠ¨æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®ï¼ˆæŽ¨èï¼‰

**åŽŸç†**ï¼š
- ç‚¹å‡»å…­è±¡é™çš„"è°ƒä»·"æŒ‰é’®
- é¡µé¢è‡ªåŠ¨æ»šåŠ¨åˆ°æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨çš„ä½ç½®
- åŒæ—¶ä¼ é€’è±¡é™æ•°æ®

**ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´æŽ¥ï¼Œç”¨æˆ·ä½“éªŒå¥½
- ä¸éœ€è¦åˆ‡æ¢Tab
- ç¬¦åˆç”¨æˆ·å¿ƒæ™ºæ¨¡åž‹

**å®žçŽ°æ–¹å¼**ï¼š
1. ç»™æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨å¡ç‰‡æ·»åŠ IDï¼š`id='pricing-calculator-card'`
2. ä½¿ç”¨clientside callbackæ»šåŠ¨åˆ°è¯¥ä½ç½®
3. åŒæ—¶æ›´æ–°Storeä¼ é€’è±¡é™æ•°æ®

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# 1. ç»™æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨å¡ç‰‡æ·»åŠ ID
dbc.Card([
    dbc.CardHeader([...]),
    dbc.CardBody([...])
], id='pricing-calculator-card', className="mb-4")

# 2. Clientside callbackæ»šåŠ¨
app.clientside_callback(
    """
    function(n_clicks) {
        if (n_clicks) {
            const element = document.getElementById('pricing-calculator-card');
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // é«˜äº®æ˜¾ç¤ºï¼ˆå¯é€‰ï¼‰
                element.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.8)';
                setTimeout(() => {
                    element.style.boxShadow = '';
                }, 2000);
            }
        }
        return window.dash_clientside.no_update;
    }
    """,
    Output('dummy-output', 'children'),
    Input({'type': 'quadrant-to-pricing', 'quadrant': ALL}, 'n_clicks')
)

# 3. æœåŠ¡ç«¯callbackä¼ é€’æ•°æ®
@callback(
    Output('pricing-quadrant-filter', 'data'),
    Input({'type': 'quadrant-to-pricing', 'quadrant': ALL}, 'n_clicks'),
    ...
)
def pass_quadrant_data(n_clicks, ...):
    # ä¼ é€’è±¡é™æ•°æ®
    return quadrant_filter
```

---

### æ–¹æ¡ˆBï¼šä½¿ç”¨Accordionå±•å¼€/æŠ˜å 

**åŽŸç†**ï¼š
- å°†æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨æ”¾åœ¨Accordionä¸­
- ç‚¹å‡»å…­è±¡é™çš„"è°ƒä»·"æŒ‰é’®
- è‡ªåŠ¨å±•å¼€æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨çš„Accordion
- åŒæ—¶æ»šåŠ¨åˆ°è¯¥ä½ç½®

**ä¼˜ç‚¹**ï¼š
- å¯ä»¥æŠ˜å éšè—ï¼ŒèŠ‚çœç©ºé—´
- å±•å¼€æ—¶æœ‰åŠ¨ç”»æ•ˆæžœï¼Œç”¨æˆ·æ„ŸçŸ¥æ˜Žæ˜¾

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹å¸ƒå±€ç»“æž„
- å¯èƒ½å½±å“çŽ°æœ‰åŠŸèƒ½

---

### æ–¹æ¡ˆCï¼šä½¿ç”¨Modalå¼¹çª—ï¼ˆå¤‡é€‰ï¼‰

**åŽŸç†**ï¼š
- ç‚¹å‡»å…­è±¡é™çš„"è°ƒä»·"æŒ‰é’®
- å¼¹å‡ºæ™ºèƒ½è°ƒä»·è®¡ç®—å™¨çš„Modal
- åœ¨Modalä¸­æ˜¾ç¤ºè‡ªç”±è°ƒä»·åŠŸèƒ½

**ä¼˜ç‚¹**ï¼š
- ç‹¬ç«‹çš„äº¤äº’ç©ºé—´
- ä¸å½±å“ä¸»é¡µé¢

**ç¼ºç‚¹**ï¼š
- Modalç©ºé—´æœ‰é™
- ç”¨æˆ·å¯èƒ½ä¸å–œæ¬¢å¼¹çª—

---

## ðŸŽ¯ æŽ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆAï¼ˆæ»šåŠ¨ + æ•°æ®ä¼ é€’ï¼‰

### å®žçŽ°æ­¥éª¤

#### æ­¥éª¤1ï¼šæ·»åŠ å¡ç‰‡IDå’Œæ»šåŠ¨åŠŸèƒ½

```python
# åœ¨ create_today_must_do_layout ä¸­
dbc.Card([
    dbc.CardHeader([
        dbc.Row([
            dbc.Col([
                html.H5([
                    html.I(className="fas fa-calculator me-2"),
                    "ðŸ”§ æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨"
                ], className="mb-0 text-warning")
            ], width=6),
            ...
        ])
    ]),
    dbc.CardBody([...])
], id='pricing-calculator-card', className="mb-4 shadow-sm border-0")  # æ·»åŠ ID
```

#### æ­¥éª¤2ï¼šæ·»åŠ clientside callbackæ»šåŠ¨

```python
# åœ¨ register_today_must_do_callbacks ä¸­
app.clientside_callback(
    """
    function(n_clicks) {
        // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‰é’®è¢«ç‚¹å‡»
        const triggered = dash_clientside.callback_context.triggered;
        if (!triggered || triggered.length === 0) {
            return window.dash_clientside.no_update;
        }
        
        // æ»šåŠ¨åˆ°æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨
        const element = document.getElementById('pricing-calculator-card');
        if (element) {
            // å¹³æ»‘æ»šåŠ¨
            element.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start',
                inline: 'nearest'
            });
            
            // é«˜äº®æ˜¾ç¤º2ç§’
            element.style.transition = 'box-shadow 0.3s';
            element.style.boxShadow = '0 0 30px rgba(255, 193, 7, 0.8)';
            setTimeout(() => {
                element.style.boxShadow = '';
            }, 2000);
        }
        
        return window.dash_clientside.no_update;
    }
    """,
    Output('pricing-scroll-trigger', 'data'),  # è™šæ‹Ÿè¾“å‡º
    Input({'type': 'quadrant-to-pricing', 'quadrant': ALL}, 'n_clicks'),
    prevent_initial_call=True
)

# æ·»åŠ è™šæ‹ŸStore
dcc.Store(id='pricing-scroll-trigger', data=None)
```

#### æ­¥éª¤3ï¼šä¼ é€’è±¡é™æ•°æ®åˆ°è‡ªç”±è°ƒä»·

```python
@callback(
    [Output('pricing-quadrant-filter', 'data'),
     Output('pricing-source-context', 'data'),
     Output('quick-scene-store', 'data')],  # åˆ©ç”¨çŽ°æœ‰çš„å¿«æ·åœºæ™¯Store
    Input({'type': 'quadrant-to-pricing', 'quadrant': ALL}, 'n_clicks'),
    [State('db-store-filter', 'value'),
     State('product-health-channel-filter', 'value')],
    prevent_initial_call=True
)
def pass_quadrant_data_to_pricing(n_clicks, selected_stores, channel):
    """ä¼ é€’è±¡é™æ•°æ®åˆ°è‡ªç”±è°ƒä»·"""
    from dash import ctx
    from datetime import datetime
    
    if not any(n_clicks) or not ctx.triggered:
        raise PreventUpdate
    
    triggered = ctx.triggered_id
    if not triggered or 'quadrant' not in triggered:
        raise PreventUpdate
    
    quadrant = triggered['quadrant']
    
    print(f"[è”åŠ¨] ä¼ é€’è±¡é™æ•°æ®: {quadrant}")
    
    # é‡æ–°è®¡ç®—å•†å“è¯„åˆ†æ•°æ®
    try:
        GLOBAL_DATA = get_real_global_data()
        if GLOBAL_DATA is None or GLOBAL_DATA.empty:
            raise PreventUpdate
        
        # åº”ç”¨ç­›é€‰
        from .diagnosis_analysis import apply_filters_view, calculate_product_scores
        store_list = selected_stores if isinstance(selected_stores, list) else [selected_stores] if selected_stores else []
        df = apply_filters_view(GLOBAL_DATA, selected_stores=store_list)
        
        if df is None or df.empty:
            raise PreventUpdate
        
        # åº”ç”¨æ¸ é“ç­›é€‰
        if channel and channel != 'all':
            channel_col = next((c for c in ['æ¸ é“', 'å¹³å°', 'channel'] if c in df.columns), None)
            if channel_col:
                df = df[df[channel_col] == channel]
        
        # è®¡ç®—å•†å“è¯„åˆ†
        product_scores = calculate_product_scores(df, days_range=0)
        
        if product_scores is None or product_scores.empty:
            raise PreventUpdate
        
        # ç­›é€‰è¯¥è±¡é™çš„å•†å“
        quadrant_col = 'å››è±¡é™åˆ†ç±»' if 'å››è±¡é™åˆ†ç±»' in product_scores.columns else 'è±¡é™åˆ†ç±»'
        if quadrant_col not in product_scores.columns:
            raise PreventUpdate
        
        quadrant_products = product_scores[product_scores[quadrant_col] == quadrant]
        
        print(f"[è”åŠ¨] ç­›é€‰åˆ° {len(quadrant_products)} ä¸ª{quadrant}å•†å“")
        
        # æž„å»ºè±¡é™ç­›é€‰æ•°æ®
        quadrant_filter = {
            'quadrant': quadrant,
            'products': quadrant_products.to_dict('records'),
            'count': len(quadrant_products),
            'timestamp': datetime.now().isoformat()
        }
        
        # æž„å»ºæ¥æºä¸Šä¸‹æ–‡
        source_context = {
            'from': 'å•†å“å¥åº·åˆ†æž',
            'quadrant': quadrant,
            'stores': store_list,
            'channel': channel,
            'timestamp': datetime.now().isoformat()
        }
        
        # è®¾ç½®å¿«æ·åœºæ™¯ä¸º"å…­è±¡é™"ï¼ˆåˆ©ç”¨çŽ°æœ‰çš„å¿«æ·åœºæ™¯æœºåˆ¶ï¼‰
        quick_scene = {
            'type': 'quadrant',
            'quadrant': quadrant,
            'timestamp': datetime.now().isoformat()
        }
        
        return quadrant_filter, source_context, quick_scene
        
    except Exception as e:
        print(f"[è”åŠ¨] æ•°æ®ä¼ é€’å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        raise PreventUpdate
```

#### æ­¥éª¤4ï¼šä¿®æ”¹è‡ªç”±è°ƒä»·çš„æ•°æ®åŠ è½½é€»è¾‘

```python
@callback(
    Output('free-pricing-table-container', 'children'),
    [Input('free-pricing-calculate-btn', 'n_clicks'),
     Input('quick-scene-store', 'data')],  # ç›‘å¬å¿«æ·åœºæ™¯å˜åŒ–
    [State('calculator-date-range', 'value'),
     State('free-pricing-category', 'value'),
     State('free-pricing-price-min', 'value'),
     State('free-pricing-price-max', 'value'),
     State('free-pricing-adjust-type', 'value'),
     State('free-pricing-adjust-value', 'value'),
     State('db-store-filter', 'value'),
     State('pricing-quadrant-filter', 'data')],  # è¯»å–è±¡é™æ•°æ®
    prevent_initial_call=True
)
def update_free_pricing_table(n_clicks, quick_scene, date_range, category, 
                              price_min, price_max, adjust_type, adjust_value,
                              selected_stores, quadrant_filter):
    """æ›´æ–°è‡ªç”±è°ƒä»·è¡¨æ ¼ï¼ˆæ”¯æŒè±¡é™ç­›é€‰ï¼‰"""
    from dash import ctx
    
    triggered_id = ctx.triggered_id
    
    # èŽ·å–å…¨å±€æ•°æ®
    GLOBAL_DATA = get_real_global_data()
    if GLOBAL_DATA is None or GLOBAL_DATA.empty:
        return dbc.Alert("æ— æ•°æ®", color="warning")
    
    # åº”ç”¨é—¨åº—ç­›é€‰
    from .diagnosis_analysis import apply_filters_view
    store_list = selected_stores if isinstance(selected_stores, list) else [selected_stores] if selected_stores else []
    df = apply_filters_view(GLOBAL_DATA, selected_stores=store_list)
    
    if df is None or df.empty:
        return dbc.Alert("ç­›é€‰åŽæ— æ•°æ®", color="warning")
    
    # åº”ç”¨æ—¶é—´èŒƒå›´ç­›é€‰
    if date_range and date_range > 0:
        from datetime import datetime, timedelta
        date_col = 'æ—¥æœŸ' if 'æ—¥æœŸ' in df.columns else 'ä¸‹å•æ—¶é—´'
        if date_col in df.columns:
            df[date_col] = pd.to_datetime(df[date_col], errors='coerce')
            cutoff_date = df[date_col].max() - timedelta(days=date_range)
            df = df[df[date_col] >= cutoff_date]
    
    # å¦‚æžœæ˜¯ä»Žè±¡é™è·³è½¬è¿‡æ¥çš„ï¼Œåº”ç”¨è±¡é™ç­›é€‰
    if triggered_id == 'quick-scene-store' and quick_scene:
        if quick_scene.get('type') == 'quadrant' and quadrant_filter:
            quadrant_products = quadrant_filter.get('products', [])
            if quadrant_products:
                # æå–å•†å“åç§°åˆ—è¡¨
                product_names = [p.get('å•†å“åç§°') for p in quadrant_products if p.get('å•†å“åç§°')]
                # ç­›é€‰è¿™äº›å•†å“
                if 'å•†å“åç§°' in df.columns:
                    df = df[df['å•†å“åç§°'].isin(product_names)]
                    print(f"[è‡ªç”±è°ƒä»·] åº”ç”¨è±¡é™ç­›é€‰: {len(product_names)}ä¸ªå•†å“")
    
    # åº”ç”¨å…¶ä»–ç­›é€‰æ¡ä»¶ï¼ˆåˆ†ç±»ã€ä»·æ ¼åŒºé—´ç­‰ï¼‰
    if category:
        category_col = 'ä¸€çº§åˆ†ç±»' if 'ä¸€çº§åˆ†ç±»' in df.columns else 'ä¸€çº§åˆ†ç±»å'
        if category_col in df.columns:
            df = df[df[category_col] == category]
    
    if price_min is not None or price_max is not None:
        price_col = 'å•†å“å®žå”®ä»·' if 'å•†å“å®žå”®ä»·' in df.columns else 'å®žæ”¶ä»·æ ¼'
        if price_col in df.columns:
            if price_min is not None:
                df = df[df[price_col] >= price_min]
            if price_max is not None:
                df = df[df[price_col] <= price_max]
    
    # èšåˆåˆ°å•†å“çº§åˆ«
    # ... åŽç»­å¤„ç†é€»è¾‘ ...
    
    # ç”Ÿæˆè¡¨æ ¼
    # ... è¡¨æ ¼ç”Ÿæˆé€»è¾‘ ...
```

---

## ðŸŽ¨ UIä¼˜åŒ–

### 1. åœ¨å…­è±¡é™åˆ†å¸ƒä¸­æ·»åŠ æç¤º

```python
# åœ¨å…­è±¡é™åˆ†å¸ƒå¡ç‰‡é¡¶éƒ¨æ·»åŠ æç¤º
dbc.Alert([
    html.I(className="fas fa-info-circle me-2"),
    "ç‚¹å‡»è±¡é™å³ä¾§çš„",
    html.Strong(" [è°ƒä»·] ", className="mx-1"),
    "æŒ‰é’®ï¼Œå¿«é€Ÿè·³è½¬åˆ°æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨å¹¶è‡ªåŠ¨ç­›é€‰è¯¥è±¡é™å•†å“"
], color="info", className="mb-3 py-2")
```

### 2. åœ¨æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨ä¸­æ˜¾ç¤ºæ¥æºä¿¡æ¯

```python
# åœ¨è‡ªç”±è°ƒä»·Tabé¡¶éƒ¨æ·»åŠ 
html.Div(id='pricing-source-info', className="mb-3")

# å›žè°ƒæ˜¾ç¤ºæ¥æºä¿¡æ¯
@callback(
    Output('pricing-source-info', 'children'),
    Input('pricing-source-context', 'data'),
    prevent_initial_call=True
)
def show_pricing_source_info(context):
    if not context:
        return html.Div()
    
    quadrant = context.get('quadrant', '')
    
    return dbc.Alert([
        html.I(className="fas fa-link me-2"),
        f"å·²è‡ªåŠ¨ç­›é€‰ï¼š{quadrant}",
        html.Small(f" (æ¥è‡ªå•†å“å¥åº·åˆ†æž)", className="ms-2 text-muted")
    ], color="success", className="py-2")
```

---

## ðŸ“ å®žæ–½æ¸…å•

- [ ] 1. ç»™æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨å¡ç‰‡æ·»åŠ ID
- [ ] 2. æ·»åŠ clientside callbackå®žçŽ°æ»šåŠ¨
- [ ] 3. æ·»åŠ è™šæ‹ŸStoreï¼ˆpricing-scroll-triggerï¼‰
- [ ] 4. ä¿®æ”¹è±¡é™æ•°æ®ä¼ é€’å›žè°ƒ
- [ ] 5. ä¿®æ”¹è‡ªç”±è°ƒä»·çš„æ•°æ®åŠ è½½é€»è¾‘ï¼Œæ”¯æŒè±¡é™ç­›é€‰
- [ ] 6. æ·»åŠ æ¥æºä¿¡æ¯æ˜¾ç¤º
- [ ] 7. æ·»åŠ UIæç¤º
- [ ] 8. æµ‹è¯•éªŒè¯

---

## ðŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1ï¼šæ»šåŠ¨è·³è½¬

1. è¿›å…¥ä»Šæ—¥å¿…åšTab
2. æ»šåŠ¨åˆ°å…­è±¡é™åˆ†å¸ƒ
3. ç‚¹å‡»"ðŸ’Ž æ½œåŠ›å•†å“"çš„"[è°ƒä»·]"æŒ‰é’®
4. **é¢„æœŸ**: é¡µé¢å¹³æ»‘æ»šåŠ¨åˆ°æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨
5. **é¢„æœŸ**: æ™ºèƒ½è°ƒä»·è®¡ç®—å™¨é«˜äº®æ˜¾ç¤º2ç§’

### æµ‹è¯•2ï¼šæ•°æ®ç­›é€‰

1. ç‚¹å‡»"[è°ƒä»·]"æŒ‰é’®åŽ
2. æŸ¥çœ‹è‡ªç”±è°ƒä»·Tab
3. **é¢„æœŸ**: æ˜¾ç¤ºæ¥æºä¿¡æ¯ï¼š"å·²è‡ªåŠ¨ç­›é€‰ï¼šðŸ’Ž æ½œåŠ›å•†å“"
4. ç‚¹å‡»"è®¡ç®—"æŒ‰é’®
5. **é¢„æœŸ**: åªæ˜¾ç¤ºæ½œåŠ›å•†å“çš„è°ƒä»·å»ºè®®

### æµ‹è¯•3ï¼šæ—¶é—´èŒƒå›´

1. åœ¨è‡ªç”±è°ƒä»·Tabä¸­é€‰æ‹©"è¿‘7å¤©"
2. ç‚¹å‡»"è®¡ç®—"æŒ‰é’®
3. **é¢„æœŸ**: åªä½¿ç”¨è¿‘7å¤©çš„æ•°æ®è®¡ç®—

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2025-12-10  
**ä¸‹ä¸€æ­¥**: å®žæ–½ä»£ç ä¿®æ”¹

