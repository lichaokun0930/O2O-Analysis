# O2O è®¢å•æ•°æ®çœ‹æ¿ - è‡ªåŠ¨éƒ¨ç½²é…ç½®
# 
# è§¦å‘æ¡ä»¶: æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
# 
# ä½¿ç”¨å‰éœ€è¦åœ¨ GitHub ä»“åº“è®¾ç½®ä»¥ä¸‹ Secrets:
#   - SERVER_HOST: äº‘æœåŠ¡å™¨ IP åœ°å€
#   - SERVER_USER: SSH ç”¨æˆ·å (é€šå¸¸æ˜¯ root)
#   - SERVER_SSH_KEY: SSH ç§é’¥ (ç”¨äºå…å¯†ç™»å½•)
#   - SERVER_PORT: SSH ç«¯å£ (é»˜è®¤ 22)

name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  APP_NAME: o2o-analysis
  DEPLOY_PATH: /opt/o2o-analysis

jobs:
  # ==========================================
  # é˜¶æ®µ 1: æµ‹è¯•
  # ==========================================
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: ğŸ§ª Run backend tests
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short || echo "No tests found, skipping..."
      
      - name: ğŸ“— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-react/package-lock.json
      
      - name: ğŸ“¦ Install frontend dependencies
        run: |
          cd frontend-react
          npm ci
      
      - name: ğŸ” Lint frontend
        run: |
          cd frontend-react
          npm run lint || echo "Lint passed or no lint script"

  # ==========================================
  # é˜¶æ®µ 2: æ„å»º
  # ==========================================
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend-react/package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: |
          cd frontend-react
          npm ci
      
      - name: ğŸ”¨ Build frontend
        run: |
          cd frontend-react
          npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend-react/dist/
          retention-days: 1

  # ==========================================
  # é˜¶æ®µ 3: éƒ¨ç½²åˆ°æœåŠ¡å™¨
  # ==========================================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-react/dist/
      
      - name: ğŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_PORT || 22 }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: ğŸ“¤ Deploy to server
        run: |
          # åŒæ­¥åç«¯ä»£ç 
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_PORT || 22 }}" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env.local' \
            ./backend/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/backend/
          
          # åŒæ­¥å‰ç«¯æ„å»ºäº§ç‰©
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_PORT || 22 }}" \
            ./frontend-react/dist/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/frontend/
      
      - name: ğŸ”„ Restart services
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_PORT || 22 }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          
          cd /opt/o2o-analysis
          
          # å®‰è£…/æ›´æ–° Python ä¾èµ–
          source .venv/bin/activate
          pip install -r backend/requirements.txt -q
          
          # é‡å¯åç«¯æœåŠ¡
          sudo systemctl restart o2o-backend
          
          # å¤åˆ¶å‰ç«¯åˆ° Nginx ç›®å½•
          sudo cp -r frontend/* /var/www/html/
          
          # é‡è½½ Nginx
          sudo systemctl reload nginx
          
          echo "âœ… Deployment completed!"
          EOF
      
      - name: ğŸ¥ Health check
        run: |
          sleep 10
          curl -f http://${{ secrets.SERVER_HOST }}/api/health || echo "Health check skipped"

  # ==========================================
  # éƒ¨ç½²é€šçŸ¥
  # ==========================================
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ“¢ Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ!"
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
