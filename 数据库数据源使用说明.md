# 数据库数据源使用说明

## ⚠️ 当前状态

### ✅ 已修复
1. **Tab 2 字段错误** - 已添加 `库存`, `店内码`, `预计订单收入` 字段
2. **看板启动错误** - 可以正常启动并运行
3. **数据库连接** - 可以正常加载数据(8,345行)

### ❌ 存在问题
**数据库数据不完整** - 缺少营销费用字段的真实值

| 字段名 | Excel数据 | 数据库数据 | 影响 |
|--------|----------|-----------|------|
| 满减金额 | ✅ 有值 | ❌ 全为0 | 利润计算错误 |
| 商品减免金额 | ✅ 有值 | ❌ 全为0 | 成本缺失 |
| 商家代金券 | ✅ 有值 | ❌ 全为0 | 成本缺失 |
| 商家承担部分券 | ✅ 有值 | ❌ 全为0 | 成本缺失 |
| 配送费减免金额 | ✅ 有值 | ❌ 全为0 | 成本缺失 |

**计算结果对比:**

| 指标 | Excel数据 | 数据库数据 | 问题 |
|------|----------|-----------|------|
| 总利润 | 正常 | -¥55,862.82 | ❌ 严重负数 |
| 利润率 | ~25% | -86.84% | ❌ 异常负值 |
| 活动营销成本 | 有真实值 | ¥0.00 | ❌ 缺失 |

## 📊 推荐使用方式

### 方案1: 使用Excel数据源(推荐✅)

**优点:**
- ✅ 数据完整,包含所有营销费用
- ✅ 计算准确,利润率正确
- ✅ 立即可用,无需额外配置

**使用步骤:**
1. 启动看板: `启动智能看板.ps1`
2. 访问: http://localhost:8050
3. 默认已加载Excel数据(新沂2店.xlsx)
4. 所有功能正常使用

### 方案2: 使用数据库数据源(⚠️受限)

**可用功能:**
- ✅ 商品信息查看
- ✅ 销售数量统计
- ✅ 分类分析
- ✅ 场景分析

**不可用功能:**
- ❌ 利润分析(数据不准确)
- ❌ 成本分析(缺少营销费用)
- ❌ 订单盈利分析(结果错误)

**使用步骤:**
1. 启动看板后,点击 "🗄️ 数据库数据" Tab
2. 选择门店和日期范围
3. 点击"加载数据"
4. **仅用于查看销售数据,不要进行利润分析**

## 🔧 长期解决方案

### 1. 完善数据库模型

需要在 `database/models.py` 的 `Order` 表中添加营销费用字段:

```python
class Order(Base):
    __tablename__ = 'orders'
    
    # 现有字段...
    
    # 新增营销费用字段
    discount_amount = Column(Numeric(10, 2), comment='满减金额')
    product_discount = Column(Numeric(10, 2), comment='商品减免金额')
    merchant_coupon = Column(Numeric(10, 2), comment='商家代金券')
    merchant_share_coupon = Column(Numeric(10, 2), comment='商家承担部分券')
    delivery_discount = Column(Numeric(10, 2), comment='配送费减免金额')
    packaging_fee = Column(Numeric(10, 2), comment='打包袋金额')
```

### 2. 创建数据库迁移

```bash
# 创建迁移脚本
python database/manage.py create_migration "add_marketing_fields"

# 执行迁移
python database/manage.py migrate
```

### 3. 导入完整数据

将Excel数据导入数据库,包含所有营销费用字段:

```bash
python database/batch_import.py --file 实际数据/新沂2店.xlsx
```

### 4. 更新字段映射

修改 `database/data_source_manager.py` 的 `load_from_database()` 方法,从数据库读取真实的营销费用:

```python
'满减金额': order.discount_amount if order.discount_amount else 0,
'商品减免金额': order.product_discount if order.product_discount else 0,
# 等等...
```

## ⚡ 临时解决方案

如果暂时无法完善数据库,可以:

1. **主要使用Excel数据源** - 所有功能正常
2. **数据库仅作为备份** - 查看数据用
3. **分析时切换到Excel Tab** - 确保数据准确

## 📌 使用建议

**当前阶段(数据库未完善):**
- ✅ 使用看板时默认使用Excel数据
- ✅ 所有利润分析基于Excel数据
- ⚠️ 暂时不要使用数据库数据做利润分析

**数据库完善后:**
- ✅ 可以放心使用数据库数据源
- ✅ 支持多门店对比分析
- ✅ 支持历史数据追溯
- ✅ 支持跨期间数据分析

## 💡 常见问题

**Q: 为什么数据库数据显示负利润?**
A: 数据库缺少营销费用字段,导致成本计算不完整。建议使用Excel数据源。

**Q: 如何切换数据源?**
A: 看板顶部有 "📁 Excel数据" 和 "🗄️ 数据库数据" 两个Tab,点击切换即可。

**Q: 数据库什么时候可以正常使用?**
A: 需要先完善数据库模型,添加营销费用字段,然后重新导入数据。

**Q: Excel数据有什么限制?**
A: Excel数据仅包含单个门店单个时期的数据,无法做跨门店/跨时期分析。

## 📝 总结

- **短期:** 使用Excel数据源 ✅
- **中期:** 完善数据库模型 🔧
- **长期:** 数据库作为主要数据源,Excel作为临时导入方式 🎯
