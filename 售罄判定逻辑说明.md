# 售罄判定逻辑说明

## 🎯 核心问题回答

**Q: 售罄也是随着日期变化计算的吗？**

**A: 是的！** 售罄判定也是基于**逐日对比**的逻辑:

```python
# 判定条件
if 当前销量 == 0 and 之前销量 > 0:
    → 🔴售罄
```

---

## 📊 售罄判定完整流程

### 步骤1: 按日期对比（与涨降价相同）

```python
# 逐日对比
9月30日 vs 9月29日
9月29日 vs 9月28日
9月28日 vs 9月27日
...
```

### 步骤2: 计算每天的商品销量

**当前期（例如9月30日）**:
```python
current_data = df[df['日期'] == '2025-09-30']
current_agg = current_data.groupby('商品名称').agg({
    '商品实售价': 'count'  # 订单数量 = 销量
})

# 结果示例:
可口可乐: 3单  ← 当前销量
雪碧: 0单      ← 当前销量为0
```

**对比期（例如9月29日）**:
```python
compare_data = df[df['日期'] == '2025-09-29']
compare_agg = compare_data.groupby('商品名称').agg({
    '商品实售价': 'count'
})

# 结果示例:
可口可乐: 5单  ← 之前销量
雪碧: 8单      ← 之前销量>0
```

### 步骤3: 判定售罄

```python
def analyze_reason(row):
    if row['当前销量'] == 0 and row['之前销量'] > 0:
        return "🔴售罄"  # 之前有销量，现在没有了 → 售罄
    elif row['当前销量'] == 0:
        return "⚪新品"  # 之前也没有，现在也没有 → 新品/待上架
    # ... 其他判定
```

---

## 🔍 实际案例演示

### 案例1: 雪碧售罄

**原始数据**:
```
日期        商品名称    订单数
9月28日     雪碧       10单
9月29日     雪碧       8单
9月30日     雪碧       0单  ← 没有订单了
```

**判定过程**:

#### 对比1: 9月30日 vs 9月29日
```python
当前销量(9月30日) = 0单
之前销量(9月29日) = 8单

判定条件:
  ✓ 当前销量 == 0  → 是
  ✓ 之前销量 > 0   → 是(8单 > 0)

结果: 🔴售罄
说明: 9月29日还有8单销量，但9月30日没有订单了 → 售罄
```

#### 对比2: 9月29日 vs 9月28日
```python
当前销量(9月29日) = 8单
之前销量(9月28日) = 10单

判定条件:
  ✗ 当前销量 == 0  → 否(8 ≠ 0)

结果: 📉销量小幅下滑 (或其他原因)
说明: 9月29日还有销量，不算售罄
```

---

### 案例2: 可口可乐正常在售

**原始数据**:
```
日期        商品名称      订单数
9月28日     可口可乐     12单
9月29日     可口可乐     10单
9月30日     可口可乐     8单
```

**判定过程**:

#### 对比: 9月30日 vs 9月29日
```python
当前销量(9月30日) = 8单
之前销量(9月29日) = 10单

判定条件:
  ✗ 当前销量 == 0  → 否(8 ≠ 0)

结果: 📉销量小幅下滑
说明: 虽然销量下降，但仍有销售，不算售罄
```

---

### 案例3: 新品尚未上架

**原始数据**:
```
日期        商品名称    订单数
9月28日     网红零食    0单
9月29日     网红零食    0单
9月30日     网红零食    0单  ← 一直没有订单
```

**判定过程**:

#### 对比: 9月30日 vs 9月29日
```python
当前销量(9月30日) = 0单
之前销量(9月29日) = 0单

判定条件:
  ✓ 当前销量 == 0  → 是
  ✗ 之前销量 > 0   → 否(0 不大于 0)

结果: ⚪新品
说明: 之前也没有销量，可能是新品尚未上架
```

---

### 案例4: 售罄后补货

**原始数据**:
```
日期        商品名称    订单数
9月27日     薯片       15单
9月28日     薯片       8单
9月29日     薯片       0单  ← 售罄
9月30日     薯片       12单 ← 补货后恢复销售
```

**判定过程**:

#### 对比1: 9月29日 vs 9月28日
```python
当前销量(9月29日) = 0单
之前销量(9月28日) = 8单

判定: 🔴售罄
说明: 9月28日还有销量，9月29日没了 → 售罄
```

#### 对比2: 9月30日 vs 9月29日
```python
当前销量(9月30日) = 12单
之前销量(9月29日) = 0单

判定: ✅正常 (或销量增长)
说明: 补货后恢复销售，不再是售罄状态
```

---

## 🎨 可视化流程图

```
原始订单数据
    ↓
┌─────────────────────────────────────┐
│ 1. 按日期筛选                        │
│   - 9月30日: 筛选该天所有订单        │
│   - 9月29日: 筛选该天所有订单        │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 按商品统计销量                    │
│   9月30日:                           │
│   - 可口可乐: 3单                    │
│   - 雪碧: 0单      ← 没有订单        │
│                                      │
│   9月29日:                           │
│   - 可口可乐: 5单                    │
│   - 雪碧: 8单      ← 有订单          │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 3. 判定售罄                          │
│   雪碧:                              │
│   当前销量(9月30日) = 0单            │
│   之前销量(9月29日) = 8单            │
│                                      │
│   ✓ 当前销量 == 0                   │
│   ✓ 之前销量 > 0                    │
│   → 🔴售罄                           │
└─────────────────────────────────────┘
```

---

## 📋 判定规则对比

### 售罄 vs 新品 vs 正常

| 状态 | 当前销量 | 之前销量 | 判定结果 | 说明 |
|------|---------|---------|---------|------|
| **售罄** | = 0 | > 0 | 🔴售罄 | 之前有销售，现在没了 |
| **新品** | = 0 | = 0 | ⚪新品 | 之前也没有，可能是新品 |
| **正常** | > 0 | 任意 | 其他判定 | 有销量，不算售罄 |

### 完整判定优先级

```python
def analyze_reason(row):
    # 优先级1: 售罄
    if row['当前销量'] == 0 and row['之前销量'] > 0:
        return "🔴售罄"
    
    # 优先级2: 新品
    elif row['当前销量'] == 0:
        return "⚪新品"
    
    # 优先级3: 涨价导致销量降
    elif row['单价变化率'] > 5 and row['销量变化'] < 0:
        return "💰涨价导致销量降"
    
    # 优先级4: 降价仍降量
    elif row['单价变化率'] < -5 and row['销量变化'] < 0:
        return "💸降价仍降量"
    
    # 优先级5: 销量大幅下滑
    elif row['销量变化'] < -row['之前销量'] * 0.3:
        return "📉销量大幅下滑"
    
    # 优先级6: 销量小幅下滑
    elif row['销量变化'] < 0:
        return "📉销量小幅下滑"
    
    # 优先级7: 正常
    else:
        return "✅正常"
```

---

## 💡 关键特点

### 1. **逐日检测售罄**
```
9月30日检查: 雪碧今天售罄了吗？
  → 对比9月29日: 昨天有销量吗？
  → 是 → 🔴售罄

9月29日检查: 雪碧昨天售罄了吗？
  → 对比9月28日: 前天有销量吗？
  → 是 → 🔴售罄
```

### 2. **区分售罄和新品**
```
售罄: 之前有销量，现在没有了
新品: 之前也没有，现在也没有
```

### 3. **动态追踪**
```
如果一个商品:
  9月28日: 有销量 ✅
  9月29日: 售罄 🔴
  9月30日: 补货后有销量 ✅

系统会准确识别:
  - 9月29日标记为"售罄"
  - 9月30日标记为"正常"
```

### 4. **优先级最高**
```
售罄判定优先级最高，即使其他条件符合也会先判定为售罄:

例: 某商品
  单价变化率: +20% (符合涨价)
  当前销量: 0
  之前销量: 10

判定: 🔴售罄 (不是"涨价导致销量降")
```

---

## 🔬 实际数据验证示例

### 示例数据表

```
日期        商品名称    订单ID    商品实售价
9月28日     雪碧       O001      3.5
9月28日     雪碧       O002      3.5
9月28日     雪碧       O003      3.5
9月29日     雪碧       O100      3.5
9月29日     雪碧       O101      3.5
9月30日     雪碧       (无订单)   -
```

### 计算过程

#### 统计9月30日销量
```python
df_0930 = df[df['日期'].dt.date == date(2025, 9, 30)]
雪碧_9月30日 = df_0930[df_0930['商品名称'] == '雪碧']

销量 = len(雪碧_9月30日)  # 0单
→ 当前销量 = 0
```

#### 统计9月29日销量
```python
df_0929 = df[df['日期'].dt.date == date(2025, 9, 29)]
雪碧_9月29日 = df_0929[df_0929['商品名称'] == '雪碧']

销量 = len(雪碧_9月29日)  # 2单 (O100, O101)
→ 之前销量 = 2
```

#### 判定
```python
if 当前销量 == 0 and 之前销量 > 0:
    # 0 == 0 ✓
    # 2 > 0 ✓
    return "🔴售罄"
```

---

## 📝 总结

### 售罄判定逻辑

✅ **是的，售罄也是随着日期变化计算的**

### 判定条件
```
🔴售罄:
  1. 当前期销量 = 0  (今天没有任何订单)
  2. 对比期销量 > 0  (昨天还有订单)
```

### 计算流程
```
1. 按日期分割数据 (9月30日 vs 9月29日)
2. 统计商品销量 (count订单数)
3. 对比前后天销量
4. 判定是否售罄
```

### 与涨降价的一致性
```
涨降价: 对比前后天的 平均单价
售罄:   对比前后天的 销量

都是基于:
  ✅ 逐日对比
  ✅ 商品级别聚合
  ✅ 滚动分析
```

---

## 🎯 典型场景

### 场景1: 促销活动售罄
```
9月28日: 薯片正常销售，20单
9月29日: 促销活动，50单 (卖光了)
9月30日: 0单 → 🔴售罄

原因: 促销太火爆，库存卖光
```

### 场景2: 滞销商品下架
```
9月28日: 某商品 3单
9月29日: 某商品 1单
9月30日: 0单 → 🔴售罄

原因: 销量不佳，决定下架
```

### 场景3: 季节性商品
```
9月28日: 冰淇淋 25单
9月29日: 冰淇淋 15单
9月30日: 0单 → 🔴售罄

原因: 天气转凉，暂停销售
```

---

**相关文件**: `问题诊断引擎.py` 第837-840行  
**相关文档**: `单价计算逻辑说明.md`, `涨价降价定义说明.md`  
**最后更新**: 2025-10-16
