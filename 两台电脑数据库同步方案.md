# 两台电脑数据库结构同步完整方案

## 问题背景

两台电脑各自有独立的PostgreSQL数据库,当A电脑修改了models.py添加新字段后,B电脑拉取代码后数据库结构不一致,导致功能异常。

**传统痛点:**
- ❌ 手动同步容易遗漏字段
- ❌ 不知道哪些迁移已执行
- ❌ 需要查看Git历史才知道改了什么
- ❌ 每次都要手动写SQL命令

**解决方案:**
- ✅ 使用迁移脚本管理数据库结构变更
- ✅ 自动跟踪哪些迁移已执行
- ✅ 一键同步所有未执行的迁移
- ✅ 自动验证数据库结构一致性

---

## 核心机制

### 1. 迁移脚本(Migrations)

所有数据库结构变更用SQL脚本记录:

```
database/migrations/
├── README.md                    # 迁移目录说明
├── migration_template.sql       # 迁移模板
├── v1_add_stock_fields.sql      # 迁移1: 添加库存字段
├── v2_add_indexes.sql           # 迁移2: 添加索引(未来)
└── ...
```

### 2. 迁移历史表(migration_history)

数据库中记录哪些迁移已执行:

```sql
CREATE TABLE migration_history (
    id SERIAL PRIMARY KEY,
    migration_name VARCHAR(255) UNIQUE,  -- 迁移文件名
    applied_at TIMESTAMP,                -- 执行时间
    success BOOLEAN,                      -- 是否成功
    error_message TEXT                    -- 错误信息
);
```

### 3. 自动化工具

- `migration_history.py` - 管理迁移历史表
- `apply_migration.py` - 应用单个迁移
- `sync_migrations.py` - 自动同步所有迁移
- `check_structure.py` - 验证结构一致性

---

## 完整工作流程

### A电脑: 创建迁移

#### 步骤1: 修改models.py

```python
# database/models.py
class Order(Base):
    # 添加新字段
    new_field = Column(String(100), comment='新字段')
```

#### 步骤2: 创建迁移脚本

```powershell
# 复制模板
cd database\migrations
copy migration_template.sql v2_add_new_field.sql

# 编辑v2_add_new_field.sql
notepad v2_add_new_field.sql
```

```sql
-- v2_add_new_field.sql
-- 日期: 2025-11-22
-- 说明: 添加新字段用于XXX功能

ALTER TABLE orders ADD COLUMN IF NOT EXISTS new_field VARCHAR(100);
COMMENT ON COLUMN orders.new_field IS '新字段说明';

-- 验证
DO $$
DECLARE
    field_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO field_count
    FROM information_schema.columns
    WHERE table_name = 'orders' AND column_name = 'new_field';
    
    IF field_count > 0 THEN
        RAISE NOTICE '✓ 字段添加成功';
    ELSE
        RAISE WARNING '✗ 字段添加失败';
    END IF;
END $$;
```

#### 步骤3: 应用迁移(A电脑)

```powershell
# 应用迁移到A电脑数据库
python database\migrations\apply_migration.py v2_add_new_field.sql
```

**输出:**
```
============================================================
应用迁移: v2_add_new_field.sql
============================================================

✓ 迁移应用成功: v2_add_new_field.sql
```

#### 步骤4: 验证结构

```powershell
python database\migrations\check_structure.py
```

**输出:**
```
============================================================
数据库结构一致性检查
============================================================

数据库字段数: 45
models.py字段数: 45

✓ 共有字段 (45 个)

============================================================
✓ 数据库结构完全一致!
============================================================
```

#### 步骤5: 提交到Git

```powershell
git add database\migrations\v2_add_new_field.sql
git add database\models.py
git commit -m "添加new_field字段"
git push
```

---

### B电脑: 同步迁移

#### 步骤1: 拉取代码

```powershell
cd D:\Python1\O2O_Analysis\O2O数据分析\测算模型
git pull
```

#### 步骤2: 自动同步迁移

```powershell
python database\migrations\sync_migrations.py
```

**输出:**
```
============================================================
数据库迁移同步
============================================================

已应用的迁移: 1 个
发现迁移文件: 2 个

待应用的迁移: 1 个
  - v2_add_new_field.sql

============================================================
开始应用迁移...
============================================================

应用迁移: v2_add_new_field.sql
✓ 迁移应用成功: v2_add_new_field.sql

============================================================
同步结果
============================================================
成功: 1 个
失败: 0 个

✓ 数据库结构同步完成!

下一步: 验证数据库结构
  python database\migrations\check_structure.py
```

#### 步骤3: 验证结构

```powershell
python database\migrations\check_structure.py
```

#### 步骤4: 重启看板

```powershell
.\启动看板.ps1
```

---

## 快速命令参考

### A电脑(修改方)

```powershell
# 1. 修改models.py
# 2. 创建迁移脚本
cd database\migrations
copy migration_template.sql vX_description.sql

# 3. 应用到A电脑
python apply_migration.py vX_description.sql

# 4. 验证
python check_structure.py

# 5. 提交Git
git add database\migrations\vX_description.sql database\models.py
git commit -m "描述"
git push
```

### B电脑(同步方)

```powershell
# 1. 拉取代码
git pull

# 2. 自动同步所有迁移
python database\migrations\sync_migrations.py

# 3. 验证
python database\migrations\check_structure.py

# 4. 重启看板
.\启动看板.ps1
```

---

## 一键同步脚本

为了更方便,可以创建一键同步脚本。

### A电脑: 创建并应用迁移

```powershell
# 创建: A电脑_创建迁移.ps1
@"
# A电脑创建迁移工作流

param(
    [string]`$description = "new_migration"
)

Write-Host "=" * 60
Write-Host "A电脑: 创建并应用迁移"
Write-Host "=" * 60

# 生成迁移文件名
`$timestamp = Get-Date -Format "yyyyMMdd_HHmm"
`$filename = "v`${timestamp}_`${description}.sql"
`$filepath = "database\migrations\`$filename"

# 复制模板
Copy-Item "database\migrations\migration_template.sql" `$filepath
Write-Host "`n✓ 已创建: `$filepath"

# 打开编辑
notepad `$filepath

Write-Host "`n按Enter键继续应用迁移..."
Read-Host

# 应用迁移
python database\migrations\apply_migration.py `$filename

# 验证
python database\migrations\check_structure.py

Write-Host "`n下一步: 提交到Git"
Write-Host "  git add `$filepath database\models.py"
Write-Host "  git commit -m '`$description'"
Write-Host "  git push"
"@ | Out-File -Encoding UTF8 A电脑_创建迁移.ps1
```

### B电脑: 一键同步

```powershell
# 创建: B电脑_同步数据库.ps1
@"
# B电脑一键同步数据库结构

Write-Host "=" * 60
Write-Host "B电脑: 同步数据库结构"
Write-Host "=" * 60

# 1. 拉取代码
Write-Host "`n[1/4] 拉取最新代码..."
git pull

# 2. 同步迁移
Write-Host "`n[2/4] 同步数据库迁移..."
python database\migrations\sync_migrations.py

# 3. 验证结构
Write-Host "`n[3/4] 验证数据库结构..."
python database\migrations\check_structure.py

# 4. 清理缓存
Write-Host "`n[4/4] 清理Redis缓存..."
python 清理Redis缓存.py

Write-Host "`n=" * 60
Write-Host "✓ 同步完成!"
Write-Host "=" * 60

Write-Host "`n下一步: 重启看板"
Write-Host "  .\启动看板.ps1"
"@ | Out-File -Encoding UTF8 B电脑_同步数据库.ps1
```

使用方法:

```powershell
# A电脑
.\A电脑_创建迁移.ps1 add_new_field

# B电脑
.\B电脑_同步数据库.ps1
```

---

## 常见问题

### Q1: 忘记创建迁移脚本,直接修改了数据库怎么办?

**A:** 反向生成迁移脚本:

```powershell
# 检查差异
python database\migrations\check_structure.py

# 根据输出手动创建迁移脚本
# 然后应用到另一台电脑
```

### Q2: 迁移执行失败怎么办?

**A:** 查看错误信息,修复后重新执行:

```powershell
# 查看迁移历史
python database\migrations\migration_history.py

# 修复迁移脚本后重新执行
python database\migrations\apply_migration.py vX_xxx.sql
```

### Q3: 如何回滚迁移?

**A:** 创建回滚迁移:

```sql
-- vX_rollback_field.sql
ALTER TABLE orders DROP COLUMN IF EXISTS field_name;
```

```powershell
python database\migrations\apply_migration.py vX_rollback_field.sql
```

### Q4: 如何重置迁移历史?

**A:** 清空迁移历史表:

```powershell
python -c "from database.connection import get_db; from sqlalchemy import text; db = next(get_db()); db.execute(text('TRUNCATE TABLE migration_history')); db.commit(); print('✓ 迁移历史已清空')"
```

### Q5: 如何导出数据库结构?

**A:** 使用pg_dump:

```powershell
# 只导出结构(不含数据)
$env:PGPASSWORD="308352588"
pg_dump -U postgres -d o2o_dashboard -s > database_structure.sql

# 复制到另一台电脑执行
psql -U postgres -d o2o_dashboard -f database_structure.sql
```

---

## 最佳实践

### 1. 迁移文件命名

```
vX_description.sql
```

- 使用递增版本号(v1, v2, v3...)
- 描述清晰明了
- 一个迁移只做一件事

### 2. 迁移内容

```sql
-- 必须包含:
-- 1. 日期和说明注释
-- 2. IF NOT EXISTS避免重复执行
-- 3. 验证代码确认成功
-- 4. COMMENT说明字段用途
```

### 3. 测试流程

```powershell
# A电脑测试
1. 应用迁移
2. 验证结构
3. 测试功能
4. 提交Git

# B电脑测试
1. 拉取代码
2. 同步迁移
3. 验证结构
4. 测试功能
```

### 4. 团队协作

- 修改models.py必须创建迁移
- 迁移脚本与代码一起提交
- 每次拉取代码后运行sync_migrations.py
- 定期运行check_structure.py验证

---

## 对比传统方式

### 传统方式 ❌

```powershell
# A电脑
# 1. 修改models.py
# 2. 手动写SQL
psql -U postgres -d o2o_dashboard -c "ALTER TABLE orders ADD COLUMN new_field VARCHAR(100);"
# 3. 提交代码(可能忘记告诉B电脑)

# B电脑
# 1. 拉取代码
# 2. 看到报错
# 3. 问A电脑改了什么
# 4. 手动执行SQL
# 5. 可能执行错误或遗漏字段
```

**问题:**
- 依赖人工沟通
- 容易出错
- 难以追溯历史
- 无法自动化

### 迁移方式 ✅

```powershell
# A电脑
# 1. 修改models.py
# 2. 创建迁移脚本
# 3. 应用迁移
python database\migrations\apply_migration.py v2_add_field.sql
# 4. 提交代码+迁移脚本

# B电脑
# 1. 拉取代码
# 2. 自动同步
python database\migrations\sync_migrations.py
# 完成!
```

**优势:**
- 完全自动化
- 版本可追溯
- 不会遗漏字段
- 可验证一致性

---

## 总结

### 核心原则

1. **所有数据库结构变更都用迁移脚本**
2. **迁移脚本与代码一起提交Git**
3. **拉取代码后自动运行sync_migrations.py**
4. **定期验证check_structure.py**

### 工具清单

| 工具 | 用途 | 使用场景 |
|------|------|----------|
| `migration_template.sql` | 迁移模板 | 创建新迁移 |
| `migration_history.py` | 管理历史表 | 查看已应用迁移 |
| `apply_migration.py` | 应用单个迁移 | A电脑首次应用 |
| `sync_migrations.py` | 自动同步 | B电脑拉取后同步 |
| `check_structure.py` | 验证一致性 | 验证两台电脑一致 |
| `A电脑_创建迁移.ps1` | 一键创建 | 简化A电脑流程 |
| `B电脑_同步数据库.ps1` | 一键同步 | 简化B电脑流程 |

### 快速开始

```powershell
# 首次使用: 初始化迁移系统
python database\migrations\migration_history.py

# A电脑工作流
.\A电脑_创建迁移.ps1 add_new_field

# B电脑工作流
.\B电脑_同步数据库.ps1
```

**从此两台电脑数据库结构永远一致!** 🎉
