# 客单价归因分析 - 测试验证指南

> **测试时间**: 2025年10月15日  
> **测试环境**: http://localhost:8502  
> **测试模块**: 问题诊断 → 客单价下滑归因分析

---

## 🎯 测试目标

验证5个核心优化是否生效：
1. ✅ 店内码和渠道字段显示
2. ✅ CSV导出无乱码
3. ✅ 灵活周期对比功能
4. ✅ 数值格式化正确
5. ✅ UI周期选择器正常

---

## 📋 测试步骤

### 步骤1：访问系统
1. 打开浏览器访问 http://localhost:8502
2. 点击左侧导航栏"问题诊断"
3. 选择标签"客单价下滑归因分析"

**预期**: 页面正常加载，显示配置区域

---

### 步骤2：测试周期选择器（P2优化）

1. 查看"选择对比周期"区域
2. 点击"当前周期"下拉菜单

**预期**:
```
✅ 显示格式：第40周 (2025年) (2025-09-30 ~ 2025-10-06)
✅ 列出最近12个周期
✅ 默认选中第0个（最新周）
```

3. 点击"对比周期"下拉菜单

**预期**:
```
✅ 只显示早于当前周期的选项
✅ 如果当前周期=第40周，对比周期只能选第39周、第38周...
✅ 默认选中紧邻的上一周期
```

**截图保存**: `测试截图1_周期选择器.png`

---

### 步骤3：执行分析

1. 保持默认设置：
   - 分析粒度: 按周分析
   - 客单价下滑阈值%: -5.0
   - 当前周期: 第40周
   - 对比周期: 第39周

2. 点击"🔍 开始归因"按钮

**预期**:
```
✅ 显示加载动画"正在分析客单价下滑原因..."
✅ 2-5秒内完成分析
✅ 显示结果表格
```

---

### 步骤4：验证表格内容（P1优化 - 数值格式化）

查看结果表格的表头和数值：

**预期表头**:
```
✅ 对比周期
✅ 第39周客单价
✅ 第40周客单价
✅ 客单价变化
✅ 变化幅度%
✅ 主要下滑商品TOP5
✅ 商品角色分布
✅ 问题等级
✅ 建议操作
```

**预期数值格式**:
| 列名 | 正确格式 | 错误格式（优化前） |
|------|---------|------------------|
| 第39周客单价 | ✅ `¥45.8` | ❌ `45.83492` |
| 第40周客单价 | ✅ `¥38.2` | ❌ `38.24561` |
| 客单价变化 | ✅ `¥-7.6` | ❌ `-7.593` |
| 变化幅度% | ✅ `-16.5%` | ❌ `-16.5` 或 `-16.593` |

**截图保存**: `测试截图2_表格格式.png`

---

### 步骤5：验证店内码和渠道（P0优化 - 字段扩展）

查看"主要下滑商品TOP5"列内容：

**优化前**:
```
❌ 可口可乐(¥3.5), 百事可乐(¥3.2), ...
   （只有商品名和价格）
```

**优化后（预期）**:
```
如果数据中包含店内码和渠道字段，结果表格应该有对应列显示
（注意：TOP5商品字符串中可能不直接显示，需要在后续详细分析中体现）
```

**验证方法**:
- 检查数据源是否有"店内码"和"渠道"字段
- 如果有，应该在聚合结果中看到这两个字段

---

### 步骤6：测试CSV导出（P0优化 - BOM编码）

1. 点击"⬇️ 导出CSV"按钮
2. 保存文件到本地（如 `客单价归因_20251015.csv`）
3. 用Excel双击打开文件

**预期结果**:

✅ **中文无乱码**
```
对比周期    第39周客单价    第40周客单价    客单价变化    变化幅度%
第39周 vs 第40周    45.8    38.2    -7.6    -16.5%
```

✅ **数值可操作**
- 第39周客单价列: 纯数值 `45.8`（无¥符号）
- 第40周客单价列: 纯数值 `38.2`（无¥符号）
- 客单价变化列: 纯数值 `-7.6`（无¥符号）
- 变化幅度%列: 带%符号 `-16.5%`（保留）

✅ **Excel功能正常**
- 可以对客单价列排序 ✓
- 可以对客单价列求和 ✓
- 可以对客单价列筛选 ✓

❌ **如果出现乱码**（优化失败）
```
�Ա����    ��39�ܿ͵���    ��40�ܿ͵���    �ͻ�������    �仯��%
```

**截图保存**: `测试截图3_CSV导出效果.png`

---

### 步骤7：测试跨周期对比（P1优化 - 灵活对比）

1. 返回配置区域
2. 修改周期选择：
   - 当前周期: 第40周
   - 对比周期: **第37周**（跨3周对比）
3. 点击"🔍 开始归因"

**预期**:
```
✅ 表头变化：
   - 对比周期: "第37周 vs 第40周"
   - 第37周客单价: ¥XX.X
   - 第40周客单价: ¥XX.X

✅ 数据正确反映两个周期的对比
✅ 可以用于分析节假日、促销活动的影响
```

**场景示例**:
- 国庆假期分析: "第40周（国庆周）vs 第37周（平时周）"
- 促销活动分析: "第40周（促销周）vs 第36周（无促销周）"

**截图保存**: `测试截图4_跨周期对比.png`

---

## 📊 测试结果记录表

| 测试项 | 优化点 | 预期结果 | 实际结果 | 状态 |
|--------|--------|---------|---------|------|
| 周期选择器 | P2 - UI助手 | 下拉菜单显示周数和日期 | [ ] | ⬜ |
| 表头动态显示 | P1 - 灵活对比 | 显示"第XX周客单价" | [ ] | ⬜ |
| 数值格式化 | P1 - 格式化 | ¥45.8、-16.5% | [ ] | ⬜ |
| CSV中文编码 | P0 - BOM | Excel无乱码 | [ ] | ⬜ |
| CSV数值格式 | P0 - 清理 | 客单价无¥，%保留 | [ ] | ⬜ |
| 店内码字段 | P0 - 字段扩展 | 结果包含店内码 | [ ] | ⬜ |
| 渠道字段 | P0 - 字段扩展 | 结果包含渠道 | [ ] | ⬜ |
| 跨周期对比 | P1 - 灵活对比 | 可选任意周期对比 | [ ] | ⬜ |

**填写说明**:
- 实际结果: 填写"通过"或描述具体问题
- 状态: ✅ 通过 / ❌ 失败 / ⚠️ 部分通过

---

## 🐛 问题反馈模板

如果测试发现问题，请使用以下模板反馈：

```markdown
### 问题描述
[详细描述问题现象]

### 重现步骤
1. 第一步操作
2. 第二步操作
3. ...

### 预期结果
[应该出现什么]

### 实际结果
[实际出现了什么]

### 截图
[粘贴相关截图]

### 环境信息
- 浏览器: Chrome / Edge / Firefox
- 数据文件: xxx.xlsx
- 时间: 2025-10-15 21:30
```

---

## ✅ 测试完成检查清单

完成所有测试后，请确认：

- [ ] 已测试周期选择器功能
- [ ] 已验证表格数值格式
- [ ] 已测试CSV导出（中文编码）
- [ ] 已测试CSV导出（数值格式）
- [ ] 已验证跨周期对比功能
- [ ] 已保存测试截图
- [ ] 已填写测试结果记录表
- [ ] 如有问题已使用模板反馈

---

## 📞 技术支持

如遇到测试问题，可查阅以下文档：

1. **详细优化说明**: `客单价归因分析优化总结.md`
2. **系统修改日志**: `系统修改日志.md`
3. **源代码**:
   - 后端引擎: `问题诊断引擎.py` 第329-502行
   - 前端界面: `智能门店经营看板_可视化.py` 第7757-7827行

---

**测试文档版本**: 1.0  
**最后更新**: 2025-10-15 21:26  
**预计测试时长**: 15-20分钟
