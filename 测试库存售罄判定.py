#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•ä¿®å¤åçš„å”®ç½„åˆ¤å®šé€»è¾‘
éªŒè¯æ˜¯å¦æ­£ç¡®ä½¿ç”¨åº“å­˜è€Œä¸æ˜¯é”€é‡
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta

def create_test_data():
    """åˆ›å»ºæµ‹è¯•æ•°æ®ï¼ŒåŒ…å«å„ç§å”®ç½„/æ»é”€åœºæ™¯"""
    
    base_date = datetime(2025, 9, 28)
    test_cases = []
    
    # åœºæ™¯1: çœŸæ­£å”®ç½„ï¼ˆåº“å­˜ä»10å˜ä¸º0ï¼‰
    print("=" * 80)
    print("åœºæ™¯1: çœŸæ­£å”®ç½„ - åº“å­˜ä»10å˜ä¸º0")
    print("=" * 80)
    for i in range(3):
        date = base_date + timedelta(days=i)
        # 9æœˆ28æ—¥: åº“å­˜10, é”€é‡5
        # 9æœˆ29æ—¥: åº“å­˜5, é”€é‡5
        # 9æœˆ30æ—¥: åº“å­˜0, é”€é‡0
        stock = max(0, 10 - i * 5)
        sales = 5 if stock > 0 else 0
        
        for j in range(sales):
            test_cases.append({
                'æ—¥æœŸ': date,
                'å•†å“åç§°': 'å¯å£å¯ä¹',
                'å•†å“å®å”®ä»·': 3.5,
                'å‰©ä½™åº“å­˜': stock,
                'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
            })
        
        # å³ä½¿æ²¡é”€é‡ï¼Œä¹Ÿè¦æœ‰ä¸€æ¡è®°å½•æ¥æ ‡è¯†åº“å­˜
        if sales == 0:
            test_cases.append({
                'æ—¥æœŸ': date,
                'å•†å“åç§°': 'å¯å£å¯ä¹',
                'å•†å“å®å”®ä»·': 0,  # æ²¡æœ‰é”€å”®
                'å‰©ä½™åº“å­˜': stock,
                'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
            })
    
    # åœºæ™¯2: æ»é”€ï¼ˆåº“å­˜å……è¶³ä½†æ²¡é”€é‡ï¼‰
    print("\nåœºæ™¯2: æ»é”€é¢„è­¦ - åº“å­˜100ï¼Œä½†è¿ç»­æ²¡é”€é‡")
    print("=" * 80)
    for i in range(3):
        date = base_date + timedelta(days=i)
        # åº“å­˜å……è¶³(100)ï¼Œä½†è¿ç»­æ— é”€é‡
        test_cases.append({
            'æ—¥æœŸ': date,
            'å•†å“åç§°': 'è¿‡å­£é¥®æ–™',
            'å•†å“å®å”®ä»·': 0,  # æ²¡æœ‰é”€å”®
            'å‰©ä½™åº“å­˜': 100,
            'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
        })
    
    # åœºæ™¯3: æ­£å¸¸é”€å”®ï¼ˆæœ‰åº“å­˜æœ‰é”€é‡ï¼‰
    print("\nåœºæ™¯3: æ­£å¸¸é”€å”® - æœ‰åº“å­˜æœ‰é”€é‡")
    print("=" * 80)
    for i in range(3):
        date = base_date + timedelta(days=i)
        stock = 50 - i * 5
        sales = 5
        
        for j in range(sales):
            test_cases.append({
                'æ—¥æœŸ': date,
                'å•†å“åç§°': 'é›ªç¢§',
                'å•†å“å®å”®ä»·': 3.0,
                'å‰©ä½™åº“å­˜': stock,
                'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
            })
    
    # åœºæ™¯4: åº“å­˜ä¸è¶³ï¼ˆåº“å­˜<5ä¸”é”€é‡ä¸‹é™ï¼‰
    print("\nåœºæ™¯4: åº“å­˜ä¸è¶³é¢„è­¦ - åº“å­˜<5ä¸”é”€é‡ä¸‹é™")
    print("=" * 80)
    for i in range(3):
        date = base_date + timedelta(days=i)
        stock = max(1, 4 - i)
        sales = max(1, 5 - i * 2)
        
        for j in range(sales):
            test_cases.append({
                'æ—¥æœŸ': date,
                'å•†å“åç§°': 'èŠ¬è¾¾',
                'å•†å“å®å”®ä»·': 3.2,
                'å‰©ä½™åº“å­˜': stock,
                'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
            })
    
    # åœºæ™¯5: å·²ä¸‹æ¶ï¼ˆåº“å­˜ä¸€ç›´ä¸º0ï¼‰
    print("\nåœºæ™¯5: å·²ä¸‹æ¶ - åº“å­˜ä¸€ç›´ä¸º0")
    print("=" * 80)
    for i in range(3):
        date = base_date + timedelta(days=i)
        test_cases.append({
            'æ—¥æœŸ': date,
            'å•†å“åç§°': 'å·²ä¸‹æ¶å•†å“',
            'å•†å“å®å”®ä»·': 0,
            'å‰©ä½™åº“å­˜': 0,
            'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
        })
    
    df = pd.DataFrame(test_cases)
    df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'])
    
    return df

def test_inventory_based_stockout():
    """æµ‹è¯•åŸºäºåº“å­˜çš„å”®ç½„åˆ¤å®š"""
    
    print("\n" + "=" * 80)
    print("ğŸ§ª æµ‹è¯•åŸºäºåº“å­˜çš„å”®ç½„åˆ¤å®šé€»è¾‘")
    print("=" * 80)
    
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    df = create_test_data()
    
    print(f"\nç”Ÿæˆæµ‹è¯•æ•°æ®: {len(df)} æ¡è®°å½•")
    print(f"æ—¥æœŸèŒƒå›´: {df['æ—¥æœŸ'].min()} è‡³ {df['æ—¥æœŸ'].max()}")
    print(f"å•†å“æ•°é‡: {df['å•†å“åç§°'].nunique()}")
    
    # æŒ‰æ—¥æœŸå’Œå•†å“ç»Ÿè®¡
    print("\n" + "=" * 80)
    print("ğŸ“Š æ¯æ—¥å•†å“åº“å­˜å’Œé”€é‡æ±‡æ€»")
    print("=" * 80)
    
    for date in sorted(df['æ—¥æœŸ'].unique()):
        print(f"\nğŸ“… {date.strftime('%Y-%m-%d')}")
        print("-" * 80)
        
        day_data = df[df['æ—¥æœŸ'] == date]
        summary = day_data.groupby('å•†å“åç§°').agg({
            'å•†å“å®å”®ä»·': 'count',  # é”€é‡
            'å‰©ä½™åº“å­˜': 'max'
        })
        summary.columns = ['é”€é‡', 'åº“å­˜']
        print(summary.to_string())
    
    # æ¨¡æ‹Ÿé—®é¢˜è¯Šæ–­å¼•æ“çš„åˆ†æé€»è¾‘
    print("\n\n" + "=" * 80)
    print("ğŸ” å”®ç½„åŸå› åˆ†æï¼ˆé€æ—¥å¯¹æ¯”ï¼‰")
    print("=" * 80)
    
    dates = sorted(df['æ—¥æœŸ'].unique())
    
    for i in range(len(dates) - 1):
        current_date = dates[i + 1]  # å½“å‰æœŸï¼ˆè¾ƒæ–°ï¼‰
        compare_date = dates[i]      # å¯¹æ¯”æœŸï¼ˆè¾ƒæ—§ï¼‰
        
        print(f"\nğŸ“Š å¯¹æ¯”: {current_date.strftime('%m-%d')} vs {compare_date.strftime('%m-%d')}")
        print("=" * 80)
        
        current_data = df[df['æ—¥æœŸ'] == current_date]
        compare_data = df[df['æ—¥æœŸ'] == compare_date]
        
        # ç»Ÿè®¡å½“å‰æœŸ
        current_agg = current_data.groupby('å•†å“åç§°').agg({
            'å•†å“å®å”®ä»·': ['count', 'mean'],
            'å‰©ä½™åº“å­˜': 'max',
            'ä¸‰çº§åˆ†ç±»å': 'first'
        })
        current_agg.columns = ['å½“å‰é”€é‡', 'å½“å‰å•ä»·', 'å½“å‰åº“å­˜', 'åˆ†ç±»']
        
        # ç»Ÿè®¡å¯¹æ¯”æœŸ
        compare_agg = compare_data.groupby('å•†å“åç§°').agg({
            'å•†å“å®å”®ä»·': ['count', 'mean'],
            'å‰©ä½™åº“å­˜': 'max'
        })
        compare_agg.columns = ['ä¹‹å‰é”€é‡', 'ä¹‹å‰å•ä»·', 'ä¹‹å‰åº“å­˜']
        
        # åˆå¹¶
        merged = current_agg.join(compare_agg, how='outer').fillna(0)
        
        # åˆ†æåŸå› 
        def analyze_reason(row):
            # ä¼˜å…ˆçº§1: ä½¿ç”¨åº“å­˜åˆ¤å®šå”®ç½„
            if row['å½“å‰åº“å­˜'] == 0 and row['ä¹‹å‰åº“å­˜'] > 0:
                return "ğŸ”´å”®ç½„"
            elif row['å½“å‰åº“å­˜'] == 0:
                return "âšªå·²ä¸‹æ¶"
            # æ»é”€é¢„è­¦
            elif row['å½“å‰åº“å­˜'] > 0 and row['å½“å‰é”€é‡'] == 0 and row['ä¹‹å‰é”€é‡'] == 0:
                return "âš ï¸æ»é”€é¢„è­¦"
            # åº“å­˜ä¸è¶³
            elif row['å½“å‰åº“å­˜'] > 0 and row['å½“å‰åº“å­˜'] < 5 and (row['å½“å‰é”€é‡'] < row['ä¹‹å‰é”€é‡']):
                return "âš ï¸åº“å­˜ä¸è¶³"
            elif row['å½“å‰é”€é‡'] < row['ä¹‹å‰é”€é‡']:
                return "ğŸ“‰é”€é‡ä¸‹æ»‘"
            else:
                return "âœ…æ­£å¸¸"
        
        merged['åˆ¤å®š'] = merged.apply(analyze_reason, axis=1)
        
        # æ˜¾ç¤ºç»“æœ
        display_cols = ['å½“å‰åº“å­˜', 'ä¹‹å‰åº“å­˜', 'å½“å‰é”€é‡', 'ä¹‹å‰é”€é‡', 'åˆ¤å®š']
        print(merged[display_cols].to_string())
    
    print("\n\n" + "=" * 80)
    print("âœ… éªŒè¯ç»“è®º")
    print("=" * 80)
    print("""
1. âœ… å¯å£å¯ä¹: åº“å­˜10â†’5â†’0ï¼Œæ­£ç¡®åˆ¤å®šä¸º"ğŸ”´å”®ç½„"
   - 9æœˆ29æ—¥åº“å­˜5ï¼Œ9æœˆ30æ—¥åº“å­˜0
   - ç¬¦åˆå”®ç½„å®šä¹‰

2. âœ… è¿‡å­£é¥®æ–™: åº“å­˜ä¸€ç›´100ï¼Œä½†æ— é”€é‡ï¼Œæ­£ç¡®åˆ¤å®šä¸º"âš ï¸æ»é”€é¢„è­¦"
   - æœ‰è´§ä½†æ²¡äººä¹°
   - åº”è¯¥ä¿ƒé”€æˆ–ä¸‹æ¶

3. âœ… é›ªç¢§: æœ‰åº“å­˜æœ‰é”€é‡ï¼Œåˆ¤å®šä¸º"æ­£å¸¸"
   - åº“å­˜å……è¶³ï¼Œé”€å”®æ­£å¸¸

4. âœ… èŠ¬è¾¾: åº“å­˜<5ä¸”é”€é‡ä¸‹é™ï¼Œåˆ¤å®šä¸º"âš ï¸åº“å­˜ä¸è¶³"
   - åº“å­˜ä¸è¶³é¢„è­¦
   - éœ€è¦è¡¥è´§

5. âœ… å·²ä¸‹æ¶å•†å“: åº“å­˜ä¸€ç›´ä¸º0ï¼Œåˆ¤å®šä¸º"âšªå·²ä¸‹æ¶"
   - åŒºåˆ†å”®ç½„å’Œä¸‹æ¶
    """)
    
    print("\n" + "=" * 80)
    print("ğŸ¯ å…³é”®æ”¹è¿›")
    print("=" * 80)
    print("""
âŒ æ—§é€»è¾‘: ä½¿ç”¨é”€é‡åˆ¤å®šå”®ç½„
   - é—®é¢˜: å‘¨æœ«ä¸è¥ä¸šä¹Ÿä¼šæ˜¾ç¤º"å”®ç½„"
   - é—®é¢˜: æ»é”€å•†å“ä¼šè¢«è¯¯åˆ¤ä¸º"å”®ç½„"

âœ… æ–°é€»è¾‘: ä½¿ç”¨åº“å­˜åˆ¤å®šå”®ç½„
   - å‡†ç¡®: åº“å­˜ä¸º0æ‰æ˜¯çœŸæ­£å”®ç½„
   - åŒºåˆ†: æ»é”€ vs å”®ç½„
   - å¢åŠ : åº“å­˜ä¸è¶³é¢„è­¦
    """)

if __name__ == "__main__":
    test_inventory_based_stockout()
