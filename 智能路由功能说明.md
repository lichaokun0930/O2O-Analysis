# 智能查询路由功能说明

## 功能概述

智能查询路由根据数据量自动选择最优查询引擎：
- **数据量 < 100万条**: 使用 PostgreSQL + 预聚合表（低延迟）
- **数据量 ≥ 100万条**: 自动切换到 DuckDB + Parquet（高吞吐）

## 当前状态

| 指标 | 值 |
|------|-----|
| 数据量 | 429,855 条 |
| 切换阈值 | 1,000,000 条 |
| 当前引擎 | PostgreSQL |
| 还需数据 | 570,145 条 |

## 性能对比

| 引擎 | 平均耗时 | 加速比 |
|------|----------|--------|
| PostgreSQL | 192ms | 1x |
| DuckDB | 25ms | **7.78x** |

## API 端点

### 查看路由状态
```
GET /api/v1/observability/query-router/status
```

### 刷新路由状态
```
POST /api/v1/observability/query-router/refresh
```

### 强制切换引擎（测试用）
```
POST /api/v1/observability/query-router/force-engine?engine=duckdb
POST /api/v1/observability/query-router/force-engine?engine=postgresql
```

### 测试智能路由
```
GET /api/v1/observability/query-router/test
```

## 验证方法

### 方法1: 本地验证（不需要重启后端）
```powershell
python 验证智能路由.py
```

### 方法2: API 测试（需要重启后端）
```powershell
# 重启后端后运行
python 测试智能路由切换.py
```

## 重启后端

如果需要使用新的 API 端点，请重启后端服务：

1. 关闭当前后端窗口
2. 重新运行启动脚本：
   - 开发模式: `一键启动React.ps1` 选择 1
   - 生产模式: `一键启动Nginx生产版.ps1`

## 智能切换逻辑

```
┌─────────────────────────────────────────────────────────┐
│                    查询请求                              │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │  数据量 ≥ 100万？      │
              └───────────────────────┘
                    │           │
                   是          否
                    │           │
                    ▼           ▼
          ┌─────────────┐  ┌─────────────┐
          │ DuckDB 可用？│  │ PostgreSQL  │
          └─────────────┘  └─────────────┘
              │     │
             是    否
              │     │
              ▼     ▼
        ┌─────────┐ ┌─────────────┐
        │ DuckDB  │ │ PostgreSQL  │
        │ Parquet │ │ (降级)      │
        └─────────┘ └─────────────┘
```

## 启动时显示

启动脚本会在终端显示智能路由状态：

```
============================================================
  智能查询路由引擎
============================================================

  数据量: 429,855 条 (中型数据)
  切换阈值: 1,000,000 条

  查询引擎状态:
    (OK) PostgreSQL: 可用
    (OK) DuckDB: 可用

  当前引擎: POSTGRESQL
  智能切换: 数据量达到 1,000,000 条后自动切换到 DuckDB
            (还需 570,145 条)
```
