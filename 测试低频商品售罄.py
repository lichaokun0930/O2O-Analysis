#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•ä½é¢‘å•†å“å”®ç½„åˆ¤å®šä¿®å¤
éªŒè¯28å¯¸è¡Œæç®±æ¡ˆä¾‹
"""

import pandas as pd
from datetime import datetime, timedelta

def test_low_frequency_stockout():
    """æµ‹è¯•ä½é¢‘å•†å“å”®ç½„åˆ¤å®š"""
    
    print("=" * 80)
    print("ğŸ§ª æµ‹è¯•ä½é¢‘å•†å“å”®ç½„åˆ¤å®šï¼ˆ28å¯¸è¡Œæç®±æ¡ˆä¾‹ï¼‰")
    print("=" * 80)
    
    # åˆ›å»ºæµ‹è¯•æ•°æ®
    base_date = datetime(2025, 9, 22)
    test_data = []
    
    # åœºæ™¯1: 28å¯¸è¡Œæç®±ï¼ˆä½é¢‘å•†å“ï¼‰
    # 9æœˆ22æ—¥: åº“å­˜1ï¼Œä½†æ— äººè´­ä¹°ï¼ˆæ— è®¢å•è®°å½•ï¼‰
    # 9æœˆ23æ—¥: å–å‡º1ä»¶ï¼Œåº“å­˜å˜0
    
    print("\n" + "=" * 80)
    print("ğŸ“¦ åœºæ™¯1: ä½é¢‘å•†å“å”®ç½„ï¼ˆ28å¯¸è¡Œæç®±ï¼‰")
    print("=" * 80)
    print("""
å•†å“: 28å¯¸è¡Œæç®±
9æœˆ1æ—¥-21æ—¥: åº“å­˜1ä»¶ï¼Œæ— äººè´­ä¹°
9æœˆ22æ—¥: åº“å­˜1ä»¶ï¼Œæ— äººè´­ä¹° (æ— è®¢å•è®°å½•)
9æœˆ23æ—¥: å–å‡º1ä»¶ï¼Œåº“å­˜å˜ä¸º0
    """)
    
    # 9æœˆ22æ—¥: æ²¡æœ‰è®¢å•è®°å½•ï¼ˆå› ä¸ºæ²¡äººä¹°ï¼‰
    # æ‰€ä»¥è¿™ä¸€å¤©ä¸ä¼šæœ‰è¿™ä¸ªå•†å“çš„æ•°æ®
    
    # 9æœˆ23æ—¥: æœ‰1æ¡è®¢å•è®°å½•ï¼ˆå–å‡º1ä»¶ï¼‰
    test_data.append({
        'æ—¥æœŸ': base_date + timedelta(days=1),  # 9æœˆ23æ—¥
        'å•†å“åç§°': '28å¯¸è¡Œæç®±',
        'å•†å“å®å”®ä»·': 199.0,
        'å‰©ä½™åº“å­˜': 0,  # å–å‡ºååº“å­˜ä¸º0
        'ä¸‰çº§åˆ†ç±»å': 'è¡Œæç®±'
    })
    
    # åœºæ™¯2: å¯å£å¯ä¹ï¼ˆé«˜é¢‘å•†å“ï¼‰
    # 9æœˆ22æ—¥: åº“å­˜10ï¼Œå–å‡º5ä»¶
    # 9æœˆ23æ—¥: åº“å­˜5ï¼Œå–å‡º5ä»¶ï¼Œåº“å­˜å˜0
    
    print("=" * 80)
    print("ğŸ“¦ åœºæ™¯2: é«˜é¢‘å•†å“å”®ç½„ï¼ˆå¯å£å¯ä¹ï¼‰")
    print("=" * 80)
    print("""
å•†å“: å¯å£å¯ä¹
9æœˆ22æ—¥: åº“å­˜10ä»¶ï¼Œå–å‡º5ä»¶ (æœ‰è®¢å•è®°å½•)
9æœˆ23æ—¥: åº“å­˜5ä»¶ï¼Œå–å‡º5ä»¶ï¼Œåº“å­˜å˜0
    """)
    
    # 9æœˆ22æ—¥: 5æ¡è®¢å•è®°å½•
    for i in range(5):
        test_data.append({
            'æ—¥æœŸ': base_date,  # 9æœˆ22æ—¥
            'å•†å“åç§°': 'å¯å£å¯ä¹',
            'å•†å“å®å”®ä»·': 3.5,
            'å‰©ä½™åº“å­˜': 5,  # å–å‡ºåå‰©ä½™5ä»¶
            'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
        })
    
    # 9æœˆ23æ—¥: 5æ¡è®¢å•è®°å½•
    for i in range(5):
        test_data.append({
            'æ—¥æœŸ': base_date + timedelta(days=1),  # 9æœˆ23æ—¥
            'å•†å“åç§°': 'å¯å£å¯ä¹',
            'å•†å“å®å”®ä»·': 3.5,
            'å‰©ä½™åº“å­˜': 0,  # å–å‡ºååº“å­˜ä¸º0
            'ä¸‰çº§åˆ†ç±»å': 'é¥®æ–™'
        })
    
    # åœºæ™¯3: å·²ä¸‹æ¶å•†å“
    # 9æœˆ22æ—¥: æ— åº“å­˜æ— é”€é‡
    # 9æœˆ23æ—¥: æ— åº“å­˜æ— é”€é‡
    
    print("=" * 80)
    print("ğŸ“¦ åœºæ™¯3: çœŸæ­£çš„å·²ä¸‹æ¶å•†å“")
    print("=" * 80)
    print("""
å•†å“: å·²ä¸‹æ¶å•†å“
9æœˆ22æ—¥: åº“å­˜0ï¼Œæ— è®¢å•
9æœˆ23æ—¥: åº“å­˜0ï¼Œæ— è®¢å•
    """)
    
    # åˆ›å»ºDataFrame
    df = pd.DataFrame(test_data)
    df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'])
    
    print("\n" + "=" * 80)
    print("ğŸ“Š åŸå§‹æ•°æ®")
    print("=" * 80)
    print(df.to_string())
    
    # æ¨¡æ‹Ÿé—®é¢˜è¯Šæ–­å¼•æ“çš„åˆ†æé€»è¾‘
    print("\n\n" + "=" * 80)
    print("ğŸ” å”®ç½„åˆ¤å®šåˆ†æï¼ˆ9æœˆ23æ—¥ vs 9æœˆ22æ—¥ï¼‰")
    print("=" * 80)
    
    current_date = datetime(2025, 9, 23)
    compare_date = datetime(2025, 9, 22)
    
    current_data = df[df['æ—¥æœŸ'].dt.date == current_date.date()]
    compare_data = df[df['æ—¥æœŸ'].dt.date == compare_date.date()]
    
    print(f"\nå½“å‰æœŸï¼ˆ9æœˆ23æ—¥ï¼‰æ•°æ®æ¡æ•°: {len(current_data)}")
    print(f"å¯¹æ¯”æœŸï¼ˆ9æœˆ22æ—¥ï¼‰æ•°æ®æ¡æ•°: {len(compare_data)}")
    
    # ç»Ÿè®¡å½“å‰æœŸ
    if not current_data.empty:
        current_agg = current_data.groupby('å•†å“åç§°').agg({
            'å•†å“å®å”®ä»·': ['count', 'mean'],
            'å‰©ä½™åº“å­˜': 'max',
            'ä¸‰çº§åˆ†ç±»å': 'first'
        })
        current_agg.columns = ['å½“å‰é”€é‡', 'å½“å‰å•ä»·', 'å½“å‰åº“å­˜', 'åˆ†ç±»']
    else:
        current_agg = pd.DataFrame()
    
    # ç»Ÿè®¡å¯¹æ¯”æœŸ
    if not compare_data.empty:
        compare_agg = compare_data.groupby('å•†å“åç§°').agg({
            'å•†å“å®å”®ä»·': ['count', 'mean'],
            'å‰©ä½™åº“å­˜': 'max'
        })
        compare_agg.columns = ['ä¹‹å‰é”€é‡', 'ä¹‹å‰å•ä»·', 'ä¹‹å‰åº“å­˜']
    else:
        compare_agg = pd.DataFrame()
    
    # åˆå¹¶
    merged = current_agg.join(compare_agg, how='outer').fillna(0)
    
    print("\n" + "=" * 80)
    print("ğŸ“ˆ èšåˆåçš„å•†å“æ•°æ®")
    print("=" * 80)
    print(merged.to_string())
    
    # åˆ†æåŸå› ï¼ˆä½¿ç”¨ä¿®å¤åçš„é€»è¾‘ï¼‰
    def analyze_reason(row):
        # ä¼˜å…ˆçº§1: ä½¿ç”¨åº“å­˜åˆ¤å®šå”®ç½„
        if 'å½“å‰åº“å­˜' in row.index and 'ä¹‹å‰åº“å­˜' in row.index:
            # æ ‡å‡†å”®ç½„åˆ¤å®š
            if row['å½“å‰åº“å­˜'] == 0 and row['ä¹‹å‰åº“å­˜'] > 0:
                return "ğŸ”´å”®ç½„(æ ‡å‡†)"
            
            # ğŸ†• ç‰¹æ®Šæƒ…å†µ: ä½é¢‘å•†å“å”®ç½„
            elif (row['å½“å‰åº“å­˜'] == 0 and 
                  row['ä¹‹å‰åº“å­˜'] == 0 and 
                  row['å½“å‰é”€é‡'] > 0 and 
                  row['ä¹‹å‰é”€é‡'] == 0):
                return "ğŸ”´å”®ç½„(ä½é¢‘å•†å“)"
            
            # çœŸæ­£çš„å·²ä¸‹æ¶
            elif row['å½“å‰åº“å­˜'] == 0:
                return "âšªå·²ä¸‹æ¶"
            
            else:
                return "âœ…æ­£å¸¸"
        else:
            return "â“æ— åº“å­˜æ•°æ®"
    
    merged['åˆ¤å®š'] = merged.apply(analyze_reason, axis=1)
    
    print("\n" + "=" * 80)
    print("ğŸ¯ å”®ç½„åˆ¤å®šç»“æœ")
    print("=" * 80)
    
    result_cols = ['å½“å‰åº“å­˜', 'ä¹‹å‰åº“å­˜', 'å½“å‰é”€é‡', 'ä¹‹å‰é”€é‡', 'åˆ¤å®š']
    print(merged[result_cols].to_string())
    
    print("\n\n" + "=" * 80)
    print("âœ… éªŒè¯ç»“è®º")
    print("=" * 80)
    
    # éªŒè¯28å¯¸è¡Œæç®±
    if '28å¯¸è¡Œæç®±' in merged.index:
        luggage_result = merged.loc['28å¯¸è¡Œæç®±', 'åˆ¤å®š']
        print(f"\n1. 28å¯¸è¡Œæç®±åˆ¤å®š: {luggage_result}")
        
        if luggage_result == "ğŸ”´å”®ç½„(ä½é¢‘å•†å“)":
            print("   âœ… æ­£ç¡®ï¼è¯†åˆ«å‡ºä½é¢‘å•†å“å”®ç½„")
            print("   è¯´æ˜: ä¹‹å‰æ— è®¢å•è®°å½•(åº“å­˜0é”€é‡0)ï¼Œå½“å‰å–å‡ºååº“å­˜ä¸º0")
            print("   åŸå› : è¿™æ˜¯ä½é¢‘å•†å“ï¼Œä¹‹å‰æ²¡äººä¹°æ‰€ä»¥æ— è®¢å•è®°å½•")
        else:
            print(f"   âŒ é”™è¯¯ï¼åº”è¯¥åˆ¤å®šä¸º'ğŸ”´å”®ç½„(ä½é¢‘å•†å“)'ï¼Œå®é™…åˆ¤å®šä¸º'{luggage_result}'")
    else:
        print("\n1. 28å¯¸è¡Œæç®±: âŒ æœªå‡ºç°åœ¨ç»“æœä¸­ï¼ˆæ•°æ®é—®é¢˜ï¼‰")
    
    # éªŒè¯å¯å£å¯ä¹
    if 'å¯å£å¯ä¹' in merged.index:
        cola_result = merged.loc['å¯å£å¯ä¹', 'åˆ¤å®š']
        print(f"\n2. å¯å£å¯ä¹åˆ¤å®š: {cola_result}")
        
        if cola_result == "ğŸ”´å”®ç½„(æ ‡å‡†)":
            print("   âœ… æ­£ç¡®ï¼æ ‡å‡†å”®ç½„åˆ¤å®š")
            print("   è¯´æ˜: ä¹‹å‰åº“å­˜5ï¼Œå½“å‰åº“å­˜0")
        else:
            print(f"   âŒ é”™è¯¯ï¼åº”è¯¥åˆ¤å®šä¸º'ğŸ”´å”®ç½„(æ ‡å‡†)'ï¼Œå®é™…åˆ¤å®šä¸º'{cola_result}'")
    else:
        print("\n2. å¯å£å¯ä¹: âŒ æœªå‡ºç°åœ¨ç»“æœä¸­ï¼ˆæ•°æ®é—®é¢˜ï¼‰")
    
    print("\n" + "=" * 80)
    print("ğŸ¯ å…³é”®æ”¹è¿›")
    print("=" * 80)
    print("""
âŒ ä¿®å¤å‰:
   28å¯¸è¡Œæç®±: âšªå·²ä¸‹æ¶ (é”™è¯¯)
   åŸå› : æ— æ³•è¯†åˆ«ä½é¢‘å•†å“å”®ç½„åœºæ™¯

âœ… ä¿®å¤å:
   28å¯¸è¡Œæç®±: ğŸ”´å”®ç½„(ä½é¢‘å•†å“) (æ­£ç¡®)
   åŸå› : å¢åŠ äº†ä½é¢‘å•†å“å”®ç½„çš„åˆ¤å®šé€»è¾‘
   
åˆ¤å®šæ¡ä»¶:
   å½“å‰åº“å­˜ = 0
   ä¹‹å‰åº“å­˜ = 0 (å› ä¸ºæ— è®¢å•è®°å½•)
   å½“å‰é”€é‡ > 0 (å½“å‰å–å‡ºäº†)
   ä¹‹å‰é”€é‡ = 0 (ä¹‹å‰æ²¡å–å‡º)
   â†’ ğŸ”´å”®ç½„(ä½é¢‘å•†å“)
    """)

if __name__ == "__main__":
    test_low_frequency_stockout()
