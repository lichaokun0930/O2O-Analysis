# 涨价降价定义和计算逻辑说明

## 📊 核心计算公式

### 1. 单价计算
```python
# 当前单价 = 当前周期商品平均售价
当前单价 = current_data.groupby('商品名称')['商品实售价'].mean()

# 之前单价 = 对比周期商品平均售价
之前单价 = compare_data.groupby('商品名称')['商品实售价'].mean()
```

### 2. 单价变化计算
```python
# 单价变化(绝对值) = 当前单价 - 之前单价
单价变化 = 当前单价 - 之前单价

# 单价变化率(百分比) = (当前单价 - 之前单价) / 之前单价 * 100
单价变化率 = ((当前单价 - 之前单价) / 之前单价) * 100
```

---

## 🎯 涨价降价判定标准

### 涨价判定: 单价变化率 > 5%
```python
if 单价变化率 > 5:
    判定为"涨价"
```

**示例**:
- 之前单价: ¥10.0
- 当前单价: ¥10.6
- 单价变化: ¥+0.6
- 单价变化率: (10.6 - 10.0) / 10.0 * 100 = **6%**
- **判定**: ✅ 涨价 (6% > 5%)

### 降价判定: 单价变化率 < -5%
```python
if 单价变化率 < -5:
    判定为"降价"
```

**示例**:
- 之前单价: ¥10.0
- 当前单价: ¥9.4
- 单价变化: ¥-0.6
- 单价变化率: (9.4 - 10.0) / 10.0 * 100 = **-6%**
- **判定**: ✅ 降价 (-6% < -5%)

### 价格稳定: -5% ≤ 单价变化率 ≤ 5%
```python
if -5 <= 单价变化率 <= 5:
    判定为"价格稳定"
```

**示例**:
- 之前单价: ¥10.0
- 当前单价: ¥10.3
- 单价变化: ¥+0.3
- 单价变化率: (10.3 - 10.0) / 10.0 * 100 = **3%**
- **判定**: ✅ 价格稳定 (3% 在 -5%~5% 范围内)

---

## 🏷️ 下滑原因判定逻辑

完整的决策树逻辑:

```python
def analyze_reason(row):
    # 优先级1: 售罄判定
    if row['当前销量'] == 0 and row['之前销量'] > 0:
        return "🔴售罄"
    
    # 优先级2: 新品判定
    elif row['当前销量'] == 0:
        return "⚪新品"
    
    # 优先级3: 涨价判定 (单价变化率 > 5%)
    elif row['单价变化率'] > 5:
        if row['销量变化'] < 0:
            return "💰涨价导致销量降"
        else:
            return "💰涨价(销量增)"
    
    # 优先级4: 降价判定 (单价变化率 < -5%)
    elif row['单价变化率'] < -5:
        if row['销量变化'] < 0:
            return "💸降价仍降量"
        else:
            return "💸降价促销成功"
    
    # 优先级5: 销量大幅下滑 (销量下降>30%)
    elif row['销量变化'] < -row['之前销量'] * 0.3:
        return "📉销量大幅下滑"
    
    # 优先级6: 销量小幅下滑
    elif row['销量变化'] < 0:
        return "📉销量小幅下滑"
    
    # 优先级7: 正常
    else:
        return "✅正常"
```

---

## 💡 判定标准详解

### 为什么选择 ±5% 作为阈值?

#### 1. 业务合理性
- **±5% 是显著的价格变化**
  - 对于¥10商品: ±¥0.5 (消费者能明显感知)
  - 对于¥100商品: ±¥5 (显著影响购买决策)
  
- **过滤价格波动噪音**
  - 日常价格微调 (±1-2%) 不算涨价降价
  - 避免把正常价格波动误判为策略调整

#### 2. 统计显著性
- ±5% 的变化通常代表:
  - 有意识的定价策略调整
  - 促销活动或竞争响应
  - 成本变化传导

#### 3. 实际案例
```
商品A: ¥10.0 → ¥10.2 (变化率 +2%)
判定: 价格稳定 ✅
原因: 可能是成本微调,不构成涨价策略

商品B: ¥10.0 → ¥10.6 (变化率 +6%)
判定: 涨价 ⚠️
原因: 显著涨价,可能影响销量

商品C: ¥10.0 → ¥9.3 (变化率 -7%)
判定: 降价 💰
原因: 明显促销,期待销量提升
```

---

## 📈 完整判定示例

### 示例1: 涨价导致销量降
```python
商品: 可口可乐
之前单价: ¥3.5
当前单价: ¥4.0
之前销量: 100件
当前销量: 80件

计算:
- 单价变化 = 4.0 - 3.5 = +0.5元
- 单价变化率 = (4.0 - 3.5) / 3.5 * 100 = +14.3%
- 销量变化 = 80 - 100 = -20件

判定逻辑:
1. 当前销量 > 0 → ✅ 非售罄
2. 单价变化率 +14.3% > 5% → ✅ 涨价
3. 销量变化 -20 < 0 → ✅ 销量下降

结果: 💰涨价导致销量降
```

### 示例2: 降价仍降量
```python
商品: 洗发水
之前单价: ¥15.0
当前单价: ¥12.0
之前销量: 50件
当前销量: 40件

计算:
- 单价变化 = 12.0 - 15.0 = -3.0元
- 单价变化率 = (12.0 - 15.0) / 15.0 * 100 = -20%
- 销量变化 = 40 - 50 = -10件

判定逻辑:
1. 当前销量 > 0 → ✅ 非售罄
2. 单价变化率 -20% < -5% → ✅ 降价
3. 销量变化 -10 < 0 → ✅ 销量下降

结果: 💸降价仍降量
```

### 示例3: 销量大幅下滑(价格稳定)
```python
商品: 红牛
之前单价: ¥6.5
当前单价: ¥6.5
之前销量: 100件
当前销量: 60件

计算:
- 单价变化 = 6.5 - 6.5 = 0元
- 单价变化率 = 0%
- 销量变化 = 60 - 100 = -40件
- 销量变化率 = -40 / 100 = -40%

判定逻辑:
1. 当前销量 > 0 → ✅ 非售罄
2. 单价变化率 0% 在 -5%~5% 范围内 → ✅ 价格稳定
3. 销量变化 -40 < -100*0.3 → ✅ 销量下降>30%

结果: 📉销量大幅下滑
```

### 示例4: 降价促销成功
```python
商品: 薯片
之前单价: ¥5.0
当前单价: ¥4.0
之前销量: 80件
当前销量: 120件

计算:
- 单价变化 = 4.0 - 5.0 = -1.0元
- 单价变化率 = (4.0 - 5.0) / 5.0 * 100 = -20%
- 销量变化 = 120 - 80 = +40件

判定逻辑:
1. 当前销量 > 0 → ✅ 非售罄
2. 单价变化率 -20% < -5% → ✅ 降价
3. 销量变化 +40 > 0 → ✅ 销量上升

结果: 💸降价促销成功
```

---

## 🔧 自定义阈值

如果需要调整涨价降价的判定标准,修改以下代码:

### 文件位置
`问题诊断引擎.py` 第837-857行

### 当前阈值
```python
# 涨价阈值: 5%
elif row['单价变化率'] > 5:

# 降价阈值: -5%
elif row['单价变化率'] < -5:

# 销量大幅下滑阈值: 30%
elif row['销量变化'] < -row['之前销量'] * 0.3:
```

### 修改示例

#### 场景1: 更严格的涨降价判定(±10%)
```python
# 涨价阈值改为10%
elif row['单价变化率'] > 10:  # 之前是5

# 降价阈值改为-10%
elif row['单价变化率'] < -10:  # 之前是-5
```

#### 场景2: 更宽松的涨降价判定(±3%)
```python
# 涨价阈值改为3%
elif row['单价变化率'] > 3:  # 之前是5

# 降价阈值改为-3%
elif row['单价变化率'] < -3:  # 之前是-5
```

#### 场景3: 调整销量大幅下滑阈值(50%)
```python
# 销量大幅下滑阈值改为50%
elif row['销量变化'] < -row['之前销量'] * 0.5:  # 之前是0.3(30%)
```

---

## 📊 阈值选择建议

### 不同业务场景的推荐阈值

| 业务场景 | 涨降价阈值 | 销量下滑阈值 | 说明 |
|---------|-----------|-------------|------|
| **高频快消品** | ±3% | 20% | 价格敏感,波动频繁 |
| **标准零售** | **±5%** ⭐ | **30%** ⭐ | **当前默认值,适合大多数场景** |
| **高价低频商品** | ±10% | 40% | 价格稳定,销量波动大 |
| **促销频繁** | ±3% | 20% | 需要捕捉小幅价格调整 |
| **价格敏感行业** | ±2% | 15% | 微小变化都需要关注 |

---

## ⚙️ 计算实现代码

### 完整代码片段
```python
# 1. 聚合商品数据
current_agg = current_data.groupby('商品名称').agg({
    '商品实售价': ['mean', 'sum', 'count'],  # 平均单价、销售额、销量
    '三级分类名': 'first'
})

compare_agg = compare_data.groupby('商品名称').agg({
    '商品实售价': ['mean', 'sum', 'count']
})

# 2. 合并数据
merged = current_agg.join(compare_agg, how='outer').fillna(0)

# 3. 计算变化指标
merged['单价变化'] = merged['当前单价'] - merged['之前单价']
merged['单价变化率'] = ((merged['当前单价'] - merged['之前单价']) 
                       / merged['之前单价'] * 100).fillna(0)
merged['销量变化'] = merged['当前销量'] - merged['之前销量']

# 4. 判定原因
def analyze_reason(row):
    if row['当前销量'] == 0 and row['之前销量'] > 0:
        return "🔴售罄"
    elif row['单价变化率'] > 5:  # 涨价阈值
        if row['销量变化'] < 0:
            return "💰涨价导致销量降"
        else:
            return "💰涨价(销量增)"
    elif row['单价变化率'] < -5:  # 降价阈值
        if row['销量变化'] < 0:
            return "💸降价仍降量"
        else:
            return "💸降价促销成功"
    elif row['销量变化'] < -row['之前销量'] * 0.3:  # 销量大幅下滑阈值
        return "📉销量大幅下滑"
    elif row['销量变化'] < 0:
        return "📉销量小幅下滑"
    else:
        return "✅正常"

merged['下滑原因'] = merged.apply(analyze_reason, axis=1)
```

---

## 📝 总结

### 核心公式
```
单价变化率 = (当前单价 - 之前单价) / 之前单价 * 100
```

### 判定标准
| 判定结果 | 条件 |
|---------|------|
| 💰**涨价** | 单价变化率 > **5%** |
| 💸**降价** | 单价变化率 < **-5%** |
| 📊**价格稳定** | -5% ≤ 单价变化率 ≤ 5% |

### 阈值选择
- **默认值**: ±5% (适合大多数零售场景)
- **可自定义**: 根据业务特点调整
- **建议范围**: ±2% ~ ±10%

---

**文档维护**: 问题诊断引擎开发团队  
**最后更新**: 2025-10-16  
**相关文件**: `问题诊断引擎.py` (第837-857行)
