# å­—æ®µå…¼å®¹æ€§å®Œæ•´ä¿®å¤è¯´æ˜

## ä¿®å¤æ¦‚è¿°

**ä¿®å¤æ—¥æœŸ:** 2025å¹´11æœˆ22æ—¥  
**é—®é¢˜æè¿°:** Bç”µè„‘å…‹éš†å,ä¸€çº§åˆ†ç±»é”€å”®è¶‹åŠ¿ä¸­çš„æ»é”€å“ç»Ÿè®¡å’Œåº“å­˜å‘¨è½¬ç»Ÿè®¡æ— æ•°æ®  
**æ ¹æœ¬åŸå› :** 
1. models.pyç¼ºå°‘4ä¸ªæ•°æ®åº“å­—æ®µå®šä¹‰
2. ä»£ç ä¸­å­—æ®µåæ£€æŸ¥ä¸å…¼å®¹ä¸­è‹±æ–‡å­—æ®µ

---

## é—®é¢˜åˆ†æ

### 1. å­—æ®µå®šä¹‰ç¼ºå¤±

**æ•°æ®åº“å­—æ®µ(44ä¸ª):**
```sql
-- å®Œæ•´å­—æ®µåˆ—è¡¨
id, order_id, date, store_name, product_id, product_name, barcode,
category_level1, category_level3, price, original_price, cost, actual_price,
quantity, amount, profit, profit_margin,
delivery_fee, commission, scene, time_period, address, channel,
created_at, updated_at,
user_paid_delivery_fee, delivery_discount, full_reduction, product_discount,
merchant_voucher, merchant_share, packaging_fee,
delivery_distance, city, store_id, stock,  -- â­ æ–°å¢å­—æ®µ
gift_amount, other_merchant_discount, new_customer_discount, corporate_rebate,
delivery_platform, platform_service_fee, store_franchise_type, remaining_stock  -- â­ æ–°å¢å­—æ®µ
```

**models.pyå­—æ®µ(ä¿®å¤å‰40ä¸ª):**
```python
# ç¼ºå°‘ä»¥ä¸‹å­—æ®µ:
- stock (åº“å­˜)
- delivery_distance (é…é€è·ç¦»)
- store_id (é—¨åº—ID)
- city (åŸå¸‚)
```

### 2. å­—æ®µåæ£€æŸ¥ä¸å…¼å®¹

**é—®é¢˜ä»£ç :**
```python
# Line 9613: åªæ£€æŸ¥ä¸­æ–‡å­—æ®µå
elif field == 'åº“å­˜' and 'å‰©ä½™åº“å­˜' in df.columns:
    required_fields[field] = True  # âŒ ä¸æ”¯æŒè‹±æ–‡å­—æ®µå

# Line 9754: åªæ£€æŸ¥éƒ¨åˆ†ä¸­æ–‡å­—æ®µ
stock_col = 'åº“å­˜' if 'åº“å­˜' in df.columns else 'å‰©ä½™åº“å­˜' if 'å‰©ä½™åº“å­˜' in df.columns else None
# âŒ ä¸æ”¯æŒ stock, remaining_stock
```

**æ•°æ®åº“å®é™…å­—æ®µå:**
- `stock` (è‹±æ–‡)
- `remaining_stock` (è‹±æ–‡)

**å¯¼è‡´ç»“æœ:**
```python
required_fields['åº“å­˜'] = False  # âŒ å­—æ®µæ£€æŸ¥å¤±è´¥
# â†“
# Line 9810: å”®ç½„å“ç»Ÿè®¡è·³è¿‡
if required_fields['æ—¥æœŸ'] and required_fields['åº“å­˜'] and stock_col:
    # è®¡ç®—å”®ç½„å“
else:
    category_stats['å”®ç½„å“æ•°'] = 0  # âŒ ç›´æ¥èµ‹å€¼0

# Line 9830: æ»é”€å“ç»Ÿè®¡è·³è¿‡
if required_fields['æ—¥æœŸ'] and required_fields['åº“å­˜'] and stock_col:
    # è®¡ç®—æ»é”€å“
else:
    category_stats['æ»é”€å“æ€»æ•°'] = 0  # âŒ ç›´æ¥èµ‹å€¼0

# Line 9880: åº“å­˜å‘¨è½¬è·³è¿‡
if required_fields['æ—¥æœŸ'] and required_fields['åº“å­˜'] and required_fields['æœˆå”®'] and stock_col:
    # è®¡ç®—åº“å­˜å‘¨è½¬
else:
    category_stats['åº“å­˜å‘¨è½¬å¤©æ•°'] = 0  # âŒ ç›´æ¥èµ‹å€¼0
```

---

## å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: åŒæ­¥models.pyå­—æ®µå®šä¹‰

**æ–‡ä»¶:** `database/models.py`

**ä¿®æ”¹ä½ç½®1 (Line 42-47):**
```python
# ä¿®å¤å‰
class Order(Base):
    quantity = Column(Integer, default=1, comment='é”€é‡')
    remaining_stock = Column(Float, default=0, comment='å‰©ä½™åº“å­˜')
    amount = Column(Float, comment='é”€å”®é¢')

# ä¿®å¤å
class Order(Base):
    quantity = Column(Integer, default=1, comment='é”€é‡')
    stock = Column(Integer, default=0, comment='åº“å­˜')  # âœ… æ–°å¢
    remaining_stock = Column(Float, default=0, comment='å‰©ä½™åº“å­˜')
    amount = Column(Float, comment='é”€å”®é¢')
```

**ä¿®æ”¹ä½ç½®2 (Line 68-71):**
```python
# ä¿®å¤å‰
delivery_platform = Column(String(100), index=True, comment='é…é€å¹³å°')
store_franchise_type = Column(Integer, index=True, comment='é—¨åº—åŠ ç›Ÿç±»å‹')

# ä¿®å¤å
delivery_platform = Column(String(100), index=True, comment='é…é€å¹³å°')
delivery_distance = Column(Float, default=0, comment='é…é€è·ç¦»(å…¬é‡Œ)')  # âœ… æ–°å¢

store_id = Column(String(100), index=True, comment='é—¨åº—ID')  # âœ… æ–°å¢
store_franchise_type = Column(Integer, index=True, comment='é—¨åº—åŠ ç›Ÿç±»å‹')
city = Column(String(100), index=True, comment='åŸå¸‚')  # âœ… æ–°å¢
```

### ä¿®å¤2: å¢å¼ºå­—æ®µåå…¼å®¹æ€§

**æ–‡ä»¶:** `æ™ºèƒ½é—¨åº—çœ‹æ¿_Dashç‰ˆ.py`

**ä¿®æ”¹ä½ç½®1 (Line 9613):**
```python
# ä¿®å¤å‰
elif field == 'åº“å­˜' and 'å‰©ä½™åº“å­˜' in df.columns:
    required_fields[field] = True

# ä¿®å¤å
elif field == 'åº“å­˜':
    # ğŸ”§ å…¼å®¹ä¸­è‹±æ–‡åº“å­˜å­—æ®µå
    if any(col in df.columns for col in ['å‰©ä½™åº“å­˜', 'stock', 'remaining_stock', 'åº“å­˜']):
        required_fields[field] = True
```

**ä¿®æ”¹ä½ç½®2 (Line 9754):**
```python
# ä¿®å¤å‰
stock_col = 'åº“å­˜' if 'åº“å­˜' in df.columns else 'å‰©ä½™åº“å­˜' if 'å‰©ä½™åº“å­˜' in df.columns else None

# ä¿®å¤å
# ğŸ”§ ç»Ÿä¸€åº“å­˜å­—æ®µåï¼ˆå…¼å®¹ä¸­è‹±æ–‡åº“å­˜å­—æ®µï¼‰
stock_col = None
for col in ['åº“å­˜', 'å‰©ä½™åº“å­˜', 'stock', 'remaining_stock']:
    if col in df.columns:
        stock_col = col
        break
```

**ä¿®æ”¹ä½ç½®3 (Line 19488):**
```python
# ä¿®å¤å‰
for col in ['å‰©ä½™åº“å­˜', 'åº“å­˜', 'æœŸæœ«åº“å­˜']:
    if col in df.columns:
        stock_col = col
        break

# ä¿®å¤å
# ğŸ”§ æ£€æµ‹åº“å­˜å­—æ®µ(å…¼å®¹ä¸­è‹±æ–‡)
stock_col = None
for col in ['åº“å­˜', 'å‰©ä½™åº“å­˜', 'stock', 'remaining_stock', 'æœŸæœ«åº“å­˜']:
    if col in df.columns:
        stock_col = col
        break
```

### ä¿®å¤3: åˆ›å»ºè‡ªåŠ¨åŒ–åŒæ­¥è„šæœ¬

**æ–‡ä»¶:** `åŒæ­¥æ•°æ®åº“ç»“æ„.py` (æ–°å»º)

**åŠŸèƒ½:**
- è‡ªåŠ¨æ£€æµ‹ordersè¡¨ç¼ºå¤±å­—æ®µ
- æ‰¹é‡æ·»åŠ æ‰€æœ‰5ä¸ªå­—æ®µ(stock, remaining_stock, delivery_distance, store_id, city)
- è‡ªåŠ¨éªŒè¯åŒæ­¥ç»“æœ

**ä½¿ç”¨æ–¹æ³•:**
```powershell
.\.venv\Scripts\Activate.ps1
python åŒæ­¥æ•°æ®åº“ç»“æ„.py
```

### ä¿®å¤4: æ›´æ–°åŒæ­¥æŒ‡å—æ–‡æ¡£

**æ–‡ä»¶:** `åŒæ­¥æ•°æ®åº“ç»“æ„æŒ‡å—.md`

**æ›´æ–°å†…å®¹:**
- è¡¥å……æ‰€æœ‰5ä¸ªå­—æ®µçš„åŒæ­¥æ–¹æ³•
- æ·»åŠ ä¸€é”®è‡ªåŠ¨åŒæ­¥æ–¹æ¡ˆ
- æä¾›å®Œæ•´çš„éªŒè¯æ­¥éª¤
- å¢å¼ºå¸¸è§é—®é¢˜è§£ç­”

---

## éªŒè¯æµ‹è¯•

### 1. éªŒè¯models.pyå­—æ®µå®Œæ•´æ€§

```powershell
python -c "from database.models import Order; from sqlalchemy import inspect; cols = inspect(Order).columns; print(f'å­—æ®µæ•°: {len(cols)}'); print('å…³é”®å­—æ®µ:', [c.name for c in cols if c.name in ['stock', 'remaining_stock', 'delivery_distance', 'store_id', 'city']])"
```

**æœŸæœ›è¾“å‡º:**
```
å­—æ®µæ•°: 44
å…³é”®å­—æ®µ: ['stock', 'remaining_stock', 'delivery_distance', 'store_id', 'city']
```

### 2. éªŒè¯æ•°æ®åº“å­—æ®µå­˜åœ¨

```powershell
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "SELECT column_name FROM information_schema.columns WHERE table_name = 'orders' AND column_name IN ('stock', 'remaining_stock', 'delivery_distance', 'store_id', 'city') ORDER BY column_name;"
```

**æœŸæœ›è¾“å‡º:**
```
     column_name
---------------------
 city
 delivery_distance
 remaining_stock
 stock
 store_id
(5 rows)
```

### 3. éªŒè¯å­—æ®µåå…¼å®¹æ€§

**æµ‹è¯•ä»£ç :**
```python
import pandas as pd

# æµ‹è¯•ä¸­æ–‡å­—æ®µå
df_chinese = pd.DataFrame({'åº“å­˜': [10, 20], 'å‰©ä½™åº“å­˜': [5, 15]})

# æµ‹è¯•è‹±æ–‡å­—æ®µå
df_english = pd.DataFrame({'stock': [10, 20], 'remaining_stock': [5, 15]})

# æµ‹è¯•å­—æ®µæ£€æµ‹é€»è¾‘
for df, name in [(df_chinese, 'ä¸­æ–‡'), (df_english, 'è‹±æ–‡')]:
    stock_col = None
    for col in ['åº“å­˜', 'å‰©ä½™åº“å­˜', 'stock', 'remaining_stock']:
        if col in df.columns:
            stock_col = col
            break
    print(f"{name}æ•°æ®æ¡†: stock_col = {stock_col}")
```

**æœŸæœ›è¾“å‡º:**
```
ä¸­æ–‡æ•°æ®æ¡†: stock_col = åº“å­˜
è‹±æ–‡æ•°æ®æ¡†: stock_col = stock
```

### 4. éªŒè¯çœ‹æ¿åŠŸèƒ½

```powershell
.\å¯åŠ¨çœ‹æ¿.ps1
```

è®¿é—® http://localhost:8050ï¼Œæ£€æŸ¥:

1. **æ•°æ®åº“æ•°æ®æº** â†’ **ä¸€çº§åˆ†ç±»é”€å”®è¶‹åŠ¿**
   - âœ… å”®ç½„å“æ•° æœ‰æ•°æ®(ä¸æ˜¯0)
   - âœ… æ»é”€å“æ€»æ•° æœ‰æ•°æ®(ä¸æ˜¯0)
   - âœ… åº“å­˜å‘¨è½¬å¤©æ•° æœ‰æ•°æ®(ä¸æ˜¯0)

2. **è¯¦ç»†æ•°æ®æ˜ç»†**
   - âœ… æ»é”€å“ç»Ÿè®¡ å±•å¼€æœ‰å…·ä½“å•†å“
   - âœ… åº“å­˜å‘¨è½¬ æ˜¾ç¤ºå…·ä½“å¤©æ•°

---

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

**ç°è±¡:**
- ä¸€çº§åˆ†ç±»é”€å”®è¶‹åŠ¿è¡¨æ ¼ä¸­:
  - å”®ç½„å“æ•°: 0
  - æ»é”€å“æ€»æ•°: 0
  - åº“å­˜å‘¨è½¬å¤©æ•°: 0
- æ»é”€å“ç»Ÿè®¡å±•å¼€æ— æ•°æ®
- åº“å­˜å‘¨è½¬åˆ—æ˜¾ç¤º "-"

**æ ¹å› :**
- models.pyç¼ºå°‘4ä¸ªå­—æ®µ
- å­—æ®µåæ£€æŸ¥ä¸æ”¯æŒè‹±æ–‡
- `required_fields['åº“å­˜'] = False`
- è·³è¿‡æ‰€æœ‰åº“å­˜ç›¸å…³è®¡ç®—

### ä¿®å¤å

**ç°è±¡:**
- ä¸€çº§åˆ†ç±»é”€å”®è¶‹åŠ¿è¡¨æ ¼ä¸­:
  - å”®ç½„å“æ•°: æ­£å¸¸æ˜¾ç¤º(å¦‚: 5)
  - æ»é”€å“æ€»æ•°: æ­£å¸¸æ˜¾ç¤º(å¦‚: 12)
    - ä¸€çº§æ»é”€: 3
    - äºŒçº§æ»é”€: 5
    - ä¸‰çº§æ»é”€: 4
  - åº“å­˜å‘¨è½¬å¤©æ•°: æ­£å¸¸æ˜¾ç¤º(å¦‚: 15.8å¤©)
- æ»é”€å“ç»Ÿè®¡å±•å¼€æœ‰å…·ä½“å•†å“åˆ—è¡¨
- åº“å­˜å‘¨è½¬åˆ—æ˜¾ç¤ºå…·ä½“å¤©æ•°

**æ•ˆæœ:**
- âœ… models.pyæœ‰44ä¸ªå®Œæ•´å­—æ®µ
- âœ… æ•°æ®åº“æœ‰æ‰€æœ‰5ä¸ªå­—æ®µ
- âœ… å­—æ®µåæ£€æŸ¥å…¼å®¹ä¸­è‹±æ–‡
- âœ… åº“å­˜ç›¸å…³åŠŸèƒ½å®Œå…¨æ¢å¤

---

## Bç”µè„‘åŒæ­¥æ­¥éª¤

### 1. æ‹‰å–æœ€æ–°ä»£ç 

```powershell
cd D:\Python1\O2O_Analysis\O2Oæ•°æ®åˆ†æ\æµ‹ç®—æ¨¡å‹
git pull origin master
```

### 2. åŒæ­¥æ•°æ®åº“ç»“æ„

**æ–¹å¼A: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬(æ¨è)**
```powershell
.\.venv\Scripts\Activate.ps1
python åŒæ­¥æ•°æ®åº“ç»“æ„.py
```

**æ–¹å¼B: æ‰‹åŠ¨æ‰§è¡ŒSQL**
```powershell
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "
ALTER TABLE orders ADD COLUMN IF NOT EXISTS stock INTEGER DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS remaining_stock FLOAT DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_distance FLOAT DEFAULT 0;
ALTER TABLE orders ADD COLUMN IF NOT EXISTS store_id VARCHAR(100);
ALTER TABLE orders ADD COLUMN IF NOT EXISTS city VARCHAR(100);
"
```

### 3. éªŒè¯åŒæ­¥

```powershell
# æ£€æŸ¥å­—æ®µæ•°
python -c "from database.models import Order; from sqlalchemy import inspect; print(f'models.pyå­—æ®µæ•°: {len(inspect(Order).columns)}')"

# æ£€æŸ¥æ•°æ®åº“å­—æ®µ
$env:PGPASSWORD="308352588"
psql -U postgres -d o2o_dashboard -c "\d orders" | Select-String "stock|delivery_distance|store_id|city"
```

### 4. é‡å¯çœ‹æ¿éªŒè¯

```powershell
.\å¯åŠ¨çœ‹æ¿.ps1
```

æ£€æŸ¥ä¸€çº§åˆ†ç±»é”€å”®è¶‹åŠ¿åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚

---

## ç›¸å…³æ–‡æ¡£

- `åŒæ­¥æ•°æ®åº“ç»“æ„æŒ‡å—.md` - å®Œæ•´çš„æ•°æ®åº“åŒæ­¥æ­¥éª¤
- `modelså­—æ®µåŒæ­¥ä¿®å¤è¯´æ˜.md` - models.pyå­—æ®µåŒæ­¥è¯¦æƒ…
- `æ•°æ®ç»“æ„ç»Ÿä¸€æ ‡å‡†.md` - æ•°æ®å­—æ®µæ ‡å‡†å’Œä¸šåŠ¡é€»è¾‘
- `æ–°ç”µè„‘å®Œæ•´é…ç½®æŒ‡å—.md` - æ–°ç”µè„‘é¦–æ¬¡é…ç½®æµç¨‹
- `Bç”µè„‘å…‹éš†æ¸…å•.md` - Bç”µè„‘å…‹éš†æ³¨æ„äº‹é¡¹

---

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜:

1. **å­—æ®µå®šä¹‰å®Œæ•´æ€§**: models.pyç°åœ¨æœ‰44ä¸ªå­—æ®µ,ä¸æ•°æ®åº“å®Œå…¨ä¸€è‡´
2. **å­—æ®µåå…¼å®¹æ€§**: ä»£ç æ”¯æŒä¸­è‹±æ–‡å­—æ®µåè‡ªåŠ¨è¯†åˆ«

**ä¿®å¤æ–‡ä»¶:**
- `database/models.py` - æ·»åŠ 4ä¸ªç¼ºå¤±å­—æ®µ
- `æ™ºèƒ½é—¨åº—çœ‹æ¿_Dashç‰ˆ.py` - 3å¤„å­—æ®µåæ£€æŸ¥é€»è¾‘å¢å¼º
- `åŒæ­¥æ•°æ®åº“ç»“æ„.py` - æ–°å»ºè‡ªåŠ¨åŒ–åŒæ­¥è„šæœ¬
- `åŒæ­¥æ•°æ®åº“ç»“æ„æŒ‡å—.md` - æ›´æ–°å®Œæ•´åŒæ­¥æ–¹æ¡ˆ

**æ ¸å¿ƒæ”¹è¿›:**
- âœ… æ”¯æŒä¸­æ–‡å­—æ®µå: `åº“å­˜`, `å‰©ä½™åº“å­˜`
- âœ… æ”¯æŒè‹±æ–‡å­—æ®µå: `stock`, `remaining_stock`
- âœ… è‡ªåŠ¨åŒ–åŒæ­¥è„šæœ¬,ä¸€é”®æ·»åŠ æ‰€æœ‰å­—æ®µ
- âœ… å®Œæ•´çš„éªŒè¯å’Œæµ‹è¯•æµç¨‹

**é€‚ç”¨åœºæ™¯:**
- A/Bç”µè„‘ä»£ç åŒæ­¥
- æ–°ç”µè„‘é¦–æ¬¡å…‹éš†
- æ•°æ®åº“ç»“æ„è¿­ä»£æ›´æ–°
- å­—æ®µåä¸ç»Ÿä¸€å¯¼è‡´çš„åŠŸèƒ½å¼‚å¸¸
