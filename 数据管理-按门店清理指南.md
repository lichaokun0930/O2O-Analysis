# 📋 数据管理功能 - 按门店清理

## 🎯 功能说明

**只保留按门店清理功能** - 删除指定门店的所有数据，简单直接。

---

## 🖥️ 使用步骤

### 1. 打开数据管理页面

```
启动看板 → 数据源选择 → 🗂️ 数据管理
```

---

### 2. 查看数据库统计

页面顶部显示：
```
┌─────────────┬─────────────┬─────────────┬──────────────────┐
│ 总订单数    │ 门店数量    │ 数据库大小  │ 数据日期范围     │
├─────────────┼─────────────┼─────────────┼──────────────────┤
│ 856,234     │ 5          │ 2.5 GB      │ 2024-01-01 ~     │
│             │            │             │ 2025-11-11       │
└─────────────┴─────────────┴─────────────┴──────────────────┘
```

---

### 3. 按门店清理数据

**步骤流程**:

```
① 选择门店
   ┌──────────────────────────────┐
   │ 选择要清理的门店:             │
   │ [  请选择门店  ▼]            │  ← 点击下拉
   │   如东店                     │
   │   海安店                     │
   │   启东店                     │
   │   海门店                     │
   └──────────────────────────────┘

② 查看门店数据
   ┌──────────────────────────────┐
   │ [查看门店数据]                │  ← 先点这个预览
   └──────────────────────────────┘
   
   弹出提示:
   ℹ️ 门店数据预览: 启东店
   • 订单数量: 125,678 条
   • 数据范围: 2024-01-01 至 2025-11-11

③ 确认删除
   ┌──────────────────────────────┐
   │ [删除门店数据]                │  ← 确认后点这个
   └──────────────────────────────┘
   
   弹出确认:
   ✅ 已删除门店: 启东店
   • 删除订单数: 125,678 条
   • 数据库已优化
   • 请刷新页面查看最新统计
```

---

### 4. 优化数据库（可选）

**删除大量数据后建议执行**：

```
点击优化按钮
┌──────────────────────────────┐
│ [优化数据库]                  │
└──────────────────────────────┘

弹出确认:
✅ 数据库优化成功！
• VACUUM FULL - 空间回收完成
• REINDEX - 索引重建完成
• ANALYZE - 统计信息更新完成
```

---

## 🛡️ 安全机制

### 双重确认
```
1️⃣ 查看门店数据 → 看看有多少数据
2️⃣ 删除门店数据 → 确认后才删除
```

### 原始数据安全
```
清理流程:
┌────────────────────────────────┐
│ 公司原始数据库（永久存储）     │ ← 不受影响
└────────────────────────────────┘
              ↓
┌────────────────────────────────┐
│ 本地PostgreSQL（临时分析库）   │ ← 可以放心清理
└────────────────────────────────┘
```

---

## 📊 使用场景

### 场景1: 删除关闭的门店
```
门店已关闭 → 数据不再需要 → 删除释放空间
```

### 场景2: 删除测试数据
```
测试门店 → 上传了测试数据 → 删除清理
```

### 场景3: 删除错误上传的数据
```
上传错误 → 发现门店数据有问题 → 删除重新上传
```

---

## ⚠️ 注意事项

### ✅ DO - 推荐做法

1. **先预览再删除**
   - 永远先点"查看门店数据"
   - 确认无误再点"删除门店数据"

2. **删除后优化**
   - 删除大量数据后点"优化数据库"
   - 确保空间真正释放

3. **重要数据备份**
   - 删除前确认原始数据在公司数据库
   - 或先导出Excel备份

---

### ❌ DON'T - 避免做法

1. **不要盲目删除**
   - 不看预览直接删除
   - 可能删错门店

2. **不要忘记优化**
   - 删除后不优化
   - 空间不会立即释放

---

## ❓ 常见问题

### Q1: 下拉列表显示"No results found"？

**原因**: 数据库中没有数据

**解决**:
1. 先上传门店数据
2. 刷新页面
3. 重新进入数据管理页面

---

### Q2: 误删了门店数据怎么办？

**答**: 从公司数据库重新导入
1. 从公司数据库导出该门店数据
2. 通过"上传新数据"重新导入
3. 原始数据在公司数据库（安全）

---

### Q3: 删除后空间没减少？

**答**: 需要优化数据库
1. 点击"优化数据库"按钮
2. 执行 VACUUM FULL
3. 空间立即释放

---

### Q4: 能不能批量删除多个门店？

**答**: 目前只能一个个删除
- 每次选择一个门店
- 删除后再选择下一个
- 这样更安全，防止误删

---

### Q5: 删除会影响其他正在使用的人吗？

**答**: 会有短暂影响
- 删除期间: 2-5秒锁表
- **建议**: 业务低峰期执行

---

## 🎯 操作演示

### 完整流程示例

```
1. 打开数据管理
   → 看到5个门店，856,234条订单，2.5 GB

2. 选择要删除的门店
   → 选择"测试门店"

3. 查看门店数据
   → 看到有1,234条测试订单

4. 确认删除
   → 点击"删除门店数据"
   → ✅ 已删除，1,234条订单

5. 优化数据库
   → 点击"优化数据库"
   → ✅ 优化成功

6. 刷新查看
   → 还剩4个门店，855,000条订单，2.48 GB
```

---

## 📈 效果预期

### 删除一个门店后

```
删除前:
├─ 门店数: 5
├─ 订单数: 856,234
└─ 数据库: 2.5 GB

删除后:
├─ 门店数: 4
├─ 订单数: 730,556 (-15%)
└─ 数据库: 2.1 GB (-16%)

优化后:
├─ 门店数: 4
├─ 订单数: 730,556
└─ 数据库: 2.0 GB (空间回收)
```

---

## 💡 最佳实践

### 简单三步
```
1️⃣ 预览 → 看清楚
2️⃣ 删除 → 确认删
3️⃣ 优化 → 释放空间
```

### 核心原则
```
先预览，再删除，后优化
```

---

## 🔧 故障排查

### 问题1: 门店列表是空的

**检查步骤**:
```bash
# 1. 检查数据库是否有数据
python database/data_lifecycle_manager.py
→ 选择 "1. 查看数据库统计"

# 2. 如果没有数据，先上传
看板 → 上传新数据 → 上传Excel文件

# 3. 刷新页面
F5 刷新浏览器
```

---

### 问题2: 删除失败

**可能原因**:
- 数据库连接断开
- 门店名称不存在
- 权限问题

**解决方法**:
```bash
# 检查数据库连接
python database/connection.py

# 查看错误日志
看控制台输出的错误信息
```

---

## 📝 总结

### 核心功能
```
按门店删除 = 简单直接 + 安全可控
```

### 记住2点
1. **先预览，再删除** - 防止误删
2. **删除后优化** - 释放空间

### 操作简单
```
选门店 → 查看 → 删除 → 优化
  ↓       ↓      ↓      ↓
 1秒    1秒    3秒    10秒
```

**总耗时**: < 20秒完成清理 ⚡

---

**版本**: v2.0 (简化版)  
**更新时间**: 2025-11-11  
**功能**: 仅保留按门店清理  
**安全等级**: ⭐⭐⭐⭐⭐
