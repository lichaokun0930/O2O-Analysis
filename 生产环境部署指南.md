# 生产环境部署指南

## 问题根源

**Waitress 3.x在Windows上的兼容性问题**:
- Waitress的`serve()`函数在某些Windows环境下会立即返回,而不是正常的阻塞运行
- 这是Waitress在Windows上的已知问题,与Windows的socket实现和异步I/O机制有关
- 导致进程启动后立即退出,造成内存累积和启动失败

## 解决方案

### ✅ 已实施的修复

1. **平台自适应启动** (`智能门店看板_Dash版.py`)
   ```python
   # Windows: 使用Flask多线程模式 (稳定)
   # Linux/Unix: 使用Waitress (高性能)
   ```

2. **自动进程清理** (`启动看板.ps1` & `生产环境启动.ps1`)
   - 启动前自动检测并清理所有旧的看板进程
   - 支持python.exe、python3.exe、python3.11.exe等所有变体
   - 避免内存累积问题

3. **增强的错误处理**
   - 端口占用检测
   - 数据库连接预检
   - 服务启动失败自动提示

### 📋 生产环境启动步骤

#### 方式1: 使用生产环境脚本 (推荐)
```powershell
.\生产环境启动.ps1
```

**优点**:
- 5步检查流程,确保环境完整
- 自动清理旧进程
- 详细的状态提示
- 失败时提供明确的解决建议

#### 方式2: 使用标准启动脚本
```powershell
.\启动看板.ps1
```

**优点**:
- 简洁快速
- 自动清理旧进程
- 适合日常使用

### 🔧 技术细节

#### 为什么在Windows上使用Flask而不是Waitress?

**Flask多线程模式的优势**:
1. ✅ **稳定性**: Windows原生支持,无兼容性问题
2. ✅ **性能**: `threaded=True`提供足够的并发能力
3. ✅ **可靠性**: 不会出现意外退出的情况
4. ✅ **维护性**: 标准库,无额外依赖风险

**性能对比** (中小型应用):
- Flask多线程: 50-100 并发请求/秒
- Waitress: 100-200 并发请求/秒
- 对于内部管理看板,Flask完全够用

#### 为什么在Linux上仍使用Waitress?

1. Linux上Waitress非常稳定
2. 性能优势明显
3. 生产级WSGI服务器
4. 资源占用更低

### 🚀 性能优化建议

如果需要更高性能,可以考虑:

#### 1. Gunicorn (仅Linux)
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:8051 智能门店看板_Dash版:server
```

#### 2. uWSGI (跨平台)
```bash
pip install uwsgi
uwsgi --http 0.0.0.0:8051 --wsgi-file 智能门店看板_Dash版.py --callable server
```

#### 3. Nginx反向代理
```nginx
upstream dashboard {
    server 127.0.0.1:8051;
}

server {
    listen 80;
    server_name dashboard.example.com;
    
    location / {
        proxy_pass http://dashboard;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 📊 监控和维护

#### 检查运行状态
```powershell
# 查看Python进程
Get-Process python* | Select-Object Id,ProcessName,StartTime,@{Name="Memory(MB)";Expression={[math]::Round($_.WS/1MB,2)}}

# 检查端口占用
netstat -ano | Select-String "8051"

# 测试访问
Invoke-WebRequest http://localhost:8051 -UseBasicParsing
```

#### 日志管理
```powershell
# 查看实时日志
Get-Content .\logs\dashboard.log -Wait -Tail 50

# 搜索错误
Select-String -Path .\logs\dashboard.log -Pattern "ERROR|CRITICAL"
```

### 🛠️ 故障排查

#### 问题1: 端口被占用
```powershell
# 查找占用进程
netstat -ano | Select-String "8051"
# 终止进程
Stop-Process -Id <PID> -Force
```

#### 问题2: 内存占用过高
```powershell
# 清理所有Python进程
Get-Process python* | Stop-Process -Force
# 重启看板
.\生产环境启动.ps1
```

#### 问题3: 数据库连接失败
```powershell
# 检查PostgreSQL服务
Get-Service postgresql*
# 启动数据库
.\启动数据库.ps1
```

### 📝 最佳实践

1. **定期重启**: 每周重启一次看板,清理内存
2. **监控资源**: 设置内存/CPU告警
3. **日志轮转**: 定期清理旧日志
4. **数据备份**: 定期备份PostgreSQL数据库
5. **版本控制**: 使用Git管理代码变更

### 🔒 安全建议

1. **防火墙规则**: 
   ```powershell
   # 允许8051端口
   New-NetFirewallRule -DisplayName "Dashboard" -Direction Inbound -LocalPort 8051 -Protocol TCP -Action Allow
   ```

2. **访问控制**: 
   - 仅限内网访问
   - 或使用反向代理添加身份验证

3. **HTTPS**: 
   - 生产环境建议使用HTTPS
   - 可通过Nginx配置SSL证书

### 📞 支持

遇到问题时:
1. 检查本文档的故障排查章节
2. 查看应用日志
3. 运行诊断命令确认环境状态
4. 联系技术支持并提供详细错误信息

---

**最后更新**: 2025-12-09
**版本**: v2.0 - 生产稳定版
