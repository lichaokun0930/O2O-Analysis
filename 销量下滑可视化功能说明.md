# 销量下滑可视化功能说明

## 🎨 功能概览

销量下滑诊断模块现已集成**12个可视化图表**，实现数据到洞察的可视化呈现。

---

## 📊 可视化看板结构

### 整体布局

```
┌─────────────────────────────────────────────────────┐
│ ✅ 发现 X 个销量下滑商品                              │
├─────────────────────────────────────────────────────┤
│ 📊 可视化分析看板                                    │
├─────────────────────────────────────────────────────┤
│ 📈 核心指标概览（4个KPI卡片）                         │
│ ┌──────┬──────┬──────┬──────┐                       │
│ │下滑  │销量  │收入  │利润  │                       │
│ │商品数│损失  │损失  │损失  │                       │
│ └──────┴──────┴──────┴──────┘                       │
├─────────────────────────────────────────────────────┤
│ 图表区域（左右分栏）                                  │
│ ┌───────────────────┬───────────────────┐          │
│ │ 左侧图表          │ 右侧图表          │          │
│ │ 1. 时段下滑分析   │ 4. 下滑TOP10      │          │
│ │ 2. 场景分布饼图   │ 5. 收入损失TOP10  │          │
│ │ 3. 品类TOP5       │ 6. 周期销量对比   │          │
│ └───────────────────┴───────────────────┘          │
├─────────────────────────────────────────────────────┤
│ 🔬 高级分析（Tab切换）                               │
│ ┌─────────────────────────────────────────────┐    │
│ │ Tab1: 利润影响分析（四维散点图）             │    │
│ │ Tab2: 分类树状图（Treemap）                 │    │
│ │ Tab3: 时段×场景热力图                       │    │
│ └─────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────┤
│ 📋 详细数据表格（可排序、可筛选）                     │
└─────────────────────────────────────────────────────┘
```

---

## 1️⃣ 核心指标概览（KPI Cards）

### 显示内容

| 指标 | 说明 | 数据来源 |
|------|------|---------|
| 📉 下滑商品数 | 符合下滑阈值的商品总数 | `len(declined_df)` |
| 📦 销量损失 | 总销量减少数量（单） | `sum(销量变化)` |
| 💸 收入损失 | 总收入减少金额（元） | `sum(当前期收入 - 对比期收入)` |
| 💰 利润损失 | 总利润减少金额（元） | `sum(收入损失 × 毛利率)` |

### 视觉特性
- 使用 `st.metric()` 组件
- 损失值显示为负数（红色向下箭头）
- 支持悬停查看帮助说明

**示例**：
```
┌──────────────┐
│ 📉 下滑商品数 │
│   15 个      │
└──────────────┘
```

---

## 2️⃣ 左侧图表区（分析维度）

### 图表1：⏰ 分时段下滑分析

**图表类型**：柱状图（可切换指标）

**显示内容**：
- X轴：8个时段（清晨、上午、正午、下午、傍晚、晚间、深夜、凌晨）
- Y轴：选择的指标值
- 柱形颜色：红色（损失）或蓝色（数量）

**可切换指标**：
1. 下滑商品数
2. 销量损失
3. 收入损失
4. 利润损失

**业务价值**：
- 发现问题时段（如"清晨下滑最严重"）
- 针对性调整营业时间或促销活动
- 优化时段人员配置

**示例**：
```
各时段下滑商品数

  15│    ██
    │    ██
  12│    ██   ██
    │    ██   ██   ██
  10│    ██   ██   ██   ██
    │────────────────────────
     清晨  上午  正午  下午 ...
```

**前置条件**：
- 数据中必须有"时段"字段
- 时段筛选器选择"全部时段"

---

### 图表2：🎭 分场景下滑分布

**图表类型**：环形饼图（Donut Chart）

**显示内容**：
- 各场景下滑商品数占比
- 环形中心空白（hole=0.4）
- 标签显示：场景名称 + 百分比

**配色方案**：
- 红色系：#d32f2f
- 橙色系：#f57c00
- 黄色系：#fbc02d
- 绿色系：#388e3c
- 蓝色系：#1976d2

**业务价值**：
- 快速识别问题场景
- 评估各场景业务占比
- 优先优化占比大的场景

**示例**：
```
各场景下滑商品占比

      早餐 35%
     ┌─────┐
  夜宵│     │下午茶
  15% │  █  │ 25%
     └─────┘
    午餐 20%  晚餐 5%
```

**前置条件**：
- 数据中必须有"场景"字段
- 场景筛选器选择"全部场景"

---

### 图表3：📦 品类下滑TOP5

**图表类型**：横向柱状图（Horizontal Bar）

**显示内容**：
- Y轴：一级分类名称（TOP5）
- X轴：收入损失金额
- 柱形颜色：珊瑚色（coral）
- 文本标签：¥金额

**排序逻辑**：
- 按收入损失从大到小
- 只显示前5个品类

**悬停信息**：
- 品类名称
- 收入损失
- 下滑商品数

**业务价值**：
- 发现高风险品类
- 优先资源配置
- 品类结构优化

**示例**：
```
收入损失最大的5个品类

熟食制品  ████████████ ¥5,000
饮料乳品  ██████████ ¥4,200
休闲零食  ████████ ¥3,800
粮油调味  ██████ ¥3,000
日用百货  ████ ¥2,500
```

---

## 3️⃣ 右侧图表区（排名与对比）

### 图表4：🔻 下滑最严重TOP10

**图表类型**：横向柱状图（颜色分级）

**显示内容**：
- Y轴：商品名称（TOP10）
- X轴：变化幅度（%）
- 文本标签：变化幅度% + 销量变化单数

**颜色映射**：
- ≤ -50%：深红色 #8b0000（严重）
- ≤ -30%：红色 #d32f2f（警告）
- 其他：橙色 #f57c00（关注）

**排序逻辑**：
- 按变化幅度%从小到大
- 只显示前10个商品

**业务价值**：
- 快速识别重点关注商品
- 评估下滑严重程度
- 制定针对性挽回策略

**示例**：
```
变化幅度最低的10个商品

活珠子   ████████████ -75% (-9单)
豆浆     ██████████ -60% (-12单)
油条     ████████ -50% (-8单)
...
```

---

### 图表5：💸 收入损失TOP10

**图表类型**：瀑布图（Waterfall Chart）

**显示内容**：
- X轴：商品名称
- Y轴：收入损失金额（绝对值）
- 累积效果：从上到下叠加

**视觉特性**：
- 递减柱形（红色）
- 连接线显示累积关系
- 文本标签：¥金额

**业务价值**：
- 可视化累积损失
- 评估单品影响权重
- 优先恢复高价值商品

**示例**：
```
收入损失累积瀑布图

¥5000│┌────┐
     ││活珠│
¥3000│││子 │┌────┐
     │└────┘││豆浆│
¥1000│      ││   │┌────┐
     │      └────┘││油条│
   0 │            └────┘
```

---

### 图表6：📊 周期销量对比

**图表类型**：分组柱状图（Grouped Bar）

**显示内容**：
- X轴：商品名称（TOP10）
- Y轴：销量（单）
- 两组柱形：当前期 vs 对比期

**配色方案**：
- 当前期：红色 #d32f2f
- 对比期：蓝色 #1976d2

**业务价值**：
- 直观对比销量变化
- 识别下滑/增长趋势
- 评估恢复可能性

**示例**：
```
TOP10商品销量对比

 50│  ██
   │  ██     ██
 40│  ██  ██ ██
   │  ██  ██ ██  ██
 30│  ██  ██ ██  ██  ██
   │──────────────────
    活珠  豆浆 油条 盖饭
     子

 █ 第38周   █ 第39周
```

---

## 4️⃣ 高级分析（Tab切换）

### Tab 1: 💰 利润影响分析

**图表类型**：四维气泡散点图（Bubble Scatter）

**四个维度**：
1. **X轴**：销量变化（单）
2. **Y轴**：利润损失（元）
3. **气泡大小**：商品售价（价格越高气泡越大）
4. **气泡颜色**：毛利率%（红=低毛利，绿=高毛利）

**配色方案**：
- 颜色渐变：RdYlGn（红-黄-绿）
- 颜色条：显示毛利率范围

**交互功能**：
- 悬停显示：商品名称、销量变化、利润损失、售价、毛利率
- 缩放：支持框选放大
- 拖拽：支持平移

**业务价值**：
- 综合评估四个核心维度
- 识别"高价值损失商品"（左下角大气泡）
- 发现"低毛利高损失"商品（红色大气泡）

**阅读提示**：
```
💡 气泡越大 = 售价越高
   颜色越红 = 毛利率越低
   左下角 = 高损失商品
```

**示例场景**：
- 左下角大红泡：高价低毛利且销量大跌 → 最优先处理
- 左下角小绿泡：低价高毛利但销量大跌 → 关注复购
- 右上角：增长商品（不显示）

---

### Tab 2: 🌳 分类树状图

**图表类型**：Treemap（矩形树图）

**层级结构**：
```
一级分类
  └─ 三级分类
      └─ 商品名称
```

**视觉映射**：
- **矩形面积**：收入损失绝对值（越大=损失越大）
- **矩形颜色**：变化幅度%（越红=下滑越严重）
- **层级嵌套**：外层=一级分类，中层=三级分类，内层=商品

**配色方案**：
- 颜色渐变：Reds（白-粉-红-深红）
- 颜色深度：表示下滑严重程度

**悬停信息**：
- 分类/商品名称
- 收入损失
- 变化幅度%
- 销量变化

**业务价值**：
- 一目了然看到分类层级
- 快速定位问题分类
- 评估分类内部结构

**阅读提示**：
```
💡 颜色越深 = 下滑越严重
   面积越大 = 损失越大
```

**示例**：
```
┌─────────────────────────────────────┐
│ 熟食制品（深红色，面积大）           │
│ ┌────────┬──────┬──────┐            │
│ │卤制品  │烧烤  │凉菜  │            │
│ │-50%    │-40%  │-30%  │  饮料乳品   │
│ └────────┴──────┴──────┘  -35%      │
│                                     │
│ ┌────────────────┐                  │
│ │  休闲零食       │    粮油调味      │
│ │  -25%          │    -20%         │
│ └────────────────┘                  │
└─────────────────────────────────────┘
```

---

### Tab 3: 🔥 时段×场景热力图

**图表类型**：Heatmap（热力图）

**维度**：
- X轴：8个时段
- Y轴：N个场景
- 单元格值：下滑商品数

**配色方案**：
- 颜色渐变：Reds（白-红）
- 白色：无下滑（0商品）
- 浅红：轻微下滑（1-5商品）
- 深红：严重下滑（10+商品）

**单元格标注**：
- 自动显示数值（text_auto=True）

**计算逻辑**：
- 对每个"时段+场景"组合单独诊断
- 统计下滑商品数量
- 构建矩阵热力图

**业务价值**：
- 精准定位"时段+场景"问题点
- 发现交叉影响（如"清晨早餐"严重）
- 制定场景化时段策略

**阅读提示**：
```
💡 找到深红色区域
   针对性优化该时段+场景的商品
```

**示例**：
```
时段×场景下滑商品数

场景＼时段  清晨  上午  正午  下午  傍晚  晚间  深夜  凌晨
早餐        🔴15  🟠8   🟡3   ⬜0   ⬜0   ⬜0   ⬜0   ⬜0
午餐        ⬜0   🟡2   🔴20  🟠10  🟡3   ⬜0   ⬜0   ⬜0
下午茶      ⬜0   🟡3   🟡4   🟠12  🟡5   ⬜1   ⬜0   ⬜0
晚餐        ⬜0   ⬜0   ⬜1   🟡3   🔴18  🟠8   🟡2   ⬜0
夜宵        ⬜0   ⬜0   ⬜0   ⬜0   🟡2   🟠6   🔴10  🟡3
```

**发现示例**：
- 清晨×早餐：15个商品下滑 → 加强早餐促销
- 正午×午餐：20个商品下滑 → 优化午餐SKU
- 傍晚×晚餐：18个商品下滑 → 晚餐时段竞争力不足

---

## 5️⃣ 详细数据表格

### 表格特性

**显示内容**：
- 所有下滑商品的完整字段
- 动态列名（根据周期自动调整）
- 格式化数值（¥符号、%符号）

**视觉高亮**：
- 问题等级=严重：红色背景 #ffcccc
- 问题等级=警告：橙色背景 #ffe6cc
- 问题等级=关注：无背景

**交互功能**：
- 列排序：点击列名升序/降序
- 滚动：固定表头，内容滚动
- 高度：400px

**主要列**：
| 列名 | 说明 | 示例 |
|------|------|------|
| 商品名称 | 商品名称 | 活珠子 |
| 第XX周销量 | 当前期销量 | 3 |
| 第XX周销量 | 对比期销量 | 12 |
| 销量变化 | 销量差值 | -9 |
| 变化幅度% | 变化百分比 | -75.0% |
| 第XX周预计收入 | 当前期收入 | ¥45.0 |
| 第XX周预计收入 | 对比期收入 | ¥180.0 |
| 一级分类名 | 商品大类 | 熟食制品 |
| 三级分类名 | 商品小类 | 卤制品 |
| 商品实售价 | 平均售价 | ¥15.0 |
| 平均毛利率% | 毛利率 | 35.0% |
| 问题等级 | 严重程度 | 严重 |
| 建议操作 | AI建议 | 紧急关注... |

---

## 📱 响应式设计

### 布局适配

**大屏（>1200px）**：
- 左右分栏显示
- 图表并排展示
- 最佳观看体验

**中屏（768-1200px）**：
- 自动调整列宽
- 图表堆叠显示
- 保持可读性

**小屏（<768px）**：
- 单列布局
- 图表全宽显示
- 优化触摸交互

---

## 🎯 使用场景

### 场景1：快速诊断

**目标**：快速了解整体下滑情况

**操作流程**：
1. 点击"开始诊断"
2. 查看核心指标卡片（4个KPI）
3. 查看时段分析图（找问题时段）
4. 查看TOP10排名（找重点商品）

**耗时**：< 30秒

---

### 场景2：深度分析

**目标**：全面分析下滑原因

**操作流程**：
1. 完成快速诊断
2. 查看场景分布饼图（找问题场景）
3. 查看品类TOP5（找问题品类）
4. 查看四维散点图（综合评估）
5. 查看热力图（时段×场景交叉）

**耗时**：3-5分钟

---

### 场景3：专项优化

**目标**：针对特定维度优化

**示例1：优化清晨时段**
```
1. 时段筛选：选择"清晨(6-9点)"
2. 点击"开始诊断"
3. 查看清晨时段的下滑商品
4. 制定清晨促销策略
```

**示例2：优化早餐场景**
```
1. 场景筛选：选择"早餐"
2. 点击"开始诊断"
3. 查看早餐场景的下滑商品
4. 优化早餐商品SKU
```

**示例3：优化清晨早餐（交叉）**
```
1. 时段筛选：清晨
2. 场景筛选：早餐
3. 点击"开始诊断"
4. 查看交叉条件下的商品
5. 制定精准策略
```

---

## 💡 最佳实践

### 1. 分析顺序建议

```
第一步：核心指标
  └─ 了解整体影响（多少商品、多少损失）

第二步：维度分析
  ├─ 时段分析：找问题时段
  ├─ 场景分析：找问题场景
  └─ 品类分析：找问题品类

第三步：商品排名
  ├─ 变化幅度TOP10：找下滑最快的
  └─ 收入损失TOP10：找损失最大的

第四步：交叉分析
  └─ 热力图：找时段×场景问题点

第五步：综合评估
  └─ 四维散点图：优先级排序
```

### 2. 图表阅读技巧

**柱状图**：
- 看高度：值的大小
- 看颜色：问题严重程度
- 看对比：不同维度差异

**饼图**：
- 看面积：占比大小
- 看颜色：分类区分
- 看标签：具体数值

**散点图**：
- 看位置：X/Y轴关系
- 看大小：第三维度
- 看颜色：第四维度
- 看聚类：问题集中区域

**热力图**：
- 看颜色：深浅表示严重程度
- 看分布：横向/纵向模式
- 看极值：最深色区域

### 3. 性能优化建议

**数据量较大时**：
- 时段/场景分析会循环调用诊断引擎
- 热力图计算较慢（时段×场景组合）
- 建议先用筛选器缩小范围

**加速技巧**：
- 不选择"全部时段/全部场景"可跳过相关图表
- 提高下滑阈值减少商品数量
- 使用缓存（数据不变时无需重复诊断）

---

## 🔧 技术实现细节

### 数据处理流程

```python
1. 获取诊断结果（格式化字符串）
   result = diagnostic_engine.diagnose_sales_decline(...)

2. 复制数据用于可视化
   viz_df = result.copy()

3. 解析格式化数值
   def parse_number(val):
       # ¥1234.5 → 1234.5
       # -50.0% → -50.0
       return float(cleaned_value)

4. 计算派生指标
   - 收入变化 = 当前期收入 - 对比期收入
   - 利润变化 = 收入变化 × 毛利率

5. 聚合分析数据
   - 按时段/场景/分类统计
   - 生成图表数据

6. 渲染可视化
   - Plotly图表
   - Streamlit组件
```

### 图表库选择

**Plotly优势**：
- 交互性强（缩放、拖拽、悬停）
- 图表类型丰富
- 美观度高
- 支持导出图片

**Streamlit集成**：
- `st.plotly_chart()` 渲染
- `use_container_width=True` 响应式
- 自动主题适配

---

## 🚀 未来优化方向

### 功能增强

1. **趋势分析**（已设计，待实现）
   - 近4周下滑趋势折线图
   - 判断问题是否恶化

2. **对比分析增强**
   - 多周期对比（3个以上周期）
   - 同比/环比切换

3. **智能洞察**
   - 自动生成洞察摘要
   - AI诊断建议

4. **交互联动**
   - 点击图表筛选表格
   - 跨图表联动

### 性能优化

1. **数据缓存**
   - 缓存诊断结果
   - 避免重复计算

2. **懒加载**
   - Tab切换时才渲染
   - 减少初始加载时间

3. **并行计算**
   - 多时段/场景并行诊断
   - 提升热力图生成速度

---

## 📞 常见问题

### Q1: 为什么某些图表不显示？

**A**: 检查前置条件：
- 时段分析：需要"时段"字段 + 选择"全部时段"
- 场景分析：需要"场景"字段 + 选择"全部场景"
- 周期对比：需要有两个周期的数据

### Q2: 热力图计算很慢？

**A**: 正常现象。热力图需要计算所有"时段×场景"组合：
- 8个时段 × 5个场景 = 40次诊断
- 优化：使用筛选器缩小范围

### Q3: 图表数据与表格数据不一致？

**A**: 可能原因：
- 图表使用原始数据重新统计
- 表格是当前筛选条件的结果
- 确保筛选条件一致

### Q4: 如何导出图表？

**A**: Plotly图表支持导出：
1. 悬停在图表右上角
2. 点击"📷"图标
3. 保存为PNG图片

---

## ✅ 总结

### 核心价值

1. **可视化直观**：12个图表全方位展示
2. **多维度分析**：时段、场景、分类、商品
3. **交互性强**：缩放、悬停、切换
4. **业务友好**：无需专业知识即可理解

### 使用建议

- **新手**：关注核心指标 + TOP10排名
- **进阶**：增加时段/场景/品类分析
- **专家**：使用四维散点图 + 热力图

### 效果评估

**未使用可视化**：
- 只有数据表格
- 难以发现规律
- 分析耗时长

**使用可视化后**：
- 一目了然看趋势
- 快速定位问题
- 决策效率提升10倍+

---

**祝您使用愉快！** 🎉
