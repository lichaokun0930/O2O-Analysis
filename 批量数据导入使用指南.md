# 批量数据导入使用指南

本指南介绍两种快捷的数据导入方式，无需在看板中逐个上传文件。

## 📁 目录结构

```
O2O-Analysis/
├── 实际数据/           ← 方案1：手动批量导入目录
│   └── *.xlsx          ← 放入 Excel 文件
│
├── data/
│   ├── inbox/          ← 方案2：热文件夹（放入即自动导入）
│   ├── processed/      ← 导入成功的文件
│   └── failed/         ← 导入失败的文件
```

---

## 方案1：一键批量导入（推荐）

适合：一次性导入多个历史数据文件

### 使用步骤

1. 将 Excel 文件放入 `实际数据/` 目录
2. 双击运行 `一键批量导入数据.ps1`
3. 确认文件列表后输入 `y` 开始导入
4. 等待导入完成

### 命令行参数

```powershell
# 默认：增量导入 ./实际数据 目录
.\一键批量导入数据.ps1

# 指定其他目录
.\一键批量导入数据.ps1 -Path "D:\数据备份"

# 全量替换模式（删除旧数据后导入）
.\一键批量导入数据.ps1 -Mode replace
```

### 导入模式说明

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| `incremental` | 增量导入（默认） | 日常更新，只导入新数据 |
| `replace` | 全量替换 | 数据修正，需要覆盖旧数据 |

---

## 方案2：热文件夹监控

适合：频繁更新数据，希望自动化导入

### 使用步骤

1. 双击运行 `启动数据监控服务.ps1`
2. 将 Excel 文件放入 `data/inbox/` 目录
3. 系统自动检测并导入
4. 导入成功 → 文件移动到 `data/processed/`
5. 导入失败 → 文件移动到 `data/failed/`

### 特点

- 放入文件即自动导入，无需手动操作
- 支持实时监控（需安装 watchdog）
- 自动记录导入历史
- 失败文件保留，方便排查问题

### 安装实时监控支持（可选）

```powershell
pip install watchdog
```

---

## 支持的文件格式

- `.xlsx` - Excel 2007+
- `.xls` - Excel 97-2003

> ⚠️ 临时文件（以 `~$` 开头）会自动跳过

---

## 数据要求

### 必需字段

| 字段 | 说明 |
|------|------|
| 订单ID | 订单唯一标识 |
| 门店名称 | 门店名称 |
| 商品名称 | 商品名称 |
| 下单时间/日期 | 订单日期 |

### 可选字段

系统会自动识别并导入以下字段（如果存在）：

- 商品实售价、商品原价、商品采购成本
- 销量、库存
- 物流配送费、平台服务费
- 满减金额、商品减免金额、商家代金券等营销字段
- 配送距离、配送平台
- 一级分类、三级分类
- 渠道、收货地址

---

## 导入后操作

### 更新预聚合表（重要！）

导入新数据后，建议运行以下命令更新预聚合表以获得最佳查询性能：

```powershell
python 全看板性能优化实施.py
```

### 清除缓存

如果看板数据未更新，可以清除缓存：

```powershell
# 通过 API 清除
curl -X POST http://localhost:8080/api/v1/orders/clear-cache
```

---

## 常见问题

### Q: 导入后看板数据没变化？

A: 
1. 检查导入是否成功（查看控制台输出）
2. 运行 `python 全看板性能优化实施.py` 更新预聚合表
3. 清除浏览器缓存或刷新页面

### Q: 文件导入失败？

A: 检查以下几点：
1. 文件是否包含必需字段（订单ID、门店名称、商品名称、日期）
2. 日期格式是否正确
3. 文件是否被其他程序占用

### Q: 如何查看导入历史？

A: 导入历史记录在数据库 `data_upload_history` 表中，可通过以下方式查看：

```sql
SELECT * FROM data_upload_history ORDER BY uploaded_at DESC LIMIT 20;
```

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `一键批量导入数据.ps1` | 方案1 启动脚本 |
| `启动数据监控服务.ps1` | 方案2 启动脚本 |
| `database/batch_import_enhanced.py` | 批量导入核心逻辑 |
| `services/data_watcher_service.py` | 热文件夹监控服务 |
