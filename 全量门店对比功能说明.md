# 全量门店对比分析功能

## 📋 功能概述

全量门店对比分析是一个新增的 Tab 页面，用于对比所有门店的关键经营指标，帮助快速发现优劣势门店。

## 🎯 核心功能

### 1. 汇总指标卡片
- 总门店数
- 总订单量
- 总销售额
- 总利润
- 平均利润率

### 2. 门店对比数据表格
展示所有门店的详细指标：
- 订单量
- 销售额
- 利润
- 利润率
- 客单价（AOV）
- 单均配送费
- 单均营销费
- 配送成本率
- 营销成本率
- 环比数据（本周 vs 上周）

支持功能：
- 按任意列排序
- 排名展示（前3名高亮）
- 利润率颜色分级
- 环比变化趋势图标

### 3. 门店排行榜图表
- 柱状图展示 Top 10 门店
- 支持切换指标：销售额/利润/利润率/订单量
- 颜色根据利润率分级
- 悬停显示详细信息

### 4. 门店效率散点图
- X轴：营销成本率
- Y轴：利润率
- 气泡大小：销售额
- 四象限分析：
  - 左上（绿色）：金牛门店（高利润低营销）
  - 右上（青色）：明星门店（高利润高营销）
  - 左下（橙色）：待优化门店（低利润低营销）
  - 右下（红色）：问题门店（低利润高营销）

## 🔧 技术实现

### 后端 API

#### 1. 门店对比数据
```
GET /api/v1/stores/comparison
```

参数：
- `start_date`: 开始日期（可选）
- `end_date`: 结束日期（可选）
- `sort_by`: 排序字段（revenue/profit/profit_margin/order_count）
- `sort_order`: 排序方向（asc/desc）

响应：
```json
{
  "success": true,
  "data": {
    "stores": [
      {
        "store_name": "XX路店",
        "order_count": 1500,
        "total_revenue": 450000,
        "total_profit": 135000,
        "profit_margin": 30.0,
        "aov": 300,
        "avg_delivery_fee": 5.5,
        "avg_marketing_cost": 8.2,
        "delivery_cost_rate": 1.8,
        "marketing_cost_rate": 2.7,
        "ranks": {
          "revenue_rank": 1,
          "profit_rank": 2,
          "profit_margin_rank": 3
        }
      }
    ],
    "summary": {
      "total_stores": 25,
      "total_orders": 37500,
      "total_revenue": 11250000,
      "total_profit": 3375000,
      "avg_profit_margin": 30.0
    }
  }
}
```

#### 2. 环比数据
```
GET /api/v1/stores/comparison/week-over-week
```

参数：
- `end_date`: 结束日期（可选，默认为数据最大日期）

响应：
```json
{
  "success": true,
  "data": {
    "stores": [
      {
        "store_name": "XX路店",
        "current": {
          "order_count": 1500,
          "total_revenue": 450000,
          "total_profit": 135000,
          "profit_margin": 30.0
        },
        "changes": {
          "order_count": 5.2,
          "revenue": 8.3,
          "profit": 12.5,
          "profit_margin": 1.2
        }
      }
    ],
    "period": {
      "current": {"start": "2024-01-15", "end": "2024-01-21"},
      "previous": {"start": "2024-01-08", "end": "2024-01-14"}
    }
  }
}
```

#### 3. 排行榜
```
GET /api/v1/stores/comparison/ranking
```

参数：
- `metric`: 排名指标（revenue/profit/profit_margin/order_count）
- `limit`: 返回 Top N（默认10）
- `start_date`: 开始日期（可选）
- `end_date`: 结束日期（可选）

### 前端组件

#### 主视图
- `views/StoreComparisonView.tsx`

#### 子组件
- `components/StoreComparisonTable.tsx` - 数据表格
- `components/charts/StoreRankingChart.tsx` - 排行榜图表
- `components/charts/StoreEfficiencyScatter.tsx` - 效率散点图

#### API 封装
- `api/storeComparison.ts`

#### 类型定义
- `types/index.ts` - 新增门店对比相关类型

## 📊 计算逻辑

### 与经营总览完全一致

所有计算逻辑复用 `orders.py` 中的 `calculate_order_metrics()` 函数：

1. **订单实际利润** = 利润额 - 平台服务费 - 物流配送费 + 企客后返
2. **配送净成本** = 物流配送费 - (用户支付配送费 - 配送费减免金额) - 企客后返
3. **商家活动成本** = 配送费减免 + 满减 + 商品减免 + 商家代金券 + 商家承担券 + 满赠 + 其他优惠 + 新客减免
4. **利润率** = 总利润 / 销售额 × 100
5. **客单价** = 销售额 / 订单数
6. **单均配送费** = 总配送费 / 订单数
7. **单均营销费** = 总营销成本 / 订单数
8. **配送成本率** = 总配送费 / 销售额 × 100
9. **营销成本率** = 总营销成本 / 销售额 × 100

### 环比计算

- **本周**：最近7天（基于全局日期范围的结束日期）
- **上周**：前7天
- **环比变化** = (本周 - 上周) / 上周 × 100
- **利润率环比** = 本周利润率 - 上周利润率（百分点变化）

## 🚀 使用方法

### 1. 访问页面
点击左侧导航栏的"全量门店对比"进入页面

### 2. 日期筛选
使用顶部的全局日期筛选器选择分析时间范围（与经营总览共享）

### 3. 查看数据
- 顶部卡片：查看汇总指标
- 排行榜图表：查看门店排名
- 散点图：分析门店效率
- 数据表格：查看详细数据

### 4. 排序
点击表格列标题进行排序

## 🔍 数据要求

### 数据库表结构
使用现有的 `orders` 表，需要包含以下字段：
- `store_id` - 门店ID
- `store_name` - 门店名称
- `date` - 订单日期
- 其他订单相关字段（与单店分析一致）

### 数据上传
1. 准备包含所有门店数据的 Excel/CSV 文件
2. 确保每行数据都有 `门店名称` 字段
3. 通过"数据管理"页面上传
4. 系统自动识别并存储多门店数据

## 📈 性能优化

### 后端
- 复用现有的 Redis + 内存双层缓存
- 按门店分片缓存（5分钟有效期）
- 数据库查询使用索引（store_id, store_name）

### 前端
- 懒加载视图组件
- ECharts 图表按需渲染
- 表格直接渲染（25-30家门店无需虚拟滚动）

## 🧪 测试

运行测试脚本验证 API：

```bash
python test_store_comparison_api.py
```

测试内容：
1. 门店对比数据接口
2. 环比数据接口
3. 排行榜接口

## 📝 注意事项

1. **日期范围**：与经营总览共享全局日期筛选器
2. **计算逻辑**：与单店分析完全一致，确保数据可对比
3. **环比数据**：基于最近两周数据计算
4. **门店数量**：系统设计支持 25-30 家门店，性能无压力
5. **权限控制**：当前版本暂不考虑权限，所有用户可见所有门店

## 🔄 后续优化方向

1. 支持多门店选择进行深度对比
2. 添加门店健康度雷达图
3. 支持导出 Excel 报告
4. 添加异常门店自动检测
5. 支持按区域/类型筛选门店
