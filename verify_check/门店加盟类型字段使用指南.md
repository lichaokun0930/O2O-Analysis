# 🏪 门店加盟类型字段使用指南

## 📋 字段规格说明

### 基本信息
| 项目 | 说明 |
|------|------|
| **数据库字段名** | `store_franchise_type` (英文) |
| **中文名称** | 门店加盟类型 |
| **数据类型** | SMALLINT |
| **是否允许空值** | YES (历史数据兼容) |
| **默认值** | NULL |
| **索引** | idx_orders_franchise_type |

### 编码规则
```sql
1 = 直营店    -- 公司自营的门店
2 = 加盟店    -- 加盟商经营的门店  
3 = 托管店    -- 公司托管的门店
4 = 买断      -- 买断经营的门店
NULL = 未分类  -- 历史数据或未标记的订单
```

---

## 🚀 快速开始

### 步骤1: 执行数据库迁移

#### 方式A: 使用Python脚本 (推荐开发环境)
```powershell
# 进入项目目录
cd d:\Python1\O2O_Analysis\O2O数据分析\测算模型

# 执行迁移脚本
python database/add_store_franchise_type_field.py
```

**脚本执行效果:**
- ✅ 自动检查字段是否存在(幂等性)
- ✅ 添加 `store_franchise_type` 字段
- ✅ 添加中文注释说明
- ✅ 创建索引提升查询性能
- ✅ 添加数据约束(仅允许1-4或NULL)
- ✅ 验证迁移结果
- ✅ 自动生成生产SQL脚本

#### 方式B: 使用SQL脚本 (推荐生产环境)
```powershell
# 使用生成的SQL脚本
psql -h [数据库地址] -U [用户名] -d o2o_dashboard \
     -f database/migrations/pg_ddl_20251119.sql
```

**执行前检查:**
```sql
-- 检查字段是否已存在
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_name='orders' AND column_name='store_franchise_type';

-- 如已存在,无需重复执行
```

---

## 📊 数据导入配置

### Excel数据准备

#### 在现有Excel中新增列:
| 列名选项 (任选其一) | 说明 |
|-------------------|------|
| **门店加盟类型** | 推荐使用 |
| 加盟类型 | 可识别 |
| 门店类型 | 可识别 |
| store_franchise_type | 可识别 |

#### 数据填写规范:
```excel
示例1: 使用数字编码
门店名称          门店加盟类型
北京总部店        1
上海加盟店A       2  
深圳托管店        3
广州买断店        4

示例2: 使用中文(系统自动转换)
门店名称          门店类型
北京总部店        直营店
上海加盟店A       加盟店
深圳托管店        托管店
广州买断店        买断
```

### 自动映射逻辑

**真实数据处理器** (`真实数据处理器.py`) 已配置以下字段自动识别:

```python
'门店加盟类型': [
    '门店加盟类型',       # 标准名称
    '加盟类型',           # 简写
    '门店类型',           # 别名
    'store_franchise_type',  # 英文
    'franchise_type',     # 英文简写
    '店铺类型'            # 通用说法
]
```

**上传流程:**
1. 上传包含"门店加盟类型"列的Excel文件
2. 系统自动识别字段名并映射
3. 自动写入 `orders.store_franchise_type` 字段
4. 历史数据保持NULL值不变

---

## 💡 使用场景示例

### 场景1: 按加盟类型统计销售额

```sql
SELECT 
    CASE store_franchise_type
        WHEN 1 THEN '直营店'
        WHEN 2 THEN '加盟店'
        WHEN 3 THEN '托管店'
        WHEN 4 THEN '买断'
        ELSE '未分类'
    END AS 加盟类型,
    COUNT(*) AS 订单数,
    SUM(amount) AS 销售额,
    AVG(profit_margin) AS 平均利润率,
    SUM(profit) AS 总利润
FROM orders
GROUP BY store_franchise_type
ORDER BY 销售额 DESC;
```

**输出示例:**
| 加盟类型 | 订单数 | 销售额 | 平均利润率 | 总利润 |
|---------|--------|--------|-----------|--------|
| 直营店 | 15,234 | ¥458,234 | 28.5% | ¥130,456 |
| 加盟店 | 12,456 | ¥356,789 | 22.3% | ¥79,562 |
| 托管店 | 8,567 | ¥245,678 | 25.1% | ¥61,645 |
| 买断 | 3,456 | ¥123,456 | 31.2% | ¥38,518 |
| 未分类 | 45,678 | ¥1,234,567 | 26.8% | ¥330,863 |

---

### 场景2: 对比直营店与加盟店毛利率

```sql
SELECT 
    CASE 
        WHEN store_franchise_type = 1 THEN '直营店'
        WHEN store_franchise_type = 2 THEN '加盟店'
        ELSE '其他'
    END AS 门店类型,
    AVG(profit_margin) AS 平均毛利率,
    STDDEV(profit_margin) AS 毛利率波动,
    MIN(profit_margin) AS 最低毛利率,
    MAX(profit_margin) AS 最高毛利率
FROM orders
WHERE store_franchise_type IN (1, 2)
GROUP BY 门店类型;
```

---

### 场景3: 分析不同加盟类型的商品结构

```sql
-- 统计各加盟类型的流量品/利润品占比
SELECT 
    o.store_franchise_type,
    p.product_role AS 商品角色,
    COUNT(DISTINCT o.product_name) AS 商品数,
    SUM(o.amount) AS 销售额,
    AVG(o.profit_margin) AS 平均毛利率
FROM orders o
LEFT JOIN products p ON o.product_id = p.id
WHERE o.store_franchise_type IS NOT NULL
GROUP BY o.store_franchise_type, p.product_role
ORDER BY o.store_franchise_type, 销售额 DESC;
```

---

### 场景4: 时间维度 + 加盟类型分析

```sql
-- 近30天各加盟类型销售趋势
SELECT 
    DATE(date) AS 日期,
    CASE store_franchise_type
        WHEN 1 THEN '直营店'
        WHEN 2 THEN '加盟店'
        WHEN 3 THEN '托管店'
        WHEN 4 THEN '买断'
        ELSE '未分类'
    END AS 加盟类型,
    COUNT(*) AS 订单数,
    SUM(amount) AS 销售额
FROM orders
WHERE date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY DATE(date), store_franchise_type
ORDER BY 日期 DESC, 销售额 DESC;
```

---

## 🔧 数据维护

### 为历史数据补充加盟类型

#### 方式1: 根据门店名称批量更新
```sql
-- 直营店标记
UPDATE orders 
SET store_franchise_type = 1 
WHERE store_name IN ('北京总部店', '上海旗舰店', '深圳形象店')
  AND store_franchise_type IS NULL;

-- 加盟店标记  
UPDATE orders 
SET store_franchise_type = 2 
WHERE store_name LIKE '%加盟%'
  AND store_franchise_type IS NULL;

-- 托管店标记
UPDATE orders 
SET store_franchise_type = 3 
WHERE store_name LIKE '%托管%'
  AND store_franchise_type IS NULL;

-- 买断店标记
UPDATE orders 
SET store_franchise_type = 4 
WHERE store_name LIKE '%买断%'
  AND store_franchise_type IS NULL;
```

#### 方式2: 使用CASE批量更新
```sql
UPDATE orders 
SET store_franchise_type = CASE
    WHEN store_name LIKE '%直营%' OR store_name LIKE '%总部%' THEN 1
    WHEN store_name LIKE '%加盟%' THEN 2
    WHEN store_name LIKE '%托管%' THEN 3
    WHEN store_name LIKE '%买断%' THEN 4
    ELSE NULL
END
WHERE store_franchise_type IS NULL;
```

#### 方式3: 从外部映射表导入
```sql
-- 假设有门店主数据表 stores(store_name, franchise_type)
UPDATE orders o
SET store_franchise_type = s.franchise_type
FROM stores s
WHERE o.store_name = s.store_name
  AND o.store_franchise_type IS NULL;
```

---

## 📈 看板集成建议

### 在智能门店看板中添加筛选器

```python
# 在 智能门店看板_Dash版.py 中添加筛选组件

franchise_type_filter = dcc.Dropdown(
    id='franchise-type-filter',
    options=[
        {'label': '全部门店类型', 'value': 'all'},
        {'label': '直营店', 'value': '1'},
        {'label': '加盟店', 'value': '2'},
        {'label': '托管店', 'value': '3'},
        {'label': '买断', 'value': '4'},
        {'label': '未分类', 'value': 'null'}
    ],
    value='all',
    placeholder='选择门店类型',
    style={'width': '200px'}
)
```

### 在数据筛选回调中应用

```python
@app.callback(
    Output('analysis-result', 'children'),
    Input('franchise-type-filter', 'value'),
    Input('date-picker', 'start_date'),
    Input('date-picker', 'end_date')
)
def update_analysis(franchise_type, start_date, end_date):
    # 构建SQL查询
    query = "SELECT * FROM orders WHERE date BETWEEN %s AND %s"
    params = [start_date, end_date]
    
    # 添加加盟类型筛选
    if franchise_type != 'all':
        if franchise_type == 'null':
            query += " AND store_franchise_type IS NULL"
        else:
            query += " AND store_franchise_type = %s"
            params.append(int(franchise_type))
    
    # 执行查询...
    df = pd.read_sql(query, conn, params=params)
    # 后续分析逻辑...
```

---

## 🔍 数据验证

### 检查字段是否添加成功

```sql
-- 查看字段定义
SELECT 
    column_name, 
    data_type, 
    is_nullable,
    column_default
FROM information_schema.columns 
WHERE table_name='orders' AND column_name='store_franchise_type';
```

**预期输出:**
```
 column_name          | data_type | is_nullable | column_default
----------------------+-----------+-------------+---------------
 store_franchise_type | smallint  | YES         | NULL
```

### 检查索引是否创建

```sql
-- 查看索引
SELECT indexname, indexdef
FROM pg_indexes 
WHERE tablename='orders' AND indexname='idx_orders_franchise_type';
```

**预期输出:**
```
 indexname                    | indexdef
------------------------------+--------------------------------------------------
 idx_orders_franchise_type    | CREATE INDEX idx_orders_franchise_type ON ...
```

### 检查数据分布

```sql
-- 统计各类型订单数
SELECT 
    store_franchise_type,
    COUNT(*) AS 订单数,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS 占比
FROM orders
GROUP BY store_franchise_type
ORDER BY 订单数 DESC;
```

---

## 🛡️ 数据完整性约束

### 已添加的约束
```sql
-- 检查约束: 确保值在1-4或NULL
ALTER TABLE orders
ADD CONSTRAINT chk_franchise_type 
CHECK (store_franchise_type IS NULL OR store_franchise_type BETWEEN 1 AND 4);
```

### 测试约束有效性
```sql
-- 测试1: 插入合法值 (应成功)
INSERT INTO orders (order_id, store_franchise_type, ...) 
VALUES ('TEST001', 1, ...);  -- ✅ 成功

-- 测试2: 插入非法值 (应失败)
INSERT INTO orders (order_id, store_franchise_type, ...) 
VALUES ('TEST002', 5, ...);  -- ❌ 失败: 违反约束

-- 测试3: 插入NULL值 (应成功)
INSERT INTO orders (order_id, store_franchise_type, ...) 
VALUES ('TEST003', NULL, ...);  -- ✅ 成功
```

---

## 🔄 回滚方案

### 如需删除字段 (谨慎操作)

```sql
-- Step 1: 删除索引
DROP INDEX IF EXISTS idx_orders_franchise_type;

-- Step 2: 删除约束
ALTER TABLE orders DROP CONSTRAINT IF EXISTS chk_franchise_type;

-- Step 3: 删除字段
ALTER TABLE orders DROP COLUMN IF EXISTS store_franchise_type;
```

**⚠️ 警告:** 回滚将永久删除所有 `store_franchise_type` 数据,请确保有备份!

---

## ❓ 常见问题

### Q1: 历史数据都显示为"未分类"怎么办?
**A:** 历史数据默认为NULL(未分类),这是正常的。如需标记历史数据,参考"数据维护"章节的批量更新方法。

### Q2: 上传新数据时字段没有自动填充?
**A:** 检查以下几点:
1. Excel列名是否包含"门店类型"/"加盟类型"等关键词
2. 数值是否为1-4之间的整数
3. 查看 `真实数据处理器.py` 的字段映射配置
4. 检查上传日志是否有错误提示

### Q3: 可以使用中文字段名吗?
**A:** 虽然PostgreSQL支持中文字段名,但**强烈建议使用英文字段名**:
- ✅ SQL查询更简洁 (不需要双引号)
- ✅ Python ORM使用更方便
- ✅ 避免编码问题
- ✅ 团队协作更规范
- 💡 可通过 `COMMENT ON COLUMN` 添加中文说明

### Q4: 索引会影响插入性能吗?
**A:** 会有轻微影响,但可忽略:
- 单索引字段 (SMALLINT) 占用空间极小
- 查询性能提升远大于插入性能损耗
- 适用于读多写少的OLAP场景

### Q5: 如何在Pandas中使用这个字段?
```python
import pandas as pd
from database.connection import engine

# 读取数据时筛选加盟店
df = pd.read_sql("""
    SELECT * FROM orders 
    WHERE store_franchise_type = 2  -- 加盟店
      AND date >= '2025-01-01'
""", engine)

# 添加中文标签
df['加盟类型'] = df['store_franchise_type'].map({
    1: '直营店',
    2: '加盟店',
    3: '托管店',
    4: '买断',
    None: '未分类'
})

# 按加盟类型分组分析
summary = df.groupby('加盟类型').agg({
    'amount': 'sum',
    'profit': 'mean',
    'order_id': 'count'
}).rename(columns={
    'amount': '销售额',
    'profit': '平均利润',
    'order_id': '订单数'
})
```

---

## 📝 字段变更记录

| 日期 | 操作 | 说明 | 操作人 |
|------|------|------|--------|
| 2025-11-19 | 新增字段 | 添加 store_franchise_type 字段 | 系统管理员 |
| 2025-11-19 | 创建索引 | 创建 idx_orders_franchise_type | 系统管理员 |
| 2025-11-19 | 添加约束 | 添加 chk_franchise_type 约束 | 系统管理员 |

---

## 📚 相关文件清单

| 文件 | 说明 |
|------|------|
| `database/add_store_franchise_type_field.py` | Python迁移脚本 (开发环境) |
| `database/migrations/pg_ddl_20251119.sql` | SQL脚本 (生产环境) |
| `database/models.py` | 数据库模型定义 (已更新) |
| `真实数据处理器.py` | 字段映射配置 (已更新) |
| `门店加盟类型字段使用指南.md` | 本文档 |

---

## 🎯 后续计划

- [ ] 在智能门店看板添加"按加盟类型分析"模块
- [ ] 开发加盟店业绩对比报表
- [ ] 建立门店主数据管理系统
- [ ] 集成加盟店业绩排行榜
- [ ] 支持加盟类型维度的AI智能诊断

---

## 📞 技术支持

如遇到问题,请联系技术支持团队,或查看项目文档:
- 项目仓库: `O2O-Analysis`
- 技术文档: `部署清单.md`
- 版本历史: `版本更新日志.md`

---

**文档版本:** v1.0  
**最后更新:** 2025-11-19  
**维护人:** AI助手
