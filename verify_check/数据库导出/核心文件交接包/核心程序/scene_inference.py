#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
åœºæ™¯æ¨æ–­å·¥å…·æ¨¡å—
æ™ºèƒ½æ¨æ–­æ¶ˆè´¹åœºæ™¯å’Œæ—¶æ®µ

ä¼˜å…ˆçº§ï¼š
1. å•†å“åç§°å…³é”®è¯ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. åˆ†ç±»æ˜ å°„
3. æ—¶æ®µåå¤‡æ–¹æ¡ˆ
"""

import pandas as pd
import re
from datetime import datetime

# åœºæ™¯å…³é”®è¯æ˜ å°„ï¼ˆå•†å“åç§°ä¼˜å…ˆï¼‰
SCENE_KEYWORDS = {
    'æ—©é¤': ['æ—©é¤', 'è±†æµ†', 'æ²¹æ¡', 'åŒ…å­', 'ç²¥', 'ç…é¥¼', 'é¸¡è›‹', 'é¢åŒ…', 'ç‰›å¥¶', 'ç‡•éº¦'],
    'åˆé¤': ['åˆé¤', 'ä¾¿å½“', 'ç›’é¥­', 'å¥—é¤', 'ç‚’é¥­', 'ç‚’é¢', 'æ‹‰é¢', 'ç±³é¥­'],
    'æ™šé¤': ['æ™šé¤', 'æ™šé¥­', 'ç‚’èœ', 'çƒ§çƒ¤'],
    'å¤œå®µ': ['å¤œå®µ', 'å®µå¤œ', 'çƒ§çƒ¤', 'ä¸²ä¸²', 'å°é¾™è™¾', 'å•¤é…’'],
    'ä¸‹åˆèŒ¶': ['å’–å•¡', 'å¥¶èŒ¶', 'è›‹ç³•', 'ç”œå“', 'å†°æ·‡æ·‹', 'é¥®æ–™'],
    'ä¼‘é—²é›¶é£Ÿ': ['è–¯ç‰‡', 'é¥¼å¹²', 'ç³–æœ', 'å·§å…‹åŠ›', 'åšæœ', 'æœå†»', 'ç“œå­'],
    'æ—¥ç”¨è¡¥å……': ['çº¸å·¾', 'å«ç”Ÿçº¸', 'æ´—è¡£æ¶²', 'æ´—æ´ç²¾', 'ç‰™è†', 'é¦™çš‚', 'æ´—å‘æ°´'],
    'åº”æ€¥è´­ä¹°': ['ç”µæ± ', 'å……ç”µå™¨', 'é›¨ä¼', 'å£ç½©', 'åˆ›å¯è´´'],
    'è¥å…»è¡¥å……': ['ç»´ç”Ÿç´ ', 'è›‹ç™½ç²‰', 'é’™ç‰‡', 'ä¿å¥å“']
}

# åˆ†ç±»åˆ°åœºæ™¯çš„æ˜ å°„
CATEGORY_SCENE_MAP = {
    'ä¼‘é—²é£Ÿå“': 'ä¼‘é—²é›¶é£Ÿ',
    'é¥®æ–™': 'ä¸‹åˆèŒ¶',
    'é…’æ°´': 'å¤œé—´ç¤¾äº¤',
    'ç²®æ²¹è°ƒå‘³': 'æ—¥å¸¸è´­ç‰©',
    'é€Ÿé£Ÿ': 'åˆé¤',
    'ä¸ªäººæŠ¤ç†': 'æ—¥ç”¨è¡¥å……',
    'å®¶åº­æ¸…æ´': 'æ—¥ç”¨è¡¥å……',
    'æ¯å©´': 'å±…å®¶æ¶ˆè´¹',
    'å® ç‰©': 'å±…å®¶æ¶ˆè´¹',
    'ç”Ÿé²œ': 'æ—¥å¸¸è´­ç‰©'
}

# æ—¶æ®µåˆ°åœºæ™¯çš„åå¤‡æ˜ å°„ï¼ˆä¿®å¤ï¼šæ‰€æœ‰æ—¶æ®µé»˜è®¤éƒ½æ˜¯æ—¥å¸¸è´­ç‰©ï¼Œé¿å…åœºæ™¯è¢«é™åˆ¶åœ¨ç‰¹å®šæ—¶æ®µï¼‰
TIMESLOT_SCENE_MAP = {
    'æ¸…æ™¨(6-9ç‚¹)': 'æ—¥å¸¸è´­ç‰©',  # ä¿®æ”¹ï¼šæ—©é¤åº”ç”±å•†å“åç§°å…³é”®è¯åŒ¹é…
    'ä¸Šåˆ(9-12ç‚¹)': 'æ—¥å¸¸è´­ç‰©',
    'æ­£åˆ(12-14ç‚¹)': 'æ—¥å¸¸è´­ç‰©',  # ä¿®æ”¹ï¼šåˆé¤åº”ç”±å•†å“åç§°å…³é”®è¯åŒ¹é…
    'ä¸‹åˆ(14-18ç‚¹)': 'æ—¥å¸¸è´­ç‰©',  # ä¿®æ”¹ï¼šä¸‹åˆèŒ¶åº”ç”±å•†å“åç§°å…³é”®è¯åŒ¹é…
    'å‚æ™š(18-21ç‚¹)': 'æ—¥å¸¸è´­ç‰©',  # ä¿®æ”¹ï¼šæ™šé¤åº”ç”±å•†å“åç§°å…³é”®è¯åŒ¹é…
    'æ™šé—´(21-24ç‚¹)': 'æ—¥å¸¸è´­ç‰©',  # ä¿®æ”¹ï¼šä¼‘é—²é›¶é£Ÿåº”ç”±å•†å“åç§°å…³é”®è¯åŒ¹é…
    'æ·±å¤œ(0-3ç‚¹)': 'æ—¥å¸¸è´­ç‰©',    # ä¿®æ”¹ï¼šå¤œå®µåº”ç”±å•†å“åç§°å…³é”®è¯åŒ¹é…
    'å‡Œæ™¨(3-6ç‚¹)': 'æ—¥å¸¸è´­ç‰©'     # ä¿®æ”¹ï¼šåº”æ€¥è´­ä¹°åº”ç”±å•†å“åç§°å…³é”®è¯åŒ¹é…
}


def classify_timeslot(hour):
    """
    æ ¹æ®å°æ—¶æ•°åˆ†ç±»æ—¶æ®µ
    
    å‚æ•°:
        hour: å°æ—¶æ•°ï¼ˆ0-23ï¼‰
    
    è¿”å›:
        str: æ—¶æ®µæ ‡ç­¾
    """
    if pd.isna(hour):
        return 'æœªçŸ¥æ—¶æ®µ'
    
    hour = int(hour)
    
    if 6 <= hour < 9:
        return 'æ¸…æ™¨(6-9ç‚¹)'
    elif 9 <= hour < 12:
        return 'ä¸Šåˆ(9-12ç‚¹)'
    elif 12 <= hour < 14:
        return 'æ­£åˆ(12-14ç‚¹)'
    elif 14 <= hour < 18:
        return 'ä¸‹åˆ(14-18ç‚¹)'
    elif 18 <= hour < 21:
        return 'å‚æ™š(18-21ç‚¹)'
    elif 21 <= hour < 24:
        return 'æ™šé—´(21-24ç‚¹)'
    elif 0 <= hour < 3:
        return 'æ·±å¤œ(0-3ç‚¹)'
    else:  # 3-6ç‚¹
        return 'å‡Œæ™¨(3-6ç‚¹)'


def infer_scene(row):
    """
    æ™ºèƒ½æ¨æ–­æ¶ˆè´¹åœºæ™¯
    
    ä¼˜å…ˆçº§:
    1. å•†å“åç§°å…³é”®è¯åŒ¹é…ï¼ˆæœ€å‡†ç¡®ï¼‰
    2. åˆ†ç±»æ˜ å°„
    3. æ—¶æ®µåå¤‡æ–¹æ¡ˆ
    
    å‚æ•°:
        row: DataFrameçš„ä¸€è¡Œï¼ŒåŒ…å« 'å•†å“åç§°', 'ä¸€çº§åˆ†ç±»å', 'æ—¶æ®µ' å­—æ®µ
    
    è¿”å›:
        str: åœºæ™¯æ ‡ç­¾
    """
    product_name = str(row.get('å•†å“åç§°', ''))
    category = str(row.get('ä¸€çº§åˆ†ç±»å', ''))
    timeslot = str(row.get('æ—¶æ®µ', ''))
    
    # ç¬¬1ä¼˜å…ˆçº§ï¼šå•†å“åç§°å…³é”®è¯åŒ¹é…
    for scene, keywords in SCENE_KEYWORDS.items():
        for keyword in keywords:
            if keyword in product_name:
                return scene
    
    # ç¬¬2ä¼˜å…ˆçº§ï¼šåˆ†ç±»æ˜ å°„
    if category in CATEGORY_SCENE_MAP:
        return CATEGORY_SCENE_MAP[category]
    
    # ç¬¬3ä¼˜å…ˆçº§ï¼šæ—¶æ®µåå¤‡
    if timeslot in TIMESLOT_SCENE_MAP:
        return TIMESLOT_SCENE_MAP[timeslot]
    
    # é»˜è®¤ï¼šç¤¾äº¤å¨±ä¹ï¼ˆæœ€é€šç”¨çš„åœºæ™¯ï¼‰
    return 'ç¤¾äº¤å¨±ä¹'


def add_scene_and_timeslot_fields(df, use_advanced_tagger=True):
    """
    ä¸ºDataFrameæ·»åŠ åœºæ™¯å’Œæ—¶æ®µå­—æ®µ
    
    å‚æ•°:
        df: pandas DataFrameï¼Œå¿…é¡»åŒ…å« 'æ—¥æœŸ' æˆ– 'ä¸‹å•æ—¶é—´' å­—æ®µ
        use_advanced_tagger: æ˜¯å¦ä½¿ç”¨é«˜çº§æ™ºèƒ½æ‰“æ ‡å¼•æ“ (é»˜è®¤True)
    
    è¿”å›:
        DataFrame: æ·»åŠ äº† 'æ—¶æ®µ' å’Œ 'åœºæ™¯' å­—æ®µçš„DataFrame
    
    ç¤ºä¾‹:
        >>> df = pd.DataFrame({'æ—¥æœŸ': ['2025-09-01 08:30:00'], 'å•†å“åç§°': ['è±†æµ†']})
        >>> df = add_scene_and_timeslot_fields(df)
        >>> df[['æ—¶æ®µ', 'åœºæ™¯']].values
        array([['æ¸…æ™¨(6-9ç‚¹)', 'æ—©é¤']], dtype=object)
    """
    df = df.copy()
    
    # ç¡®å®šæ—¥æœŸåˆ—
    date_col = 'æ—¥æœŸ' if 'æ—¥æœŸ' in df.columns else 'ä¸‹å•æ—¶é—´'
    
    if date_col not in df.columns:
        raise ValueError(f"DataFrameå¿…é¡»åŒ…å« 'æ—¥æœŸ' æˆ– 'ä¸‹å•æ—¶é—´' å­—æ®µ")
    
    # ç¡®ä¿æ—¥æœŸåˆ—æ˜¯datetimeç±»å‹
    if not pd.api.types.is_datetime64_any_dtype(df[date_col]):
        df[date_col] = pd.to_datetime(df[date_col], errors='coerce')
    
    # 1. æ·»åŠ æ—¶æ®µå­—æ®µ (æ€»æ˜¯æ‰§è¡Œ)
    df['å°æ—¶'] = df[date_col].dt.hour
    df['æ—¶æ®µ'] = df['å°æ—¶'].apply(classify_timeslot)
    
    # 2. æ·»åŠ åœºæ™¯å­—æ®µ
    if use_advanced_tagger:
        # ä½¿ç”¨é«˜çº§æ™ºèƒ½æ‰“æ ‡å¼•æ“ (å¤šç»´åº¦åˆ†æ)
        try:
            from å•†å“åœºæ™¯æ™ºèƒ½æ‰“æ ‡å¼•æ“ import ProductSceneTagger
            print("   ğŸ¯ ä½¿ç”¨æ™ºèƒ½åœºæ™¯æ‰“æ ‡å¼•æ“...")
            tagger = ProductSceneTagger()
            
            # å…ˆç¡®ä¿æœ‰åŸºç¡€åœºæ™¯å­—æ®µ,é¿å…åç»­å¤„ç†å‡ºé”™
            if 'åœºæ™¯' not in df.columns:
                df['åœºæ™¯'] = df.apply(infer_scene, axis=1)
            
            # æ‰§è¡Œæ™ºèƒ½æ‰“æ ‡
            df = tagger.tag_product_scenes(df)
            
            print(f"   âœ… æ™ºèƒ½æ‰“æ ‡å®Œæˆ! è¯†åˆ«åˆ° {df['åœºæ™¯'].nunique()} ä¸ªåœºæ™¯")
            if 'è´­ä¹°é©±åŠ¨' in df.columns:
                print(f"      - è´­ä¹°é©±åŠ¨: {df['è´­ä¹°é©±åŠ¨'].nunique()} ç§")
            if 'å­£èŠ‚åœºæ™¯' in df.columns:
                print(f"      - å­£èŠ‚åœºæ™¯: {df['å­£èŠ‚åœºæ™¯'].nunique()} ç§")
        except ImportError:
            print("   âš ï¸ æ™ºèƒ½æ‰“æ ‡å¼•æ“ä¸å¯ç”¨ï¼Œé™çº§åˆ°åŸºç¡€æ¨¡å¼")
            df['åœºæ™¯'] = df.apply(infer_scene, axis=1)
        except Exception as e:
            print(f"   âš ï¸ æ™ºèƒ½æ‰“æ ‡å¼•æ“æ‰§è¡Œå¤±è´¥: {e}ï¼Œé™çº§åˆ°åŸºç¡€æ¨¡å¼")
            import traceback
            traceback.print_exc()
            df['åœºæ™¯'] = df.apply(infer_scene, axis=1)
    else:
        # ä½¿ç”¨åŸºç¡€å…³é”®è¯åŒ¹é…
        print("   ğŸ“‹ ä½¿ç”¨åŸºç¡€åœºæ™¯æ¨æ–­...")
        df['åœºæ™¯'] = df.apply(infer_scene, axis=1)
    
    # æ¸…ç†ä¸´æ—¶åˆ—
    df = df.drop(columns=['å°æ—¶'], errors='ignore')
    
    return df


def get_available_scenes(df):
    """
    è·å–æ•°æ®ä¸­æ‰€æœ‰å¯ç”¨çš„åœºæ™¯åˆ—è¡¨
    
    å‚æ•°:
        df: DataFrame with 'åœºæ™¯' column
    
    è¿”å›:
        list: æ’åºåçš„åœºæ™¯åˆ—è¡¨
    """
    if 'åœºæ™¯' not in df.columns:
        return []
    
    return sorted(df['åœºæ™¯'].dropna().unique().tolist())


def get_available_timeslots(df):
    """
    è·å–æ•°æ®ä¸­æ‰€æœ‰å¯ç”¨çš„æ—¶æ®µåˆ—è¡¨
    
    å‚æ•°:
        df: DataFrame with 'æ—¶æ®µ' column
    
    è¿”å›:
        list: æŒ‰æ—¶é—´é¡ºåºæ’åºçš„æ—¶æ®µåˆ—è¡¨
    """
    if 'æ—¶æ®µ' not in df.columns:
        return []
    
    timeslot_order = [
        'æ¸…æ™¨(6-9ç‚¹)', 'ä¸Šåˆ(9-12ç‚¹)', 'æ­£åˆ(12-14ç‚¹)', 'ä¸‹åˆ(14-18ç‚¹)',
        'å‚æ™š(18-21ç‚¹)', 'æ™šé—´(21-24ç‚¹)', 'æ·±å¤œ(0-3ç‚¹)', 'å‡Œæ™¨(3-6ç‚¹)'
    ]
    
    available = df['æ—¶æ®µ'].dropna().unique().tolist()
    
    # æŒ‰é¢„å®šä¹‰é¡ºåºæ’åº
    return [t for t in timeslot_order if t in available]


# å•å…ƒæµ‹è¯•
if __name__ == "__main__":
    print("=" * 60)
    print("åœºæ™¯æ¨æ–­æ¨¡å—æµ‹è¯•")
    print("=" * 60)
    
    # æµ‹è¯•æ•°æ®
    test_data = pd.DataFrame({
        'æ—¥æœŸ': pd.to_datetime([
            '2025-09-01 08:30:00',
            '2025-09-01 12:30:00',
            '2025-09-01 15:00:00',
            '2025-09-01 19:00:00',
            '2025-09-01 23:00:00'
        ]),
        'å•†å“åç§°': ['è±†æµ†', 'ç‚’é¥­', 'å’–å•¡', 'ç‚’èœ', 'å•¤é…’'],
        'ä¸€çº§åˆ†ç±»å': ['é¥®æ–™', 'é€Ÿé£Ÿ', 'é¥®æ–™', 'ç”Ÿé²œ', 'é…’æ°´']
    })
    
    print("\nåŸå§‹æ•°æ®:")
    print(test_data)
    
    # æ·»åŠ åœºæ™¯å’Œæ—¶æ®µ
    result = add_scene_and_timeslot_fields(test_data)
    
    print("\næ·»åŠ åœºæ™¯å’Œæ—¶æ®µå:")
    print(result[['å•†å“åç§°', 'æ—¶æ®µ', 'åœºæ™¯']])
    
    # è·å–å¯ç”¨åœºæ™¯å’Œæ—¶æ®µ
    scenes = get_available_scenes(result)
    timeslots = get_available_timeslots(result)
    
    print(f"\nå¯ç”¨åœºæ™¯ ({len(scenes)}ä¸ª): {scenes}")
    print(f"å¯ç”¨æ—¶æ®µ ({len(timeslots)}ä¸ª): {timeslots}")
    
    print("\nâœ… æµ‹è¯•å®Œæˆï¼")
