# 门店数据清理和空间回收使用指南

## 问题说明

您遇到的两个问题:

### 1️⃣ 删除门店后下拉列表仍显示已删除的门店
**原因**: 下拉列表使用的是应用启动时的静态数据,不会自动更新

**解决方案**: ✅ 已修复 - 启用了动态刷新功能,删除门店后自动更新列表

### 2️⃣ 删除数据后数据库大小没有减少
**原因**: PostgreSQL的空间管理机制

- **DELETE操作**: 只标记数据为"已删除",不释放磁盘空间
- **VACUUM**: 整理碎片,标记空间可重用,但不释放给操作系统  
- **VACUUM FULL**: 重建表,真正释放磁盘空间给操作系统

**解决方案**: ✅ 已修复 - 优化数据库功能使用VACUUM FULL回收空间

---

## 使用方法

### 步骤1: 删除门店数据

1. 进入看板的"数据生命周期"TAB
2. 在"按门店清理"区域,选择要清理的门店
3. 点击"查看门店数据"预览要删除的数据
4. 确认无误后,点击"删除门店数据"
5. **门店列表会自动刷新** ✨ (新功能)

### 步骤2: 回收磁盘空间

删除门店后,数据库大小不会立即减少,需要执行优化:

1. 在同一页面滚动到底部
2. 点击"优化数据库"按钮
3. 等待优化完成(可能需要几分钟)
4. 优化完成后会显示成功提示

**优化过程包括**:
- ✅ VACUUM FULL - 回收磁盘空间给操作系统
- ✅ REINDEX - 重建索引提升查询性能
- ✅ ANALYZE - 更新统计信息优化查询计划

### 步骤3: 验证效果

优化完成后:

1. 刷新浏览器页面 (Ctrl+F5 或 Cmd+Shift+R)
2. 进入"数据库统计"查看新的数据库大小
3. 门店列表中不再显示已删除的门店

---

## 技术细节

### 修复内容

#### 1. 启用门店列表动态刷新 (智能门店看板_Dash版.py)

```python
@app.callback(
    Output('cleanup-store-select', 'options'),
    Input('delete-store-btn', 'n_clicks'),
    Input('optimize-database-btn', 'n_clicks'),
    prevent_initial_call=True
)
def refresh_store_dropdown(delete_clicks, optimize_clicks):
    '''删除门店或优化数据库后刷新下拉列表'''
    # 从数据库实时查询门店列表
    query = '''
    SELECT DISTINCT store_name
    FROM orders
    ORDER BY store_name
    '''
    results = manager.session.execute(text(query)).fetchall()
    return [{'label': r[0], 'value': r[0]} for r in results]
```

**变更说明**:
- ❌ 旧版本: 回调函数被注释,使用静态初始化数据
- ✅ 新版本: 启用回调,监听删除和优化按钮点击事件
- ✅ 效果: 删除门店后自动从数据库重新查询列表

#### 2. VACUUM FULL空间回收 (data_lifecycle_manager.py)

```python
def optimize_database(self):
    """优化数据库性能"""
    # 1. VACUUM FULL（完整清理）
    cursor.execute("VACUUM FULL orders")
    
    # 2. REINDEX（重建索引）
    cursor.execute("REINDEX TABLE orders")
    
    # 3. ANALYZE（更新统计信息）
    cursor.execute("ANALYZE orders")
```

**变更说明**:
- ✅ 已使用VACUUM FULL (不需要修改,之前已正确实现)
- ✅ 会真正释放磁盘空间给操作系统
- ⚠️ 执行时会锁表,建议在非高峰时段操作

---

## 当前数据库状态

```
💾 数据库大小: 98 MB
📋 订单表大小: 87 MB
🏪 门店数量: 1 个
  • 惠宜选-六安市金寨店: 14,838 条订单
```

### 预期优化效果

已删除"惠宜选-徐州沛县店"的17,934条订单,优化后预期:

- 数据库大小: 98 MB → 约 55-60 MB (减少约40%)
- 订单表大小: 87 MB → 约 45-50 MB (减少约40%)

---

## 注意事项

### ⚠️ 重要提醒

1. **VACUUM FULL会锁表**
   - 优化期间无法访问orders表
   - 建议在业务低峰时段执行
   - 通常耗时: 几分钟到十几分钟

2. **需要足够的磁盘空间**
   - VACUUM FULL需要临时空间存放新表
   - 至少需要表大小2倍的空闲空间
   - 当前需要约 87MB * 2 = 174MB 空闲空间

3. **刷新页面查看效果**
   - 删除/优化后建议刷新浏览器
   - 使用Ctrl+F5强制刷新清除缓存
   - 确保看到最新的门店列表

4. **定期维护建议**
   - 每月执行一次VACUUM FULL
   - 或删除大量数据后手动执行
   - 保持数据库健康状态

---

## 验证修复

运行验证脚本:

```bash
python 验证门店列表刷新和空间回收.py
```

如果选择执行优化(输入'y'),将会:
- ✅ 执行VACUUM FULL回收空间
- ✅ 重建索引
- ✅ 更新统计信息
- ✅ 显示优化前后的大小对比

---

## 问题排查

### 如果门店列表仍未刷新:

1. **检查浏览器缓存**: 按Ctrl+F5强制刷新
2. **检查控制台日志**: 查看是否有"🔄 已刷新门店列表"消息
3. **重启应用**: 停止看板应用后重新启动

### 如果优化后空间未减少:

1. **检查优化日志**: 确认VACUUM FULL成功执行
2. **检查磁盘空间**: 确保有足够的临时空间
3. **手动执行**: 使用database工具手动优化

```bash
cd database
python data_lifecycle_manager.py
# 选择选项 7. 优化数据库
```

---

## 后续建议

### 数据清理策略

1. **按时间清理**
   - 保留最近3-6个月的数据
   - 定期归档历史数据

2. **按门店清理**  
   - 关闭或迁移的门店及时清理
   - 测试数据定期删除

3. **优化频率**
   - 正常运营: 每月1次
   - 大量删除后: 立即执行
   - 性能下降时: 按需执行

---

**修复完成时间**: 2025年11月13日  
**修复内容**: 启用门店列表动态刷新 + 确认VACUUM FULL功能正常  
**影响文件**:
- ✅ 智能门店看板_Dash版.py (主程序)
- ✅ 交付包/智能门店看板_Dash版.py (交付版本)
- ✅ database/data_lifecycle_manager.py (已确认VACUUM FULL正确)
