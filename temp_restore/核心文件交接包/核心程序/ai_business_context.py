#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
AI业务上下文模块
为所有AI分析提供标准化的业务背景和提示词模板

创建时间: 2025-10-26
用途: 确保AI分析深度理解业务逻辑,提供专业的、可执行的建议
"""

# ==================== 业务背景常量 ====================

BUSINESS_CONTEXT = {
    "业务类型": "O2O闪购(纯线上外卖)",
    "主要平台": "美团、饿了么、京东",
    "经营模式": "24小时营业,仓店一体模式,上千家门店",
    "SKU规模": "6000+商品",
    "商品分类": "日常生活、个人洗护、出行必备、应季商品等几十个分类",
    "核心目标": "门店利润最大化",
    "营业特点": "纯线上,无线下门店,24小时营业",
    
    "健康指标": {
        "利润率": "8-15%",
        "商品成本占比": "55-65%",
        "履约成本占比": "8-12%",
        "平台成本占比": "5-8%",
        "营销成本占比": "3-8%"
    },
    
    "决策原则": [
        "利润优先(不盲目追求GMV)",
        "成本敏感(严控每分支出,追求最高ROI)",
        "数据驱动(所有决策基于数据洞察)",
        "全局视角(平衡上千家门店资源)",
        "敏锐应变(快速响应市场变化、平台政策、竞对动作)"
    ],
    
    "商品角色": {
        "流量品": {
            "定义": "高频刚需,低毛利,用于引流获客",
            "特征": "销量高TOP20%,毛利率<15%,价格竞争激烈",
            "占比": "25-30%",
            "策略": "保持价格竞争力,控制占比,搭配销售,避免单独促销"
        },
        "利润品": {
            "定义": "高毛利,差异化,核心盈利来源",
            "特征": "毛利率>30%,价格不敏感,贡献主要利润",
            "占比": "40-50%",
            "策略": "最大化销量,保护毛利率,关联推荐,提高曝光"
        },
        "形象品": {
            "定义": "品牌力强,提升门店形象",
            "特征": "品牌知名度高,毛利率15-30%",
            "占比": "20-25%",
            "策略": "维持品质,适度促销,提升客户信任"
        }
    },
    
    "风险阈值": {
        "利润率过低": "< 5%",
        "商品成本过高": "> 70%",
        "履约成本失控": "> 15%",
        "营销费用过高": "> 10%",
        "流量品占比过高": "> 40%",
        "利润品占比不足": "< 30%",
        "营销ROI过低": "< 1.0"
    }
}


# ==================== Few-Shot示例库 (阶段1优化) ====================

FEW_SHOT_EXAMPLES = {
    "利润下滑": """
【示例1: 利润下滑诊断】
输入数据:
- 当前利润率: 6.5%, 历史利润率: 12%
- GMV增长: +5% (950K → 1000K)
- 商品成本占比: 68% (历史62%)
- 履约成本占比: 14% (历史10%)
- 营销成本占比: 11% (历史6%)

分析过程:
1. 问题定位: 利润率下滑5.5%,主要是成本侧问题
   - 商品成本上升6%(62%→68%),超出健康阈值(<65%)
   - 履约成本上升4%(10%→14%),接近失控阈值(<15%)
   - 营销成本上升5%(6%→11%),已超过警戒线(<10%)

2. 根因分析:
   - 商品成本上升: 流量品占比过高(推测45%,健康值<30%),且未搭配销售
   - 履约成本上升: 低客单价订单增多,配送成本率失控
   - 营销成本上升: 存在ROI<1的烧钱活动

3. 解决方案 (按ROI排序):
   方案1: 控制流量品占比 (ROI: 5.0)
   - 立即停止单品流量品促销
   - 强制组合销售(流量品+利润品)
   - 预期: 商品成本降至62%(-6%), 利润率提升+3.5%
   
   方案2: 砍掉亏损营销活动 (ROI: 4.2)
   - 停止ROI<1的活动(预计占营销费用40%)
   - 营销成本降至6.6%(-4.4%)
   - 预期: 利润率提升+4.4%
   
   方案3: 提高起送金额 (ROI: 3.8)
   - 从29元提升至39元
   - 客单价提升+15%, 履约成本降至11%(-3%)
   - 预期: 利润率提升+2.5%

4. 效果预估:
   - 总计利润率提升: +10.4% (6.5% → 16.9%)
   - 总计利润金额提升: +160% (65K → 169K)
   - 综合ROI: 4.3

5. 执行优先级:
   - P0 (立即执行): 停止亏损营销活动 (当天见效)
   - P1 (1周内): 调整流量品组合销售策略
   - P2 (2周内): 提高起送金额 (需要AB测试)
""",
    
    "客单价提升": """
【示例2: 客单价提升策略】
输入数据:
- 当前客单价: 25元
- 目标客单价: 35元 (+40%)
- 利润品占比: 28% (健康值>40%)
- 平均商品数/订单: 1.2件
- 复购率: 45%

分析过程:
1. 问题定位: 客单价低,单品订单占比过高
   - 利润品占比不足(28%,健康值>40%)
   - 关联推荐缺失
   - 无满减激励

2. 根因分析:
   - 利润品曝光不足,用户只买流量品
   - 缺少组合装和套餐
   - 无满减阶梯引导多买

3. 解决方案 (按ROI排序):
   方案1: 设置满减阶梯 (ROI: 6.5)
   - 满49减5 (目标拉动10%用户凑单)
   - 满99减15 (目标拉动5%用户大额购买)
   - 预期: 客单价+35%, 利润品占比+12%
   
   方案2: 首页推荐利润品组合 (ROI: 5.8)
   - 洗护套装、零食组合、应季礼盒
   - 组合价格优惠5-8%
   - 预期: 客单价+20%, 利润品占比+8%
   
   方案3: 购物车关联推荐 (ROI: 4.2)
   - 买牛奶推荐面包、买洗发水推荐护发素
   - 算法优先推荐高毛利商品
   - 预期: 客单价+15%, 利润品占比+6%

4. 效果预估:
   - 客单价提升: 25元 → 38元 (+52%)
   - 利润品占比: 28% → 45% (+17%)
   - 订单利润提升: +65%

5. 执行优先级:
   - P0: 设置满减阶梯 (1天上线)
   - P1: 上架利润品组合 (3天准备)
   - P2: 开发关联推荐 (1周开发)
""",

    "商品结构优化": """
【示例3: 商品结构优化】
输入数据:
- 流量品占比: 45% (健康值25-30%)
- 利润品占比: 28% (健康值40-50%)
- 形象品占比: 18% (健康值20-25%)
- 滞销品: 9% (>60天无销售)
- 平均毛利率: 22% (偏低)

分析过程:
1. 问题定位: 商品结构失衡,赚钱能力弱
   - 流量品占比过高15%(45%,阈值<40%)
   - 利润品占比不足12%(28%,阈值>40%)
   - 滞销品占用库存和运营成本

2. 根因分析:
   - 过度依赖低价引流,忽视利润
   - 利润品SKU少或曝光不足
   - 商品优胜劣汰机制缺失

3. 解决方案 (按ROI排序):
   方案1: 淘汰滞销低毛利品 (ROI: 8.0)
   - 清退9%滞销品(约540个SKU)
   - 释放库存资金和运营精力
   - 预期: 平均毛利率+3%
   
   方案2: 引入高毛利差异化商品 (ROI: 6.2)
   - 增加300个利润品SKU
   - 利润品占比提升至42%
   - 预期: 平均毛利率+6%, 整体利润率+4%
   
   方案3: 降低流量品曝光权重 (ROI: 5.5)
   - 首页流量品占比从60%降至30%
   - 搜索排序提升利润品权重
   - 预期: 流量品占比降至32%, 平均毛利率+4%

4. 效果预估:
   - 平均毛利率: 22% → 35% (+13%)
   - 整体利润率: 8% → 15% (+7%)
   - 商品结构: 流量30%|利润45%|形象25%

5. 执行优先级:
   - P0: 清退滞销品 (本周完成)
   - P1: 调整曝光权重 (1周上线)
   - P2: 引入新SKU (持续2个月)
"""
}


# ==================== CoT思维链模板 (阶段1优化) ====================

COT_TEMPLATE = """
【AI分析思维链】
请严格按照以下步骤进行分析,每步必须输出清晰结论:

▶ 第1步: 数据理解与验证
- 关键指标有哪些?数值是否合理?
- 与健康基准对比如何?(利润率8-15%, 商品成本55-65%, 履约成本8-12%, 营销成本3-8%)
- 是否有异常信号?(如成本>70%, 营销ROI<1)
- ⚠️ 数据验证规则 (刻在基因中):
  * 销售额 = Σ(每个订单的实收价格总和)
  * 客单价 = 销售额 / 订单数 (不是商品数)
  * 必须按订单ID分组,避免多商品订单重复计算

▶ 第2步: 问题定位
- 核心问题是什么?(收入侧 vs 成本侧)
- 主要矛盾 vs 次要因素
- 问题严重程度量化 (偏离健康基准X%)

▶ 第3步: 根因挖掘
- 为什么会出现这个问题?(深挖3层why)
- 商品角色分布是否合理?(流量25-30%, 利润40-50%, 形象20-25%)
- 成本结构哪里失控?
- 营销ROI如何?是否存在烧钱?
- 是否违背决策原则?(利润优先、成本敏感、数据驱动、全局视角、敏锐应变)

▶ 第4步: 方案设计
- 至少3个可执行方案 (按ROI从高到低排序)
- 每个方案包含:
  * 方案名称和核心思路
  * 具体执行步骤 (可落地,非空泛建议)
  * 预期效果量化 (利润率+X%, 成本-Y%)
  * ROI评估 (投入产出比)
  * 实施难度和周期
  * 风险提示

▶ 第5步: 效果预估
- 总计利润提升金额
- 利润率变化 (当前X% → 优化后Y%)
- 综合ROI评估

▶ 第6步: 执行路径
- P0 (立即执行,当天见效): [...]
- P1 (短期1周内): [...]
- P2 (中期1月内): [...]
- 需要监控的指标: [...]

【禁止事项】
❌ 跳过任何思维链步骤
❌ 空泛建议 (如"提升用户体验")
❌ 无法量化的方案
❌ 忽略成本的增长建议
❌ 盲目追求GMV (违背利润优先原则)
❌ 缺乏ROI评估的营销建议
❌ 违反数据计算规则 (如直接sum实收价格)
"""


# ==================== 数据验证规则 (刻在基因中) ====================

DATA_VALIDATION_RULES = """
【核心数据计算规则】(刻在代码基因中)

1. ⚠️ 多商品订单处理规则:
   ✅ 正确: df.groupby('订单ID')['实收价格'].sum().sum()
   ❌ 错误: df['实收价格'].sum() (会重复计算多商品订单)
   
2. 销售额计算:
   销售额 = Σ(每个订单的实收价格总和)
   # 一个订单可能包含多个商品,但每个订单只计算一次总价
   
3. 客单价计算:
   客单价 = 销售额 / 订单数
   ❌ 错误: 客单价 ≠ 销售额 / 商品数
   
4. 订单数计算:
   订单数 = 订单ID去重后的数量
   不是商品行数
   
5. 成本占比计算:
   商品成本占比 = 商品总成本 / 销售额 * 100%
   履约成本占比 = 配送费总成本 / 销售额 * 100%
   营销成本占比 = 营销补贴总额 / 销售额 * 100%
   
6. 利润率计算:
   利润率 = (销售额 - 商品成本 - 履约成本 - 平台成本 - 营销成本) / 销售额 * 100%

【AI分析时必须验证】
在提供任何数据分析结论前,先问自己:
- 这个销售额是否按订单ID分组计算的?
- 这个客单价是否用订单数而非商品数?
- 多商品订单是否被重复计算了?

如发现数据计算可能有误,必须在分析报告中明确指出!
"""


# ==================== AI提示词模板 ====================

def get_base_prompt():
    """获取基础业务背景提示词"""
    return f"""
你是一位资深的O2O零售运营专家,专门负责上千家闪购门店的利润优化工作。

【业务背景】
- 业务类型: {BUSINESS_CONTEXT['业务类型']}
- 主要平台: {BUSINESS_CONTEXT['主要平台']}
- 经营模式: {BUSINESS_CONTEXT['经营模式']}
- SKU规模: {BUSINESS_CONTEXT['SKU规模']}
- 核心目标: {BUSINESS_CONTEXT['核心目标']}

【健康指标基准】
- 利润率: {BUSINESS_CONTEXT['健康指标']['利润率']}
- 商品成本占比: {BUSINESS_CONTEXT['健康指标']['商品成本占比']}
- 履约成本占比: {BUSINESS_CONTEXT['健康指标']['履约成本占比']}
- 平台成本占比: {BUSINESS_CONTEXT['健康指标']['平台成本占比']}
- 营销成本占比: {BUSINESS_CONTEXT['健康指标']['营销成本占比']}

【决策原则】
{chr(10).join([f"{i+1}. {p}" for i, p in enumerate(BUSINESS_CONTEXT['决策原则'])])}

【商品角色体系】
- 流量品: {BUSINESS_CONTEXT['商品角色']['流量品']['定义']} (占比{BUSINESS_CONTEXT['商品角色']['流量品']['占比']})
- 利润品: {BUSINESS_CONTEXT['商品角色']['利润品']['定义']} (占比{BUSINESS_CONTEXT['商品角色']['利润品']['占比']})
- 形象品: {BUSINESS_CONTEXT['商品角色']['形象品']['定义']} (占比{BUSINESS_CONTEXT['商品角色']['形象品']['占比']})
"""


def get_analysis_prompt(task_name, data_summary, specific_question=None, use_cot=True, use_examples=True):
    """
    获取完整的分析提示词 (阶段1优化版)
    
    参数:
        task_name: 分析任务名称 (如"利润下滑诊断"、"商品结构分析"等)
        data_summary: 数据摘要 (关键指标的字典或字符串)
        specific_question: 具体问题 (可选)
        use_cot: 是否使用CoT思维链 (默认True)
        use_examples: 是否包含Few-Shot示例 (默认True)
    
    返回:
        完整的提示词字符串
    """
    base_prompt = get_base_prompt()
    
    # 格式化数据摘要
    if isinstance(data_summary, dict):
        data_str = "\n".join([f"- {k}: {v}" for k, v in data_summary.items()])
    else:
        data_str = str(data_summary)
    
    # 构建完整提示词
    full_prompt = f"""{base_prompt}

{DATA_VALIDATION_RULES}
"""
    
    # 添加Few-Shot示例
    if use_examples:
        # 根据任务类型选择合适的示例
        example_key = None
        if "利润" in task_name or "下滑" in task_name:
            example_key = "利润下滑"
        elif "客单价" in task_name:
            example_key = "客单价提升"
        elif "商品结构" in task_name or "商品" in task_name:
            example_key = "商品结构优化"
        
        if example_key and example_key in FEW_SHOT_EXAMPLES:
            full_prompt += f"""
【参考示例】
{FEW_SHOT_EXAMPLES[example_key]}

注意: 以上示例仅供参考,请根据实际数据进行分析,不要生搬硬套。
"""
    
    # 添加CoT思维链
    if use_cot:
        full_prompt += f"\n{COT_TEMPLATE}\n"
    
    # 添加当前任务数据
    full_prompt += f"""
【当前数据概览】
{data_str}

【分析任务】
{task_name}
"""
    
    if specific_question:
        full_prompt += f"\n【具体问题】\n{specific_question}\n"
    
    full_prompt += """
【输出要求】
请严格按照思维链步骤分析,提供专业的分析报告,必须包含:

1. **数据验证** (3-5行)
   - 检查数据计算是否符合规则(订单分组、客单价计算等)
   - 指出任何可能的数据异常
   - 确认数据可信度

2. **问题定位** (5-10行)
   - 清晰指出核心问题(流量/转化/成本/商品结构等)
   - 用数据量化问题严重程度
   - 对比健康指标基准,说明偏离程度

3. **归因分析** (10-15行)
   - 深挖根本原因,不停留在表象
   - 分析是收入侧问题还是成本侧问题
   - 识别关键影响因素及其权重

4. **解决方案** (15-20行)
   提供3-5个具体的、可执行的策略,每个方案包含:
   - 方案名称和核心思路
   - 具体执行步骤
   - 预期效果(量化收益)
   - ROI评估
   - 实施难度和周期
   - 按ROI从高到低排序

5. **效果预估** (5-8行)
   - 总计可提升的利润金额
   - 预计利润率变化 (当前X% → 优化后Y%)
   - 整体ROI评估

6. **执行建议** (5-8行)
   - P0(立即执行): [...]
   - P1(短期1周内): [...]
   - P2(中期1月内): [...]

7. **风险提示** (3-5行)
   - 指出潜在风险和注意事项
   - 提醒需要监控的指标

请确保每个方案都是具体可执行的,有明确的ROI评估和优先级排序。
"""
    
    return full_prompt


def get_profit_decline_prompt(current_metrics, historical_metrics):
    """
    利润下滑诊断专用提示词
    
    参数:
        current_metrics: 当前周期指标 (字典)
        historical_metrics: 历史周期指标 (字典)
    """
    data_summary = {
        "当前利润率": f"{current_metrics.get('利润率', 0):.2f}%",
        "历史利润率": f"{historical_metrics.get('利润率', 0):.2f}%",
        "利润率变化": f"{current_metrics.get('利润率', 0) - historical_metrics.get('利润率', 0):.2f}%",
        "当前GMV": f"¥{current_metrics.get('GMV', 0):,.0f}",
        "历史GMV": f"¥{historical_metrics.get('GMV', 0):,.0f}",
        "GMV变化率": f"{(current_metrics.get('GMV', 0) / historical_metrics.get('GMV', 1) - 1) * 100:.2f}%",
        "商品成本占比": f"{current_metrics.get('商品成本占比', 0):.2f}%",
        "履约成本占比": f"{current_metrics.get('履约成本占比', 0):.2f}%",
        "营销成本占比": f"{current_metrics.get('营销成本占比', 0):.2f}%"
    }
    
    specific_question = """
请重点分析:
1. 利润下滑的主要原因是收入下降还是成本上升?
2. 如果是收入下降,是流量、转化率还是客单价的问题?
3. 如果是成本上升,具体是哪类成本失控?
4. 商品结构是否健康?流量品/利润品占比是否合理?
5. 营销活动的ROI如何?是否存在烧钱问题?
6. 给出优先级排序的解决方案,预估每个方案的利润提升空间
"""
    
    return get_analysis_prompt("利润下滑诊断", data_summary, specific_question)


def get_product_structure_prompt(product_metrics):
    """
    商品结构分析专用提示词
    
    参数:
        product_metrics: 商品指标 (字典)
    """
    data_summary = {
        "总SKU数": product_metrics.get('总SKU数', 0),
        "流量品数量": product_metrics.get('流量品数量', 0),
        "流量品占比": f"{product_metrics.get('流量品占比', 0):.2f}%",
        "利润品数量": product_metrics.get('利润品数量', 0),
        "利润品占比": f"{product_metrics.get('利润品占比', 0):.2f}%",
        "形象品数量": product_metrics.get('形象品数量', 0),
        "形象品占比": f"{product_metrics.get('形象品占比', 0):.2f}%",
        "平均毛利率": f"{product_metrics.get('平均毛利率', 0):.2f}%",
        "滞销品占比": f"{product_metrics.get('滞销品占比', 0):.2f}%"
    }
    
    specific_question = """
请重点分析:
1. 当前商品结构是否健康?与理想配比(流量25-30%,利润40-50%,形象20-25%)对比如何?
2. 流量品占比过高或过低会带来什么风险?
3. 利润品占比是否足够?如何提升利润品销量?
4. 滞销品问题严重吗?哪些商品应该淘汰?
5. 整体毛利率水平如何?有哪些优化空间?
6. 给出具体的商品结构优化方案
"""
    
    return get_analysis_prompt("商品结构分析", data_summary, specific_question)


def get_marketing_roi_prompt(marketing_metrics):
    """
    营销ROI分析专用提示词
    
    参数:
        marketing_metrics: 营销指标 (字典或DataFrame)
    """
    if isinstance(marketing_metrics, dict):
        data_summary = marketing_metrics
    else:
        # 如果是DataFrame,转换为摘要
        data_summary = {
            "营销活动数": len(marketing_metrics),
            "总营销成本": f"¥{marketing_metrics['营销成本'].sum():,.0f}",
            "总增量收入": f"¥{marketing_metrics['增量收入'].sum():,.0f}",
            "平均ROI": f"{marketing_metrics['ROI'].mean():.2f}",
            "ROI<1活动数": len(marketing_metrics[marketing_metrics['ROI'] < 1]),
            "ROI>3活动数": len(marketing_metrics[marketing_metrics['ROI'] > 3])
        }
    
    specific_question = """
请重点分析:
1. 哪些营销活动ROI过低(< 1)?应该立即停止?
2. 哪些营销活动效果好(ROI > 3)?应该加大投入?
3. 营销成本占比是否合理?是否存在烧钱问题?
4. 折扣力度是否过大?如何在保证吸引力的同时控制成本?
5. 如何优化营销策略,提升整体ROI?
6. 给出具体的营销优化方案和预期效果
"""
    
    return get_analysis_prompt("营销ROI分析", data_summary, specific_question)


def get_period_scenario_prompt(period_metrics, scenario_metrics):
    """
    时段场景分析专用提示词
    
    参数:
        period_metrics: 时段指标 (DataFrame或字典)
        scenario_metrics: 场景指标 (DataFrame或字典)
    """
    # 构建数据摘要
    if hasattr(period_metrics, 'to_dict'):
        period_summary = period_metrics.to_dict('records')
    else:
        period_summary = period_metrics
    
    if hasattr(scenario_metrics, 'to_dict'):
        scenario_summary = scenario_metrics.to_dict('records')
    else:
        scenario_summary = scenario_metrics
    
    data_summary = f"""
【时段数据】
{period_summary}

【场景数据】
{scenario_summary}
"""
    
    specific_question = """
请重点分析:
1. 哪些时段是黄金时段(高订单量+高客单价+高利润率)?
2. 哪些时段是低谷时段?如何优化?
3. 24小时营业模式下,深夜和凌晨时段是否盈利?成本是否可控?
4. 哪些消费场景最重要?应该重点运营?
5. 时段和场景如何组合,实现利润最大化?
6. 给出具体的时段场景营销策略
"""
    
    return get_analysis_prompt("时段场景营销分析", data_summary, specific_question)


# ==================== 辅助函数 ====================

def format_number(value, decimals=2):
    """格式化数字"""
    if isinstance(value, (int, float)):
        if decimals == 0:
            return f"{value:,.0f}"
        else:
            return f"{value:,.{decimals}f}"
    return str(value)


def get_health_warnings(metrics):
    """
    获取健康度预警
    
    参数:
        metrics: 指标字典
    
    返回:
        预警列表
    """
    warnings = []
    
    利润率 = metrics.get('利润率', 0)
    商品成本占比 = metrics.get('商品成本占比', 0)
    履约成本占比 = metrics.get('履约成本占比', 0)
    营销成本占比 = metrics.get('营销成本占比', 0)
    流量品占比 = metrics.get('流量品占比', 0)
    利润品占比 = metrics.get('利润品占比', 0)
    
    # 利润率检查
    if 利润率 < 5:
        warnings.append({
            "级别": "严重",
            "指标": "利润率",
            "当前值": f"{利润率:.2f}%",
            "阈值": "< 5%",
            "问题": "利润率过低,存在严重亏损风险",
            "建议": "立即诊断成本结构,砍掉亏损商品和活动"
        })
    elif 利润率 < 8:
        warnings.append({
            "级别": "警告",
            "指标": "利润率",
            "当前值": f"{利润率:.2f}%",
            "阈值": "< 8%",
            "问题": "利润率偏低,低于健康水平",
            "建议": "优化商品结构,提升利润品占比"
        })
    
    # 商品成本检查
    if 商品成本占比 > 70:
        warnings.append({
            "级别": "严重",
            "指标": "商品成本占比",
            "当前值": f"{商品成本占比:.2f}%",
            "阈值": "> 70%",
            "问题": "商品成本过高,毛利率严重不足",
            "建议": "优化采购价格或提高售价,砍掉低毛利商品"
        })
    elif 商品成本占比 > 65:
        warnings.append({
            "级别": "警告",
            "指标": "商品成本占比",
            "当前值": f"{商品成本占比:.2f}%",
            "阈值": "> 65%",
            "问题": "商品成本偏高",
            "建议": "评估定价策略,适度提价"
        })
    
    # 履约成本检查
    if 履约成本占比 > 15:
        warnings.append({
            "级别": "严重",
            "指标": "履约成本占比",
            "当前值": f"{履约成本占比:.2f}%",
            "阈值": "> 15%",
            "问题": "履约成本失控",
            "建议": "提高起送金额,优化配送范围,减少低客单价订单"
        })
    elif 履约成本占比 > 12:
        warnings.append({
            "级别": "警告",
            "指标": "履约成本占比",
            "当前值": f"{履约成本占比:.2f}%",
            "阈值": "> 12%",
            "问题": "履约成本偏高",
            "建议": "评估配送效率,考虑调整起送金额"
        })
    
    # 营销成本检查
    if 营销成本占比 > 10:
        warnings.append({
            "级别": "严重",
            "指标": "营销成本占比",
            "当前值": f"{营销成本占比:.2f}%",
            "阈值": "> 10%",
            "问题": "营销费用过高,可能存在烧钱问题",
            "建议": "立即停止ROI<1的活动,严控折扣力度"
        })
    elif 营销成本占比 > 8:
        warnings.append({
            "级别": "警告",
            "指标": "营销成本占比",
            "当前值": f"{营销成本占比:.2f}%",
            "阈值": "> 8%",
            "问题": "营销成本偏高",
            "建议": "评估营销ROI,优化活动策略"
        })
    
    # 商品结构检查
    if 流量品占比 > 40:
        warnings.append({
            "级别": "警告",
            "指标": "流量品占比",
            "当前值": f"{流量品占比:.2f}%",
            "阈值": "> 40%",
            "问题": "流量品占比过高,拖累整体毛利率",
            "建议": "减少低毛利商品,增加利润品曝光"
        })
    
    if 利润品占比 < 30:
        warnings.append({
            "级别": "警告",
            "指标": "利润品占比",
            "当前值": f"{利润品占比:.2f}%",
            "阈值": "< 30%",
            "问题": "利润品占比不足,赚钱能力弱",
            "建议": "加大利润品推广,提升销量占比"
        })
    
    return warnings


# ==================== 单元测试 ====================

if __name__ == "__main__":
    print("=" * 80)
    print("AI业务上下文模块测试")
    print("=" * 80)
    
    # 测试1: 基础提示词
    print("\n【测试1: 基础提示词】")
    print(get_base_prompt())
    
    # 测试2: 利润下滑分析提示词
    print("\n【测试2: 利润下滑分析提示词】")
    current = {
        "利润率": 6.5,
        "GMV": 1000000,
        "商品成本占比": 68,
        "履约成本占比": 14,
        "营销成本占比": 11
    }
    historical = {
        "利润率": 12.0,
        "GMV": 950000,
        "商品成本占比": 62,
        "履约成本占比": 10,
        "营销成本占比": 6
    }
    print(get_profit_decline_prompt(current, historical))
    
    # 测试3: 健康度预警
    print("\n【测试3: 健康度预警】")
    warnings = get_health_warnings(current)
    for w in warnings:
        print(f"\n⚠️ {w['级别']}警告:")
        print(f"   指标: {w['指标']}")
        print(f"   当前值: {w['当前值']} (阈值: {w['阈值']})")
        print(f"   问题: {w['问题']}")
        print(f"   建议: {w['建议']}")
    
    print("\n✅ 测试完成!")
