# V8.10.2 ç®—æ³•ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ

## ğŸ” æ€§èƒ½ç“¶é¢ˆå®šä½

### å½“å‰ä»£ç åˆ†æ

ç»è¿‡è¯¦ç»†ä»£ç å®¡æŸ¥ï¼Œå‘ç°ï¼š

#### âœ… `identify_churn_customers` - å·²ä¼˜åŒ–
```python
# å½“å‰å®ç°å·²ç»ä½¿ç”¨å‘é‡åŒ–
customer_stats = df_recent.groupby('customer_id').agg({...})  # O(n)
```
**æ€§èƒ½**ï¼šå·²ç»å¾ˆå¥½ï¼Œæ— éœ€ä¼˜åŒ–

#### âŒ `analyze_churn_reasons` - ä¸¥é‡ç“¶é¢ˆ
```python
# å½“å‰å®ç°ï¼šä¸‰å±‚åµŒå¥—
for _, customer_row in churn_customers.iterrows():  # 483æ¬¡
    customer_orders = df[df['customer_id'] == customer_id]  # æ¯æ¬¡æ‰«æ36043è¡Œï¼
    favorite_products = customer_orders.groupby('å•†å“åç§°').agg({...})  # æ¯æ¬¡èšåˆ
    
    for product_name, stats in favorite_products.iterrows():  # 3æ¬¡
        current_product = products_df[products_df['product_name'] == product_name]  # æ¯æ¬¡æ‰«æ7758è¡Œï¼
        # æ¶¨ä»·åˆ¤æ–­è¿˜æœ‰æ›´å¤šåµŒå¥—æŸ¥è¯¢...
```

**å¤æ‚åº¦åˆ†æ**ï¼š
- å¤–å±‚å¾ªç¯ï¼š483æ¬¡ï¼ˆæµå¤±å®¢æˆ·æ•°ï¼‰
- æ¯æ¬¡æ‰«ædfï¼š36,043è¡Œ
- å†…å±‚å¾ªç¯ï¼š3æ¬¡ï¼ˆTop3å•†å“ï¼‰
- æ¯æ¬¡æ‰«æproducts_dfï¼š7,758è¡Œ
- æ¶¨ä»·åˆ¤æ–­ï¼šæ¯ä¸ªå•†å“è¿˜è¦æ‰«æ2æ¬¡df

**æ€»è®¡ç®—é‡**ï¼š483 Ã— 36,043 Ã— 3 Ã— 7,758 Ã— 2 â‰ˆ **8,200äº¿æ¬¡æ“ä½œ**ï¼

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦36ç§’çš„åŸå› ã€‚

---

## ğŸ’¡ ä¼˜åŒ–ç­–ç•¥

### æ ¸å¿ƒæ€è·¯ï¼šé¢„å¤„ç† + æ‰¹é‡JOIN + å‘é‡åŒ–

#### ä¼˜åŒ–ç‚¹1ï¼šé¢„å¤„ç†ç´¢å¼•ï¼ˆä¸€æ¬¡æ€§ï¼‰
```python
# å°†é‡å¤æŸ¥è¯¢çš„æ•°æ®é¢„å¤„ç†æˆå­—å…¸
customer_orders_dict = {
    cid: group 
    for cid, group in df.groupby('customer_id')
}  # O(n)ï¼Œä½†åªæ‰§è¡Œä¸€æ¬¡

products_dict = products_df.set_index('product_name').to_dict('index')  # O(p)
```

#### ä¼˜åŒ–ç‚¹2ï¼šæ‰¹é‡JOINï¼ˆé¿å…å¾ªç¯æŸ¥è¯¢ï¼‰
```python
# ä¸€æ¬¡æ€§JOINæ‰€æœ‰éœ€è¦çš„æ•°æ®
df_with_product = df.merge(
    products_df[['product_name', 'stock']],
    left_on='å•†å“åç§°',
    right_on='product_name',
    how='left'
)  # O(n log p)
```

#### ä¼˜åŒ–ç‚¹3ï¼šå‘é‡åŒ–èšåˆï¼ˆæ›¿ä»£å¾ªç¯ï¼‰
```python
# æ‰¹é‡è®¡ç®—æ‰€æœ‰æµå¤±å®¢æˆ·çš„Topå•†å“
churn_customer_ids = set(churn_customers['customer_id'])
df_churn = df_with_product[df_with_product['customer_id'].isin(churn_customer_ids)]

# ä¸€æ¬¡æ€§èšåˆæ‰€æœ‰å®¢æˆ·çš„æ‰€æœ‰å•†å“
all_customer_products = df_churn.groupby(['customer_id', 'å•†å“åç§°']).agg({
    'å•†å“å®å”®ä»·': 'mean',
    'è®¢å•ID': 'nunique',
    'stock': 'first'
}).reset_index()

# å‘é‡åŒ–ç­›é€‰Top3
top3_per_customer = all_customer_products.sort_values(
    'è®¢å•ID', ascending=False
).groupby('customer_id').head(3)
```

#### ä¼˜åŒ–ç‚¹4ï¼šå‘é‡åŒ–é—®é¢˜åˆ¤æ–­
```python
# ä½¿ç”¨NumPyå‘é‡åŒ–åˆ¤æ–­
top3_per_customer['issue_type'] = np.where(
    top3_per_customer['stock'].isna(), 'delisted',
    np.where(top3_per_customer['stock'] == 0, 'out_of_stock', 'unknown')
)
```

### å¤æ‚åº¦å¯¹æ¯”

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **æ€»å¤æ‚åº¦** | O(nÃ—mÃ—kÃ—p) | O(n log p) | **1000å€+** |
| **å®é™…æ“ä½œæ•°** | 8,200äº¿ | 540ä¸‡ | **150,000å€** |
| **é¢„æœŸæ—¶é—´** | 36ç§’ | <0.5ç§’ | **72å€** |

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Step 1ï¼šåˆ›å»ºä¼˜åŒ–ç‰ˆæœ¬å‡½æ•°

åˆ›å»ºæ–°å‡½æ•° `analyze_churn_reasons_v2`ï¼Œä¿ç•™åŸå‡½æ•°ä½œä¸ºå¤‡ä»½ã€‚

### Step 2ï¼šé€æ­¥æ›¿æ¢

1. å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
2. A/Bå¯¹æ¯”ç»“æœ
3. ç¡®è®¤æ— è¯¯åæ›¿æ¢

### Step 3ï¼šæ€§èƒ½ç›‘æ§

æ·»åŠ è¯¦ç»†çš„æ€§èƒ½æ—¥å¿—ï¼Œç›‘æ§æ¯ä¸ªæ­¥éª¤çš„è€—æ—¶ã€‚

---

## ğŸ“ ä¼˜åŒ–åçš„å®Œæ•´ä»£ç 

è§ä¸‹ä¸€æ­¥å®æ–½...

---

**ç‰ˆæœ¬**ï¼šV8.10.2  
**åˆ›å»ºæ—¶é—´**ï¼š2025-12-11  
**é¢„æœŸæ•ˆæœ**ï¼š36ç§’ â†’ <2ç§’ï¼ˆæå‡95%ï¼‰
