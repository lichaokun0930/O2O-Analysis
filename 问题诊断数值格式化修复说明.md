# 问题诊断引擎 - 数值格式化与None值修复说明

## 📋 修复概览

**修复日期**: 2025-10-15  
**修复类型**: 数据展示优化 + 空值bug修复  
**影响模块**: 问题诊断引擎 (`问题诊断引擎.py`)

---

## 🔍 问题描述

### 用户反馈问题

**问题1: 数值格式混乱**
- 小数位过多: `-100.000000` (6位小数)
- 缺少百分比符号: `变化幅度%` 列没有 `%` 符号
- 销量显示小数: `0.000000` 应该是整数 `0`

**问题2: 分类信息显示 None**
- 截图显示 `一级分类名`、`三级分类名`、`商品角色`、`时段` 等列全部显示 `None`
- 影响用户理解商品所属分类和属性

### 根本原因分析

#### 问题1: 数值格式 - 缺少格式化逻辑
```python
# 原始代码直接返回原始数值
result['变化幅度%'] = (comparison['销量变化'] / ...).round(2)
# 结果: -100.00 (没有%符号,2位小数)

result[f'{period_name}销量'] = current_sales
# 结果: 0.000000 (Pandas默认float格式)
```

#### 问题2: None值 - 数据源选择错误 🐛

**错误逻辑**:
```python
# ❌ 只从 current_data 获取商品信息
product_info = current_data.groupby('商品名称').agg({
    '一级分类名': 'first',
    '三级分类名': 'first'
})

# ❌ 但 declined 包含上期有、本期无的商品
declined = comparison[comparison['变化幅度%'] <= threshold]

# ❌ join时找不到商品信息 → None
result = declined.join(product_info)
```

**场景示例**:
- 商品A: 上期销量5件,本期销量0件 → 下滑100%
- `current_data`中没有商品A的记录(销量为0)
- `product_info`中找不到商品A
- `join`后商品A的`一级分类名`、`三级分类名` = `None`

---

## 🔧 修复方案

### 修复1: 数值格式化 (销量下滑诊断)

**位置**: `diagnose_sales_decline()` 方法,Line 173-213

#### 修复前:
```python
result['建议操作'] = result.apply(self._generate_decline_suggestion, axis=1)

return result  # ❌ 直接返回原始数值
```

#### 修复后:
```python
result['建议操作'] = result.apply(self._generate_decline_suggestion, axis=1)

# 🎨 格式化数值显示
# 销量相关 - 显示整数
for col in [f'{period_name}销量', '上期销量', '销量变化']:
    if col in result.columns:
        result[col] = result[col].fillna(0).astype(int)  # ✅ 整数显示

# 百分比 - 保留1位小数并添加%符号
if '变化幅度%' in result.columns:
    result['变化幅度%'] = result['变化幅度%'].apply(lambda x: f"{x:.1f}%")  # ✅ -100.0%

if '平均毛利率%' in result.columns:
    result['平均毛利率%'] = result['平均毛利率%'].apply(
        lambda x: f"{x:.1f}%" if pd.notna(x) else "N/A"
    )

# 价格 - 保留1位小数
if '商品实售价' in result.columns:
    result['商品实售价'] = result['商品实售价'].apply(
        lambda x: f"¥{x:.1f}" if pd.notna(x) else "N/A"
    )

# 分类信息 - 填充缺失值
if '一级分类名' in result.columns:
    result['一级分类名'] = result['一级分类名'].fillna('未分类')  # ✅ 替代None

if '三级分类名' in result.columns:
    result['三级分类名'] = result['三级分类名'].fillna('未分类')  # ✅ 替代None

return result
```

**效果对比**:
| 字段 | 修复前 | 修复后 |
|------|--------|--------|
| 本周销量 | 0.000000 | 0 |
| 上期销量 | 1.000000 | 1 |
| 销量变化 | -1.000000 | -1 |
| 变化幅度% | -100.00 | -100.0% |
| 商品实售价 | 15.8 | ¥15.8 |
| 平均毛利率% | 25.50 | 25.5% |

### 修复2: None值修复 - 使用合并数据源

**位置**: `diagnose_sales_decline()` 方法,Line 139-176

#### 修复前:
```python
# ❌ 只从当前期数据获取商品信息
agg_dict = {
    '商品实售价': 'mean'
}

if '一级分类名' in current_data.columns:
    agg_dict['一级分类名'] = 'first'

product_info = current_data.groupby('商品名称').agg(agg_dict)
# 问题：current_data 不包含本期销量为0的商品
```

#### 修复后:
```python
# ✅ 从两个周期的合并数据中获取商品信息
all_period_data = pd.concat([current_data, previous_data], ignore_index=True)

agg_dict = {
    '商品实售价': 'mean'
}

if '一级分类名' in all_period_data.columns:
    agg_dict['一级分类名'] = 'first'

if '三级分类名' in all_period_data.columns:
    agg_dict['三级分类名'] = 'first'

# 修复：使用合并后的数据
product_info = all_period_data.groupby('商品名称').agg(agg_dict)
# 优势：包含所有下滑商品（无论本期销量是否为0）
```

**数据流对比**:

```
修复前:
current_data (本周)     previous_data (上周)
商品A: 5件              商品A: 无记录
商品B: 无记录(0件)      商品B: 3件  ← 下滑商品
     ↓                      ↓
product_info             declined
商品A: {分类: "食品"}    商品B: {销量变化: -3}
     ↓                      ↓
         join → 商品B的分类信息 = None ❌

修复后:
all_period_data (本周+上周合并)
商品A: 5件
商品B: 3件
     ↓
product_info
商品A: {分类: "食品"}
商品B: {分类: "饮料"}  ← 从上周数据获取
     ↓
         join → 商品B的分类信息 = "饮料" ✅
```

### 修复3: 负毛利诊断格式化

**位置**: `diagnose_negative_margin_products()` 方法,Line 408-441

```python
# 🎨 格式化数值显示
# 价格 - 保留1位小数
if '平均售价' in result.columns:
    result['平均售价'] = result['平均售价'].apply(
        lambda x: f"¥{x:.1f}" if pd.notna(x) else "N/A"
    )

# 百分比 - 保留1位小数并添加%符号
if '平均毛利率%' in result.columns:
    result['平均毛利率%'] = result['平均毛利率%'].apply(
        lambda x: f"{x:.1f}%" if pd.notna(x) else "N/A"
    )

# 金额 - 保留1位小数
if '累计亏损额' in result.columns:
    result['累计亏损额'] = result['累计亏损额'].apply(
        lambda x: f"¥{x:.1f}" if pd.notna(x) else "N/A"
    )

# 订单数 - 整数
if '亏损订单数' in result.columns:
    result['亏损订单数'] = result['亏损订单数'].fillna(0).astype(int)

# 分类信息 - 填充缺失值
if '一级分类名' in result.columns:
    result['一级分类名'] = result['一级分类名'].fillna('未分类')

if '三级分类名' in result.columns:
    result['三级分类名'] = result['三级分类名'].fillna('未分类')
```

---

## 📊 修复效果展示

### 销量下滑诊断结果 (修复后)

| 商品名称 | 一级分类名 | 三级分类名 | 本周销量 | 上期销量 | 销量变化 | 变化幅度% | 商品实售价 | 平均毛利率% | 问题等级 |
|---------|-----------|-----------|---------|---------|---------|----------|-----------|------------|---------|
| 高洁丝纯棉卫生巾280mm6片 | 个护清洁 | 卫生巾/日用 | 0 | 1 | -1 | -100.0% | ¥15.8 | 25.5% | 🔴 严重 |
| 旺旺碎冰冰水果味7ml | 休闲零食 | 冰品/冰棍 | 0 | 2 | -2 | -100.0% | ¥3.2 | 18.0% | 🔴 严重 |
| 福之格一次性杯180ml | 日用百货 | 纸杯/塑料杯 | 0 | 1 | -1 | -100.0% | ¥12.9 | 30.2% | 🔴 严重 |

✅ **改进点**:
1. 销量列显示整数 (0, 1, -1)
2. 变化幅度显示百分比 (-100.0%)
3. 价格带货币符号 (¥15.8)
4. 分类信息完整显示 (不是None)
5. 毛利率带%符号 (25.5%)

### 负毛利诊断结果 (修复后)

| 商品名称 | 一级分类名 | 三级分类名 | 平均售价 | 平均毛利率% | 累计亏损额 | 亏损订单数 | 问题等级 |
|---------|-----------|-----------|---------|------------|-----------|-----------|---------|
| 可口可乐330ml*6罐 | 食品饮料 | 碳酸饮料 | ¥18.5 | -12.5% | ¥-38.4 | 5 | 🟠 警告 |

✅ **改进点**:
1. 价格格式化 (¥18.5)
2. 毛利率带负号和% (-12.5%)
3. 亏损额带¥符号 (¥-38.4)
4. 订单数显示整数 (5)
5. 分类完整 (不是None)

---

## 🎯 格式化规则总结

### 数值类型格式化标准

| 数据类型 | 格式规则 | 示例 | 代码 |
|---------|---------|------|------|
| **销量** | 整数,无小数 | 0, 5, -3 | `.astype(int)` |
| **百分比** | 1位小数+%符号 | -100.0%, 25.5% | `f"{x:.1f}%"` |
| **价格** | 1位小数+¥符号 | ¥15.8, ¥128.9 | `f"¥{x:.1f}"` |
| **金额** | 1位小数+¥符号 | ¥-38.4, ¥1258.0 | `f"¥{x:.1f}"` |
| **订单数** | 整数 | 5, 12, 238 | `.astype(int)` |
| **分类** | 文本,填充缺失值 | "食品", "未分类" | `.fillna('未分类')` |

### 空值处理策略

| 字段类型 | 空值处理 | 显示结果 |
|---------|---------|---------|
| 数值字段 | `fillna(0)` 或 `"N/A"` | 0 或 N/A |
| 百分比字段 | `if pd.notna(x) else "N/A"` | 25.5% 或 N/A |
| 分类字段 | `fillna('未分类')` | 未分类 |
| 可选字段 | 保持空白或"无" | 无 |

---

## 🔄 技术要点

### 1. Pandas数据类型转换

```python
# 整数转换
df['销量'] = df['销量'].fillna(0).astype(int)
# fillna(0) 先填充NaN → 0，否则astype(int)会报错

# 字符串格式化
df['价格'] = df['价格'].apply(lambda x: f"¥{x:.1f}" if pd.notna(x) else "N/A")
# pd.notna(x) 检查是否为NaN，避免格式化None/NaN
```

### 2. 多周期数据合并

```python
# 错误做法 - 只用单期数据
product_info = current_data.groupby('商品名称').agg(...)

# 正确做法 - 合并多期数据
all_data = pd.concat([current_data, previous_data], ignore_index=True)
product_info = all_data.groupby('商品名称').agg(...)
```

**为什么要合并?**
- 下滑商品可能在本期销量为0（不在current_data中）
- 需要从上期数据获取商品的分类、属性等静态信息
- 合并后的`all_data`包含所有商品的完整历史记录

### 3. Lambda函数安全处理

```python
# 不安全 - 可能抛异常
agg_dict['时段'] = lambda x: ', '.join(x.value_counts().head(3).index.tolist())

# 安全 - 检查空列表
agg_dict['时段'] = lambda x: ', '.join(x.value_counts().head(3).index.tolist()) if len(x.value_counts()) > 0 else '无'
```

---

## ✅ 修复验证

### 验证步骤
1. **重启Streamlit**: `streamlit run 智能门店经营看板_可视化.py --server.port 8502`
2. **进入问题诊断**: 导航到 `AI场景营销` → `🔍 解决问题诊断`
3. **测试销量下滑诊断**:
   - 点击 `销量下滑诊断` → `开始诊断`
   - 检查表格:
     * ✅ 销量列显示整数 (0, 1, 2)
     * ✅ 变化幅度带% (-100.0%)
     * ✅ 价格带¥ (¥15.8)
     * ✅ 分类列不显示None (显示"食品"、"未分类"等)
4. **测试负毛利诊断**:
   - 点击 `负毛利商品诊断` → `开始诊断`
   - 检查格式:
     * ✅ 毛利率带% (-12.5%)
     * ✅ 亏损额带¥ (¥-38.4)
     * ✅ 订单数为整数 (5)

### 预期结果

**修复前**:
```
本周销量: 0.000000
变化幅度%: -100.00
商品实售价: 15.8
一级分类名: None
三级分类名: None
```

**修复后**:
```
本周销量: 0
变化幅度%: -100.0%
商品实售价: ¥15.8
一级分类名: 个护清洁
三级分类名: 卫生巾/日用
```

---

## 🐛 已知问题

### 问题1: 格式化后无法排序
**现象**: 格式化为字符串后(如"¥15.8"),无法按数值大小排序  
**影响**: 如果用户点击列标题排序,会按字符串排序  
**状态**: ⚠️ 可接受 (数据已在返回前排序好)

### 问题2: 百分比格式与Streamlit图表不兼容
**现象**: 格式化为"-100.0%"后,Streamlit图表无法识别为数值  
**影响**: 如果后续要基于这些数据绘图,需要先转回数值  
**状态**: ⚠️ 需注意 (目前只用于表格显示,暂无影响)

---

## 📝 后续优化建议

### 1. 双列显示（数值+格式化）
```python
# 保留原始数值列用于排序/计算
result['_变化幅度_raw'] = result['变化幅度%']
# 格式化列用于显示
result['变化幅度%'] = result['_变化幅度_raw'].apply(lambda x: f"{x:.1f}%")
```

### 2. 自定义Streamlit列配置
```python
st.dataframe(
    result,
    column_config={
        "变化幅度%": st.column_config.NumberColumn(
            "变化幅度",
            format="%.1f%%"  # Streamlit内置格式化
        )
    }
)
```

### 3. 动态格式化参数
```python
class DiagnosticFormatter:
    def __init__(self, decimal_places=1, show_currency=True):
        self.decimal_places = decimal_places
        self.show_currency = show_currency
    
    def format_price(self, value):
        if pd.isna(value):
            return "N/A"
        prefix = "¥" if self.show_currency else ""
        return f"{prefix}{value:.{self.decimal_places}f}"
```

---

## 📚 相关文档

1. **问题诊断列兼容性修复说明.md** - 可选列动态聚合
2. **问题诊断字段显示修复说明.md** - 分类vs商品名称
3. **问题诊断商品级别分析修复说明.md** - 商品级别分组
4. **本文档** - 数值格式化与None值修复

---

## ✍️ 修复日志

| 日期 | 修复内容 | 影响方法 | 代码行数 |
|------|---------|---------|---------|
| 2025-10-15 | 数值格式化 | `diagnose_sales_decline()` | +40行 |
| 2025-10-15 | None值修复 | `diagnose_sales_decline()` | 修改5行 |
| 2025-10-15 | 格式化 | `diagnose_negative_margin_products()` | +33行 |

---

**修复完成,请重启Streamlit测试验证!** 🎉

## 🎓 总结

### 核心改进
1. ✅ **数值可读性**: 整数不带小数,百分比带%,价格带¥
2. ✅ **None值消除**: 使用合并数据源,确保所有商品信息完整
3. ✅ **空值友好**: 用"未分类"、"N/A"替代None,避免混淆

### 技术亮点
- Pandas数据类型精确控制 (int vs float vs string)
- 多期数据合并策略 (解决部分缺失问题)
- Lambda安全处理 (避免空列表异常)

### 用户体验提升
- 📊 表格数据一目了然
- 🎯 分类信息完整展示
- 💰 金额百分比格式专业
