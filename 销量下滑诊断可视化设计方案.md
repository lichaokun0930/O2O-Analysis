# 销量下滑诊断可视化设计方案

## 📊 整体设计理念

### 核心目标
1. **快速定位问题**：通过可视化快速发现下滑重灾区
2. **多维度分析**：时段、场景、分类、商品等多角度展示
3. **量化影响**：不仅看销量，还要看收入和利润损失
4. **对比分析**：当前周期 vs 对比周期的直观对比

---

## 🎨 可视化看板设计（9大看板）

### 布局结构
```
┌─────────────────────────────────────────────────────┐
│ 📊 核心指标卡片（3个）                                │
├─────────────────────────────────────────────────────┤
│ 📈 图表区域（左右分栏）                               │
│ ├─ 左侧：时段/场景/分类分析（4个图表）                │
│ └─ 右侧：TOP排名和趋势（3个图表）                     │
├─────────────────────────────────────────────────────┤
│ 📋 详细数据表格（可筛选、可排序）                      │
└─────────────────────────────────────────────────────┘
```

---

## 1️⃣ 核心指标卡片（KPI Overview）

### 设计：3个并排的指标卡

```
┌──────────────┬──────────────┬──────────────┐
│ 📉 下滑商品数 │ 💸 收入损失   │ 💰 利润损失   │
│   15个       │  ¥12,345    │  ¥4,567     │
│   ↓18% vs上周│  ↓25% vs上周 │  ↓22% vs上周 │
└──────────────┴──────────────┴──────────────┘
```

**数据来源**：
```python
下滑商品数 = len(declined_products)
收入损失 = sum(当前期收入 - 对比期收入)
利润损失 = sum(收入损失 × 平均毛利率)
环比变化 = (当前值 - 上期值) / 上期值
```

**视觉设计**：
- 使用 `st.metric()` 组件
- 红色表示恶化，绿色表示改善
- 显示具体数值和百分比变化

---

## 2️⃣ 时段下滑分析（Time Slot Analysis）

### 图表1：分时段下滑商品数量（柱状图）

```
📊 各时段下滑商品数量

        15
        ██
   12   ██   10    8     5     3     2     1
   ██   ██   ██   ██    ██    ██    ██    ██
清晨  上午  正午  下午  傍晚  晚间  深夜  凌晨
(6-9)(9-12)(12-14)(14-18)(18-21)(21-24)(0-3)(3-6)
```

**实现逻辑**：
```python
# 按时段统计下滑商品数
时段统计 = 原始数据.groupby('时段').apply(
    lambda x: 计算该时段下滑商品数量
)

# Plotly柱状图
fig = go.Figure(go.Bar(
    x=时段列表,
    y=下滑商品数,
    marker_color='indianred'
))
```

**业务价值**：
- 发现问题时段（清晨、上午下滑最严重）
- 针对性调整营业时间或促销活动

### 图表2：分时段销量/收入/利润损失（多指标柱状图）

```
📊 各时段损失详情（可切换指标）

选择器：[销量损失] [收入损失] [利润损失]

        ¥5000
        ████
  ¥3000 ████  ¥2000  ¥1500  ¥800  ¥400  ¥200  ¥100
  ████  ████  ████   ████   ████  ████  ████  ████
 清晨   上午  正午   下午   傍晚  晚间  深夜  凌晨
```

**实现逻辑**：
```python
# 按时段聚合
时段损失 = df.groupby('时段').agg({
    '销量变化': 'sum',
    '收入变化': 'sum',
    '利润变化': 'sum'
})

# 切换按钮
指标 = st.radio("选择指标", ["销量损失", "收入损失", "利润损失"])
```

---

## 3️⃣ 场景下滑分析（Scene Analysis）

### 图表3：分场景下滑分布（饼图）

```
📊 各场景下滑商品占比

        早餐 35%
       ┌─────┐
    夜宵│     │下午茶
    15% │  █  │ 25%
       └─────┘
      午餐 20%  晚餐 5%
```

**实现逻辑**：
```python
场景分布 = df.groupby('场景')['商品名称'].count()

fig = go.Figure(go.Pie(
    labels=场景列表,
    values=商品数量,
    hole=0.4  # 环形图
))
```

**业务价值**：
- 发现问题场景（早餐场景下滑最严重）
- 优化场景化商品组合

### 图表4：场景损失对比（堆叠柱状图）

```
📊 各场景损失详情

      ¥6000│
           │    ████ 利润损失
      ¥4000│    ████ 收入损失
           │█████████ 销量损失
      ¥2000│█████████
           │█████████
         0 │─────────────────────
            早餐  午餐  下午茶 晚餐  夜宵
```

**实现逻辑**：
```python
场景损失 = df.groupby('场景').agg({
    '销量变化': 'sum',
    '收入变化': 'sum',
    '利润变化': 'sum'
})

# 堆叠柱状图
fig = go.Figure()
fig.add_trace(go.Bar(name='销量损失', x=场景, y=销量损失))
fig.add_trace(go.Bar(name='收入损失', x=场景, y=收入损失))
fig.add_trace(go.Bar(name='利润损失', x=场景, y=利润损失))
fig.update_layout(barmode='stack')
```

---

## 4️⃣ 分类下滑分析（Category Analysis）

### 图表5：一级分类下滑TOP5（横向柱状图）

```
📊 下滑最严重的5个品类

熟食制品    ████████████████ -¥5,000
饮料乳品    ██████████████ -¥4,200
休闲零食    ████████████ -¥3,800
粮油调味    ██████████ -¥3,000
日用百货    ████████ -¥2,500
```

**实现逻辑**：
```python
分类损失 = df.groupby('一级分类名').agg({
    '收入变化': 'sum',
    '商品数量': 'count'
}).sort_values('收入变化').head(5)

fig = go.Figure(go.Bar(
    x=收入损失,
    y=分类名称,
    orientation='h',  # 横向
    marker_color='coral'
))
```

**业务价值**：
- 发现高风险品类
- 优先优化重点品类

### 图表6：三级分类树状图（Treemap）

```
📊 三级分类下滑热力图

┌─────────────────────────────────────┐
│ 熟食制品                             │
│ ┌────────┬──────┬──────┐            │
│ │卤制品  │烧烤  │凉菜  │            │
│ │-¥2000  │-¥1500│-¥800 │  饮料乳品   │
│ └────────┴──────┴──────┘  -¥4200    │
│                                     │
│ ┌────────────────┐                  │
│ │  休闲零食       │    粮油调味      │
│ │  -¥3800        │    -¥3000       │
│ └────────────────┘                  │
└─────────────────────────────────────┘
```

**实现逻辑**：
```python
import plotly.express as px

fig = px.treemap(
    df,
    path=['一级分类名', '三级分类名'],
    values='收入损失绝对值',
    color='变化幅度%',
    color_continuous_scale='Reds'
)
```

**业务价值**：
- 直观看到分类层级和损失占比
- 颜色深浅表示下滑严重程度

---

## 5️⃣ TOP商品排名（Product Rankings）

### 图表7：下滑最严重TOP10商品（条形图）

```
📊 下滑最严重的10个商品

活珠子        ████████████████ -75% (-9单)
豆浆          ██████████████ -60% (-12单)
油条          ████████████ -50% (-8单)
盖浇饭        ██████████ -45% (-15单)
奶茶          ████████ -40% (-10单)
...
```

**实现逻辑**：
```python
top_declined = df.nsmallest(10, '变化幅度%')

fig = go.Figure(go.Bar(
    x=top_declined['变化幅度%'],
    y=top_declined['商品名称'],
    orientation='h',
    text=top_declined.apply(
        lambda x: f"{x['变化幅度%']:.1f}% ({x['销量变化']}单)",
        axis=1
    ),
    textposition='auto'
))
```

**视觉优化**：
- 悬停显示详细信息（分类、价格、毛利率）
- 颜色渐变（下滑越严重越红）

### 图表8：收入损失TOP10商品（瀑布图）

```
📊 收入损失TOP10商品

¥20000│
      │┌────┐
¥15000│││活珠│
      │││子 │┌────┐
¥10000│││-5K│││豆浆│
      │└────┘││-3K│┌────┐
¥5000 │      └────┘││油条│
      │            ││-2K│
    0 │            └────┘
      └──────────────────────
```

**实现逻辑**：
```python
top_revenue_loss = df.nsmallest(10, '收入变化')

fig = go.Figure(go.Waterfall(
    name="收入损失",
    orientation="v",
    x=top_revenue_loss['商品名称'],
    y=top_revenue_loss['收入变化'],
    connector={"line": {"color": "rgb(63, 63, 63)"}}
))
```

**业务价值**：
- 可视化累积损失
- 优先恢复高价值商品

---

## 6️⃣ 周期对比分析（Period Comparison）

### 图表9：当前期 vs 对比期销量对比（分组柱状图）

```
📊 销量对比（选取下滑TOP10）

  50│
    │  ██
  40│  ██     ██
    │  ██  ██ ██
  30│  ██  ██ ██  ██
    │  ██  ██ ██  ██  ██
  20│  ██  ██ ██  ██  ██
    │  ██  ██ ██  ██  ██
  10│  ██  ██ ██  ██  ██
    │  ██  ██ ██  ██  ██
   0│  ──  ──  ──  ──  ──
     活珠  豆浆 油条 盖饭 奶茶
      子

  █ 第38周   █ 第39周
```

**实现逻辑**：
```python
top10 = df.nsmallest(10, '变化幅度%')

fig = go.Figure()
fig.add_trace(go.Bar(
    name='第38周',
    x=top10['商品名称'],
    y=top10['对比期销量']
))
fig.add_trace(go.Bar(
    name='第39周',
    x=top10['商品名称'],
    y=top10['当前期销量']
))
fig.update_layout(barmode='group')
```

---

## 7️⃣ 利润影响分析（Profit Impact）

### 图表10：利润损失散点图（气泡图）

```
📊 销量变化 vs 利润损失

利润损失│
¥5000  │        ⭕ 活珠子
       │       (销量-9, 利润-¥4500)
¥3000  │  ⭕ 豆浆
       │ (销量-12, 利润-¥2800)
¥1000  │⭕ 油条
       │(销量-8, 利润-¥900)
     0 │─────────────────────
       0   -5   -10  -15  -20
            销量变化（单）

⭕ 大小表示商品价格
颜色表示毛利率（红=低毛利，绿=高毛利）
```

**实现逻辑**：
```python
fig = go.Figure(go.Scatter(
    x=df['销量变化'],
    y=df['利润损失'],
    mode='markers',
    marker=dict(
        size=df['商品实售价'] * 2,  # 气泡大小
        color=df['平均毛利率%'],    # 颜色
        colorscale='RdYlGn',
        showscale=True
    ),
    text=df['商品名称'],
    hovertemplate='<b>%{text}</b><br>' +
                  '销量变化: %{x}单<br>' +
                  '利润损失: ¥%{y:.0f}<br>'
))
```

**业务价值**：
- 四个维度（销量、利润、价格、毛利率）
- 快速识别"高价值损失商品"

---

## 8️⃣ 时段×场景交叉分析（Heatmap）

### 图表11：时段-场景下滑热力图

```
📊 时段×场景下滑热力图（商品数量）

场景＼时段  清晨  上午  正午  下午  傍晚  晚间  深夜  凌晨
早餐        🔴15  🟠8   🟡3   ⬜0   ⬜0   ⬜0   ⬜0   ⬜0
午餐        ⬜0   🟡2   🔴20  🟠10  🟡3   ⬜0   ⬜0   ⬜0
下午茶      ⬜0   🟡3   🟡4   🟠12  🟡5   ⬜1   ⬜0   ⬜0
晚餐        ⬜0   ⬜0   ⬜1   🟡3   🔴18  🟠8   🟡2   ⬜0
夜宵        ⬜0   ⬜0   ⬜0   ⬜0   🟡2   🟠6   🔴10  🟡3

颜色说明：
🔴 严重（15+商品）  🟠 警告（8-15商品）
🟡 关注（3-8商品）  ⬜ 正常（<3商品）
```

**实现逻辑**：
```python
import plotly.express as px

# 交叉统计
heatmap_data = df.groupby(['场景', '时段'])['商品名称'].count().unstack(fill_value=0)

fig = px.imshow(
    heatmap_data,
    labels=dict(x="时段", y="场景", color="下滑商品数"),
    x=时段列表,
    y=场景列表,
    color_continuous_scale='Reds'
)
```

**业务价值**：
- 发现"时段-场景"的问题组合
- 针对性优化（如"清晨早餐"下滑严重，加强早餐促销）

---

## 9️⃣ 趋势分析（Trend Analysis）

### 图表12：近4周下滑趋势（折线图）

```
📊 下滑商品数量趋势

商品数│
  20 │           ●
     │         ／
  15 │       ●
     │     ／
  10 │   ●
     │ ／
   5 │●
     │
   0 │─────────────────
     第35周 第36周 第37周 第38周

  ● 下滑商品数   ● 收入损失趋势
```

**实现逻辑**：
```python
# 需要循环计算近4周数据
trend_data = []
for week in range(4):
    declined = diagnostic_engine.diagnose_sales_decline(
        time_period='week',
        current_period_index=week
    )
    trend_data.append({
        '周次': f'第{38-week}周',
        '下滑商品数': len(declined),
        '收入损失': declined['收入变化'].sum()
    })

fig = go.Figure()
fig.add_trace(go.Scatter(
    x=周次,
    y=下滑商品数,
    mode='lines+markers',
    name='下滑商品数'
))
```

**业务价值**：
- 判断问题是否恶化
- 评估优化措施效果

---

## 🎨 视觉设计规范

### 颜色方案

**下滑程度配色**：
```python
颜色映射 = {
    '严重': '#d32f2f',    # 深红
    '警告': '#f57c00',    # 橙色
    '关注': '#fbc02d',    # 黄色
    '正常': '#388e3c'     # 绿色
}
```

**图表配色**：
- **销量**：蓝色系 `#1976d2`
- **收入**：绿色系 `#388e3c`
- **利润**：金色系 `#f57f17`
- **下滑**：红色系 `#d32f2f`

### 交互设计

1. **悬停提示**：显示详细数值
2. **点击联动**：点击图表筛选表格
3. **缩放拖拽**：支持图表缩放
4. **切换按钮**：指标/维度切换

---

## 📱 响应式布局

### 大屏显示（>1200px）
```
┌────────────────┬────────────────┐
│  图表1-6       │  图表7-9       │
│  (左侧)        │  (右侧)        │
└────────────────┴────────────────┘
```

### 中等屏幕（768-1200px）
```
┌──────────────────────────────┐
│  图表1-3                      │
├──────────────────────────────┤
│  图表4-6                      │
├──────────────────────────────┤
│  图表7-9                      │
└──────────────────────────────┘
```

### 小屏（<768px）
```
┌───────────────┐
│  图表1        │
├───────────────┤
│  图表2        │
├───────────────┤
│  ...          │
└───────────────┘
```

---

## 🔧 技术实现要点

### 数据准备
```python
def prepare_visualization_data(declined_df, raw_data, diagnostic_engine):
    """准备可视化所需的所有数据"""
    
    viz_data = {
        # KPI指标
        'kpi': {
            '下滑商品数': len(declined_df),
            '收入损失': declined_df['收入变化'].sum(),
            '利润损失': declined_df['利润变化'].sum()
        },
        
        # 时段分析
        'time_slot': {
            '商品数': 按时段统计下滑商品数,
            '销量损失': 按时段统计销量损失,
            '收入损失': 按时段统计收入损失
        },
        
        # 场景分析
        'scene': {
            '商品数': 按场景统计下滑商品数,
            '分布': 按场景计算占比
        },
        
        # 分类分析
        'category': {
            '一级分类': 按一级分类聚合,
            '三级分类': 按三级分类聚合
        },
        
        # TOP排名
        'top': {
            'top10_decline': 变化幅度最低的10个,
            'top10_revenue': 收入损失最大的10个
        }
    }
    
    return viz_data
```

### 图表封装
```python
def create_decline_chart(data, chart_type, title):
    """统一的图表创建函数"""
    
    if chart_type == 'bar':
        fig = go.Figure(go.Bar(...))
    elif chart_type == 'pie':
        fig = go.Figure(go.Pie(...))
    # ... 其他类型
    
    # 统一样式
    fig.update_layout(
        title=title,
        template='plotly_white',
        font=dict(family='Microsoft YaHei', size=12)
    )
    
    return fig
```

---

## 📊 推荐优先级

### 必须实现（MVP）✅
1. **核心指标卡片** - 快速概览
2. **时段下滑柱状图** - 发现问题时段
3. **TOP10商品排名** - 重点关注商品
4. **详细数据表格** - 数据明细

### 高优先级 🔥
5. **场景分布饼图** - 场景分析
6. **分类损失TOP5** - 品类分析
7. **周期对比柱状图** - 对比分析

### 中优先级 ⭐
8. **利润损失散点图** - 综合分析
9. **三级分类树状图** - 层级分析

### 可选优化 💡
10. **时段×场景热力图** - 交叉分析
11. **趋势折线图** - 时间序列分析
12. **瀑布图** - 累积效应

---

## 🎯 您的想法评估

| 您提出的 | 评价 | 建议 |
|---------|------|------|
| 分时段下滑分类情况 | ✅ 非常好 | 已设计（图表1、2） |
| 分时段下滑商品TOP | ✅ 必要 | 可与图表7结合 |
| 分场景下滑分类情况 | ✅ 重要 | 已设计（图表3、4） |
| 销售额损失 | ✅ 核心指标 | 已纳入所有图表 |
| 利润损失 | ✅ 最终目标 | 单独设计散点图 |

### 我补充的维度：
- ✅ **商品分类分析**（一级/三级）
- ✅ **周期对比**（当前 vs 对比）
- ✅ **时段×场景交叉**（热力图）
- ✅ **趋势分析**（4周变化）

---

## 💡 创新点

1. **四维散点图**：同时展示销量、利润、价格、毛利率
2. **交叉热力图**：时段×场景的问题定位
3. **树状图**：分类层级和占比可视化
4. **瀑布图**：累积损失的视觉冲击

---

## 📝 下一步

选择实现方案：

**方案A：一次性实现所有图表**
- 优点：功能完整
- 缺点：开发量大，可能有性能问题

**方案B：分阶段实现（推荐）**
- 第一阶段：MVP（图表1-4）
- 第二阶段：高优先级（图表5-7）
- 第三阶段：优化迭代（图表8-12）

**方案C：可配置显示**
- 默认显示核心图表
- 用户可选择展开更多图表
- 避免页面过长

请告诉我您的偏好，我们马上开始实现！🚀
