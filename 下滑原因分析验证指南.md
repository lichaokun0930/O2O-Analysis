# 下滑原因分析功能验证指南

## 功能改进概述

### 改进前
下滑TOP商品只显示:
```
【饮料】可口可乐(¥3.5)
【零食】薯片(¥5.2)
```

### 改进后
下滑TOP商品显示完整原因分析:
```
【饮料】可口可乐(¥0.0 之前¥3.5) → 🔴售罄
【零食】薯片(¥5.8 之前¥5.2) → 💰涨价导致销量降
【日用】洗发水(¥12.0 之前¥15.0) → 💸降价仍降量
【饮料】红牛(¥6.5) → 📉销量大幅下滑
【零食】巧克力(¥8.5) → 📉销量小幅下滑
```

---

## 下滑原因分类体系

| 原因标签 | 判断条件 | 运营建议 |
|---------|----------|----------|
| 🔴售罄 | 当前销量=0 & 之前销量>0 | ⚡立即补货 |
| 💰涨价导致销量降 | 单价上涨>5% & 销量下降 | 🔧调整定价策略 |
| 💸降价仍降量 | 单价下降>5% & 销量仍下降 | 🔍分析竞品压力 |
| 📉销量大幅下滑 | 销量下降>30% | ⚠️检查商品质量/营销力度 |
| 📉销量小幅下滑 | 销量下降<30% | 👀持续观察 |
| ✅正常 | 无明显问题 | - |

---

## 验证步骤

### 步骤1: 打开智能看板
访问: **http://localhost:8502**

### 步骤2: 切换到问题诊断Tab
点击顶部菜单 → **Tab4 - 问题诊断**

### 步骤3: 选择客单价归因分析
在问题诊断页面,选择:
- 分析类型: **客单价归因分析**
- 时间周期: **按日分析** 或 **按周分析**

### 步骤4: 查看下滑TOP商品
在分析结果表格中,找到以下列:
- 下滑TOP1商品
- 下滑TOP2商品
- 下滑TOP3商品
- 下滑TOP4商品
- 下滑TOP5商品

### 步骤5: 验证原因分析
检查每个商品是否显示:
✅ **商品分类** (如【饮料】)
✅ **商品名称** (如可口可乐)
✅ **当前价格** (如¥3.5)
✅ **价格变化** (如 之前¥3.0,表示涨价)
✅ **下滑原因** (如 → 💰涨价导致销量降)

---

## 预期效果示例

### 示例1: 售罄商品
```
【饮料】可口可乐(¥0.0 之前¥3.5) → 🔴售罄
```
**解读**: 可口可乐之前卖¥3.5,现在已售罄
**行动**: 立即补货

### 示例2: 涨价导致销量下降
```
【零食】薯片(¥5.8 之前¥5.2) → 💰涨价导致销量降
```
**解读**: 薯片从¥5.2涨价到¥5.8(涨幅11.5%>5%),导致销量下降
**行动**: 考虑调回原价或优化定价策略

### 示例3: 降价仍降量
```
【日用】洗发水(¥12.0 之前¥15.0) → 💸降价仍降量
```
**解读**: 洗发水从¥15.0降价到¥12.0(降幅20%>5%),但销量仍下降
**行动**: 可能存在竞品压力,需深入分析竞争环境

### 示例4: 销量大幅下滑
```
【饮料】红牛(¥6.5) → 📉销量大幅下滑
```
**解读**: 红牛价格未明显变化,但销量下降>30%
**行动**: 检查商品质量、陈列位置、营销活动

### 示例5: 销量小幅下滑
```
【零食】巧克力(¥8.5) → 📉销量小幅下滑
```
**解读**: 巧克力销量下降<30%,属于正常波动
**行动**: 持续观察,暂无需干预

---

## 技术实现

### 核心方法
文件: `问题诊断引擎.py`
方法: `_get_top_declining_products_with_reason()`

### 关键逻辑
```python
1. 聚合当前期和对比期数据
   current_agg = current_data.groupby('商品名称').agg(...)
   compare_agg = compare_data.groupby('商品名称').agg(...)

2. 计算变化指标
   merged['销售额变化'] = current - compare
   merged['销量变化'] = current - compare
   merged['单价变化率'] = (current - compare) / compare * 100

3. 判断下滑原因
   if 当前销量==0 and 之前销量>0: "🔴售罄"
   elif 单价上涨>5% and 销量下降: "💰涨价导致销量降"
   elif 单价下降>5% and 销量下降: "💸降价仍降量"
   elif 销量下降>30%: "📉销量大幅下滑"
   elif 销量下降: "📉销量小幅下滑"

4. 格式化输出
   format: 【分类】商品名(¥价格) → 原因
```

### 集成位置
1. **客单价归因分析** (问题诊断引擎.py 第523行)
2. **销量下滑诊断** (问题诊断引擎.py 第626行)

---

## 测试检查清单

- [ ] 客单价归因 - 按日分析 - 下滑商品显示原因
- [ ] 客单价归因 - 按周分析 - 下滑商品显示原因
- [ ] 销量下滑诊断 - 下滑商品显示原因
- [ ] 售罄商品标记为 🔴售罄
- [ ] 涨价导致销量降标记为 💰涨价导致销量降
- [ ] 降价仍降量标记为 💸降价仍降量
- [ ] 销量大幅下滑标记为 📉销量大幅下滑
- [ ] 销量小幅下滑标记为 📉销量小幅下滑
- [ ] 价格变化正确显示 (之前¥XX)
- [ ] 分类信息正确显示 【XX】

---

## 常见问题

### Q1: 为什么有些商品没有显示价格变化?
A: 如果单价变化<1%,为了保持显示简洁,不会显示"之前¥XX"。只显示当前价格。

### Q2: 为什么"下滑TOP"中有些商品标记为"✅正常"?
A: 下滑TOP是按销售额排序的,不一定都在下滑。标记"✅正常"说明该商品虽然销售额高,但没有明显问题。

### Q3: "🔴售罄"的商品为什么会出现在下滑TOP中?
A: 当前期销量为0的商品不会出现在TOP列表中。只显示仍在售(当前销售额>0)的商品。

### Q4: 如何调整原因判断的阈值?
A: 修改 `问题诊断引擎.py` 中的 `_get_top_declining_products_with_reason` 方法:
```python
# 当前阈值
单价变化>5%: row['单价变化率'] > 5
销量大幅下滑>30%: row['销量变化'] < -row['之前销量'] * 0.3

# 可自定义调整
单价变化>10%: row['单价变化率'] > 10
销量大幅下滑>50%: row['销量变化'] < -row['之前销量'] * 0.5
```

---

## 更新记录

| 日期 | 版本 | 更新内容 |
|-----|------|---------|
| 2025-10-16 | v1.0 | 初始版本 - 新增下滑原因分析功能 |
|  |  | - 新增 `_get_top_declining_products_with_reason` 方法 |
|  |  | - 集成到客单价归因分析 |
|  |  | - 集成到销量下滑诊断 |
|  |  | - 支持6种原因分类 |

---

**功能状态**: ✅ 已完成
**访问地址**: http://localhost:8502
**文档维护**: 问题诊断引擎开发团队
