# 🛠️ O2O看板开发日志 & 避坑指南

> 本文档记录开发过程中的关键变更、Bug修复及技术沉淀，用于后续查阅和避免重复踩坑。

---

## [2025-11-24 14:45] 修复美团共橙下钻显示"暂无数据"

- **类型**: 🐛 Bug修复
- **涉及文件**: `components/drill_down_callbacks.py`, `redis_cache_manager.py`
- **问题/背景**: 
  > 数据库中确认有1796条"美团共橙"的有效订单，但在看板点击该渠道下钻时，详情页显示"暂无数据"，且日志显示订单数为0。
- **根本原因**: 
  **Python模块导入导致的"脑裂" (Split Brain) 问题**。
  `drill_down_callbacks.py` 在文件头部使用了 `from 智能门店看板_Dash版 import GLOBAL_DATA`。
  这会在模块加载时创建 `GLOBAL_DATA` 的一个副本。由于模块加载发生在主程序更新 `GLOBAL_DATA` 之前，这个副本永远是空的（None或Empty DataFrame），且不会随主程序更新而更新。
- **解决方案**: 
  1. 引入 `redis_cache_manager`。
  2. 修改 `render_channel_detail` 函数，不再依赖模块级的 `GLOBAL_DATA`。
  3. 改为使用 `get_cached_dataframe(f"store_data:{store_name}:display")` 直接从 Redis 获取最新的门店数据。
  4. 更新回调函数 `update_drill_down_container` 以接收 `store_name` 参数。
- **💡 避坑/经验**: 
  **在 Dash 多模块架构中，严禁跨模块直接导入可变全局变量（如 DataFrame）。必须使用 Redis、dcc.Store 或回调函数的参数来传递动态数据，确保"单一事实来源" (Single Source of Truth)。**

---

## [2025-11-24 18:28] 开发效能工具集

- **类型**: 🛠️ 工具开发
- **涉及文件**: `扫描今日变动.py`, `maintain_dev_log.py`
- **功能**: 
  1. `扫描今日变动.py`: 自动扫描并按时间顺序列出当天修改过的文件，辅助生成开发日志。
  2. `maintain_dev_log.py`: 交互式脚本，用于标准化记录开发过程中的变更和Bug。
- **目的**: 提高开发过程的可追溯性，减少手动编写文档的工作量。

---

## [2025-11-24 16:42] 数据库编码与导入流程重构

- **类型**: ♻️ 代码重构 / 🐛 Bug修复
- **涉及文件**: `智能导入门店数据.py`, `重建数据库_UTF8.bat`, `检查Excel列名.py`
- **问题/背景**: 
  > 在导入"铜山万达"等实际数据时，遇到编码兼容性问题和列名匹配错误，导致数据入库失败或乱码。
- **解决方案**: 
  1. 创建 `重建数据库_UTF8.bat`，强制使用 UTF-8 编码初始化数据库环境。
  2. 优化 `智能导入门店数据.py`，增强对 Excel 列名的容错处理。
  3. 增加 `检查Excel列名.bat` 等批处理工具，方便快速诊断数据源问题。

---

## [2025-11-24 15:57] 利润计算逻辑专项验证

- **类型**: ✅ 测试/验证
- **涉及文件**: `验证美团利润_数据库版.py`, `验证美团闪购利润计算.py`, `快速验证祥和路利润.py`
- **背景**: 
  > 为确保看板显示的利润数据准确无误，需要与 Excel 原始报表进行精确对账。
- **结果**: 
  验证了美团及美团闪购渠道的利润计算公式，确认数据库计算逻辑与业务财务口径一致。

---

## [2025-11-24 14:54] 核心业务文档标准化

- **类型**: 📚 文档更新
- **涉及文件**: `【权威】业务逻辑与数据字典完整手册.md`, `Tab1业务逻辑说明文档.md`
- **内容**: 
  更新并锁定了核心业务逻辑定义，特别是订单聚合规则和成本计算标准，作为后续开发的唯一真理来源 (Single Source of Truth)。

---

## [2025-11-24 11:51] 下钻分析架构集成

- **类型**: ✨ 新功能
- **涉及文件**: `components/drill_down_manager.py`, `测试下钻架构集成.py`
- **功能**: 
  实现了基于状态模式 (State Pattern) 的下钻管理器，支持：
  1. 多层级导航 (总览 -> 渠道 -> 商品列表 -> 单品分析)。
  2. 面包屑导航自动生成。
  3. 历史记录栈管理（支持返回上一级）。
