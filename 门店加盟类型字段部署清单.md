# 🏪 门店加盟类型字段部署清单

## 📋 需求背景

**字段名称:** `store_franchise_type` (门店加盟类型)  
**业务需求:** 区分门店类型(直营/加盟/托管/买断),用于业绩分析和经营决策  
**编码规则:**
- `1` = 直营店
- `2` = 加盟店
- `3` = 托管店
- `4` = 买断
- `NULL` = 未分类(历史数据)

---

## ✅ 已完成工作

### 1️⃣ 数据库迁移脚本
✅ **文件:** `database/add_store_franchise_type_field.py`
- [x] 自动检查字段是否存在(幂等性)
- [x] 添加 `store_franchise_type` 字段 (SMALLINT)
- [x] 添加中文注释说明业务含义
- [x] 创建索引 `idx_orders_franchise_type`
- [x] 添加数据约束 `chk_franchise_type`
- [x] 自动生成生产SQL脚本
- [x] 完整的验证和回滚逻辑

**执行方式:**
```powershell
cd d:\Python1\O2O_Analysis\O2O数据分析\测算模型
python database/add_store_franchise_type_field.py
```

---

### 2️⃣ 生产SQL脚本
✅ **文件:** `database/migrations/pg_ddl_20251119.sql`
- [x] 标准PostgreSQL DDL语句
- [x] 包含完整注释说明
- [x] 提供验证SQL
- [x] 提供回滚脚本
- [x] 提供数据回填示例
- [x] 提供统计查询示例

**执行方式:**
```sql
-- 连接生产数据库
psql -h [数据库地址] -U [用户名] -d o2o_dashboard

-- 执行脚本
\i database/migrations/pg_ddl_20251119.sql

-- 验证结果
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_name='orders' AND column_name='store_franchise_type';
```

---

### 3️⃣ 数据库模型更新
✅ **文件:** `database/models.py`
- [x] Order模型中添加 `store_franchise_type` 字段定义
- [x] 设置正确的数据类型 (Integer)
- [x] 添加索引标记
- [x] 添加中文注释

**变更内容:**
```python
# 门店信息
store_franchise_type = Column(
    Integer, 
    index=True, 
    comment='门店加盟类型(1=直营店,2=加盟店,3=托管店,4=买断,NULL=未分类)'
)
```

---

### 4️⃣ 数据处理器更新
✅ **文件:** `真实数据处理器.py`
- [x] 在 `field_mapping` 字典中添加字段映射
- [x] 支持多种字段名识别:
  - `门店加盟类型` (标准名称)
  - `加盟类型` (简写)
  - `门店类型` (别名)
  - `store_franchise_type` (英文)
  - `franchise_type` (英文简写)
  - `店铺类型` (通用说法)

**变更内容:**
```python
# 门店类型信息 (用于加盟类型分析)
'门店加盟类型': [
    '门店加盟类型', '加盟类型', '门店类型', 
    'store_franchise_type', 'franchise_type', '店铺类型'
],
```

---

### 5️⃣ 使用文档
✅ **文件:** `门店加盟类型字段使用指南.md`
- [x] 字段规格详细说明
- [x] 快速开始指南
- [x] 数据导入配置说明
- [x] 使用场景示例 (4个SQL示例)
- [x] 数据维护方法 (批量更新)
- [x] 看板集成建议
- [x] 数据验证SQL
- [x] 回滚方案
- [x] 常见问题解答 (5个Q&A)

---

### 6️⃣ 测试脚本
✅ **文件:** `测试门店加盟类型字段.py`
- [x] 测试1: 数据库字段验证
- [x] 测试2: 字段映射功能
- [x] 测试3: 别名字段识别
- [x] 测试4: 数据约束验证
- [x] 测试5: 统计查询验证

**执行方式:**
```powershell
python 测试门店加盟类型字段.py
```

---

## 🚀 部署步骤

### 开发环境部署 (本地测试)

```powershell
# Step 1: 进入项目目录
cd d:\Python1\O2O_Analysis\O2O数据分析\测算模型

# Step 2: 执行数据库迁移
python database/add_store_franchise_type_field.py
# 提示: 输入 yes 确认执行

# Step 3: 运行测试验证
python 测试门店加盟类型字段.py

# Step 4: 检查测试结果
# 预期: 5/5 测试通过
```

---

### 生产环境部署

#### 方式A: 使用SQL脚本 (推荐)
```bash
# Step 1: 连接生产数据库
psql -h production-db.example.com -U admin -d o2o_dashboard

# Step 2: 执行迁移脚本
\i database/migrations/pg_ddl_20251119.sql

# Step 3: 验证结果
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_name='orders' AND column_name='store_franchise_type';

# Step 4: 验证索引
SELECT indexname FROM pg_indexes 
WHERE tablename='orders' AND indexname='idx_orders_franchise_type';

# Step 5: 统计数据分布
SELECT 
    store_franchise_type,
    COUNT(*) AS count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS percentage
FROM orders
GROUP BY store_franchise_type;
```

#### 方式B: 使用Python脚本
```python
# 修改 database/connection.py 的数据库连接为生产环境
# 然后执行:
python database/add_store_franchise_type_field.py
```

---

## 📊 数据回填 (可选)

如需为历史数据补充加盟类型,可使用以下SQL:

### 方法1: 根据门店名称规则
```sql
UPDATE orders 
SET store_franchise_type = CASE
    WHEN store_name LIKE '%直营%' OR store_name LIKE '%总部%' THEN 1
    WHEN store_name LIKE '%加盟%' THEN 2
    WHEN store_name LIKE '%托管%' THEN 3
    WHEN store_name LIKE '%买断%' THEN 4
    ELSE NULL
END
WHERE store_franchise_type IS NULL;
```

### 方法2: 根据已知门店列表
```sql
-- 直营店
UPDATE orders 
SET store_franchise_type = 1 
WHERE store_name IN ('北京总部店', '上海旗舰店', '深圳形象店')
  AND store_franchise_type IS NULL;

-- 加盟店
UPDATE orders 
SET store_franchise_type = 2 
WHERE store_name IN ('加盟店A', '加盟店B', '加盟店C')
  AND store_franchise_type IS NULL;
```

---

## 📈 后续数据导入

### Excel数据准备规范

#### 在订单数据Excel中新增列:
```
列名: 门店加盟类型 (或 加盟类型 / 门店类型)
数据类型: 整数
取值范围: 1, 2, 3, 4

示例:
订单ID    门店名称      门店加盟类型    商品名称    ...
ORD001    北京直营店    1              咖啡        ...
ORD002    上海加盟店    2              面包        ...
ORD003    深圳托管店    3              蛋糕        ...
ORD004    广州买断店    4              饮料        ...
```

#### 系统自动处理:
1. ✅ 识别列名 (支持6种命名方式)
2. ✅ 映射到标准字段 `store_franchise_type`
3. ✅ 写入数据库 orders 表
4. ✅ 历史数据保持 NULL 不变

---

## 🔍 验证清单

### ✅ 数据库层面验证

```sql
-- 1. 检查字段存在
SELECT column_name FROM information_schema.columns 
WHERE table_name='orders' AND column_name='store_franchise_type';
-- 预期: 1行记录

-- 2. 检查索引
SELECT indexname FROM pg_indexes 
WHERE tablename='orders' AND indexname='idx_orders_franchise_type';
-- 预期: 1行记录

-- 3. 检查约束
SELECT constraint_name FROM information_schema.table_constraints
WHERE table_name='orders' AND constraint_name='chk_franchise_type';
-- 预期: 1行记录

-- 4. 检查数据分布
SELECT store_franchise_type, COUNT(*) 
FROM orders 
GROUP BY store_franchise_type;
-- 预期: 显示各类型订单数(或全为NULL)
```

### ✅ 应用层面验证

```python
# 1. 导入测试
from database.models import Order
from database.connection import SessionLocal

session = SessionLocal()
order = session.query(Order).first()

# 检查字段是否可访问
print(order.store_franchise_type)  # 应输出: None 或 1-4
session.close()

# 2. 运行完整测试
python 测试门店加盟类型字段.py
# 预期: 5/5 测试通过
```

---

## 📁 交付文件清单

| 文件路径 | 说明 | 状态 |
|---------|------|------|
| `database/add_store_franchise_type_field.py` | Python迁移脚本 | ✅ 已创建 |
| `database/migrations/pg_ddl_20251119.sql` | SQL脚本(生产) | ✅ 已创建 |
| `database/models.py` | 数据库模型 | ✅ 已更新 |
| `真实数据处理器.py` | 字段映射配置 | ✅ 已更新 |
| `门店加盟类型字段使用指南.md` | 使用文档 | ✅ 已创建 |
| `测试门店加盟类型字段.py` | 测试脚本 | ✅ 已创建 |
| `门店加盟类型字段部署清单.md` | 本文档 | ✅ 已创建 |

---

## 🎯 注意事项

### ⚠️ 重要提醒

1. **幂等性保证**
   - 迁移脚本可重复执行,不会重复创建字段
   - 建议先在开发环境测试

2. **数据兼容性**
   - 历史数据默认为 `NULL` (未分类)
   - 不影响现有功能正常运行
   - 新数据上传时自动填充

3. **性能影响**
   - 已添加索引,查询性能不受影响
   - 插入性能有轻微损耗(可忽略)
   - 适用于OLAP分析场景

4. **字段命名**
   - 数据库使用英文字段名 `store_franchise_type`
   - Excel可使用中文列名,系统自动映射
   - 建议统一使用"门店加盟类型"

5. **数据完整性**
   - 已添加约束,仅允许 1-4 或 NULL
   - 非法值会被拒绝插入
   - 保证数据质量

---

## 🔄 回滚方案 (紧急情况)

如遇到严重问题需要回滚:

```sql
-- ⚠️ 警告: 此操作会永久删除数据!
-- 请确保已备份数据!

-- Step 1: 删除索引
DROP INDEX IF EXISTS idx_orders_franchise_type;

-- Step 2: 删除约束
ALTER TABLE orders DROP CONSTRAINT IF EXISTS chk_franchise_type;

-- Step 3: 删除字段
ALTER TABLE orders DROP COLUMN IF EXISTS store_franchise_type;
```

**回滚后需要:**
1. 恢复 `database/models.py` 中的字段定义
2. 恢复 `真实数据处理器.py` 中的字段映射
3. 重新启动看板应用

---

## 📞 技术支持

如遇到问题,请检查:
1. 数据库连接是否正常
2. 是否有足够的权限执行DDL操作
3. PostgreSQL版本是否支持 (建议 10.0+)
4. 查看详细错误日志

---

## 📅 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-11-19 | 初始版本,完成字段添加 | AI助手 |

---

**部署完成标记:**

- [ ] 开发环境迁移完成
- [ ] 开发环境测试通过 (5/5)
- [ ] 生产环境迁移完成
- [ ] 生产环境验证通过
- [ ] 数据回填完成 (如需要)
- [ ] 看板集成完成 (如需要)
- [ ] 文档交付完成

**执行人:** _______________  
**执行日期:** _______________  
**备注:** _____________________________________________
