# 🎯 字段依赖关系确认 - 诊断引擎字段清单

生成时间: 2025-10-17

---

## 📋 问题诊断引擎字段需求清单

根据 `问题诊断引擎.py` (Lines 1-151) 分析：

### ✅ **必需字段（中文）**

诊断引擎使用的是 **中文字段名**：

| 字段名 | 用途 | 行号 |
|--------|------|------|
| `日期` | 周期对比、趋势分析 | Line 48, 81, 82, 155 |
| `订单ID` | 订单级别分析、配送费计算 | Line 63 |
| `商品实售价` | 价格分析、毛利计算 | Line 55, 56 |
| `商品采购成本` | 毛利计算 | Line 55 |
| `物流配送费` | 配送费占比分析 | Line 63 |
| `平台佣金` | 成本分析 | Line 50 |
| `三级分类名` | 分类分析 | __init__ docstring |
| `时段` | 时段分析 | __init__ docstring |
| `商品角色` | 角色失衡诊断 | Line 666, 895 |

### ⚠️ **衍生字段（引擎自动计算）**

| 字段名 | 计算公式 | 行号 |
|--------|---------|------|
| `单品毛利` | 商品实售价 - 商品采购成本 | Line 55 |
| `单品毛利率` | (单品毛利 / 商品实售价 * 100) | Line 56 |
| `配送费占比` | (物流配送费 / 订单金额 * 100) | Line 63 |

### 📊 **可选字段**

| 字段名 | 用途 | 备注 |
|--------|------|------|
| `场景` | 场景分析 | 如：早餐/午餐/晚餐 |
| `价格带` | 价格分层分析 | 如：低价/中价/高价 |
| `周` | 周级别聚合 | 可从日期计算 |

---

## 🔴 **关键发现**

### 问题1: 字段名不匹配风险

**诊断引擎期望**: 中文字段名（如 `商品实售价`）

**真实数据处理器**: 标准化为英文字段名（如 `price`）

**冲突**:
```python
# 真实数据处理器标准化后
df.columns = ['product_name', 'price', 'original_price', ...]

# 诊断引擎期望
df['商品实售价']  # ❌ KeyError!
```

---

## ✅ **解决方案**

### 方案1: 修改真实数据处理器 ⭐⭐⭐⭐⭐（推荐）

**修改字段映射，保持中文字段名**：

```python
def standardize_sales_data(self, df: pd.DataFrame) -> pd.DataFrame:
    """标准化为中文字段名（匹配诊断引擎）"""
    
    field_mapping = {
        # 保持中文字段名
        '商品名称': ['商品名称', 'product_name', 'name', '名称'],
        '商品实售价': ['售价', 'price', 'selling_price', '现价', '商品实售价'],
        '商品采购成本': ['原价', 'original_price', 'cost', '成本', '商品采购成本'],
        '月售': ['月售', 'monthly_sales', 'sales_volume', '月销量'],
        '一级分类名': ['美团一级分类', 'category_l1', 'primary_category', '一级分类', '一级分类名'],
        '三级分类名': ['美团三级分类', 'category_l3', 'tertiary_category', '三级分类', '三级分类名'],
        '订单ID': ['订单ID', 'order_id', 'orderId'],
        '日期': ['日期', 'date', 'collect_time', '采集时间'],
        # ... 其他映射
    }
```

### 方案2: 修改诊断引擎（不推荐）

- ❌ 工作量大（1686行代码）
- ❌ 可能破坏现有逻辑
- ❌ 不符合业务习惯（门店数据通常是中文）

---

## 🎯 最终确认

### ✅ 当前状态

**Dash版数据加载** (智能门店看板_Dash版.py Lines 62-101):
```python
def load_real_business_data():
    # 直接读取Excel
    df = pd.read_excel(data_file, sheet_name=0)
    return df  # ❌ 没有标准化
```

**问题**:
1. 如果Excel列名不匹配 → 诊断引擎报错
2. 没有数据类型转换 → 计算可能出错
3. 没有衍生字段 → 部分功能无法使用

### ✅ 整合后

```python
from 真实数据处理器 import RealDataProcessor

def load_real_business_data():
    # 原有的文件查找逻辑
    if data_file:
        try:
            df = pd.read_excel(data_file, sheet_name=0)
            
            # ⭐ 使用真实数据处理器标准化
            processor = RealDataProcessor()
            df_standardized = processor.standardize_sales_data(df)
            
            return df_standardized
```

**优势**:
1. ✅ 自动字段映射
2. ✅ 数据类型转换
3. ✅ 计算衍生字段
4. ✅ 兼容多种数据格式

---

## 📝 实施检查清单

- [ ] 修改 `真实数据处理器.py` 的字段映射（保持中文）
- [ ] 整合到 `智能门店看板_Dash版.py`
- [ ] 重启应用测试
- [ ] 验证Tab 4是否显示真实数据（非mock数据）
- [ ] 检查控制台是否有字段缺失错误

---

**立即行动**: 我现在就开始修改代码！
